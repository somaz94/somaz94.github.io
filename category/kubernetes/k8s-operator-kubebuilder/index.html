<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>Creating Kubernetes Operators with Kubebuilder | somaz</title>
    <meta name="description" content="A practical guide to building Kubernetes Operators using Kubebuilder framework">
    
        <meta name="keywords" content="kubernetes, operator, kubebuilder, development, go, custom-resources">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Creating Kubernetes Operators with Kubebuilder | somaz">
    <meta name="twitter:description" content="A practical guide to building Kubernetes Operators using Kubebuilder framework">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1737356533/kubernetes-operator-kubebuilder_r8hvo4.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/kubernetes/k8s-operator-kubebuilder/">
    <meta property="og:title" content="Creating Kubernetes Operators with Kubebuilder | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1737356533/kubernetes-operator-kubebuilder_r8hvo4.png">
    <meta property="og:description" content="A practical guide to building Kubernetes Operators using Kubebuilder framework">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/kubernetes/k8s-operator-kubebuilder/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-01-14T09:00:00+00:00">
                            


January 14, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>19 min to read</span>
                </p>
                <h1 class="post-title">Creating Kubernetes Operators with Kubebuilder</h1>
                <p class="post-subtitle">A step-by-step guide to building custom controllers for Kubernetes</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1737356533/kubernetes-operator-kubebuilder_r8hvo4.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <ul>
  <li><a href="https://github.com/somaz94/helios-lb/">image reference link</a></li>
</ul>

<p><br /></p>

<hr />

<h2 id="overview">Overview</h2>

<p>Kubernetes Operators extend the platform’s functionality by adding domain-specific logic to manage complex applications. This guide demonstrates how to build Kubernetes Operators using Kubebuilder, a powerful framework that simplifies the development of custom controllers and APIs.</p>

<div class="info-box info-box-default-not-check">
  <strong>What is a Kubernetes Operator?</strong>
  <p>A Kubernetes Operator is a method of packaging, deploying, and managing applications using custom resources and controllers. Operators follow Kubernetes principles to automate operational tasks that would otherwise require manual intervention.</p>
</div>

<div style="width: 100%; margin: 20px auto;">
  <div class="mermaid">
    graph TD
      A[Kubernetes API Server] --&gt; B[API Extension]
      B --&gt; C[Custom Resource Definition]
      B --&gt; D[Custom Controller/Operator]
      D --&gt; E[Reconciliation Loop]
      E --&gt; F[Monitor State]
      F --&gt; G[Compare with Desired State]
      G --&gt; H[Take Action]
      H --&gt; F
      
      style A fill:#326ce5,stroke:#fff,color:#fff
      style D fill:#ffa726,stroke:#fff,color:#000
      style E fill:#ffa726,stroke:#fff,color:#000
  </div>
</div>

<p><br /></p>

<h2 id="understanding-kubebuilder">Understanding Kubebuilder</h2>

<h3 id="what-is-kubebuilder">What is Kubebuilder?</h3>

<p>Kubebuilder is an SDK for building Kubernetes APIs and controllers using Go. It provides scaffolding, code generation, and other tools to simplify operator development.</p>

<div class="info-box info-box-default-not-check">
  <strong>Key Benefits of Kubebuilder</strong>
  <ul>
    <li><strong>Code Generation:</strong> Automatically generates boilerplate code for CRDs and controllers</li>
    <li><strong>Standards-Based:</strong> Built on controller-runtime library, adhering to Kubernetes API patterns</li>
    <li><strong>Scaffolding:</strong> Provides project structure including configuration files, Dockerfile, and Makefile</li>
    <li><strong>Testing:</strong> Integrates with tools like 'envtest' for Kubernetes testing</li>
    <li><strong>Extensibility:</strong> Easily customizable to fit specific requirements</li>
  </ul>
</div>

<p><br /></p>

<h3 id="kubebuilder-development-workflow">Kubebuilder Development Workflow</h3>

<div style="width: 100%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      A[Initialize Project] --&gt; B[Create API/CRD]
      B --&gt; C[Implement Controller Logic]
      C --&gt; D[Generate Manifests]
      D --&gt; E[Test Locally]
      E --&gt; F[Build &amp; Deploy]
      
      style A fill:#bbdefb,stroke:#333,stroke-width:1px
      style B fill:#90caf9,stroke:#333,stroke-width:1px
      style C fill:#64b5f6,stroke:#333,stroke-width:1px
      style D fill:#42a5f5,stroke:#333,stroke-width:1px
      style E fill:#2196f3,stroke:#333,stroke-width:1px,color:#fff
      style F fill:#1976d2,stroke:#333,stroke-width:1px,color:#fff
  </div>
</div>

<p><br /></p>

<h2 id="getting-started-with-kubebuilder">Getting Started with Kubebuilder</h2>

<h3 id="prerequisites">Prerequisites</h3>

<p>Before starting, ensure you have the following tools installed:</p>

<ul>
  <li>Go (version 1.19+)</li>
  <li>Docker</li>
  <li>kubectl</li>
  <li>kustomize</li>
  <li>Kubernetes cluster for testing</li>
</ul>

<h3 id="installation">Installation</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS</span>
brew <span class="nb">install </span>kubebuilder

<span class="c"># Linux</span>
curl <span class="nt">-L</span> <span class="nt">-o</span> kubebuilder https://go.kubebuilder.io/dl/latest/<span class="si">$(</span>go <span class="nb">env </span>GOOS<span class="si">)</span>/<span class="si">$(</span>go <span class="nb">env </span>GOARCH<span class="si">)</span>
<span class="nb">chmod</span> +x kubebuilder
<span class="nb">sudo mv </span>kubebuilder /usr/local/bin/
</code></pre></div></div>

<h3 id="project-initialization">Project Initialization</h3>

<p>Create a new project with Kubebuilder:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create a directory for your project</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> ~/projects/namespace-sync
<span class="nb">cd</span> ~/projects/namespace-sync

<span class="c"># Initialize the project</span>
kubebuilder init <span class="nt">--domain</span> nsync.dev <span class="nt">--repo</span> github.com/somaz94/k8s-namespace-sync

<span class="c"># Create an API</span>
kubebuilder create api <span class="nt">--group</span> <span class="nb">sync</span> <span class="nt">--version</span> v1 <span class="nt">--kind</span> NamespaceSync
</code></pre></div></div>

<p>When prompted:</p>
<ul>
  <li>Create Resource [y/n]: <code class="language-plaintext highlighter-rouge">y</code></li>
  <li>Create Controller [y/n]: <code class="language-plaintext highlighter-rouge">y</code></li>
</ul>

<p>This generates a skeleton project structure with:</p>
<ul>
  <li>API definitions</li>
  <li>Controller scaffolding</li>
  <li>Configuration files</li>
  <li>Testing infrastructure</li>
</ul>

<p><br /></p>

<h3 id="understanding-the-project-structure">Understanding the Project Structure</h3>

<div class="info-box info-box-default-not-check">
  <strong>Key Directories and Files</strong>
  <div style="display: flex; margin-top: 10px;">
    <div style="flex: 1;">
      <ul>
        <li><code>api/</code> - CRD API definitions</li>
        <li><code>controllers/</code> - Reconciliation logic</li>
        <li><code>config/</code> - Kubernetes resource manifests</li>
        <li><code>Makefile</code> - Build and deployment commands</li>
        <li><code>main.go</code> - Operator entry point</li>
      </ul>
    </div>
    <div style="flex: 1;">
      <ul>
        <li><code>Dockerfile</code> - Container image definition</li>
        <li><code>go.mod</code> - Go module dependencies</li>
        <li><code>hack/</code> - Scripts and tools</li>
        <li><code>PROJECT</code> - Kubebuilder project metadata</li>
      </ul>
    </div>
  </div>
</div>

<p>Here’s a more detailed view of the generated project structure:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── api                     # API definitions
│   └── v1
│       ├── groupversion_info.go
│       ├── namespacesync_types.go  # CRD definition
│       └── zz_generated.deepcopy.go
├── bin                     # Binaries
├── cmd                     # Command-line interfaces
│   └── main.go             # Main entry point
├── config                  # Kubernetes configuration
│   ├── crd                 # Custom Resource Definitions
│   ├── default             # Default configurations
│   ├── manager             # Controller manager
│   ├── rbac                # Role-based access control
│   └── samples             # Sample custom resources
├── controllers             # Controller logic
│   ├── namespacesync_controller.go  # Main controller logic
│   └── suite_test.go                # Test setup
├── Dockerfile              # Container build instructions
├── go.mod                  # Go module definition
├── go.sum                  # Go dependencies checksum
├── hack                    # Scripts and tools
│   └── boilerplate.go.txt
├── Makefile                # Build, test, and deploy commands
└── PROJECT                 # Project metadata
</code></pre></div></div>

<p><br /></p>

<h2 id="defining-custom-resources">Defining Custom Resources</h2>

<p>The core of your operator is the Custom Resource Definition (CRD). This defines the API that users will interact with.</p>

<h3 id="understanding-the-api-definition">Understanding the API Definition</h3>

<p>Let’s examine the API definition in <code class="language-plaintext highlighter-rouge">api/v1/namespacesync_types.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// NamespaceSyncSpec defines the desired state of NamespaceSync</span>
<span class="k">type</span> <span class="n">NamespaceSyncSpec</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// SourceNamespace is the namespace to sync resources from</span>
	<span class="c">// +kubebuilder:validation:Required</span>
	<span class="n">SourceNamespace</span> <span class="kt">string</span> <span class="s">`json:"sourceNamespace"`</span>

	<span class="c">// TargetNamespaces is a list of namespaces to sync resources to</span>
	<span class="c">// +optional</span>
	<span class="n">TargetNamespaces</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:"targetNamespaces,omitempty"`</span>

	<span class="c">// NamespaceSelector selects namespaces to sync resources to</span>
	<span class="c">// +optional</span>
	<span class="n">NamespaceSelector</span> <span class="o">*</span><span class="n">metav1</span><span class="o">.</span><span class="n">LabelSelector</span> <span class="s">`json:"namespaceSelector,omitempty"`</span>

	<span class="c">// Resources is a list of resources to sync</span>
	<span class="c">// +kubebuilder:validation:Required</span>
	<span class="c">// +kubebuilder:validation:MinItems=1</span>
	<span class="n">Resources</span> <span class="p">[]</span><span class="n">ResourceSelector</span> <span class="s">`json:"resources"`</span>
<span class="p">}</span>

<span class="c">// ResourceSelector defines which resources to sync</span>
<span class="k">type</span> <span class="n">ResourceSelector</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// Kind of the resource (e.g. ConfigMap, Secret)</span>
	<span class="c">// +kubebuilder:validation:Required</span>
	<span class="c">// +kubebuilder:validation:Enum=ConfigMap;Secret</span>
	<span class="n">Kind</span> <span class="kt">string</span> <span class="s">`json:"kind"`</span>

	<span class="c">// Name of the resource</span>
	<span class="c">// +kubebuilder:validation:Required</span>
	<span class="n">Name</span> <span class="kt">string</span> <span class="s">`json:"name"`</span>
<span class="p">}</span>

<span class="c">// NamespaceSyncStatus defines the observed state of NamespaceSync</span>
<span class="k">type</span> <span class="n">NamespaceSyncStatus</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// Conditions represent the latest available observations of the NamespaceSync</span>
	<span class="c">// +optional</span>
	<span class="n">Conditions</span> <span class="p">[]</span><span class="n">metav1</span><span class="o">.</span><span class="n">Condition</span> <span class="s">`json:"conditions,omitempty"`</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="adding-kubebuilder-markers">Adding Kubebuilder Markers</h3>

<p>Kubebuilder uses special comment markers to generate additional code and metadata:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// +kubebuilder:object:root=true</span>
<span class="c">// +kubebuilder:subresource:status</span>
<span class="c">// +kubebuilder:printcolumn:name="Source",type="string",JSONPath=".spec.sourceNamespace"</span>
<span class="c">// +kubebuilder:printcolumn:name="Age",type="date",JSONPath=".metadata.creationTimestamp"</span>
<span class="c">// +kubebuilder:printcolumn:name="Status",type="string",JSONPath=".status.conditions[?(@.type=='Ready')].status"</span>
<span class="c">// +kubebuilder:printcolumn:name="Message",type="string",JSONPath=".status.conditions[?(@.type=='Ready')].message"</span>
</code></pre></div></div>

<p>These markers:</p>
<ul>
  <li>Define the resource as a root object</li>
  <li>Add a status subresource</li>
  <li>Configure columns for <code class="language-plaintext highlighter-rouge">kubectl get</code> output</li>
  <li>Define validation rules for fields</li>
</ul>

<div class="table-container">
  <table class="table-beauty">
    <tr>
      <th style="width: 30%;">Marker Type</th>
      <th style="width: 70%;">Purpose</th>
    </tr>
    <tr>
      <td>object</td>
      <td>Defines object characteristics (e.g., root=true for top-level resources)</td>
    </tr>
    <tr>
      <td>subresource</td>
      <td>Adds subresources like status or scale</td>
    </tr>
    <tr>
      <td>printcolumn</td>
      <td>Configures columns in kubectl output</td>
    </tr>
    <tr>
      <td>validation</td>
      <td>Adds schema validation (e.g., required fields, enums)</td>
    </tr>
    <tr>
      <td>rbac</td>
      <td>Defines permissions needed for the controller</td>
    </tr>
  </table>
</div>

<p><br /></p>

<h2 id="implementing-the-controller">Implementing the Controller</h2>

<p>The controller contains the reconciliation logic for your custom resource.</p>

<h3 id="understanding-the-reconciliation-loop">Understanding the Reconciliation Loop</h3>

<div style="width: 100%; margin: 20px auto;">
  <div class="mermaid">
    sequenceDiagram
      participant K as Kubernetes API
      participant C as Controller
      participant R as Reconcile Function
      
      K-&gt;&gt;C: Resource Change Event
      C-&gt;&gt;C: Add to Work Queue
      C-&gt;&gt;R: Call Reconcile()
      R-&gt;&gt;K: Get Current State
      R-&gt;&gt;R: Compare with Desired State
      R-&gt;&gt;K: Apply Changes
      R-&gt;&gt;C: Return Result
      Note over C: If Error or Requeue
      C-&gt;&gt;C: Add Back to Queue
  </div>
</div>

<p>The controller watches for changes to your custom resource and other related resources, then triggers the reconciliation loop to ensure the actual state matches the desired state.</p>

<h3 id="controller-implementation">Controller Implementation</h3>

<p>Let’s look at a simplified version of a controller from our NamespaceSync example:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// NamespaceSyncReconciler reconciles a NamespaceSync object</span>
<span class="k">type</span> <span class="n">NamespaceSyncReconciler</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">client</span><span class="o">.</span><span class="n">Client</span>
	<span class="n">Scheme</span> <span class="o">*</span><span class="n">runtime</span><span class="o">.</span><span class="n">Scheme</span>
	<span class="n">Recorder</span> <span class="n">record</span><span class="o">.</span><span class="n">EventRecorder</span>
<span class="p">}</span>

<span class="c">// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="c">// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs/status,verbs=get;update;patch</span>
<span class="c">// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs/finalizers,verbs=update</span>
<span class="c">// +kubebuilder:rbac:groups="",resources=namespaces,verbs=get;list;watch</span>
<span class="c">// +kubebuilder:rbac:groups="",resources=configmaps;secrets,verbs=get;list;watch;create;update;patch;delete</span>

<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">NamespaceSyncReconciler</span><span class="p">)</span> <span class="n">Reconcile</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log</span> <span class="o">:=</span> <span class="n">log</span><span class="o">.</span><span class="n">FromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
	
	<span class="c">// Fetch the NamespaceSync instance</span>
	<span class="k">var</span> <span class="n">namespacesync</span> <span class="n">syncv1</span><span class="o">.</span><span class="n">NamespaceSync</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">NamespacedName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="c">// Handle not-found error</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">client</span><span class="o">.</span><span class="n">IgnoreNotFound</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	
	<span class="c">// Add finalizer if needed</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">controllerutil</span><span class="o">.</span><span class="n">ContainsFinalizer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">finalizerName</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">controllerutil</span><span class="o">.</span><span class="n">AddFinalizer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">finalizerName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to add finalizer"</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="c">// Check if being deleted</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">namespacesync</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="o">.</span><span class="n">DeletionTimestamp</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">handleDeletion</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">)</span>
	<span class="p">}</span>
	
	<span class="c">// Get target namespaces</span>
	<span class="n">targetNamespaces</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">getTargetNamespaces</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>
	
	<span class="c">// Synchronize resources to target namespaces</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">syncResources</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">targetNamespaces</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="c">// Update status to reflect error</span>
		<span class="n">r</span><span class="o">.</span><span class="n">updateStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">metav1</span><span class="o">.</span><span class="n">ConditionFalse</span><span class="p">,</span> <span class="s">"SyncFailed"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>
	
	<span class="c">// Update status to reflect success</span>
	<span class="n">r</span><span class="o">.</span><span class="n">updateStatusCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">metav1</span><span class="o">.</span><span class="n">ConditionTrue</span><span class="p">,</span> <span class="s">"Synced"</span><span class="p">,</span> <span class="s">"Resources synchronized successfully"</span><span class="p">)</span>
	
	<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{</span><span class="n">RequeueAfter</span><span class="o">:</span> <span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">},</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="key-controller-components">Key Controller Components</h3>

<ol>
  <li><strong>RBAC Markers</strong>: Define the permissions needed by the controller</li>
  <li><strong>Reconcile Function</strong>: Main logic that handles the resource</li>
  <li><strong>Finalizers</strong>: Ensure cleanup when resources are deleted</li>
  <li><strong>Status Updates</strong>: Report the current state back to the user</li>
</ol>

<p><br /></p>

<h2 id="building-and-testing-your-operator">Building and Testing Your Operator</h2>

<h3 id="key-makefile-commands">Key Makefile Commands</h3>

<p>Kubebuilder creates a comprehensive Makefile with all necessary commands:</p>

<div class="table-container">
  <table class="table-beauty">
    <tr>
      <th style="width: 25%;">Command</th>
      <th style="width: 75%;">Description</th>
    </tr>
    <tr>
      <td><code>make generate</code></td>
      <td>Generate code (DeepCopy methods, etc.) for custom resources</td>
    </tr>
    <tr>
      <td><code>make manifests</code></td>
      <td>Generate CRD manifests and RBAC configuration</td>
    </tr>
    <tr>
      <td><code>make test</code></td>
      <td>Run unit tests with a simulated Kubernetes API server</td>
    </tr>
    <tr>
      <td><code>make run</code></td>
      <td>Run the controller locally against your configured Kubernetes cluster</td>
    </tr>
    <tr>
      <td><code>make docker-build</code></td>
      <td>Build the Docker image</td>
    </tr>
    <tr>
      <td><code>make docker-push</code></td>
      <td>Push the Docker image to a registry</td>
    </tr>
    <tr>
      <td><code>make deploy</code></td>
      <td>Deploy the controller to the Kubernetes cluster</td>
    </tr>
  </table>
</div>

<h3 id="running-tests">Running Tests</h3>

<p>Kubebuilder integrates with the Kubernetes <code class="language-plaintext highlighter-rouge">envtest</code> package to simulate the API server for testing:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// controllers/suite_test.go</span>
<span class="k">func</span> <span class="n">TestAPIs</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">RegisterFailHandler</span><span class="p">(</span><span class="n">Fail</span><span class="p">)</span>
	<span class="n">RunSpecs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">"Controller Suite"</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">BeforeSuite</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">logf</span><span class="o">.</span><span class="n">SetLogger</span><span class="p">(</span><span class="n">zap</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">zap</span><span class="o">.</span><span class="n">WriteTo</span><span class="p">(</span><span class="n">GinkgoWriter</span><span class="p">),</span> <span class="n">zap</span><span class="o">.</span><span class="n">UseDevMode</span><span class="p">(</span><span class="no">true</span><span class="p">)))</span>

	<span class="n">By</span><span class="p">(</span><span class="s">"bootstrapping test environment"</span><span class="p">)</span>
	<span class="n">testEnv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">envtest</span><span class="o">.</span><span class="n">Environment</span><span class="p">{</span>
		<span class="n">CRDDirectoryPaths</span><span class="o">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="n">filepath</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="s">".."</span><span class="p">,</span> <span class="s">"config"</span><span class="p">,</span> <span class="s">"crd"</span><span class="p">,</span> <span class="s">"bases"</span><span class="p">)},</span>
		<span class="n">ErrorIfCRDPathMissing</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">testEnv</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
	<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>
	<span class="n">Expect</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">BeNil</span><span class="p">())</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">syncv1</span><span class="o">.</span><span class="n">AddToScheme</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">Scheme</span><span class="p">)</span>
	<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>

	<span class="n">k8sClient</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span><span class="n">Scheme</span><span class="o">:</span> <span class="n">scheme</span><span class="o">.</span><span class="n">Scheme</span><span class="p">})</span>
	<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>
	<span class="n">Expect</span><span class="p">(</span><span class="n">k8sClient</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">BeNil</span><span class="p">())</span>
<span class="p">})</span>
</code></pre></div></div>

<p>To run tests:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nb">test</span>
</code></pre></div></div>

<h3 id="building-for-multiple-platforms">Building for Multiple Platforms</h3>

<p>For cross-platform support, add a multi-platform build rule to your Makefile:</p>

<p><br /></p>

<script src="https://gist.github.com/somaz94/9c5e731ad9e384841faa85d21a9c63c3.js"></script>

<p><br /></p>

<h2 id="real-world-example-namespace-sync-operator">Real-World Example: Namespace Sync Operator</h2>

<p>Let’s explore a real-world example of a Kubernetes Operator built with Kubebuilder: a Namespace Synchronization Operator that copies resources from one namespace to others.</p>

<h3 id="use-case">Use Case</h3>

<ul>
  <li>Synchronize ConfigMaps and Secrets from a source namespace to multiple target namespaces</li>
  <li>Target namespaces can be explicitly listed or selected via labels</li>
  <li>Resources stay in sync automatically when the source changes</li>
</ul>

<h3 id="crd-example">CRD Example</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">sync.nsync.dev/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NamespaceSync</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config-sync</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">sourceNamespace</span><span class="pi">:</span> <span class="s">source-namespace</span>
  <span class="na">targetNamespaces</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">target-namespace-1</span>
    <span class="pi">-</span> <span class="s">target-namespace-2</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">shared-config</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">shared-credentials</span>
</code></pre></div></div>

<p>Or using a namespace selector:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">sync.nsync.dev/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NamespaceSync</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config-sync-all</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">sourceNamespace</span><span class="pi">:</span> <span class="s">source-namespace</span>
  <span class="na">namespaceSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">sync-enabled</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">shared-config</span>
</code></pre></div></div>

<h3 id="building-the-feature-step-by-step">Building the Feature Step by Step</h3>

<ol>
  <li><strong>Resource Synchronization Logic</strong>:</li>
</ol>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">NamespaceSyncReconciler</span><span class="p">)</span> <span class="n">syncResources</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">namespacesync</span> <span class="o">*</span><span class="n">syncv1</span><span class="o">.</span><span class="n">NamespaceSync</span><span class="p">,</span> <span class="n">targetNamespaces</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">log</span> <span class="o">:=</span> <span class="n">log</span><span class="o">.</span><span class="n">FromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
	<span class="n">sourceNamespace</span> <span class="o">:=</span> <span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">SourceNamespace</span>
	
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Resources</span> <span class="p">{</span>
		<span class="c">// Get source resource</span>
		<span class="n">sourceObj</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">getSourceResource</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">sourceNamespace</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">}</span>
		
		<span class="c">// Apply to target namespaces</span>
		<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">targetNs</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">targetNamespaces</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">targetNs</span> <span class="o">==</span> <span class="n">sourceNamespace</span> <span class="p">{</span>
				<span class="c">// Skip source namespace</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			
			<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">applyToTarget</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">sourceObj</span><span class="p">,</span> <span class="n">targetNs</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to apply resource to target"</span><span class="p">,</span> 
					<span class="s">"kind"</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">Kind</span><span class="p">,</span> <span class="s">"name"</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"target"</span><span class="p">,</span> <span class="n">targetNs</span><span class="p">)</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			
			<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Synchronized resource"</span><span class="p">,</span> 
				<span class="s">"kind"</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">Kind</span><span class="p">,</span> <span class="s">"name"</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> 
				<span class="s">"from"</span><span class="p">,</span> <span class="n">sourceNamespace</span><span class="p">,</span> <span class="s">"to"</span><span class="p">,</span> <span class="n">targetNs</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li><strong>Target Namespace Resolution</strong>:</li>
</ol>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">NamespaceSyncReconciler</span><span class="p">)</span> <span class="n">getTargetNamespaces</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">namespacesync</span> <span class="o">*</span><span class="n">syncv1</span><span class="o">.</span><span class="n">NamespaceSync</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// If explicit targets provided, use those</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">TargetNamespaces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">TargetNamespaces</span><span class="p">,</span> <span class="no">nil</span>
	<span class="p">}</span>
	
	<span class="c">// If selector provided, query matching namespaces</span>
	<span class="k">if</span> <span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">NamespaceSelector</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">selector</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">metav1</span><span class="o">.</span><span class="n">LabelSelectorAsSelector</span><span class="p">(</span><span class="n">namespacesync</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">NamespaceSelector</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
		<span class="p">}</span>
		
		<span class="k">var</span> <span class="n">namespaceList</span> <span class="n">corev1</span><span class="o">.</span><span class="n">NamespaceList</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namespaceList</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">.</span><span class="n">ListOptions</span><span class="p">{</span>
			<span class="n">LabelSelector</span><span class="o">:</span> <span class="n">selector</span><span class="p">,</span>
		<span class="p">});</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
		<span class="p">}</span>
		
		<span class="n">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">namespaceList</span><span class="o">.</span><span class="n">Items</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ns</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">namespaceList</span><span class="o">.</span><span class="n">Items</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="no">nil</span>
	<span class="p">}</span>
	
	<span class="c">// No targets specified</span>
	<span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"no target namespaces specified"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="testing-the-operator">Testing the Operator</h3>

<p>To test the operator locally:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run the controller against your configured Kubernetes cluster</span>
make run

<span class="c"># In another terminal, apply a sample CR</span>
kubectl apply <span class="nt">-f</span> config/samples/sync_v1_namespacesync.yaml

<span class="c"># Check the status</span>
kubectl get namespacesync

<span class="c"># Verify resources were synced</span>
kubectl get configmap <span class="nt">-n</span> target-namespace-1
</code></pre></div></div>

<p><br /></p>

<h2 id="deploying-your-operator">Deploying Your Operator</h2>

<h3 id="building-and-pushing-the-container-image">Building and Pushing the Container Image</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set the image name</span>
<span class="nb">export </span><span class="nv">IMG</span><span class="o">=</span>yourdockerhub/namespace-sync:v0.1.0

<span class="c"># Build and push</span>
make docker-build docker-push <span class="nv">IMG</span><span class="o">=</span><span class="nv">$IMG</span>
</code></pre></div></div>

<h3 id="deploying-to-a-kubernetes-cluster">Deploying to a Kubernetes Cluster</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install the CRDs</span>
make <span class="nb">install</span>

<span class="c"># Deploy the controller</span>
make deploy <span class="nv">IMG</span><span class="o">=</span><span class="nv">$IMG</span>
</code></pre></div></div>

<h3 id="verifying-the-deployment">Verifying the Deployment</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check the operator deployment</span>
kubectl get pods <span class="nt">-n</span> namespace-sync-system

<span class="c"># Check the CRD</span>
kubectl get crd | <span class="nb">grep </span>namespacesync

<span class="c"># Check if any CRs exist</span>
kubectl get namespacesync <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="advanced-topics">Advanced Topics</h2>

<h3 id="finalizers">Finalizers</h3>

<p>Finalizers ensure proper cleanup when resources are deleted:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">finalizerName</span> <span class="o">=</span> <span class="s">"namespacesync.sync.nsync.dev/finalizer"</span>

<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">NamespaceSyncReconciler</span><span class="p">)</span> <span class="n">handleDeletion</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">namespacesync</span> <span class="o">*</span><span class="n">syncv1</span><span class="o">.</span><span class="n">NamespaceSync</span><span class="p">)</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log</span> <span class="o">:=</span> <span class="n">log</span><span class="o">.</span><span class="n">FromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
	
	<span class="c">// Perform cleanup here...</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Cleaning up resources"</span><span class="p">)</span>
	
	<span class="c">// When finished, remove the finalizer</span>
	<span class="n">controllerutil</span><span class="o">.</span><span class="n">RemoveFinalizer</span><span class="p">(</span><span class="n">namespacesync</span><span class="p">,</span> <span class="n">finalizerName</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">namespacesync</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="n">err</span>
	<span class="p">}</span>
	
	<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Finalizer removed"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">Result</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="webhooks">Webhooks</h3>

<p>Kubebuilder supports generating admission webhooks for validation and defaulting:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add webhook support to your API</span>
kubebuilder create webhook <span class="nt">--group</span> <span class="nb">sync</span> <span class="nt">--version</span> v1 <span class="nt">--kind</span> NamespaceSync <span class="nt">--defaulting</span> <span class="nt">--programmatic-validation</span>
</code></pre></div></div>

<h3 id="metrics-and-monitoring">Metrics and Monitoring</h3>

<p>The controller-runtime library automatically exposes Prometheus metrics. Add custom metrics:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="p">(</span>
	<span class="n">syncCount</span> <span class="o">=</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="s">"namespacesync_resources_synced_total"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"Number of resources synced by the operator"</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"kind"</span><span class="p">,</span> <span class="s">"source_namespace"</span><span class="p">,</span> <span class="s">"target_namespace"</span><span class="p">},</span>
	<span class="p">)</span>
<span class="p">)</span>

<span class="c">// Use in your reconciler</span>
<span class="n">syncCount</span><span class="o">.</span><span class="n">WithLabelValues</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Kind</span><span class="p">,</span> <span class="n">sourceNamespace</span><span class="p">,</span> <span class="n">targetNs</span><span class="p">)</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="best-practices-for-operator-development">Best Practices for Operator Development</h2>

<div class="info-box info-box-success-not-check">
  <strong>Design Principles</strong>
  <ul>
    <li>Follow the single responsibility principle - one operator for one application type</li>
    <li>Make operations idempotent - reconcile function should be safe to call multiple times</li>
    <li>Design for eventual consistency - handle delays and unavailability gracefully</li>
    <li>Add proper status reporting so users can understand the current state</li>
    <li>Structure your reconciliation to achieve maximum convergence</li>
    <li>Use owner references to manage related resources</li>
  </ul>
  
  <strong>Implementation Best Practices</strong>
  <ul>
    <li>Add clear documentation with examples in your CRDs</li>
    <li>Include meaningful validation to catch errors early</li>
    <li>Use shared informers for watching resources</li>
    <li>Implement proper error handling with appropriate backoff</li>
    <li>Add thorough unit and integration tests</li>
    <li>Minimize container image size for faster deployments</li>
  </ul>
  
  <strong>Operational Best Practices</strong>
  <ul>
    <li>Implement proper logging with structured contextual information</li>
    <li>Add Prometheus metrics for monitoring</li>
    <li>Set resource requests and limits on controller pods</li>
    <li>Implement leader election for high availability</li>
    <li>Version your APIs properly using semantic versioning</li>
    <li>Document upgrade procedures for your operator</li>
  </ul>
</div>

<p><br /></p>

<h2 id="conclusion">Conclusion</h2>

<p>Building Kubernetes Operators with Kubebuilder streamlines the development process for extending Kubernetes with custom resources and controllers. This guide demonstrated the key steps in creating an operator, from project initialization to deployment, using a real-world Namespace Synchronization example.</p>

<p>As your operators grow more complex, leveraging the full power of Kubebuilder’s scaffolding, code generation, and testing tools will help you create robust, production-ready extensions to Kubernetes.</p>

<p><br /></p>

<hr />

<h2 id="references">References</h2>

<ul>
  <li><a href="https://book.kubebuilder.io/">Kubebuilder Documentation</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Operator Pattern</a></li>
  <li><a href="https://github.com/somaz94/k8s-namespace-sync">Namespace Sync Example</a></li>
  <li><a href="https://github.com/somaz94/helios-lb">Helios Load Balancer</a></li>
  <li><a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime">Controller-Runtime Library</a></li>
  <li><a href="https://cloud.google.com/blog/products/containers-kubernetes/best-practices-for-building-kubernetes-operators-and-stateful-apps">Operator Best Practices</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/openstack/openstack-neutron/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1742267532/openstack_t2tmoc.png">
                                    
                                    <h3>Deep Dive into OpenStack Neutron</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/openstack/openstack-nova/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1742267532/openstack_t2tmoc.png">
                                    
                                    <h3>Deep Dive into OpenStack Nova</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/cs/load-average/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1744340441/load-average_nqzjno.png">
                                    
                                    <h3>Load Average in top Command - What It Really Means</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="19">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <div class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    
    <a href="/category/kubernetes/k8s-helm-chart-packaging/" class="post-preview">
        <div class="image">
            
                <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1737357972/github-gh-pages_lokj8q.png">
            
        </div>
        <h3 class="title">Creating and Hosting Helm Charts for Kubernetes Operators</h3>
    </a>
</div>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;A practical guide to building Kubernetes Operators using Kubebuilder framework&quot;%20https://somaz.blog/category/kubernetes/k8s-operator-kubebuilder/%20via%20&#64;twitter_username&hashtags=kubernetes,operator,kubebuilder,development,go,custom-resources"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/kubernetes/k8s-operator-kubebuilder/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/kubernetes/k8s-operator-kubebuilder/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Creating Kubernetes Operators with Kubebuilder",
            "headline": "A step-by-step guide to building custom controllers for Kubernetes",
            "description": "A practical guide to building Kubernetes Operators using Kubebuilder framework",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1737356533/kubernetes-operator-kubebuilder_r8hvo4.png",
            "url": "https://somaz.blog/category/kubernetes/k8s-operator-kubebuilder/",
            "articleBody": "
  image reference link






Overview

Kubernetes Operators extend the platform’s functionality by adding domain-specific logic to manage complex applications. This guide demonstrates how to build Kubernetes Operators using Kubebuilder, a powerful framework that simplifies the development of custom controllers and APIs.


  What is a Kubernetes Operator?
  A Kubernetes Operator is a method of packaging, deploying, and managing applications using custom resources and controllers. Operators follow Kubernetes principles to automate operational tasks that would otherwise require manual intervention.



  
    graph TD
      A[Kubernetes API Server] --&amp;gt; B[API Extension]
      B --&amp;gt; C[Custom Resource Definition]
      B --&amp;gt; D[Custom Controller/Operator]
      D --&amp;gt; E[Reconciliation Loop]
      E --&amp;gt; F[Monitor State]
      F --&amp;gt; G[Compare with Desired State]
      G --&amp;gt; H[Take Action]
      H --&amp;gt; F
      
      style A fill:#326ce5,stroke:#fff,color:#fff
      style D fill:#ffa726,stroke:#fff,color:#000
      style E fill:#ffa726,stroke:#fff,color:#000
  




Understanding Kubebuilder

What is Kubebuilder?

Kubebuilder is an SDK for building Kubernetes APIs and controllers using Go. It provides scaffolding, code generation, and other tools to simplify operator development.


  Key Benefits of Kubebuilder
  
    Code Generation: Automatically generates boilerplate code for CRDs and controllers
    Standards-Based: Built on controller-runtime library, adhering to Kubernetes API patterns
    Scaffolding: Provides project structure including configuration files, Dockerfile, and Makefile
    Testing: Integrates with tools like &apos;envtest&apos; for Kubernetes testing
    Extensibility: Easily customizable to fit specific requirements
  




Kubebuilder Development Workflow


  
    graph LR
      A[Initialize Project] --&amp;gt; B[Create API/CRD]
      B --&amp;gt; C[Implement Controller Logic]
      C --&amp;gt; D[Generate Manifests]
      D --&amp;gt; E[Test Locally]
      E --&amp;gt; F[Build &amp;amp; Deploy]
      
      style A fill:#bbdefb,stroke:#333,stroke-width:1px
      style B fill:#90caf9,stroke:#333,stroke-width:1px
      style C fill:#64b5f6,stroke:#333,stroke-width:1px
      style D fill:#42a5f5,stroke:#333,stroke-width:1px
      style E fill:#2196f3,stroke:#333,stroke-width:1px,color:#fff
      style F fill:#1976d2,stroke:#333,stroke-width:1px,color:#fff
  




Getting Started with Kubebuilder

Prerequisites

Before starting, ensure you have the following tools installed:


  Go (version 1.19+)
  Docker
  kubectl
  kustomize
  Kubernetes cluster for testing


Installation

# macOS
brew install kubebuilder

# Linux
curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)
chmod +x kubebuilder
sudo mv kubebuilder /usr/local/bin/


Project Initialization

Create a new project with Kubebuilder:

# Create a directory for your project
mkdir -p ~/projects/namespace-sync
cd ~/projects/namespace-sync

# Initialize the project
kubebuilder init --domain nsync.dev --repo github.com/somaz94/k8s-namespace-sync

# Create an API
kubebuilder create api --group sync --version v1 --kind NamespaceSync


When prompted:

  Create Resource [y/n]: y
  Create Controller [y/n]: y


This generates a skeleton project structure with:

  API definitions
  Controller scaffolding
  Configuration files
  Testing infrastructure




Understanding the Project Structure


  Key Directories and Files
  
    
      
        api/ - CRD API definitions
        controllers/ - Reconciliation logic
        config/ - Kubernetes resource manifests
        Makefile - Build and deployment commands
        main.go - Operator entry point
      
    
    
      
        Dockerfile - Container image definition
        go.mod - Go module dependencies
        hack/ - Scripts and tools
        PROJECT - Kubebuilder project metadata
      
    
  


Here’s a more detailed view of the generated project structure:

.
├── api                     # API definitions
│   └── v1
│       ├── groupversion_info.go
│       ├── namespacesync_types.go  # CRD definition
│       └── zz_generated.deepcopy.go
├── bin                     # Binaries
├── cmd                     # Command-line interfaces
│   └── main.go             # Main entry point
├── config                  # Kubernetes configuration
│   ├── crd                 # Custom Resource Definitions
│   ├── default             # Default configurations
│   ├── manager             # Controller manager
│   ├── rbac                # Role-based access control
│   └── samples             # Sample custom resources
├── controllers             # Controller logic
│   ├── namespacesync_controller.go  # Main controller logic
│   └── suite_test.go                # Test setup
├── Dockerfile              # Container build instructions
├── go.mod                  # Go module definition
├── go.sum                  # Go dependencies checksum
├── hack                    # Scripts and tools
│   └── boilerplate.go.txt
├── Makefile                # Build, test, and deploy commands
└── PROJECT                 # Project metadata




Defining Custom Resources

The core of your operator is the Custom Resource Definition (CRD). This defines the API that users will interact with.

Understanding the API Definition

Let’s examine the API definition in api/v1/namespacesync_types.go:

// NamespaceSyncSpec defines the desired state of NamespaceSync
type NamespaceSyncSpec struct {
	// SourceNamespace is the namespace to sync resources from
	// +kubebuilder:validation:Required
	SourceNamespace string `json:&quot;sourceNamespace&quot;`

	// TargetNamespaces is a list of namespaces to sync resources to
	// +optional
	TargetNamespaces []string `json:&quot;targetNamespaces,omitempty&quot;`

	// NamespaceSelector selects namespaces to sync resources to
	// +optional
	NamespaceSelector *metav1.LabelSelector `json:&quot;namespaceSelector,omitempty&quot;`

	// Resources is a list of resources to sync
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:MinItems=1
	Resources []ResourceSelector `json:&quot;resources&quot;`
}

// ResourceSelector defines which resources to sync
type ResourceSelector struct {
	// Kind of the resource (e.g. ConfigMap, Secret)
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Enum=ConfigMap;Secret
	Kind string `json:&quot;kind&quot;`

	// Name of the resource
	// +kubebuilder:validation:Required
	Name string `json:&quot;name&quot;`
}

// NamespaceSyncStatus defines the observed state of NamespaceSync
type NamespaceSyncStatus struct {
	// Conditions represent the latest available observations of the NamespaceSync
	// +optional
	Conditions []metav1.Condition `json:&quot;conditions,omitempty&quot;`
}


Adding Kubebuilder Markers

Kubebuilder uses special comment markers to generate additional code and metadata:

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:printcolumn:name=&quot;Source&quot;,type=&quot;string&quot;,JSONPath=&quot;.spec.sourceNamespace&quot;
// +kubebuilder:printcolumn:name=&quot;Age&quot;,type=&quot;date&quot;,JSONPath=&quot;.metadata.creationTimestamp&quot;
// +kubebuilder:printcolumn:name=&quot;Status&quot;,type=&quot;string&quot;,JSONPath=&quot;.status.conditions[?(@.type==&apos;Ready&apos;)].status&quot;
// +kubebuilder:printcolumn:name=&quot;Message&quot;,type=&quot;string&quot;,JSONPath=&quot;.status.conditions[?(@.type==&apos;Ready&apos;)].message&quot;


These markers:

  Define the resource as a root object
  Add a status subresource
  Configure columns for kubectl get output
  Define validation rules for fields



  
    
      Marker Type
      Purpose
    
    
      object
      Defines object characteristics (e.g., root=true for top-level resources)
    
    
      subresource
      Adds subresources like status or scale
    
    
      printcolumn
      Configures columns in kubectl output
    
    
      validation
      Adds schema validation (e.g., required fields, enums)
    
    
      rbac
      Defines permissions needed for the controller
    
  




Implementing the Controller

The controller contains the reconciliation logic for your custom resource.

Understanding the Reconciliation Loop


  
    sequenceDiagram
      participant K as Kubernetes API
      participant C as Controller
      participant R as Reconcile Function
      
      K-&amp;gt;&amp;gt;C: Resource Change Event
      C-&amp;gt;&amp;gt;C: Add to Work Queue
      C-&amp;gt;&amp;gt;R: Call Reconcile()
      R-&amp;gt;&amp;gt;K: Get Current State
      R-&amp;gt;&amp;gt;R: Compare with Desired State
      R-&amp;gt;&amp;gt;K: Apply Changes
      R-&amp;gt;&amp;gt;C: Return Result
      Note over C: If Error or Requeue
      C-&amp;gt;&amp;gt;C: Add Back to Queue
  


The controller watches for changes to your custom resource and other related resources, then triggers the reconciliation loop to ensure the actual state matches the desired state.

Controller Implementation

Let’s look at a simplified version of a controller from our NamespaceSync example:

// NamespaceSyncReconciler reconciles a NamespaceSync object
type NamespaceSyncReconciler struct {
	client.Client
	Scheme *runtime.Scheme
	Recorder record.EventRecorder
}

// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs/status,verbs=get;update;patch
// +kubebuilder:rbac:groups=sync.nsync.dev,resources=namespacesyncs/finalizers,verbs=update
// +kubebuilder:rbac:groups=&quot;&quot;,resources=namespaces,verbs=get;list;watch
// +kubebuilder:rbac:groups=&quot;&quot;,resources=configmaps;secrets,verbs=get;list;watch;create;update;patch;delete

func (r *NamespaceSyncReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	log := log.FromContext(ctx)
	
	// Fetch the NamespaceSync instance
	var namespacesync syncv1.NamespaceSync
	if err := r.Get(ctx, req.NamespacedName, &amp;amp;namespacesync); err != nil {
		// Handle not-found error
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}
	
	// Add finalizer if needed
	if !controllerutil.ContainsFinalizer(&amp;amp;namespacesync, finalizerName) {
		controllerutil.AddFinalizer(&amp;amp;namespacesync, finalizerName)
		if err := r.Update(ctx, &amp;amp;namespacesync); err != nil {
			log.Error(err, &quot;Failed to add finalizer&quot;)
			return ctrl.Result{}, err
		}
	}
	
	// Check if being deleted
	if !namespacesync.ObjectMeta.DeletionTimestamp.IsZero() {
		return r.handleDeletion(ctx, &amp;amp;namespacesync)
	}
	
	// Get target namespaces
	targetNamespaces, err := r.getTargetNamespaces(ctx, &amp;amp;namespacesync)
	if err != nil {
		return ctrl.Result{}, err
	}
	
	// Synchronize resources to target namespaces
	if err := r.syncResources(ctx, &amp;amp;namespacesync, targetNamespaces); err != nil {
		// Update status to reflect error
		r.updateStatusCondition(&amp;amp;namespacesync, metav1.ConditionFalse, &quot;SyncFailed&quot;, err.Error())
		return ctrl.Result{}, err
	}
	
	// Update status to reflect success
	r.updateStatusCondition(&amp;amp;namespacesync, metav1.ConditionTrue, &quot;Synced&quot;, &quot;Resources synchronized successfully&quot;)
	
	return ctrl.Result{RequeueAfter: 5 * time.Minute}, nil
}


Key Controller Components


  RBAC Markers: Define the permissions needed by the controller
  Reconcile Function: Main logic that handles the resource
  Finalizers: Ensure cleanup when resources are deleted
  Status Updates: Report the current state back to the user




Building and Testing Your Operator

Key Makefile Commands

Kubebuilder creates a comprehensive Makefile with all necessary commands:


  
    
      Command
      Description
    
    
      make generate
      Generate code (DeepCopy methods, etc.) for custom resources
    
    
      make manifests
      Generate CRD manifests and RBAC configuration
    
    
      make test
      Run unit tests with a simulated Kubernetes API server
    
    
      make run
      Run the controller locally against your configured Kubernetes cluster
    
    
      make docker-build
      Build the Docker image
    
    
      make docker-push
      Push the Docker image to a registry
    
    
      make deploy
      Deploy the controller to the Kubernetes cluster
    
  


Running Tests

Kubebuilder integrates with the Kubernetes envtest package to simulate the API server for testing:

// controllers/suite_test.go
func TestAPIs(t *testing.T) {
	RegisterFailHandler(Fail)
	RunSpecs(t, &quot;Controller Suite&quot;)
}

var _ = BeforeSuite(func() {
	logf.SetLogger(zap.New(zap.WriteTo(GinkgoWriter), zap.UseDevMode(true)))

	By(&quot;bootstrapping test environment&quot;)
	testEnv = &amp;amp;envtest.Environment{
		CRDDirectoryPaths:     []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
		ErrorIfCRDPathMissing: true,
	}

	cfg, err := testEnv.Start()
	Expect(err).NotTo(HaveOccurred())
	Expect(cfg).NotTo(BeNil())

	err = syncv1.AddToScheme(scheme.Scheme)
	Expect(err).NotTo(HaveOccurred())

	k8sClient, err = client.New(cfg, client.Options{Scheme: scheme.Scheme})
	Expect(err).NotTo(HaveOccurred())
	Expect(k8sClient).NotTo(BeNil())
})


To run tests:

make test


Building for Multiple Platforms

For cross-platform support, add a multi-platform build rule to your Makefile:







Real-World Example: Namespace Sync Operator

Let’s explore a real-world example of a Kubernetes Operator built with Kubebuilder: a Namespace Synchronization Operator that copies resources from one namespace to others.

Use Case


  Synchronize ConfigMaps and Secrets from a source namespace to multiple target namespaces
  Target namespaces can be explicitly listed or selected via labels
  Resources stay in sync automatically when the source changes


CRD Example

apiVersion: sync.nsync.dev/v1
kind: NamespaceSync
metadata:
  name: config-sync
spec:
  sourceNamespace: source-namespace
  targetNamespaces:
    - target-namespace-1
    - target-namespace-2
  resources:
    - kind: ConfigMap
      name: shared-config
    - kind: Secret
      name: shared-credentials


Or using a namespace selector:

apiVersion: sync.nsync.dev/v1
kind: NamespaceSync
metadata:
  name: config-sync-all
spec:
  sourceNamespace: source-namespace
  namespaceSelector:
    matchLabels:
      sync-enabled: &quot;true&quot;
  resources:
    - kind: ConfigMap
      name: shared-config


Building the Feature Step by Step


  Resource Synchronization Logic:


func (r *NamespaceSyncReconciler) syncResources(ctx context.Context, namespacesync *syncv1.NamespaceSync, targetNamespaces []string) error {
	log := log.FromContext(ctx)
	sourceNamespace := namespacesync.Spec.SourceNamespace
	
	for _, res := range namespacesync.Spec.Resources {
		// Get source resource
		sourceObj, err := r.getSourceResource(ctx, sourceNamespace, res)
		if err != nil {
			return err
		}
		
		// Apply to target namespaces
		for _, targetNs := range targetNamespaces {
			if targetNs == sourceNamespace {
				// Skip source namespace
				continue
			}
			
			if err := r.applyToTarget(ctx, sourceObj, targetNs); err != nil {
				log.Error(err, &quot;Failed to apply resource to target&quot;, 
					&quot;kind&quot;, res.Kind, &quot;name&quot;, res.Name, &quot;target&quot;, targetNs)
				continue
			}
			
			log.Info(&quot;Synchronized resource&quot;, 
				&quot;kind&quot;, res.Kind, &quot;name&quot;, res.Name, 
				&quot;from&quot;, sourceNamespace, &quot;to&quot;, targetNs)
		}
	}
	
	return nil
}



  Target Namespace Resolution:


func (r *NamespaceSyncReconciler) getTargetNamespaces(ctx context.Context, namespacesync *syncv1.NamespaceSync) ([]string, error) {
	// If explicit targets provided, use those
	if len(namespacesync.Spec.TargetNamespaces) &amp;gt; 0 {
		return namespacesync.Spec.TargetNamespaces, nil
	}
	
	// If selector provided, query matching namespaces
	if namespacesync.Spec.NamespaceSelector != nil {
		selector, err := metav1.LabelSelectorAsSelector(namespacesync.Spec.NamespaceSelector)
		if err != nil {
			return nil, err
		}
		
		var namespaceList corev1.NamespaceList
		if err := r.List(ctx, &amp;amp;namespaceList, &amp;amp;client.ListOptions{
			LabelSelector: selector,
		}); err != nil {
			return nil, err
		}
		
		result := make([]string, 0, len(namespaceList.Items))
		for _, ns := range namespaceList.Items {
			result = append(result, ns.Name)
		}
		return result, nil
	}
	
	// No targets specified
	return nil, fmt.Errorf(&quot;no target namespaces specified&quot;)
}


Testing the Operator

To test the operator locally:

# Run the controller against your configured Kubernetes cluster
make run

# In another terminal, apply a sample CR
kubectl apply -f config/samples/sync_v1_namespacesync.yaml

# Check the status
kubectl get namespacesync

# Verify resources were synced
kubectl get configmap -n target-namespace-1




Deploying Your Operator

Building and Pushing the Container Image

# Set the image name
export IMG=yourdockerhub/namespace-sync:v0.1.0

# Build and push
make docker-build docker-push IMG=$IMG


Deploying to a Kubernetes Cluster

# Install the CRDs
make install

# Deploy the controller
make deploy IMG=$IMG


Verifying the Deployment

# Check the operator deployment
kubectl get pods -n namespace-sync-system

# Check the CRD
kubectl get crd | grep namespacesync

# Check if any CRs exist
kubectl get namespacesync --all-namespaces




Advanced Topics

Finalizers

Finalizers ensure proper cleanup when resources are deleted:

const finalizerName = &quot;namespacesync.sync.nsync.dev/finalizer&quot;

func (r *NamespaceSyncReconciler) handleDeletion(ctx context.Context, namespacesync *syncv1.NamespaceSync) (ctrl.Result, error) {
	log := log.FromContext(ctx)
	
	// Perform cleanup here...
	log.Info(&quot;Cleaning up resources&quot;)
	
	// When finished, remove the finalizer
	controllerutil.RemoveFinalizer(namespacesync, finalizerName)
	if err := r.Update(ctx, namespacesync); err != nil {
		return ctrl.Result{}, err
	}
	
	log.Info(&quot;Finalizer removed&quot;)
	return ctrl.Result{}, nil
}


Webhooks

Kubebuilder supports generating admission webhooks for validation and defaulting:

# Add webhook support to your API
kubebuilder create webhook --group sync --version v1 --kind NamespaceSync --defaulting --programmatic-validation


Metrics and Monitoring

The controller-runtime library automatically exposes Prometheus metrics. Add custom metrics:

var (
	syncCount = promauto.NewCounterVec(
		prometheus.CounterOpts{
			Name: &quot;namespacesync_resources_synced_total&quot;,
			Help: &quot;Number of resources synced by the operator&quot;,
		},
		[]string{&quot;kind&quot;, &quot;source_namespace&quot;, &quot;target_namespace&quot;},
	)
)

// Use in your reconciler
syncCount.WithLabelValues(res.Kind, sourceNamespace, targetNs).Inc()




Best Practices for Operator Development


  Design Principles
  
    Follow the single responsibility principle - one operator for one application type
    Make operations idempotent - reconcile function should be safe to call multiple times
    Design for eventual consistency - handle delays and unavailability gracefully
    Add proper status reporting so users can understand the current state
    Structure your reconciliation to achieve maximum convergence
    Use owner references to manage related resources
  
  
  Implementation Best Practices
  
    Add clear documentation with examples in your CRDs
    Include meaningful validation to catch errors early
    Use shared informers for watching resources
    Implement proper error handling with appropriate backoff
    Add thorough unit and integration tests
    Minimize container image size for faster deployments
  
  
  Operational Best Practices
  
    Implement proper logging with structured contextual information
    Add Prometheus metrics for monitoring
    Set resource requests and limits on controller pods
    Implement leader election for high availability
    Version your APIs properly using semantic versioning
    Document upgrade procedures for your operator
  




Conclusion

Building Kubernetes Operators with Kubebuilder streamlines the development process for extending Kubernetes with custom resources and controllers. This guide demonstrated the key steps in creating an operator, from project initialization to deployment, using a real-world Namespace Synchronization example.

As your operators grow more complex, leveraging the full power of Kubebuilder’s scaffolding, code generation, and testing tools will help you create robust, production-ready extensions to Kubernetes.





References


  Kubebuilder Documentation
  Kubernetes Operator Pattern
  Namespace Sync Example
  Helios Load Balancer
  Controller-Runtime Library
  Operator Best Practices

",
            "wordcount": "3578",
            "inLanguage": "en",
            "dateCreated": "2025-01-14/",
            "datePublished": "2025-01-14/",
            "dateModified": "2025-01-14/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "KUBERNETES",
            "articleSection": "KUBERNETES",
            "keywords": ["kubernetes","operator","kubebuilder","development","go","custom-resources"]
        }
        </script>
    </body>
</html>
