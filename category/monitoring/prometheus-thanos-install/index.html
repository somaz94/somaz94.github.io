<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>Installing Prometheus and Thanos with Helm | somaz</title>
    <meta name="description" content="Learn how to install and configure Prometheus and Thanos using Helm charts for scalable monitoring">
    
        <meta name="keywords" content="prometheus, thanos, helm, kubernetes">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Installing Prometheus and Thanos with Helm | somaz">
    <meta name="twitter:description" content="Learn how to install and configure Prometheus and Thanos using Helm charts for scalable monitoring">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1738640346/prometheus-thans-archi_zfo72f.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/monitoring/prometheus-thanos-install/">
    <meta property="og:title" content="Installing Prometheus and Thanos with Helm | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1738640346/prometheus-thans-archi_zfo72f.png">
    <meta property="og:description" content="Learn how to install and configure Prometheus and Thanos using Helm charts for scalable monitoring">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/monitoring/prometheus-thanos-install/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-06-04T00:00:00+00:00">
                            


June 4, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>36 min to read</span>
                </p>
                <h1 class="post-title">Installing Prometheus and Thanos with Helm</h1>
                <p class="post-subtitle">Complete guide to deploying, securing, and operating Prometheus and Thanos from basic setup to enterprise-grade production deployments</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1738640346/prometheus-thans-archi_zfo72f.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><a href="https://particule.io/en/blog/thanos-monitoring/">Image Reference</a></p>

<p><br /></p>

<hr />

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="#overview-and-architecture">Overview and Architecture</a></li>
  <li><a href="#prerequisites-and-planning">Prerequisites and Planning</a></li>
  <li><a href="#basic-installation-with-helm">Basic Installation with Helm</a></li>
  <li><a href="#enterprise-architecture-implementation">Enterprise Architecture Implementation</a></li>
  <li><a href="#advanced-configuration-and-optimization">Advanced Configuration and Optimization</a></li>
  <li><a href="#multi-cluster-federation">Multi-Cluster Federation</a></li>
  <li><a href="#security-and-compliance">Security and Compliance</a></li>
  <li><a href="#performance-optimization">Performance Optimization</a></li>
  <li><a href="#operational-excellence">Operational Excellence</a></li>
  <li><a href="#disaster-recovery">Disaster Recovery</a></li>
  <li><a href="#troubleshooting-and-best-practices">Troubleshooting and Best Practices</a></li>
</ol>

<hr />

<h2 id="overview-and-architecture">Overview and Architecture</h2>

<p>Enterprise monitoring infrastructure demands sophisticated solutions that can scale across global deployments while maintaining reliability, security, and operational simplicity.</p>

<p>Prometheus and Thanos together form the foundation of modern observability platforms, providing metrics collection, long-term storage, and unified querying capabilities that meet the most demanding enterprise requirements.</p>

<p><br /></p>

<h3 id="evolution-of-enterprise-monitoring">Evolution of Enterprise Monitoring</h3>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      A[Enterprise Monitoring Evolution] --&gt; B[Traditional Monitoring<br />2000-2010]
      A --&gt; C[Cloud-Native Monitoring<br />2010-2020]
      A --&gt; D[Distributed Observability<br />2020-Present]
      
      B --&gt; B1[SNMP/Nagios]
      B --&gt; B2[Centralized Architecture]
      B --&gt; B3[Manual Configuration]
      
      C --&gt; C1[Prometheus/Grafana]
      C --&gt; C2[Container Monitoring]
      C --&gt; C3[Service Discovery]
      C --&gt; C4[Pull-based Metrics]
      
      D --&gt; D1[Multi-Cluster Federation]
      D --&gt; D2[Long-term Storage]
      D --&gt; D3[Global Query Layer]
      D --&gt; D4[Observability as Code]
      D --&gt; D5[AI-driven Insights]
  </div>
</div>

<p><br /></p>

<h3 id="core-architecture-components">Core Architecture Components</h3>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      subgraph "Control Plane Layer"
        ThanosQuery[Thanos Query<br />Global Query Interface]
        ThanosQueryFrontend[Thanos Query Frontend<br />Query Optimization]
        ThanosRuler[Thanos Ruler<br />Global Alerting]
      end
      
      subgraph "Data Plane Layer"
        subgraph "Cluster 1"
          Prom1[Prometheus<br />Metrics Collection]
          ThanosReceive1[Thanos Receive<br />Remote Write]
          ThanosSidecar1[Thanos Sidecar<br />Upload Agent]
        end
        
        subgraph "Cluster 2"
          Prom2[Prometheus<br />Metrics Collection]
          ThanosReceive2[Thanos Receive<br />Remote Write]
          ThanosSidecar2[Thanos Sidecar<br />Upload Agent]
        end
      end
      
      subgraph "Storage Layer"
        ObjectStorage[(Object Storage<br />S3/GCS/Azure)]
        ThanosCompactor[Thanos Compactor<br />Data Processing]
        ThanosStore[Thanos Store<br />Query Gateway]
      end
      
      subgraph "Operational Layer"
        Grafana[Grafana<br />Visualization]
        Alertmanager[Alertmanager<br />Notification]
        ServiceMesh[Service Mesh<br />Istio/Linkerd]
      end
      
      ThanosQuery --&gt; ThanosReceive1
      ThanosQuery --&gt; ThanosReceive2
      ThanosQuery --&gt; ThanosStore
      ThanosQueryFrontend --&gt; ThanosQuery
      
      ThanosSidecar1 --&gt; ObjectStorage
      ThanosSidecar2 --&gt; ObjectStorage
      ThanosReceive1 --&gt; ObjectStorage
      ThanosReceive2 --&gt; ObjectStorage
      
      ThanosCompactor --&gt; ObjectStorage
      ThanosStore --&gt; ObjectStorage
      
      ThanosRuler --&gt; Alertmanager
      ThanosQueryFrontend --&gt; Grafana
  </div>
</div>

<hr />

<h2 id="prerequisites-and-planning">Prerequisites and Planning</h2>

<p><br /></p>

<h3 id="technical-prerequisites">Technical Prerequisites</h3>

<p>Before implementing your monitoring infrastructure, ensure you have the following components in place:</p>

<h4 id="infrastructure-requirements">Infrastructure Requirements:</h4>
<ul>
  <li><strong>Kubernetes Cluster</strong>: v1.24+ with proper networking configuration</li>
  <li><strong>Storage Provisioner</strong>: For persistent volumes (recommended: SSD-based storage classes)</li>
  <li><strong>Object Storage</strong>: S3, GCS, MinIO, or other compatible object storage</li>
  <li><strong>Network Connectivity</strong>: Proper ingress configuration and DNS resolution</li>
  <li><strong>Resource Allocation</strong>: Adequate CPU, memory, and storage for monitoring workloads</li>
</ul>

<h4 id="tool-requirements">Tool Requirements:</h4>
<ul>
  <li><strong>Helm</strong>: Version 3.12+ installed and configured</li>
  <li><strong>kubectl</strong>: Properly configured with cluster access</li>
  <li><strong>DNS</strong>: Proper DNS configuration for service discovery</li>
  <li><strong>TLS Certificates</strong>: For secure communications (recommended)</li>
</ul>

<h4 id="access-requirements">Access Requirements:</h4>
<ul>
  <li><strong>Object Storage Access</strong>: Credentials for chosen storage provider</li>
  <li><strong>Cluster Admin Rights</strong>: For installing CRDs and operators</li>
  <li><strong>Network Access</strong>: Between clusters for multi-cluster setups</li>
</ul>

<p><br /></p>

<h3 id="capacity-planning">Capacity Planning</h3>

<h4 id="resource-requirements-by-deployment-size">Resource Requirements by Deployment Size:</h4>

<div class="table-container">
  <table class="table-modern">
    <tr>
      <th>Deployment Size</th>
      <th>Prometheus Resources</th>
      <th>Thanos Resources</th>
      <th>Storage Requirements</th>
    </tr>
    <tr>
      <td><strong>Small</strong> (&lt; 1k series)</td>
      <td>2 vCPU, 4GB RAM</td>
      <td>1 vCPU, 2GB RAM</td>
      <td>50GB local, 100GB object</td>
    </tr>
    <tr>
      <td><strong>Medium</strong> (1k-10k series)</td>
      <td>4 vCPU, 8GB RAM</td>
      <td>2 vCPU, 4GB RAM</td>
      <td>200GB local, 1TB object</td>
    </tr>
    <tr>
      <td><strong>Large</strong> (10k-100k series)</td>
      <td>8 vCPU, 16GB RAM</td>
      <td>4 vCPU, 8GB RAM</td>
      <td>500GB local, 10TB object</td>
    </tr>
    <tr>
      <td><strong>Enterprise</strong> (100k+ series)</td>
      <td>16+ vCPU, 32+ GB RAM</td>
      <td>8+ vCPU, 16+ GB RAM</td>
      <td>1TB+ local, 100TB+ object</td>
    </tr>
  </table>
</div>

<p><br /></p>

<h3 id="installation-strategy-planning">Installation Strategy Planning</h3>

<h4 id="choose-your-installation-approach">Choose Your Installation Approach:</h4>

<div class="table-container">
  <table class="table-modern">
    <tr>
      <th>Approach</th>
      <th>Use Case</th>
      <th>Complexity</th>
      <th>Features</th>
    </tr>
    <tr>
      <td><strong>Basic Setup</strong></td>
      <td>Development, small teams</td>
      <td>Low</td>
      <td>Core monitoring capabilities</td>
    </tr>
    <tr>
      <td><strong>Production Ready</strong></td>
      <td>Small to medium production</td>
      <td>Medium</td>
      <td>HA, basic security, retention</td>
    </tr>
    <tr>
      <td><strong>Enterprise Grade</strong></td>
      <td>Large scale, compliance</td>
      <td>High</td>
      <td>Multi-tenant, federation, advanced security</td>
    </tr>
  </table>
</div>

<hr />

<h2 id="basic-installation-with-helm">Basic Installation with Helm</h2>

<p>This section provides step-by-step instructions for installing Prometheus and Thanos using Helm charts, progressing from basic to production-ready configurations.</p>

<p><br /></p>

<h3 id="preparation-steps">Preparation Steps</h3>

<h4 id="1-add-required-helm-repositories">1. Add Required Helm Repositories</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add Prometheus community repository</span>
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

<span class="c"># Add Bitnami repository for Thanos</span>
helm repo add bitnami https://charts.bitnami.com/bitnami

<span class="c"># Update repositories</span>
helm repo update

<span class="c"># Verify repositories</span>
helm repo list
</code></pre></div></div>

<h4 id="2-create-monitoring-namespace">2. Create Monitoring Namespace</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create dedicated namespace for monitoring</span>
kubectl create namespace monitoring

<span class="c"># Set default namespace for convenience</span>
kubectl config set-context <span class="nt">--current</span> <span class="nt">--namespace</span><span class="o">=</span>monitoring
</code></pre></div></div>

<h4 id="3-install-required-crds">3. Install Required CRDs</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Prometheus Operator CRDs</span>
helm <span class="nb">install </span>prometheus-operator-crds prometheus-community/prometheus-operator-crds <span class="nt">--namespace</span> monitoring
</code></pre></div></div>

<p><br /></p>

<h3 id="installation-options">Installation Options</h3>

<h4 id="option-1-basic-prometheus-installation">Option 1: Basic Prometheus Installation</h4>

<p><strong>Use Case</strong>: Development environments, getting started</p>

<p><br /></p>

<p>Create <code class="language-plaintext highlighter-rouge">values/prometheus-basic.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Basic Prometheus configuration</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">server</span>
  <span class="na">image</span><span class="pi">:</span>
    <span class="na">repository</span><span class="pi">:</span> <span class="s">quay.io/prometheus/prometheus</span>
    <span class="na">tag</span><span class="pi">:</span> <span class="s">latest</span>
  
  <span class="na">persistentVolume</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
    <span class="na">storageClass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">default"</span>
    <span class="na">size</span><span class="pi">:</span> <span class="s">50Gi</span>
  
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">statefulSet</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
  
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  
  <span class="c1"># Resource limits</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">4Gi</span>

<span class="c1"># Enable basic components</span>
<span class="na">alertmanager</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">persistence</span><span class="pi">:</span>
    <span class="na">size</span><span class="pi">:</span> <span class="s">2Gi</span>

<span class="na">kube-state-metrics</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">prometheus-node-exporter</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">prometheus-pushgateway</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p><strong>Installation:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>prometheus prometheus-community/prometheus <span class="nt">--namespace</span> monitoring <span class="nt">--values</span> values/prometheus-basic.yaml <span class="nt">--create-namespace</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="option-2-production-ready-with-kube-prometheus-stack">Option 2: Production-Ready with Kube-Prometheus-Stack</h4>

<p><strong>Use Case</strong>: Production environments with comprehensive monitoring</p>

<p>Create <code class="language-plaintext highlighter-rouge">values/kube-prometheus-stack.yaml</code>:</p>

<script src="https://gist.github.com/somaz94/73e65f000f54a5a5978128f07042775d.js"></script>

<p><br /></p>

<h4 id="installation">Installation:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>kube-prometheus-stack prometheus-community/kube-prometheus-stack <span class="nt">--namespace</span> monitoring <span class="nt">--values</span> values/kube-prometheus-stack.yaml <span class="nt">--create-namespace</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="object-storage-configuration">Object Storage Configuration</h3>

<p>Before installing Thanos, configure object storage for long-term metrics retention.</p>

<h4 id="create-object-storage-configuration">Create Object Storage Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">objstore.yml</code> with your storage provider configuration:</p>

<p><br /></p>

<p><strong>For AWS S3:</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">type</span><span class="pi">:</span> <span class="s">s3</span>
<span class="na">config</span><span class="pi">:</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your-thanos-bucket"</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3.us-west-2.amazonaws.com"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">us-west-2"</span>
  <span class="na">access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">YOUR_ACCESS_KEY"</span>
  <span class="na">secret_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">YOUR_SECRET_KEY"</span>
  <span class="na">insecure</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">signature_version2</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">encrypt_sse</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">put_user_metadata</span><span class="pi">:</span>
    <span class="s2">"</span><span class="s">X-Amz-Acl"</span><span class="err">:</span> <span class="s2">"</span><span class="s">private"</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>For Google Cloud Storage:</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">type</span><span class="pi">:</span> <span class="s">gcs</span>
<span class="na">config</span><span class="pi">:</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your-thanos-bucket"</span>
  <span class="na">service_account</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">{</span>
      <span class="s">"type": "service_account",</span>
      <span class="s">"project_id": "your-project",</span>
      <span class="s">"private_key_id": "...",</span>
      <span class="s">"private_key": "...",</span>
      <span class="s">"client_email": "...",</span>
      <span class="s">"client_id": "...",</span>
      <span class="s">"auth_uri": "https://accounts.google.com/o/oauth2/auth",</span>
      <span class="s">"token_uri": "https://oauth2.googleapis.com/token"</span>
    <span class="s">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>For MinIO (Development/Testing):</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">type</span><span class="pi">:</span> <span class="s">s3</span>
<span class="na">config</span><span class="pi">:</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">thanos"</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">minio.storage.svc.cluster.local:9000"</span>
  <span class="na">access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">minioadmin"</span>
  <span class="na">secret_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">minioadmin"</span>
  <span class="na">insecure</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">signature_version2</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="create-kubernetes-secret">Create Kubernetes Secret</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create the object storage secret</span>
kubectl create secret generic thanos-objstore <span class="nt">--from-file</span><span class="o">=</span>objstore.yml <span class="nt">--namespace</span> monitoring
</code></pre></div></div>

<p><br /></p>

<h3 id="thanos-installation">Thanos Installation</h3>

<h4 id="single-cluster-thanos-configuration">Single-Cluster Thanos Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">values/thanos-single-cluster.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Global configuration</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">storageClass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">fast-ssd"</span>
  <span class="na">imageRegistry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quay.io"</span>

<span class="c1"># Cluster domain configuration</span>
<span class="na">clusterDomain</span><span class="pi">:</span> <span class="s">cluster.local</span>
<span class="na">fullnameOverride</span><span class="pi">:</span> <span class="s2">"</span><span class="s">thanos"</span>

<span class="c1"># Object storage configuration</span>
<span class="na">existingObjstoreSecret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">thanos-objstore"</span>

<span class="c1"># Query component configuration</span>
<span class="na">query</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">logLevel</span><span class="pi">:</span> <span class="s">info</span>
  
  <span class="c1"># Replica labels for deduplication</span>
  <span class="na">replicaLabel</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prometheus_replica</span>
    <span class="pi">-</span> <span class="s">__replica__</span>
  
  <span class="c1"># Store endpoints</span>
  <span class="na">stores</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">4Gi</span>
  
  <span class="c1"># Service configuration</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="na">http</span><span class="pi">:</span> <span class="m">9090</span>
      <span class="na">grpc</span><span class="pi">:</span> <span class="m">10901</span>
  
  <span class="c1"># Ingress configuration</span>
  <span class="na">ingress</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">thanos-query.your-domain.com</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">tls</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">extraTls</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">thanos-query.your-domain.com</span>
      <span class="na">secretName</span><span class="pi">:</span> <span class="s">thanos-query-tls</span>

<span class="c1"># Query Frontend component</span>
<span class="na">queryFrontend</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">1000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">2Gi</span>
  
  <span class="c1"># Configuration</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">type: in-memory</span>
    <span class="s">config:</span>
      <span class="s">max_size: 256MB</span>
      <span class="s">validity: 24h</span>
  
  <span class="c1"># Ingress configuration</span>
  <span class="na">ingress</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">thanos.your-domain.com</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">tls</span><span class="pi">:</span> <span class="no">true</span>

<span class="c1"># Compactor component</span>
<span class="na">compactor</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Retention configuration</span>
  <span class="na">retentionResolutionRaw</span><span class="pi">:</span> <span class="s">30d</span>      <span class="c1"># Raw data retention</span>
  <span class="na">retentionResolution5m</span><span class="pi">:</span> <span class="s">90d</span>       <span class="c1"># 5-minute downsampled data</span>
  <span class="na">retentionResolution1h</span><span class="pi">:</span> <span class="s">2y</span>        <span class="c1"># 1-hour downsampled data</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">1000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">2Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">4Gi</span>
  
  <span class="c1"># Persistence configuration</span>
  <span class="na">persistence</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">storageClass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">fast-ssd"</span>
    <span class="na">size</span><span class="pi">:</span> <span class="s">20Gi</span>
  
  <span class="c1"># Compaction configuration</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">compactor:</span>
      <span class="s">sync-delay: 30m</span>
      <span class="s">retention-resolution-raw: 30d</span>
      <span class="s">retention-resolution-5m: 90d</span>
      <span class="s">retention-resolution-1h: 2y</span>
      <span class="s">wait: true</span>
      <span class="s">block-sync-concurrency: 20</span>
      <span class="s">compact-concurrency: 1</span>
      <span class="s">downsample-concurrency: 1</span>

<span class="c1"># Store Gateway component</span>
<span class="na">storegateway</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">2Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
  
  <span class="c1"># Persistence for caching</span>
  <span class="na">persistence</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">storageClass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">fast-ssd"</span>
    <span class="na">size</span><span class="pi">:</span> <span class="s">50Gi</span>
  
  <span class="c1"># Configuration</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">store:</span>
      <span class="s">sync-block-duration: 3m</span>
      <span class="s">block-sync-concurrency: 20</span>
      <span class="s">index-cache-size: 1GB</span>
      <span class="s">chunk-pool-size: 2GB</span>

<span class="c1"># Ruler component (optional)</span>
<span class="na">ruler</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># Enable if you need global alerting rules</span>
  
  <span class="c1"># Alertmanager configuration</span>
  <span class="na">alertmanagers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093</span>
  
  <span class="c1"># Evaluation interval</span>
  <span class="na">evalInterval</span><span class="pi">:</span> <span class="s">15s</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">1000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">2Gi</span>

<span class="c1"># Receive component (optional for remote write)</span>
<span class="na">receive</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># Enable for remote write scenarios</span>
</code></pre></div></div>

<h4 id="install-thanos">Install Thanos</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>thanos bitnami/thanos <span class="nt">--namespace</span> monitoring <span class="nt">--values</span> values/thanos-single-cluster.yaml
</code></pre></div></div>

<p><br /></p>

<h3 id="verification-and-basic-testing">Verification and Basic Testing</h3>

<h4 id="check-installation-status">Check Installation Status</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check all monitoring pods</span>
kubectl get pods <span class="nt">-n</span> monitoring

<span class="c"># Check services</span>
kubectl get svc <span class="nt">-n</span> monitoring

<span class="c"># Check ingresses</span>
kubectl get ingress <span class="nt">-n</span> monitoring
</code></pre></div></div>

<h4 id="verify-component-health">Verify Component Health</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check Prometheus health</span>
kubectl port-forward svc/kube-prometheus-stack-prometheus 9090:9090 <span class="nt">-n</span> monitoring &amp;
curl http://localhost:9090/-/healthy

<span class="c"># Check Thanos Query health</span>
kubectl port-forward svc/thanos-query 9090:9090 <span class="nt">-n</span> monitoring &amp;
curl http://localhost:9090/-/healthy

<span class="c"># Check Thanos Store health</span>
kubectl port-forward svc/thanos-storegateway 10902:10902 <span class="nt">-n</span> monitoring &amp;
curl http://localhost:10902/-/healthy
</code></pre></div></div>

<h4 id="test-metric-queries">Test Metric Queries</h4>

<p>Access Thanos Query UI and verify:</p>

<ol>
  <li><strong>Basic connectivity</strong>: Navigate to Thanos Query UI</li>
  <li><strong>Store status</strong>: Check the “Stores” page to verify all stores are connected</li>
  <li><strong>Query functionality</strong>: Run simple queries like <code class="language-plaintext highlighter-rouge">up</code> or <code class="language-plaintext highlighter-rouge">prometheus_build_info</code></li>
  <li><strong>Data availability</strong>: Verify metrics from different time ranges</li>
</ol>

<hr />

<h2 id="enterprise-architecture-implementation">Enterprise Architecture Implementation</h2>

<p>Once you have a basic setup running, you can evolve your monitoring infrastructure to meet enterprise requirements. This section covers advanced architectural patterns and configurations.</p>

<p><br /></p>

<h3 id="multi-tenancy-implementation">Multi-Tenancy Implementation</h3>

<h4 id="tenant-isolation-strategy">Tenant Isolation Strategy</h4>

<p>Create <code class="language-plaintext highlighter-rouge">values/prometheus-multitenant.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Multi-tenant Prometheus configuration</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="c1"># Tenant-specific external labels</span>
  <span class="na">external_labels</span><span class="pi">:</span>
    <span class="na">tenant</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${TENANT_ID}"</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${CLUSTER_NAME}"</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${ENVIRONMENT}"</span>

<span class="na">prometheus</span><span class="pi">:</span>
  <span class="na">prometheusSpec</span><span class="pi">:</span>
    <span class="c1"># Tenant-specific configuration</span>
    <span class="na">externalLabels</span><span class="pi">:</span>
      <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
      <span class="na">cluster</span><span class="pi">:</span> <span class="s">production-east</span>
      <span class="na">environment</span><span class="pi">:</span> <span class="s">prod</span>
    
    <span class="c1"># Resource isolation per tenant</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">4Gi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2000m"</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">16Gi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">8000m"</span>
    
    <span class="c1"># Storage isolation</span>
    <span class="na">storageSpec</span><span class="pi">:</span>
      <span class="na">volumeClaimTemplate</span><span class="pi">:</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">premium-ssd</span>
          <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
              <span class="na">storage</span><span class="pi">:</span> <span class="s">200Gi</span>
    
    <span class="c1"># Service monitoring scoped to tenant</span>
    <span class="na">serviceMonitorSelector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
    
    <span class="na">podMonitorSelector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
    
    <span class="c1"># Security context</span>
    <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
      <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">65534</span>
    
    <span class="c1"># Network policies for isolation</span>
    <span class="na">podMetadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
        <span class="na">monitoring</span><span class="pi">:</span> <span class="s">prometheus</span>
</code></pre></div></div>

<h4 id="network-isolation">Network Isolation</h4>

<p>Create <code class="language-plaintext highlighter-rouge">network-policies/tenant-isolation.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tenant-prometheus-isolation</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="c1"># Allow ingress from ingress controllers</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
  
  <span class="c1"># Allow inter-component communication within monitoring namespace</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">10901</span>
  
  <span class="na">egress</span><span class="pi">:</span>
  <span class="c1"># Allow DNS resolution</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
  
  <span class="c1"># Allow HTTPS to object storage</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
  
  <span class="c1"># Allow communication to tenant-specific targets</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">tenant</span><span class="pi">:</span> <span class="s">tenant-a</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="high-availability-configuration">High Availability Configuration</h3>

<h4 id="ha-prometheus-setup">HA Prometheus Setup</h4>

<p>Create <code class="language-plaintext highlighter-rouge">values/prometheus-ha.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">prometheus</span><span class="pi">:</span>
  <span class="na">prometheusSpec</span><span class="pi">:</span>
    <span class="c1"># High availability with multiple replicas</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
    
    <span class="c1"># Pod disruption budget</span>
    <span class="na">podDisruptionBudget</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">minAvailable</span><span class="pi">:</span> <span class="m">2</span>
    
    <span class="c1"># Anti-affinity for spreading across nodes</span>
    <span class="na">affinity</span><span class="pi">:</span>
      <span class="na">podAntiAffinity</span><span class="pi">:</span>
        <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">prometheus</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
        <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">prometheus</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">topology.kubernetes.io/zone</span>
    
    <span class="c1"># Node selector for dedicated monitoring nodes</span>
    <span class="na">nodeSelector</span><span class="pi">:</span>
      <span class="na">node-role</span><span class="pi">:</span> <span class="s">monitoring</span>
    
    <span class="c1"># Tolerations for monitoring nodes</span>
    <span class="na">tolerations</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">monitoring</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Equal</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
      <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
    
    <span class="c1"># Resource allocation for HA setup</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
    
    <span class="c1"># Sharding configuration for large scale</span>
    <span class="na">shards</span><span class="pi">:</span> <span class="m">2</span>
</code></pre></div></div>

<h4 id="ha-thanos-configuration">HA Thanos Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">values/thanos-ha.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># High Availability Thanos configuration</span>
<span class="na">query</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">3</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">4Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
  
  <span class="c1"># Anti-affinity configuration</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAntiAffinity</span><span class="pi">:</span>
      <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">podAffinityTerm</span><span class="pi">:</span>
          <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">thanos</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/component</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">query</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  
  <span class="c1"># Pod disruption budget</span>
  <span class="na">podDisruptionBudget</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">minAvailable</span><span class="pi">:</span> <span class="m">2</span>

<span class="na">storegateway</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">3</span>
  
  <span class="c1"># Sharding configuration</span>
  <span class="na">sharding</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Resource allocation for HA</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">2000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
  
  <span class="c1"># Anti-affinity for distribution</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAntiAffinity</span><span class="pi">:</span>
      <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">podAffinityTerm</span><span class="pi">:</span>
          <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/component</span>
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">storegateway</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>

<span class="na">compactor</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Single instance for compactor (stateful)</span>
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">1</span>
  
  <span class="c1"># Leader election for HA</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">compactor:</span>
      <span class="s">consistency-delay: 30m</span>
      <span class="s">wait: true</span>
      <span class="s">block-sync-concurrency: 20</span>
</code></pre></div></div>

<hr />

<h2 id="advanced-configuration-and-optimization">Advanced Configuration and Optimization</h2>

<p><br /></p>

<h3 id="performance-tuning">Performance Tuning</h3>

<h4 id="prometheus-performance-configuration">Prometheus Performance Configuration</h4>

<p><br /></p>

<p>Create <code class="language-plaintext highlighter-rouge">values/prometheus-performance.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">prometheus</span><span class="pi">:</span>
  <span class="na">prometheusSpec</span><span class="pi">:</span>
    <span class="c1"># Performance optimizations</span>
    <span class="na">additionalArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">--web.enable-lifecycle</span>
    <span class="pi">-</span> <span class="s">--web.enable-admin-api</span>
    <span class="pi">-</span> <span class="s">--storage.tsdb.min-block-duration=2h</span>
    <span class="pi">-</span> <span class="s">--storage.tsdb.max-block-duration=2h</span>
    <span class="pi">-</span> <span class="s">--storage.tsdb.wal-compression</span>
    <span class="pi">-</span> <span class="s">--query.max-concurrency=50</span>
    <span class="pi">-</span> <span class="s">--query.max-samples=50000000</span>
    <span class="pi">-</span> <span class="s">--storage.tsdb.retention.time=15d</span>
    <span class="pi">-</span> <span class="s">--storage.tsdb.retention.size=45GB</span>
    
    <span class="c1"># WAL configuration</span>
    <span class="na">walCompression</span><span class="pi">:</span> <span class="no">true</span>
    
    <span class="c1"># Resource allocation for high performance</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s">16000m</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">32Gi</span>
    
    <span class="c1"># Storage optimization</span>
    <span class="na">storageSpec</span><span class="pi">:</span>
      <span class="na">volumeClaimTemplate</span><span class="pi">:</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">premium-nvme</span>
          <span class="na">accessModes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ReadWriteOnce"</span><span class="pi">]</span>
          <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
              <span class="na">storage</span><span class="pi">:</span> <span class="s">500Gi</span>
    
    <span class="c1"># Scrape configuration optimization</span>
    <span class="na">scrapeInterval</span><span class="pi">:</span> <span class="s">15s</span>
    <span class="na">evaluationInterval</span><span class="pi">:</span> <span class="s">15s</span>
    
    <span class="c1"># Query optimization</span>
    <span class="na">queryLogFile</span><span class="pi">:</span> <span class="s">/prometheus/query.log</span>
    
    <span class="c1"># Remote write configuration for Thanos Receive</span>
    <span class="na">remoteWrite</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s">http://thanos-receive.monitoring.svc.cluster.local:19291/api/v1/receive</span>
      <span class="na">writeRelabelConfigs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">sourceLabels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__name__</span><span class="pi">]</span>
        <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">go_.*|process_.*|prometheus_.*'</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">drop</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="advanced-recording-rules">Advanced Recording Rules</h4>

<p>Create <code class="language-plaintext highlighter-rouge">rules/performance-rules.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PrometheusRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance-recording-rules</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">instance.rules</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">30s</span>
    <span class="na">rules</span><span class="pi">:</span>
    <span class="c1"># CPU utilization by instance</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">instance:cpu_utilization:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">(</span>
          <span class="s">1 - avg by (instance) (</span>
            <span class="s">rate(node_cpu_seconds_total{mode="idle"}[5m])</span>
          <span class="s">)</span>
        <span class="s">) * 100</span>
    
    <span class="c1"># Memory utilization by instance</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">instance:memory_utilization:ratio</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">(</span>
          <span class="s">1 - (</span>
            <span class="s">node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes</span>
          <span class="s">)</span>
        <span class="s">) * 100</span>
    
    <span class="c1"># Disk utilization by instance and device</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">instance:disk_utilization:ratio</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">(</span>
          <span class="s">1 - (</span>
            <span class="s">node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} /</span>
            <span class="s">node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"}</span>
          <span class="s">)</span>
        <span class="s">) * 100</span>
    
    <span class="c1"># Network throughput by instance</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">instance:network_throughput:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">sum by (instance) (</span>
          <span class="s">rate(node_network_receive_bytes_total[5m]) +</span>
          <span class="s">rate(node_network_transmit_bytes_total[5m])</span>
        <span class="s">)</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">application.rules</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">30s</span>
    <span class="na">rules</span><span class="pi">:</span>
    <span class="c1"># Application request rate</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">application:request_rate:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">sum by (service, namespace) (</span>
          <span class="s">rate(http_requests_total[5m])</span>
        <span class="s">)</span>
    
    <span class="c1"># Application error rate</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">application:error_rate:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">sum by (service, namespace) (</span>
          <span class="s">rate(http_requests_total{status=~"5.."}[5m])</span>
        <span class="s">) / sum by (service, namespace) (</span>
          <span class="s">rate(http_requests_total[5m])</span>
        <span class="s">) * 100</span>
    
    <span class="c1"># Application response time p99</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">application:response_time:p99</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">histogram_quantile(0.99,</span>
          <span class="s">sum by (service, namespace, le) (</span>
            <span class="s">rate(http_request_duration_seconds_bucket[5m])</span>
          <span class="s">)</span>
        <span class="s">)</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cluster.rules</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">60s</span>
    <span class="na">rules</span><span class="pi">:</span>
    <span class="c1"># Cluster CPU utilization</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">cluster:cpu_utilization:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">avg(instance:cpu_utilization:rate5m)</span>
    
    <span class="c1"># Cluster memory utilization</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">cluster:memory_utilization:ratio</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">(</span>
          <span class="s">sum(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) /</span>
          <span class="s">sum(node_memory_MemTotal_bytes)</span>
        <span class="s">) * 100</span>
    
    <span class="c1"># Cluster network throughput</span>
    <span class="pi">-</span> <span class="na">record</span><span class="pi">:</span> <span class="s">cluster:network_throughput:rate5m</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">sum(instance:network_throughput:rate5m)</span>
</code></pre></div></div>

<h4 id="thanos-performance-optimization">Thanos Performance Optimization</h4>

<p>Create <code class="language-plaintext highlighter-rouge">values/thanos-performance.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">query</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Performance configuration</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--query.timeout=15m</span>
  <span class="pi">-</span> <span class="s">--query.max-concurrent=100</span>
  <span class="pi">-</span> <span class="s">--query.lookback-delta=15m</span>
  <span class="pi">-</span> <span class="s">--query.auto-downsampling</span>
  <span class="pi">-</span> <span class="s">--query.partial-response</span>
  <span class="pi">-</span> <span class="s">--query.max-concurrent-select=16</span>
  <span class="pi">-</span> <span class="s">--store.unhealthy-timeout=5m</span>
  <span class="pi">-</span> <span class="s">--store.response-timeout=30s</span>
  
  <span class="c1"># Resource allocation for high performance</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>

<span class="na">queryFrontend</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Query optimization configuration</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--query-range.split-interval=24h</span>
  <span class="pi">-</span> <span class="s">--query-range.max-retries-per-request=3</span>
  <span class="pi">-</span> <span class="s">--query-range.request-downsampled</span>
  <span class="pi">-</span> <span class="s">--query-range.partial-response</span>
  <span class="pi">-</span> <span class="s">--query-frontend.align-range-with-step</span>
  <span class="pi">-</span> <span class="s">--query-frontend.split-queries-by-interval=24h</span>
  <span class="pi">-</span> <span class="s">--query-frontend.cache-unaligned-requests</span>
  
  <span class="c1"># Caching configuration</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">type: redis</span>
    <span class="s">config:</span>
      <span class="s">addr: "redis-cluster.monitoring.svc.cluster.local:6379"</span>
      <span class="s">password: "${REDIS_PASSWORD}"</span>
      <span class="s">db: 0</span>
      <span class="s">pool_size: 100</span>
      <span class="s">min_idle_conns: 10</span>
      <span class="s">dial_timeout: 5s</span>
      <span class="s">read_timeout: 3s</span>
      <span class="s">write_timeout: 3s</span>
      <span class="s">expiration: 24h</span>

<span class="na">storegateway</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Performance optimization</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--sync-block-duration=3m</span>
  <span class="pi">-</span> <span class="s">--block-sync-concurrency=20</span>
  <span class="pi">-</span> <span class="s">--index-cache-size=4GB</span>
  <span class="pi">-</span> <span class="s">--chunk-pool-size=4GB</span>
  <span class="pi">-</span> <span class="s">--store.grpc.series-sample-limit=120000</span>
  <span class="pi">-</span> <span class="s">--store.grpc.series-max-concurrency=50</span>
  
  <span class="c1"># Resource allocation for high performance</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">32Gi</span>

<span class="na">compactor</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Compaction optimization</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--block-files-concurrency=8</span>
  <span class="pi">-</span> <span class="s">--compact-concurrency=4</span>
  <span class="pi">-</span> <span class="s">--downsample-concurrency=4</span>
  <span class="pi">-</span> <span class="s">--delete-delay=48h</span>
  
  <span class="c1"># Resource allocation</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">4000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">8Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="horizontal-pod-autoscaling">Horizontal Pod Autoscaling</h3>

<p>Create <code class="language-plaintext highlighter-rouge">hpa/thanos-query-hpa.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query-hpa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">20</span>
  <span class="na">metrics</span><span class="pi">:</span>
  <span class="c1"># CPU-based scaling</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">cpu</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">Utilization</span>
        <span class="na">averageUtilization</span><span class="pi">:</span> <span class="m">70</span>
  
  <span class="c1"># Memory-based scaling</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">memory</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">Utilization</span>
        <span class="na">averageUtilization</span><span class="pi">:</span> <span class="m">80</span>
  
  <span class="c1"># Custom metric: Query latency</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Pods</span>
    <span class="na">pods</span><span class="pi">:</span>
      <span class="na">metric</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">thanos_query_duration_seconds_p99</span>
      <span class="na">target</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">AverageValue</span>
        <span class="na">averageValue</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5"</span>
  
  <span class="na">behavior</span><span class="pi">:</span>
    <span class="na">scaleUp</span><span class="pi">:</span>
      <span class="na">stabilizationWindowSeconds</span><span class="pi">:</span> <span class="m">300</span>
      <span class="na">policies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
        <span class="na">value</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Pods</span>
        <span class="na">value</span><span class="pi">:</span> <span class="m">4</span>
        <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">selectPolicy</span><span class="pi">:</span> <span class="s">Max</span>
    <span class="na">scaleDown</span><span class="pi">:</span>
      <span class="na">stabilizationWindowSeconds</span><span class="pi">:</span> <span class="m">600</span>
      <span class="na">policies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
        <span class="na">value</span><span class="pi">:</span> <span class="m">50</span>
        <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Pods</span>
        <span class="na">value</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">selectPolicy</span><span class="pi">:</span> <span class="s">Min</span>
</code></pre></div></div>

<hr />

<h2 id="multi-cluster-federation">Multi-Cluster Federation</h2>

<p>For enterprise environments spanning multiple clusters, implement federation for unified monitoring across your infrastructure.</p>

<p><br /></p>

<h3 id="multi-cluster-architecture">Multi-Cluster Architecture</h3>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph TB
      subgraph "Global Control Plane"
        GlobalQuery[Global Thanos Query]
        GlobalFrontend[Global Query Frontend]
        GlobalRuler[Global Thanos Ruler]
      end
      
      subgraph "Region: US-East"
        subgraph "Production Cluster"
          USEProd[Prometheus]
          USEThanos[Thanos Sidecar]
          USEReceive[Thanos Receive]
        end
        subgraph "Staging Cluster"
          USEStaging[Prometheus]
          USEThanosStg[Thanos Sidecar]
        end
      end
      
      subgraph "Region: US-West"
        subgraph "Production Cluster"
          USWProd[Prometheus]
          USWThanos[Thanos Sidecar]
          USWReceive[Thanos Receive]
        end
      end
      
      subgraph "Global Storage Layer"
        GlobalStorage[(Multi-Region<br />Object Storage)]
        RegionalCache[Regional Store<br />Gateways]
      end
      
      GlobalQuery --&gt; USEReceive
      GlobalQuery --&gt; USWReceive
      GlobalQuery --&gt; RegionalCache
      
      USEThanos --&gt; GlobalStorage
      USWThanos --&gt; GlobalStorage
      USEThanosStg --&gt; GlobalStorage
      
      USEReceive --&gt; GlobalStorage
      USWReceive --&gt; GlobalStorage
      
      RegionalCache --&gt; GlobalStorage
  </div>
</div>

<h3 id="external-cluster-configuration">External Cluster Configuration</h3>

<p><br /></p>

<p>Create <code class="language-plaintext highlighter-rouge">values/thanos-external-cluster.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Configuration for external cluster</span>
<span class="na">query</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Connect to local Prometheus and remote clusters</span>
  <span class="na">stores</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local</span>
  <span class="pi">-</span> <span class="s">thanos-query-frontend-grpc.us-east-1.company.com:443</span>
  <span class="pi">-</span> <span class="s">thanos-query-frontend-grpc.eu-central-1.company.com:443</span>
  
  <span class="c1"># External labels for this cluster</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--query.replica-label=prometheus_replica</span>
  <span class="pi">-</span> <span class="s">--query.replica-label=__replica__</span>
  <span class="pi">-</span> <span class="s">--label=cluster="us-west-2"</span>
  <span class="pi">-</span> <span class="s">--label=region="us-west-2"</span>
  
  <span class="c1"># gRPC ingress for external access</span>
  <span class="na">ingress</span><span class="pi">:</span>
    <span class="na">grpc</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">hostname</span><span class="pi">:</span> <span class="s">thanos-query-grpc.us-west-2.company.com</span>
      <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">nginx.ingress.kubernetes.io/backend-protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">GRPC"</span>
        <span class="na">nginx.ingress.kubernetes.io/grpc-backend</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
        <span class="na">cert-manager.io/cluster-issuer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">letsencrypt-prod"</span>
      <span class="na">tls</span><span class="pi">:</span> <span class="no">true</span>

<span class="c1"># Store gateway for this region</span>
<span class="na">storegateway</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Regional store configuration</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--selector.relabel-config-file=/etc/thanos/relabel.yml</span>
  
  <span class="c1"># Configure to serve only regional data</span>
  <span class="na">configMaps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">store-relabel-config</span>
    <span class="na">data</span><span class="pi">:</span>
      <span class="na">relabel.yml</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">- source_labels: [cluster]</span>
          <span class="s">regex: "us-west-2"</span>
          <span class="s">action: keep</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="global-query-configuration">Global Query Configuration</h3>

<p>Create <code class="language-plaintext highlighter-rouge">values/thanos-global-query.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Global Thanos Query for multi-cluster federation</span>
<span class="na">query</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">5</span>
  
  <span class="c1"># All regional store endpoints</span>
  <span class="na">stores</span><span class="pi">:</span>
  <span class="c1"># Regional store gateways</span>
  <span class="pi">-</span> <span class="s">thanos-store.us-east-1.company.com:10901</span>
  <span class="pi">-</span> <span class="s">thanos-store.us-west-2.company.com:10901</span>
  <span class="pi">-</span> <span class="s">thanos-store.eu-central-1.company.com:10901</span>
  
  <span class="c1"># Regional receive endpoints</span>
  <span class="pi">-</span> <span class="s">thanos-receive.us-east-1.company.com:10901</span>
  <span class="pi">-</span> <span class="s">thanos-receive.us-west-2.company.com:10901</span>
  <span class="pi">-</span> <span class="s">thanos-receive.eu-central-1.company.com:10901</span>
  
  <span class="c1"># Direct Prometheus endpoints for real-time data</span>
  <span class="pi">-</span> <span class="s">prometheus.us-east-1.company.com:10901</span>
  <span class="pi">-</span> <span class="s">prometheus.us-west-2.company.com:10901</span>
  <span class="pi">-</span> <span class="s">prometheus.eu-central-1.company.com:10901</span>
  
  <span class="c1"># Global query optimizations</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--query.timeout=15m</span>
  <span class="pi">-</span> <span class="s">--query.max-concurrent=100</span>
  <span class="pi">-</span> <span class="s">--query.lookback-delta=15m</span>
  <span class="pi">-</span> <span class="s">--query.auto-downsampling</span>
  <span class="pi">-</span> <span class="s">--query.partial-response</span>
  <span class="pi">-</span> <span class="s">--query.max-concurrent-select=16</span>
  <span class="pi">-</span> <span class="s">--query.default-evaluation-interval=1m</span>
  <span class="pi">-</span> <span class="s">--store.unhealthy-timeout=5m</span>
  <span class="pi">-</span> <span class="s">--store.response-timeout=30s</span>
  
  <span class="c1"># Resource allocation for global scale</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">8000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">16Gi</span>
    <span class="na">limits</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">16000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">32Gi</span>

<span class="na">queryFrontend</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="c1"># Global query frontend configuration</span>
  <span class="na">extraArgs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">--query-range.split-interval=6h</span>
  <span class="pi">-</span> <span class="s">--query-range.max-retries-per-request=5</span>
  <span class="pi">-</span> <span class="s">--query-frontend.cache-compression-type=snappy</span>
  <span class="pi">-</span> <span class="s">--query-frontend.downstream-tripper-config-file=/etc/thanos/tracing.yml</span>
  
  <span class="c1"># Global caching configuration</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">type: redis</span>
    <span class="s">config:</span>
      <span class="s">cluster_addrs:</span>
      <span class="s">- redis-cluster-global.monitoring.svc.cluster.local:6379</span>
      <span class="s">route_by_latency: true</span>
      <span class="s">route_randomly: false</span>
      <span class="s">expiration: 6h</span>
</code></pre></div></div>

<hr />

<h2 id="security-and-compliance">Security and Compliance</h2>

<p><br /></p>

<h3 id="authentication-and-authorization">Authentication and Authorization</h3>

<h4 id="rbac-configuration">RBAC Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">rbac/monitoring-rbac.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Comprehensive RBAC for monitoring stack</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-enterprise</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-enterprise</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="c1"># Core Prometheus permissions</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="pi">-</span> <span class="s">nodes/proxy</span>
  <span class="pi">-</span> <span class="s">nodes/metrics</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">extensions"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">networking.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">nonResourceURLs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/metrics"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/metrics/cadvisor"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>

<span class="c1"># Monitoring CRDs</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">monitoring.coreos.com"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">servicemonitors</span>
  <span class="pi">-</span> <span class="s">podmonitors</span>
  <span class="pi">-</span> <span class="s">prometheusrules</span>
  <span class="pi">-</span> <span class="s">probes</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-enterprise</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-enterprise</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-enterprise</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="tls-and-encryption">TLS and Encryption</h3>

<h4 id="tls-configuration">TLS Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">tls/monitoring-tls.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># TLS certificate for monitoring components</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Certificate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring-tls</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">secretName</span><span class="pi">:</span> <span class="s">monitoring-tls</span>
  <span class="na">issuerRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
  <span class="na">dnsNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">prometheus.your-domain.com</span>
  <span class="pi">-</span> <span class="s">thanos-query.your-domain.com</span>
  <span class="pi">-</span> <span class="s">thanos.your-domain.com</span>
  <span class="pi">-</span> <span class="s">alertmanager.your-domain.com</span>
<span class="nn">---</span>
<span class="c1"># TLS configuration for Thanos components</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-tls</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">kubernetes.io/tls</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">tls.crt</span><span class="pi">:</span> <span class="c1"># Base64 encoded certificate</span>
  <span class="na">tls.key</span><span class="pi">:</span> <span class="c1"># Base64 encoded private key</span>
  <span class="na">ca.crt</span><span class="pi">:</span>  <span class="c1"># Base64 encoded CA certificate</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="data-protection">Data Protection</h3>

<h4 id="encryption-at-rest">Encryption at Rest</h4>

<p>Update object storage configuration with encryption:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Enhanced object storage configuration with encryption</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">s3</span>
<span class="na">config</span><span class="pi">:</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">enterprise-thanos-encrypted"</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3.us-west-2.amazonaws.com"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">us-west-2"</span>
  <span class="na">access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${AWS_ACCESS_KEY_ID}"</span>
  <span class="na">secret_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${AWS_SECRET_ACCESS_KEY}"</span>
  <span class="na">insecure</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">signature_version2</span><span class="pi">:</span> <span class="no">false</span>
  
  <span class="c1"># Server-side encryption</span>
  <span class="na">encrypt_sse</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">sse_config</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">SSE-KMS"</span>
    <span class="na">kms_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">arn:aws:kms:us-west-2:123456789012:key/12345678-1234-1234-1234-123456789012"</span>
  
  <span class="c1"># Additional security headers</span>
  <span class="na">put_user_metadata</span><span class="pi">:</span>
    <span class="s2">"</span><span class="s">X-Amz-Acl"</span><span class="err">:</span> <span class="s2">"</span><span class="s">private"</span>
    <span class="s2">"</span><span class="s">data-classification"</span><span class="err">:</span> <span class="s2">"</span><span class="s">internal"</span>
    <span class="s2">"</span><span class="s">encryption-required"</span><span class="err">:</span> <span class="s2">"</span><span class="s">true"</span>
</code></pre></div></div>

<hr />

<h2 id="operational-excellence">Operational Excellence</h2>

<p><br /></p>

<h3 id="monitoring-the-monitoring-stack">Monitoring the Monitoring Stack</h3>

<h4 id="self-monitoring-configuration">Self-Monitoring Configuration</h4>

<p>Create <code class="language-plaintext highlighter-rouge">monitoring/self-monitoring-rules.yaml</code>:</p>

<script src="https://gist.github.com/somaz94/0c12022e0439990a5111fed8863f8017.js"></script>

<p><br /></p>

<h3 id="automated-operations">Automated Operations</h3>

<h4 id="backup-and-recovery">Backup and Recovery</h4>

<p>Create <code class="language-plaintext highlighter-rouge">backup/backup-job.yaml</code>:</p>

<script src="https://gist.github.com/somaz94/98efa62834106d84707b85ab888c6cde.js"></script>

<hr />

<h2 id="disaster-recovery">Disaster Recovery</h2>

<p><br /></p>

<h3 id="multi-region-dr-setup">Multi-Region DR Setup</h3>

<h4 id="cross-region-replication">Cross-Region Replication</h4>

<p>Create <code class="language-plaintext highlighter-rouge">dr/cross-region-config.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cross-region disaster recovery configuration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">disaster-recovery-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">dr-strategy.yml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">primary_region: us-west-2</span>
    <span class="s">secondary_regions:</span>
    <span class="s">- us-east-1</span>
    <span class="s">- eu-central-1</span>
    
    <span class="s">recovery_objectives:</span>
      <span class="s">rpo: "15m"  # Recovery Point Objective</span>
      <span class="s">rto: "30m"  # Recovery Time Objective</span>
    
    <span class="s">backup_strategy:</span>
      <span class="s">continuous_replication:</span>
        <span class="s">enabled: true</span>
        <span class="s">replication_lag_threshold: "5m"</span>
    <span class="no">  </span>
      <span class="s">snapshots:</span>
        <span class="s">frequency: "4h"</span>
        <span class="s">retention: "30d"</span>
        <span class="s">compression: true</span>
        <span class="s">encryption: true</span>
    
    <span class="s">failover_strategy:</span>
      <span class="s">automated_triggers:</span>
      <span class="s">- primary_region_down: "10m"</span>
      <span class="s">- data_loss_detected: "immediate"</span>
    <span class="no">  </span>
      <span class="s">manual_triggers:</span>
      <span class="s">- security_incident</span>
      <span class="s">- planned_maintenance</span>
</code></pre></div></div>

<h4 id="dr-testing">DR Testing</h4>

<p>Create <code class="language-plaintext highlighter-rouge">dr/dr-test-job.yaml</code>:</p>

<script src="https://gist.github.com/somaz94/5cfff3169ef841a3602e81e3d372531c.js"></script>

<hr />

<h2 id="troubleshooting-and-best-practices">Troubleshooting and Best Practices</h2>

<p><br /></p>

<h3 id="common-issues-and-solutions">Common Issues and Solutions</h3>

<h4 id="dns-resolution-problems">DNS Resolution Problems</h4>

<p><strong>Problem</strong>: Thanos Query cannot discover stores</p>

<p><br /></p>

<p><strong>Solution</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check DNS resolution</span>
kubectl run <span class="nt">-it</span> <span class="nt">--rm</span> dns-test <span class="nt">--image</span><span class="o">=</span>nicolaka/netshoot <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span> dig _grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local

<span class="c"># Verify service endpoints</span>
kubectl get endpoints <span class="nt">-n</span> monitoring | <span class="nb">grep </span>thanos

<span class="c"># Check service labels</span>
kubectl get service kube-prometheus-stack-thanos-discovery <span class="nt">-n</span> monitoring <span class="nt">-o</span> yaml
</code></pre></div></div>

<p><br /></p>

<h4 id="object-storage-access-issues">Object Storage Access Issues</h4>

<p><strong>Problem</strong>: Thanos components cannot access object storage</p>

<p><br /></p>

<p><strong>Diagnosis</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Test object storage connectivity</span>
kubectl <span class="nb">exec</span> <span class="nt">-it</span> thanos-query-0 <span class="nt">-n</span> monitoring <span class="nt">--</span> thanos tools bucket <span class="nb">ls</span> <span class="nt">--objstore</span>.config-file<span class="o">=</span>/etc/bucket/objstore.yml

<span class="c"># Check secret configuration</span>
kubectl get secret thanos-objstore <span class="nt">-n</span> monitoring <span class="nt">-o</span> yaml

<span class="c"># Verify network policies</span>
kubectl get networkpolicies <span class="nt">-n</span> monitoring
</code></pre></div></div>

<h4 id="performance-issues">Performance Issues</h4>

<p><strong>Problem</strong>: Slow query performance</p>

<p><strong>Optimization checklist</strong>:</p>
<ol>
  <li><strong>Enable query caching</strong>: Configure Redis cache for Query Frontend</li>
  <li><strong>Optimize queries</strong>: Use recording rules for complex calculations</li>
  <li><strong>Scale components</strong>: Increase replicas for Query and Store Gateway</li>
  <li><strong>Tune resource allocation</strong>: Adjust CPU and memory limits</li>
  <li><strong>Enable downsampling</strong>: Configure appropriate retention policies</li>
</ol>

<p><br /></p>

<h3 id="best-practices">Best Practices</h3>

<h4 id="configuration-management">Configuration Management</h4>

<ol>
  <li><strong>Use Git for configuration</strong>: Store all Helm values and manifests in version control</li>
  <li><strong>Environment-specific values</strong>: Separate values files for different environments</li>
  <li><strong>Secret management</strong>: Use external secret management (Vault, External Secrets Operator)</li>
  <li><strong>Configuration validation</strong>: Implement pre-commit hooks for YAML validation</li>
</ol>

<h4 id="operational-practices">Operational Practices</h4>

<ol>
  <li><strong>Monitor the monitoring</strong>: Set up comprehensive self-monitoring</li>
  <li><strong>Regular testing</strong>: Implement automated DR testing and backup verification</li>
  <li><strong>Capacity planning</strong>: Regular review of resource usage and scaling needs</li>
  <li><strong>Security updates</strong>: Keep components updated with latest security patches</li>
  <li><strong>Documentation</strong>: Maintain runbooks and operational procedures</li>
</ol>

<h4 id="scaling-guidelines">Scaling Guidelines</h4>

<div class="table-container">
  <table class="table-modern">
    <tr>
      <th>Metric Volume</th>
      <th>Prometheus Config</th>
      <th>Thanos Config</th>
      <th>Storage Strategy</th>
    </tr>
    <tr>
      <td>&lt; 1M series</td>
      <td>Single instance</td>
      <td>Basic setup</td>
      <td>Local + 1y object</td>
    </tr>
    <tr>
      <td>1M-10M series</td>
      <td>HA with 2 replicas</td>
      <td>Multi-replica components</td>
      <td>Fast local + 2y object</td>
    </tr>
    <tr>
      <td>10M-100M series</td>
      <td>Sharded deployment</td>
      <td>Horizontal scaling</td>
      <td>NVMe + multi-region</td>
    </tr>
    <tr>
      <td>&gt; 100M series</td>
      <td>Federation model</td>
      <td>Full enterprise setup</td>
      <td>Tiered storage strategy</td>
    </tr>
  </table>
</div>

<p><br /></p>

<h3 id="upgrade-procedures">Upgrade Procedures</h3>

<h4 id="safe-upgrade-process">Safe Upgrade Process</h4>

<ol>
  <li><strong>Backup current state</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Backup configurations</span>
kubectl get all <span class="nt">-n</span> monitoring <span class="nt">-o</span> yaml <span class="o">&gt;</span> monitoring-backup-<span class="si">$(</span><span class="nb">date</span> +%Y%m%d<span class="si">)</span>.yaml
   
<span class="c"># Backup PVCs</span>
kubectl get pvc <span class="nt">-n</span> monitoring <span class="nt">-o</span> yaml <span class="o">&gt;</span> pvc-backup-<span class="si">$(</span><span class="nb">date</span> +%Y%m%d<span class="si">)</span>.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Test in staging</strong>: Always test upgrades in a staging environment first</p>
  </li>
  <li><strong>Rolling upgrade strategy</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Upgrade Prometheus Operator CRDs first</span>
helm upgrade prometheus-operator-crds prometheus-community/prometheus-operator-crds <span class="nt">-n</span> monitoring
   
<span class="c"># Upgrade kube-prometheus-stack</span>
helm upgrade kube-prometheus-stack prometheus-community/kube-prometheus-stack <span class="nt">-n</span> monitoring <span class="nt">-f</span> values/kube-prometheus-stack.yaml
   
<span class="c"># Upgrade Thanos</span>
helm upgrade thanos bitnami/thanos <span class="nt">-n</span> monitoring <span class="nt">-f</span> values/thanos.yaml
</code></pre></div>    </div>
  </li>
  <li><strong>Verification after upgrade</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check pod status</span>
kubectl get pods <span class="nt">-n</span> monitoring
   
<span class="c"># Verify metrics ingestion</span>
kubectl port-forward svc/thanos-query 9090:9090 <span class="nt">-n</span> monitoring &amp;
curl <span class="s2">"http://localhost:9090/api/v1/query?query=up"</span>
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>This comprehensive guide provides a complete roadmap for implementing enterprise-grade Prometheus and Thanos monitoring infrastructure. Starting with basic Helm installations and progressing through advanced enterprise configurations, you now have the knowledge and practical examples needed to build monitoring systems that can scale with your organization’s growth.</p>

<p><br /></p>

<h3 id="key-implementation-steps-recap">Key Implementation Steps Recap:</h3>

<ol>
  <li><strong>Start with basics</strong>: Use the provided Helm configurations to establish core monitoring</li>
  <li><strong>Implement security</strong>: Add RBAC, TLS, and network policies from day one</li>
  <li><strong>Plan for scale</strong>: Design your architecture with growth in mind</li>
  <li><strong>Automate operations</strong>: Implement backup, monitoring, and recovery procedures</li>
  <li><strong>Test regularly</strong>: Validate your setup with automated testing and DR procedures</li>
</ol>

<p><br /></p>

<h3 id="enterprise-success-factors">Enterprise Success Factors:</h3>

<ul>
  <li><strong>Architectural Excellence</strong>: Multi-cluster federation and advanced scaling patterns</li>
  <li><strong>Security First</strong>: Comprehensive security framework with encryption and access controls</li>
  <li><strong>Operational Excellence</strong>: Self-monitoring, automated recovery, and disaster preparedness</li>
  <li><strong>Performance Optimization</strong>: Advanced caching, resource management, and query optimization</li>
  <li><strong>Continuous Improvement</strong>: Regular testing, monitoring, and refinement of your monitoring infrastructure</li>
</ul>

<p>Whether you’re implementing monitoring for a single cluster or orchestrating observability across a global infrastructure, this guide provides the foundation for building monitoring systems that deliver reliable insights while maintaining the operational excellence required for enterprise success.</p>

<p><br /></p>

<hr />

<h2 id="references-and-resources">References and Resources</h2>

<p><br /></p>

<h3 id="official-documentation">Official Documentation</h3>
<ul>
  <li><a href="https://prometheus.io/docs/">Prometheus Documentation</a></li>
  <li><a href="https://thanos.io/">Thanos Documentation</a></li>
  <li><a href="https://prometheus-operator.dev/">Prometheus Operator Guide</a></li>
</ul>

<p><br /></p>

<h3 id="helm-charts">Helm Charts</h3>
<ul>
  <li><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">Kube-Prometheus-Stack</a></li>
  <li><a href="https://github.com/bitnami/charts/tree/main/bitnami/thanos">Bitnami Thanos Chart</a></li>
  <li><a href="https://github.com/prometheus-community/helm-charts">Prometheus Community Charts</a></li>
</ul>

<p><br /></p>

<h3 id="advanced-topics">Advanced Topics</h3>
<ul>
  <li><a href="https://thanos.io/tip/thanos/storage.md/">Thanos Storage Configuration</a></li>
  <li><a href="https://www.cncf.io/blog/2021/09/13/multi-cluster-monitoring-with-thanos/">Multi-cluster Monitoring Patterns</a></li>
  <li><a href="https://prometheus.io/docs/practices/instrumentation/">Prometheus Performance Best Practices</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/">Kubernetes Monitoring Guide</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/openstack/openstack-zun/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1742267532/openstack_t2tmoc.png">
                                    
                                    <h3>Deep Dive into OpenStack Zun</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/network/bgp-border-gateway-protocol-complete-guide/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755074091/bgp-1_i4oqyf.png">
                                    
                                    <h3>BGP (Border Gateway Protocol) Complete Guide - Internet's Core Routing Protocol</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/database/database-schema/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755739796/database-schema-1_h26zze.png">
                                    
                                    <h3>Database Schema Design: From Concepts to Production Excellence</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="36">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/openstack/openstack-placement/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755833039/openstack-placement-1_f62ne8.png">
                
            </div>
            <h3 class="title">Deep Dive into OpenStack Placement</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Learn how to install and configure Prometheus and Thanos using Helm charts for scalable monitoring&quot;%20https://somaz.blog/category/monitoring/prometheus-thanos-install/%20via%20&#64;twitter_username&hashtags=prometheus,thanos,helm,kubernetes"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/monitoring/prometheus-thanos-install/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/monitoring/prometheus-thanos-install/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Installing Prometheus and Thanos with Helm",
            "headline": "Complete guide to deploying, securing, and operating Prometheus and Thanos from basic setup to enterprise-grade production deployments",
            "description": "Learn how to install and configure Prometheus and Thanos using Helm charts for scalable monitoring",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1738640346/prometheus-thans-archi_zfo72f.png",
            "url": "https://somaz.blog/category/monitoring/prometheus-thanos-install/",
            "articleBody": "Image Reference





Table of Contents


  Overview and Architecture
  Prerequisites and Planning
  Basic Installation with Helm
  Enterprise Architecture Implementation
  Advanced Configuration and Optimization
  Multi-Cluster Federation
  Security and Compliance
  Performance Optimization
  Operational Excellence
  Disaster Recovery
  Troubleshooting and Best Practices




Overview and Architecture

Enterprise monitoring infrastructure demands sophisticated solutions that can scale across global deployments while maintaining reliability, security, and operational simplicity.

Prometheus and Thanos together form the foundation of modern observability platforms, providing metrics collection, long-term storage, and unified querying capabilities that meet the most demanding enterprise requirements.



Evolution of Enterprise Monitoring


  
    graph LR
      A[Enterprise Monitoring Evolution] --&amp;gt; B[Traditional Monitoring2000-2010]
      A --&amp;gt; C[Cloud-Native Monitoring2010-2020]
      A --&amp;gt; D[Distributed Observability2020-Present]
      
      B --&amp;gt; B1[SNMP/Nagios]
      B --&amp;gt; B2[Centralized Architecture]
      B --&amp;gt; B3[Manual Configuration]
      
      C --&amp;gt; C1[Prometheus/Grafana]
      C --&amp;gt; C2[Container Monitoring]
      C --&amp;gt; C3[Service Discovery]
      C --&amp;gt; C4[Pull-based Metrics]
      
      D --&amp;gt; D1[Multi-Cluster Federation]
      D --&amp;gt; D2[Long-term Storage]
      D --&amp;gt; D3[Global Query Layer]
      D --&amp;gt; D4[Observability as Code]
      D --&amp;gt; D5[AI-driven Insights]
  




Core Architecture Components


  
    graph LR
      subgraph &quot;Control Plane Layer&quot;
        ThanosQuery[Thanos QueryGlobal Query Interface]
        ThanosQueryFrontend[Thanos Query FrontendQuery Optimization]
        ThanosRuler[Thanos RulerGlobal Alerting]
      end
      
      subgraph &quot;Data Plane Layer&quot;
        subgraph &quot;Cluster 1&quot;
          Prom1[PrometheusMetrics Collection]
          ThanosReceive1[Thanos ReceiveRemote Write]
          ThanosSidecar1[Thanos SidecarUpload Agent]
        end
        
        subgraph &quot;Cluster 2&quot;
          Prom2[PrometheusMetrics Collection]
          ThanosReceive2[Thanos ReceiveRemote Write]
          ThanosSidecar2[Thanos SidecarUpload Agent]
        end
      end
      
      subgraph &quot;Storage Layer&quot;
        ObjectStorage[(Object StorageS3/GCS/Azure)]
        ThanosCompactor[Thanos CompactorData Processing]
        ThanosStore[Thanos StoreQuery Gateway]
      end
      
      subgraph &quot;Operational Layer&quot;
        Grafana[GrafanaVisualization]
        Alertmanager[AlertmanagerNotification]
        ServiceMesh[Service MeshIstio/Linkerd]
      end
      
      ThanosQuery --&amp;gt; ThanosReceive1
      ThanosQuery --&amp;gt; ThanosReceive2
      ThanosQuery --&amp;gt; ThanosStore
      ThanosQueryFrontend --&amp;gt; ThanosQuery
      
      ThanosSidecar1 --&amp;gt; ObjectStorage
      ThanosSidecar2 --&amp;gt; ObjectStorage
      ThanosReceive1 --&amp;gt; ObjectStorage
      ThanosReceive2 --&amp;gt; ObjectStorage
      
      ThanosCompactor --&amp;gt; ObjectStorage
      ThanosStore --&amp;gt; ObjectStorage
      
      ThanosRuler --&amp;gt; Alertmanager
      ThanosQueryFrontend --&amp;gt; Grafana
  




Prerequisites and Planning



Technical Prerequisites

Before implementing your monitoring infrastructure, ensure you have the following components in place:

Infrastructure Requirements:

  Kubernetes Cluster: v1.24+ with proper networking configuration
  Storage Provisioner: For persistent volumes (recommended: SSD-based storage classes)
  Object Storage: S3, GCS, MinIO, or other compatible object storage
  Network Connectivity: Proper ingress configuration and DNS resolution
  Resource Allocation: Adequate CPU, memory, and storage for monitoring workloads


Tool Requirements:

  Helm: Version 3.12+ installed and configured
  kubectl: Properly configured with cluster access
  DNS: Proper DNS configuration for service discovery
  TLS Certificates: For secure communications (recommended)


Access Requirements:

  Object Storage Access: Credentials for chosen storage provider
  Cluster Admin Rights: For installing CRDs and operators
  Network Access: Between clusters for multi-cluster setups




Capacity Planning

Resource Requirements by Deployment Size:


  
    
      Deployment Size
      Prometheus Resources
      Thanos Resources
      Storage Requirements
    
    
      Small (&amp;lt; 1k series)
      2 vCPU, 4GB RAM
      1 vCPU, 2GB RAM
      50GB local, 100GB object
    
    
      Medium (1k-10k series)
      4 vCPU, 8GB RAM
      2 vCPU, 4GB RAM
      200GB local, 1TB object
    
    
      Large (10k-100k series)
      8 vCPU, 16GB RAM
      4 vCPU, 8GB RAM
      500GB local, 10TB object
    
    
      Enterprise (100k+ series)
      16+ vCPU, 32+ GB RAM
      8+ vCPU, 16+ GB RAM
      1TB+ local, 100TB+ object
    
  




Installation Strategy Planning

Choose Your Installation Approach:


  
    
      Approach
      Use Case
      Complexity
      Features
    
    
      Basic Setup
      Development, small teams
      Low
      Core monitoring capabilities
    
    
      Production Ready
      Small to medium production
      Medium
      HA, basic security, retention
    
    
      Enterprise Grade
      Large scale, compliance
      High
      Multi-tenant, federation, advanced security
    
  




Basic Installation with Helm

This section provides step-by-step instructions for installing Prometheus and Thanos using Helm charts, progressing from basic to production-ready configurations.



Preparation Steps

1. Add Required Helm Repositories

# Add Prometheus community repository
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

# Add Bitnami repository for Thanos
helm repo add bitnami https://charts.bitnami.com/bitnami

# Update repositories
helm repo update

# Verify repositories
helm repo list


2. Create Monitoring Namespace

# Create dedicated namespace for monitoring
kubectl create namespace monitoring

# Set default namespace for convenience
kubectl config set-context --current --namespace=monitoring


3. Install Required CRDs

# Install Prometheus Operator CRDs
helm install prometheus-operator-crds prometheus-community/prometheus-operator-crds --namespace monitoring




Installation Options

Option 1: Basic Prometheus Installation

Use Case: Development environments, getting started



Create values/prometheus-basic.yaml:

# Basic Prometheus configuration
server:
  name: server
  image:
    repository: quay.io/prometheus/prometheus
    tag: latest
  
  persistentVolume:
    enabled: true
    accessModes:
      - ReadWriteOnce
    storageClass: &quot;default&quot;
    size: 50Gi
  
  replicaCount: 1
  statefulSet:
    enabled: false
  
  service:
    enabled: true
    type: ClusterIP
  
  # Resource limits
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

# Enable basic components
alertmanager:
  enabled: true
  persistence:
    size: 2Gi

kube-state-metrics:
  enabled: true

prometheus-node-exporter:
  enabled: true

prometheus-pushgateway:
  enabled: false


Installation:

helm install prometheus prometheus-community/prometheus --namespace monitoring --values values/prometheus-basic.yaml --create-namespace




Option 2: Production-Ready with Kube-Prometheus-Stack

Use Case: Production environments with comprehensive monitoring

Create values/kube-prometheus-stack.yaml:





Installation:

helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --namespace monitoring --values values/kube-prometheus-stack.yaml --create-namespace




Object Storage Configuration

Before installing Thanos, configure object storage for long-term metrics retention.

Create Object Storage Configuration

Create objstore.yml with your storage provider configuration:



For AWS S3:
type: s3
config:
  bucket: &quot;your-thanos-bucket&quot;
  endpoint: &quot;s3.us-west-2.amazonaws.com&quot;
  region: &quot;us-west-2&quot;
  access_key: &quot;YOUR_ACCESS_KEY&quot;
  secret_key: &quot;YOUR_SECRET_KEY&quot;
  insecure: false
  signature_version2: false
  encrypt_sse: true
  put_user_metadata:
    &quot;X-Amz-Acl&quot;: &quot;private&quot;




For Google Cloud Storage:
type: gcs
config:
  bucket: &quot;your-thanos-bucket&quot;
  service_account: |
    {
      &quot;type&quot;: &quot;service_account&quot;,
      &quot;project_id&quot;: &quot;your-project&quot;,
      &quot;private_key_id&quot;: &quot;...&quot;,
      &quot;private_key&quot;: &quot;...&quot;,
      &quot;client_email&quot;: &quot;...&quot;,
      &quot;client_id&quot;: &quot;...&quot;,
      &quot;auth_uri&quot;: &quot;https://accounts.google.com/o/oauth2/auth&quot;,
      &quot;token_uri&quot;: &quot;https://oauth2.googleapis.com/token&quot;
    }




For MinIO (Development/Testing):
type: s3
config:
  bucket: &quot;thanos&quot;
  endpoint: &quot;minio.storage.svc.cluster.local:9000&quot;
  access_key: &quot;minioadmin&quot;
  secret_key: &quot;minioadmin&quot;
  insecure: true
  signature_version2: false




Create Kubernetes Secret

# Create the object storage secret
kubectl create secret generic thanos-objstore --from-file=objstore.yml --namespace monitoring




Thanos Installation

Single-Cluster Thanos Configuration

Create values/thanos-single-cluster.yaml:

# Global configuration
global:
  storageClass: &quot;fast-ssd&quot;
  imageRegistry: &quot;quay.io&quot;

# Cluster domain configuration
clusterDomain: cluster.local
fullnameOverride: &quot;thanos&quot;

# Object storage configuration
existingObjstoreSecret: &quot;thanos-objstore&quot;

# Query component configuration
query:
  enabled: true
  logLevel: info
  
  # Replica labels for deduplication
  replicaLabel:
    - prometheus_replica
    - __replica__
  
  # Store endpoints
  stores:
    - dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local
  
  # Resource allocation
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  
  # Service configuration
  service:
    type: ClusterIP
    ports:
      http: 9090
      grpc: 10901
  
  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: nginx
    hostname: thanos-query.your-domain.com
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;
    tls: true
    extraTls:
    - hosts:
      - thanos-query.your-domain.com
      secretName: thanos-query-tls

# Query Frontend component
queryFrontend:
  enabled: true
  
  # Resource allocation
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  # Configuration
  config: |
    type: in-memory
    config:
      max_size: 256MB
      validity: 24h
  
  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: nginx
    hostname: thanos.your-domain.com
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;
    tls: true

# Compactor component
compactor:
  enabled: true
  
  # Retention configuration
  retentionResolutionRaw: 30d      # Raw data retention
  retentionResolution5m: 90d       # 5-minute downsampled data
  retentionResolution1h: 2y        # 1-hour downsampled data
  
  # Resource allocation
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  
  # Persistence configuration
  persistence:
    enabled: true
    storageClass: &quot;fast-ssd&quot;
    size: 20Gi
  
  # Compaction configuration
  config: |
    compactor:
      sync-delay: 30m
      retention-resolution-raw: 30d
      retention-resolution-5m: 90d
      retention-resolution-1h: 2y
      wait: true
      block-sync-concurrency: 20
      compact-concurrency: 1
      downsample-concurrency: 1

# Store Gateway component
storegateway:
  enabled: true
  
  # Resource allocation
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 8Gi
  
  # Persistence for caching
  persistence:
    enabled: true
    storageClass: &quot;fast-ssd&quot;
    size: 50Gi
  
  # Configuration
  config: |
    store:
      sync-block-duration: 3m
      block-sync-concurrency: 20
      index-cache-size: 1GB
      chunk-pool-size: 2GB

# Ruler component (optional)
ruler:
  enabled: false  # Enable if you need global alerting rules
  
  # Alertmanager configuration
  alertmanagers:
    - http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
  
  # Evaluation interval
  evalInterval: 15s
  
  # Resource allocation
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi

# Receive component (optional for remote write)
receive:
  enabled: false  # Enable for remote write scenarios


Install Thanos

helm install thanos bitnami/thanos --namespace monitoring --values values/thanos-single-cluster.yaml




Verification and Basic Testing

Check Installation Status

# Check all monitoring pods
kubectl get pods -n monitoring

# Check services
kubectl get svc -n monitoring

# Check ingresses
kubectl get ingress -n monitoring


Verify Component Health

# Check Prometheus health
kubectl port-forward svc/kube-prometheus-stack-prometheus 9090:9090 -n monitoring &amp;amp;
curl http://localhost:9090/-/healthy

# Check Thanos Query health
kubectl port-forward svc/thanos-query 9090:9090 -n monitoring &amp;amp;
curl http://localhost:9090/-/healthy

# Check Thanos Store health
kubectl port-forward svc/thanos-storegateway 10902:10902 -n monitoring &amp;amp;
curl http://localhost:10902/-/healthy


Test Metric Queries

Access Thanos Query UI and verify:


  Basic connectivity: Navigate to Thanos Query UI
  Store status: Check the “Stores” page to verify all stores are connected
  Query functionality: Run simple queries like up or prometheus_build_info
  Data availability: Verify metrics from different time ranges




Enterprise Architecture Implementation

Once you have a basic setup running, you can evolve your monitoring infrastructure to meet enterprise requirements. This section covers advanced architectural patterns and configurations.



Multi-Tenancy Implementation

Tenant Isolation Strategy

Create values/prometheus-multitenant.yaml:

# Multi-tenant Prometheus configuration
global:
  # Tenant-specific external labels
  external_labels:
    tenant: &quot;${TENANT_ID}&quot;
    cluster: &quot;${CLUSTER_NAME}&quot;
    environment: &quot;${ENVIRONMENT}&quot;

prometheus:
  prometheusSpec:
    # Tenant-specific configuration
    externalLabels:
      tenant: tenant-a
      cluster: production-east
      environment: prod
    
    # Resource isolation per tenant
    resources:
      requests:
        memory: &quot;4Gi&quot;
        cpu: &quot;2000m&quot;
      limits:
        memory: &quot;16Gi&quot;
        cpu: &quot;8000m&quot;
    
    # Storage isolation
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: premium-ssd
          resources:
            requests:
              storage: 200Gi
    
    # Service monitoring scoped to tenant
    serviceMonitorSelector:
      matchLabels:
        tenant: tenant-a
    
    podMonitorSelector:
      matchLabels:
        tenant: tenant-a
    
    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
    
    # Network policies for isolation
    podMetadata:
      labels:
        tenant: tenant-a
        monitoring: prometheus


Network Isolation

Create network-policies/tenant-isolation.yaml:

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tenant-prometheus-isolation
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      tenant: tenant-a
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow ingress from ingress controllers
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 9090
  
  # Allow inter-component communication within monitoring namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          tenant: tenant-a
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 10901
  
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Allow HTTPS to object storage
  - to: []
    ports:
    - protocol: TCP
      port: 443
  
  # Allow communication to tenant-specific targets
  - to:
    - namespaceSelector:
        matchLabels:
          tenant: tenant-a




High Availability Configuration

HA Prometheus Setup

Create values/prometheus-ha.yaml:

prometheus:
  prometheusSpec:
    # High availability with multiple replicas
    replicas: 3
    
    # Pod disruption budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 2
    
    # Anti-affinity for spreading across nodes
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - prometheus
          topologyKey: kubernetes.io/hostname
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - prometheus
          topologyKey: topology.kubernetes.io/zone
    
    # Node selector for dedicated monitoring nodes
    nodeSelector:
      node-role: monitoring
    
    # Tolerations for monitoring nodes
    tolerations:
    - key: monitoring
      operator: Equal
      value: &quot;true&quot;
      effect: NoSchedule
    
    # Resource allocation for HA setup
    resources:
      requests:
        cpu: 4000m
        memory: 8Gi
      limits:
        cpu: 8000m
        memory: 16Gi
    
    # Sharding configuration for large scale
    shards: 2


HA Thanos Configuration

Create values/thanos-ha.yaml:

# High Availability Thanos configuration
query:
  enabled: true
  replicaCount: 3
  
  # Resource allocation
  resources:
    requests:
      cpu: 2000m
      memory: 4Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  
  # Anti-affinity configuration
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - thanos
            - key: app.kubernetes.io/component
              operator: In
              values:
              - query
          topologyKey: kubernetes.io/hostname
  
  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

storegateway:
  enabled: true
  replicaCount: 3
  
  # Sharding configuration
  sharding:
    enabled: true
  
  # Resource allocation for HA
  resources:
    requests:
      cpu: 2000m
      memory: 8Gi
    limits:
      cpu: 4000m
      memory: 16Gi
  
  # Anti-affinity for distribution
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/component
              operator: In
              values:
              - storegateway
          topologyKey: kubernetes.io/hostname

compactor:
  enabled: true
  
  # Single instance for compactor (stateful)
  replicaCount: 1
  
  # Leader election for HA
  config: |
    compactor:
      consistency-delay: 30m
      wait: true
      block-sync-concurrency: 20




Advanced Configuration and Optimization



Performance Tuning

Prometheus Performance Configuration



Create values/prometheus-performance.yaml:

prometheus:
  prometheusSpec:
    # Performance optimizations
    additionalArgs:
    - --web.enable-lifecycle
    - --web.enable-admin-api
    - --storage.tsdb.min-block-duration=2h
    - --storage.tsdb.max-block-duration=2h
    - --storage.tsdb.wal-compression
    - --query.max-concurrency=50
    - --query.max-samples=50000000
    - --storage.tsdb.retention.time=15d
    - --storage.tsdb.retention.size=45GB
    
    # WAL configuration
    walCompression: true
    
    # Resource allocation for high performance
    resources:
      requests:
        cpu: 8000m
        memory: 16Gi
      limits:
        cpu: 16000m
        memory: 32Gi
    
    # Storage optimization
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: premium-nvme
          accessModes: [&quot;ReadWriteOnce&quot;]
          resources:
            requests:
              storage: 500Gi
    
    # Scrape configuration optimization
    scrapeInterval: 15s
    evaluationInterval: 15s
    
    # Query optimization
    queryLogFile: /prometheus/query.log
    
    # Remote write configuration for Thanos Receive
    remoteWrite:
    - url: http://thanos-receive.monitoring.svc.cluster.local:19291/api/v1/receive
      writeRelabelConfigs:
      - sourceLabels: [__name__]
        regex: &apos;go_.*|process_.*|prometheus_.*&apos;
        action: drop




Advanced Recording Rules

Create rules/performance-rules.yaml:

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: performance-recording-rules
  namespace: monitoring
spec:
  groups:
  - name: instance.rules
    interval: 30s
    rules:
    # CPU utilization by instance
    - record: instance:cpu_utilization:rate5m
      expr: |
        (
          1 - avg by (instance) (
            rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[5m])
          )
        ) * 100
    
    # Memory utilization by instance
    - record: instance:memory_utilization:ratio
      expr: |
        (
          1 - (
            node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes
          )
        ) * 100
    
    # Disk utilization by instance and device
    - record: instance:disk_utilization:ratio
      expr: |
        (
          1 - (
            node_filesystem_avail_bytes{fstype!~&quot;tmpfs|fuse.lxcfs&quot;} /
            node_filesystem_size_bytes{fstype!~&quot;tmpfs|fuse.lxcfs&quot;}
          )
        ) * 100
    
    # Network throughput by instance
    - record: instance:network_throughput:rate5m
      expr: |
        sum by (instance) (
          rate(node_network_receive_bytes_total[5m]) +
          rate(node_network_transmit_bytes_total[5m])
        )

  - name: application.rules
    interval: 30s
    rules:
    # Application request rate
    - record: application:request_rate:rate5m
      expr: |
        sum by (service, namespace) (
          rate(http_requests_total[5m])
        )
    
    # Application error rate
    - record: application:error_rate:rate5m
      expr: |
        sum by (service, namespace) (
          rate(http_requests_total{status=~&quot;5..&quot;}[5m])
        ) / sum by (service, namespace) (
          rate(http_requests_total[5m])
        ) * 100
    
    # Application response time p99
    - record: application:response_time:p99
      expr: |
        histogram_quantile(0.99,
          sum by (service, namespace, le) (
            rate(http_request_duration_seconds_bucket[5m])
          )
        )

  - name: cluster.rules
    interval: 60s
    rules:
    # Cluster CPU utilization
    - record: cluster:cpu_utilization:rate5m
      expr: |
        avg(instance:cpu_utilization:rate5m)
    
    # Cluster memory utilization
    - record: cluster:memory_utilization:ratio
      expr: |
        (
          sum(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) /
          sum(node_memory_MemTotal_bytes)
        ) * 100
    
    # Cluster network throughput
    - record: cluster:network_throughput:rate5m
      expr: |
        sum(instance:network_throughput:rate5m)


Thanos Performance Optimization

Create values/thanos-performance.yaml:

query:
  enabled: true
  
  # Performance configuration
  extraArgs:
  - --query.timeout=15m
  - --query.max-concurrent=100
  - --query.lookback-delta=15m
  - --query.auto-downsampling
  - --query.partial-response
  - --query.max-concurrent-select=16
  - --store.unhealthy-timeout=5m
  - --store.response-timeout=30s
  
  # Resource allocation for high performance
  resources:
    requests:
      cpu: 4000m
      memory: 8Gi
    limits:
      cpu: 8000m
      memory: 16Gi

queryFrontend:
  enabled: true
  
  # Query optimization configuration
  extraArgs:
  - --query-range.split-interval=24h
  - --query-range.max-retries-per-request=3
  - --query-range.request-downsampled
  - --query-range.partial-response
  - --query-frontend.align-range-with-step
  - --query-frontend.split-queries-by-interval=24h
  - --query-frontend.cache-unaligned-requests
  
  # Caching configuration
  config: |
    type: redis
    config:
      addr: &quot;redis-cluster.monitoring.svc.cluster.local:6379&quot;
      password: &quot;${REDIS_PASSWORD}&quot;
      db: 0
      pool_size: 100
      min_idle_conns: 10
      dial_timeout: 5s
      read_timeout: 3s
      write_timeout: 3s
      expiration: 24h

storegateway:
  enabled: true
  
  # Performance optimization
  extraArgs:
  - --sync-block-duration=3m
  - --block-sync-concurrency=20
  - --index-cache-size=4GB
  - --chunk-pool-size=4GB
  - --store.grpc.series-sample-limit=120000
  - --store.grpc.series-max-concurrency=50
  
  # Resource allocation for high performance
  resources:
    requests:
      cpu: 4000m
      memory: 16Gi
    limits:
      cpu: 8000m
      memory: 32Gi

compactor:
  enabled: true
  
  # Compaction optimization
  extraArgs:
  - --block-files-concurrency=8
  - --compact-concurrency=4
  - --downsample-concurrency=4
  - --delete-delay=48h
  
  # Resource allocation
  resources:
    requests:
      cpu: 4000m
      memory: 8Gi
    limits:
      cpu: 8000m
      memory: 16Gi




Horizontal Pod Autoscaling

Create hpa/thanos-query-hpa.yaml:

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: thanos-query-hpa
  namespace: monitoring
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: thanos-query
  minReplicas: 3
  maxReplicas: 20
  metrics:
  # CPU-based scaling
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  # Memory-based scaling
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  
  # Custom metric: Query latency
  - type: Pods
    pods:
      metric:
        name: thanos_query_duration_seconds_p99
      target:
        type: AverageValue
        averageValue: &quot;5&quot;
  
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
      - type: Pods
        value: 4
        periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Min




Multi-Cluster Federation

For enterprise environments spanning multiple clusters, implement federation for unified monitoring across your infrastructure.



Multi-Cluster Architecture


  
    graph TB
      subgraph &quot;Global Control Plane&quot;
        GlobalQuery[Global Thanos Query]
        GlobalFrontend[Global Query Frontend]
        GlobalRuler[Global Thanos Ruler]
      end
      
      subgraph &quot;Region: US-East&quot;
        subgraph &quot;Production Cluster&quot;
          USEProd[Prometheus]
          USEThanos[Thanos Sidecar]
          USEReceive[Thanos Receive]
        end
        subgraph &quot;Staging Cluster&quot;
          USEStaging[Prometheus]
          USEThanosStg[Thanos Sidecar]
        end
      end
      
      subgraph &quot;Region: US-West&quot;
        subgraph &quot;Production Cluster&quot;
          USWProd[Prometheus]
          USWThanos[Thanos Sidecar]
          USWReceive[Thanos Receive]
        end
      end
      
      subgraph &quot;Global Storage Layer&quot;
        GlobalStorage[(Multi-RegionObject Storage)]
        RegionalCache[Regional StoreGateways]
      end
      
      GlobalQuery --&amp;gt; USEReceive
      GlobalQuery --&amp;gt; USWReceive
      GlobalQuery --&amp;gt; RegionalCache
      
      USEThanos --&amp;gt; GlobalStorage
      USWThanos --&amp;gt; GlobalStorage
      USEThanosStg --&amp;gt; GlobalStorage
      
      USEReceive --&amp;gt; GlobalStorage
      USWReceive --&amp;gt; GlobalStorage
      
      RegionalCache --&amp;gt; GlobalStorage
  


External Cluster Configuration



Create values/thanos-external-cluster.yaml:

# Configuration for external cluster
query:
  enabled: true
  
  # Connect to local Prometheus and remote clusters
  stores:
  - dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local
  - thanos-query-frontend-grpc.us-east-1.company.com:443
  - thanos-query-frontend-grpc.eu-central-1.company.com:443
  
  # External labels for this cluster
  extraArgs:
  - --query.replica-label=prometheus_replica
  - --query.replica-label=__replica__
  - --label=cluster=&quot;us-west-2&quot;
  - --label=region=&quot;us-west-2&quot;
  
  # gRPC ingress for external access
  ingress:
    grpc:
      enabled: true
      hostname: thanos-query-grpc.us-west-2.company.com
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/backend-protocol: &quot;GRPC&quot;
        nginx.ingress.kubernetes.io/grpc-backend: &quot;true&quot;
        cert-manager.io/cluster-issuer: &quot;letsencrypt-prod&quot;
      tls: true

# Store gateway for this region
storegateway:
  enabled: true
  
  # Regional store configuration
  extraArgs:
  - --selector.relabel-config-file=/etc/thanos/relabel.yml
  
  # Configure to serve only regional data
  configMaps:
  - name: store-relabel-config
    data:
      relabel.yml: |
        - source_labels: [cluster]
          regex: &quot;us-west-2&quot;
          action: keep




Global Query Configuration

Create values/thanos-global-query.yaml:

# Global Thanos Query for multi-cluster federation
query:
  enabled: true
  replicaCount: 5
  
  # All regional store endpoints
  stores:
  # Regional store gateways
  - thanos-store.us-east-1.company.com:10901
  - thanos-store.us-west-2.company.com:10901
  - thanos-store.eu-central-1.company.com:10901
  
  # Regional receive endpoints
  - thanos-receive.us-east-1.company.com:10901
  - thanos-receive.us-west-2.company.com:10901
  - thanos-receive.eu-central-1.company.com:10901
  
  # Direct Prometheus endpoints for real-time data
  - prometheus.us-east-1.company.com:10901
  - prometheus.us-west-2.company.com:10901
  - prometheus.eu-central-1.company.com:10901
  
  # Global query optimizations
  extraArgs:
  - --query.timeout=15m
  - --query.max-concurrent=100
  - --query.lookback-delta=15m
  - --query.auto-downsampling
  - --query.partial-response
  - --query.max-concurrent-select=16
  - --query.default-evaluation-interval=1m
  - --store.unhealthy-timeout=5m
  - --store.response-timeout=30s
  
  # Resource allocation for global scale
  resources:
    requests:
      cpu: 8000m
      memory: 16Gi
    limits:
      cpu: 16000m
      memory: 32Gi

queryFrontend:
  enabled: true
  
  # Global query frontend configuration
  extraArgs:
  - --query-range.split-interval=6h
  - --query-range.max-retries-per-request=5
  - --query-frontend.cache-compression-type=snappy
  - --query-frontend.downstream-tripper-config-file=/etc/thanos/tracing.yml
  
  # Global caching configuration
  config: |
    type: redis
    config:
      cluster_addrs:
      - redis-cluster-global.monitoring.svc.cluster.local:6379
      route_by_latency: true
      route_randomly: false
      expiration: 6h




Security and Compliance



Authentication and Authorization

RBAC Configuration

Create rbac/monitoring-rbac.yaml:

# Comprehensive RBAC for monitoring stack
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-enterprise
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-enterprise
rules:
# Core Prometheus permissions
- apiGroups: [&quot;&quot;]
  resources:
  - nodes
  - nodes/proxy
  - nodes/metrics
  - services
  - endpoints
  - pods
  - ingresses
  - configmaps
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;extensions&quot;, &quot;networking.k8s.io&quot;]
  resources:
  - ingresses
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;&quot;]
  resources:
  - configmaps
  verbs: [&quot;get&quot;]
- nonResourceURLs: [&quot;/metrics&quot;, &quot;/metrics/cadvisor&quot;]
  verbs: [&quot;get&quot;]

# Monitoring CRDs
- apiGroups: [&quot;monitoring.coreos.com&quot;]
  resources:
  - servicemonitors
  - podmonitors
  - prometheusrules
  - probes
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-enterprise
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-enterprise
subjects:
- kind: ServiceAccount
  name: prometheus-enterprise
  namespace: monitoring




TLS and Encryption

TLS Configuration

Create tls/monitoring-tls.yaml:

# TLS certificate for monitoring components
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: monitoring-tls
  namespace: monitoring
spec:
  secretName: monitoring-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - prometheus.your-domain.com
  - thanos-query.your-domain.com
  - thanos.your-domain.com
  - alertmanager.your-domain.com
---
# TLS configuration for Thanos components
apiVersion: v1
kind: Secret
metadata:
  name: thanos-tls
  namespace: monitoring
type: kubernetes.io/tls
data:
  tls.crt: # Base64 encoded certificate
  tls.key: # Base64 encoded private key
  ca.crt:  # Base64 encoded CA certificate




Data Protection

Encryption at Rest

Update object storage configuration with encryption:

# Enhanced object storage configuration with encryption
type: s3
config:
  bucket: &quot;enterprise-thanos-encrypted&quot;
  endpoint: &quot;s3.us-west-2.amazonaws.com&quot;
  region: &quot;us-west-2&quot;
  access_key: &quot;${AWS_ACCESS_KEY_ID}&quot;
  secret_key: &quot;${AWS_SECRET_ACCESS_KEY}&quot;
  insecure: false
  signature_version2: false
  
  # Server-side encryption
  encrypt_sse: true
  sse_config:
    type: &quot;SSE-KMS&quot;
    kms_key_id: &quot;arn:aws:kms:us-west-2:123456789012:key/12345678-1234-1234-1234-123456789012&quot;
  
  # Additional security headers
  put_user_metadata:
    &quot;X-Amz-Acl&quot;: &quot;private&quot;
    &quot;data-classification&quot;: &quot;internal&quot;
    &quot;encryption-required&quot;: &quot;true&quot;




Operational Excellence



Monitoring the Monitoring Stack

Self-Monitoring Configuration

Create monitoring/self-monitoring-rules.yaml:





Automated Operations

Backup and Recovery

Create backup/backup-job.yaml:





Disaster Recovery



Multi-Region DR Setup

Cross-Region Replication

Create dr/cross-region-config.yaml:

# Cross-region disaster recovery configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: disaster-recovery-config
  namespace: monitoring
data:
  dr-strategy.yml: |
    primary_region: us-west-2
    secondary_regions:
    - us-east-1
    - eu-central-1
    
    recovery_objectives:
      rpo: &quot;15m&quot;  # Recovery Point Objective
      rto: &quot;30m&quot;  # Recovery Time Objective
    
    backup_strategy:
      continuous_replication:
        enabled: true
        replication_lag_threshold: &quot;5m&quot;
      
      snapshots:
        frequency: &quot;4h&quot;
        retention: &quot;30d&quot;
        compression: true
        encryption: true
    
    failover_strategy:
      automated_triggers:
      - primary_region_down: &quot;10m&quot;
      - data_loss_detected: &quot;immediate&quot;
      
      manual_triggers:
      - security_incident
      - planned_maintenance


DR Testing

Create dr/dr-test-job.yaml:





Troubleshooting and Best Practices



Common Issues and Solutions

DNS Resolution Problems

Problem: Thanos Query cannot discover stores



Solution:
# Check DNS resolution
kubectl run -it --rm dns-test --image=nicolaka/netshoot --restart=Never -- dig _grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local

# Verify service endpoints
kubectl get endpoints -n monitoring | grep thanos

# Check service labels
kubectl get service kube-prometheus-stack-thanos-discovery -n monitoring -o yaml




Object Storage Access Issues

Problem: Thanos components cannot access object storage



Diagnosis:
# Test object storage connectivity
kubectl exec -it thanos-query-0 -n monitoring -- thanos tools bucket ls --objstore.config-file=/etc/bucket/objstore.yml

# Check secret configuration
kubectl get secret thanos-objstore -n monitoring -o yaml

# Verify network policies
kubectl get networkpolicies -n monitoring


Performance Issues

Problem: Slow query performance

Optimization checklist:

  Enable query caching: Configure Redis cache for Query Frontend
  Optimize queries: Use recording rules for complex calculations
  Scale components: Increase replicas for Query and Store Gateway
  Tune resource allocation: Adjust CPU and memory limits
  Enable downsampling: Configure appropriate retention policies




Best Practices

Configuration Management


  Use Git for configuration: Store all Helm values and manifests in version control
  Environment-specific values: Separate values files for different environments
  Secret management: Use external secret management (Vault, External Secrets Operator)
  Configuration validation: Implement pre-commit hooks for YAML validation


Operational Practices


  Monitor the monitoring: Set up comprehensive self-monitoring
  Regular testing: Implement automated DR testing and backup verification
  Capacity planning: Regular review of resource usage and scaling needs
  Security updates: Keep components updated with latest security patches
  Documentation: Maintain runbooks and operational procedures


Scaling Guidelines


  
    
      Metric Volume
      Prometheus Config
      Thanos Config
      Storage Strategy
    
    
      &amp;lt; 1M series
      Single instance
      Basic setup
      Local + 1y object
    
    
      1M-10M series
      HA with 2 replicas
      Multi-replica components
      Fast local + 2y object
    
    
      10M-100M series
      Sharded deployment
      Horizontal scaling
      NVMe + multi-region
    
    
      &amp;gt; 100M series
      Federation model
      Full enterprise setup
      Tiered storage strategy
    
  




Upgrade Procedures

Safe Upgrade Process


  Backup current state:
    # Backup configurations
kubectl get all -n monitoring -o yaml &amp;gt; monitoring-backup-$(date +%Y%m%d).yaml
   
# Backup PVCs
kubectl get pvc -n monitoring -o yaml &amp;gt; pvc-backup-$(date +%Y%m%d).yaml
    
  
  
    Test in staging: Always test upgrades in a staging environment first
  
  Rolling upgrade strategy:
    # Upgrade Prometheus Operator CRDs first
helm upgrade prometheus-operator-crds prometheus-community/prometheus-operator-crds -n monitoring
   
# Upgrade kube-prometheus-stack
helm upgrade kube-prometheus-stack prometheus-community/kube-prometheus-stack -n monitoring -f values/kube-prometheus-stack.yaml
   
# Upgrade Thanos
helm upgrade thanos bitnami/thanos -n monitoring -f values/thanos.yaml
    
  
  Verification after upgrade:
    # Check pod status
kubectl get pods -n monitoring
   
# Verify metrics ingestion
kubectl port-forward svc/thanos-query 9090:9090 -n monitoring &amp;amp;
curl &quot;http://localhost:9090/api/v1/query?query=up&quot;
    
  




Conclusion

This comprehensive guide provides a complete roadmap for implementing enterprise-grade Prometheus and Thanos monitoring infrastructure. Starting with basic Helm installations and progressing through advanced enterprise configurations, you now have the knowledge and practical examples needed to build monitoring systems that can scale with your organization’s growth.



Key Implementation Steps Recap:


  Start with basics: Use the provided Helm configurations to establish core monitoring
  Implement security: Add RBAC, TLS, and network policies from day one
  Plan for scale: Design your architecture with growth in mind
  Automate operations: Implement backup, monitoring, and recovery procedures
  Test regularly: Validate your setup with automated testing and DR procedures




Enterprise Success Factors:


  Architectural Excellence: Multi-cluster federation and advanced scaling patterns
  Security First: Comprehensive security framework with encryption and access controls
  Operational Excellence: Self-monitoring, automated recovery, and disaster preparedness
  Performance Optimization: Advanced caching, resource management, and query optimization
  Continuous Improvement: Regular testing, monitoring, and refinement of your monitoring infrastructure


Whether you’re implementing monitoring for a single cluster or orchestrating observability across a global infrastructure, this guide provides the foundation for building monitoring systems that deliver reliable insights while maintaining the operational excellence required for enterprise success.





References and Resources



Official Documentation

  Prometheus Documentation
  Thanos Documentation
  Prometheus Operator Guide




Helm Charts

  Kube-Prometheus-Stack
  Bitnami Thanos Chart
  Prometheus Community Charts




Advanced Topics

  Thanos Storage Configuration
  Multi-cluster Monitoring Patterns
  Prometheus Performance Best Practices
  Kubernetes Monitoring Guide

",
            "wordcount": "6499",
            "inLanguage": "en",
            "dateCreated": "2025-06-04/",
            "datePublished": "2025-06-04/",
            "dateModified": "2025-06-04/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "MONITORING",
            "articleSection": "MONITORING",
            "keywords": ["prometheus","thanos","helm","kubernetes"]
        }
        </script>
    </body>
</html>
