<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>AWS IRSA (IAM Roles for Service Accounts) - Complete Enterprise Guide | somaz</title>
    <meta name="description" content="Complete guide to AWS IRSA implementation, from basic concepts to enterprise-grade security patterns and operational best practices">
    
        <meta name="keywords" content="aws, kubernetes, eks, security, irsa, oidc, sts, iam, enterprise, devops">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AWS IRSA (IAM Roles for Service Accounts) - Complete Enterprise Guide | somaz">
    <meta name="twitter:description" content="Complete guide to AWS IRSA implementation, from basic concepts to enterprise-grade security patterns and operational best practices">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1738570911/aws-irsa_bnkgqv.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/aws/aws-irsa/">
    <meta property="og:title" content="AWS IRSA (IAM Roles for Service Accounts) - Complete Enterprise Guide | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1738570911/aws-irsa_bnkgqv.png">
    <meta property="og:description" content="Complete guide to AWS IRSA implementation, from basic concepts to enterprise-grade security patterns and operational best practices">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/aws/aws-irsa/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-05-15T00:00:00+00:00">
                            


May 15, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>53 min to read</span>
                </p>
                <h1 class="post-title">AWS IRSA (IAM Roles for Service Accounts) - Complete Enterprise Guide</h1>
                <p class="post-subtitle">Master secure AWS service access in EKS with advanced IRSA implementation patterns</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1738570911/aws-irsa_bnkgqv.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><br /></p>

<hr />

<h2 id="table-of-contents">Table of Contents</h2>
<ul>
  <li><a href="#overview">Overview</a></li>
  <li><a href="#the-problem-with-traditional-approaches">The Problem with Traditional Approaches</a></li>
  <li><a href="#core-components-deep-dive">Core Components Deep Dive</a></li>
  <li><a href="#irsa-workflow-and-architecture">IRSA Workflow and Architecture</a></li>
  <li><a href="#implementation-guide">Implementation Guide</a></li>
  <li><a href="#advanced-configuration-patterns">Advanced Configuration Patterns</a></li>
  <li><a href="#enterprise-use-cases">Enterprise Use Cases</a></li>
  <li><a href="#security-best-practices">Security Best Practices</a></li>
  <li><a href="#monitoring-and-operations">Monitoring and Operations</a></li>
  <li><a href="#troubleshooting-guide">Troubleshooting Guide</a></li>
  <li><a href="#migration-strategies">Migration Strategies</a></li>
  <li><a href="#performance-optimization">Performance Optimization</a></li>
</ul>

<p><br /></p>

<hr />

<h2 id="overview">Overview</h2>

<p>AWS IAM Roles for Service Accounts (IRSA) revolutionizes how Kubernetes workloads securely access AWS services.</p>

<p>By leveraging OpenID Connect (OIDC) and AWS Security Token Service (STS), IRSA eliminates the need for long-lived credentials while providing fine-grained, pod-level access control.</p>

<p><br /></p>

<div class="quote-box">
  <strong>Why IRSA Matters</strong>
  <ul>
    <li><strong>Zero Trust Security:</strong> No long-lived credentials stored in clusters</li>
    <li><strong>Granular Permissions:</strong> Pod-level access control with least privilege</li>
    <li><strong>Kubernetes Native:</strong> Seamless integration with ServiceAccounts</li>
    <li><strong>Audit Trail:</strong> Complete visibility into AWS API calls</li>
    <li><strong>Operational Simplicity:</strong> Automatic credential rotation and management</li>
  </ul>
</div>

<p><br /></p>

<hr />

<h2 id="the-problem-with-traditional-approaches">The Problem with Traditional Approaches</h2>

<p><br /></p>

<h3 id="1-ec2-instance-profiles---the-overprivileged-problem">1. EC2 Instance Profiles - The Overprivileged Problem</h3>

<p>Before IRSA, the most common approach was using EC2 instance profiles, which grants the same permissions to all pods on a node.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># All pods inherit the same permissions</span>
aws sts get-caller-identity
<span class="c"># Returns the same role for every pod on the node</span>
</code></pre></div></div>

<p><strong>Critical Issues:</strong></p>
<ul>
  <li><strong>Blast Radius:</strong> Single compromised pod can access all permissions</li>
  <li><strong>Compliance Violations:</strong> Impossible to implement least privilege</li>
  <li><strong>Audit Complexity:</strong> Cannot trace specific pod actions</li>
  <li><strong>Scale Limitations:</strong> Cannot support multi-tenant workloads</li>
</ul>

<p><br /></p>

<h3 id="2-embedded-credentials---the-security-nightmare">2. Embedded Credentials - The Security Nightmare</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Anti-pattern: Never do this</span>
<span class="na">env</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_ACCESS_KEY_ID</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AKIAIOSFODNN7EXAMPLE"</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_SECRET_ACCESS_KEY</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>
</code></pre></div></div>

<h4 id="security-risks">Security Risks:</h4>
<ul>
  <li><strong>Credential Leakage:</strong> Visible in process lists, logs, and configs</li>
  <li><strong>No Rotation:</strong> Manual rotation process prone to human error</li>
  <li><strong>Git Exposure:</strong> Risk of committing credentials to version control</li>
  <li><strong>Container Registry Exposure:</strong> Credentials baked into images</li>
</ul>

<p><br /></p>

<h3 id="3-external-secret-management---the-complexity-trap">3. External Secret Management - The Complexity Trap</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complex initialization process</span>
<span class="na">initContainers</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret-fetcher</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">vault:latest</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">sh'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">-c'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">vault</span><span class="nv"> </span><span class="s">auth</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">vault</span><span class="nv"> </span><span class="s">kv</span><span class="nv"> </span><span class="s">get</span><span class="nv"> </span><span class="s">-field=aws_key</span><span class="nv"> </span><span class="s">secret/myapp'</span><span class="pi">]</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="operational-overhead">Operational Overhead:</h4>
<ul>
  <li><strong>Bootstrap Problem:</strong> Still need initial credentials</li>
  <li><strong>Dependency Chain:</strong> Multiple points of failure</li>
  <li><strong>Latency Impact:</strong> Additional API calls at startup</li>
  <li><strong>Complexity:</strong> Multiple systems to maintain and monitor</li>
</ul>

<p><br /></p>

<h3 id="irsa-the-elegant-solution">IRSA: The Elegant Solution</h3>

<div class="info-box info-box-success-not-check">
  <strong>How IRSA Solves These Problems</strong>
  <ul>
    <li><strong>Automatic Credential Provisioning:</strong> AWS SDK automatically discovers and uses IRSA credentials</li>
    <li><strong>Temporary Credentials:</strong> Short-lived tokens that auto-rotate</li>
    <li><strong>Pod-Level Isolation:</strong> Each ServiceAccount maps to specific IAM role</li>
    <li><strong>Zero Configuration:</strong> No credential management in application code</li>
    <li><strong>Full Auditability:</strong> CloudTrail tracks every API call with pod identity</li>
  </ul>
</div>

<p><br /></p>

<h3 id="what-is-aws-irsa">What is AWS IRSA?</h3>

<p>AWS IRSA is a sophisticated identity federation mechanism that bridges Kubernetes ServiceAccounts with AWS IAM roles. It uses industry-standard protocols (OIDC) to establish trust between your EKS cluster and AWS IAM, enabling secure, temporary credential exchange without storing any long-lived secrets.</p>

<p><br /></p>

<hr />

<h2 id="core-components-deep-dive">Core Components Deep Dive</h2>

<div class="info-box info-box-default-not-check">
  <strong>IRSA Architecture Components</strong>
  <ul>
    <li><strong>Kubernetes ServiceAccounts:</strong> Identity primitive for pods</li>
    <li><strong>AWS IAM Roles:</strong> Permission container with trust policies</li>
    <li><strong>OpenID Connect (OIDC) Provider:</strong> Identity federation bridge</li>
    <li><strong>Security Token Service (STS):</strong> Temporary credential issuer</li>
    <li><strong>EKS Pod Identity Webhook:</strong> Automatic credential injection</li>
    <li><strong>AWS SDK:</strong> Automatic credential discovery and rotation</li>
  </ul>
</div>

<p><br /></p>

<h3 id="openid-connect-oidc---the-trust-foundation">OpenID Connect (OIDC) - The Trust Foundation</h3>

<p>OpenID Connect serves as the cornerstone of IRSA’s security model, establishing cryptographically verifiable trust between EKS and AWS IAM.</p>

<h4 id="technical-deep-dive">Technical Deep Dive</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts.amazonaws.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:namespace:service-account-name"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516242622</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kubernetes.io"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"serviceaccount"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-service-account"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12345678-1234-1234-1234-123456789012"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pod"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-pod-12345"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87654321-4321-4321-4321-210987654321"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="key-oidc-features-for-irsa">Key OIDC Features for IRSA:</h4>
<ul>
  <li><strong>Cryptographic Signatures:</strong> JWT tokens are signed with rotating keys</li>
  <li><strong>Audience Validation:</strong> Ensures tokens are intended for AWS STS</li>
  <li><strong>Subject Identity:</strong> Maps to specific Kubernetes ServiceAccount</li>
  <li><strong>Expiration Control:</strong> Configurable token lifetime (default: 1 hour)</li>
</ul>

<h4 id="oidc-provider-setup-and-verification">OIDC Provider Setup and Verification</h4>

<script src="https://gist.github.com/somaz94/dcfdd3124e75edec6a40934d90241fdb.js"></script>

<script src="https://gist.github.com/somaz94/c68ef16712cd35a63c3f2cfe5b917a07.js"></script>

<p><br /></p>

<h3 id="kubernetes-serviceaccounts---identity-primitives">Kubernetes ServiceAccounts - Identity Primitives</h3>

<p>ServiceAccounts in Kubernetes serve as the identity foundation for IRSA, providing a secure mechanism to associate AWS IAM roles with specific pods.</p>

<h4 id="advanced-serviceaccount-configuration">Advanced ServiceAccount Configuration</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">advanced-service-account</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="c1"># Primary IRSA annotation</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/MyAppRole</span>
    
    <span class="c1"># Optional: Specify audience (default: sts.amazonaws.com)</span>
    <span class="na">eks.amazonaws.com/audience</span><span class="pi">:</span> <span class="s">sts.amazonaws.com</span>
    
    <span class="c1"># Optional: Custom token expiration (default: 86400 seconds)</span>
    <span class="na">eks.amazonaws.com/token-expiration</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3600"</span>
    
    <span class="c1"># Optional: STS regional endpoints</span>
    <span class="na">eks.amazonaws.com/sts-regional-endpoints</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">my-application</span>
    <span class="na">tier</span><span class="pi">:</span> <span class="s">backend</span>
    <span class="na">security.policy</span><span class="pi">:</span> <span class="s">irsa-enabled</span>
<span class="nn">---</span>
<span class="c1"># Role binding for Kubernetes RBAC</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">serviceaccount-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">serviceaccounts"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">read-serviceaccounts</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">advanced-service-account</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">serviceaccount-reader</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<h4 id="serviceaccount-best-practices">ServiceAccount Best Practices</h4>

<div class="info-box info-box-warning-not-check">
  <strong>ServiceAccount Security Guidelines</strong>
  <ul>
    <li><strong>Namespace Isolation:</strong> Use dedicated namespaces for different environments</li>
    <li><strong>Naming Convention:</strong> Include app name and environment in ServiceAccount names</li>
    <li><strong>Automount Control:</strong> Disable automounting when not needed</li>
    <li><strong>RBAC Integration:</strong> Combine with Kubernetes RBAC for defense in depth</li>
  </ul>
</div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example: Disable automatic token mounting</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">no-auto-mount-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">automountServiceAccountToken</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># Disable if not needed</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="aws-security-token-service-sts---credential-engine">AWS Security Token Service (STS) - Credential Engine</h3>

<p>STS acts as the credential engine in IRSA, issuing temporary, automatically rotating credentials based on OIDC token validation.</p>

<h4 id="sts-token-exchange-flow">STS Token Exchange Flow</h4>

<script src="https://gist.github.com/somaz94/ef323fd77793151f816ca59cd6711b7d.js"></script>

<h4 id="advanced-sts-configuration">Advanced STS Configuration</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Federated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRoleWithWebIdentity"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:production:my-service-account"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts.amazonaws.com"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:amr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"authenticated"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:TokenIssueTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T00:00:00Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"NumericLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:TokenAge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"86400"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Advanced Trust Policy Features:</strong></p>
<ul>
  <li><strong>Time-based Conditions:</strong> Restrict token age and issue time</li>
  <li><strong>Session Constraints:</strong> Limit session duration and permissions</li>
  <li><strong>Source IP Restrictions:</strong> Geographic or network-based access control</li>
  <li><strong>MFA Requirements:</strong> Require multi-factor authentication for sensitive roles</li>
</ul>

<p><br /></p>

<hr />

<h2 id="irsa-workflow-and-architecture">IRSA Workflow and Architecture</h2>

<p><br /></p>

<h3 id="complete-end-to-end-workflow">Complete End-to-End Workflow</h3>

<p>The IRSA workflow involves multiple components working together to provide seamless, secure access to AWS services. Here’s the detailed step-by-step process:</p>

<div class="info-box info-box-default-not-check">
  <strong>IRSA Token Exchange Flow</strong>
  <ol>
    <li><strong>Pod Startup:</strong> EKS Pod Identity Webhook injects OIDC token</li>
    <li><strong>Token Projection:</strong> Kubernetes mounts projected token volume</li>
    <li><strong>AWS SDK Discovery:</strong> AWS SDK automatically discovers IRSA credentials</li>
    <li><strong>STS Token Exchange:</strong> SDK calls AssumeRoleWithWebIdentity</li>
    <li><strong>OIDC Validation:</strong> STS validates JWT with OIDC provider</li>
    <li><strong>Trust Policy Check:</strong> IAM evaluates trust relationships</li>
    <li><strong>Temporary Credentials:</strong> STS issues short-lived credentials</li>
    <li><strong>AWS API Calls:</strong> Pod uses temporary credentials for AWS services</li>
    <li><strong>Automatic Renewal:</strong> SDK handles credential refresh transparently</li>
  </ol>
</div>

<p><br /></p>

<h3 id="detailed-architecture-diagram-analysis">Detailed Architecture Diagram Analysis</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   EKS Cluster   │    │   AWS IAM/STS    │    │  AWS Services   │
│                 │    │                  │    │                 │
│  ┌───────────┐  │    │  ┌─────────────┐ │    │  ┌───────────┐  │
│  │    Pod    │  │    │  │     STS     │ │    │  │    S3     │  │
│  │           │  │    │  │             │ │    │  │           │  │
│  │  AWS SDK  │  │◄──►│  │AssumeRole   │ │    │  │  Buckets  │  │
│  │           │  │    │  │WithWebID    │ │    │  │           │  │
│  └─────┬─────┘  │    │  └─────────────┘ │    │  └───────────┘  │
│        │        │    │         │        │    │         │       │
│  ┌─────▼─────┐  │    │  ┌──────▼──────┐ │    │  ┌──────▼────┐  │
│  │ServiceAcc │  │    │  │ OIDC Provider│ │    │  │ DynamoDB  │  │
│  │ + Role    │  │    │  │ Validation   │ │    │  │   Tables  │  │
│  │Annotation │  │    │  └─────────────┘ │    │  └───────────┘  │
│  └───────────┘  │    │         │        │    │         │       │
│        │        │    │  ┌──────▼──────┐ │    │  ┌──────▼────┐  │
│  ┌─────▼─────┐  │    │  │  IAM Role   │ │    │  │    SQS    │  │
│  │ OIDC JWT  │  │    │  │Trust Policy │ │    │  │   Queues  │  │
│  │  Token    │  │    │  └─────────────┘ │    │  └───────────┘  │
│  └───────────┘  │    └──────────────────┘    └─────────────────┘
└─────────────────┘
</code></pre></div></div>

<p><br /></p>

<h3 id="real-world-example-s3-access-workflow">Real-World Example: S3 Access Workflow</h3>

<p>Let’s walk through a practical example where a pod needs to access S3:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. ServiceAccount with IRSA configuration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/S3ProcessorRole</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 2. Application code (Python with boto3)
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">process_s3_files</span><span class="p">():</span>
    <span class="c1"># AWS SDK automatically discovers IRSA credentials
</span>    <span class="c1"># No explicit credential configuration needed!
</span>    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'s3'</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># List objects in bucket
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">s3_client</span><span class="p">.</span><span class="n">list_objects_v2</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="s">'my-data-bucket'</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Contents'</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Processing file: </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s">'Key'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Download and process file
</span>            <span class="n">s3_client</span><span class="p">.</span><span class="n">download_file</span><span class="p">(</span>
                <span class="s">'my-data-bucket'</span><span class="p">,</span> 
                <span class="n">obj</span><span class="p">[</span><span class="s">'Key'</span><span class="p">],</span> 
                <span class="sa">f</span><span class="s">"/tmp/</span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s">'Key'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span>
            <span class="p">)</span>
            
    <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error accessing S3: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">process_s3_files</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 3. Pod deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">s3-processor</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">s3-processor</span>  <span class="c1"># Links to IRSA-enabled ServiceAccount</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">processor</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-company/s3-processor:v1.0.0</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="c1"># No AWS credentials needed - IRSA handles automatically!</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">256Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="behind-the-scenes-credential-discovery">Behind the Scenes: Credential Discovery</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Inside the pod, AWS SDK follows this credential discovery chain:</span>
<span class="c"># 1. Environment variables (AWS_ACCESS_KEY_ID, etc.) - Empty</span>
<span class="c"># 2. AWS credentials file (~/.aws/credentials) - Not present</span>
<span class="c"># 3. IAM instance profile - Not applicable in containers</span>
<span class="c"># 4. Web Identity Token (IRSA) - Found and used!</span>

<span class="c"># The projected token is mounted at:</span>
<span class="nb">ls</span> <span class="nt">-la</span> /var/run/secrets/eks.amazonaws.com/serviceaccount/
<span class="c"># token  # JWT token for OIDC authentication</span>

<span class="c"># AWS SDK reads this token and makes STS call:</span>
<span class="nb">cat</span> /var/run/secrets/eks.amazonaws.com/serviceaccount/token
<span class="c"># eyJhbGciOiJSUzI1NiIsImtpZCI6... (JWT token)</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="credential-lifecycle-management">Credential Lifecycle Management</h3>

<div class="info-box info-box-default-not-check">
  <strong>Automatic Credential Lifecycle</strong>
  <ul>
    <li><strong>Token Issuance:</strong> Kubernetes issues JWT with 1-hour expiration</li>
    <li><strong>STS Exchange:</strong> AWS SDK exchanges JWT for temporary credentials</li>
    <li><strong>Credential Caching:</strong> SDK caches credentials until near expiration</li>
    <li><strong>Automatic Refresh:</strong> SDK automatically refreshes before expiration</li>
    <li><strong>Graceful Fallback:</strong> Retry logic handles temporary failures</li>
  </ul>
</div>

<p><br /></p>

<h3 id="security-validation-points">Security Validation Points</h3>

<p>The IRSA workflow includes multiple security validation checkpoints:</p>

<ol>
  <li><strong>Kubernetes API Server Validation:</strong>
    <ul>
      <li>Validates ServiceAccount exists</li>
      <li>Checks RBAC permissions</li>
      <li>Verifies pod is authorized to use ServiceAccount</li>
    </ul>
  </li>
  <li><strong>OIDC Token Validation:</strong>
    <ul>
      <li>Cryptographic signature verification</li>
      <li>Audience claim validation (sts.amazonaws.com)</li>
      <li>Subject claim validation (namespace:serviceaccount)</li>
      <li>Token expiration check</li>
    </ul>
  </li>
  <li><strong>IAM Trust Policy Evaluation:</strong>
    <ul>
      <li>Federated identity verification</li>
      <li>Condition evaluation (StringEquals, StringLike, etc.)</li>
      <li>Principal validation</li>
    </ul>
  </li>
  <li><strong>STS Token Issuance:</strong>
    <ul>
      <li>Temporary credential generation</li>
      <li>Session policy application</li>
      <li>Permission boundary enforcement</li>
    </ul>
  </li>
</ol>

<p><br /></p>

<hr />

<h2 id="implementation-guide">Implementation Guide</h2>

<p><br /></p>

<h3 id="prerequisites-and-environment-setup">Prerequisites and Environment Setup</h3>

<p>Before implementing IRSA, ensure your environment meets these requirements:</p>

<div class="info-box info-box-warning-not-check">
  <strong>Prerequisites Checklist</strong>
  <ul>
    <li><strong>EKS Version:</strong> 1.13+ (recommended: 1.21+)</li>
    <li><strong>AWS CLI:</strong> Version 2.0+ with appropriate permissions</li>
    <li><strong>kubectl:</strong> Compatible with your EKS version</li>
    <li><strong>eksctl:</strong> Latest version (optional but recommended)</li>
    <li><strong>IAM Permissions:</strong> iam:CreateRole, iam:CreateOpenIDConnectProvider</li>
  </ul>
</div>

<p><br /></p>

<h3 id="step-1-oidc-provider-setup-advanced">Step 1: OIDC Provider Setup (Advanced)</h3>

<script src="https://gist.github.com/somaz94/cc0ec732a1550c3dbd1be4f7c1483536.js"></script>

<p><br /></p>

<script src="https://gist.github.com/somaz94/8344b84f525d1245560ac5db3bfd3556.js"></script>

<p><br /></p>

<h3 id="step-2-advanced-iam-role-creation">Step 2: Advanced IAM Role Creation</h3>

<script src="https://gist.github.com/somaz94/c22d3c071f219731c966c812ddf26998.js"></script>

<p><br /></p>

<script src="https://gist.github.com/somaz94/955a0f77a9b8cd0c360e22e499a14047.js"></script>

<p><br /></p>

<h3 id="step-3-advanced-serviceaccount-configuration">Step 3: Advanced ServiceAccount Configuration</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># advanced-serviceaccount.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="c1"># Required: IAM role ARN</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/S3ProcessorRole</span>
    
    <span class="c1"># Optional: Specify audience (default: sts.amazonaws.com)</span>
    <span class="na">eks.amazonaws.com/audience</span><span class="pi">:</span> <span class="s">sts.amazonaws.com</span>
    
    <span class="c1"># Optional: Token expiration (default: 86400 seconds)</span>
    <span class="na">eks.amazonaws.com/token-expiration</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3600"</span>
    
    <span class="c1"># Optional: STS regional endpoints for better performance</span>
    <span class="na">eks.amazonaws.com/sts-regional-endpoints</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    
    <span class="c1"># Metadata for operational purposes</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ServiceAccount</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">S3</span><span class="nv"> </span><span class="s">data</span><span class="nv"> </span><span class="s">processing</span><span class="nv"> </span><span class="s">workloads"</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s2">"</span><span class="s">data-platform-team"</span>
    <span class="na">cost-center</span><span class="pi">:</span> <span class="s2">"</span><span class="s">engineering"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">s3-processor</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">data-pipeline</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">analytics-platform</span>
    <span class="na">security.policy/irsa</span><span class="pi">:</span> <span class="s2">"</span><span class="s">enabled"</span>
    <span class="na">compliance.level</span><span class="pi">:</span> <span class="s2">"</span><span class="s">high"</span>
<span class="na">automountServiceAccountToken</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># Required for IRSA</span>
<span class="nn">---</span>
<span class="c1"># Create namespace if it doesn't exist</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">pod-security.kubernetes.io/enforce</span><span class="pi">:</span> <span class="s">restricted</span>
    <span class="na">pod-security.kubernetes.io/audit</span><span class="pi">:</span> <span class="s">restricted</span>
    <span class="na">pod-security.kubernetes.io/warn</span><span class="pi">:</span> <span class="s">restricted</span>
<span class="nn">---</span>
<span class="c1"># RBAC configuration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor-role</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">secrets"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">configmaps"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">events"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor-binding</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="step-4-production-ready-deployment">Step 4: Production-Ready Deployment</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># production-deployment.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">s3-processor</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1.0.0</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">maxSurge</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">s3-processor</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">s3-processor</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1.0.0</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">prometheus.io/scrape</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
        <span class="na">prometheus.io/port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">8080"</span>
        <span class="na">prometheus.io/path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/metrics"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">s3-processor</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">65534</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">processor</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-company/s3-processor:v1.0.0</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_DEFAULT_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="c1"># Enable STS regional endpoints for better performance</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_STS_REGIONAL_ENDPOINTS</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">regional</span>
        <span class="c1"># Optional: Enable AWS SDK debug logging</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_SDK_LOAD_CONFIG</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
        <span class="c1"># Application-specific configuration</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">S3_BUCKET_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">my-data-bucket</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PROCESSING_CONCURRENCY</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">512Mi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ALL</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tmp</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/tmp</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cache</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app/cache</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tmp</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cache</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">podAntiAffinity</span><span class="pi">:</span>
          <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
            <span class="na">podAffinityTerm</span><span class="pi">:</span>
              <span class="na">labelSelector</span><span class="pi">:</span>
                <span class="na">matchExpressions</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app</span>
                  <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                  <span class="na">values</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s">s3-processor</span>
              <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="step-5-verification-and-testing">Step 5: Verification and Testing</h3>

<script src="https://gist.github.com/somaz94/28ef935ff782fcb3c2e9ccfe13dcf617.js"></script>

<p><br /></p>

<hr />

<h2 id="advanced-configuration-patterns">Advanced Configuration Patterns</h2>

<p><br /></p>

<h3 id="multi-tenant-irsa-setup">Multi-Tenant IRSA Setup</h3>

<p>For organizations running multiple teams or applications in shared EKS clusters:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Namespace-based isolation</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">team-alpha</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">team</span><span class="pi">:</span> <span class="s">alpha</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">team-beta</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">team</span><span class="pi">:</span> <span class="s">beta</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
<span class="nn">---</span>
<span class="c1"># Team Alpha ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-service-account</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">team-alpha</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/TeamAlphaAppRole</span>
<span class="nn">---</span>
<span class="c1"># Team Beta ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-service-account</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">team-beta</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/TeamBetaAppRole</span>
</code></pre></div></div>

<h3 id="cross-account-irsa-configuration">Cross-Account IRSA Configuration</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Federated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::ACCOUNT-A:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:production:cross-account-service"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::ACCOUNT-A:role/CrossAccountRole"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"sts:ExternalId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"unique-external-id-12345"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h3 id="environment-specific-configurations">Environment-Specific Configurations</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Environment-specific role naming convention</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span><span class="s2">"production"</span>  <span class="c"># or staging, development</span>
<span class="nv">APPLICATION</span><span class="o">=</span><span class="s2">"data-processor"</span>
<span class="nv">ROLE_NAME</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">ENVIRONMENT</span><span class="k">}</span><span class="s2">-</span><span class="k">${</span><span class="nv">APPLICATION</span><span class="k">}</span><span class="s2">-role"</span>

<span class="c"># Create environment-specific trust policies</span>
<span class="nb">cat</span> <span class="o">&gt;</span> <span class="k">${</span><span class="nv">ENVIRONMENT</span><span class="k">}</span><span class="nt">-trust-policy</span>.json <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::</span><span class="k">${</span><span class="nv">ACCOUNT_ID</span><span class="k">}</span><span class="sh">:oidc-provider/oidc.eks.</span><span class="k">${</span><span class="nv">REGION</span><span class="k">}</span><span class="sh">.amazonaws.com/id/</span><span class="k">${</span><span class="nv">OIDC_ID</span><span class="k">}</span><span class="sh">"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.</span><span class="k">${</span><span class="nv">REGION</span><span class="k">}</span><span class="sh">.amazonaws.com/id/</span><span class="k">${</span><span class="nv">OIDC_ID</span><span class="k">}</span><span class="sh">:sub": "system:serviceaccount:</span><span class="k">${</span><span class="nv">ENVIRONMENT</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">APPLICATION</span><span class="k">}</span><span class="sh">",
          "oidc.eks.</span><span class="k">${</span><span class="nv">REGION</span><span class="k">}</span><span class="sh">.amazonaws.com/id/</span><span class="k">${</span><span class="nv">OIDC_ID</span><span class="k">}</span><span class="sh">:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "oidc.eks.</span><span class="k">${</span><span class="nv">REGION</span><span class="k">}</span><span class="sh">.amazonaws.com/id/</span><span class="k">${</span><span class="nv">OIDC_ID</span><span class="k">}</span><span class="sh">:amr": "authenticated"
        }
      }
    }
  ]
}
</span><span class="no">EOF
</span></code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="enterprise-use-cases">Enterprise Use Cases</h2>

<p><br /></p>

<h3 id="1-data-pipeline-architecture">1. Data Pipeline Architecture</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Real-world data processing pipeline with IRSA</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Workflow</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">data-pipeline</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">data-platform</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">data-pipeline-sa</span>
  <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">process-data</span>
  <span class="na">templates</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">process-data</span>
    <span class="na">dag</span><span class="pi">:</span>
      <span class="na">tasks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">extract</span>
        <span class="na">template</span><span class="pi">:</span> <span class="s">s3-extractor</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">transform</span>
        <span class="na">template</span><span class="pi">:</span> <span class="s">data-transformer</span>
        <span class="na">dependencies</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">extract</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">load</span>
        <span class="na">template</span><span class="pi">:</span> <span class="s">rds-loader</span>
        <span class="na">dependencies</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">transform</span><span class="pi">]</span>
  
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">s3-extractor</span>
    <span class="na">container</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">data-platform/extractor:v2.1.0</span>
      <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SOURCE_BUCKET</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">raw-data-bucket</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
        <span class="na">limits</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s">2Gi</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s">1000m</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-microservices-with-different-aws-permissions">2. Microservices with Different AWS Permissions</h3>

<div class="info-box info-box-default-not-check">
  <strong>Microservices IRSA Pattern</strong>
  <ul>
    <li><strong>User Service:</strong> DynamoDB read/write, Cognito access</li>
    <li><strong>Order Service:</strong> SQS/SNS, RDS access, S3 receipts</li>
    <li><strong>Payment Service:</strong> Secrets Manager, KMS encryption</li>
    <li><strong>Notification Service:</strong> SES, SNS publishing</li>
    <li><strong>Analytics Service:</strong> Kinesis, S3 data lake, Athena</li>
  </ul>
</div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User Service - DynamoDB focused</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">user-service-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">microservices</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/UserServiceRole</span>
<span class="nn">---</span>
<span class="c1"># Order Service - Multiple services</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">order-service-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">microservices</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/OrderServiceRole</span>
<span class="nn">---</span>
<span class="c1"># Payment Service - High security requirements</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">payment-service-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">microservices</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/PaymentServiceRole</span>
    <span class="c1"># Additional security constraints</span>
    <span class="na">eks.amazonaws.com/token-expiration</span><span class="pi">:</span> <span class="s2">"</span><span class="s">900"</span>  <span class="c1"># 15 minutes</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-cicd-pipeline-integration">3. CI/CD Pipeline Integration</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># GitLab CI/CD with IRSA for deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gitlab-runner-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">gitlab-system</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/GitLabRunnerRole</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gitlab-runner</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">gitlab-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">gitlab-runner</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">gitlab-runner</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">gitlab-runner-sa</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">gitlab-runner</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gitlab/gitlab-runner:latest</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="c1"># Can now push to ECR, deploy to EKS, update CloudFormation</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-sock</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/docker.sock</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-sock</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/var/run/docker.sock</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-machine-learning-workloads">4. Machine Learning Workloads</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ML training job with IRSA
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">sagemaker</span>
<span class="kn">from</span> <span class="nn">sagemaker.pytorch</span> <span class="kn">import</span> <span class="n">PyTorch</span>

<span class="c1"># AWS SDK automatically uses IRSA credentials
</span><span class="n">sagemaker_session</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="p">.</span><span class="n">get_execution_role</span><span class="p">()</span>  <span class="c1"># Uses IRSA role
</span>
<span class="c1"># Define training job
</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">PyTorch</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="s">'train.py'</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="s">'src'</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>  <span class="c1"># IRSA-provided role
</span>    <span class="n">instance_type</span><span class="o">=</span><span class="s">'ml.p3.2xlarge'</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s">'1.8.0'</span><span class="p">,</span>
    <span class="n">py_version</span><span class="o">=</span><span class="s">'py38'</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'epochs'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s">'batch-size'</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="s">'learning-rate'</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="p">},</span>
    <span class="c1"># Data stored in S3 (accessible via IRSA)
</span>    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'training'</span><span class="p">:</span> <span class="s">'s3://ml-data-bucket/train/'</span><span class="p">,</span>
        <span class="s">'validation'</span><span class="p">:</span> <span class="s">'s3://ml-data-bucket/val/'</span>
    <span class="p">},</span>
    <span class="c1"># Model output to S3
</span>    <span class="n">output_path</span><span class="o">=</span><span class="s">'s3://ml-models-bucket/experiments/'</span><span class="p">,</span>
    
    <span class="c1"># Use Spot instances with IRSA for cost optimization
</span>    <span class="n">use_spot_instances</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">max_wait</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>
    <span class="n">max_run</span><span class="o">=</span><span class="mi">3600</span>
<span class="p">)</span>

<span class="c1"># Start training
</span><span class="n">estimator</span><span class="p">.</span><span class="n">fit</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="5-monitoring-and-observability-stack">5. Monitoring and Observability Stack</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prometheus with IRSA for CloudWatch integration</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/PrometheusRole</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">prometheus.yml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">global:</span>
      <span class="s">scrape_interval: 15s</span>
      <span class="s">evaluation_interval: 15s</span>
    
    <span class="s">remote_write:</span>
    <span class="s">- url: https://aps-workspaces.us-west-2.amazonaws.com/workspaces/ws-12345/api/v1/remote_write</span>
      <span class="s">queue_config:</span>
        <span class="s">max_samples_per_send: 1000</span>
        <span class="s">max_shards: 200</span>
        <span class="s">capacity: 2500</span>
    <span class="no">    </span>
    <span class="s">scrape_configs:</span>
    <span class="s">- job_name: 'kubernetes-pods'</span>
      <span class="s">kubernetes_sd_configs:</span>
      <span class="s">- role: pod</span>
      <span class="s">relabel_configs:</span>
      <span class="s">- source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span>
        <span class="s">action: keep</span>
        <span class="s">regex: true</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="6-event-driven-architecture">6. Event-Driven Architecture</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># SQS Consumer with IRSA</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">event-processor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">events</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">event-processor</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">event-processor</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">event-processor-sa</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">processor</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">company/event-processor:v1.2.0</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SQS_QUEUE_URL</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://sqs.us-west-2.amazonaws.com/123456789012/event-queue</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DLQ_URL</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://sqs.us-west-2.amazonaws.com/123456789012/event-dlq</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MAX_MESSAGES</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">VISIBILITY_TIMEOUT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">300"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">256Mi</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">250m</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">512Mi</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="7-cost-optimization-patterns">7. Cost Optimization Patterns</h3>

<div class="info-box info-box-info-not-check">
  <strong>IRSA Cost Optimization Strategies</strong>
  <ul>
    <li><strong>Regional STS Endpoints:</strong> Reduce latency and data transfer costs</li>
    <li><strong>Credential Caching:</strong> Minimize STS API calls</li>
    <li><strong>Spot Instances:</strong> Use IRSA with Spot instances for batch workloads</li>
    <li><strong>Resource Tagging:</strong> Track costs by application and team using IRSA</li>
  </ul>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Cost-optimized IRSA configuration</span>
<span class="nb">export </span><span class="nv">AWS_STS_REGIONAL_ENDPOINTS</span><span class="o">=</span>regional
<span class="nb">export </span><span class="nv">AWS_SDK_LOAD_CONFIG</span><span class="o">=</span>1

<span class="c"># Enable credential caching</span>
<span class="nb">export </span><span class="nv">AWS_CREDENTIAL_CACHE_ENABLED</span><span class="o">=</span><span class="nb">true
export </span><span class="nv">AWS_CREDENTIAL_CACHE_MAX_ITEMS</span><span class="o">=</span>100
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="security-best-practices">Security Best Practices</h2>

<p><br /></p>

<h3 id="1-principle-of-least-privilege-implementation">1. Principle of Least Privilege Implementation</h3>

<div class="info-box info-box-default-not-check">
  <strong>Zero Trust Security Model</strong>
  <ul>
    <li><strong>Granular Permissions:</strong> Each ServiceAccount gets only required permissions</li>
    <li><strong>Resource-Level Access:</strong> Restrict access to specific S3 buckets, DynamoDB tables</li>
    <li><strong>Condition-Based Policies:</strong> Add time, IP, and encryption requirements</li>
    <li><strong>Regular Auditing:</strong> Continuously review and remove unused permissions</li>
  </ul>
</div>

<h4 id="advanced-iam-policy-examples">Advanced IAM Policy Examples</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RestrictedS3Access"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"s3:PutObject"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::company-data-${aws:PrincipalTag/Environment}/*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"s3:x-amz-server-side-encryption"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aws:kms"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"s3:x-amz-server-side-encryption-aws-kms-key-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:kms:us-west-2:123456789012:key/12345678-1234-1234-1234-123456789012"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"s3:x-amz-metadata-directive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"REPLACE"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T00:00:00Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-12-31T23:59:59Z"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DynamoDBTableAccess"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dynamodb:GetItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:PutItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:UpdateItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:DeleteItem"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dynamodb:Query"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:dynamodb:${aws:RequestedRegion}:${aws:userid}:table/${aws:PrincipalTag/Application}-*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ForAllValues:StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"dynamodb:Attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w"> </span><span class="s2">"data"</span><span class="p">,</span><span class="w"> </span><span class="s2">"metadata"</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"dynamodb:Select"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"ALL_ATTRIBUTES"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALL_PROJECTED_ATTRIBUTES"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h3 id="2-advanced-trust-policy-security">2. Advanced Trust Policy Security</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Federated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRoleWithWebIdentity"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:production:secure-app"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts.amazonaws.com"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:amr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"authenticated"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:TokenIssueTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T00:00:00Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"NumericLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:TokenAge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3600"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"IpAddress"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:SourceIp"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"10.0.0.0/8"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"172.16.0.0/12"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"192.168.0.0/16"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:SecureTransport"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h3 id="3-namespace-and-environment-isolation">3. Namespace and Environment Isolation</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Production namespace with strict security</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
    <span class="na">pod-security.kubernetes.io/enforce</span><span class="pi">:</span> <span class="s">restricted</span>
    <span class="na">pod-security.kubernetes.io/audit</span><span class="pi">:</span> <span class="s">restricted</span>
    <span class="na">pod-security.kubernetes.io/warn</span><span class="pi">:</span> <span class="s">restricted</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">scheduler.alpha.kubernetes.io/node-selector</span><span class="pi">:</span> <span class="s">environment=production</span>
<span class="nn">---</span>
<span class="c1"># Network policy for namespace isolation</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">production-isolation</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Ingress</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">production</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>  <span class="c1"># HTTPS to AWS APIs</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>   <span class="c1"># DNS</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>   <span class="c1"># DNS</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-monitoring-and-alerting">4. Monitoring and Alerting</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CloudWatch monitoring for IRSA</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">irsa-monitoring-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">cloudwatch-config.json</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">{</span>
      <span class="s">"agent": {</span>
        <span class="s">"metrics_collection_interval": 60,</span>
        <span class="s">"run_as_user": "cwagent"</span>
      <span class="s">},</span>
      <span class="s">"metrics": {</span>
        <span class="s">"namespace": "EKS/IRSA",</span>
        <span class="s">"metrics_collected": {</span>
          <span class="s">"cpu": {</span>
            <span class="s">"measurement": ["cpu_usage_idle", "cpu_usage_iowait"],</span>
            <span class="s">"metrics_collection_interval": 60</span>
          <span class="s">},</span>
          <span class="s">"disk": {</span>
            <span class="s">"measurement": ["used_percent"],</span>
            <span class="s">"metrics_collection_interval": 60,</span>
            <span class="s">"resources": ["*"]</span>
          <span class="s">},</span>
          <span class="s">"mem": {</span>
            <span class="s">"measurement": ["mem_used_percent"],</span>
            <span class="s">"metrics_collection_interval": 60</span>
          <span class="s">}</span>
        <span class="s">}</span>
      <span class="s">},</span>
      <span class="s">"logs": {</span>
        <span class="s">"logs_collected": {</span>
          <span class="s">"files": {</span>
            <span class="s">"collect_list": [</span>
              <span class="s">{</span>
                <span class="s">"file_path": "/var/log/containers/*irsa*.log",</span>
                <span class="s">"log_group_name": "/eks/irsa/applications",</span>
                <span class="s">"log_stream_name": "{instance_id}-{hostname}",</span>
                <span class="s">"timezone": "UTC"</span>
              <span class="s">}</span>
            <span class="s">]</span>
          <span class="s">}</span>
        <span class="s">}</span>
      <span class="s">}</span>
    <span class="s">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="5-security-scanning-and-compliance">5. Security Scanning and Compliance</h3>

<script src="https://gist.github.com/somaz94/a00d9a05bd174aee13cc95ceab9f3772.js"></script>

<p><br /></p>

<h3 id="6-incident-response-for-irsa">6. Incident Response for IRSA</h3>

<div class="info-box info-box-warning-not-check">
  <strong>IRSA Security Incident Response</strong>
  <ul>
    <li><strong>Immediate Actions:</strong> Disable compromised ServiceAccount, rotate OIDC provider thumbprints</li>
    <li><strong>Investigation:</strong> Analyze CloudTrail logs for unauthorized AssumeRoleWithWebIdentity calls</li>
    <li><strong>Containment:</strong> Update trust policies to restrict access, implement IP allowlists</li>
    <li><strong>Recovery:</strong> Create new IRSA roles, update applications, verify security controls</li>
  </ul>
</div>

<script src="https://gist.github.com/somaz94/9f4af3b482112a9896af2ceeda70e8e4.js"></script>

<p><br /></p>

<h3 id="7-compliance-and-governance">7. Compliance and Governance</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># OPA Gatekeeper policy for IRSA governance</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">templates.gatekeeper.sh/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConstraintTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">irsarequired</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">crd</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">names</span><span class="pi">:</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">IRSARequired</span>
      <span class="na">validation</span><span class="pi">:</span>
        <span class="na">openAPIV3Schema</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
          <span class="na">properties</span><span class="pi">:</span>
            <span class="na">exemptNamespaces</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">array</span>
              <span class="na">items</span><span class="pi">:</span>
                <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="na">targets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">admission.k8s.gatekeeper.sh</span>
      <span class="na">rego</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">package irsarequired</span>
        
        <span class="s">violation[{"msg": msg}] {</span>
          <span class="s">input.review.kind.kind == "Pod"</span>
          <span class="s">input.review.object.spec.serviceAccountName</span>
          <span class="s">not exempt_namespace</span>
          <span class="s">not has_irsa_annotation</span>
          <span class="s">msg := "Pod must use ServiceAccount with IRSA annotation"</span>
        <span class="s">}</span>
        
        <span class="s">has_irsa_annotation {</span>
          <span class="s">sa_name := input.review.object.spec.serviceAccountName</span>
          <span class="s">sa := data.inventory.namespace[input.review.object.metadata.namespace]["v1"]["ServiceAccount"][sa_name]</span>
          <span class="s">sa.metadata.annotations["eks.amazonaws.com/role-arn"]</span>
        <span class="s">}</span>
        
        <span class="s">exempt_namespace {</span>
          <span class="s">input.review.object.metadata.namespace == input.parameters.exemptNamespaces[_]</span>
        <span class="s">}</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">constraints.gatekeeper.sh/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IRSARequired</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">irsa-required-production</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">match</span><span class="pi">:</span>
    <span class="na">kinds</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
        <span class="na">kinds</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Pod"</span><span class="pi">]</span>
    <span class="na">namespaces</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">production"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">staging"</span><span class="pi">]</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">exemptNamespaces</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">kube-system"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">kube-public"</span><span class="pi">]</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="monitoring-and-operations">Monitoring and Operations</h2>

<p><br /></p>

<h3 id="1-comprehensive-cloudtrail-monitoring">1. Comprehensive CloudTrail Monitoring</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"eventVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.05"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"userIdentity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebIdentityUser"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"principalId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OIDC:system:serviceaccount:production:my-app"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:sts::123456789012:assumed-role/MyAppRole/eks-cluster-system-serviceaccount-production-my-app"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"accountId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"userName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:production:my-app"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"eventTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-15T10:30:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"eventSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3.amazonaws.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"eventName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GetObject"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"awsRegion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sourceIPAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.1.100"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"accountId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::S3::Object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ARN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::my-data-bucket/data/file.json"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="cloudtrail-query-examples">CloudTrail Query Examples</h4>

<script src="https://gist.github.com/somaz94/4d6bed4c4bee2ecc881018a4278ad4e7.js"></script>

<p><br /></p>

<h3 id="2-prometheus-metrics-for-irsa">2. Prometheus Metrics for IRSA</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ServiceMonitor for IRSA metrics</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceMonitor</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">irsa-metrics</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">irsa-exporter</span>
  <span class="na">endpoints</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">metrics</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">30s</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/metrics</span>
<span class="nn">---</span>
<span class="c1"># Custom IRSA exporter deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">irsa-exporter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">irsa-exporter</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">irsa-exporter</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">irsa-monitoring-sa</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">exporter</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">company/irsa-exporter:v1.0.0</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CLUSTER_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">production-eks</span>
</code></pre></div></div>

<h4 id="key-irsa-metrics-to-monitor">Key IRSA Metrics to Monitor</h4>

<div class="language-prometheus highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Token refresh rate</span>
<span class="nb">rate</span><span class="p">(</span><span class="n">aws_sdk_token_refresh_total</span><span class="p">[</span><span class="mi">5m</span><span class="p">])</span>

<span class="c"># STS API call success rate</span>
<span class="nb">rate</span><span class="p">(</span><span class="n">aws_sts_assume_role_success_total</span><span class="p">[</span><span class="mi">5m</span><span class="p">])</span> <span class="o">/</span> <span class="nb">rate</span><span class="p">(</span><span class="n">aws_sts_assume_role_total</span><span class="p">[</span><span class="mi">5m</span><span class="p">])</span>

<span class="c"># Token expiration warnings</span>
<span class="n">aws_sdk_token_expiry_seconds</span> <span class="o">&lt;</span> <span class="mi">300</span>

<span class="c"># Failed authentication attempts</span>
<span class="nb">rate</span><span class="p">(</span><span class="n">aws_sts_assume_role_failed_total</span><span class="p">[</span><span class="mi">5m</span><span class="p">])</span>

<span class="c"># Regional endpoint usage</span>
<span class="n">aws_sts_regional_endpoint_usage_total</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-alerting-rules">3. Alerting Rules</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prometheus alerting rules for IRSA</span>
<span class="na">groups</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">irsa-alerts</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">IRSAHighTokenRefreshRate</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">rate(aws_sdk_token_refresh_total[5m]) &gt; </span><span class="m">0.1</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">5m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">High</span><span class="nv"> </span><span class="s">IRSA</span><span class="nv"> </span><span class="s">token</span><span class="nv"> </span><span class="s">refresh</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">detected"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Pod</span><span class="nv">  </span><span class="s">in</span><span class="nv"> </span><span class="s">namespace</span><span class="nv">  </span><span class="s">is</span><span class="nv"> </span><span class="s">refreshing</span><span class="nv"> </span><span class="s">tokens</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">frequently"</span>

  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">IRSAAuthenticationFailures</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">rate(aws_sts_assume_role_failed_total[5m]) &gt; </span><span class="m">0.01</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">2m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">IRSA</span><span class="nv"> </span><span class="s">authentication</span><span class="nv"> </span><span class="s">failures</span><span class="nv"> </span><span class="s">detected"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ServiceAccount</span><span class="nv">  </span><span class="s">failing</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">authenticate</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">AWS</span><span class="nv"> </span><span class="s">STS"</span>

  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">IRSATokenNearExpiry</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">aws_sdk_token_expiry_seconds &lt; </span><span class="m">300</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">1m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">IRSA</span><span class="nv"> </span><span class="s">token</span><span class="nv"> </span><span class="s">approaching</span><span class="nv"> </span><span class="s">expiry"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Token</span><span class="nv"> </span><span class="s">for</span><span class="nv">  </span><span class="s">expires</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">less</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes"</span>

  <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">IRSAUnauthorizedAccess</span>
    <span class="na">expr</span><span class="pi">:</span> <span class="s">increase(aws_api_unauthorized_total[5m]) &gt; </span><span class="m">0</span>
    <span class="na">for</span><span class="pi">:</span> <span class="s">0m</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">summary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Unauthorized</span><span class="nv"> </span><span class="s">AWS</span><span class="nv"> </span><span class="s">API</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">detected"</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Pod</span><span class="nv">  </span><span class="s">attempted</span><span class="nv"> </span><span class="s">unauthorized</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">"</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-operational-dashboards">4. Operational Dashboards</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dashboard"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IRSA Operations Dashboard"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"panels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IRSA Token Refresh Rate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"graph"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rate(aws_sdk_token_refresh_total[5m])"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"legendFormat"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"STS API Success Rate"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stat"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rate(aws_sts_assume_role_success_total[5m]) / rate(aws_sts_assume_role_total[5m]) * 100"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS API Latency by Service"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"heatmap"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"histogram_quantile(0.95, rate(aws_api_duration_seconds_bucket[5m]))"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h3 id="5-automated-health-checks">5. Automated Health Checks</h3>

<script src="https://gist.github.com/somaz94/2d08c7702bd32a75c1c09f5aa54fc0eb.js"></script>

<p><br /></p>

<hr />

<h2 id="troubleshooting-guide">Troubleshooting Guide</h2>

<p><br /></p>

<h3 id="common-issues-and-solutions">Common Issues and Solutions</h3>

<div class="info-box info-box-warning-not-check">
  <strong>Top IRSA Issues</strong>
  <ul>
    <li><strong>Token Projection Failures:</strong> Missing webhook or incorrect ServiceAccount</li>
    <li><strong>Trust Policy Mismatches:</strong> Incorrect namespace/ServiceAccount in conditions</li>
    <li><strong>OIDC Provider Issues:</strong> Missing or misconfigured OIDC provider</li>
    <li><strong>Network Connectivity:</strong> Blocked access to AWS STS endpoints</li>
    <li><strong>Clock Skew:</strong> Time synchronization issues affecting token validation</li>
  </ul>
</div>

<p><br /></p>

<h3 id="1-authentication-failures">1. Authentication Failures</h3>

<h4 id="issue-an-error-occurred-accessdenied-when-calling-the-assumerolewithwebidentity-operation">Issue: “An error occurred (AccessDenied) when calling the AssumeRoleWithWebIdentity operation”</h4>

<script src="https://gist.github.com/somaz94/b6bafc4c2a6b67587fa7a3197529b91e.js"></script>

<h4 id="solution-fix-trust-policy">Solution: Fix Trust Policy</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Federated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRoleWithWebIdentity"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID:sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:serviceaccount:CORRECT-NAMESPACE:CORRECT-SERVICE-ACCOUNT"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID:aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts.amazonaws.com"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h3 id="2-token-projection-issues">2. Token Projection Issues</h3>

<h4 id="issue-unable-to-load-aws-credentials">Issue: “Unable to load AWS credentials”</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Debug token projection</span>
kubectl <span class="nb">exec</span> <span class="nt">-it</span> my-pod <span class="nt">-n</span> production <span class="nt">--</span> /bin/bash

<span class="c"># Check if token directory exists</span>
<span class="nb">ls</span> <span class="nt">-la</span> /var/run/secrets/eks.amazonaws.com/serviceaccount/

<span class="c"># If missing, check ServiceAccount</span>
kubectl get serviceaccount my-app-sa <span class="nt">-n</span> production <span class="nt">-o</span> yaml

<span class="c"># Check if automountServiceAccountToken is enabled</span>
kubectl get serviceaccount my-app-sa <span class="nt">-n</span> production <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.automountServiceAccountToken}'</span>

<span class="c"># Check pod specification</span>
kubectl get pod my-pod <span class="nt">-n</span> production <span class="nt">-o</span> yaml | <span class="nb">grep</span> <span class="nt">-A</span> 10 <span class="nt">-B</span> 10 serviceAccount
</code></pre></div></div>

<h4 id="solution-enable-token-projection">Solution: Enable Token Projection</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fix ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-app-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">eks.amazonaws.com/role-arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::123456789012:role/MyAppRole</span>
<span class="na">automountServiceAccountToken</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># Must be true for IRSA</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-network-connectivity-issues">3. Network Connectivity Issues</h3>

<h4 id="issue-unable-to-retrieve-credentials-from-sts">Issue: “Unable to retrieve credentials from STS”</h4>

<script src="https://gist.github.com/somaz94/c9ecbaded63a11dcbb0cf78e97a90c58.js"></script>

<h4 id="solution-configure-network-access">Solution: Configure Network Access</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ensure network policies allow HTTPS egress</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">allow-aws-apis</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Egress</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">to</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-clock-skew-issues">4. Clock Skew Issues</h3>

<h4 id="issue-token-has-expired">Issue: “Token has expired”</h4>

<script src="https://gist.github.com/somaz94/075bad873ffdf3befb0d2215eda75e1d.js"></script>

<h4 id="solution-fix-time-synchronization">Solution: Fix Time Synchronization</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Add NTP sidecar if needed</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">time-sync</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">ubuntu:20.04</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">sh'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">-c'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">apt-get</span><span class="nv"> </span><span class="s">update</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">apt-get</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">-y</span><span class="nv"> </span><span class="s">ntpdate</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">ntpdate</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">time.nist.gov'</span><span class="pi">]</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-app:latest</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="5-advanced-debugging-tools">5. Advanced Debugging Tools</h3>

<script src="https://gist.github.com/somaz94/bbb7c2d7ea55740cceeff94957a85d11.js"></script>

<p><br /></p>

<h3 id="6-performance-troubleshooting">6. Performance Troubleshooting</h3>

<script src="https://gist.github.com/somaz94/d8baf9345e4dce80803b8452f0474adf.js"></script>

<p><br /></p>

<hr />

<h2 id="migration-strategies">Migration Strategies</h2>

<p><br /></p>

<h3 id="1-from-ec2-instance-profiles-to-irsa">1. From EC2 Instance Profiles to IRSA</h3>

<div class="info-box info-box-default-not-check">
  <strong>Migration Phases</strong>
  <ol>
    <li><strong>Assessment:</strong> Audit current permissions and applications</li>
    <li><strong>Planning:</strong> Design IRSA roles with least privilege</li>
    <li><strong>Parallel Deployment:</strong> Run both systems temporarily</li>
    <li><strong>Gradual Migration:</strong> Move applications one by one</li>
    <li><strong>Verification:</strong> Ensure functionality and security</li>
    <li><strong>Cleanup:</strong> Remove old instance profile permissions</li>
  </ol>
</div>

<script src="https://gist.github.com/somaz94/8d9a2a54b851ca287232bb716219a5d7.js"></script>

<h4 id="migration-plan-template">Migration Plan Template</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Phase 1: Create IRSA roles with same permissions</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">migration-plan</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">migration</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">phase1.sh</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#!/bin/bash</span>
    <span class="s"># Create IRSA role with current instance profile permissions</span>
    <span class="s">CURRENT_POLICIES=$(aws iam list-attached-role-policies --role-name NodeInstanceRole --query 'AttachedPolicies[].PolicyArn' --output text)</span>
    
    <span class="s">for policy in $CURRENT_POLICIES; do</span>
      <span class="s">aws iam attach-role-policy --role-name NewIRSARole --policy-arn $policy</span>
    <span class="s">done</span>

  <span class="na">phase2.sh</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#!/bin/bash</span>
    <span class="s"># Deploy applications with IRSA (parallel to existing)</span>
    <span class="s">kubectl apply -f irsa-serviceaccount.yaml</span>
    <span class="s">kubectl apply -f irsa-deployment.yaml</span>

  <span class="na">phase3.sh</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#!/bin/bash</span>
    <span class="s"># Switch traffic to IRSA-enabled applications</span>
    <span class="s">kubectl patch service my-app -p '{"spec":{"selector":{"version":"irsa"}}}'</span>

  <span class="na">phase4.sh</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#!/bin/bash</span>
    <span class="s"># Remove old deployments</span>
    <span class="s">kubectl delete deployment my-app-legacy</span>
    
  <span class="na">phase5.sh</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#!/bin/bash</span>
    <span class="s"># Optimize IRSA role permissions (least privilege)</span>
    <span class="s">aws iam detach-role-policy --role-name NewIRSARole --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess</span>
    <span class="s">aws iam attach-role-policy --role-name NewIRSARole --policy-arn arn:aws:iam::123456789012:policy/S3SpecificBucketAccess</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-from-hardcoded-credentials-to-irsa">2. From Hardcoded Credentials to IRSA</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Before: Hardcoded credentials (Anti-pattern)</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">legacy-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-app:legacy</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_ACCESS_KEY_ID</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">aws-credentials</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">access-key-id</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_SECRET_ACCESS_KEY</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">aws-credentials</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">secret-access-key</span>

<span class="nn">---</span>
<span class="c1"># After: IRSA (Recommended)</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">modern-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">app-service-account</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-app:modern</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-west-2</span>
        <span class="c1"># No AWS credentials needed!</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-blue-green-irsa-migration">3. Blue-Green IRSA Migration</h3>

<script src="https://gist.github.com/somaz94/29eb487472bd9b70b51501abb3f03fb6.js"></script>

<p><br /></p>

<hr />

<h2 id="performance-optimization">Performance Optimization</h2>

<p><br /></p>

<h3 id="1-regional-sts-endpoints">1. Regional STS Endpoints</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Configure regional STS endpoints for better performance</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">production</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[default]</span>
    <span class="s">region = us-west-2</span>
    <span class="s">sts_regional_endpoints = regional</span>
    <span class="s">max_attempts = 3</span>
    <span class="s">retry_mode = adaptive</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">optimized-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">my-app:optimized</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_CONFIG_FILE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/aws-config/config</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_STS_REGIONAL_ENDPOINTS</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">regional</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_RETRY_MODE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">adaptive</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AWS_MAX_ATTEMPTS</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/aws-config</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws-config</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">aws-config</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-credential-caching-optimization">2. Credential Caching Optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Python application with optimized credential caching
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">botocore.credentials</span> <span class="kn">import</span> <span class="n">InstanceMetadataProvider</span><span class="p">,</span> <span class="n">AssumeRoleWithWebIdentityProvider</span>
<span class="kn">from</span> <span class="nn">botocore.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">OptimizedCredentialProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Configure session with optimized settings
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
        
        <span class="c1"># Enable credential caching
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get_component</span><span class="p">(</span><span class="s">'credential_provider'</span><span class="p">).</span><span class="n">insert_before</span><span class="p">(</span>
            <span class="s">'env'</span><span class="p">,</span>
            <span class="n">AssumeRoleWithWebIdentityProvider</span><span class="p">(</span>
                <span class="n">load_config</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">full_config</span><span class="p">,</span>
                <span class="n">client_creator</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_create_sts_client</span><span class="p">,</span>
                <span class="n">cache</span><span class="o">=</span><span class="p">{},</span>  <span class="c1"># Enable caching
</span>                <span class="n">expire_window_seconds</span><span class="o">=</span><span class="mi">300</span>  <span class="c1"># Refresh 5 minutes before expiry
</span>            <span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_create_sts_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Use regional STS endpoints for better performance
</span>        <span class="k">return</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s">'sts'</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span> <span class="ow">or</span> <span class="s">'us-west-2'</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">boto3</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">Config</span><span class="p">(</span>
                <span class="n">retries</span><span class="o">=</span><span class="p">{</span><span class="s">'max_attempts'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'mode'</span><span class="p">:</span> <span class="s">'adaptive'</span><span class="p">},</span>
                <span class="n">max_pool_connections</span><span class="o">=</span><span class="mi">50</span>
            <span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1"># Usage
</span><span class="n">provider</span> <span class="o">=</span> <span class="n">OptimizedCredentialProvider</span><span class="p">()</span>
<span class="n">s3_client</span> <span class="o">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">get_client</span><span class="p">(</span><span class="s">'s3'</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-connection-pooling-and-retries">3. Connection Pooling and Retries</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Go application with optimized AWS client configuration</span>
<span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"context"</span>
    <span class="s">"time"</span>
    
    <span class="s">"github.com/aws/aws-sdk-go-v2/config"</span>
    <span class="s">"github.com/aws/aws-sdk-go-v2/service/s3"</span>
    <span class="s">"github.com/aws/aws-sdk-go-v2/feature/rds/auth"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Load config with optimizations</span>
    <span class="n">cfg</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">config</span><span class="o">.</span><span class="n">LoadDefaultConfig</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">TODO</span><span class="p">(),</span>
        <span class="n">config</span><span class="o">.</span><span class="n">WithRegion</span><span class="p">(</span><span class="s">"us-west-2"</span><span class="p">),</span>
        <span class="n">config</span><span class="o">.</span><span class="n">WithRetryMaxAttempts</span><span class="p">(</span><span class="m">3</span><span class="p">),</span>
        <span class="n">config</span><span class="o">.</span><span class="n">WithRetryMode</span><span class="p">(</span><span class="n">aws</span><span class="o">.</span><span class="n">RetryModeAdaptive</span><span class="p">),</span>
        <span class="n">config</span><span class="o">.</span><span class="n">WithHTTPClient</span><span class="p">(</span><span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span>
            <span class="n">Timeout</span><span class="o">:</span> <span class="m">30</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
            <span class="n">Transport</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Transport</span><span class="p">{</span>
                <span class="n">MaxIdleConns</span><span class="o">:</span>        <span class="m">100</span><span class="p">,</span>
                <span class="n">MaxIdleConnsPerHost</span><span class="o">:</span> <span class="m">10</span><span class="p">,</span>
                <span class="n">IdleConnTimeout</span><span class="o">:</span>     <span class="m">30</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}),</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c">// Create S3 client with config</span>
    <span class="n">s3Client</span> <span class="o">:=</span> <span class="n">s3</span><span class="o">.</span><span class="n">NewFromConfig</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    
    <span class="c">// Use client...</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-monitoring-performance-metrics">4. Monitoring Performance Metrics</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Performance monitoring dashboard</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">performance-dashboard</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">dashboard.json</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">{</span>
      <span class="s">"dashboard": {</span>
        <span class="s">"title": "IRSA Performance Metrics",</span>
        <span class="s">"panels": [</span>
          <span class="s">{</span>
            <span class="s">"title": "STS Token Exchange Latency",</span>
            <span class="s">"targets": [</span>
              <span class="s">{</span>
                <span class="s">"expr": "histogram_quantile(0.95, rate(aws_sts_assume_role_duration_seconds_bucket[5m]))",</span>
                <span class="s">"legendFormat": "95th percentile"</span>
              <span class="s">},</span>
              <span class="s">{</span>
                <span class="s">"expr": "histogram_quantile(0.50, rate(aws_sts_assume_role_duration_seconds_bucket[5m]))",</span>
                <span class="s">"legendFormat": "50th percentile"</span>
              <span class="s">}</span>
            <span class="s">]</span>
          <span class="s">},</span>
          <span class="s">{</span>
            <span class="s">"title": "Credential Cache Hit Rate",</span>
            <span class="s">"targets": [</span>
              <span class="s">{</span>
                <span class="s">"expr": "rate(aws_credential_cache_hits_total[5m]) / rate(aws_credential_requests_total[5m]) * 100"</span>
              <span class="s">}</span>
            <span class="s">]</span>
          <span class="s">},</span>
          <span class="s">{</span>
            <span class="s">"title": "Regional vs Global STS Usage",</span>
            <span class="s">"targets": [</span>
              <span class="s">{</span>
                <span class="s">"expr": "rate(aws_sts_regional_calls_total[5m])",</span>
                <span class="s">"legendFormat": "Regional"</span>
              <span class="s">},</span>
              <span class="s">{</span>
                <span class="s">"expr": "rate(aws_sts_global_calls_total[5m])",</span>
                <span class="s">"legendFormat": "Global"</span>
              <span class="s">}</span>
            <span class="s">]</span>
          <span class="s">}</span>
        <span class="s">]</span>
      <span class="s">}</span>
    <span class="s">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="5-load-testing-irsa">5. Load Testing IRSA</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># IRSA load testing script</span>

<span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">"load-test"</span>
<span class="nv">REPLICAS</span><span class="o">=</span>100
<span class="nv">DURATION</span><span class="o">=</span><span class="s2">"300s"</span>

<span class="nb">echo</span> <span class="s2">"Starting IRSA load test with </span><span class="nv">$REPLICAS</span><span class="s2"> replicas for </span><span class="nv">$DURATION</span><span class="s2">..."</span>

<span class="c"># Create load test namespace</span>
kubectl create namespace <span class="nv">$NAMESPACE</span> <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml | kubectl apply <span class="nt">-f</span> -

<span class="c"># Deploy load test ServiceAccount</span>
kubectl apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ServiceAccount
metadata:
  name: load-test-sa
  namespace: </span><span class="nv">$NAMESPACE</span><span class="sh">
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/LoadTestRole
</span><span class="no">EOF

</span><span class="c"># Deploy load test application</span>
kubectl apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: irsa-load-test
  namespace: </span><span class="nv">$NAMESPACE</span><span class="sh">
spec:
  replicas: </span><span class="nv">$REPLICAS</span><span class="sh">
  selector:
    matchLabels:
      app: load-test
  template:
    metadata:
      labels:
        app: load-test
    spec:
      serviceAccountName: load-test-sa
      containers:
      - name: load-generator
        image: amazon/aws-cli:latest
        command: ['sh', '-c']
        args:
        - |
          while true; do
            aws sts get-caller-identity &gt; /dev/null
            aws s3 ls &gt; /dev/null
            sleep 1
          done
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m
</span><span class="no">EOF

</span><span class="c"># Wait for deployment</span>
kubectl <span class="nb">wait</span> <span class="nt">--for</span><span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Available deployment/irsa-load-test <span class="nt">-n</span> <span class="nv">$NAMESPACE</span> <span class="nt">--timeout</span><span class="o">=</span>300s

<span class="nb">echo</span> <span class="s2">"Load test running for </span><span class="nv">$DURATION</span><span class="s2">..."</span>
<span class="nb">sleep</span> <span class="si">$(</span><span class="nb">echo</span> <span class="nv">$DURATION</span> | <span class="nb">sed</span> <span class="s1">'s/s//'</span><span class="si">)</span>

<span class="c"># Collect metrics</span>
<span class="nb">echo</span> <span class="s2">"Collecting performance metrics..."</span>
kubectl top pods <span class="nt">-n</span> <span class="nv">$NAMESPACE</span>

<span class="c"># Cleanup</span>
<span class="nb">echo</span> <span class="s2">"Cleaning up load test..."</span>
kubectl delete namespace <span class="nv">$NAMESPACE</span>

<span class="nb">echo</span> <span class="s2">"Load test complete!"</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="references-and-additional-resources">References and Additional Resources</h2>

<h3 id="official-aws-documentation">Official AWS Documentation</h3>
<ul>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">AWS IRSA User Guide</a></li>
  <li><a href="https://aws.github.io/aws-eks-best-practices/security/docs/iam/">EKS Best Practices - Security</a></li>
  <li><a href="https://docs.aws.amazon.com/STS/latest/APIReference/">AWS STS API Reference</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html">OpenID Connect in AWS IAM</a></li>
</ul>

<h3 id="aws-blog-posts-and-whitepapers">AWS Blog Posts and Whitepapers</h3>
<ul>
  <li><a href="https://aws.amazon.com/blogs/containers/diving-into-iam-roles-for-service-accounts/">Diving into IAM Roles for Service Accounts</a></li>
  <li><a href="https://aws.amazon.com/blogs/containers/amazon-eks-security-best-practices/">Amazon EKS Security Best Practices</a></li>
  <li><a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">Fine-grained IAM roles for service accounts</a></li>
</ul>

<h3 id="tools-and-utilities">Tools and Utilities</h3>
<ul>
  <li><a href="https://eksctl.io/">eksctl</a> - CLI tool for creating EKS clusters with IRSA support</li>
  <li><a href="https://aws.amazon.com/cli/">AWS CLI v2</a> - Enhanced IRSA credential support</li>
  <li><a href="https://external-secrets.io/">Kubernetes External Secrets</a> - Alternative secrets management</li>
  <li><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest">IRSA Terraform Modules</a></li>
</ul>

<h3 id="security-and-compliance">Security and Compliance</h3>
<ul>
  <li><a href="https://www.cisecurity.org/benchmark/kubernetes">CIS Amazon EKS Benchmark</a></li>
  <li><a href="https://www.nist.gov/cyberframework">NIST Cybersecurity Framework</a></li>
  <li><a href="https://aws.amazon.com/compliance/soc/">SOC 2 Compliance with IRSA</a></li>
</ul>

<h3 id="monitoring-and-observability">Monitoring and Observability</h3>
<ul>
  <li><a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html">AWS CloudTrail for IRSA</a></li>
  <li><a href="https://prometheus-operator.dev/">Prometheus Operator</a></li>
  <li><a href="https://grafana.com/grafana/dashboards/13770">Grafana Dashboard Examples</a></li>
</ul>

<h3 id="community-resources">Community Resources</h3>
<ul>
  <li><a href="https://github.com/aws/containers-roadmap">AWS Containers Roadmap</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">CNCF Kubernetes Documentation</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/security/">Kubernetes Security Best Practices</a></li>
</ul>

<h3 id="sample-code-and-examples">Sample Code and Examples</h3>
<ul>
  <li><a href="https://github.com/aws-samples/amazon-eks-irsa-sample">AWS Samples - IRSA Examples</a></li>
  <li><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/tree/master/examples">Terraform AWS EKS Examples</a></li>
  <li><a href="https://github.com/kubernetes/examples">Kubernetes Examples</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/storage/understanding-ceph-distributed-storage-architecture/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755077387/ceph-1_xm8avx.png">
                                    
                                    <h3>Understanding Ceph: Comprehensive Guide to Distributed Storage Architecture</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/openstack/openstack-manila/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1756180452/openstack-manila-1_qxm1na.png">
                                    
                                    <h3>Deep Dive into OpenStack Manila</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/troubleshooting/terraform-state-debugging/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1745823546/terraform-error_duccgn.png">
                                    
                                    <h3>Complete Terraform State Management Troubleshooting Guide</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="53">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/aws/aws-secrets-manager/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1738576381/aws-secretmanager_seysrh.png">
                
            </div>
            <h3 class="title">AWS Secrets Manager - Secure Secret Management Service</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Complete guide to AWS IRSA implementation, from basic concepts to enterprise-grade security patterns and operational best practices&quot;%20https://somaz.blog/category/aws/aws-irsa/%20via%20&#64;twitter_username&hashtags=aws,kubernetes,eks,security,irsa,oidc,sts,iam,enterprise,devops"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/aws/aws-irsa/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/aws/aws-irsa/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "AWS IRSA (IAM Roles for Service Accounts) - Complete Enterprise Guide",
            "headline": "Master secure AWS service access in EKS with advanced IRSA implementation patterns",
            "description": "Complete guide to AWS IRSA implementation, from basic concepts to enterprise-grade security patterns and operational best practices",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1738570911/aws-irsa_bnkgqv.png",
            "url": "https://somaz.blog/category/aws/aws-irsa/",
            "articleBody": "



Table of Contents

  Overview
  The Problem with Traditional Approaches
  Core Components Deep Dive
  IRSA Workflow and Architecture
  Implementation Guide
  Advanced Configuration Patterns
  Enterprise Use Cases
  Security Best Practices
  Monitoring and Operations
  Troubleshooting Guide
  Migration Strategies
  Performance Optimization






Overview

AWS IAM Roles for Service Accounts (IRSA) revolutionizes how Kubernetes workloads securely access AWS services.

By leveraging OpenID Connect (OIDC) and AWS Security Token Service (STS), IRSA eliminates the need for long-lived credentials while providing fine-grained, pod-level access control.




  Why IRSA Matters
  
    Zero Trust Security: No long-lived credentials stored in clusters
    Granular Permissions: Pod-level access control with least privilege
    Kubernetes Native: Seamless integration with ServiceAccounts
    Audit Trail: Complete visibility into AWS API calls
    Operational Simplicity: Automatic credential rotation and management
  






The Problem with Traditional Approaches



1. EC2 Instance Profiles - The Overprivileged Problem

Before IRSA, the most common approach was using EC2 instance profiles, which grants the same permissions to all pods on a node.

# All pods inherit the same permissions
aws sts get-caller-identity
# Returns the same role for every pod on the node


Critical Issues:

  Blast Radius: Single compromised pod can access all permissions
  Compliance Violations: Impossible to implement least privilege
  Audit Complexity: Cannot trace specific pod actions
  Scale Limitations: Cannot support multi-tenant workloads




2. Embedded Credentials - The Security Nightmare

# Anti-pattern: Never do this
env:
- name: AWS_ACCESS_KEY_ID
  value: &quot;AKIAIOSFODNN7EXAMPLE&quot;
- name: AWS_SECRET_ACCESS_KEY
  value: &quot;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&quot;


Security Risks:

  Credential Leakage: Visible in process lists, logs, and configs
  No Rotation: Manual rotation process prone to human error
  Git Exposure: Risk of committing credentials to version control
  Container Registry Exposure: Credentials baked into images




3. External Secret Management - The Complexity Trap

# Complex initialization process
initContainers:
- name: secret-fetcher
  image: vault:latest
  command: [&apos;sh&apos;, &apos;-c&apos;, &apos;vault auth &amp;amp;&amp;amp; vault kv get -field=aws_key secret/myapp&apos;]




Operational Overhead:

  Bootstrap Problem: Still need initial credentials
  Dependency Chain: Multiple points of failure
  Latency Impact: Additional API calls at startup
  Complexity: Multiple systems to maintain and monitor




IRSA: The Elegant Solution


  How IRSA Solves These Problems
  
    Automatic Credential Provisioning: AWS SDK automatically discovers and uses IRSA credentials
    Temporary Credentials: Short-lived tokens that auto-rotate
    Pod-Level Isolation: Each ServiceAccount maps to specific IAM role
    Zero Configuration: No credential management in application code
    Full Auditability: CloudTrail tracks every API call with pod identity
  




What is AWS IRSA?

AWS IRSA is a sophisticated identity federation mechanism that bridges Kubernetes ServiceAccounts with AWS IAM roles. It uses industry-standard protocols (OIDC) to establish trust between your EKS cluster and AWS IAM, enabling secure, temporary credential exchange without storing any long-lived secrets.





Core Components Deep Dive


  IRSA Architecture Components
  
    Kubernetes ServiceAccounts: Identity primitive for pods
    AWS IAM Roles: Permission container with trust policies
    OpenID Connect (OIDC) Provider: Identity federation bridge
    Security Token Service (STS): Temporary credential issuer
    EKS Pod Identity Webhook: Automatic credential injection
    AWS SDK: Automatic credential discovery and rotation
  




OpenID Connect (OIDC) - The Trust Foundation

OpenID Connect serves as the cornerstone of IRSA’s security model, establishing cryptographically verifiable trust between EKS and AWS IAM.

Technical Deep Dive

{
  &quot;iss&quot;: &quot;https://oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E&quot;,
  &quot;aud&quot;: &quot;sts.amazonaws.com&quot;,
  &quot;sub&quot;: &quot;system:serviceaccount:namespace:service-account-name&quot;,
  &quot;iat&quot;: 1516239022,
  &quot;exp&quot;: 1516242622,
  &quot;kubernetes.io&quot;: {
    &quot;namespace&quot;: &quot;production&quot;,
    &quot;serviceaccount&quot;: {
      &quot;name&quot;: &quot;my-service-account&quot;,
      &quot;uid&quot;: &quot;12345678-1234-1234-1234-123456789012&quot;
    },
    &quot;pod&quot;: {
      &quot;name&quot;: &quot;my-pod-12345&quot;,
      &quot;uid&quot;: &quot;87654321-4321-4321-4321-210987654321&quot;
    }
  }
}


Key OIDC Features for IRSA:

  Cryptographic Signatures: JWT tokens are signed with rotating keys
  Audience Validation: Ensures tokens are intended for AWS STS
  Subject Identity: Maps to specific Kubernetes ServiceAccount
  Expiration Control: Configurable token lifetime (default: 1 hour)


OIDC Provider Setup and Verification







Kubernetes ServiceAccounts - Identity Primitives

ServiceAccounts in Kubernetes serve as the identity foundation for IRSA, providing a secure mechanism to associate AWS IAM roles with specific pods.

Advanced ServiceAccount Configuration

apiVersion: v1
kind: ServiceAccount
metadata:
  name: advanced-service-account
  namespace: production
  annotations:
    # Primary IRSA annotation
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/MyAppRole
    
    # Optional: Specify audience (default: sts.amazonaws.com)
    eks.amazonaws.com/audience: sts.amazonaws.com
    
    # Optional: Custom token expiration (default: 86400 seconds)
    eks.amazonaws.com/token-expiration: &quot;3600&quot;
    
    # Optional: STS regional endpoints
    eks.amazonaws.com/sts-regional-endpoints: &quot;true&quot;
  labels:
    app: my-application
    tier: backend
    security.policy: irsa-enabled
---
# Role binding for Kubernetes RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: production
  name: serviceaccount-reader
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;serviceaccounts&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-serviceaccounts
  namespace: production
subjects:
- kind: ServiceAccount
  name: advanced-service-account
  namespace: production
roleRef:
  kind: Role
  name: serviceaccount-reader
  apiGroup: rbac.authorization.k8s.io


ServiceAccount Best Practices


  ServiceAccount Security Guidelines
  
    Namespace Isolation: Use dedicated namespaces for different environments
    Naming Convention: Include app name and environment in ServiceAccount names
    Automount Control: Disable automounting when not needed
    RBAC Integration: Combine with Kubernetes RBAC for defense in depth
  


# Example: Disable automatic token mounting
apiVersion: v1
kind: ServiceAccount
metadata:
  name: no-auto-mount-sa
  namespace: production
automountServiceAccountToken: false  # Disable if not needed




AWS Security Token Service (STS) - Credential Engine

STS acts as the credential engine in IRSA, issuing temporary, automatically rotating credentials based on OIDC token validation.

STS Token Exchange Flow



Advanced STS Configuration

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:sub&quot;: &quot;system:serviceaccount:production:my-service-account&quot;,
          &quot;oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:aud&quot;: &quot;sts.amazonaws.com&quot;
        },
        &quot;StringLike&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:amr&quot;: &quot;authenticated&quot;
        },
        &quot;DateGreaterThan&quot;: {
          &quot;aws:TokenIssueTime&quot;: &quot;2024-01-01T00:00:00Z&quot;
        },
        &quot;NumericLessThan&quot;: {
          &quot;aws:TokenAge&quot;: &quot;86400&quot;
        }
      }
    }
  ]
}


Advanced Trust Policy Features:

  Time-based Conditions: Restrict token age and issue time
  Session Constraints: Limit session duration and permissions
  Source IP Restrictions: Geographic or network-based access control
  MFA Requirements: Require multi-factor authentication for sensitive roles






IRSA Workflow and Architecture



Complete End-to-End Workflow

The IRSA workflow involves multiple components working together to provide seamless, secure access to AWS services. Here’s the detailed step-by-step process:


  IRSA Token Exchange Flow
  
    Pod Startup: EKS Pod Identity Webhook injects OIDC token
    Token Projection: Kubernetes mounts projected token volume
    AWS SDK Discovery: AWS SDK automatically discovers IRSA credentials
    STS Token Exchange: SDK calls AssumeRoleWithWebIdentity
    OIDC Validation: STS validates JWT with OIDC provider
    Trust Policy Check: IAM evaluates trust relationships
    Temporary Credentials: STS issues short-lived credentials
    AWS API Calls: Pod uses temporary credentials for AWS services
    Automatic Renewal: SDK handles credential refresh transparently
  




Detailed Architecture Diagram Analysis

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   EKS Cluster   │    │   AWS IAM/STS    │    │  AWS Services   │
│                 │    │                  │    │                 │
│  ┌───────────┐  │    │  ┌─────────────┐ │    │  ┌───────────┐  │
│  │    Pod    │  │    │  │     STS     │ │    │  │    S3     │  │
│  │           │  │    │  │             │ │    │  │           │  │
│  │  AWS SDK  │  │◄──►│  │AssumeRole   │ │    │  │  Buckets  │  │
│  │           │  │    │  │WithWebID    │ │    │  │           │  │
│  └─────┬─────┘  │    │  └─────────────┘ │    │  └───────────┘  │
│        │        │    │         │        │    │         │       │
│  ┌─────▼─────┐  │    │  ┌──────▼──────┐ │    │  ┌──────▼────┐  │
│  │ServiceAcc │  │    │  │ OIDC Provider│ │    │  │ DynamoDB  │  │
│  │ + Role    │  │    │  │ Validation   │ │    │  │   Tables  │  │
│  │Annotation │  │    │  └─────────────┘ │    │  └───────────┘  │
│  └───────────┘  │    │         │        │    │         │       │
│        │        │    │  ┌──────▼──────┐ │    │  ┌──────▼────┐  │
│  ┌─────▼─────┐  │    │  │  IAM Role   │ │    │  │    SQS    │  │
│  │ OIDC JWT  │  │    │  │Trust Policy │ │    │  │   Queues  │  │
│  │  Token    │  │    │  └─────────────┘ │    │  └───────────┘  │
│  └───────────┘  │    └──────────────────┘    └─────────────────┘
└─────────────────┘




Real-World Example: S3 Access Workflow

Let’s walk through a practical example where a pod needs to access S3:

# 1. ServiceAccount with IRSA configuration
apiVersion: v1
kind: ServiceAccount
metadata:
  name: s3-processor
  namespace: data-pipeline
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/S3ProcessorRole


# 2. Application code (Python with boto3)
import boto3
import os

def process_s3_files():
    # AWS SDK automatically discovers IRSA credentials
    # No explicit credential configuration needed!
    s3_client = boto3.client(&apos;s3&apos;)
    
    try:
        # List objects in bucket
        response = s3_client.list_objects_v2(Bucket=&apos;my-data-bucket&apos;)
        
        for obj in response.get(&apos;Contents&apos;, []):
            print(f&quot;Processing file: {obj[&apos;Key&apos;]}&quot;)
            
            # Download and process file
            s3_client.download_file(
                &apos;my-data-bucket&apos;, 
                obj[&apos;Key&apos;], 
                f&quot;/tmp/{obj[&apos;Key&apos;]}&quot;
            )
            
    except ClientError as e:
        print(f&quot;Error accessing S3: {e}&quot;)

if __name__ == &quot;__main__&quot;:
    process_s3_files()


# 3. Pod deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: s3-processor
  namespace: data-pipeline
spec:
  replicas: 3
  selector:
    matchLabels:
      app: s3-processor
  template:
    metadata:
      labels:
        app: s3-processor
    spec:
      serviceAccountName: s3-processor  # Links to IRSA-enabled ServiceAccount
      containers:
      - name: processor
        image: my-company/s3-processor:v1.0.0
        env:
        - name: AWS_REGION
          value: us-west-2
        # No AWS credentials needed - IRSA handles automatically!
        resources:
          requests:
            memory: &quot;256Mi&quot;
            cpu: &quot;250m&quot;
          limits:
            memory: &quot;512Mi&quot;
            cpu: &quot;500m&quot;




Behind the Scenes: Credential Discovery

# Inside the pod, AWS SDK follows this credential discovery chain:
# 1. Environment variables (AWS_ACCESS_KEY_ID, etc.) - Empty
# 2. AWS credentials file (~/.aws/credentials) - Not present
# 3. IAM instance profile - Not applicable in containers
# 4. Web Identity Token (IRSA) - Found and used!

# The projected token is mounted at:
ls -la /var/run/secrets/eks.amazonaws.com/serviceaccount/
# token  # JWT token for OIDC authentication

# AWS SDK reads this token and makes STS call:
cat /var/run/secrets/eks.amazonaws.com/serviceaccount/token
# eyJhbGciOiJSUzI1NiIsImtpZCI6... (JWT token)




Credential Lifecycle Management


  Automatic Credential Lifecycle
  
    Token Issuance: Kubernetes issues JWT with 1-hour expiration
    STS Exchange: AWS SDK exchanges JWT for temporary credentials
    Credential Caching: SDK caches credentials until near expiration
    Automatic Refresh: SDK automatically refreshes before expiration
    Graceful Fallback: Retry logic handles temporary failures
  




Security Validation Points

The IRSA workflow includes multiple security validation checkpoints:


  Kubernetes API Server Validation:
    
      Validates ServiceAccount exists
      Checks RBAC permissions
      Verifies pod is authorized to use ServiceAccount
    
  
  OIDC Token Validation:
    
      Cryptographic signature verification
      Audience claim validation (sts.amazonaws.com)
      Subject claim validation (namespace:serviceaccount)
      Token expiration check
    
  
  IAM Trust Policy Evaluation:
    
      Federated identity verification
      Condition evaluation (StringEquals, StringLike, etc.)
      Principal validation
    
  
  STS Token Issuance:
    
      Temporary credential generation
      Session policy application
      Permission boundary enforcement
    
  






Implementation Guide



Prerequisites and Environment Setup

Before implementing IRSA, ensure your environment meets these requirements:


  Prerequisites Checklist
  
    EKS Version: 1.13+ (recommended: 1.21+)
    AWS CLI: Version 2.0+ with appropriate permissions
    kubectl: Compatible with your EKS version
    eksctl: Latest version (optional but recommended)
    IAM Permissions: iam:CreateRole, iam:CreateOpenIDConnectProvider
  




Step 1: OIDC Provider Setup (Advanced)









Step 2: Advanced IAM Role Creation









Step 3: Advanced ServiceAccount Configuration

# advanced-serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: s3-processor
  namespace: data-pipeline
  annotations:
    # Required: IAM role ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/S3ProcessorRole
    
    # Optional: Specify audience (default: sts.amazonaws.com)
    eks.amazonaws.com/audience: sts.amazonaws.com
    
    # Optional: Token expiration (default: 86400 seconds)
    eks.amazonaws.com/token-expiration: &quot;3600&quot;
    
    # Optional: STS regional endpoints for better performance
    eks.amazonaws.com/sts-regional-endpoints: &quot;true&quot;
    
    # Metadata for operational purposes
    description: &quot;ServiceAccount for S3 data processing workloads&quot;
    owner: &quot;data-platform-team&quot;
    cost-center: &quot;engineering&quot;
  labels:
    app.kubernetes.io/name: s3-processor
    app.kubernetes.io/component: data-pipeline
    app.kubernetes.io/part-of: analytics-platform
    security.policy/irsa: &quot;enabled&quot;
    compliance.level: &quot;high&quot;
automountServiceAccountToken: true  # Required for IRSA
---
# Create namespace if it doesn&apos;t exist
apiVersion: v1
kind: Namespace
metadata:
  name: data-pipeline
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
---
# RBAC configuration
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: data-pipeline
  name: s3-processor-role
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;secrets&quot;, &quot;configmaps&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;]
- apiGroups: [&quot;&quot;]
  resources: [&quot;events&quot;]
  verbs: [&quot;create&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: s3-processor-binding
  namespace: data-pipeline
subjects:
- kind: ServiceAccount
  name: s3-processor
  namespace: data-pipeline
roleRef:
  kind: Role
  name: s3-processor-role
  apiGroup: rbac.authorization.k8s.io




Step 4: Production-Ready Deployment

# production-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: s3-processor
  namespace: data-pipeline
  labels:
    app: s3-processor
    version: v1.0.0
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: s3-processor
  template:
    metadata:
      labels:
        app: s3-processor
        version: v1.0.0
      annotations:
        prometheus.io/scrape: &quot;true&quot;
        prometheus.io/port: &quot;8080&quot;
        prometheus.io/path: &quot;/metrics&quot;
    spec:
      serviceAccountName: s3-processor
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
      - name: processor
        image: my-company/s3-processor:v1.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: metrics
        env:
        - name: AWS_REGION
          value: us-west-2
        - name: AWS_DEFAULT_REGION
          value: us-west-2
        # Enable STS regional endpoints for better performance
        - name: AWS_STS_REGIONAL_ENDPOINTS
          value: regional
        # Optional: Enable AWS SDK debug logging
        - name: AWS_SDK_LOAD_CONFIG
          value: &quot;1&quot;
        # Application-specific configuration
        - name: S3_BUCKET_NAME
          value: my-data-bucket
        - name: PROCESSING_CONCURRENCY
          value: &quot;10&quot;
        resources:
          requests:
            memory: &quot;512Mi&quot;
            cpu: &quot;250m&quot;
          limits:
            memory: &quot;1Gi&quot;
            cpu: &quot;500m&quot;
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
      volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - s3-processor
              topologyKey: kubernetes.io/hostname




Step 5: Verification and Testing







Advanced Configuration Patterns



Multi-Tenant IRSA Setup

For organizations running multiple teams or applications in shared EKS clusters:

# Namespace-based isolation
apiVersion: v1
kind: Namespace
metadata:
  name: team-alpha
  labels:
    team: alpha
    environment: production
---
apiVersion: v1
kind: Namespace
metadata:
  name: team-beta
  labels:
    team: beta
    environment: production
---
# Team Alpha ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service-account
  namespace: team-alpha
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/TeamAlphaAppRole
---
# Team Beta ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service-account
  namespace: team-beta
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/TeamBetaAppRole


Cross-Account IRSA Configuration

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::ACCOUNT-A:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:sub&quot;: &quot;system:serviceaccount:production:cross-account-service&quot;
        }
      }
    },
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;AWS&quot;: &quot;arn:aws:iam::ACCOUNT-A:role/CrossAccountRole&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;sts:ExternalId&quot;: &quot;unique-external-id-12345&quot;
        }
      }
    }
  ]
}




Environment-Specific Configurations

# Environment-specific role naming convention
ENVIRONMENT=&quot;production&quot;  # or staging, development
APPLICATION=&quot;data-processor&quot;
ROLE_NAME=&quot;${ENVIRONMENT}-${APPLICATION}-role&quot;

# Create environment-specific trust policies
cat &amp;gt; ${ENVIRONMENT}-trust-policy.json &amp;lt;&amp;lt; EOF
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.${REGION}.amazonaws.com/id/${OIDC_ID}&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;oidc.eks.${REGION}.amazonaws.com/id/${OIDC_ID}:sub&quot;: &quot;system:serviceaccount:${ENVIRONMENT}:${APPLICATION}&quot;,
          &quot;oidc.eks.${REGION}.amazonaws.com/id/${OIDC_ID}:aud&quot;: &quot;sts.amazonaws.com&quot;
        },
        &quot;StringLike&quot;: {
          &quot;oidc.eks.${REGION}.amazonaws.com/id/${OIDC_ID}:amr&quot;: &quot;authenticated&quot;
        }
      }
    }
  ]
}
EOF






Enterprise Use Cases



1. Data Pipeline Architecture

# Real-world data processing pipeline with IRSA
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: data-pipeline
  namespace: data-platform
spec:
  serviceAccountName: data-pipeline-sa
  entrypoint: process-data
  templates:
  - name: process-data
    dag:
      tasks:
      - name: extract
        template: s3-extractor
      - name: transform
        template: data-transformer
        dependencies: [extract]
      - name: load
        template: rds-loader
        dependencies: [transform]
  
  - name: s3-extractor
    container:
      image: data-platform/extractor:v2.1.0
      env:
      - name: AWS_REGION
        value: us-west-2
      - name: SOURCE_BUCKET
        value: raw-data-bucket
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 1000m




2. Microservices with Different AWS Permissions


  Microservices IRSA Pattern
  
    User Service: DynamoDB read/write, Cognito access
    Order Service: SQS/SNS, RDS access, S3 receipts
    Payment Service: Secrets Manager, KMS encryption
    Notification Service: SES, SNS publishing
    Analytics Service: Kinesis, S3 data lake, Athena
  


# User Service - DynamoDB focused
apiVersion: v1
kind: ServiceAccount
metadata:
  name: user-service-sa
  namespace: microservices
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/UserServiceRole
---
# Order Service - Multiple services
apiVersion: v1
kind: ServiceAccount
metadata:
  name: order-service-sa
  namespace: microservices
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/OrderServiceRole
---
# Payment Service - High security requirements
apiVersion: v1
kind: ServiceAccount
metadata:
  name: payment-service-sa
  namespace: microservices
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/PaymentServiceRole
    # Additional security constraints
    eks.amazonaws.com/token-expiration: &quot;900&quot;  # 15 minutes




3. CI/CD Pipeline Integration

# GitLab CI/CD with IRSA for deployment
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab-runner-sa
  namespace: gitlab-system
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/GitLabRunnerRole
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-runner
  namespace: gitlab-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: gitlab-runner
  template:
    metadata:
      labels:
        app: gitlab-runner
    spec:
      serviceAccountName: gitlab-runner-sa
      containers:
      - name: gitlab-runner
        image: gitlab/gitlab-runner:latest
        env:
        - name: AWS_REGION
          value: us-west-2
        # Can now push to ECR, deploy to EKS, update CloudFormation
        volumeMounts:
        - name: docker-sock
          mountPath: /var/run/docker.sock
      volumes:
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock




4. Machine Learning Workloads

# ML training job with IRSA
import boto3
import sagemaker
from sagemaker.pytorch import PyTorch

# AWS SDK automatically uses IRSA credentials
sagemaker_session = sagemaker.Session()
role = sagemaker.get_execution_role()  # Uses IRSA role

# Define training job
estimator = PyTorch(
    entry_point=&apos;train.py&apos;,
    source_dir=&apos;src&apos;,
    role=role,  # IRSA-provided role
    instance_type=&apos;ml.p3.2xlarge&apos;,
    instance_count=1,
    framework_version=&apos;1.8.0&apos;,
    py_version=&apos;py38&apos;,
    hyperparameters={
        &apos;epochs&apos;: 10,
        &apos;batch-size&apos;: 32,
        &apos;learning-rate&apos;: 0.001
    },
    # Data stored in S3 (accessible via IRSA)
    inputs={
        &apos;training&apos;: &apos;s3://ml-data-bucket/train/&apos;,
        &apos;validation&apos;: &apos;s3://ml-data-bucket/val/&apos;
    },
    # Model output to S3
    output_path=&apos;s3://ml-models-bucket/experiments/&apos;,
    
    # Use Spot instances with IRSA for cost optimization
    use_spot_instances=True,
    max_wait=7200,
    max_run=3600
)

# Start training
estimator.fit()




5. Monitoring and Observability Stack

# Prometheus with IRSA for CloudWatch integration
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-sa
  namespace: monitoring
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/PrometheusRole
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    remote_write:
    - url: https://aps-workspaces.us-west-2.amazonaws.com/workspaces/ws-12345/api/v1/remote_write
      queue_config:
        max_samples_per_send: 1000
        max_shards: 200
        capacity: 2500
        
    scrape_configs:
    - job_name: &apos;kubernetes-pods&apos;
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true




6. Event-Driven Architecture

# SQS Consumer with IRSA
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-processor
  namespace: events
spec:
  replicas: 5
  selector:
    matchLabels:
      app: event-processor
  template:
    metadata:
      labels:
        app: event-processor
    spec:
      serviceAccountName: event-processor-sa
      containers:
      - name: processor
        image: company/event-processor:v1.2.0
        env:
        - name: AWS_REGION
          value: us-west-2
        - name: SQS_QUEUE_URL
          value: https://sqs.us-west-2.amazonaws.com/123456789012/event-queue
        - name: DLQ_URL
          value: https://sqs.us-west-2.amazonaws.com/123456789012/event-dlq
        - name: MAX_MESSAGES
          value: &quot;10&quot;
        - name: VISIBILITY_TIMEOUT
          value: &quot;300&quot;
        resources:
          requests:
            memory: 256Mi
            cpu: 250m
          limits:
            memory: 512Mi
            cpu: 500m
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          periodSeconds: 30




7. Cost Optimization Patterns


  IRSA Cost Optimization Strategies
  
    Regional STS Endpoints: Reduce latency and data transfer costs
    Credential Caching: Minimize STS API calls
    Spot Instances: Use IRSA with Spot instances for batch workloads
    Resource Tagging: Track costs by application and team using IRSA
  


# Cost-optimized IRSA configuration
export AWS_STS_REGIONAL_ENDPOINTS=regional
export AWS_SDK_LOAD_CONFIG=1

# Enable credential caching
export AWS_CREDENTIAL_CACHE_ENABLED=true
export AWS_CREDENTIAL_CACHE_MAX_ITEMS=100






Security Best Practices



1. Principle of Least Privilege Implementation


  Zero Trust Security Model
  
    Granular Permissions: Each ServiceAccount gets only required permissions
    Resource-Level Access: Restrict access to specific S3 buckets, DynamoDB tables
    Condition-Based Policies: Add time, IP, and encryption requirements
    Regular Auditing: Continuously review and remove unused permissions
  


Advanced IAM Policy Examples

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;RestrictedS3Access&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;s3:GetObject&quot;,
        &quot;s3:PutObject&quot;
      ],
      &quot;Resource&quot;: &quot;arn:aws:s3:::company-data-${aws:PrincipalTag/Environment}/*&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;s3:x-amz-server-side-encryption&quot;: &quot;aws:kms&quot;,
          &quot;s3:x-amz-server-side-encryption-aws-kms-key-id&quot;: &quot;arn:aws:kms:us-west-2:123456789012:key/12345678-1234-1234-1234-123456789012&quot;
        },
        &quot;StringLike&quot;: {
          &quot;s3:x-amz-metadata-directive&quot;: &quot;REPLACE&quot;
        },
        &quot;DateGreaterThan&quot;: {
          &quot;aws:CurrentTime&quot;: &quot;2024-01-01T00:00:00Z&quot;
        },
        &quot;DateLessThan&quot;: {
          &quot;aws:CurrentTime&quot;: &quot;2025-12-31T23:59:59Z&quot;
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;DynamoDBTableAccess&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;dynamodb:GetItem&quot;,
        &quot;dynamodb:PutItem&quot;,
        &quot;dynamodb:UpdateItem&quot;,
        &quot;dynamodb:DeleteItem&quot;,
        &quot;dynamodb:Query&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:dynamodb:${aws:RequestedRegion}:${aws:userid}:table/${aws:PrincipalTag/Application}-*&quot;
      ],
      &quot;Condition&quot;: {
        &quot;ForAllValues:StringEquals&quot;: {
          &quot;dynamodb:Attributes&quot;: [&quot;id&quot;, &quot;timestamp&quot;, &quot;data&quot;, &quot;metadata&quot;]
        },
        &quot;StringEquals&quot;: {
          &quot;dynamodb:Select&quot;: [&quot;ALL_ATTRIBUTES&quot;, &quot;ALL_PROJECTED_ATTRIBUTES&quot;]
        }
      }
    }
  ]
}




2. Advanced Trust Policy Security

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:sub&quot;: &quot;system:serviceaccount:production:secure-app&quot;,
          &quot;oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:aud&quot;: &quot;sts.amazonaws.com&quot;
        },
        &quot;StringLike&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/OIDC-ID:amr&quot;: &quot;authenticated&quot;
        },
        &quot;DateGreaterThan&quot;: {
          &quot;aws:TokenIssueTime&quot;: &quot;2024-01-01T00:00:00Z&quot;
        },
        &quot;NumericLessThan&quot;: {
          &quot;aws:TokenAge&quot;: &quot;3600&quot;
        },
        &quot;IpAddress&quot;: {
          &quot;aws:SourceIp&quot;: [
            &quot;10.0.0.0/8&quot;,
            &quot;172.16.0.0/12&quot;,
            &quot;192.168.0.0/16&quot;
          ]
        },
        &quot;StringEquals&quot;: {
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;, &quot;us-east-1&quot;]
        },
        &quot;Bool&quot;: {
          &quot;aws:SecureTransport&quot;: &quot;true&quot;
        }
      }
    }
  ]
}




3. Namespace and Environment Isolation

# Production namespace with strict security
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    environment: production
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
  annotations:
    scheduler.alpha.kubernetes.io/node-selector: environment=production
---
# Network policy for namespace isolation
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: production-isolation
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          environment: production
  - to: []
    ports:
    - protocol: TCP
      port: 443  # HTTPS to AWS APIs
    - protocol: TCP
      port: 53   # DNS
    - protocol: UDP
      port: 53   # DNS




4. Monitoring and Alerting

# CloudWatch monitoring for IRSA
apiVersion: v1
kind: ConfigMap
metadata:
  name: irsa-monitoring-config
  namespace: monitoring
data:
  cloudwatch-config.json: |
    {
      &quot;agent&quot;: {
        &quot;metrics_collection_interval&quot;: 60,
        &quot;run_as_user&quot;: &quot;cwagent&quot;
      },
      &quot;metrics&quot;: {
        &quot;namespace&quot;: &quot;EKS/IRSA&quot;,
        &quot;metrics_collected&quot;: {
          &quot;cpu&quot;: {
            &quot;measurement&quot;: [&quot;cpu_usage_idle&quot;, &quot;cpu_usage_iowait&quot;],
            &quot;metrics_collection_interval&quot;: 60
          },
          &quot;disk&quot;: {
            &quot;measurement&quot;: [&quot;used_percent&quot;],
            &quot;metrics_collection_interval&quot;: 60,
            &quot;resources&quot;: [&quot;*&quot;]
          },
          &quot;mem&quot;: {
            &quot;measurement&quot;: [&quot;mem_used_percent&quot;],
            &quot;metrics_collection_interval&quot;: 60
          }
        }
      },
      &quot;logs&quot;: {
        &quot;logs_collected&quot;: {
          &quot;files&quot;: {
            &quot;collect_list&quot;: [
              {
                &quot;file_path&quot;: &quot;/var/log/containers/*irsa*.log&quot;,
                &quot;log_group_name&quot;: &quot;/eks/irsa/applications&quot;,
                &quot;log_stream_name&quot;: &quot;{instance_id}-{hostname}&quot;,
                &quot;timezone&quot;: &quot;UTC&quot;
              }
            ]
          }
        }
      }
    }




5. Security Scanning and Compliance





6. Incident Response for IRSA


  IRSA Security Incident Response
  
    Immediate Actions: Disable compromised ServiceAccount, rotate OIDC provider thumbprints
    Investigation: Analyze CloudTrail logs for unauthorized AssumeRoleWithWebIdentity calls
    Containment: Update trust policies to restrict access, implement IP allowlists
    Recovery: Create new IRSA roles, update applications, verify security controls
  






7. Compliance and Governance

# OPA Gatekeeper policy for IRSA governance
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: irsarequired
spec:
  crd:
    spec:
      names:
        kind: IRSARequired
      validation:
        openAPIV3Schema:
          type: object
          properties:
            exemptNamespaces:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package irsarequired
        
        violation[{&quot;msg&quot;: msg}] {
          input.review.kind.kind == &quot;Pod&quot;
          input.review.object.spec.serviceAccountName
          not exempt_namespace
          not has_irsa_annotation
          msg := &quot;Pod must use ServiceAccount with IRSA annotation&quot;
        }
        
        has_irsa_annotation {
          sa_name := input.review.object.spec.serviceAccountName
          sa := data.inventory.namespace[input.review.object.metadata.namespace][&quot;v1&quot;][&quot;ServiceAccount&quot;][sa_name]
          sa.metadata.annotations[&quot;eks.amazonaws.com/role-arn&quot;]
        }
        
        exempt_namespace {
          input.review.object.metadata.namespace == input.parameters.exemptNamespaces[_]
        }
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: IRSARequired
metadata:
  name: irsa-required-production
spec:
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    namespaces: [&quot;production&quot;, &quot;staging&quot;]
  parameters:
    exemptNamespaces: [&quot;kube-system&quot;, &quot;kube-public&quot;]






Monitoring and Operations



1. Comprehensive CloudTrail Monitoring

{
  &quot;eventVersion&quot;: &quot;1.05&quot;,
  &quot;userIdentity&quot;: {
    &quot;type&quot;: &quot;WebIdentityUser&quot;,
    &quot;principalId&quot;: &quot;OIDC:system:serviceaccount:production:my-app&quot;,
    &quot;arn&quot;: &quot;arn:aws:sts::123456789012:assumed-role/MyAppRole/eks-cluster-system-serviceaccount-production-my-app&quot;,
    &quot;accountId&quot;: &quot;123456789012&quot;,
    &quot;userName&quot;: &quot;system:serviceaccount:production:my-app&quot;
  },
  &quot;eventTime&quot;: &quot;2024-01-15T10:30:00Z&quot;,
  &quot;eventSource&quot;: &quot;s3.amazonaws.com&quot;,
  &quot;eventName&quot;: &quot;GetObject&quot;,
  &quot;awsRegion&quot;: &quot;us-west-2&quot;,
  &quot;sourceIPAddress&quot;: &quot;10.0.1.100&quot;,
  &quot;resources&quot;: [{
    &quot;accountId&quot;: &quot;123456789012&quot;,
    &quot;type&quot;: &quot;AWS::S3::Object&quot;,
    &quot;ARN&quot;: &quot;arn:aws:s3:::my-data-bucket/data/file.json&quot;
  }]
}


CloudTrail Query Examples





2. Prometheus Metrics for IRSA

# ServiceMonitor for IRSA metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: irsa-metrics
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: irsa-exporter
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
---
# Custom IRSA exporter deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: irsa-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: irsa-exporter
  template:
    metadata:
      labels:
        app: irsa-exporter
    spec:
      serviceAccountName: irsa-monitoring-sa
      containers:
      - name: exporter
        image: company/irsa-exporter:v1.0.0
        ports:
        - containerPort: 8080
          name: metrics
        env:
        - name: AWS_REGION
          value: us-west-2
        - name: CLUSTER_NAME
          value: production-eks


Key IRSA Metrics to Monitor

# Token refresh rate
rate(aws_sdk_token_refresh_total[5m])

# STS API call success rate
rate(aws_sts_assume_role_success_total[5m]) / rate(aws_sts_assume_role_total[5m])

# Token expiration warnings
aws_sdk_token_expiry_seconds &amp;lt; 300

# Failed authentication attempts
rate(aws_sts_assume_role_failed_total[5m])

# Regional endpoint usage
aws_sts_regional_endpoint_usage_total




3. Alerting Rules

# Prometheus alerting rules for IRSA
groups:
- name: irsa-alerts
  rules:
  - alert: IRSAHighTokenRefreshRate
    expr: rate(aws_sdk_token_refresh_total[5m]) &amp;gt; 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;High IRSA token refresh rate detected&quot;
      description: &quot;Pod  in namespace  is refreshing tokens too frequently&quot;

  - alert: IRSAAuthenticationFailures
    expr: rate(aws_sts_assume_role_failed_total[5m]) &amp;gt; 0.01
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: &quot;IRSA authentication failures detected&quot;
      description: &quot;ServiceAccount  failing to authenticate with AWS STS&quot;

  - alert: IRSATokenNearExpiry
    expr: aws_sdk_token_expiry_seconds &amp;lt; 300
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: &quot;IRSA token approaching expiry&quot;
      description: &quot;Token for  expires in less than 5 minutes&quot;

  - alert: IRSAUnauthorizedAccess
    expr: increase(aws_api_unauthorized_total[5m]) &amp;gt; 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: &quot;Unauthorized AWS API access detected&quot;
      description: &quot;Pod  attempted unauthorized access to &quot;




4. Operational Dashboards

{
  &quot;dashboard&quot;: {
    &quot;title&quot;: &quot;IRSA Operations Dashboard&quot;,
    &quot;panels&quot;: [
      {
        &quot;title&quot;: &quot;IRSA Token Refresh Rate&quot;,
        &quot;type&quot;: &quot;graph&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;rate(aws_sdk_token_refresh_total[5m])&quot;,
            &quot;legendFormat&quot;: &quot;/&quot;
          }
        ]
      },
      {
        &quot;title&quot;: &quot;STS API Success Rate&quot;,
        &quot;type&quot;: &quot;stat&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;rate(aws_sts_assume_role_success_total[5m]) / rate(aws_sts_assume_role_total[5m]) * 100&quot;
          }
        ]
      },
      {
        &quot;title&quot;: &quot;AWS API Latency by Service&quot;,
        &quot;type&quot;: &quot;heatmap&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;histogram_quantile(0.95, rate(aws_api_duration_seconds_bucket[5m]))&quot;
          }
        ]
      }
    ]
  }
}




5. Automated Health Checks







Troubleshooting Guide



Common Issues and Solutions


  Top IRSA Issues
  
    Token Projection Failures: Missing webhook or incorrect ServiceAccount
    Trust Policy Mismatches: Incorrect namespace/ServiceAccount in conditions
    OIDC Provider Issues: Missing or misconfigured OIDC provider
    Network Connectivity: Blocked access to AWS STS endpoints
    Clock Skew: Time synchronization issues affecting token validation
  




1. Authentication Failures

Issue: “An error occurred (AccessDenied) when calling the AssumeRoleWithWebIdentity operation”



Solution: Fix Trust Policy

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID:sub&quot;: &quot;system:serviceaccount:CORRECT-NAMESPACE:CORRECT-SERVICE-ACCOUNT&quot;,
          &quot;oidc.eks.us-west-2.amazonaws.com/id/CORRECT-OIDC-ID:aud&quot;: &quot;sts.amazonaws.com&quot;
        }
      }
    }
  ]
}




2. Token Projection Issues

Issue: “Unable to load AWS credentials”

# Debug token projection
kubectl exec -it my-pod -n production -- /bin/bash

# Check if token directory exists
ls -la /var/run/secrets/eks.amazonaws.com/serviceaccount/

# If missing, check ServiceAccount
kubectl get serviceaccount my-app-sa -n production -o yaml

# Check if automountServiceAccountToken is enabled
kubectl get serviceaccount my-app-sa -n production -o jsonpath=&apos;{.automountServiceAccountToken}&apos;

# Check pod specification
kubectl get pod my-pod -n production -o yaml | grep -A 10 -B 10 serviceAccount


Solution: Enable Token Projection

# Fix ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-app-sa
  namespace: production
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/MyAppRole
automountServiceAccountToken: true  # Must be true for IRSA




3. Network Connectivity Issues

Issue: “Unable to retrieve credentials from STS”



Solution: Configure Network Access

# Ensure network policies allow HTTPS egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-aws-apis
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53




4. Clock Skew Issues

Issue: “Token has expired”



Solution: Fix Time Synchronization

# Add NTP sidecar if needed
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  template:
    spec:
      initContainers:
      - name: time-sync
        image: ubuntu:20.04
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;apt-get update &amp;amp;&amp;amp; apt-get install -y ntpdate &amp;amp;&amp;amp; ntpdate -s time.nist.gov&apos;]
        securityContext:
          privileged: true
      containers:
      - name: app
        image: my-app:latest




5. Advanced Debugging Tools





6. Performance Troubleshooting







Migration Strategies



1. From EC2 Instance Profiles to IRSA


  Migration Phases
  
    Assessment: Audit current permissions and applications
    Planning: Design IRSA roles with least privilege
    Parallel Deployment: Run both systems temporarily
    Gradual Migration: Move applications one by one
    Verification: Ensure functionality and security
    Cleanup: Remove old instance profile permissions
  




Migration Plan Template

# Phase 1: Create IRSA roles with same permissions
apiVersion: v1
kind: ConfigMap
metadata:
  name: migration-plan
  namespace: migration
data:
  phase1.sh: |
    #!/bin/bash
    # Create IRSA role with current instance profile permissions
    CURRENT_POLICIES=$(aws iam list-attached-role-policies --role-name NodeInstanceRole --query &apos;AttachedPolicies[].PolicyArn&apos; --output text)
    
    for policy in $CURRENT_POLICIES; do
      aws iam attach-role-policy --role-name NewIRSARole --policy-arn $policy
    done

  phase2.sh: |
    #!/bin/bash
    # Deploy applications with IRSA (parallel to existing)
    kubectl apply -f irsa-serviceaccount.yaml
    kubectl apply -f irsa-deployment.yaml

  phase3.sh: |
    #!/bin/bash
    # Switch traffic to IRSA-enabled applications
    kubectl patch service my-app -p &apos;{&quot;spec&quot;:{&quot;selector&quot;:{&quot;version&quot;:&quot;irsa&quot;}}}&apos;

  phase4.sh: |
    #!/bin/bash
    # Remove old deployments
    kubectl delete deployment my-app-legacy
    
  phase5.sh: |
    #!/bin/bash
    # Optimize IRSA role permissions (least privilege)
    aws iam detach-role-policy --role-name NewIRSARole --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
    aws iam attach-role-policy --role-name NewIRSARole --policy-arn arn:aws:iam::123456789012:policy/S3SpecificBucketAccess




2. From Hardcoded Credentials to IRSA

# Before: Hardcoded credentials (Anti-pattern)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: legacy-app
spec:
  template:
    spec:
      containers:
      - name: app
        image: my-app:legacy
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: access-key-id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secret-access-key

---
# After: IRSA (Recommended)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: modern-app
spec:
  template:
    spec:
      serviceAccountName: app-service-account
      containers:
      - name: app
        image: my-app:modern
        env:
        - name: AWS_REGION
          value: us-west-2
        # No AWS credentials needed!




3. Blue-Green IRSA Migration







Performance Optimization



1. Regional STS Endpoints

# Configure regional STS endpoints for better performance
apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-config
  namespace: production
data:
  config: |
    [default]
    region = us-west-2
    sts_regional_endpoints = regional
    max_attempts = 3
    retry_mode = adaptive
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: optimized-app
spec:
  template:
    spec:
      containers:
      - name: app
        image: my-app:optimized
        env:
        - name: AWS_CONFIG_FILE
          value: /aws-config/config
        - name: AWS_STS_REGIONAL_ENDPOINTS
          value: regional
        - name: AWS_RETRY_MODE
          value: adaptive
        - name: AWS_MAX_ATTEMPTS
          value: &quot;3&quot;
        volumeMounts:
        - name: aws-config
          mountPath: /aws-config
      volumes:
      - name: aws-config
        configMap:
          name: aws-config




2. Credential Caching Optimization

# Python application with optimized credential caching
import boto3
from botocore.credentials import InstanceMetadataProvider, AssumeRoleWithWebIdentityProvider
from botocore.session import Session

class OptimizedCredentialProvider:
    def __init__(self):
        # Configure session with optimized settings
        self.session = Session()
        
        # Enable credential caching
        self.session.get_component(&apos;credential_provider&apos;).insert_before(
            &apos;env&apos;,
            AssumeRoleWithWebIdentityProvider(
                load_config=lambda: self.session.full_config,
                client_creator=self._create_sts_client,
                cache={},  # Enable caching
                expire_window_seconds=300  # Refresh 5 minutes before expiry
            )
        )
    
    def _create_sts_client(self, region_name=None, **kwargs):
        # Use regional STS endpoints for better performance
        return boto3.client(
            &apos;sts&apos;,
            region_name=region_name or &apos;us-west-2&apos;,
            config=boto3.session.Config(
                retries={&apos;max_attempts&apos;: 3, &apos;mode&apos;: &apos;adaptive&apos;},
                max_pool_connections=50
            )
        )
    
    def get_client(self, service_name, **kwargs):
        return self.session.create_client(service_name, **kwargs)

# Usage
provider = OptimizedCredentialProvider()
s3_client = provider.get_client(&apos;s3&apos;)




3. Connection Pooling and Retries

// Go application with optimized AWS client configuration
package main

import (
    &quot;context&quot;
    &quot;time&quot;
    
    &quot;github.com/aws/aws-sdk-go-v2/config&quot;
    &quot;github.com/aws/aws-sdk-go-v2/service/s3&quot;
    &quot;github.com/aws/aws-sdk-go-v2/feature/rds/auth&quot;
)

func main() {
    // Load config with optimizations
    cfg, err := config.LoadDefaultConfig(context.TODO(),
        config.WithRegion(&quot;us-west-2&quot;),
        config.WithRetryMaxAttempts(3),
        config.WithRetryMode(aws.RetryModeAdaptive),
        config.WithHTTPClient(&amp;amp;http.Client{
            Timeout: 30 * time.Second,
            Transport: &amp;amp;http.Transport{
                MaxIdleConns:        100,
                MaxIdleConnsPerHost: 10,
                IdleConnTimeout:     30 * time.Second,
            },
        }),
    )
    
    if err != nil {
        log.Fatal(err)
    }
    
    // Create S3 client with config
    s3Client := s3.NewFromConfig(cfg)
    
    // Use client...
}




4. Monitoring Performance Metrics

# Performance monitoring dashboard
apiVersion: v1
kind: ConfigMap
metadata:
  name: performance-dashboard
data:
  dashboard.json: |
    {
      &quot;dashboard&quot;: {
        &quot;title&quot;: &quot;IRSA Performance Metrics&quot;,
        &quot;panels&quot;: [
          {
            &quot;title&quot;: &quot;STS Token Exchange Latency&quot;,
            &quot;targets&quot;: [
              {
                &quot;expr&quot;: &quot;histogram_quantile(0.95, rate(aws_sts_assume_role_duration_seconds_bucket[5m]))&quot;,
                &quot;legendFormat&quot;: &quot;95th percentile&quot;
              },
              {
                &quot;expr&quot;: &quot;histogram_quantile(0.50, rate(aws_sts_assume_role_duration_seconds_bucket[5m]))&quot;,
                &quot;legendFormat&quot;: &quot;50th percentile&quot;
              }
            ]
          },
          {
            &quot;title&quot;: &quot;Credential Cache Hit Rate&quot;,
            &quot;targets&quot;: [
              {
                &quot;expr&quot;: &quot;rate(aws_credential_cache_hits_total[5m]) / rate(aws_credential_requests_total[5m]) * 100&quot;
              }
            ]
          },
          {
            &quot;title&quot;: &quot;Regional vs Global STS Usage&quot;,
            &quot;targets&quot;: [
              {
                &quot;expr&quot;: &quot;rate(aws_sts_regional_calls_total[5m])&quot;,
                &quot;legendFormat&quot;: &quot;Regional&quot;
              },
              {
                &quot;expr&quot;: &quot;rate(aws_sts_global_calls_total[5m])&quot;,
                &quot;legendFormat&quot;: &quot;Global&quot;
              }
            ]
          }
        ]
      }
    }




5. Load Testing IRSA

#!/bin/bash
# IRSA load testing script

NAMESPACE=&quot;load-test&quot;
REPLICAS=100
DURATION=&quot;300s&quot;

echo &quot;Starting IRSA load test with $REPLICAS replicas for $DURATION...&quot;

# Create load test namespace
kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# Deploy load test ServiceAccount
kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: load-test-sa
  namespace: $NAMESPACE
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/LoadTestRole
EOF

# Deploy load test application
kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: irsa-load-test
  namespace: $NAMESPACE
spec:
  replicas: $REPLICAS
  selector:
    matchLabels:
      app: load-test
  template:
    metadata:
      labels:
        app: load-test
    spec:
      serviceAccountName: load-test-sa
      containers:
      - name: load-generator
        image: amazon/aws-cli:latest
        command: [&apos;sh&apos;, &apos;-c&apos;]
        args:
        - |
          while true; do
            aws sts get-caller-identity &amp;gt; /dev/null
            aws s3 ls &amp;gt; /dev/null
            sleep 1
          done
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m
EOF

# Wait for deployment
kubectl wait --for=condition=Available deployment/irsa-load-test -n $NAMESPACE --timeout=300s

echo &quot;Load test running for $DURATION...&quot;
sleep $(echo $DURATION | sed &apos;s/s//&apos;)

# Collect metrics
echo &quot;Collecting performance metrics...&quot;
kubectl top pods -n $NAMESPACE

# Cleanup
echo &quot;Cleaning up load test...&quot;
kubectl delete namespace $NAMESPACE

echo &quot;Load test complete!&quot;






References and Additional Resources

Official AWS Documentation

  AWS IRSA User Guide
  EKS Best Practices - Security
  AWS STS API Reference
  OpenID Connect in AWS IAM


AWS Blog Posts and Whitepapers

  Diving into IAM Roles for Service Accounts
  Amazon EKS Security Best Practices
  Fine-grained IAM roles for service accounts


Tools and Utilities

  eksctl - CLI tool for creating EKS clusters with IRSA support
  AWS CLI v2 - Enhanced IRSA credential support
  Kubernetes External Secrets - Alternative secrets management
  IRSA Terraform Modules


Security and Compliance

  CIS Amazon EKS Benchmark
  NIST Cybersecurity Framework
  SOC 2 Compliance with IRSA


Monitoring and Observability

  AWS CloudTrail for IRSA
  Prometheus Operator
  Grafana Dashboard Examples


Community Resources

  AWS Containers Roadmap
  CNCF Kubernetes Documentation
  Kubernetes Security Best Practices


Sample Code and Examples

  AWS Samples - IRSA Examples
  Terraform AWS EKS Examples
  Kubernetes Examples

",
            "wordcount": "9669",
            "inLanguage": "en",
            "dateCreated": "2025-05-15/",
            "datePublished": "2025-05-15/",
            "dateModified": "2025-05-15/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "AWS",
            "articleSection": "AWS",
            "keywords": ["aws","kubernetes","eks","security","irsa","oidc","sts","iam","enterprise","devops"]
        }
        </script>
    </body>
</html>
