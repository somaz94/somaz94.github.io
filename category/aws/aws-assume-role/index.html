<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>Advanced AWS Assume Role Patterns & Enterprise Security Best Practices | somaz</title>
    <meta name="description" content="A comprehensive guide to AWS Assume Role with advanced patterns, automation, and enterprise-grade security implementations">
    
        <meta name="keywords" content="aws, iam, security, authentication, sts, cross-account, automation, enterprise, devops, terraform">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Advanced AWS Assume Role Patterns & Enterprise Security Best Practices | somaz">
    <meta name="twitter:description" content="A comprehensive guide to AWS Assume Role with advanced patterns, automation, and enterprise-grade security implementations">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1737423759/aws-assume-role_wtm7on.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/aws/aws-assume-role/">
    <meta property="og:title" content="Advanced AWS Assume Role Patterns & Enterprise Security Best Practices | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1737423759/aws-assume-role_wtm7on.png">
    <meta property="og:description" content="A comprehensive guide to AWS Assume Role with advanced patterns, automation, and enterprise-grade security implementations">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/aws/aws-assume-role/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-04-02T00:00:00+00:00">
                            


April 2, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>39 min to read</span>
                </p>
                <h1 class="post-title">Advanced AWS Assume Role Patterns & Enterprise Security Best Practices</h1>
                <p class="post-subtitle"></p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1737423759/aws-assume-role_wtm7on.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><a href="https://linuxbeast.com/blog/how-to-set-up-cross-account-access-in-aws-with-assumerole/">image reference link</a></p>

<p><br /></p>

<hr />

<h2 id="overview">Overview</h2>
<p>AWS Assume Role is a fundamental security feature that enables temporary, controlled access to AWS resources across accounts or within the same account.</p>

<p>This comprehensive guide covers advanced patterns, automation strategies, and enterprise-grade security implementations for production environments.</p>

<h3 id="what-is-aws-assume-role">What is AWS Assume Role?</h3>

<p>AWS Assume Role is a function provided by AWS Security Token Service (STS) that allows one IAM entity (user or service) to temporarily adopt another role in AWS and use the permissions associated with that role.</p>

<p>This mechanism enhances security and simplifies access management by granting only the necessary permissions for the duration required to complete specific tasks.</p>

<p><br /></p>

<p>The <code class="language-plaintext highlighter-rouge">sts:AssumeRole</code> operation enables a secure delegation model where:</p>

<ul>
  <li><strong>Temporary access</strong>: Credentials expire after a specified duration (15 minutes to 12 hours)</li>
  <li><strong>No sharing of long-term credentials</strong>: Eliminates the need to share permanent IAM credentials</li>
  <li><strong>Granular permissions</strong>: Access can be restricted based on session policies, source IP, and more</li>
  <li><strong>Centralized management</strong>: Simplifies permission management across multiple accounts</li>
  <li><strong>Audit trail</strong>: Complete visibility into who assumed what role and when</li>
  <li><strong>Zero-trust architecture</strong>: Supports least-privilege access principles</li>
</ul>

<h4 id="advanced-use-cases">Advanced Use Cases</h4>

<ul>
  <li><strong>Cross-account access</strong>: Access resources in another AWS account without creating and managing users in that account</li>
  <li><strong>Multi-tenant architectures</strong>: Isolate customer data while maintaining operational efficiency</li>
  <li><strong>Break-glass procedures</strong>: Emergency access with proper approval workflows</li>
  <li><strong>Service-to-service authentication</strong>: Secure communication between microservices</li>
  <li><strong>Time-bound privileged access</strong>: Temporary elevated permissions for specific tasks</li>
  <li><strong>Compliance and auditing</strong>: Meet regulatory requirements with detailed access logs</li>
  <li><strong>Zero-downtime credential rotation</strong>: Update access without service interruption</li>
</ul>

<p><br /></p>

<h3 id="how-aws-assume-role-works">How AWS Assume Role Works</h3>

<p><img src="/assets/svg/aws-assume-role/assume-role.svg" alt="Assume Role Process Flow" /></p>

<ol>
  <li><strong>Trust relationship</strong>: The target role specifies which entities (principals) can assume it</li>
  <li><strong>Permission check</strong>: The assuming entity must have permission to call the <code class="language-plaintext highlighter-rouge">sts:AssumeRole</code> action</li>
  <li><strong>STS call</strong>: The entity calls the AssumeRole API with the role ARN and optional parameters</li>
  <li><strong>Temporary credentials</strong>: STS returns temporary security credentials (access key, secret key, session token)</li>
  <li><strong>Using credentials</strong>: Applications use these credentials to make AWS API calls with the role’s permissions</li>
</ol>

<p><br /></p>

<h3 id="enterprise-grade-role-architecture-patterns">Enterprise-Grade Role Architecture Patterns</h3>

<h4 id="1-hub-and-spoke-model">1. Hub-and-Spoke Model</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Central Security Account (Hub)
├── Identity Management
├── Audit &amp; Compliance
├── Emergency Access Roles
└── Cross-Account Trust Relationships

Spoke Accounts
├── Production Account
├── Development Account
├── Testing Account
└── Shared Services Account
</code></pre></div></div>

<p><strong>Implementation Strategy:</strong></p>
<ul>
  <li>Central identity account manages all user identities</li>
  <li>Each spoke account trusts the hub account</li>
  <li>Role assumption flows through the hub for centralized auditing</li>
  <li>Consistent naming conventions across all accounts</li>
</ul>

<h4 id="2-layered-security-model">2. Layered Security Model</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AssumeRoleWithMFA"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::CENTRAL-ACCOUNT:root"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthPresent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"NumericLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthAge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3600"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/Department"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"DevOps"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Security"</span><span class="p">],</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"IpAddress"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:SourceIp"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"203.0.113.0/24"</span><span class="p">,</span><span class="w"> </span><span class="s2">"198.51.100.0/24"</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:userid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AIDAI*:${aws:username}"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="3-just-in-time-jit-access-pattern">3. Just-In-Time (JIT) Access Pattern</h4>

<p><strong>Automated Approval Workflow:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">JITAccessManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sts</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sts'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'iam'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sns</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sns'</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">request_elevated_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestor</span><span class="p">,</span> <span class="n">role_arn</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">,</span> <span class="n">justification</span><span class="p">):</span>
        <span class="s">"""Request temporary elevated access with approval workflow"""</span>
        
        <span class="c1"># Create temporary policy for specific duration
</span>        <span class="n">temp_policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"Version"</span><span class="p">:</span> <span class="s">"2012-10-17"</span><span class="p">,</span>
            <span class="s">"Statement"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">"Effect"</span><span class="p">:</span> <span class="s">"Allow"</span><span class="p">,</span>
                    <span class="s">"Principal"</span><span class="p">:</span> <span class="p">{</span><span class="s">"AWS"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"arn:aws:iam::</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">get_account_id</span><span class="p">()</span><span class="si">}</span><span class="s">:user/</span><span class="si">{</span><span class="n">requestor</span><span class="si">}</span><span class="s">"</span><span class="p">},</span>
                    <span class="s">"Action"</span><span class="p">:</span> <span class="s">"sts:AssumeRole"</span><span class="p">,</span>
                    <span class="s">"Resource"</span><span class="p">:</span> <span class="n">role_arn</span><span class="p">,</span>
                    <span class="s">"Condition"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">"DateLessThan"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s">"aws:CurrentTime"</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">duration_hours</span><span class="p">)).</span><span class="n">isoformat</span><span class="p">()</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="c1"># Send approval request
</span>        <span class="n">approval_request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"requestor"</span><span class="p">:</span> <span class="n">requestor</span><span class="p">,</span>
            <span class="s">"role_arn"</span><span class="p">:</span> <span class="n">role_arn</span><span class="p">,</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="n">duration_hours</span><span class="p">,</span>
            <span class="s">"justification"</span><span class="p">:</span> <span class="n">justification</span><span class="p">,</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">().</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s">"policy"</span><span class="p">:</span> <span class="n">temp_policy</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">sns</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">TopicArn</span><span class="o">=</span><span class="s">'arn:aws:sns:region:account:jit-access-requests'</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">approval_request</span><span class="p">),</span>
            <span class="n">Subject</span><span class="o">=</span><span class="sa">f</span><span class="s">'JIT Access Request: </span><span class="si">{</span><span class="n">requestor</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">{</span><span class="n">role_arn</span><span class="si">}</span><span class="s">'</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">approval_request</span>
    
    <span class="k">def</span> <span class="nf">approve_access_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">approver</span><span class="p">):</span>
        <span class="s">"""Approve and implement temporary access"""</span>
        <span class="c1"># Implementation for approval workflow
</span>        <span class="k">pass</span>
</code></pre></div></div>

<h3 id="advanced-automation-with-infrastructure-as-code">Advanced Automation with Infrastructure as Code</h3>

<h4 id="terraform-module-for-cross-account-roles">Terraform Module for Cross-Account Roles</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># modules/cross-account-role/main.tf</span>
<span class="nx">variable</span> <span class="s2">"account_id"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Account ID that can assume this role"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"role_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Name of the role to create"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"policies"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"List of policy ARNs to attach"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">list</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
  <span class="nx">default</span>     <span class="p">=</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"max_session_duration"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Maximum session duration in seconds"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">number</span>
  <span class="nx">default</span>     <span class="p">=</span> <span class="mi">3600</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"require_mfa"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Require MFA for role assumption"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">bool</span>
  <span class="nx">default</span>     <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"allowed_principals"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"List of principals allowed to assume this role"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">list</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"trust_policy"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span> <span class="p">=</span> <span class="s2">"Allow"</span>
    
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"AWS"</span>
      <span class="nx">identifiers</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">allowed_principals</span>
    <span class="p">}</span>
    
    <span class="nx">actions</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"sts:AssumeRole"</span><span class="p">]</span>
    
    <span class="nx">dynamic</span> <span class="s2">"condition"</span> <span class="p">{</span>
      <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">require_mfa</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
      <span class="nx">content</span> <span class="p">{</span>
        <span class="nx">test</span>     <span class="p">=</span> <span class="s2">"Bool"</span>
        <span class="nx">variable</span> <span class="p">=</span> <span class="s2">"aws:MultiFactorAuthPresent"</span>
        <span class="nx">values</span>   <span class="p">=</span> <span class="p">[</span><span class="s2">"true"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">condition</span> <span class="p">{</span>
      <span class="nx">test</span>     <span class="p">=</span> <span class="s2">"StringEquals"</span>
      <span class="nx">variable</span> <span class="p">=</span> <span class="s2">"aws:RequestedRegion"</span>
      <span class="nx">values</span>   <span class="p">=</span> <span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"cross_account_role"</span> <span class="p">{</span>
  <span class="nx">name</span>                 <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">role_name</span>
  <span class="nx">assume_role_policy</span>   <span class="p">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_iam_policy_document</span><span class="err">.</span><span class="nx">trust_policy</span><span class="err">.</span><span class="nx">json</span>
  <span class="nx">max_session_duration</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">max_session_duration</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">ManagedBy</span>   <span class="p">=</span> <span class="s2">"terraform"</span>
    <span class="nx">Purpose</span>     <span class="p">=</span> <span class="s2">"cross-account-access"</span>
    <span class="nx">Environment</span> <span class="p">=</span> <span class="nx">terraform</span><span class="err">.</span><span class="nx">workspace</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"policies"</span> <span class="p">{</span>
  <span class="nx">count</span>      <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">policies</span><span class="err">)</span>
  <span class="nx">role</span>       <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">cross_account_role</span><span class="err">.</span><span class="nx">name</span>
  <span class="nx">policy_arn</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">policies</span><span class="p">[</span><span class="nx">count</span><span class="err">.</span><span class="nx">index</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># CloudTrail for auditing</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudtrail"</span> <span class="s2">"role_audit"</span> <span class="p">{</span>
  <span class="nx">name</span>           <span class="p">=</span> <span class="s2">"${var.role_name}-audit-trail"</span>
  <span class="nx">s3_bucket_name</span> <span class="p">=</span> <span class="nx">aws_s3_bucket</span><span class="err">.</span><span class="nx">audit_logs</span><span class="err">.</span><span class="nx">bucket</span>
  
  <span class="nx">event_selector</span> <span class="p">{</span>
    <span class="nx">read_write_type</span>           <span class="p">=</span> <span class="s2">"All"</span>
    <span class="nx">include_management_events</span> <span class="p">=</span> <span class="kc">true</span>
    
    <span class="nx">data_resource</span> <span class="p">{</span>
      <span class="nx">type</span>   <span class="p">=</span> <span class="s2">"AWS::S3::Object"</span>
      <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"arn:aws:s3:::${aws_s3_bucket.audit_logs.bucket}/*"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">insight_selector</span> <span class="p">{</span>
    <span class="nx">insight_type</span> <span class="p">=</span> <span class="s2">"ApiCallRateInsight"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"role_arn"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"ARN of the created role"</span>
  <span class="nx">value</span>       <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="err">.</span><span class="nx">cross_account_role</span><span class="err">.</span><span class="nx">arn</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="aws-cli-wrapper-script-for-enhanced-security">AWS CLI Wrapper Script for Enhanced Security</h4>

<script src="https://gist.github.com/somaz94/86c8aa4844f0619a5763512f97ff8d7d.js"></script>

<p><br /></p>

<h3 id="advanced-monitoring-and-alerting">Advanced Monitoring and Alerting</h3>

<h4 id="cloudwatch-dashboards-for-role-usage">CloudWatch Dashboards for Role Usage</h4>

<script src="https://gist.github.com/somaz94/adb9126c0fd98ad0d1859a37f5b2fedb.js"></script>

<p><br /></p>

<h4 id="advanced-eventbridge-rules-for-security-alerts">Advanced EventBridge Rules for Security Alerts</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">create_security_monitoring</span><span class="p">():</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'events'</span><span class="p">)</span>
    <span class="n">sns</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sns'</span><span class="p">)</span>
    
    <span class="c1"># Rule for suspicious role assumptions
</span>    <span class="n">suspicious_pattern</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"source"</span><span class="p">:</span> <span class="p">[</span><span class="s">"aws.sts"</span><span class="p">],</span>
        <span class="s">"detail-type"</span><span class="p">:</span> <span class="p">[</span><span class="s">"AWS API Call via CloudTrail"</span><span class="p">],</span>
        <span class="s">"detail"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"eventSource"</span><span class="p">:</span> <span class="p">[</span><span class="s">"sts.amazonaws.com"</span><span class="p">],</span>
            <span class="s">"eventName"</span><span class="p">:</span> <span class="p">[</span><span class="s">"AssumeRole"</span><span class="p">],</span>
            <span class="s">"errorCode"</span><span class="p">:</span> <span class="p">{</span><span class="s">"exists"</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
            <span class="s">"sourceIPAddress"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"anything-but"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">"prefix"</span><span class="p">:</span> <span class="p">[</span><span class="s">"10."</span><span class="p">,</span> <span class="s">"172.16."</span><span class="p">,</span> <span class="s">"192.168."</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">events</span><span class="p">.</span><span class="n">put_rule</span><span class="p">(</span>
        <span class="n">Name</span><span class="o">=</span><span class="s">'SuspiciousRoleAssumption'</span><span class="p">,</span>
        <span class="n">EventPattern</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">suspicious_pattern</span><span class="p">),</span>
        <span class="n">State</span><span class="o">=</span><span class="s">'ENABLED'</span><span class="p">,</span>
        <span class="n">Description</span><span class="o">=</span><span class="s">'Alert on role assumptions from external IPs'</span>
    <span class="p">)</span>
    
    <span class="c1"># Rule for failed role assumptions
</span>    <span class="n">failure_pattern</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"source"</span><span class="p">:</span> <span class="p">[</span><span class="s">"aws.sts"</span><span class="p">],</span>
        <span class="s">"detail-type"</span><span class="p">:</span> <span class="p">[</span><span class="s">"AWS API Call via CloudTrail"</span><span class="p">],</span>
        <span class="s">"detail"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"eventSource"</span><span class="p">:</span> <span class="p">[</span><span class="s">"sts.amazonaws.com"</span><span class="p">],</span>
            <span class="s">"eventName"</span><span class="p">:</span> <span class="p">[</span><span class="s">"AssumeRole"</span><span class="p">],</span>
            <span class="s">"errorCode"</span><span class="p">:</span> <span class="p">{</span><span class="s">"exists"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">events</span><span class="p">.</span><span class="n">put_rule</span><span class="p">(</span>
        <span class="n">Name</span><span class="o">=</span><span class="s">'FailedRoleAssumption'</span><span class="p">,</span>
        <span class="n">EventPattern</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">failure_pattern</span><span class="p">),</span>
        <span class="n">State</span><span class="o">=</span><span class="s">'ENABLED'</span><span class="p">,</span>
        <span class="n">Description</span><span class="o">=</span><span class="s">'Alert on failed role assumption attempts'</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">lambda_security_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="s">"""Lambda function to process security events and send alerts"""</span>
    
    <span class="n">detail</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'detail'</span><span class="p">]</span>
    <span class="n">event_name</span> <span class="o">=</span> <span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'eventName'</span><span class="p">)</span>
    <span class="n">source_ip</span> <span class="o">=</span> <span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sourceIPAddress'</span><span class="p">)</span>
    <span class="n">user_identity</span> <span class="o">=</span> <span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userIdentity'</span><span class="p">,</span> <span class="p">{})</span>
    
    <span class="c1"># Analyze the event
</span>    <span class="n">risk_score</span> <span class="o">=</span> <span class="n">calculate_risk_score</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">risk_score</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>  <span class="c1"># High risk threshold
</span>        <span class="n">send_security_alert</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">risk_score</span><span class="p">)</span>
        
        <span class="c1"># Optionally, automatically revoke the session
</span>        <span class="k">if</span> <span class="n">risk_score</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="n">revoke_active_sessions</span><span class="p">(</span><span class="n">user_identity</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">calculate_risk_score</span><span class="p">(</span><span class="n">detail</span><span class="p">):</span>
    <span class="s">"""Calculate risk score based on various factors"""</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Check source IP reputation
</span>    <span class="k">if</span> <span class="n">is_suspicious_ip</span><span class="p">(</span><span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sourceIPAddress'</span><span class="p">)):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">30</span>
    
    <span class="c1"># Check time of access
</span>    <span class="k">if</span> <span class="n">is_unusual_time</span><span class="p">(</span><span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'eventTime'</span><span class="p">)):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
    
    <span class="c1"># Check role sensitivity
</span>    <span class="n">role_arn</span> <span class="o">=</span> <span class="n">detail</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'requestParameters'</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">'roleArn'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'Admin'</span> <span class="ow">in</span> <span class="n">role_arn</span> <span class="ow">or</span> <span class="s">'Root'</span> <span class="ow">in</span> <span class="n">role_arn</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    
    <span class="c1"># Check user behavior anomaly
</span>    <span class="k">if</span> <span class="n">is_anomalous_behavior</span><span class="p">(</span><span class="n">detail</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    
    <span class="k">return</span> <span class="n">score</span>
</code></pre></div></div>

<h3 id="detailed-example-cross-account-eks-access-with-enhanced-security">Detailed Example: Cross-Account EKS Access with Enhanced Security</h3>

<p>The following example demonstrates how to use AssumeRole to grant Account A access to EKS resources in Account B with production-grade security controls.</p>

<h4 id="step-1-create-advanced-iam-role-in-account-b-target-account">Step 1: Create Advanced IAM Role in Account B (Target Account)</h4>

<p>Create an IAM role with comprehensive security controls and conditions.</p>

<p><br /></p>

<p><strong>Enhanced Trust Policy with Multiple Security Layers</strong>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CrossAccountAssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"arn:aws:iam::123456789012:role/DevOpsTeamRole"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"arn:aws:iam::123456789012:role/SecurityTeamRole"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthPresent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"NumericLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthAge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1800"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/Department"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"DevOps"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Security"</span><span class="p">],</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">],</span><span class="w">
          </span><span class="nl">"sts:ExternalId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"unique-external-id-2024"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"IpAddress"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:SourceIp"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"203.0.113.0/24"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"198.51.100.0/24"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T00:00:00Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"DateLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-12-31T23:59:59Z"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EmergencyAccess"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::123456789012:role/BreakGlassRole"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthPresent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/EmergencyAccess"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>Granular Permission Policy with Resource-Level Controls</strong>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EKSClusterManagement"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"eks:DescribeCluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:ListClusters"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:DescribeNodegroup"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:ListNodegroups"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:DescribeUpdate"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:ListUpdates"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:eks:*:111122223333:cluster/prod-*"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"arn:aws:eks:*:111122223333:cluster/staging-*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EKSConfigurationUpdates"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"eks:UpdateClusterConfig"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:UpdateClusterVersion"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:UpdateNodegroupConfig"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:UpdateNodegroupVersion"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:eks:*:111122223333:cluster/staging-*"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"arn:aws:eks:*:111122223333:nodegroup/staging-*/*/*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">],</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/Role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DevOps"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:MultiFactorAuthPresent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ProductionReadOnly"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"eks:DescribeCluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:ListClusters"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:DescribeNodegroup"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:ListNodegroups"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:eks:*:111122223333:cluster/prod-*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/ProductionAccess"</span><span class="p">:</span><span class="w"> </span><span class="s2">"read-only"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CloudWatchLogs"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"logs:DescribeLogGroups"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"logs:DescribeLogStreams"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"logs:GetLogEvents"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"logs:FilterLogEvents"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:logs:*:111122223333:log-group:/aws/eks/*"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>Permission Boundary for Additional Security</strong>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PermissionBoundary"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"eks:*"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"ec2:DescribeInstances"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"ec2:DescribeSecurityGroups"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"ec2:DescribeSubnets"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"ec2:DescribeVpcs"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"iam:ListRoles"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"iam:PassRole"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"logs:*"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DenyDangerousActions"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Deny"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"eks:DeleteCluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"eks:DeleteNodegroup"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"iam:DeleteRole"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"iam:DeletePolicy"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"iam:DetachRolePolicy"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringNotEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:PrincipalTag/CanDelete"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h4 id="step-2-create-iam-policy-in-account-a-source-account">Step 2: Create IAM Policy in Account A (Source Account)</h4>

<p>Create and attach an IAM policy to the users or roles in Account A that need to assume the role in Account B.</p>

<p><br /></p>

<p><strong>Example Policy (in Account A)</strong>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::111122223333:role/EKSAdminRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"us-east-1"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h4 id="step-3-assume-role-from-account-a">Step 3: Assume Role from Account A</h4>

<p>A user or service in Account A can now assume the role in Account B using the AWS CLI, SDK, or AWS console.</p>

<p><br /></p>

<p><strong>Using AWS CLI</strong>:</p>

<p><br /></p>

<script src="https://gist.github.com/somaz94/f94ab450d8c2718a38669283e55f5e26.js"></script>

<p><br /></p>

<p>This command returns a JSON object containing:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">AccessKeyId</code></li>
  <li><code class="language-plaintext highlighter-rouge">SecretAccessKey</code></li>
  <li><code class="language-plaintext highlighter-rouge">SessionToken</code></li>
  <li><code class="language-plaintext highlighter-rouge">Expiration</code> timestamp</li>
</ul>

<p><br /></p>

<p><strong>Using AWS SDK (Python example)</strong>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>

<span class="c1"># Create an STS client
</span><span class="n">sts_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sts'</span><span class="p">)</span>

<span class="c1"># Assume the role
</span><span class="n">assumed_role</span> <span class="o">=</span> <span class="n">sts_client</span><span class="p">.</span><span class="n">assume_role</span><span class="p">(</span>
    <span class="n">RoleArn</span><span class="o">=</span><span class="s">'arn:aws:iam::111122223333:role/EKSAdminRole'</span><span class="p">,</span>
    <span class="n">RoleSessionName</span><span class="o">=</span><span class="s">'EKSAdminSession'</span><span class="p">,</span>
    <span class="n">DurationSeconds</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># 1 hour
</span><span class="p">)</span>

<span class="c1"># Extract the temporary credentials
</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">assumed_role</span><span class="p">[</span><span class="s">'Credentials'</span><span class="p">]</span>

<span class="c1"># Create an EKS client using the temporary credentials
</span><span class="n">eks_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span>
    <span class="s">'eks'</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s">'us-west-2'</span><span class="p">,</span>
    <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'AccessKeyId'</span><span class="p">],</span>
    <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'SecretAccessKey'</span><span class="p">],</span>
    <span class="n">aws_session_token</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'SessionToken'</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Now you can make EKS API calls
</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">eks_client</span><span class="p">.</span><span class="n">list_clusters</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="step-4-use-temporary-credentials-for-access">Step 4: Use Temporary Credentials for Access</h4>

<p>These temporary credentials can be used to access EKS resources in Account B. Here’s an example of updating your kubeconfig:</p>

<p><br /></p>

<script src="https://gist.github.com/somaz94/6a2ce90006f40949ae86e9dd83bd3fc0.js"></script>

<p><br /></p>

<p>You can also create a shell profile that automatically assumes the role:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add to your ~/.bash_profile or ~/.zshrc</span>
<span class="k">function </span>assume-eks-role<span class="o">()</span> <span class="o">{</span>
  <span class="nv">output</span><span class="o">=</span><span class="si">$(</span>aws sts assume-role <span class="nt">--role-arn</span> arn:aws:iam::111122223333:role/EKSAdminRole <span class="nt">--role-session-name</span> EKSSession<span class="si">)</span>
  <span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$output</span> | jq <span class="nt">-r</span> <span class="s1">'.Credentials.AccessKeyId'</span><span class="si">)</span>
  <span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$output</span> | jq <span class="nt">-r</span> <span class="s1">'.Credentials.SecretAccessKey'</span><span class="si">)</span>
  <span class="nb">export </span><span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$output</span> | jq <span class="nt">-r</span> <span class="s1">'.Credentials.SessionToken'</span><span class="si">)</span>
  <span class="nb">echo</span> <span class="s2">"Temporary credentials set for EKS admin role"</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h3 id="what-is-stsassumerolewithwebidentity">What is sts:AssumeRoleWithWebIdentity?</h3>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">sts:AssumeRoleWithWebIdentity</code> operation allows you to obtain temporary AWS credentials by using an OpenID Connect (OIDC) token or SAML 2.0 assertion from an external identity provider.</p>
</blockquote>

<p>This mechanism enables federating AWS access with external identity systems without requiring AWS IAM users for each identity.</p>

<h4 id="key-benefits">Key Benefits</h4>

<ul>
  <li><strong>No IAM users needed</strong>: Eliminates the need to create IAM users for each external identity</li>
  <li><strong>Centralized identity management</strong>: Use your existing identity provider</li>
  <li><strong>Zero IAM credentials</strong>: No long-term AWS credentials to manage or rotate</li>
  <li><strong>Auditable access</strong>: All access is logged in AWS CloudTrail with the original identity information</li>
</ul>

<h4 id="common-use-cases">Common Use Cases</h4>

<ul>
  <li><strong>GitHub Actions</strong>: Authenticate GitHub workflows to access AWS resources</li>
  <li><strong>Kubernetes Service Accounts</strong>: Allow pods to access AWS services securely</li>
  <li><strong>Web/Mobile Applications</strong>: Allow authenticated application users to access AWS resources directly</li>
  <li><strong>Enterprise SSO</strong>: Enable employees to access AWS using their corporate credentials</li>
  <li><strong>Self-developed applications</strong>: Authenticate custom applications with your own OIDC provider</li>
</ul>

<h4 id="process-flow">Process Flow</h4>

<ol>
  <li><strong>OIDC Provider Configuration</strong>: Register an OIDC provider in IAM and create a role with a trust policy</li>
  <li><strong>Identity Authentication</strong>: User/service authenticates with the external IdP and receives an OIDC token</li>
  <li><strong>AWS API Call</strong>: Application calls <code class="language-plaintext highlighter-rouge">AssumeRoleWithWebIdentity</code> API with the OIDC token</li>
  <li><strong>Token Verification</strong>: AWS verifies the token with the configured OIDC provider</li>
  <li><strong>Temporary Credentials</strong>: Upon successful verification, AWS issues temporary credentials</li>
</ol>

<h4 id="example-github-actions-integration">Example: GitHub Actions Integration</h4>

<p><br /></p>

<p><strong>IAM OIDC Provider Configuration</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws iam create-open-id-connect-provider <span class="nt">--url</span> https://token.actions.githubusercontent.com <span class="nt">--client-id-list</span> sts.amazonaws.com <span class="nt">--thumbprint-list</span> 6938fd4d98bab03faadb97b34396831e3780aea1
</code></pre></div></div>

<p><br /></p>

<p><strong>Role Trust Policy</strong>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Federated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRoleWithWebIdentity"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"token.actions.githubusercontent.com:aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts.amazonaws.com"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"token.actions.githubusercontent.com:sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"repo:your-org/your-repo:ref:refs/heads/main"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>GitHub Actions Workflow</strong>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">permissions</span><span class="pi">:</span>
      <span class="na">id-token</span><span class="pi">:</span> <span class="s">write</span>
      <span class="na">contents</span><span class="pi">:</span> <span class="s">read</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure AWS credentials</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">role-to-assume</span><span class="pi">:</span> <span class="s">arn:aws:iam::ACCOUNT_ID:role/GitHubActionsRole</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">us-east-1</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy infrastructure</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">aws cloudformation deploy --template-file template.yaml --stack-name my-stack</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="comparison-assumerole-vs-assumerolewithwebidentity-vs-assumerolewithsaml">Comparison: AssumeRole vs AssumeRoleWithWebIdentity vs AssumeRoleWithSAML<br /><br /></h3>

<h4 id="authentication">Authentication:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: AWS IAM credentials</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: OIDC token</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: SAML 2.0 assertion<br /></li>
</ul>

<h4 id="identity-source">Identity Source:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: AWS IAM</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: External OIDC providers (Google, GitHub, etc.)</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: SAML IdPs (Active Directory, Okta, etc.)<br /></li>
</ul>

<h4 id="primary-use-cases">Primary Use Cases:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: Cross-account access, delegation within AWS</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: Mobile/web apps, CI/CD pipelines, Kubernetes</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: Enterprise SSO, workforce identity federation<br /></li>
</ul>

<h4 id="required-setup">Required Setup:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: IAM roles and policies</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: OIDC provider + IAM role</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: SAML provider + IAM role<br /></li>
</ul>

<h4 id="credential-duration">Credential Duration:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: 15 min - 12 hours</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: 15 min - 12 hours</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: 15 min - 12 hours<br /></li>
</ul>

<h4 id="common-examples">Common Examples:</h4>
<ul>
  <li><strong>sts:AssumeRole</strong>: AWS CLI, AWS console</li>
  <li><strong>sts:AssumeRoleWithWebIdentity</strong>: GitHub Actions, Kubernetes ServiceAccounts</li>
  <li><strong>sts:AssumeRoleWithSAML</strong>: AWS Console login via corporate SSO<br /></li>
</ul>

<p><br /></p>

<h3 id="advanced-best-practices-for-enterprise-aws-assume-role">Advanced Best Practices for Enterprise AWS Assume Role</h3>

<div class="info-box info-box-success-not-check">
<br />
<strong>1. Security Architecture:</strong>
<ul>
  <li>Implement defense-in-depth with multiple conditional layers</li>
  <li>Use permission boundaries to limit maximum permissions</li>
  <li>Enforce MFA with time-based conditions (MFA age &lt; 30 minutes)</li>
  <li>Implement IP allowlisting and geographic restrictions</li>
  <li>Use external IDs for third-party access to prevent confused deputy attacks</li>
  <li>Implement role chaining limits and session duration policies</li>
</ul>

<strong>2. Automation and Operations:</strong>
<ul>
  <li>Use Infrastructure as Code (Terraform/CloudFormation) for consistent role deployment</li>
  <li>Implement automated role lifecycle management</li>
  <li>Create self-service portals for role requests with approval workflows</li>
  <li>Establish break-glass procedures with proper audit trails</li>
  <li>Implement just-in-time (JIT) access with time-bound permissions</li>
  <li>Use AWS Config rules to monitor role configuration drift</li>
</ul>

<strong>3. Monitoring and Compliance:</strong>
<ul>
  <li>Enable comprehensive CloudTrail logging with log file validation</li>
  <li>Implement real-time alerting for suspicious role assumption patterns</li>
  <li>Use AWS GuardDuty for behavioral analysis and threat detection</li>
  <li>Create custom CloudWatch metrics for role usage analytics</li>
  <li>Implement automated compliance checks with AWS Security Hub</li>
  <li>Use IAM Access Analyzer for unused and over-privileged role detection</li>
</ul>

<strong>4. Governance and Risk Management:</strong>
<ul>
  <li>Establish role naming conventions and tagging strategies</li>
  <li>Implement regular access reviews and role audits</li>
  <li>Use AWS Organizations SCPs as guardrails</li>
  <li>Create role templates for common use cases</li>
  <li>Implement risk-based access controls with conditional policies</li>
  <li>Establish incident response procedures for compromised roles</li>
</ul>

<strong>5. Performance and Scalability:</strong>
<ul>
  <li>Implement credential caching to reduce STS API calls</li>
  <li>Use regional STS endpoints for reduced latency</li>
  <li>Implement retry logic with exponential backoff</li>
  <li>Monitor STS API throttling and adjust application behavior</li>
  <li>Use session tags for enhanced authorization decisions</li>
  <li>Implement efficient credential refresh mechanisms</li>
</ul>
</div>

<p><br /></p>

<h3 id="enterprise-role-patterns-and-anti-patterns">Enterprise Role Patterns and Anti-Patterns</h3>

<h4 id="recommended-patterns">Recommended Patterns</h4>

<p><br /></p>

<p><strong>1. Principle of Least Privilege with Session Policies:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::my-bucket/user-${aws:userid}/*"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>2. Time-Based Access Controls:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DateGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T09:00:00Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"DateLessThan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"aws:CurrentTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-01-01T17:00:00Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ForAllValues:StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"aws:RequestedRegion"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"us-west-2"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>3. Emergency Access Pattern:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_emergency_access_role</span><span class="p">():</span>
    <span class="s">"""Create break-glass role with temporary elevated permissions"""</span>
    
    <span class="n">trust_policy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Version"</span><span class="p">:</span> <span class="s">"2012-10-17"</span><span class="p">,</span>
        <span class="s">"Statement"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">"Effect"</span><span class="p">:</span> <span class="s">"Allow"</span><span class="p">,</span>
                <span class="s">"Principal"</span><span class="p">:</span> <span class="p">{</span><span class="s">"AWS"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"arn:aws:iam::</span><span class="si">{</span><span class="n">ACCOUNT_ID</span><span class="si">}</span><span class="s">:role/EmergencyAccessRole"</span><span class="p">},</span>
                <span class="s">"Action"</span><span class="p">:</span> <span class="s">"sts:AssumeRole"</span><span class="p">,</span>
                <span class="s">"Condition"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">"Bool"</span><span class="p">:</span> <span class="p">{</span><span class="s">"aws:MultiFactorAuthPresent"</span><span class="p">:</span> <span class="s">"true"</span><span class="p">},</span>
                    <span class="s">"StringEquals"</span><span class="p">:</span> <span class="p">{</span><span class="s">"aws:PrincipalTag/EmergencyAccess"</span><span class="p">:</span> <span class="s">"approved"</span><span class="p">},</span>
                    <span class="s">"NumericLessThan"</span><span class="p">:</span> <span class="p">{</span><span class="s">"aws:MultiFactorAuthAge"</span><span class="p">:</span> <span class="s">"900"</span><span class="p">}</span>  <span class="c1"># 15 minutes
</span>                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="c1"># Create role with temporary permissions
</span>    <span class="c1"># Automatically expire after 2 hours
</span></code></pre></div></div>

<h4 id="anti-patterns-to-avoid">Anti-Patterns to Avoid</h4>

<p><br /></p>

<p><strong>1. Overly Permissive Trust Policies:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">DON'T</span><span class="w"> </span><span class="err">DO</span><span class="w"> </span><span class="err">THIS</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>2. Long-Lived Sessions Without Conditions:</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">DON'T</span><span class="w"> </span><span class="err">DO</span><span class="w"> </span><span class="err">THIS</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::123456789012:root"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">No</span><span class="w"> </span><span class="err">conditions</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">unlimited</span><span class="w"> </span><span class="err">access</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p><strong>3. Credential Hardcoding:</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># DON'T DO THIS
</span><span class="n">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s">"AKIA..."</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s">"secret..."</span>

<span class="c1"># DO THIS INSTEAD
</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">sts_client</span><span class="p">.</span><span class="n">assume_role</span><span class="p">(...)</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="advanced-troubleshooting-and-diagnostics">Advanced Troubleshooting and Diagnostics</h3>

<div class="info-box info-box-warning-not-check">
<br />
<strong>1. Access Denied Issues (Enhanced Diagnostics):</strong>
<ul>
  <li>Use AWS CLI with --debug flag to see detailed API responses</li>
  <li>Check CloudTrail for specific error codes and failure reasons</li>
  <li>Validate all condition keys in trust policies</li>
  <li>Test with AWS IAM Policy Simulator for permission validation</li>
  <li>Verify external ID requirements and case sensitivity</li>
  <li>Check for typos in role ARNs and account IDs</li>
</ul>

<strong>2. Session and Token Management:</strong>
<ul>
  <li>Monitor credential expiration with automated renewal</li>
  <li>Implement exponential backoff for STS API rate limiting</li>
  <li>Handle token refresh gracefully in long-running applications</li>
  <li>Use AWS SDKs' built-in credential providers when possible</li>
  <li>Implement circuit breakers for STS endpoint failures</li>
</ul>

<strong>3. OIDC/SAML Federation Troubleshooting:</strong>
<ul>
  <li>Validate OIDC provider thumbprint matches current certificate</li>
  <li>Check token claims structure and required audience values</li>
  <li>Verify clock synchronization between systems</li>
  <li>Test token validation with online JWT decoders</li>
  <li>Monitor for certificate rotation and update schedules</li>
</ul>

<strong>4. Performance and Reliability Issues:</strong>
<ul>
  <li>Implement caching strategies for frequently used credentials</li>
  <li>Use regional STS endpoints to reduce latency</li>
  <li>Monitor STS API quotas and request patterns</li>
  <li>Implement health checks for role assumption workflows</li>
  <li>Use CloudWatch metrics to track assumption success rates</li>
</ul>

<strong>5. Security Incident Response:</strong>
<ul>
  <li>Create runbooks for compromised role scenarios</li>
  <li>Implement automated session revocation capabilities</li>
  <li>Set up real-time alerting for anomalous access patterns</li>
  <li>Use AWS Config to detect unauthorized role modifications</li>
  <li>Maintain audit trails for forensic analysis</li>
</ul>
</div>

<h3 id="production-ready-code-examples">Production-Ready Code Examples</h3>

<h4 id="advanced-session-management-class">Advanced Session Management Class</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span><span class="p">,</span> <span class="n">BotoCoreError</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">AssumeRoleConfig</span><span class="p">:</span>
    <span class="n">role_arn</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">duration_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="n">external_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">session_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">mfa_serial</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'us-east-1'</span>

<span class="k">class</span> <span class="nc">EnhancedSTSManager</span><span class="p">:</span>
    <span class="s">"""Enterprise-grade STS session manager with caching and error handling"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sts_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'sts'</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">assume_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AssumeRoleConfig</span><span class="p">,</span> <span class="n">mfa_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="s">"""Assume role with comprehensive error handling and caching"""</span>
        
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># Check cache first
</span>            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_is_cached_session_valid</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Using cached credentials for </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">role_arn</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">cache_key</span><span class="p">][</span><span class="s">'credentials'</span><span class="p">]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_perform_assume_role</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">mfa_token</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_cache_session</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">credentials</span>
                
            <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_handle_client_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unexpected error assuming role: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">_perform_assume_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AssumeRoleConfig</span><span class="p">,</span> <span class="n">mfa_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="s">"""Perform the actual assume role operation with retry logic"""</span>
        
        <span class="n">assume_role_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'RoleArn'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">role_arn</span><span class="p">,</span>
            <span class="s">'RoleSessionName'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">session_name</span><span class="p">,</span>
            <span class="s">'DurationSeconds'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">duration_seconds</span>
        <span class="p">}</span>
        
        <span class="c1"># Add optional parameters
</span>        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">external_id</span><span class="p">:</span>
            <span class="n">assume_role_params</span><span class="p">[</span><span class="s">'ExternalId'</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">external_id</span>
        
        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">session_policy</span><span class="p">:</span>
            <span class="n">assume_role_params</span><span class="p">[</span><span class="s">'Policy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">session_policy</span>
        
        <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">mfa_serial</span> <span class="ow">and</span> <span class="n">mfa_token</span><span class="p">:</span>
            <span class="n">assume_role_params</span><span class="p">[</span><span class="s">'SerialNumber'</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">mfa_serial</span>
            <span class="n">assume_role_params</span><span class="p">[</span><span class="s">'TokenCode'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfa_token</span>
        
        <span class="c1"># Retry logic with exponential backoff
</span>        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">base_delay</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sts_client</span><span class="p">.</span><span class="n">assume_role</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_params</span><span class="p">)</span>
                
                <span class="c1"># Enhance credentials with metadata
</span>                <span class="n">credentials</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'Credentials'</span><span class="p">]</span>
                <span class="n">credentials</span><span class="p">[</span><span class="s">'AssumedRoleUser'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'AssumedRoleUser'</span><span class="p">]</span>
                <span class="n">credentials</span><span class="p">[</span><span class="s">'PackedPolicySize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'PackedPolicySize'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully assumed role: </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">role_arn</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">credentials</span>
                
            <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="s">'Error'</span><span class="p">][</span><span class="s">'Code'</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">error_code</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'Throttling'</span><span class="p">,</span> <span class="s">'RequestLimitExceeded'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"Rate limited, retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s"> seconds..."</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">_handle_client_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="n">ClientError</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AssumeRoleConfig</span><span class="p">):</span>
        <span class="s">"""Provide detailed error analysis and suggestions"""</span>
        
        <span class="n">error_code</span> <span class="o">=</span> <span class="n">error</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="s">'Error'</span><span class="p">][</span><span class="s">'Code'</span><span class="p">]</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="n">error</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="s">'Error'</span><span class="p">][</span><span class="s">'Message'</span><span class="p">]</span>
        
        <span class="n">troubleshooting_guide</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'AccessDenied'</span><span class="p">:</span> <span class="s">"Check trust policy, ensure calling identity has sts:AssumeRole permission"</span><span class="p">,</span>
            <span class="s">'InvalidParameterValue'</span><span class="p">:</span> <span class="s">"Verify role ARN format and account ID"</span><span class="p">,</span>
            <span class="s">'MalformedPolicyDocument'</span><span class="p">:</span> <span class="s">"Review session policy JSON syntax"</span><span class="p">,</span>
            <span class="s">'TokenRefreshRequired'</span><span class="p">:</span> <span class="s">"MFA token expired, obtain new token"</span><span class="p">,</span>
            <span class="s">'RegionDisabledException'</span><span class="p">:</span> <span class="s">"STS not available in requested region"</span>
        <span class="p">}</span>
        
        <span class="n">suggestion</span> <span class="o">=</span> <span class="n">troubleshooting_guide</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_code</span><span class="p">,</span> <span class="s">"Check AWS documentation for error code"</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"AssumeRole failed: </span><span class="si">{</span><span class="n">error_code</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Suggestion: </span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Role ARN: </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">role_arn</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AssumeRoleConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Generate unique cache key for session"""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">role_arn</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">session_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">duration_seconds</span><span class="si">}</span><span class="s">"</span>
    
    <span class="k">def</span> <span class="nf">_is_cached_session_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Check if cached session is still valid"""</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">'credentials'</span><span class="p">][</span><span class="s">'Expiration'</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">'Z'</span><span class="p">,</span> <span class="s">'+00:00'</span><span class="p">))</span>
        
        <span class="c1"># Consider session valid if more than 5 minutes remaining
</span>        <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">expiration</span><span class="p">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">expiration</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_cache_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">credentials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="s">"""Cache session credentials"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'credentials'</span><span class="p">:</span> <span class="n">credentials</span><span class="p">,</span>
            <span class="s">'cached_at'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_session_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="s">"""Get information about cached session"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s">'cached_at'</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s">'cached_at'</span><span class="p">],</span>
                    <span class="s">'expires_at'</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s">'credentials'</span><span class="p">][</span><span class="s">'Expiration'</span><span class="p">],</span>
                    <span class="s">'assumed_role_arn'</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s">'credentials'</span><span class="p">][</span><span class="s">'AssumedRoleUser'</span><span class="p">][</span><span class="s">'Arn'</span><span class="p">]</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">revoke_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="s">"""Manually revoke cached session"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Revoked cached session: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Usage example
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">EnhancedSTSManager</span><span class="p">()</span>
    
    <span class="n">config</span> <span class="o">=</span> <span class="n">AssumeRoleConfig</span><span class="p">(</span>
        <span class="n">role_arn</span><span class="o">=</span><span class="s">'arn:aws:iam::111122223333:role/EKSAdminRole'</span><span class="p">,</span>
        <span class="n">session_name</span><span class="o">=</span><span class="sa">f</span><span class="s">'enhanced-session-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
        <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
        <span class="n">external_id</span><span class="o">=</span><span class="s">'unique-external-id-2024'</span>
    <span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">assume_role</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">mfa_token</span><span class="o">=</span><span class="s">'123456'</span><span class="p">)</span>
        
        <span class="c1"># Use credentials to create service clients
</span>        <span class="n">eks_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s">'eks'</span><span class="p">,</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'AccessKeyId'</span><span class="p">],</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'SecretAccessKey'</span><span class="p">],</span>
            <span class="n">aws_session_token</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s">'SessionToken'</span><span class="p">],</span>
            <span class="n">region_name</span><span class="o">=</span><span class="s">'us-west-2'</span>
        <span class="p">)</span>
        
        <span class="c1"># Your EKS operations here
</span>        <span class="n">clusters</span> <span class="o">=</span> <span class="n">eks_client</span><span class="p">.</span><span class="n">list_clusters</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="s">'clusters'</span><span class="p">])</span><span class="si">}</span><span class="s"> EKS clusters"</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to assume role: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h3 id="reference-and-additional-resources">Reference and Additional Resources</h3>
<ul>
  <li><a href="https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html">AWS STS Documentation</a></li>
  <li><a href="https://linuxbeast.com/blog/how-to-set-up-cross-account-access-in-aws-with-assumerole/">AWS Cross-Account Access Guide</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html">AWS IAM Role Delegation</a></li>
  <li><a href="https://cloudstudio.com.au/2021/06/06/aws-assumerole/">AWS AssumeRole Deep Dive</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html">OIDC Federation with AWS</a></li>
  <li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services">GitHub OIDC Integration with AWS</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#use-roles">AWS Security Token Service Best Practices</a></li>
  <li><a href="https://policysim.aws.amazon.com/">AWS IAM Policy Simulator</a></li>
  <li><a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/">AWS CloudTrail User Guide</a></li>
  <li><a href="https://docs.aws.amazon.com/config/latest/developerguide/iam-rules.html">AWS Config Rules for IAM</a></li>
</ul>

<h3 id="enterprise-adoption-checklist">Enterprise Adoption Checklist</h3>

<div class="info-box info-box-default-not-check">
<br />
<strong>Phase 1: Foundation (Weeks 1-2)</strong><br />
☐ Establish AWS Organizations structure<br />
☐ Define role naming conventions and tagging strategy<br />
☐ Create central identity account (hub-and-spoke model)<br />
☐ Enable CloudTrail in all accounts<br />
☐ Set up basic cross-account roles<br /><br />

<strong>Phase 2: Security Hardening (Weeks 3-4)</strong><br />
☐ Implement MFA requirements for all role assumptions<br />
☐ Add IP restrictions and geographic controls<br />
☐ Deploy permission boundaries<br />
☐ Configure AWS Config rules for compliance<br />
☐ Set up CloudWatch alarms for suspicious activities<br /><br />

<strong>Phase 3: Automation (Weeks 5-6)</strong><br />
☐ Deploy Infrastructure as Code for role management<br />
☐ Implement automated compliance checking<br />
☐ Create self-service role request portal<br />
☐ Set up just-in-time access workflows<br />
☐ Deploy credential caching solutions<br /><br />

<strong>Phase 4: Advanced Features (Weeks 7-8)</strong><br />
☐ Implement break-glass procedures<br />
☐ Deploy advanced monitoring and alerting<br />
☐ Create emergency response runbooks<br />
☐ Establish regular access review processes<br />
☐ Integrate with existing identity providers<br /><br />

<strong>Ongoing Maintenance</strong><br />
☐ Regular role and permission audits<br />
☐ Security awareness training for teams<br />
☐ Performance monitoring and optimization<br />
☐ Threat model updates and security reviews<br />
☐ Documentation and procedure updates<br />
</div>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/data-engineering/oltp-olap/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755575326/oltp-olap_gqmvnx.png">
                                    
                                    <h3>Large-Scale Data Processing and Data Architecture Design</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/virtualization/kvm-nested/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755588581/kvm-nested_efue7m.png">
                                    
                                    <h3>KVM Nested Virtualization Complete Guide</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/data-engineering/data-flow-etl/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755575394/data-etl-1_sjgszi.png">
                                    
                                    <h3>Data ETL Pipeline Components and Architecture Guide</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="39">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/gcp/bigquery/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1738662164/gcp-bigquery_st2xfc.png">
                
            </div>
            <h3 class="title">What is BigQuery & Data Warehouse?</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;A comprehensive guide to AWS Assume Role with advanced patterns, automation, and enterprise-grade security implementations&quot;%20https://somaz.blog/category/aws/aws-assume-role/%20via%20&#64;twitter_username&hashtags=aws,iam,security,authentication,sts,cross-account,automation,enterprise,devops,terraform"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/aws/aws-assume-role/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/aws/aws-assume-role/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Advanced AWS Assume Role Patterns & Enterprise Security Best Practices",
            "headline": "",
            "description": "A comprehensive guide to AWS Assume Role with advanced patterns, automation, and enterprise-grade security implementations",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1737423759/aws-assume-role_wtm7on.png",
            "url": "https://somaz.blog/category/aws/aws-assume-role/",
            "articleBody": "image reference link





Overview
AWS Assume Role is a fundamental security feature that enables temporary, controlled access to AWS resources across accounts or within the same account.

This comprehensive guide covers advanced patterns, automation strategies, and enterprise-grade security implementations for production environments.

What is AWS Assume Role?

AWS Assume Role is a function provided by AWS Security Token Service (STS) that allows one IAM entity (user or service) to temporarily adopt another role in AWS and use the permissions associated with that role.

This mechanism enhances security and simplifies access management by granting only the necessary permissions for the duration required to complete specific tasks.



The sts:AssumeRole operation enables a secure delegation model where:


  Temporary access: Credentials expire after a specified duration (15 minutes to 12 hours)
  No sharing of long-term credentials: Eliminates the need to share permanent IAM credentials
  Granular permissions: Access can be restricted based on session policies, source IP, and more
  Centralized management: Simplifies permission management across multiple accounts
  Audit trail: Complete visibility into who assumed what role and when
  Zero-trust architecture: Supports least-privilege access principles


Advanced Use Cases


  Cross-account access: Access resources in another AWS account without creating and managing users in that account
  Multi-tenant architectures: Isolate customer data while maintaining operational efficiency
  Break-glass procedures: Emergency access with proper approval workflows
  Service-to-service authentication: Secure communication between microservices
  Time-bound privileged access: Temporary elevated permissions for specific tasks
  Compliance and auditing: Meet regulatory requirements with detailed access logs
  Zero-downtime credential rotation: Update access without service interruption




How AWS Assume Role Works




  Trust relationship: The target role specifies which entities (principals) can assume it
  Permission check: The assuming entity must have permission to call the sts:AssumeRole action
  STS call: The entity calls the AssumeRole API with the role ARN and optional parameters
  Temporary credentials: STS returns temporary security credentials (access key, secret key, session token)
  Using credentials: Applications use these credentials to make AWS API calls with the role’s permissions




Enterprise-Grade Role Architecture Patterns

1. Hub-and-Spoke Model

Central Security Account (Hub)
├── Identity Management
├── Audit &amp;amp; Compliance
├── Emergency Access Roles
└── Cross-Account Trust Relationships

Spoke Accounts
├── Production Account
├── Development Account
├── Testing Account
└── Shared Services Account


Implementation Strategy:

  Central identity account manages all user identities
  Each spoke account trusts the hub account
  Role assumption flows through the hub for centralized auditing
  Consistent naming conventions across all accounts


2. Layered Security Model

{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;AssumeRoleWithMFA&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;AWS&quot;: &quot;arn:aws:iam::CENTRAL-ACCOUNT:root&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Condition&quot;: {
        &quot;Bool&quot;: {
          &quot;aws:MultiFactorAuthPresent&quot;: &quot;true&quot;
        },
        &quot;NumericLessThan&quot;: {
          &quot;aws:MultiFactorAuthAge&quot;: &quot;3600&quot;
        },
        &quot;StringEquals&quot;: {
          &quot;aws:PrincipalTag/Department&quot;: [&quot;DevOps&quot;, &quot;Security&quot;],
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;, &quot;us-east-1&quot;]
        },
        &quot;IpAddress&quot;: {
          &quot;aws:SourceIp&quot;: [&quot;203.0.113.0/24&quot;, &quot;198.51.100.0/24&quot;]
        },
        &quot;StringLike&quot;: {
          &quot;aws:userid&quot;: &quot;AIDAI*:${aws:username}&quot;
        }
      }
    }
  ]
}


3. Just-In-Time (JIT) Access Pattern

Automated Approval Workflow:

import boto3
import json
from datetime import datetime, timedelta

class JITAccessManager:
    def __init__(self):
        self.sts = boto3.client(&apos;sts&apos;)
        self.iam = boto3.client(&apos;iam&apos;)
        self.sns = boto3.client(&apos;sns&apos;)
        
    def request_elevated_access(self, requestor, role_arn, duration_hours, justification):
        &quot;&quot;&quot;Request temporary elevated access with approval workflow&quot;&quot;&quot;
        
        # Create temporary policy for specific duration
        temp_policy = {
            &quot;Version&quot;: &quot;2012-10-17&quot;,
            &quot;Statement&quot;: [
                {
                    &quot;Effect&quot;: &quot;Allow&quot;,
                    &quot;Principal&quot;: {&quot;AWS&quot;: f&quot;arn:aws:iam::{self.get_account_id()}:user/{requestor}&quot;},
                    &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
                    &quot;Resource&quot;: role_arn,
                    &quot;Condition&quot;: {
                        &quot;DateLessThan&quot;: {
                            &quot;aws:CurrentTime&quot;: (datetime.utcnow() + timedelta(hours=duration_hours)).isoformat()
                        }
                    }
                }
            ]
        }
        
        # Send approval request
        approval_request = {
            &quot;requestor&quot;: requestor,
            &quot;role_arn&quot;: role_arn,
            &quot;duration&quot;: duration_hours,
            &quot;justification&quot;: justification,
            &quot;timestamp&quot;: datetime.utcnow().isoformat(),
            &quot;policy&quot;: temp_policy
        }
        
        self.sns.publish(
            TopicArn=&apos;arn:aws:sns:region:account:jit-access-requests&apos;,
            Message=json.dumps(approval_request),
            Subject=f&apos;JIT Access Request: {requestor} -&amp;gt; {role_arn}&apos;
        )
        
        return approval_request
    
    def approve_access_request(self, request_id, approver):
        &quot;&quot;&quot;Approve and implement temporary access&quot;&quot;&quot;
        # Implementation for approval workflow
        pass


Advanced Automation with Infrastructure as Code

Terraform Module for Cross-Account Roles

# modules/cross-account-role/main.tf
variable &quot;account_id&quot; {
  description = &quot;Account ID that can assume this role&quot;
  type        = string
}

variable &quot;role_name&quot; {
  description = &quot;Name of the role to create&quot;
  type        = string
}

variable &quot;policies&quot; {
  description = &quot;List of policy ARNs to attach&quot;
  type        = list(string)
  default     = []
}

variable &quot;max_session_duration&quot; {
  description = &quot;Maximum session duration in seconds&quot;
  type        = number
  default     = 3600
}

variable &quot;require_mfa&quot; {
  description = &quot;Require MFA for role assumption&quot;
  type        = bool
  default     = true
}

variable &quot;allowed_principals&quot; {
  description = &quot;List of principals allowed to assume this role&quot;
  type        = list(string)
}

data &quot;aws_iam_policy_document&quot; &quot;trust_policy&quot; {
  statement {
    effect = &quot;Allow&quot;
    
    principals {
      type        = &quot;AWS&quot;
      identifiers = var.allowed_principals
    }
    
    actions = [&quot;sts:AssumeRole&quot;]
    
    dynamic &quot;condition&quot; {
      for_each = var.require_mfa ? [1] : []
      content {
        test     = &quot;Bool&quot;
        variable = &quot;aws:MultiFactorAuthPresent&quot;
        values   = [&quot;true&quot;]
      }
    }
    
    condition {
      test     = &quot;StringEquals&quot;
      variable = &quot;aws:RequestedRegion&quot;
      values   = [&quot;us-west-2&quot;, &quot;us-east-1&quot;]
    }
  }
}

resource &quot;aws_iam_role&quot; &quot;cross_account_role&quot; {
  name                 = var.role_name
  assume_role_policy   = data.aws_iam_policy_document.trust_policy.json
  max_session_duration = var.max_session_duration
  
  tags = {
    ManagedBy   = &quot;terraform&quot;
    Purpose     = &quot;cross-account-access&quot;
    Environment = terraform.workspace
  }
}

resource &quot;aws_iam_role_policy_attachment&quot; &quot;policies&quot; {
  count      = length(var.policies)
  role       = aws_iam_role.cross_account_role.name
  policy_arn = var.policies[count.index]
}

# CloudTrail for auditing
resource &quot;aws_cloudtrail&quot; &quot;role_audit&quot; {
  name           = &quot;${var.role_name}-audit-trail&quot;
  s3_bucket_name = aws_s3_bucket.audit_logs.bucket
  
  event_selector {
    read_write_type           = &quot;All&quot;
    include_management_events = true
    
    data_resource {
      type   = &quot;AWS::S3::Object&quot;
      values = [&quot;arn:aws:s3:::${aws_s3_bucket.audit_logs.bucket}/*&quot;]
    }
  }
  
  insight_selector {
    insight_type = &quot;ApiCallRateInsight&quot;
  }
}

output &quot;role_arn&quot; {
  description = &quot;ARN of the created role&quot;
  value       = aws_iam_role.cross_account_role.arn
}


AWS CLI Wrapper Script for Enhanced Security





Advanced Monitoring and Alerting

CloudWatch Dashboards for Role Usage





Advanced EventBridge Rules for Security Alerts

import boto3
import json

def create_security_monitoring():
    events = boto3.client(&apos;events&apos;)
    sns = boto3.client(&apos;sns&apos;)
    
    # Rule for suspicious role assumptions
    suspicious_pattern = {
        &quot;source&quot;: [&quot;aws.sts&quot;],
        &quot;detail-type&quot;: [&quot;AWS API Call via CloudTrail&quot;],
        &quot;detail&quot;: {
            &quot;eventSource&quot;: [&quot;sts.amazonaws.com&quot;],
            &quot;eventName&quot;: [&quot;AssumeRole&quot;],
            &quot;errorCode&quot;: {&quot;exists&quot;: False},
            &quot;sourceIPAddress&quot;: {
                &quot;anything-but&quot;: {
                    &quot;prefix&quot;: [&quot;10.&quot;, &quot;172.16.&quot;, &quot;192.168.&quot;]
                }
            }
        }
    }
    
    events.put_rule(
        Name=&apos;SuspiciousRoleAssumption&apos;,
        EventPattern=json.dumps(suspicious_pattern),
        State=&apos;ENABLED&apos;,
        Description=&apos;Alert on role assumptions from external IPs&apos;
    )
    
    # Rule for failed role assumptions
    failure_pattern = {
        &quot;source&quot;: [&quot;aws.sts&quot;],
        &quot;detail-type&quot;: [&quot;AWS API Call via CloudTrail&quot;],
        &quot;detail&quot;: {
            &quot;eventSource&quot;: [&quot;sts.amazonaws.com&quot;],
            &quot;eventName&quot;: [&quot;AssumeRole&quot;],
            &quot;errorCode&quot;: {&quot;exists&quot;: True}
        }
    }
    
    events.put_rule(
        Name=&apos;FailedRoleAssumption&apos;,
        EventPattern=json.dumps(failure_pattern),
        State=&apos;ENABLED&apos;,
        Description=&apos;Alert on failed role assumption attempts&apos;
    )

def lambda_security_handler(event, context):
    &quot;&quot;&quot;Lambda function to process security events and send alerts&quot;&quot;&quot;
    
    detail = event[&apos;detail&apos;]
    event_name = detail.get(&apos;eventName&apos;)
    source_ip = detail.get(&apos;sourceIPAddress&apos;)
    user_identity = detail.get(&apos;userIdentity&apos;, {})
    
    # Analyze the event
    risk_score = calculate_risk_score(detail)
    
    if risk_score &amp;gt; 70:  # High risk threshold
        send_security_alert(detail, risk_score)
        
        # Optionally, automatically revoke the session
        if risk_score &amp;gt; 90:
            revoke_active_sessions(user_identity)
    
    return {&apos;statusCode&apos;: 200}

def calculate_risk_score(detail):
    &quot;&quot;&quot;Calculate risk score based on various factors&quot;&quot;&quot;
    score = 0
    
    # Check source IP reputation
    if is_suspicious_ip(detail.get(&apos;sourceIPAddress&apos;)):
        score += 30
    
    # Check time of access
    if is_unusual_time(detail.get(&apos;eventTime&apos;)):
        score += 20
    
    # Check role sensitivity
    role_arn = detail.get(&apos;requestParameters&apos;, {}).get(&apos;roleArn&apos;, &apos;&apos;)
    if &apos;Admin&apos; in role_arn or &apos;Root&apos; in role_arn:
        score += 25
    
    # Check user behavior anomaly
    if is_anomalous_behavior(detail):
        score += 25
    
    return score


Detailed Example: Cross-Account EKS Access with Enhanced Security

The following example demonstrates how to use AssumeRole to grant Account A access to EKS resources in Account B with production-grade security controls.

Step 1: Create Advanced IAM Role in Account B (Target Account)

Create an IAM role with comprehensive security controls and conditions.



Enhanced Trust Policy with Multiple Security Layers:
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;CrossAccountAssumeRole&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;AWS&quot;: [
          &quot;arn:aws:iam::123456789012:role/DevOpsTeamRole&quot;,
          &quot;arn:aws:iam::123456789012:role/SecurityTeamRole&quot;
        ]
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Condition&quot;: {
        &quot;Bool&quot;: {
          &quot;aws:MultiFactorAuthPresent&quot;: &quot;true&quot;
        },
        &quot;NumericLessThan&quot;: {
          &quot;aws:MultiFactorAuthAge&quot;: &quot;1800&quot;
        },
        &quot;StringEquals&quot;: {
          &quot;aws:PrincipalTag/Department&quot;: [&quot;DevOps&quot;, &quot;Security&quot;],
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;, &quot;us-east-1&quot;],
          &quot;sts:ExternalId&quot;: &quot;unique-external-id-2024&quot;
        },
        &quot;IpAddress&quot;: {
          &quot;aws:SourceIp&quot;: [
            &quot;203.0.113.0/24&quot;,
            &quot;198.51.100.0/24&quot;
          ]
        },
        &quot;DateGreaterThan&quot;: {
          &quot;aws:CurrentTime&quot;: &quot;2024-01-01T00:00:00Z&quot;
        },
        &quot;DateLessThan&quot;: {
          &quot;aws:CurrentTime&quot;: &quot;2025-12-31T23:59:59Z&quot;
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;EmergencyAccess&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;AWS&quot;: &quot;arn:aws:iam::123456789012:role/BreakGlassRole&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Condition&quot;: {
        &quot;Bool&quot;: {
          &quot;aws:MultiFactorAuthPresent&quot;: &quot;true&quot;
        },
        &quot;StringEquals&quot;: {
          &quot;aws:PrincipalTag/EmergencyAccess&quot;: &quot;true&quot;
        }
      }
    }
  ]
}




Granular Permission Policy with Resource-Level Controls:
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;EKSClusterManagement&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;eks:DescribeCluster&quot;,
        &quot;eks:ListClusters&quot;,
        &quot;eks:DescribeNodegroup&quot;,
        &quot;eks:ListNodegroups&quot;,
        &quot;eks:DescribeUpdate&quot;,
        &quot;eks:ListUpdates&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:eks:*:111122223333:cluster/prod-*&quot;,
        &quot;arn:aws:eks:*:111122223333:cluster/staging-*&quot;
      ],
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;, &quot;us-east-1&quot;]
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;EKSConfigurationUpdates&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;eks:UpdateClusterConfig&quot;,
        &quot;eks:UpdateClusterVersion&quot;,
        &quot;eks:UpdateNodegroupConfig&quot;,
        &quot;eks:UpdateNodegroupVersion&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:eks:*:111122223333:cluster/staging-*&quot;,
        &quot;arn:aws:eks:*:111122223333:nodegroup/staging-*/*/*&quot;
      ],
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;],
          &quot;aws:PrincipalTag/Role&quot;: &quot;DevOps&quot;
        },
        &quot;Bool&quot;: {
          &quot;aws:MultiFactorAuthPresent&quot;: &quot;true&quot;
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;ProductionReadOnly&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;eks:DescribeCluster&quot;,
        &quot;eks:ListClusters&quot;,
        &quot;eks:DescribeNodegroup&quot;,
        &quot;eks:ListNodegroups&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:eks:*:111122223333:cluster/prod-*&quot;
      ],
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;aws:PrincipalTag/ProductionAccess&quot;: &quot;read-only&quot;
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;CloudWatchLogs&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;logs:DescribeLogGroups&quot;,
        &quot;logs:DescribeLogStreams&quot;,
        &quot;logs:GetLogEvents&quot;,
        &quot;logs:FilterLogEvents&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:logs:*:111122223333:log-group:/aws/eks/*&quot;
      ]
    }
  ]
}




Permission Boundary for Additional Security:
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;PermissionBoundary&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;eks:*&quot;,
        &quot;ec2:DescribeInstances&quot;,
        &quot;ec2:DescribeSecurityGroups&quot;,
        &quot;ec2:DescribeSubnets&quot;,
        &quot;ec2:DescribeVpcs&quot;,
        &quot;iam:ListRoles&quot;,
        &quot;iam:PassRole&quot;,
        &quot;logs:*&quot;
      ],
      &quot;Resource&quot;: &quot;*&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;, &quot;us-east-1&quot;]
        }
      }
    },
    {
      &quot;Sid&quot;: &quot;DenyDangerousActions&quot;,
      &quot;Effect&quot;: &quot;Deny&quot;,
      &quot;Action&quot;: [
        &quot;eks:DeleteCluster&quot;,
        &quot;eks:DeleteNodegroup&quot;,
        &quot;iam:DeleteRole&quot;,
        &quot;iam:DeletePolicy&quot;,
        &quot;iam:DetachRolePolicy&quot;
      ],
      &quot;Resource&quot;: &quot;*&quot;,
      &quot;Condition&quot;: {
        &quot;StringNotEquals&quot;: {
          &quot;aws:PrincipalTag/CanDelete&quot;: &quot;true&quot;
        }
      }
    }
  ]
}




Step 2: Create IAM Policy in Account A (Source Account)

Create and attach an IAM policy to the users or roles in Account A that need to assume the role in Account B.



Example Policy (in Account A):
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
      &quot;Resource&quot;: &quot;arn:aws:iam::111122223333:role/EKSAdminRole&quot;,
      &quot;Condition&quot;: {
        &quot;StringLike&quot;: {
          &quot;aws:RequestedRegion&quot;: [
            &quot;us-west-2&quot;,
            &quot;us-east-1&quot;
          ]
        }
      }
    }
  ]
}




Step 3: Assume Role from Account A

A user or service in Account A can now assume the role in Account B using the AWS CLI, SDK, or AWS console.



Using AWS CLI:







This command returns a JSON object containing:

  AccessKeyId
  SecretAccessKey
  SessionToken
  Expiration timestamp




Using AWS SDK (Python example):

import boto3

# Create an STS client
sts_client = boto3.client(&apos;sts&apos;)

# Assume the role
assumed_role = sts_client.assume_role(
    RoleArn=&apos;arn:aws:iam::111122223333:role/EKSAdminRole&apos;,
    RoleSessionName=&apos;EKSAdminSession&apos;,
    DurationSeconds=3600  # 1 hour
)

# Extract the temporary credentials
credentials = assumed_role[&apos;Credentials&apos;]

# Create an EKS client using the temporary credentials
eks_client = boto3.client(
    &apos;eks&apos;,
    region_name=&apos;us-west-2&apos;,
    aws_access_key_id=credentials[&apos;AccessKeyId&apos;],
    aws_secret_access_key=credentials[&apos;SecretAccessKey&apos;],
    aws_session_token=credentials[&apos;SessionToken&apos;]
)

# Now you can make EKS API calls
clusters = eks_client.list_clusters()
print(clusters)




Step 4: Use Temporary Credentials for Access

These temporary credentials can be used to access EKS resources in Account B. Here’s an example of updating your kubeconfig:







You can also create a shell profile that automatically assumes the role:

# Add to your ~/.bash_profile or ~/.zshrc
function assume-eks-role() {
  output=$(aws sts assume-role --role-arn arn:aws:iam::111122223333:role/EKSAdminRole --role-session-name EKSSession)
  export AWS_ACCESS_KEY_ID=$(echo $output | jq -r &apos;.Credentials.AccessKeyId&apos;)
  export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r &apos;.Credentials.SecretAccessKey&apos;)
  export AWS_SESSION_TOKEN=$(echo $output | jq -r &apos;.Credentials.SessionToken&apos;)
  echo &quot;Temporary credentials set for EKS admin role&quot;
}






What is sts:AssumeRoleWithWebIdentity?


  The sts:AssumeRoleWithWebIdentity operation allows you to obtain temporary AWS credentials by using an OpenID Connect (OIDC) token or SAML 2.0 assertion from an external identity provider.


This mechanism enables federating AWS access with external identity systems without requiring AWS IAM users for each identity.

Key Benefits


  No IAM users needed: Eliminates the need to create IAM users for each external identity
  Centralized identity management: Use your existing identity provider
  Zero IAM credentials: No long-term AWS credentials to manage or rotate
  Auditable access: All access is logged in AWS CloudTrail with the original identity information


Common Use Cases


  GitHub Actions: Authenticate GitHub workflows to access AWS resources
  Kubernetes Service Accounts: Allow pods to access AWS services securely
  Web/Mobile Applications: Allow authenticated application users to access AWS resources directly
  Enterprise SSO: Enable employees to access AWS using their corporate credentials
  Self-developed applications: Authenticate custom applications with your own OIDC provider


Process Flow


  OIDC Provider Configuration: Register an OIDC provider in IAM and create a role with a trust policy
  Identity Authentication: User/service authenticates with the external IdP and receives an OIDC token
  AWS API Call: Application calls AssumeRoleWithWebIdentity API with the OIDC token
  Token Verification: AWS verifies the token with the configured OIDC provider
  Temporary Credentials: Upon successful verification, AWS issues temporary credentials


Example: GitHub Actions Integration



IAM OIDC Provider Configuration:
aws iam create-open-id-connect-provider --url https://token.actions.githubusercontent.com --client-id-list sts.amazonaws.com --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1




Role Trust Policy:
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;token.actions.githubusercontent.com:aud&quot;: &quot;sts.amazonaws.com&quot;,
          &quot;token.actions.githubusercontent.com:sub&quot;: &quot;repo:your-org/your-repo:ref:refs/heads/main&quot;
        }
      }
    }
  ]
}




GitHub Actions Workflow:
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsRole
          aws-region: us-east-1
      
      - name: Deploy infrastructure
        run: aws cloudformation deploy --template-file template.yaml --stack-name my-stack




Comparison: AssumeRole vs AssumeRoleWithWebIdentity vs AssumeRoleWithSAML

Authentication:

  sts:AssumeRole: AWS IAM credentials
  sts:AssumeRoleWithWebIdentity: OIDC token
  sts:AssumeRoleWithSAML: SAML 2.0 assertion


Identity Source:

  sts:AssumeRole: AWS IAM
  sts:AssumeRoleWithWebIdentity: External OIDC providers (Google, GitHub, etc.)
  sts:AssumeRoleWithSAML: SAML IdPs (Active Directory, Okta, etc.)


Primary Use Cases:

  sts:AssumeRole: Cross-account access, delegation within AWS
  sts:AssumeRoleWithWebIdentity: Mobile/web apps, CI/CD pipelines, Kubernetes
  sts:AssumeRoleWithSAML: Enterprise SSO, workforce identity federation


Required Setup:

  sts:AssumeRole: IAM roles and policies
  sts:AssumeRoleWithWebIdentity: OIDC provider + IAM role
  sts:AssumeRoleWithSAML: SAML provider + IAM role


Credential Duration:

  sts:AssumeRole: 15 min - 12 hours
  sts:AssumeRoleWithWebIdentity: 15 min - 12 hours
  sts:AssumeRoleWithSAML: 15 min - 12 hours


Common Examples:

  sts:AssumeRole: AWS CLI, AWS console
  sts:AssumeRoleWithWebIdentity: GitHub Actions, Kubernetes ServiceAccounts
  sts:AssumeRoleWithSAML: AWS Console login via corporate SSO




Advanced Best Practices for Enterprise AWS Assume Role



1. Security Architecture:

  Implement defense-in-depth with multiple conditional layers
  Use permission boundaries to limit maximum permissions
  Enforce MFA with time-based conditions (MFA age &amp;lt; 30 minutes)
  Implement IP allowlisting and geographic restrictions
  Use external IDs for third-party access to prevent confused deputy attacks
  Implement role chaining limits and session duration policies


2. Automation and Operations:

  Use Infrastructure as Code (Terraform/CloudFormation) for consistent role deployment
  Implement automated role lifecycle management
  Create self-service portals for role requests with approval workflows
  Establish break-glass procedures with proper audit trails
  Implement just-in-time (JIT) access with time-bound permissions
  Use AWS Config rules to monitor role configuration drift


3. Monitoring and Compliance:

  Enable comprehensive CloudTrail logging with log file validation
  Implement real-time alerting for suspicious role assumption patterns
  Use AWS GuardDuty for behavioral analysis and threat detection
  Create custom CloudWatch metrics for role usage analytics
  Implement automated compliance checks with AWS Security Hub
  Use IAM Access Analyzer for unused and over-privileged role detection


4. Governance and Risk Management:

  Establish role naming conventions and tagging strategies
  Implement regular access reviews and role audits
  Use AWS Organizations SCPs as guardrails
  Create role templates for common use cases
  Implement risk-based access controls with conditional policies
  Establish incident response procedures for compromised roles


5. Performance and Scalability:

  Implement credential caching to reduce STS API calls
  Use regional STS endpoints for reduced latency
  Implement retry logic with exponential backoff
  Monitor STS API throttling and adjust application behavior
  Use session tags for enhanced authorization decisions
  Implement efficient credential refresh mechanisms





Enterprise Role Patterns and Anti-Patterns

Recommended Patterns



1. Principle of Least Privilege with Session Policies:
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: &quot;s3:GetObject&quot;,
      &quot;Resource&quot;: &quot;arn:aws:s3:::my-bucket/user-${aws:userid}/*&quot;
    }
  ]
}




2. Time-Based Access Controls:
{
  &quot;Condition&quot;: {
    &quot;DateGreaterThan&quot;: {
      &quot;aws:CurrentTime&quot;: &quot;2024-01-01T09:00:00Z&quot;
    },
    &quot;DateLessThan&quot;: {
      &quot;aws:CurrentTime&quot;: &quot;2024-01-01T17:00:00Z&quot;
    },
    &quot;ForAllValues:StringEquals&quot;: {
      &quot;aws:RequestedRegion&quot;: [&quot;us-west-2&quot;]
    }
  }
}




3. Emergency Access Pattern:
def create_emergency_access_role():
    &quot;&quot;&quot;Create break-glass role with temporary elevated permissions&quot;&quot;&quot;
    
    trust_policy = {
        &quot;Version&quot;: &quot;2012-10-17&quot;,
        &quot;Statement&quot;: [
            {
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Principal&quot;: {&quot;AWS&quot;: f&quot;arn:aws:iam::{ACCOUNT_ID}:role/EmergencyAccessRole&quot;},
                &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
                &quot;Condition&quot;: {
                    &quot;Bool&quot;: {&quot;aws:MultiFactorAuthPresent&quot;: &quot;true&quot;},
                    &quot;StringEquals&quot;: {&quot;aws:PrincipalTag/EmergencyAccess&quot;: &quot;approved&quot;},
                    &quot;NumericLessThan&quot;: {&quot;aws:MultiFactorAuthAge&quot;: &quot;900&quot;}  # 15 minutes
                }
            }
        ]
    }
    
    # Create role with temporary permissions
    # Automatically expire after 2 hours


Anti-Patterns to Avoid



1. Overly Permissive Trust Policies:
// DON&apos;T DO THIS
{
  &quot;Effect&quot;: &quot;Allow&quot;,
  &quot;Principal&quot;: {&quot;AWS&quot;: &quot;*&quot;},
  &quot;Action&quot;: &quot;sts:AssumeRole&quot;
}




2. Long-Lived Sessions Without Conditions:
// DON&apos;T DO THIS
{
  &quot;Effect&quot;: &quot;Allow&quot;,
  &quot;Principal&quot;: {&quot;AWS&quot;: &quot;arn:aws:iam::123456789012:root&quot;},
  &quot;Action&quot;: &quot;sts:AssumeRole&quot;
  // No conditions = unlimited access
}




3. Credential Hardcoding:
# DON&apos;T DO THIS
AWS_ACCESS_KEY_ID = &quot;AKIA...&quot;
AWS_SECRET_ACCESS_KEY = &quot;secret...&quot;

# DO THIS INSTEAD
credentials = sts_client.assume_role(...)




Advanced Troubleshooting and Diagnostics



1. Access Denied Issues (Enhanced Diagnostics):

  Use AWS CLI with --debug flag to see detailed API responses
  Check CloudTrail for specific error codes and failure reasons
  Validate all condition keys in trust policies
  Test with AWS IAM Policy Simulator for permission validation
  Verify external ID requirements and case sensitivity
  Check for typos in role ARNs and account IDs


2. Session and Token Management:

  Monitor credential expiration with automated renewal
  Implement exponential backoff for STS API rate limiting
  Handle token refresh gracefully in long-running applications
  Use AWS SDKs&apos; built-in credential providers when possible
  Implement circuit breakers for STS endpoint failures


3. OIDC/SAML Federation Troubleshooting:

  Validate OIDC provider thumbprint matches current certificate
  Check token claims structure and required audience values
  Verify clock synchronization between systems
  Test token validation with online JWT decoders
  Monitor for certificate rotation and update schedules


4. Performance and Reliability Issues:

  Implement caching strategies for frequently used credentials
  Use regional STS endpoints to reduce latency
  Monitor STS API quotas and request patterns
  Implement health checks for role assumption workflows
  Use CloudWatch metrics to track assumption success rates


5. Security Incident Response:

  Create runbooks for compromised role scenarios
  Implement automated session revocation capabilities
  Set up real-time alerting for anomalous access patterns
  Use AWS Config to detect unauthorized role modifications
  Maintain audit trails for forensic analysis



Production-Ready Code Examples

Advanced Session Management Class

import boto3
import json
import time
from datetime import datetime, timedelta
from botocore.exceptions import ClientError, BotoCoreError
import logging
from typing import Dict, Optional, Any
import threading
from dataclasses import dataclass

@dataclass
class AssumeRoleConfig:
    role_arn: str
    session_name: str
    duration_seconds: int = 3600
    external_id: Optional[str] = None
    session_policy: Optional[str] = None
    mfa_serial: Optional[str] = None
    region: str = &apos;us-east-1&apos;

class EnhancedSTSManager:
    &quot;&quot;&quot;Enterprise-grade STS session manager with caching and error handling&quot;&quot;&quot;
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self._sessions: Dict[str, Dict[str, Any]] = {}
        self._lock = threading.RLock()
        self.sts_client = boto3.client(&apos;sts&apos;)
        
    def assume_role(self, config: AssumeRoleConfig, mfa_token: Optional[str] = None) -&amp;gt; Dict[str, Any]:
        &quot;&quot;&quot;Assume role with comprehensive error handling and caching&quot;&quot;&quot;
        
        cache_key = self._generate_cache_key(config)
        
        with self._lock:
            # Check cache first
            if self._is_cached_session_valid(cache_key):
                self.logger.info(f&quot;Using cached credentials for {config.role_arn}&quot;)
                return self._sessions[cache_key][&apos;credentials&apos;]
            
            try:
                credentials = self._perform_assume_role(config, mfa_token)
                self._cache_session(cache_key, credentials)
                return credentials
                
            except ClientError as e:
                self._handle_client_error(e, config)
                raise
            except Exception as e:
                self.logger.error(f&quot;Unexpected error assuming role: {str(e)}&quot;)
                raise
    
    def _perform_assume_role(self, config: AssumeRoleConfig, mfa_token: Optional[str] = None) -&amp;gt; Dict[str, Any]:
        &quot;&quot;&quot;Perform the actual assume role operation with retry logic&quot;&quot;&quot;
        
        assume_role_params = {
            &apos;RoleArn&apos;: config.role_arn,
            &apos;RoleSessionName&apos;: config.session_name,
            &apos;DurationSeconds&apos;: config.duration_seconds
        }
        
        # Add optional parameters
        if config.external_id:
            assume_role_params[&apos;ExternalId&apos;] = config.external_id
        
        if config.session_policy:
            assume_role_params[&apos;Policy&apos;] = config.session_policy
        
        if config.mfa_serial and mfa_token:
            assume_role_params[&apos;SerialNumber&apos;] = config.mfa_serial
            assume_role_params[&apos;TokenCode&apos;] = mfa_token
        
        # Retry logic with exponential backoff
        max_retries = 3
        base_delay = 1
        
        for attempt in range(max_retries):
            try:
                response = self.sts_client.assume_role(**assume_role_params)
                
                # Enhance credentials with metadata
                credentials = response[&apos;Credentials&apos;]
                credentials[&apos;AssumedRoleUser&apos;] = response[&apos;AssumedRoleUser&apos;]
                credentials[&apos;PackedPolicySize&apos;] = response.get(&apos;PackedPolicySize&apos;, 0)
                
                self.logger.info(f&quot;Successfully assumed role: {config.role_arn}&quot;)
                return credentials
                
            except ClientError as e:
                error_code = e.response[&apos;Error&apos;][&apos;Code&apos;]
                
                if error_code in [&apos;Throttling&apos;, &apos;RequestLimitExceeded&apos;] and attempt &amp;lt; max_retries - 1:
                    delay = base_delay * (2 ** attempt)
                    self.logger.warning(f&quot;Rate limited, retrying in {delay} seconds...&quot;)
                    time.sleep(delay)
                    continue
                else:
                    raise
    
    def _handle_client_error(self, error: ClientError, config: AssumeRoleConfig):
        &quot;&quot;&quot;Provide detailed error analysis and suggestions&quot;&quot;&quot;
        
        error_code = error.response[&apos;Error&apos;][&apos;Code&apos;]
        error_message = error.response[&apos;Error&apos;][&apos;Message&apos;]
        
        troubleshooting_guide = {
            &apos;AccessDenied&apos;: &quot;Check trust policy, ensure calling identity has sts:AssumeRole permission&quot;,
            &apos;InvalidParameterValue&apos;: &quot;Verify role ARN format and account ID&quot;,
            &apos;MalformedPolicyDocument&apos;: &quot;Review session policy JSON syntax&quot;,
            &apos;TokenRefreshRequired&apos;: &quot;MFA token expired, obtain new token&quot;,
            &apos;RegionDisabledException&apos;: &quot;STS not available in requested region&quot;
        }
        
        suggestion = troubleshooting_guide.get(error_code, &quot;Check AWS documentation for error code&quot;)
        
        self.logger.error(f&quot;AssumeRole failed: {error_code} - {error_message}&quot;)
        self.logger.error(f&quot;Suggestion: {suggestion}&quot;)
        self.logger.error(f&quot;Role ARN: {config.role_arn}&quot;)
    
    def _generate_cache_key(self, config: AssumeRoleConfig) -&amp;gt; str:
        &quot;&quot;&quot;Generate unique cache key for session&quot;&quot;&quot;
        return f&quot;{config.role_arn}:{config.session_name}:{config.duration_seconds}&quot;
    
    def _is_cached_session_valid(self, cache_key: str) -&amp;gt; bool:
        &quot;&quot;&quot;Check if cached session is still valid&quot;&quot;&quot;
        if cache_key not in self._sessions:
            return False
        
        session = self._sessions[cache_key]
        expiration = datetime.fromisoformat(session[&apos;credentials&apos;][&apos;Expiration&apos;].replace(&apos;Z&apos;, &apos;+00:00&apos;))
        
        # Consider session valid if more than 5 minutes remaining
        return datetime.now(expiration.tzinfo) &amp;lt; (expiration - timedelta(minutes=5))
    
    def _cache_session(self, cache_key: str, credentials: Dict[str, Any]):
        &quot;&quot;&quot;Cache session credentials&quot;&quot;&quot;
        self._sessions[cache_key] = {
            &apos;credentials&apos;: credentials,
            &apos;cached_at&apos;: datetime.utcnow()
        }
    
    def get_session_info(self, cache_key: str) -&amp;gt; Optional[Dict[str, Any]]:
        &quot;&quot;&quot;Get information about cached session&quot;&quot;&quot;
        with self._lock:
            if cache_key in self._sessions:
                session = self._sessions[cache_key]
                return {
                    &apos;cached_at&apos;: session[&apos;cached_at&apos;],
                    &apos;expires_at&apos;: session[&apos;credentials&apos;][&apos;Expiration&apos;],
                    &apos;assumed_role_arn&apos;: session[&apos;credentials&apos;][&apos;AssumedRoleUser&apos;][&apos;Arn&apos;]
                }
        return None
    
    def revoke_session(self, cache_key: str):
        &quot;&quot;&quot;Manually revoke cached session&quot;&quot;&quot;
        with self._lock:
            if cache_key in self._sessions:
                del self._sessions[cache_key]
                self.logger.info(f&quot;Revoked cached session: {cache_key}&quot;)

# Usage example
def main():
    manager = EnhancedSTSManager()
    
    config = AssumeRoleConfig(
        role_arn=&apos;arn:aws:iam::111122223333:role/EKSAdminRole&apos;,
        session_name=f&apos;enhanced-session-{int(time.time())}&apos;,
        duration_seconds=3600,
        external_id=&apos;unique-external-id-2024&apos;
    )
    
    try:
        credentials = manager.assume_role(config, mfa_token=&apos;123456&apos;)
        
        # Use credentials to create service clients
        eks_client = boto3.client(
            &apos;eks&apos;,
            aws_access_key_id=credentials[&apos;AccessKeyId&apos;],
            aws_secret_access_key=credentials[&apos;SecretAccessKey&apos;],
            aws_session_token=credentials[&apos;SessionToken&apos;],
            region_name=&apos;us-west-2&apos;
        )
        
        # Your EKS operations here
        clusters = eks_client.list_clusters()
        print(f&quot;Found {len(clusters[&apos;clusters&apos;])} EKS clusters&quot;)
        
    except Exception as e:
        logging.error(f&quot;Failed to assume role: {str(e)}&quot;)

if __name__ == &quot;__main__&quot;:
    logging.basicConfig(level=logging.INFO)
    main()






Reference and Additional Resources

  AWS STS Documentation
  AWS Cross-Account Access Guide
  AWS IAM Role Delegation
  AWS AssumeRole Deep Dive
  OIDC Federation with AWS
  GitHub OIDC Integration with AWS
  AWS Security Token Service Best Practices
  AWS IAM Policy Simulator
  AWS CloudTrail User Guide
  AWS Config Rules for IAM


Enterprise Adoption Checklist



Phase 1: Foundation (Weeks 1-2)
☐ Establish AWS Organizations structure
☐ Define role naming conventions and tagging strategy
☐ Create central identity account (hub-and-spoke model)
☐ Enable CloudTrail in all accounts
☐ Set up basic cross-account roles

Phase 2: Security Hardening (Weeks 3-4)
☐ Implement MFA requirements for all role assumptions
☐ Add IP restrictions and geographic controls
☐ Deploy permission boundaries
☐ Configure AWS Config rules for compliance
☐ Set up CloudWatch alarms for suspicious activities

Phase 3: Automation (Weeks 5-6)
☐ Deploy Infrastructure as Code for role management
☐ Implement automated compliance checking
☐ Create self-service role request portal
☐ Set up just-in-time access workflows
☐ Deploy credential caching solutions

Phase 4: Advanced Features (Weeks 7-8)
☐ Implement break-glass procedures
☐ Deploy advanced monitoring and alerting
☐ Create emergency response runbooks
☐ Establish regular access review processes
☐ Integrate with existing identity providers

Ongoing Maintenance
☐ Regular role and permission audits
☐ Security awareness training for teams
☐ Performance monitoring and optimization
☐ Threat model updates and security reviews
☐ Documentation and procedure updates

",
            "wordcount": "7050",
            "inLanguage": "en",
            "dateCreated": "2025-04-02/",
            "datePublished": "2025-04-02/",
            "dateModified": "2025-04-02/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "AWS",
            "articleSection": "AWS",
            "keywords": ["aws","iam","security","authentication","sts","cross-account","automation","enterprise","devops","terraform"]
        }
        </script>
    </body>
</html>
