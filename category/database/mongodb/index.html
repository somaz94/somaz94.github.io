<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>MongoDB: From Fundamentals to Production Excellence | somaz</title>
    <meta name="description" content="Master MongoDB from core concepts to production-ready implementations with advanced data modeling, performance optimization, and distributed system patterns">
    
        <meta name="keywords" content="mongodb, nosql, database, distributed-systems, performance, microservices, data-modeling">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MongoDB: From Fundamentals to Production Excellence | somaz">
    <meta name="twitter:description" content="Master MongoDB from core concepts to production-ready implementations with advanced data modeling, performance optimization, and distributed system patterns">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755739632/mongodb-1_zqkghg.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/database/mongodb/">
    <meta property="og:title" content="MongoDB: From Fundamentals to Production Excellence | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755739632/mongodb-1_zqkghg.png">
    <meta property="og:description" content="Master MongoDB from core concepts to production-ready implementations with advanced data modeling, performance optimization, and distributed system patterns">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/database/mongodb/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-01-27T00:00:00+00:00">
                            


January 27, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>75 min to read</span>
                </p>
                <h1 class="post-title">MongoDB: From Fundamentals to Production Excellence</h1>
                <p class="post-subtitle">Comprehensive guide to MongoDB architecture, advanced patterns, and enterprise deployment strategies</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1755739632/mongodb-1_zqkghg.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><br /></p>

<hr />

<h2 id="overview">Overview</h2>

<p>MongoDB has evolved from a simple document database to a comprehensive data platform powering modern applications at unprecedented scale.</p>

<p>As organizations embrace cloud-native architectures, microservices, and real-time analytics, MongoDB serves as the backbone for flexible, scalable data solutions.</p>

<p>This comprehensive guide explores MongoDB from foundational concepts to advanced production patterns, covering everything from document modeling principles to distributed system architectures.</p>

<p>Whether you’re architecting a new application, optimizing existing deployments, or implementing enterprise-grade MongoDB solutions, this guide provides the depth and practical insights needed for success.</p>

<p>Modern MongoDB deployments face complex challenges: multi-cloud distribution, real-time synchronization, security compliance, and operational excellence.</p>

<p>Understanding these challenges and implementing appropriate solutions distinguishes successful MongoDB implementations from basic deployments.</p>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      A[MongoDB Evolution] --&gt; B[Document Database<br />2009-2012]
      A --&gt; C[Distributed Platform<br />2013-2018]
      A --&gt; D[Cloud-Native Solution<br />2019-Present]
      
      B --&gt; B1[BSON Documents]
      B --&gt; B2[Dynamic Schema]
      B --&gt; B3[Simple Replication]
      
      C --&gt; C1[Sharding]
      C --&gt; C2[Aggregation Framework]
      C --&gt; C3[WiredTiger Engine]
      C --&gt; C4[ACID Transactions]
      
      D --&gt; D1[Atlas Cloud Platform]
      D --&gt; D2[Multi-Cloud Clusters]
      D --&gt; D3[Serverless Instances]
      D --&gt; D4[Vector Search]
      D --&gt; D5[Time Series Collections]
      
      style A fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
      style B fill:#fff3e0,stroke:#f57c00,stroke-width:2px
      style C fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style D fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
  </div>
</div>

<div class="diagram-caption">
  <p>MongoDB Evolution: From simple document storage to comprehensive cloud-native data platform</p>
</div>

<p><br /></p>

<hr />

<h2 id="mongodb-architecture-deep-dive">MongoDB Architecture Deep Dive</h2>

<p>MongoDB’s architecture is designed for horizontal scaling, high availability, and operational simplicity. Understanding its core components enables effective deployment strategies and optimization techniques.</p>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      A[MongoDB Cluster Architecture] --&gt; B[Replica Sets<br />High Availability]
      A --&gt; C[Sharded Clusters<br />Horizontal Scaling]
      A --&gt; D[Config Servers<br />Metadata Management]
      A --&gt; E[Query Routers<br />mongos]
      
      B --&gt; B1[Primary Node<br />Read/Write Operations]
      B --&gt; B2[Secondary Nodes<br />Data Replication]
      B --&gt; B3[Arbiter Nodes<br />Election Participation]
      B --&gt; B4[Hidden Members<br />Analytics/Backup]
      
      C --&gt; C1[Shard Key Selection]
      C --&gt; C2[Chunk Distribution]
      C --&gt; C3[Balancer Process]
      C --&gt; C4[Zone Sharding]
      
      D --&gt; D1[Cluster Metadata]
      D --&gt; D2[Shard Mapping]
      D --&gt; D3[Balancer State]
      
      E --&gt; E1[Query Routing]
      E --&gt; E2[Load Distribution]
      E --&gt; E3[Connection Pooling]
      
      style A fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
      style B fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style C fill:#fff3e0,stroke:#f57c00,stroke-width:2px
      style D fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
      style E fill:#ffebee,stroke:#d32f2f,stroke-width:2px
  </div>
</div>

<div class="diagram-caption">
  <p>MongoDB Cluster Architecture: Comprehensive view of components and their interactions</p>
</div>

<p><br /></p>

<h3 id="advanced-replica-set-configuration">Advanced Replica Set Configuration</h3>

<p>Modern replica sets require sophisticated configuration for optimal performance, availability, and operational flexibility.</p>

<h4 id="production-ready-replica-set-setup">Production-Ready Replica Set Setup</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Advanced replica set configuration</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">initiate</span><span class="p">({</span>
  <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">production-replica-set</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="na">members</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mongo-primary.internal:27017</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">priority</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">,</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">primary</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mongo-secondary-1.internal:27017</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">,</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">secondary</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mongo-secondary-2.internal:27017</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-west-2</span><span class="dl">"</span><span class="p">,</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">secondary</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mongo-analytics.internal:27017</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">priority</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">hidden</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">analytics</span><span class="dl">"</span><span class="p">,</span> <span class="na">workload</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reporting</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mongo-delayed.internal:27017</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">priority</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">hidden</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">slaveDelay</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="c1">// 1-hour delay for disaster recovery</span>
      <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">delayed-secondary</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="na">settings</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">chainingAllowed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">heartbeatIntervalMillis</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="na">heartbeatTimeoutSecs</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="na">electionTimeoutMillis</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="na">catchUpTimeoutMillis</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
    <span class="na">getLastErrorModes</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">cross-region</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
      <span class="dl">"</span><span class="s2">majority-plus-analytics</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">getLastErrorDefaults</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">w</span><span class="p">:</span> <span class="dl">"</span><span class="s2">majority</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">wtimeout</span><span class="p">:</span> <span class="mi">5000</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Configure read preferences for different workloads</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">getMongo</span><span class="p">().</span><span class="nx">setReadPref</span><span class="p">(</span><span class="dl">"</span><span class="s2">primaryPreferred</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span> <span class="p">}</span>
<span class="p">]);</span>

<span class="c1">// Analytics workload configuration</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">getMongo</span><span class="p">().</span><span class="nx">setReadPref</span><span class="p">(</span><span class="dl">"</span><span class="s2">secondary</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">analytics</span><span class="dl">"</span> <span class="p">}</span>
<span class="p">]);</span>
</code></pre></div></div>

<h4 id="advanced-write-concerns-and-read-preferences">Advanced Write Concerns and Read Preferences</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Write concern strategies for different use cases</span>
<span class="kd">const</span> <span class="nx">writeConfigs</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Critical financial transactions</span>
  <span class="na">financial</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">w</span><span class="p">:</span> <span class="dl">"</span><span class="s2">majority</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">j</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">wtimeout</span><span class="p">:</span> <span class="mi">5000</span>
  <span class="p">},</span>
  
  <span class="c1">// Cross-region durability</span>
  <span class="na">crossRegion</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">w</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cross-region</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">j</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">wtimeout</span><span class="p">:</span> <span class="mi">10000</span>
  <span class="p">},</span>
  
  <span class="c1">// High-throughput logging</span>
  <span class="na">logging</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">w</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">j</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">wtimeout</span><span class="p">:</span> <span class="mi">1000</span>
  <span class="p">},</span>
  
  <span class="c1">// Analytics data ingestion</span>
  <span class="na">analytics</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">w</span><span class="p">:</span> <span class="dl">"</span><span class="s2">majority-plus-analytics</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">j</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">wtimeout</span><span class="p">:</span> <span class="mi">15000</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Application-specific implementations</span>
<span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transactions</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span>
  <span class="p">{</span> 
    <span class="na">userId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">amount</span><span class="p">:</span> <span class="mf">1000.00</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">transfer</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">writeConcern</span><span class="p">:</span> <span class="nx">writeConfigs</span><span class="p">.</span><span class="nx">financial</span> <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Read preference optimization</span>
<span class="kd">const</span> <span class="nx">readPreferences</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Real-time user data</span>
  <span class="na">userProfile</span><span class="p">:</span> <span class="p">{</span> <span class="na">mode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">primary</span><span class="dl">"</span> <span class="p">},</span>
  
  <span class="c1">// Analytics and reporting</span>
  <span class="na">analytics</span><span class="p">:</span> <span class="p">{</span> 
    <span class="na">mode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">secondary</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">tags</span><span class="p">:</span> <span class="p">[{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">analytics</span><span class="dl">"</span> <span class="p">}],</span>
    <span class="na">maxStalenessSeconds</span><span class="p">:</span> <span class="mi">300</span>
  <span class="p">},</span>
  
  <span class="c1">// Search and discovery</span>
  <span class="na">search</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">mode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">secondaryPreferred</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">tags</span><span class="p">:</span> <span class="p">[{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span> <span class="p">}]</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="sharding-architecture-and-optimization">Sharding Architecture and Optimization</h3>

<p>Effective sharding requires careful planning of shard key selection, chunk distribution, and balancing strategies.</p>

<div style="width: 90%; margin: 20px auto;">
  <div class="mermaid">
    graph LR
      A[Client Application] --&gt; B[mongos Router]
      B --&gt; C[Config Server Replica Set]
      B --&gt; D[Shard 1<br />Replica Set]
      B --&gt; E[Shard 2<br />Replica Set]
      B --&gt; F[Shard 3<br />Replica Set]
      
      C --&gt; C1[Cluster Metadata]
      C --&gt; C2[Chunk Mappings]
      C --&gt; C3[Balancer Configuration]
      
      D --&gt; D1[Range: min - 1000]
      E --&gt; E1[Range: 1000 - 2000]
      F --&gt; F1[Range: 2000 - max]
      
      G[Zone Sharding] --&gt; H[Geographic Distribution]
      G --&gt; I[Workload Isolation]
      G --&gt; J[Hardware Optimization]
      
      style B fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
      style C fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
      style D fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style E fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style F fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style G fill:#fff3e0,stroke:#f57c00,stroke-width:2px
  </div>
</div>

<div class="diagram-caption">
  <p>Sharded Cluster Architecture: Data distribution and query routing mechanisms</p>
</div>

<h4 id="strategic-shard-key-selection">Strategic Shard Key Selection</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Anti-patterns to avoid</span>
<span class="kd">const</span> <span class="nx">badShardKeys</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Monotonically increasing - creates hotspots</span>
  <span class="na">timestamp</span><span class="p">:</span> <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="na">autoIncrement</span><span class="p">:</span> <span class="p">{</span> <span class="na">sequence</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  
  <span class="c1">// Low cardinality - limits scaling</span>
  <span class="na">status</span><span class="p">:</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="na">category</span><span class="p">:</span> <span class="p">{</span> <span class="na">category</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  
  <span class="c1">// Non-queryable - forces scatter-gather</span>
  <span class="na">hash</span><span class="p">:</span> <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hashed</span><span class="dl">"</span> <span class="p">}</span> <span class="c1">// without query patterns</span>
<span class="p">};</span>

<span class="c1">// Effective shard key strategies</span>
<span class="kd">const</span> <span class="nx">goodShardKeys</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// High cardinality + query pattern alignment</span>
  <span class="na">userActivity</span><span class="p">:</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  
  <span class="c1">// Compound key for even distribution</span>
  <span class="na">ecommerce</span><span class="p">:</span> <span class="p">{</span> <span class="na">customerId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">orderId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  
  <span class="c1">// Geographic distribution</span>
  <span class="na">iot</span><span class="p">:</span> <span class="p">{</span> <span class="na">deviceRegion</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">deviceId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  
  <span class="c1">// Hash for even distribution when range isn't suitable</span>
  <span class="na">socialMedia</span><span class="p">:</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hashed</span><span class="dl">"</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Implementation with zone sharding</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">enableSharding</span><span class="p">(</span><span class="dl">"</span><span class="s2">ecommerce</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// Create zones for geographic distribution</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">addShardToZone</span><span class="p">(</span><span class="dl">"</span><span class="s2">shard-us-east</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">us-east</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">addShardToZone</span><span class="p">(</span><span class="dl">"</span><span class="s2">shard-us-west</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">us-west</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">addShardToZone</span><span class="p">(</span><span class="dl">"</span><span class="s2">shard-europe</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">europe</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// Define zone ranges</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">updateZoneKeyRange</span><span class="p">(</span>
  <span class="dl">"</span><span class="s2">ecommerce.orders</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east</span><span class="dl">"</span><span class="p">,</span> <span class="na">customerId</span><span class="p">:</span> <span class="nx">MinKey</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east</span><span class="dl">"</span><span class="p">,</span> <span class="na">customerId</span><span class="p">:</span> <span class="nx">MaxKey</span> <span class="p">},</span>
  <span class="dl">"</span><span class="s2">us-east</span><span class="dl">"</span>
<span class="p">);</span>

<span class="c1">// Shard the collection</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">ecommerce.orders</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> 
  <span class="na">region</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
  <span class="na">customerId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
  <span class="na">orderDate</span><span class="p">:</span> <span class="mi">1</span> 
<span class="p">});</span>
</code></pre></div></div>

<h4 id="advanced-balancer-configuration">Advanced Balancer Configuration</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Custom balancer settings for different workloads</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span>
  <span class="na">balancerCollectionStatus</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ecommerce.orders</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">defragmentCollection</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="c1">// Configure balancer windows</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">balancer</span><span class="dl">"</span> <span class="p">},</span>
  <span class="p">{</span> 
    <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">activeWindow</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">start</span><span class="p">:</span> <span class="dl">"</span><span class="s2">02:00</span><span class="dl">"</span><span class="p">,</span>  <span class="c1">// 2 AM</span>
        <span class="na">stop</span><span class="p">:</span> <span class="dl">"</span><span class="s2">06:00</span><span class="dl">"</span>    <span class="c1">// 6 AM</span>
      <span class="p">},</span>
      <span class="na">mode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">full</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Optimize chunk size for specific collections</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span>
  <span class="na">configureCollectionBalancing</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ecommerce.orders</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">chunkSize</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>  <span class="c1">// MB</span>
  <span class="na">defragmentCollection</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">enableAutoSplit</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="advanced-data-modeling-patterns">Advanced Data Modeling Patterns</h2>

<p>MongoDB’s flexible document model enables sophisticated data modeling patterns that align with application access patterns and performance requirements.</p>

<p><br /></p>

<h3 id="document-design-strategies">Document Design Strategies</h3>

<h4 id="dynamic-schema-evolution">Dynamic Schema Evolution</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Schema versioning for backward compatibility</span>
<span class="kd">const</span> <span class="nx">userSchemaV1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">schemaVersion</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user@example.com</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">John Doe</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">created</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">userSchemaV2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">schemaVersion</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user@example.com</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">profile</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">John</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Doe</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">displayName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">John Doe</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="na">preferences</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">theme</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dark</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">notifications</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">language</span><span class="p">:</span> <span class="dl">"</span><span class="s2">en</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="na">created</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">lastModified</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<span class="p">};</span>

<span class="c1">// Migration strategy with version checks</span>
<span class="kd">function</span> <span class="nx">migrateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">schemaVersion</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">user</span><span class="p">,</span>
        <span class="na">schemaVersion</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="na">profile</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">firstName</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
          <span class="na">lastName</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="dl">''</span><span class="p">,</span>
          <span class="na">displayName</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span>
        <span class="p">},</span>
        <span class="na">preferences</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">theme</span><span class="p">:</span> <span class="dl">"</span><span class="s2">light</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">notifications</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="na">language</span><span class="p">:</span> <span class="dl">"</span><span class="s2">en</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="na">lastModified</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="p">};</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span> <span class="c1">// Already current version</span>
    <span class="nl">default</span><span class="p">:</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Unknown schema version: </span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">schemaVersion</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="advanced-embedding-vs-referencing-patterns">Advanced Embedding vs Referencing Patterns</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Product catalog with complex relationships</span>
<span class="kd">const</span> <span class="nx">productCatalog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Embedded for frequently accessed, bounded data</span>
  <span class="na">product</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">sku</span><span class="p">:</span> <span class="dl">"</span><span class="s2">LAPTOP-001</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Gaming Laptop</span><span class="dl">"</span><span class="p">,</span>
    
    <span class="c1">// Embedded specifications (1-to-1, rarely changes)</span>
    <span class="na">specifications</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">processor</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Intel i7-12700H</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">memory</span><span class="p">:</span> <span class="dl">"</span><span class="s2">32GB DDR4</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1TB NVMe SSD</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">graphics</span><span class="p">:</span> <span class="dl">"</span><span class="s2">RTX 3070</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">display</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">size</span><span class="p">:</span> <span class="dl">"</span><span class="s2">15.6 inches</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">resolution</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1920x1080</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">refreshRate</span><span class="p">:</span> <span class="dl">"</span><span class="s2">144Hz</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="c1">// Embedded pricing (frequently accessed with product)</span>
    <span class="na">pricing</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">msrp</span><span class="p">:</span> <span class="mf">1499.99</span><span class="p">,</span>
      <span class="na">currentPrice</span><span class="p">:</span> <span class="mf">1299.99</span><span class="p">,</span>
      <span class="na">currency</span><span class="p">:</span> <span class="dl">"</span><span class="s2">USD</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">discounts</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">seasonal</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">amount</span><span class="p">:</span> <span class="mf">200.00</span><span class="p">,</span>
          <span class="na">validUntil</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="dl">"</span><span class="s2">2024-12-31</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    
    <span class="c1">// Referenced for large, independently managed data</span>
    <span class="na">categoryId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">category-laptops</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">brandId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">brand-gaming</span><span class="dl">"</span><span class="p">),</span>
    
    <span class="c1">// Embedded recent reviews (limited subset)</span>
    <span class="na">recentReviews</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">userId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">rating</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Excellent performance</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">summary</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Great for gaming and development work...</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
        <span class="na">helpful</span><span class="p">:</span> <span class="mi">23</span>
      <span class="p">}</span>
    <span class="p">],</span>
    
    <span class="c1">// Referenced for complete review data</span>
    <span class="na">totalReviews</span><span class="p">:</span> <span class="mi">156</span><span class="p">,</span>
    <span class="na">averageRating</span><span class="p">:</span> <span class="mf">4.7</span><span class="p">,</span>
    
    <span class="c1">// Embedded inventory (frequently updated)</span>
    <span class="na">inventory</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">available</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
      <span class="na">reserved</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="na">reorderLevel</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="na">lastUpdated</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Separate collections for scalable data</span>
<span class="kd">const</span> <span class="nx">reviews</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">productId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">product-id</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">userId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">user-id</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">rating</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Excellent performance</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Detailed review content...</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">images</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">review-img-1.jpg</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">review-img-2.jpg</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">verified</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">helpful</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
  <span class="na">replies</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
      <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Thanks for the detailed review!</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="na">created</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">lastModified</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="polymorphic-data-patterns">Polymorphic Data Patterns</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Event-driven architecture with polymorphic events</span>
<span class="kd">const</span> <span class="nx">eventStore</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">eventType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">UserRegistered</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">aggregateId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user-123</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">aggregateVersion</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">eventData</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user@example.com</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">registrationSource</span><span class="p">:</span> <span class="dl">"</span><span class="s2">web</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">marketingConsent</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">ipAddress</span><span class="p">:</span> <span class="dl">"</span><span class="s2">192.168.1.1</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">userAgent</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Mozilla/5.0...</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">correlationId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reg-123</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="na">processed</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span>
    <span class="na">eventType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OrderPlaced</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">aggregateId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">order-456</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">aggregateVersion</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">eventData</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">customerId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user-123</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">items</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">prod-1</span><span class="dl">"</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mf">29.99</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">prod-2</span><span class="dl">"</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mf">15.50</span> <span class="p">}</span>
      <span class="p">],</span>
      <span class="na">totalAmount</span><span class="p">:</span> <span class="mf">75.48</span><span class="p">,</span>
      <span class="na">paymentMethod</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stripe</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">shippingAddress</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">street</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123 Main St</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">city</span><span class="p">:</span> <span class="dl">"</span><span class="s2">New York</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">state</span><span class="p">:</span> <span class="dl">"</span><span class="s2">NY</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">zip</span><span class="p">:</span> <span class="dl">"</span><span class="s2">10001</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">sessionId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sess-789</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">promotionCode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">SAVE10</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="na">processed</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// Polymorphic query patterns</span>
<span class="kd">const</span> <span class="nx">eventHandlers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">handleUserRegistered</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">aggregateId</span><span class="p">,</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">registrationSource</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">registrationSource</span><span class="p">,</span>
      <span class="na">marketingConsent</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">marketingConsent</span><span class="p">,</span>
      <span class="na">created</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">timestamp</span>
    <span class="p">});</span>
  <span class="p">},</span>
  
  <span class="k">async</span> <span class="nx">handleOrderPlaced</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">aggregateId</span><span class="p">,</span>
      <span class="na">customerId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">customerId</span><span class="p">,</span>
      <span class="na">items</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span>
      <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">totalAmount</span><span class="p">,</span>
      <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">created</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">timestamp</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Event processing with polymorphic dispatch</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">processEvents</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">unprocessedEvents</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="na">processed</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">({</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">event</span> <span class="k">of</span> <span class="nx">unprocessedEvents</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">handlerName</span> <span class="o">=</span> <span class="s2">`handle</span><span class="p">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventType</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">handlerName</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
          <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span>
          <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">processed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">processedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
          <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span>
          <span class="p">{</span> 
            <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> 
              <span class="na">processingError</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
              <span class="na">processingAttempts</span><span class="p">:</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">processingAttempts</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="time-series-and-iot-data-patterns">Time Series and IoT Data Patterns</h3>

<p>MongoDB’s time series collections optimize storage and queries for time-stamped data.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Time series collection for IoT sensor data</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">sensor_data</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">timeseries</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">timeField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">timestamp</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">metaField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sensor</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">granularity</span><span class="p">:</span> <span class="dl">"</span><span class="s2">minutes</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">bucketMaxSpanSeconds</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="na">bucketRoundingSeconds</span><span class="p">:</span> <span class="mi">60</span>
  <span class="p">},</span>
  <span class="na">expireAfterSeconds</span><span class="p">:</span> <span class="mi">31536000</span> <span class="c1">// 1 year retention</span>
<span class="p">});</span>

<span class="c1">// Optimized IoT data structure</span>
<span class="kd">const</span> <span class="nx">sensorReading</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">sensor</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">deviceId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sensor-001</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">warehouse-a</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">temperature-humidity</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">model</span><span class="p">:</span> <span class="dl">"</span><span class="s2">DHT22</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="na">measurements</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">temperature</span><span class="p">:</span> <span class="mf">23.5</span><span class="p">,</span>
    <span class="na">humidity</span><span class="p">:</span> <span class="mf">65.2</span><span class="p">,</span>
    <span class="na">batteryLevel</span><span class="p">:</span> <span class="mi">87</span>
  <span class="p">},</span>
  <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">firmware</span><span class="p">:</span> <span class="dl">"</span><span class="s2">v1.2.3</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">signalStrength</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span>
    <span class="na">dataQuality</span><span class="p">:</span> <span class="dl">"</span><span class="s2">good</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Efficient time series queries</span>
<span class="kd">const</span> <span class="nx">temperatureAggregation</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">$match</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">$gte</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// Last 24 hours</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">sensor.type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">temperature-humidity</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">$group</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">deviceId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$sensor.deviceId</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">hour</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">$dateTrunc</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">date</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$timestamp</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">unit</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hour</span><span class="dl">"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="na">avgTemperature</span><span class="p">:</span> <span class="p">{</span> <span class="na">$avg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">maxTemperature</span><span class="p">:</span> <span class="p">{</span> <span class="na">$max</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">minTemperature</span><span class="p">:</span> <span class="p">{</span> <span class="na">$min</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">readingCount</span><span class="p">:</span> <span class="p">{</span> <span class="na">$sum</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">$sort</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_id.hour</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// Real-time anomaly detection</span>
<span class="kd">const</span> <span class="nx">anomalyDetection</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">$match</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">$gte</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// Last hour</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">$setWindowFields</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">partitionBy</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$sensor.deviceId</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">sortBy</span><span class="p">:</span> <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">movingAverage</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">$avg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">window</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">documents</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">// 10-point moving average</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">standardDeviation</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">$stdDevSamp</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">window</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">documents</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">$addFields</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">anomaly</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">$gt</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">$abs</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">$subtract</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">$measurements.temperature</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$movingAverage</span><span class="dl">"</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span> <span class="na">$multiply</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">$standardDeviation</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">}</span> <span class="c1">// 2-sigma threshold</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">anomaly</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">];</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="performance-optimization-and-indexing-strategies">Performance Optimization and Indexing Strategies</h2>

<p>MongoDB performance optimization requires comprehensive indexing strategies, query optimization, and architectural considerations.</p>

<p><br /></p>

<h3 id="advanced-indexing-patterns">Advanced Indexing Patterns</h3>

<h4 id="compound-index-optimization">Compound Index Optimization</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Query pattern analysis for index design</span>
<span class="kd">const</span> <span class="nx">queryPatterns</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// User activity lookup</span>
  <span class="na">userActivity</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">...</span><span class="dl">"</span><span class="p">),</span> <span class="na">timestamp</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">},</span>
    <span class="na">sort</span><span class="p">:</span> <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
    <span class="na">limit</span><span class="p">:</span> <span class="mi">50</span>
  <span class="p">},</span>
  
  <span class="c1">// Product search with filters</span>
  <span class="na">productSearch</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">category</span><span class="p">:</span> <span class="dl">"</span><span class="s2">electronics</span><span class="dl">"</span><span class="p">,</span> 
      <span class="na">price</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="na">$lte</span><span class="p">:</span> <span class="mi">500</span> <span class="p">},</span>
      <span class="na">inStock</span><span class="p">:</span> <span class="kc">true</span> 
    <span class="p">},</span>
    <span class="na">sort</span><span class="p">:</span> <span class="p">{</span> <span class="na">popularity</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Geospatial queries</span>
  <span class="na">nearbyStores</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">location</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">$near</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">$geometry</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Point</span><span class="dl">"</span><span class="p">,</span> <span class="na">coordinates</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">73.9857</span><span class="p">,</span> <span class="mf">40.7484</span><span class="p">]</span> <span class="p">},</span>
          <span class="na">$maxDistance</span><span class="p">:</span> <span class="mi">5000</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="na">storeType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">retail</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Optimized index strategies</span>
<span class="kd">const</span> <span class="nx">indexStrategies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ESR (Equality, Sort, Range) principle</span>
  <span class="na">userActivityIndex</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">timestamp</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="c1">// Equality first, then sort</span>
    <span class="na">options</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_user_activity_optimized</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">partialFilterExpression</span><span class="p">:</span> <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Compound index for product filtering</span>
  <span class="na">productSearchIndex</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">{</span> <span class="na">category</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">inStock</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">popularity</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
    <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_product_search_compound</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">partialFilterExpression</span><span class="p">:</span> <span class="p">{</span> <span class="na">inStock</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Geospatial index</span>
  <span class="na">storeLocationIndex</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">{</span> <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2dsphere</span><span class="dl">"</span><span class="p">,</span> <span class="na">storeType</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="na">options</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_store_location_type</span><span class="dl">"</span> <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Text search with language support</span>
  <span class="na">productTextSearch</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> 
      <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> 
      <span class="na">tags</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> 
    <span class="p">},</span>
    <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_product_text_search</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">weights</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="na">tags</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="na">default_language</span><span class="p">:</span> <span class="dl">"</span><span class="s2">english</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Index creation with monitoring</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">createOptimizedIndexes</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">collections</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user_activity</span><span class="dl">"</span><span class="p">,</span> <span class="na">indexes</span><span class="p">:</span> <span class="p">[</span><span class="nx">indexStrategies</span><span class="p">.</span><span class="nx">userActivityIndex</span><span class="p">]</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span> <span class="na">indexes</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">indexStrategies</span><span class="p">.</span><span class="nx">productSearchIndex</span><span class="p">,</span>
      <span class="nx">indexStrategies</span><span class="p">.</span><span class="nx">productTextSearch</span>
    <span class="p">]},</span>
    <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stores</span><span class="dl">"</span><span class="p">,</span> <span class="na">indexes</span><span class="p">:</span> <span class="p">[</span><span class="nx">indexStrategies</span><span class="p">.</span><span class="nx">storeLocationIndex</span><span class="p">]</span> <span class="p">}</span>
  <span class="p">];</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">collection</span> <span class="k">of</span> <span class="nx">collections</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">indexes</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">[</span><span class="nx">collection</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">createIndex</span><span class="p">(</span>
          <span class="nx">index</span><span class="p">.</span><span class="nx">keys</span><span class="p">,</span> 
          <span class="nx">index</span><span class="p">.</span><span class="nx">options</span>
        <span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Created index </span><span class="p">${</span><span class="nx">index</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">: </span><span class="p">${</span><span class="nx">result</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Failed to create index </span><span class="p">${</span><span class="nx">index</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">:`</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="sparse-and-partial-indexes-for-optimization">Sparse and Partial Indexes for Optimization</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Sparse indexes for optional fields</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">socialSecurityNumber</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> 
    <span class="na">sparse</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_users_ssn_sparse</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Partial indexes for specific conditions</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">customerId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">orderDate</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">partialFilterExpression</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">status</span><span class="p">:</span> <span class="p">{</span> <span class="na">$in</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">processing</span><span class="dl">"</span><span class="p">]</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_orders_active_customer_date</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// TTL indexes for automatic document expiration</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">lastAccessed</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">expireAfterSeconds</span><span class="p">:</span> <span class="mi">3600</span> <span class="p">}</span> <span class="c1">// 1 hour</span>
<span class="p">);</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">createdAt</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">expireAfterSeconds</span><span class="p">:</span> <span class="mi">2592000</span> <span class="p">}</span> <span class="c1">// 30 days</span>
<span class="p">);</span>

<span class="c1">// Compound TTL with partial filter</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">temporaryData</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">expiresAt</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">expireAfterSeconds</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">partialFilterExpression</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">temporary</span><span class="p">:</span> <span class="kc">true</span> 
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="query-optimization-techniques">Query Optimization Techniques</h3>

<h4 id="aggregation-pipeline-optimization">Aggregation Pipeline Optimization</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Inefficient aggregation pipeline</span>
<span class="kd">const</span> <span class="nx">inefficientPipeline</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">completed</span><span class="dl">"</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$lookup</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">from</span><span class="p">:</span> <span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">localField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">productId</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">foreignField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">"</span><span class="s2">product</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">$unwind</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$product</span><span class="dl">"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">product.category</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">electronics</span><span class="dl">"</span> <span class="p">}</span> <span class="p">},</span> <span class="c1">// Should be earlier</span>
  <span class="p">{</span> <span class="na">$group</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$customerId</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">totalSpent</span><span class="p">:</span> <span class="p">{</span> <span class="na">$sum</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$amount</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">$sort</span><span class="p">:</span> <span class="p">{</span> <span class="na">totalSpent</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$limit</span><span class="p">:</span> <span class="mi">100</span> <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// Optimized aggregation pipeline</span>
<span class="kd">const</span> <span class="nx">optimizedPipeline</span> <span class="o">=</span> <span class="p">[</span>
  <span class="c1">// Early filtering reduces documents in pipeline</span>
  <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">completed</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">amount</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="c1">// Additional early filter</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Index hint for optimal query plan</span>
  <span class="p">{</span> <span class="na">$hint</span><span class="p">:</span> <span class="dl">"</span><span class="s2">idx_orders_status_customer_amount</span><span class="dl">"</span> <span class="p">},</span>
  
  <span class="c1">// Efficient lookup with pipeline for filtering</span>
  <span class="p">{</span> <span class="na">$lookup</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">from</span><span class="p">:</span> <span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">let</span><span class="p">:</span> <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$productId</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">pipeline</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> 
            <span class="na">$expr</span><span class="p">:</span> <span class="p">{</span> <span class="na">$eq</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">$_id</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$$productId</span><span class="dl">"</span><span class="p">]</span> <span class="p">},</span>
            <span class="na">category</span><span class="p">:</span> <span class="dl">"</span><span class="s2">electronics</span><span class="dl">"</span> <span class="c1">// Filter in subpipeline</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="na">$project</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">category</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="c1">// Minimal projection</span>
      <span class="p">],</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">"</span><span class="s2">product</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Filter out documents without matching products</span>
  <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">product.0</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
  
  <span class="c1">// Group with optimized accumulator</span>
  <span class="p">{</span> <span class="na">$group</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$customerId</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">totalSpent</span><span class="p">:</span> <span class="p">{</span> <span class="na">$sum</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$amount</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">orderCount</span><span class="p">:</span> <span class="p">{</span> <span class="na">$sum</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="na">avgOrderValue</span><span class="p">:</span> <span class="p">{</span> <span class="na">$avg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$amount</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Sort and limit for top customers</span>
  <span class="p">{</span> <span class="na">$sort</span><span class="p">:</span> <span class="p">{</span> <span class="na">totalSpent</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$limit</span><span class="p">:</span> <span class="mi">100</span> <span class="p">},</span>
  
  <span class="c1">// Final projection for clean output</span>
  <span class="p">{</span> <span class="na">$project</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">customerId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$_id</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">totalSpent</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">orderCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">avgOrderValue</span><span class="p">:</span> <span class="p">{</span> <span class="na">$round</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">$avgOrderValue</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">},</span>
      <span class="na">_id</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// Performance monitoring wrapper</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">executeOptimizedAggregation</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">allowDiskUse</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">cursor</span><span class="p">:</span> <span class="p">{</span> <span class="na">batchSize</span><span class="p">:</span> <span class="mi">1000</span> <span class="p">},</span>
      <span class="p">...</span><span class="nx">options</span>
    <span class="p">}).</span><span class="nx">toArray</span><span class="p">();</span>
    
    <span class="kd">const</span> <span class="nx">executionTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">;</span>
    
    <span class="c1">// Log performance metrics</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">query_performance</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span>
      <span class="na">query</span><span class="p">:</span> <span class="dl">"</span><span class="s2">customer_electronics_analysis</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">executionTime</span><span class="p">,</span>
      <span class="na">resultCount</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">pipeline</span><span class="p">:</span> <span class="nx">pipeline</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">});</span>
    
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Aggregation failed:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="query-plan-analysis-and-optimization">Query Plan Analysis and Optimization</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Query performance analysis</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">analyzeQueryPerformance</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="na">category</span><span class="p">:</span> <span class="dl">"</span><span class="s2">electronics</span><span class="dl">"</span><span class="p">,</span> 
    <span class="na">price</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="na">$lte</span><span class="p">:</span> <span class="mi">1000</span> <span class="p">},</span>
    <span class="na">inStock</span><span class="p">:</span> <span class="kc">true</span> 
  <span class="p">};</span>
  
  <span class="c1">// Explain query execution</span>
  <span class="kd">const</span> <span class="nx">explanation</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">({</span> <span class="na">popularity</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">explain</span><span class="p">(</span><span class="dl">"</span><span class="s2">executionStats</span><span class="dl">"</span><span class="p">);</span>
  
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Query Execution Stats:</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Execution Time: </span><span class="p">${</span><span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">executionTimeMillis</span><span class="p">}</span><span class="s2">ms`</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Documents Examined: </span><span class="p">${</span><span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">totalDocsExamined</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Documents Returned: </span><span class="p">${</span><span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">totalDocsReturned</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Index Used: </span><span class="p">${</span><span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">executionStages</span><span class="p">.</span><span class="nx">indexName</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">COLLSCAN</span><span class="dl">'</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  
  <span class="c1">// Calculate selectivity</span>
  <span class="kd">const</span> <span class="nx">selectivity</span> <span class="o">=</span> <span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">totalDocsReturned</span> <span class="o">/</span> 
                     <span class="nx">explanation</span><span class="p">.</span><span class="nx">executionStats</span><span class="p">.</span><span class="nx">totalDocsExamined</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">selectivity</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Low selectivity detected. Consider index optimization.</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">explanation</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Index usage monitoring</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">monitorIndexUsage</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">indexStats</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$indexStats</span><span class="p">:</span> <span class="p">{}</span> <span class="p">}</span>
  <span class="p">]).</span><span class="nx">toArray</span><span class="p">();</span>
  
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Index Usage Statistics:</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">indexStats</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">stat</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Index: </span><span class="p">${</span><span class="nx">stat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`  Accesses: </span><span class="p">${</span><span class="nx">stat</span><span class="p">.</span><span class="nx">accesses</span><span class="p">.</span><span class="nx">ops</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`  Since: </span><span class="p">${</span><span class="nx">stat</span><span class="p">.</span><span class="nx">accesses</span><span class="p">.</span><span class="nx">since</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">});</span>
  
  <span class="c1">// Identify unused indexes</span>
  <span class="kd">const</span> <span class="nx">unusedIndexes</span> <span class="o">=</span> <span class="nx">indexStats</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">stat</span> <span class="o">=&gt;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">accesses</span><span class="p">.</span><span class="nx">ops</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">unusedIndexes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unused indexes detected:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">unusedIndexes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">idx</span> <span class="o">=&gt;</span> <span class="nx">idx</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="enterprise-patterns-and-distributed-systems">Enterprise Patterns and Distributed Systems</h2>

<p>Modern MongoDB deployments often serve as the data layer for distributed systems, requiring sophisticated patterns for consistency, scalability, and reliability.</p>

<p><br /></p>

<h3 id="microservices-data-patterns">Microservices Data Patterns</h3>

<h4 id="database-per-service-with-event-sourcing">Database per Service with Event Sourcing</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// User Service - Event Store Implementation</span>
<span class="kd">class</span> <span class="nx">UserEventStore</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">user_events</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">appendEvent</span><span class="p">(</span><span class="nx">streamId</span><span class="p">,</span> <span class="nx">expectedVersion</span><span class="p">,</span> <span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">startSession</span><span class="p">();</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">session</span><span class="p">.</span><span class="nx">withTransaction</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Check current version for optimistic concurrency</span>
        <span class="kd">const</span> <span class="nx">currentEvents</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span>
          <span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">streamId</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">session</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">sort</span><span class="p">({</span> <span class="na">version</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
        
        <span class="kd">const</span> <span class="nx">currentVersion</span> <span class="o">=</span> <span class="nx">currentEvents</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">?</span> 
          <span class="nx">currentEvents</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">version</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">currentVersion</span> <span class="o">!==</span> <span class="nx">expectedVersion</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Concurrency conflict. Expected </span><span class="p">${</span><span class="nx">expectedVersion</span><span class="p">}</span><span class="s2">, got </span><span class="p">${</span><span class="nx">currentVersion</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// Append new events</span>
        <span class="kd">const</span> <span class="nx">eventsToInsert</span> <span class="o">=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">event</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
          <span class="na">_id</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">(),</span>
          <span class="nx">streamId</span><span class="p">,</span>
          <span class="na">version</span><span class="p">:</span> <span class="nx">expectedVersion</span> <span class="o">+</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
          <span class="na">eventType</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
          <span class="na">eventData</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
          <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">...</span><span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span>
            <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
            <span class="na">correlationId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">?.</span><span class="nx">correlationId</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
          <span class="p">}</span>
        <span class="p">}));</span>
        
        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">insertMany</span><span class="p">(</span><span class="nx">eventsToInsert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">session</span> <span class="p">});</span>
        
        <span class="k">return</span> <span class="nx">eventsToInsert</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">session</span><span class="p">.</span><span class="nx">endSession</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getEvents</span><span class="p">(</span><span class="nx">streamId</span><span class="p">,</span> <span class="nx">fromVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span>
      <span class="p">.</span><span class="nx">find</span><span class="p">({</span> 
        <span class="nx">streamId</span><span class="p">,</span> 
        <span class="na">version</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="nx">fromVersion</span> <span class="p">}</span> 
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">sort</span><span class="p">({</span> <span class="na">version</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Saga Orchestration Pattern</span>
<span class="kd">class</span> <span class="nx">OrderSagaOrchestrator</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">order_sagas</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stepCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">saga_steps</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">startOrderSaga</span><span class="p">(</span><span class="nx">orderData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">sagaId</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">saga</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span><span class="p">,</span>
      <span class="na">sagaType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ProcessOrder</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">state</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Started</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">currentStep</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">orderData</span><span class="p">,</span>
      <span class="na">steps</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ReserveInventory</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Pending</span><span class="dl">'</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ProcessPayment</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Pending</span><span class="dl">'</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CreateShipment</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Pending</span><span class="dl">'</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">SendConfirmation</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Pending</span><span class="dl">'</span> <span class="p">}</span>
      <span class="p">],</span>
      <span class="na">createdAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">updatedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">saga</span><span class="p">);</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeNextStep</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">sagaId</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">executeNextStep</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">saga</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">saga</span> <span class="o">||</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span> <span class="o">&gt;=</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kd">const</span> <span class="nx">currentStep</span> <span class="o">=</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span><span class="p">];</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Execute step based on type</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeStep</span><span class="p">(</span><span class="nx">currentStep</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      
      <span class="c1">// Update step status</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">},</span>
        <span class="p">{</span>
          <span class="na">$set</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">[</span><span class="s2">`steps.</span><span class="p">${</span><span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span><span class="p">}</span><span class="s2">.status`</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">Completed</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">`steps.</span><span class="p">${</span><span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span><span class="p">}</span><span class="s2">.result`</span><span class="p">]:</span> <span class="nx">result</span><span class="p">,</span>
            <span class="na">currentStep</span><span class="p">:</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="na">updatedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">);</span>
      
      <span class="c1">// Continue to next step</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeNextStep</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">);</span>
      
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Handle step failure</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleStepFailure</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">,</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">currentStep</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">handleStepFailure</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">,</span> <span class="nx">failedStepIndex</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Mark step as failed</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
      <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">$set</span><span class="p">:</span> <span class="p">{</span>
          <span class="p">[</span><span class="s2">`steps.</span><span class="p">${</span><span class="nx">failedStepIndex</span><span class="p">}</span><span class="s2">.status`</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">Failed</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">[</span><span class="s2">`steps.</span><span class="p">${</span><span class="nx">failedStepIndex</span><span class="p">}</span><span class="s2">.error`</span><span class="p">]:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
          <span class="na">state</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Compensating</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">updatedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">);</span>
    
    <span class="c1">// Execute compensation actions</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">executeCompensation</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">,</span> <span class="nx">failedStepIndex</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">executeCompensation</span><span class="p">(</span><span class="nx">sagaId</span><span class="p">,</span> <span class="nx">fromStep</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">saga</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">});</span>
    
    <span class="c1">// Compensate completed steps in reverse order</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">fromStep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Completed</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">compensateStep</span><span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">step</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">saga</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
          
          <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
            <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">},</span>
            <span class="p">{</span>
              <span class="na">$set</span><span class="p">:</span> <span class="p">{</span>
                <span class="p">[</span><span class="s2">`steps.</span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2">.compensated`</span><span class="p">]:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">updatedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">compensationError</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Compensation failed for step </span><span class="p">${</span><span class="nx">step</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">:`</span><span class="p">,</span> <span class="nx">compensationError</span><span class="p">);</span>
          <span class="c1">// Handle compensation failure (manual intervention required)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sagaCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
      <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">sagaId</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">state</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed</span><span class="dl">'</span><span class="p">,</span> <span class="na">updatedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="cqrs-with-mongodb">CQRS with MongoDB</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Command Side - Write Model</span>
<span class="kd">class</span> <span class="nx">OrderCommandHandler</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">eventStore</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">eventStore</span> <span class="o">=</span> <span class="nx">eventStore</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">createOrder</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OrderCreated</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="nx">orderId</span><span class="p">,</span>
          <span class="na">customerId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">customerId</span><span class="p">,</span>
          <span class="na">items</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span>
          <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">totalAmount</span>
        <span class="p">},</span>
        <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">commandId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
          <span class="na">userId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
          <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">];</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventStore</span><span class="p">.</span><span class="nx">appendEvent</span><span class="p">(</span><span class="s2">`order-</span><span class="p">${</span><span class="nx">orderId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">events</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">orderId</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">updateOrderStatus</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventStore</span><span class="p">.</span><span class="nx">getEvents</span><span class="p">(</span><span class="s2">`order-</span><span class="p">${</span><span class="nx">command</span><span class="p">.</span><span class="nx">orderId</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reconstructOrderFromEvents</span><span class="p">(</span><span class="nx">events</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Order not found</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">const</span> <span class="nx">newEvent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OrderStatusChanged</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">orderId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">orderId</span><span class="p">,</span>
        <span class="na">previousStatus</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span>
        <span class="na">newStatus</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">newStatus</span><span class="p">,</span>
        <span class="na">reason</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">reason</span>
      <span class="p">},</span>
      <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">commandId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="na">userId</span><span class="p">:</span> <span class="nx">command</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
        <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventStore</span><span class="p">.</span><span class="nx">appendEvent</span><span class="p">(</span>
      <span class="s2">`order-</span><span class="p">${</span><span class="nx">command</span><span class="p">.</span><span class="nx">orderId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> 
      <span class="nx">events</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> 
      <span class="p">[</span><span class="nx">newEvent</span><span class="p">]</span>
    <span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">reconstructOrderFromEvents</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">order</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">event</span> <span class="k">of</span> <span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">OrderCreated</span><span class="dl">'</span><span class="p">:</span>
          <span class="nx">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">orderId</span><span class="p">,</span>
            <span class="na">customerId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">customerId</span><span class="p">,</span>
            <span class="na">items</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span>
            <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">totalAmount</span><span class="p">,</span>
            <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Created</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">createdAt</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span>
          <span class="p">};</span>
          <span class="k">break</span><span class="p">;</span>
          
        <span class="k">case</span> <span class="dl">'</span><span class="s1">OrderStatusChanged</span><span class="dl">'</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">order</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">newStatus</span><span class="p">;</span>
            <span class="nx">order</span><span class="p">.</span><span class="nx">lastModified</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nx">order</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Query Side - Read Model Projections</span>
<span class="kd">class</span> <span class="nx">OrderProjectionHandler</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">orderSummaryCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">order_summary</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">customerOrdersCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">customer_orders</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">handleOrderCreated</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderSummary</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">orderId</span><span class="p">,</span>
      <span class="na">customerId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">customerId</span><span class="p">,</span>
      <span class="na">itemCount</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">totalAmount</span><span class="p">,</span>
      <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Created</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">createdAt</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
      <span class="na">lastModified</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">orderSummaryCollection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">orderSummary</span><span class="p">);</span>
    
    <span class="c1">// Update customer orders aggregation</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">customerOrdersCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
      <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">customerId</span> <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span> 
          <span class="na">totalOrders</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="na">totalSpent</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">totalAmount</span>
        <span class="p">},</span>
        <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">lastOrderDate</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span> <span class="p">},</span>
        <span class="na">$setOnInsert</span><span class="p">:</span> <span class="p">{</span> <span class="na">firstOrderDate</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">handleOrderStatusChanged</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">orderSummaryCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
      <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">orderId</span> <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">$set</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">status</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">newStatus</span><span class="p">,</span>
          <span class="na">lastModified</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">timestamp</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">);</span>
    
    <span class="c1">// Update additional projections based on status</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">newStatus</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Completed</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">customerOrdersCollection</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">customerId</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span> <span class="na">completedOrders</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="multi-tenant-architecture-patterns">Multi-Tenant Architecture Patterns</h3>

<h4 id="tenant-isolation-strategies">Tenant Isolation Strategies</h4>

<script src="https://gist.github.com/somaz94/e8827c1d5ad93453d4f23c5f9997fa7c.js"></script>

<p><br /></p>

<h2 id="security-and-compliance">Security and Compliance</h2>

<p>Enterprise MongoDB deployments require comprehensive security measures addressing authentication, authorization, encryption, and compliance requirements.</p>

<p><br /></p>

<h3 id="advanced-security-implementation">Advanced Security Implementation</h3>

<h4 id="role-based-access-control-rbac">Role-Based Access Control (RBAC)</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Custom role definitions for enterprise security</span>
<span class="kd">const</span> <span class="nx">securityRoles</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Application service roles</span>
  <span class="na">userServiceRole</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userServiceRole</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">privileges</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">resource</span><span class="p">:</span> <span class="p">{</span> <span class="na">db</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userdb</span><span class="dl">"</span><span class="p">,</span> <span class="na">collection</span><span class="p">:</span> <span class="dl">"</span><span class="s2">users</span><span class="dl">"</span> <span class="p">},</span>
        <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">find</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">insert</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">remove</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">resource</span><span class="p">:</span> <span class="p">{</span> <span class="na">db</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userdb</span><span class="dl">"</span><span class="p">,</span> <span class="na">collection</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user_sessions</span><span class="dl">"</span> <span class="p">},</span>
        <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">find</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">insert</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">remove</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="na">roles</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  
  <span class="c1">// Analytics read-only role</span>
  <span class="na">analyticsRole</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">analyticsRole</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">privileges</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">resource</span><span class="p">:</span> <span class="p">{</span> <span class="na">db</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">collection</span><span class="p">:</span> <span class="dl">""</span> <span class="p">},</span> <span class="c1">// All databases</span>
        <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">find</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">listCollections</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">listIndexes</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="na">roles</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  
  <span class="c1">// Audit role with special permissions</span>
  <span class="na">auditRole</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auditRole</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">privileges</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">resource</span><span class="p">:</span> <span class="p">{</span> <span class="na">cluster</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
        <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">auditLogRotate</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">viewRole</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">viewUser</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">resource</span><span class="p">:</span> <span class="p">{</span> <span class="na">db</span><span class="p">:</span> <span class="dl">"</span><span class="s2">audit</span><span class="dl">"</span><span class="p">,</span> <span class="na">collection</span><span class="p">:</span> <span class="dl">""</span> <span class="p">},</span>
        <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">find</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">insert</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">listCollections</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="na">roles</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// User creation with role assignment</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">createApplicationUsers</span><span class="p">(</span><span class="nx">adminDb</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Create custom roles</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">[</span><span class="nx">roleName</span><span class="p">,</span> <span class="nx">roleConfig</span><span class="p">]</span> <span class="k">of</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">securityRoles</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">adminDb</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">({</span>
        <span class="na">createRole</span><span class="p">:</span> <span class="nx">roleConfig</span><span class="p">.</span><span class="nx">role</span><span class="p">,</span>
        <span class="na">privileges</span><span class="p">:</span> <span class="nx">roleConfig</span><span class="p">.</span><span class="nx">privileges</span><span class="p">,</span>
        <span class="na">roles</span><span class="p">:</span> <span class="nx">roleConfig</span><span class="p">.</span><span class="nx">roles</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Created role: </span><span class="p">${</span><span class="nx">roleConfig</span><span class="p">.</span><span class="nx">role</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">51002</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Role already exists</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Failed to create role </span><span class="p">${</span><span class="nx">roleConfig</span><span class="p">.</span><span class="nx">role</span><span class="p">}</span><span class="s2">:`</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1">// Create application users</span>
  <span class="kd">const</span> <span class="nx">applicationUsers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userService</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">pwd</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">USER_SERVICE_PASSWORD</span><span class="p">,</span>
      <span class="na">roles</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">userServiceRole</span><span class="dl">"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">"</span><span class="s2">analyticsService</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">pwd</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ANALYTICS_SERVICE_PASSWORD</span><span class="p">,</span>
      <span class="na">roles</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">analyticsRole</span><span class="dl">"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">"</span><span class="s2">auditService</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">pwd</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AUDIT_SERVICE_PASSWORD</span><span class="p">,</span>
      <span class="na">roles</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">auditRole</span><span class="dl">"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">];</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">userConfig</span> <span class="k">of</span> <span class="nx">applicationUsers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">adminDb</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">({</span>
        <span class="na">createUser</span><span class="p">:</span> <span class="nx">userConfig</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span>
        <span class="na">pwd</span><span class="p">:</span> <span class="nx">userConfig</span><span class="p">.</span><span class="nx">pwd</span><span class="p">,</span>
        <span class="na">roles</span><span class="p">:</span> <span class="nx">userConfig</span><span class="p">.</span><span class="nx">roles</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Created user: </span><span class="p">${</span><span class="nx">userConfig</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">51003</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// User already exists</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Failed to create user </span><span class="p">${</span><span class="nx">userConfig</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2">:`</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="field-level-encryption">Field-Level Encryption</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Client-side field level encryption setup</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongodb</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">ClientEncryption</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongodb-client-encryption</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nx">FieldLevelEncryption</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">keyVaultNamespace</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultNamespace</span> <span class="o">=</span> <span class="nx">keyVaultNamespace</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">kmsProviders</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">local</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">key</span><span class="p">:</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MASTER_KEY</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Create key vault client</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
    
    <span class="c1">// Create client encryption</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clientEncryption</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ClientEncryption</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultClient</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">keyVaultNamespace</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultNamespace</span><span class="p">,</span>
        <span class="na">kmsProviders</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">kmsProviders</span>
      <span class="p">}</span>
    <span class="p">);</span>
    
    <span class="c1">// Create data encryption keys</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dataKeys</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">ssn</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">createDataKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">SSN_KEY</span><span class="dl">'</span><span class="p">),</span>
      <span class="na">creditCard</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">createDataKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">CREDIT_CARD_KEY</span><span class="dl">'</span><span class="p">),</span>
      <span class="na">personalData</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">createDataKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">PERSONAL_DATA_KEY</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">createDataKey</span><span class="p">(</span><span class="nx">altName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientEncryption</span><span class="p">.</span><span class="nx">createDataKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">keyAltNames</span><span class="p">:</span> <span class="p">[</span><span class="nx">altName</span><span class="p">]</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Key might already exist, try to find it</span>
      <span class="kd">const</span> <span class="nx">keyVault</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultClient</span>
        <span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keyVaultNamespace</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keyVaultNamespace</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
        
      <span class="kd">const</span> <span class="nx">existingKey</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">keyVault</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
        <span class="na">keyAltNames</span><span class="p">:</span> <span class="nx">altName</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="nx">existingKey</span> <span class="p">?</span> <span class="nx">existingKey</span><span class="p">.</span><span class="nx">_id</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">encryptField</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">fieldType</span><span class="p">,</span> <span class="nx">algorithm</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">keyId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataKeys</span><span class="p">[</span><span class="nx">fieldType</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">keyId</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`No encryption key found for field type: </span><span class="p">${</span><span class="nx">fieldType</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientEncryption</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">keyId</span><span class="p">,</span>
      <span class="nx">algorithm</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">decryptField</span><span class="p">(</span><span class="nx">encryptedValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientEncryption</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">encryptedValue</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="c1">// Create encrypted client with automatic encryption</span>
  <span class="k">async</span> <span class="nx">createEncryptedClient</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">schemaMap</span> <span class="o">=</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">healthcare.patients</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">bsonType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">ssn</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">encrypt</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">keyId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataKeys</span><span class="p">.</span><span class="nx">ssn</span><span class="p">,</span>
              <span class="na">bsonType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">algorithm</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic</span><span class="dl">"</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">medicalRecord</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">encrypt</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">keyId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataKeys</span><span class="p">.</span><span class="nx">personalData</span><span class="p">,</span>
              <span class="na">bsonType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">algorithm</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AEAD_AES_256_CBC_HMAC_SHA_512-Random</span><span class="dl">"</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
    
    <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">autoEncryption</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">keyVaultNamespace</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyVaultNamespace</span><span class="p">,</span>
        <span class="na">kmsProviders</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">kmsProviders</span><span class="p">,</span>
        <span class="nx">schemaMap</span>
      <span class="p">}</span>
    <span class="p">});</span>
    
    <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="comprehensive-audit-logging">Comprehensive Audit Logging</h4>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Advanced audit logging configuration</span>
<span class="kd">const</span> <span class="nx">auditConfiguration</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Enable audit logging</span>
  <span class="na">auditLog</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">destination</span><span class="p">:</span> <span class="dl">"</span><span class="s2">file</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/var/log/mongodb/audit.json</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">JSON</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">filter</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// Audit all authentication events</span>
      <span class="na">$or</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">authenticate</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">authCheck</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">logout</span><span class="dl">"</span> <span class="p">},</span>
        
        <span class="c1">// Audit administrative operations</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">createCollection</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dropCollection</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">createIndex</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dropIndex</span><span class="dl">"</span> <span class="p">},</span>
        
        <span class="c1">// Audit data modification on sensitive collections</span>
        <span class="p">{</span>
          <span class="na">$and</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$in</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">insert</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">remove</span><span class="dl">"</span><span class="p">]</span> <span class="p">}</span> <span class="p">},</span>
            <span class="p">{</span> <span class="dl">"</span><span class="s2">param.ns</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$regex</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^(users|payments|medical)</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        
        <span class="c1">// Audit role and user management</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">createUser</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dropUser</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">createRole</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dropRole</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">grantRolesToUser</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="dl">"</span><span class="s2">atype</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">revokeRolesFromUser</span><span class="dl">"</span> <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Custom audit event handler</span>
<span class="kd">class</span> <span class="nx">AuditEventProcessor</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">auditCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">security_audit_events</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">processAuditEvent</span><span class="p">(</span><span class="nx">auditEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">processedEvent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">auditEvent</span><span class="p">,</span>
      <span class="na">processedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">riskScore</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateRiskScore</span><span class="p">(</span><span class="nx">auditEvent</span><span class="p">),</span>
      <span class="na">category</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">categorizeEvent</span><span class="p">(</span><span class="nx">auditEvent</span><span class="p">)</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">auditCollection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">processedEvent</span><span class="p">);</span>
    
    <span class="c1">// Check for suspicious patterns</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">processedEvent</span><span class="p">.</span><span class="nx">riskScore</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">triggerSecurityAlert</span><span class="p">(</span><span class="nx">processedEvent</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">calculateRiskScore</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// Failed authentication attempts</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">atype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">authenticate</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">result</span> <span class="o">===</span> <span class="mi">18</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">score</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Administrative operations outside business hours</span>
    <span class="kd">const</span> <span class="nx">hour</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">ts</span><span class="p">).</span><span class="nx">getHours</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">([</span><span class="dl">'</span><span class="s1">createUser</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">dropUser</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">createRole</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">dropRole</span><span class="dl">'</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">atype</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">hour</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span> <span class="nx">hour</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">score</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Bulk data access</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">atype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">find</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">param</span><span class="p">?.</span><span class="nx">filter</span> <span class="o">===</span> <span class="p">{})</span> <span class="p">{</span>
      <span class="nx">score</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Unusual source IP</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">remote</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isKnownIP</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">remote</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">score</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">score</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">categorizeEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">categories</span> <span class="o">=</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">authenticate</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">AUTHENTICATION</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">authCheck</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">AUTHORIZATION</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">insert</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DATA_MODIFICATION</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">update</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DATA_MODIFICATION</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">remove</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DATA_MODIFICATION</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">find</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DATA_ACCESS</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">createUser</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">USER_MANAGEMENT</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">dropUser</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">USER_MANAGEMENT</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">createRole</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ROLE_MANAGEMENT</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">dropRole</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ROLE_MANAGEMENT</span><span class="dl">'</span>
    <span class="p">};</span>
    
    <span class="k">return</span> <span class="nx">categories</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">atype</span><span class="p">]</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">OTHER</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">triggerSecurityAlert</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">alert</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">alertId</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">(),</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH_RISK_AUDIT_EVENT</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">severity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">event</span><span class="p">:</span> <span class="nx">event</span><span class="p">,</span>
      <span class="na">triggeredAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OPEN</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">assignedTo</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">security_alerts</span><span class="dl">'</span><span class="p">).</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">alert</span><span class="p">);</span>
    
    <span class="c1">// Send notification to security team</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">notifySecurityTeam</span><span class="p">(</span><span class="nx">alert</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">notifySecurityTeam</span><span class="p">(</span><span class="nx">alert</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Implementation for security team notification</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`🚨 Security Alert: </span><span class="p">${</span><span class="nx">alert</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span><span class="s2"> - Risk Score: </span><span class="p">${</span><span class="nx">alert</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">riskScore</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">isKnownIP</span><span class="p">(</span><span class="nx">ip</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">knownIPRanges</span> <span class="o">=</span> <span class="p">[</span>
      <span class="dl">'</span><span class="s1">10.0.0.0/8</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">172.16.0.0/12</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">192.168.0.0/16</span><span class="dl">'</span>
    <span class="p">];</span>
    
    <span class="c1">// Implementation for IP range checking</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Simplified for example</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="production-operations-and-monitoring">Production Operations and Monitoring</h2>

<p>Enterprise MongoDB deployments require comprehensive operational excellence covering monitoring, alerting, backup strategies, and performance optimization.</p>

<p><br /></p>

<h3 id="performance-monitoring-and-alerting">Performance Monitoring and Alerting</h3>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Comprehensive performance monitoring system</span>
<span class="kd">class</span> <span class="nx">MongoDBPerformanceMonitor</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">alertManager</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">alertManager</span> <span class="o">=</span> <span class="nx">alertManager</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">metricsCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">performance_metrics</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">alertCollection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">performance_alerts</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">collectPerformanceMetrics</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">metrics</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">server</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getServerStatus</span><span class="p">(),</span>
      <span class="na">database</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDatabaseMetrics</span><span class="p">(),</span>
      <span class="na">queries</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSlowQueryMetrics</span><span class="p">(),</span>
      <span class="na">replication</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReplicationMetrics</span><span class="p">(),</span>
      <span class="na">sharding</span><span class="p">:</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getShardingMetrics</span><span class="p">()</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">metricsCollection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">metrics</span><span class="p">);</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">analyzeMetrics</span><span class="p">(</span><span class="nx">metrics</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">metrics</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getServerStatus</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">serverStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">().</span><span class="nx">serverStatus</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">uptime</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">uptime</span><span class="p">,</span>
      <span class="na">memory</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">resident</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">mem</span><span class="p">.</span><span class="nx">resident</span><span class="p">,</span>
        <span class="na">virtual</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">mem</span><span class="p">.</span><span class="nx">virtual</span><span class="p">,</span>
        <span class="na">mapped</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">mem</span><span class="p">.</span><span class="nx">mapped</span>
      <span class="p">},</span>
      <span class="na">connections</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">current</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span>
        <span class="na">available</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">available</span><span class="p">,</span>
        <span class="na">totalCreated</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">totalCreated</span>
      <span class="p">},</span>
      <span class="na">network</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">bytesIn</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">bytesIn</span><span class="p">,</span>
        <span class="na">bytesOut</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">bytesOut</span><span class="p">,</span>
        <span class="na">numRequests</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">numRequests</span>
      <span class="p">},</span>
      <span class="na">opcounters</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">opcounters</span><span class="p">,</span>
      <span class="na">wiredTiger</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">wiredTiger</span> <span class="p">?</span> <span class="p">{</span>
        <span class="na">cacheSize</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">wiredTiger</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="dl">'</span><span class="s1">bytes currently in the cache</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">cacheDirtySize</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">wiredTiger</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="dl">'</span><span class="s1">tracked dirty bytes in the cache</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">cacheReadIntoSize</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">wiredTiger</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="dl">'</span><span class="s1">bytes read into cache</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">cacheWrittenFromSize</span><span class="p">:</span> <span class="nx">serverStatus</span><span class="p">.</span><span class="nx">wiredTiger</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="dl">'</span><span class="s1">bytes written from cache</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">}</span> <span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getDatabaseMetrics</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">dbStats</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">stats</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">collections</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span>
      <span class="na">objects</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">objects</span><span class="p">,</span>
      <span class="na">avgObjSize</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">avgObjSize</span><span class="p">,</span>
      <span class="na">dataSize</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">dataSize</span><span class="p">,</span>
      <span class="na">storageSize</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">storageSize</span><span class="p">,</span>
      <span class="na">indexSize</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">indexSize</span><span class="p">,</span>
      <span class="na">indexes</span><span class="p">:</span> <span class="nx">dbStats</span><span class="p">.</span><span class="nx">indexes</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getSlowQueryMetrics</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Enable profiling for slow operations</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">({</span> <span class="na">profile</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">slowms</span><span class="p">:</span> <span class="mi">100</span> <span class="p">});</span>
    
    <span class="kd">const</span> <span class="nx">slowQueries</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">system.profile</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="na">ts</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">}</span> <span class="p">})</span> <span class="c1">// Last 5 minutes</span>
      <span class="p">.</span><span class="nx">sort</span><span class="p">({</span> <span class="na">ts</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">count</span><span class="p">:</span> <span class="nx">slowQueries</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="na">avgDuration</span><span class="p">:</span> <span class="nx">slowQueries</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">q</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">q</span><span class="p">.</span><span class="nx">millis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">slowQueries</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">queries</span><span class="p">:</span> <span class="nx">slowQueries</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// Top 10 slowest</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getReplicationMetrics</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">replStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">().</span><span class="nx">replSetGetStatus</span><span class="p">();</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">state</span><span class="p">:</span> <span class="nx">replStatus</span><span class="p">.</span><span class="nx">myState</span><span class="p">,</span>
        <span class="na">members</span><span class="p">:</span> <span class="nx">replStatus</span><span class="p">.</span><span class="nx">members</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">member</span> <span class="o">=&gt;</span> <span class="p">({</span>
          <span class="na">name</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
          <span class="na">state</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span>
          <span class="na">health</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">health</span><span class="p">,</span>
          <span class="na">uptime</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">uptime</span><span class="p">,</span>
          <span class="na">optime</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">optime</span><span class="p">,</span>
          <span class="na">syncSourceHost</span><span class="p">:</span> <span class="nx">member</span><span class="p">.</span><span class="nx">syncSourceHost</span>
        <span class="p">})),</span>
        <span class="na">replicationLag</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateReplicationLag</span><span class="p">(</span><span class="nx">replStatus</span><span class="p">.</span><span class="nx">members</span><span class="p">)</span>
      <span class="p">};</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Not in replica set or insufficient permissions</span><span class="dl">'</span> <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">getShardingMetrics</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">shardingStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">admin</span><span class="p">().</span><span class="nx">runCommand</span><span class="p">({</span> <span class="na">listShards</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">configDB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">);</span>
      
      <span class="kd">const</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">configDB</span><span class="p">.</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">();</span>
      <span class="kd">const</span> <span class="nx">balancerState</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">configDB</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">balancer</span><span class="dl">'</span> <span class="p">});</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">shards</span><span class="p">:</span> <span class="nx">shardingStatus</span><span class="p">.</span><span class="nx">shards</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="na">chunks</span><span class="p">:</span> <span class="nx">chunks</span><span class="p">,</span>
        <span class="na">balancerEnabled</span><span class="p">:</span> <span class="nx">balancerState</span> <span class="p">?</span> <span class="nx">balancerState</span><span class="p">.</span><span class="nx">stopped</span> <span class="o">!==</span> <span class="kc">true</span> <span class="p">:</span> <span class="kc">true</span>
      <span class="p">};</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Not in sharded cluster or insufficient permissions</span><span class="dl">'</span> <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">calculateReplicationLag</span><span class="p">(</span><span class="nx">members</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">primary</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">primary</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    
    <span class="kd">const</span> <span class="nx">secondaries</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">maxLag</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">secondaries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> 
      <span class="nx">primary</span><span class="p">.</span><span class="nx">optime</span><span class="p">.</span><span class="nx">ts</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">optime</span><span class="p">.</span><span class="nx">ts</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
    <span class="p">));</span>
    
    <span class="k">return</span> <span class="nx">maxLag</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// Convert to seconds</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">analyzeMetrics</span><span class="p">(</span><span class="nx">metrics</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">alerts</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="c1">// Connection alert</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">current</span> <span class="o">/</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">available</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alerts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH_CONNECTION_USAGE</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">severity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">WARNING</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`Connection usage at </span><span class="p">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">current</span> <span class="o">/</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">available</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)}</span><span class="s2">%`</span><span class="p">,</span>
        <span class="na">metrics</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">current</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span>
          <span class="na">available</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">available</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="c1">// Memory alert</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">resident</span> <span class="o">&gt;</span> <span class="mi">8000</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 8GB threshold</span>
      <span class="nx">alerts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH_MEMORY_USAGE</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">severity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">WARNING</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`Resident memory usage: </span><span class="p">${</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">resident</span><span class="p">}</span><span class="s2">MB`</span><span class="p">,</span>
        <span class="na">metrics</span><span class="p">:</span> <span class="p">{</span> <span class="na">resident</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">resident</span> <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="c1">// Slow query alert</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">queries</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alerts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH_SLOW_QUERY_RATE</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">severity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CRITICAL</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">queries</span><span class="p">.</span><span class="nx">count</span><span class="p">}</span><span class="s2"> slow queries in last 5 minutes`</span><span class="p">,</span>
        <span class="na">metrics</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">count</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">queries</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
          <span class="na">avgDuration</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">queries</span><span class="p">.</span><span class="nx">avgDuration</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="c1">// Replication lag alert</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">replicationLag</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alerts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HIGH_REPLICATION_LAG</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">severity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CRITICAL</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`Replication lag: </span><span class="p">${</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">replicationLag</span><span class="p">}</span><span class="s2"> seconds`</span><span class="p">,</span>
        <span class="na">metrics</span><span class="p">:</span> <span class="p">{</span> <span class="na">lag</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">replicationLag</span> <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="c1">// Process and store alerts</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">alert</span> <span class="k">of</span> <span class="nx">alerts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">processAlert</span><span class="p">(</span><span class="nx">alert</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">processAlert</span><span class="p">(</span><span class="nx">alert</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">alertDocument</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">alert</span><span class="p">,</span>
      <span class="nx">timestamp</span><span class="p">,</span>
      <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ACTIVE</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">acknowledged</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">resolvedAt</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">alertCollection</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">alertDocument</span><span class="p">);</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">alertManager</span><span class="p">.</span><span class="nx">sendAlert</span><span class="p">(</span><span class="nx">alertDocument</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Automated backup and disaster recovery</span>
<span class="kd">class</span> <span class="nx">BackupManager</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">mongoUri</span><span class="p">,</span> <span class="nx">s3Config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mongoUri</span> <span class="o">=</span> <span class="nx">mongoUri</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">s3Config</span> <span class="o">=</span> <span class="nx">s3Config</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">createBackup</span><span class="p">(</span><span class="nx">databases</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">:.</span><span class="se">]</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">backupId</span> <span class="o">=</span> <span class="s2">`backup-</span><span class="p">${</span><span class="nx">timestamp</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">dbName</span> <span class="k">of</span> <span class="nx">databases</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">backupDatabase</span><span class="p">(</span><span class="nx">dbName</span><span class="p">,</span> <span class="nx">backupId</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">uploadToS3</span><span class="p">(</span><span class="nx">backupId</span><span class="p">);</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">recordBackup</span><span class="p">(</span><span class="nx">backupId</span><span class="p">,</span> <span class="nx">databases</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">backupId</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Backup failed for </span><span class="p">${</span><span class="nx">backupId</span><span class="p">}</span><span class="s2">:`</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">backupDatabase</span><span class="p">(</span><span class="nx">dbName</span><span class="p">,</span> <span class="nx">backupId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">backupPath</span> <span class="o">=</span> <span class="s2">`/tmp/backups/</span><span class="p">${</span><span class="nx">backupId</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">dbName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    
    <span class="c1">// Use mongodump for consistent backup</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">execSync</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="s2">`mongodump --uri="</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">mongoUri</span><span class="p">}</span><span class="s2">" --db=</span><span class="p">${</span><span class="nx">dbName</span><span class="p">}</span><span class="s2"> --out=</span><span class="p">${</span><span class="nx">backupPath</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    
    <span class="nx">execSync</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="p">{</span> <span class="na">stdio</span><span class="p">:</span> <span class="dl">'</span><span class="s1">inherit</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">uploadToS3</span><span class="p">(</span><span class="nx">backupId</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Implementation for S3 upload</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Uploading backup </span><span class="p">${</span><span class="nx">backupId</span><span class="p">}</span><span class="s2"> to S3...`</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">recordBackup</span><span class="p">(</span><span class="nx">backupId</span><span class="p">,</span> <span class="nx">databases</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mongoUri</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
    
    <span class="kd">const</span> <span class="nx">adminDb</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">adminDb</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">backups</span><span class="dl">'</span><span class="p">).</span><span class="nx">insertOne</span><span class="p">({</span>
      <span class="nx">backupId</span><span class="p">,</span>
      <span class="nx">databases</span><span class="p">,</span>
      <span class="na">createdAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">COMPLETED</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">location</span><span class="p">:</span> <span class="s2">`s3://</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">s3Config</span><span class="p">.</span><span class="nx">bucket</span><span class="p">}</span><span class="s2">/backups/</span><span class="p">${</span><span class="nx">backupId</span><span class="p">}</span><span class="s2">`</span>
    <span class="p">});</span>
    
    <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="conclusion">Conclusion</h2>

<p>MongoDB has evolved from a simple document database into a comprehensive data platform capable of supporting the most demanding enterprise applications. This comprehensive exploration demonstrates that successful MongoDB implementations require deep understanding of architectural patterns, performance optimization strategies, and operational excellence practices.</p>

<p><br /></p>

<h3 id="key-success-factors-for-production-mongodb">Key Success Factors for Production MongoDB:</h3>

<p><strong>Architecture Excellence</strong>: Implementing appropriate replica set configurations, sharding strategies, and distributed system patterns ensures scalability and reliability at enterprise scale.</p>

<p><strong>Data Modeling Mastery</strong>: Leveraging MongoDB’s flexible document model while applying proper normalization strategies, indexing patterns, and schema evolution techniques optimizes performance and maintainability.</p>

<p><strong>Security Implementation</strong>: Comprehensive security measures including RBAC, field-level encryption, audit logging, and compliance frameworks protect sensitive data and meet regulatory requirements.</p>

<p><strong>Operational Excellence</strong>: Proactive monitoring, automated alerting, robust backup strategies, and performance optimization enable reliable production operations.</p>

<p><strong>Modern Integration Patterns</strong>: Event sourcing, CQRS, saga patterns, and microservices architectures leverage MongoDB’s strengths in distributed, cloud-native environments.</p>

<p><br /></p>

<h3 id="future-considerations">Future Considerations:</h3>

<p>As MongoDB continues evolving with features like vector search for AI workloads, enhanced time series capabilities, and improved multi-cloud operations, the fundamental principles explored in this guide provide a solid foundation for embracing new capabilities while maintaining operational excellence.</p>

<p>The investment in understanding MongoDB’s advanced capabilities and implementation patterns enables organizations to build scalable, secure, and maintainable data architectures that can adapt to changing business requirements and technological landscapes.</p>

<p>Whether implementing greenfield applications or optimizing existing MongoDB deployments, these patterns and practices provide the depth needed for production success at any scale.</p>

<p><br /></p>

<hr />

<h2 id="references-and-further-reading">References and Further Reading</h2>

<ul>
  <li><a href="https://www.mongodb.com/docs/">MongoDB Official Documentation</a></li>
  <li><a href="https://www.mongodb.com/collateral/mongodb-operations-best-practices">MongoDB Production Best Practices</a></li>
  <li><a href="https://www.mongodb.com/collateral/mongodb-performance-best-practices">MongoDB Performance Best Practices</a></li>
  <li><a href="https://www.mongodb.com/collateral/mongodb-security-checklist">MongoDB Security Checklist</a></li>
  <li><a href="https://www.mongodb.com/blog/post/building-with-patterns-a-summary">Building with Patterns: MongoDB Data Modeling</a></li>
  <li><a href="https://www.mongodb.com/collateral/mongodb-architecture-guide">MongoDB Architecture Guide</a></li>
  <li><a href="https://dataintensive.net/">Designing Data-Intensive Applications - Martin Kleppmann</a></li>
  <li><a href="https://www.oreilly.com/library/view/mongodb-the-definitive/9781491954454/">MongoDB: The Definitive Guide - Shannon Bradshaw</a></li>
  <li><a href="https://www.mongodb.com/blog/post/event-sourcing-with-mongodb">Event Sourcing with MongoDB</a></li>
  <li><a href="https://learn.mongodb.com/">MongoDB University</a></li>
  <li><a href="https://www.mongodb.com/community/forums/">MongoDB Community Forums</a></li>
  <li><a href="https://github.com/mongodb/mongo">MongoDB GitHub Repository</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/iac/pulumi/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755152827/pulumi-1_bmpstq.png">
                                    
                                    <h3>Pulumi: Modern Infrastructure as Code with Programming Languages</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/storage/deploying-rook-ceph-kubernetes-complete-guide/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755078066/rook-ceph-1_ompm5x.png">
                                    
                                    <h3>Deploying and Operating Rook-Ceph on Kubernetes: Complete Implementation Guide</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/iac/terraformer/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755143598/terraformer-1_xowy61.png">
                                    
                                    <h3>Terraformer: Reverse Engineering Infrastructure to Terraform</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="75">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/cs/process-thread/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1737100636/process-thared-sh_rybwfg.png">
                
            </div>
            <h3 class="title">Understanding Processes and Threads</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Master MongoDB from core concepts to production-ready implementations with advanced data modeling, performance optimization, and distributed system patterns&quot;%20https://somaz.blog/category/database/mongodb/%20via%20&#64;twitter_username&hashtags=mongodb,nosql,database,distributed-systems,performance,microservices,data-modeling"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/database/mongodb/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/database/mongodb/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "MongoDB: From Fundamentals to Production Excellence",
            "headline": "Comprehensive guide to MongoDB architecture, advanced patterns, and enterprise deployment strategies",
            "description": "Master MongoDB from core concepts to production-ready implementations with advanced data modeling, performance optimization, and distributed system patterns",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1755739632/mongodb-1_zqkghg.png",
            "url": "https://somaz.blog/category/database/mongodb/",
            "articleBody": "



Overview

MongoDB has evolved from a simple document database to a comprehensive data platform powering modern applications at unprecedented scale.

As organizations embrace cloud-native architectures, microservices, and real-time analytics, MongoDB serves as the backbone for flexible, scalable data solutions.

This comprehensive guide explores MongoDB from foundational concepts to advanced production patterns, covering everything from document modeling principles to distributed system architectures.

Whether you’re architecting a new application, optimizing existing deployments, or implementing enterprise-grade MongoDB solutions, this guide provides the depth and practical insights needed for success.

Modern MongoDB deployments face complex challenges: multi-cloud distribution, real-time synchronization, security compliance, and operational excellence.

Understanding these challenges and implementing appropriate solutions distinguishes successful MongoDB implementations from basic deployments.


  
    graph LR
      A[MongoDB Evolution] --&amp;gt; B[Document Database2009-2012]
      A --&amp;gt; C[Distributed Platform2013-2018]
      A --&amp;gt; D[Cloud-Native Solution2019-Present]
      
      B --&amp;gt; B1[BSON Documents]
      B --&amp;gt; B2[Dynamic Schema]
      B --&amp;gt; B3[Simple Replication]
      
      C --&amp;gt; C1[Sharding]
      C --&amp;gt; C2[Aggregation Framework]
      C --&amp;gt; C3[WiredTiger Engine]
      C --&amp;gt; C4[ACID Transactions]
      
      D --&amp;gt; D1[Atlas Cloud Platform]
      D --&amp;gt; D2[Multi-Cloud Clusters]
      D --&amp;gt; D3[Serverless Instances]
      D --&amp;gt; D4[Vector Search]
      D --&amp;gt; D5[Time Series Collections]
      
      style A fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
      style B fill:#fff3e0,stroke:#f57c00,stroke-width:2px
      style C fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style D fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
  



  MongoDB Evolution: From simple document storage to comprehensive cloud-native data platform






MongoDB Architecture Deep Dive

MongoDB’s architecture is designed for horizontal scaling, high availability, and operational simplicity. Understanding its core components enables effective deployment strategies and optimization techniques.


  
    graph LR
      A[MongoDB Cluster Architecture] --&amp;gt; B[Replica SetsHigh Availability]
      A --&amp;gt; C[Sharded ClustersHorizontal Scaling]
      A --&amp;gt; D[Config ServersMetadata Management]
      A --&amp;gt; E[Query Routersmongos]
      
      B --&amp;gt; B1[Primary NodeRead/Write Operations]
      B --&amp;gt; B2[Secondary NodesData Replication]
      B --&amp;gt; B3[Arbiter NodesElection Participation]
      B --&amp;gt; B4[Hidden MembersAnalytics/Backup]
      
      C --&amp;gt; C1[Shard Key Selection]
      C --&amp;gt; C2[Chunk Distribution]
      C --&amp;gt; C3[Balancer Process]
      C --&amp;gt; C4[Zone Sharding]
      
      D --&amp;gt; D1[Cluster Metadata]
      D --&amp;gt; D2[Shard Mapping]
      D --&amp;gt; D3[Balancer State]
      
      E --&amp;gt; E1[Query Routing]
      E --&amp;gt; E2[Load Distribution]
      E --&amp;gt; E3[Connection Pooling]
      
      style A fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
      style B fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style C fill:#fff3e0,stroke:#f57c00,stroke-width:2px
      style D fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
      style E fill:#ffebee,stroke:#d32f2f,stroke-width:2px
  



  MongoDB Cluster Architecture: Comprehensive view of components and their interactions




Advanced Replica Set Configuration

Modern replica sets require sophisticated configuration for optimal performance, availability, and operational flexibility.

Production-Ready Replica Set Setup
// Advanced replica set configuration
rs.initiate({
  _id: &quot;production-replica-set&quot;,
  version: 1,
  members: [
    {
      _id: 0,
      host: &quot;mongo-primary.internal:27017&quot;,
      priority: 2,
      tags: { region: &quot;us-east-1&quot;, role: &quot;primary&quot; }
    },
    {
      _id: 1,
      host: &quot;mongo-secondary-1.internal:27017&quot;,
      priority: 1,
      tags: { region: &quot;us-east-1&quot;, role: &quot;secondary&quot; }
    },
    {
      _id: 2,
      host: &quot;mongo-secondary-2.internal:27017&quot;,
      priority: 1,
      tags: { region: &quot;us-west-2&quot;, role: &quot;secondary&quot; }
    },
    {
      _id: 3,
      host: &quot;mongo-analytics.internal:27017&quot;,
      priority: 0,
      hidden: true,
      votes: 0,
      tags: { role: &quot;analytics&quot;, workload: &quot;reporting&quot; }
    },
    {
      _id: 4,
      host: &quot;mongo-delayed.internal:27017&quot;,
      priority: 0,
      hidden: true,
      votes: 0,
      slaveDelay: 3600, // 1-hour delay for disaster recovery
      tags: { role: &quot;delayed-secondary&quot; }
    }
  ],
  settings: {
    chainingAllowed: true,
    heartbeatIntervalMillis: 2000,
    heartbeatTimeoutSecs: 10,
    electionTimeoutMillis: 10000,
    catchUpTimeoutMillis: 60000,
    getLastErrorModes: {
      &quot;cross-region&quot;: { region: 2 },
      &quot;majority-plus-analytics&quot;: { role: 3 }
    },
    getLastErrorDefaults: {
      w: &quot;majority&quot;,
      wtimeout: 5000
    }
  }
});

// Configure read preferences for different workloads
db.getMongo().setReadPref(&quot;primaryPreferred&quot;, [
  { region: &quot;us-east-1&quot; }
]);

// Analytics workload configuration
db.getMongo().setReadPref(&quot;secondary&quot;, [
  { role: &quot;analytics&quot; }
]);


Advanced Write Concerns and Read Preferences
// Write concern strategies for different use cases
const writeConfigs = {
  // Critical financial transactions
  financial: {
    w: &quot;majority&quot;,
    j: true,
    wtimeout: 5000
  },
  
  // Cross-region durability
  crossRegion: {
    w: &quot;cross-region&quot;,
    j: true,
    wtimeout: 10000
  },
  
  // High-throughput logging
  logging: {
    w: 1,
    j: false,
    wtimeout: 1000
  },
  
  // Analytics data ingestion
  analytics: {
    w: &quot;majority-plus-analytics&quot;,
    j: true,
    wtimeout: 15000
  }
};

// Application-specific implementations
await db.transactions.insertOne(
  { 
    userId: ObjectId(&quot;...&quot;),
    amount: 1000.00,
    type: &quot;transfer&quot;,
    timestamp: new Date()
  },
  { writeConcern: writeConfigs.financial }
);

// Read preference optimization
const readPreferences = {
  // Real-time user data
  userProfile: { mode: &quot;primary&quot; },
  
  // Analytics and reporting
  analytics: { 
    mode: &quot;secondary&quot;,
    tags: [{ role: &quot;analytics&quot; }],
    maxStalenessSeconds: 300
  },
  
  // Search and discovery
  search: {
    mode: &quot;secondaryPreferred&quot;,
    tags: [{ region: &quot;us-east-1&quot; }]
  }
};




Sharding Architecture and Optimization

Effective sharding requires careful planning of shard key selection, chunk distribution, and balancing strategies.


  
    graph LR
      A[Client Application] --&amp;gt; B[mongos Router]
      B --&amp;gt; C[Config Server Replica Set]
      B --&amp;gt; D[Shard 1Replica Set]
      B --&amp;gt; E[Shard 2Replica Set]
      B --&amp;gt; F[Shard 3Replica Set]
      
      C --&amp;gt; C1[Cluster Metadata]
      C --&amp;gt; C2[Chunk Mappings]
      C --&amp;gt; C3[Balancer Configuration]
      
      D --&amp;gt; D1[Range: min - 1000]
      E --&amp;gt; E1[Range: 1000 - 2000]
      F --&amp;gt; F1[Range: 2000 - max]
      
      G[Zone Sharding] --&amp;gt; H[Geographic Distribution]
      G --&amp;gt; I[Workload Isolation]
      G --&amp;gt; J[Hardware Optimization]
      
      style B fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
      style C fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
      style D fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style E fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style F fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      style G fill:#fff3e0,stroke:#f57c00,stroke-width:2px
  



  Sharded Cluster Architecture: Data distribution and query routing mechanisms


Strategic Shard Key Selection
// Anti-patterns to avoid
const badShardKeys = {
  // Monotonically increasing - creates hotspots
  timestamp: { _id: 1 },
  autoIncrement: { sequence: 1 },
  
  // Low cardinality - limits scaling
  status: { status: 1 },
  category: { category: 1 },
  
  // Non-queryable - forces scatter-gather
  hash: { _id: &quot;hashed&quot; } // without query patterns
};

// Effective shard key strategies
const goodShardKeys = {
  // High cardinality + query pattern alignment
  userActivity: { userId: 1, timestamp: 1 },
  
  // Compound key for even distribution
  ecommerce: { customerId: 1, orderId: 1 },
  
  // Geographic distribution
  iot: { deviceRegion: 1, deviceId: 1, timestamp: 1 },
  
  // Hash for even distribution when range isn&apos;t suitable
  socialMedia: { userId: &quot;hashed&quot; }
};

// Implementation with zone sharding
sh.enableSharding(&quot;ecommerce&quot;);

// Create zones for geographic distribution
sh.addShardToZone(&quot;shard-us-east&quot;, &quot;us-east&quot;);
sh.addShardToZone(&quot;shard-us-west&quot;, &quot;us-west&quot;);
sh.addShardToZone(&quot;shard-europe&quot;, &quot;europe&quot;);

// Define zone ranges
sh.updateZoneKeyRange(
  &quot;ecommerce.orders&quot;,
  { region: &quot;us-east&quot;, customerId: MinKey },
  { region: &quot;us-east&quot;, customerId: MaxKey },
  &quot;us-east&quot;
);

// Shard the collection
sh.shardCollection(&quot;ecommerce.orders&quot;, { 
  region: 1, 
  customerId: 1, 
  orderDate: 1 
});


Advanced Balancer Configuration
// Custom balancer settings for different workloads
db.adminCommand({
  balancerCollectionStatus: &quot;ecommerce.orders&quot;,
  defragmentCollection: true
});

// Configure balancer windows
db.settings.updateOne(
  { _id: &quot;balancer&quot; },
  { 
    $set: { 
      activeWindow: {
        start: &quot;02:00&quot;,  // 2 AM
        stop: &quot;06:00&quot;    // 6 AM
      },
      mode: &quot;full&quot;
    }
  },
  { upsert: true }
);

// Optimize chunk size for specific collections
db.adminCommand({
  configureCollectionBalancing: &quot;ecommerce.orders&quot;,
  chunkSize: 128,  // MB
  defragmentCollection: true,
  enableAutoSplit: true
});




Advanced Data Modeling Patterns

MongoDB’s flexible document model enables sophisticated data modeling patterns that align with application access patterns and performance requirements.



Document Design Strategies

Dynamic Schema Evolution
// Schema versioning for backward compatibility
const userSchemaV1 = {
  _id: ObjectId(&quot;...&quot;),
  schemaVersion: 1,
  email: &quot;user@example.com&quot;,
  name: &quot;John Doe&quot;,
  created: new Date()
};

const userSchemaV2 = {
  _id: ObjectId(&quot;...&quot;),
  schemaVersion: 2,
  email: &quot;user@example.com&quot;,
  profile: {
    firstName: &quot;John&quot;,
    lastName: &quot;Doe&quot;,
    displayName: &quot;John Doe&quot;
  },
  preferences: {
    theme: &quot;dark&quot;,
    notifications: true,
    language: &quot;en&quot;
  },
  created: new Date(),
  lastModified: new Date()
};

// Migration strategy with version checks
function migrateUser(user) {
  switch (user.schemaVersion || 1) {
    case 1:
      return {
        ...user,
        schemaVersion: 2,
        profile: {
          firstName: user.name.split(&apos; &apos;)[0],
          lastName: user.name.split(&apos; &apos;)[1] || &apos;&apos;,
          displayName: user.name
        },
        preferences: {
          theme: &quot;light&quot;,
          notifications: true,
          language: &quot;en&quot;
        },
        lastModified: new Date()
      };
    case 2:
      return user; // Already current version
    default:
      throw new Error(`Unknown schema version: ${user.schemaVersion}`);
  }
}


Advanced Embedding vs Referencing Patterns
// Product catalog with complex relationships
const productCatalog = {
  // Embedded for frequently accessed, bounded data
  product: {
    _id: ObjectId(&quot;...&quot;),
    sku: &quot;LAPTOP-001&quot;,
    name: &quot;Gaming Laptop&quot;,
    
    // Embedded specifications (1-to-1, rarely changes)
    specifications: {
      processor: &quot;Intel i7-12700H&quot;,
      memory: &quot;32GB DDR4&quot;,
      storage: &quot;1TB NVMe SSD&quot;,
      graphics: &quot;RTX 3070&quot;,
      display: {
        size: &quot;15.6 inches&quot;,
        resolution: &quot;1920x1080&quot;,
        refreshRate: &quot;144Hz&quot;
      }
    },
    
    // Embedded pricing (frequently accessed with product)
    pricing: {
      msrp: 1499.99,
      currentPrice: 1299.99,
      currency: &quot;USD&quot;,
      discounts: [
        {
          type: &quot;seasonal&quot;,
          amount: 200.00,
          validUntil: new Date(&quot;2024-12-31&quot;)
        }
      ]
    },
    
    // Referenced for large, independently managed data
    categoryId: ObjectId(&quot;category-laptops&quot;),
    brandId: ObjectId(&quot;brand-gaming&quot;),
    
    // Embedded recent reviews (limited subset)
    recentReviews: [
      {
        _id: ObjectId(&quot;...&quot;),
        userId: ObjectId(&quot;...&quot;),
        rating: 5,
        title: &quot;Excellent performance&quot;,
        summary: &quot;Great for gaming and development work...&quot;,
        date: new Date(),
        helpful: 23
      }
    ],
    
    // Referenced for complete review data
    totalReviews: 156,
    averageRating: 4.7,
    
    // Embedded inventory (frequently updated)
    inventory: {
      available: 45,
      reserved: 12,
      reorderLevel: 10,
      lastUpdated: new Date()
    }
  }
};

// Separate collections for scalable data
const reviews = {
  _id: ObjectId(&quot;...&quot;),
  productId: ObjectId(&quot;product-id&quot;),
  userId: ObjectId(&quot;user-id&quot;),
  rating: 5,
  title: &quot;Excellent performance&quot;,
  content: &quot;Detailed review content...&quot;,
  images: [&quot;review-img-1.jpg&quot;, &quot;review-img-2.jpg&quot;],
  verified: true,
  helpful: 23,
  replies: [
    {
      userId: ObjectId(&quot;...&quot;),
      content: &quot;Thanks for the detailed review!&quot;,
      date: new Date()
    }
  ],
  created: new Date(),
  lastModified: new Date()
};


Polymorphic Data Patterns
// Event-driven architecture with polymorphic events
const eventStore = [
  {
    _id: ObjectId(&quot;...&quot;),
    eventType: &quot;UserRegistered&quot;,
    aggregateId: &quot;user-123&quot;,
    aggregateVersion: 1,
    eventData: {
      email: &quot;user@example.com&quot;,
      registrationSource: &quot;web&quot;,
      marketingConsent: true
    },
    metadata: {
      ipAddress: &quot;192.168.1.1&quot;,
      userAgent: &quot;Mozilla/5.0...&quot;,
      correlationId: &quot;reg-123&quot;
    },
    timestamp: new Date(),
    processed: false
  },
  {
    _id: ObjectId(&quot;...&quot;),
    eventType: &quot;OrderPlaced&quot;,
    aggregateId: &quot;order-456&quot;,
    aggregateVersion: 1,
    eventData: {
      customerId: &quot;user-123&quot;,
      items: [
        { productId: &quot;prod-1&quot;, quantity: 2, price: 29.99 },
        { productId: &quot;prod-2&quot;, quantity: 1, price: 15.50 }
      ],
      totalAmount: 75.48,
      paymentMethod: &quot;stripe&quot;,
      shippingAddress: {
        street: &quot;123 Main St&quot;,
        city: &quot;New York&quot;,
        state: &quot;NY&quot;,
        zip: &quot;10001&quot;
      }
    },
    metadata: {
      sessionId: &quot;sess-789&quot;,
      promotionCode: &quot;SAVE10&quot;
    },
    timestamp: new Date(),
    processed: false
  }
];

// Polymorphic query patterns
const eventHandlers = {
  async handleUserRegistered(event) {
    await db.users.insertOne({
      _id: event.aggregateId,
      email: event.eventData.email,
      registrationSource: event.eventData.registrationSource,
      marketingConsent: event.eventData.marketingConsent,
      created: event.timestamp
    });
  },
  
  async handleOrderPlaced(event) {
    await db.orders.insertOne({
      _id: event.aggregateId,
      customerId: event.eventData.customerId,
      items: event.eventData.items,
      totalAmount: event.eventData.totalAmount,
      status: &quot;pending&quot;,
      created: event.timestamp
    });
  }
};

// Event processing with polymorphic dispatch
async function processEvents() {
  const unprocessedEvents = await db.events.find({ processed: false })
    .sort({ timestamp: 1 })
    .limit(100)
    .toArray();
  
  for (const event of unprocessedEvents) {
    const handlerName = `handle${event.eventType}`;
    const handler = eventHandlers[handlerName];
    
    if (handler) {
      try {
        await handler(event);
        await db.events.updateOne(
          { _id: event._id },
          { $set: { processed: true, processedAt: new Date() } }
        );
      } catch (error) {
        await db.events.updateOne(
          { _id: event._id },
          { 
            $set: { 
              processingError: error.message,
              processingAttempts: (event.processingAttempts || 0) + 1
            }
          }
        );
      }
    }
  }
}




Time Series and IoT Data Patterns

MongoDB’s time series collections optimize storage and queries for time-stamped data.

// Time series collection for IoT sensor data
db.createCollection(&quot;sensor_data&quot;, {
  timeseries: {
    timeField: &quot;timestamp&quot;,
    metaField: &quot;sensor&quot;,
    granularity: &quot;minutes&quot;,
    bucketMaxSpanSeconds: 3600,
    bucketRoundingSeconds: 60
  },
  expireAfterSeconds: 31536000 // 1 year retention
});

// Optimized IoT data structure
const sensorReading = {
  timestamp: new Date(),
  sensor: {
    deviceId: &quot;sensor-001&quot;,
    location: &quot;warehouse-a&quot;,
    type: &quot;temperature-humidity&quot;,
    model: &quot;DHT22&quot;
  },
  measurements: {
    temperature: 23.5,
    humidity: 65.2,
    batteryLevel: 87
  },
  metadata: {
    firmware: &quot;v1.2.3&quot;,
    signalStrength: -45,
    dataQuality: &quot;good&quot;
  }
};

// Efficient time series queries
const temperatureAggregation = [
  {
    $match: {
      &quot;timestamp&quot;: {
        $gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // Last 24 hours
      },
      &quot;sensor.type&quot;: &quot;temperature-humidity&quot;
    }
  },
  {
    $group: {
      _id: {
        deviceId: &quot;$sensor.deviceId&quot;,
        hour: {
          $dateTrunc: {
            date: &quot;$timestamp&quot;,
            unit: &quot;hour&quot;
          }
        }
      },
      avgTemperature: { $avg: &quot;$measurements.temperature&quot; },
      maxTemperature: { $max: &quot;$measurements.temperature&quot; },
      minTemperature: { $min: &quot;$measurements.temperature&quot; },
      readingCount: { $sum: 1 }
    }
  },
  {
    $sort: { &quot;_id.hour&quot;: 1 }
  }
];

// Real-time anomaly detection
const anomalyDetection = [
  {
    $match: {
      &quot;timestamp&quot;: {
        $gte: new Date(Date.now() - 60 * 60 * 1000) // Last hour
      }
    }
  },
  {
    $setWindowFields: {
      partitionBy: &quot;$sensor.deviceId&quot;,
      sortBy: { timestamp: 1 },
      output: {
        movingAverage: {
          $avg: &quot;$measurements.temperature&quot;,
          window: {
            documents: [-10, 0] // 10-point moving average
          }
        },
        standardDeviation: {
          $stdDevSamp: &quot;$measurements.temperature&quot;,
          window: {
            documents: [-20, 0]
          }
        }
      }
    }
  },
  {
    $addFields: {
      anomaly: {
        $gt: [
          {
            $abs: {
              $subtract: [&quot;$measurements.temperature&quot;, &quot;$movingAverage&quot;]
            }
          },
          { $multiply: [&quot;$standardDeviation&quot;, 2] } // 2-sigma threshold
        ]
      }
    }
  },
  {
    $match: { anomaly: true }
  }
];




Performance Optimization and Indexing Strategies

MongoDB performance optimization requires comprehensive indexing strategies, query optimization, and architectural considerations.



Advanced Indexing Patterns

Compound Index Optimization
// Query pattern analysis for index design
const queryPatterns = {
  // User activity lookup
  userActivity: {
    query: { userId: ObjectId(&quot;...&quot;), timestamp: { $gte: new Date() } },
    sort: { timestamp: -1 },
    limit: 50
  },
  
  // Product search with filters
  productSearch: {
    query: { 
      category: &quot;electronics&quot;, 
      price: { $gte: 100, $lte: 500 },
      inStock: true 
    },
    sort: { popularity: -1, price: 1 }
  },
  
  // Geospatial queries
  nearbyStores: {
    query: {
      location: {
        $near: {
          $geometry: { type: &quot;Point&quot;, coordinates: [-73.9857, 40.7484] },
          $maxDistance: 5000
        }
      },
      storeType: &quot;retail&quot;
    }
  }
};

// Optimized index strategies
const indexStrategies = {
  // ESR (Equality, Sort, Range) principle
  userActivityIndex: {
    keys: { userId: 1, timestamp: -1 }, // Equality first, then sort
    options: { 
      name: &quot;idx_user_activity_optimized&quot;,
      partialFilterExpression: { timestamp: { $exists: true } }
    }
  },
  
  // Compound index for product filtering
  productSearchIndex: {
    keys: { category: 1, inStock: 1, price: 1, popularity: -1 },
    options: {
      name: &quot;idx_product_search_compound&quot;,
      partialFilterExpression: { inStock: true }
    }
  },
  
  // Geospatial index
  storeLocationIndex: {
    keys: { location: &quot;2dsphere&quot;, storeType: 1 },
    options: { name: &quot;idx_store_location_type&quot; }
  },
  
  // Text search with language support
  productTextSearch: {
    keys: { 
      name: &quot;text&quot;, 
      description: &quot;text&quot;, 
      tags: &quot;text&quot; 
    },
    options: {
      name: &quot;idx_product_text_search&quot;,
      weights: { name: 10, description: 5, tags: 1 },
      default_language: &quot;english&quot;
    }
  }
};

// Index creation with monitoring
async function createOptimizedIndexes() {
  const collections = [
    { name: &quot;user_activity&quot;, indexes: [indexStrategies.userActivityIndex] },
    { name: &quot;products&quot;, indexes: [
      indexStrategies.productSearchIndex,
      indexStrategies.productTextSearch
    ]},
    { name: &quot;stores&quot;, indexes: [indexStrategies.storeLocationIndex] }
  ];
  
  for (const collection of collections) {
    for (const index of collection.indexes) {
      try {
        const result = await db[collection.name].createIndex(
          index.keys, 
          index.options
        );
        console.log(`Created index ${index.options.name}: ${result}`);
      } catch (error) {
        console.error(`Failed to create index ${index.options.name}:`, error);
      }
    }
  }
}


Sparse and Partial Indexes for Optimization
// Sparse indexes for optional fields
db.users.createIndex(
  { socialSecurityNumber: 1 },
  { 
    sparse: true,
    name: &quot;idx_users_ssn_sparse&quot;,
    unique: true
  }
);

// Partial indexes for specific conditions
db.orders.createIndex(
  { customerId: 1, orderDate: -1 },
  {
    partialFilterExpression: { 
      status: { $in: [&quot;pending&quot;, &quot;processing&quot;] }
    },
    name: &quot;idx_orders_active_customer_date&quot;
  }
);

// TTL indexes for automatic document expiration
db.sessions.createIndex(
  { lastAccessed: 1 },
  { expireAfterSeconds: 3600 } // 1 hour
);

db.logs.createIndex(
  { createdAt: 1 },
  { expireAfterSeconds: 2592000 } // 30 days
);

// Compound TTL with partial filter
db.temporaryData.createIndex(
  { expiresAt: 1 },
  {
    expireAfterSeconds: 0,
    partialFilterExpression: { 
      temporary: true 
    }
  }
);




Query Optimization Techniques

Aggregation Pipeline Optimization
// Inefficient aggregation pipeline
const inefficientPipeline = [
  { $match: { status: &quot;completed&quot; } },
  { $lookup: {
      from: &quot;products&quot;,
      localField: &quot;productId&quot;,
      foreignField: &quot;_id&quot;,
      as: &quot;product&quot;
    }
  },
  { $unwind: &quot;$product&quot; },
  { $match: { &quot;product.category&quot;: &quot;electronics&quot; } }, // Should be earlier
  { $group: {
      _id: &quot;$customerId&quot;,
      totalSpent: { $sum: &quot;$amount&quot; }
    }
  },
  { $sort: { totalSpent: -1 } },
  { $limit: 100 }
];

// Optimized aggregation pipeline
const optimizedPipeline = [
  // Early filtering reduces documents in pipeline
  { $match: { 
      status: &quot;completed&quot;,
      amount: { $gt: 0 } // Additional early filter
    }
  },
  
  // Index hint for optimal query plan
  { $hint: &quot;idx_orders_status_customer_amount&quot; },
  
  // Efficient lookup with pipeline for filtering
  { $lookup: {
      from: &quot;products&quot;,
      let: { productId: &quot;$productId&quot; },
      pipeline: [
        { $match: { 
            $expr: { $eq: [&quot;$_id&quot;, &quot;$$productId&quot;] },
            category: &quot;electronics&quot; // Filter in subpipeline
          }
        },
        { $project: { name: 1, category: 1 } } // Minimal projection
      ],
      as: &quot;product&quot;
    }
  },
  
  // Filter out documents without matching products
  { $match: { &quot;product.0&quot;: { $exists: true } } },
  
  // Group with optimized accumulator
  { $group: {
      _id: &quot;$customerId&quot;,
      totalSpent: { $sum: &quot;$amount&quot; },
      orderCount: { $sum: 1 },
      avgOrderValue: { $avg: &quot;$amount&quot; }
    }
  },
  
  // Sort and limit for top customers
  { $sort: { totalSpent: -1 } },
  { $limit: 100 },
  
  // Final projection for clean output
  { $project: {
      customerId: &quot;$_id&quot;,
      totalSpent: 1,
      orderCount: 1,
      avgOrderValue: { $round: [&quot;$avgOrderValue&quot;, 2] },
      _id: 0
    }
  }
];

// Performance monitoring wrapper
async function executeOptimizedAggregation(pipeline, options = {}) {
  const startTime = Date.now();
  
  try {
    const result = await db.orders.aggregate(pipeline, {
      allowDiskUse: true,
      cursor: { batchSize: 1000 },
      ...options
    }).toArray();
    
    const executionTime = Date.now() - startTime;
    
    // Log performance metrics
    await db.query_performance.insertOne({
      query: &quot;customer_electronics_analysis&quot;,
      executionTime,
      resultCount: result.length,
      timestamp: new Date(),
      pipeline: pipeline.length
    });
    
    return result;
  } catch (error) {
    console.error(&quot;Aggregation failed:&quot;, error);
    throw error;
  }
}


Query Plan Analysis and Optimization
// Query performance analysis
async function analyzeQueryPerformance() {
  const query = { 
    category: &quot;electronics&quot;, 
    price: { $gte: 100, $lte: 1000 },
    inStock: true 
  };
  
  // Explain query execution
  const explanation = await db.products.find(query)
    .sort({ popularity: -1 })
    .limit(20)
    .explain(&quot;executionStats&quot;);
  
  console.log(&quot;Query Execution Stats:&quot;);
  console.log(`Execution Time: ${explanation.executionStats.executionTimeMillis}ms`);
  console.log(`Documents Examined: ${explanation.executionStats.totalDocsExamined}`);
  console.log(`Documents Returned: ${explanation.executionStats.totalDocsReturned}`);
  console.log(`Index Used: ${explanation.executionStats.executionStages.indexName || &apos;COLLSCAN&apos;}`);
  
  // Calculate selectivity
  const selectivity = explanation.executionStats.totalDocsReturned / 
                     explanation.executionStats.totalDocsExamined;
  
  if (selectivity &amp;lt; 0.1) {
    console.warn(&quot;Low selectivity detected. Consider index optimization.&quot;);
  }
  
  return explanation;
}

// Index usage monitoring
async function monitorIndexUsage() {
  const indexStats = await db.products.aggregate([
    { $indexStats: {} }
  ]).toArray();
  
  console.log(&quot;Index Usage Statistics:&quot;);
  indexStats.forEach(stat =&amp;gt; {
    console.log(`Index: ${stat.name}`);
    console.log(`  Accesses: ${stat.accesses.ops}`);
    console.log(`  Since: ${stat.accesses.since}`);
  });
  
  // Identify unused indexes
  const unusedIndexes = indexStats.filter(stat =&amp;gt; stat.accesses.ops === 0);
  if (unusedIndexes.length &amp;gt; 0) {
    console.warn(&quot;Unused indexes detected:&quot;, unusedIndexes.map(idx =&amp;gt; idx.name));
  }
}




Enterprise Patterns and Distributed Systems

Modern MongoDB deployments often serve as the data layer for distributed systems, requiring sophisticated patterns for consistency, scalability, and reliability.



Microservices Data Patterns

Database per Service with Event Sourcing
// User Service - Event Store Implementation
class UserEventStore {
  constructor(db) {
    this.db = db;
    this.collection = db.collection(&apos;user_events&apos;);
  }
  
  async appendEvent(streamId, expectedVersion, events) {
    const session = this.db.client.startSession();
    
    try {
      await session.withTransaction(async () =&amp;gt; {
        // Check current version for optimistic concurrency
        const currentEvents = await this.collection
          .find({ streamId }, { session })
          .sort({ version: -1 })
          .limit(1)
          .toArray();
        
        const currentVersion = currentEvents.length &amp;gt; 0 ? 
          currentEvents[0].version : 0;
        
        if (currentVersion !== expectedVersion) {
          throw new Error(`Concurrency conflict. Expected ${expectedVersion}, got ${currentVersion}`);
        }
        
        // Append new events
        const eventsToInsert = events.map((event, index) =&amp;gt; ({
          _id: new ObjectId(),
          streamId,
          version: expectedVersion + index + 1,
          eventType: event.type,
          eventData: event.data,
          metadata: {
            ...event.metadata,
            timestamp: new Date(),
            correlationId: event.metadata?.correlationId || new ObjectId().toString()
          }
        }));
        
        await this.collection.insertMany(eventsToInsert, { session });
        
        return eventsToInsert;
      });
    } finally {
      await session.endSession();
    }
  }
  
  async getEvents(streamId, fromVersion = 0) {
    return await this.collection
      .find({ 
        streamId, 
        version: { $gt: fromVersion } 
      })
      .sort({ version: 1 })
      .toArray();
  }
}

// Saga Orchestration Pattern
class OrderSagaOrchestrator {
  constructor(db) {
    this.db = db;
    this.sagaCollection = db.collection(&apos;order_sagas&apos;);
    this.stepCollection = db.collection(&apos;saga_steps&apos;);
  }
  
  async startOrderSaga(orderData) {
    const sagaId = new ObjectId();
    const saga = {
      _id: sagaId,
      sagaType: &apos;ProcessOrder&apos;,
      state: &apos;Started&apos;,
      currentStep: 0,
      data: orderData,
      steps: [
        { name: &apos;ReserveInventory&apos;, status: &apos;Pending&apos; },
        { name: &apos;ProcessPayment&apos;, status: &apos;Pending&apos; },
        { name: &apos;CreateShipment&apos;, status: &apos;Pending&apos; },
        { name: &apos;SendConfirmation&apos;, status: &apos;Pending&apos; }
      ],
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    await this.sagaCollection.insertOne(saga);
    await this.executeNextStep(sagaId);
    
    return sagaId;
  }
  
  async executeNextStep(sagaId) {
    const saga = await this.sagaCollection.findOne({ _id: sagaId });
    if (!saga || saga.currentStep &amp;gt;= saga.steps.length) {
      return;
    }
    
    const currentStep = saga.steps[saga.currentStep];
    
    try {
      // Execute step based on type
      const result = await this.executeStep(currentStep.name, saga.data);
      
      // Update step status
      await this.sagaCollection.updateOne(
        { _id: sagaId },
        {
          $set: {
            [`steps.${saga.currentStep}.status`]: &apos;Completed&apos;,
            [`steps.${saga.currentStep}.result`]: result,
            currentStep: saga.currentStep + 1,
            updatedAt: new Date()
          }
        }
      );
      
      // Continue to next step
      await this.executeNextStep(sagaId);
      
    } catch (error) {
      // Handle step failure
      await this.handleStepFailure(sagaId, saga.currentStep, error);
    }
  }
  
  async handleStepFailure(sagaId, failedStepIndex, error) {
    // Mark step as failed
    await this.sagaCollection.updateOne(
      { _id: sagaId },
      {
        $set: {
          [`steps.${failedStepIndex}.status`]: &apos;Failed&apos;,
          [`steps.${failedStepIndex}.error`]: error.message,
          state: &apos;Compensating&apos;,
          updatedAt: new Date()
        }
      }
    );
    
    // Execute compensation actions
    await this.executeCompensation(sagaId, failedStepIndex);
  }
  
  async executeCompensation(sagaId, fromStep) {
    const saga = await this.sagaCollection.findOne({ _id: sagaId });
    
    // Compensate completed steps in reverse order
    for (let i = fromStep - 1; i &amp;gt;= 0; i--) {
      const step = saga.steps[i];
      if (step.status === &apos;Completed&apos;) {
        try {
          await this.compensateStep(step.name, step.result, saga.data);
          
          await this.sagaCollection.updateOne(
            { _id: sagaId },
            {
              $set: {
                [`steps.${i}.compensated`]: true,
                updatedAt: new Date()
              }
            }
          );
        } catch (compensationError) {
          console.error(`Compensation failed for step ${step.name}:`, compensationError);
          // Handle compensation failure (manual intervention required)
        }
      }
    }
    
    await this.sagaCollection.updateOne(
      { _id: sagaId },
      { $set: { state: &apos;Failed&apos;, updatedAt: new Date() } }
    );
  }
}


CQRS with MongoDB
// Command Side - Write Model
class OrderCommandHandler {
  constructor(eventStore, db) {
    this.eventStore = eventStore;
    this.db = db;
  }
  
  async createOrder(command) {
    const orderId = new ObjectId().toString();
    const events = [
      {
        type: &apos;OrderCreated&apos;,
        data: {
          orderId,
          customerId: command.customerId,
          items: command.items,
          totalAmount: command.totalAmount
        },
        metadata: {
          commandId: command.id,
          userId: command.userId,
          timestamp: new Date()
        }
      }
    ];
    
    await this.eventStore.appendEvent(`order-${orderId}`, 0, events);
    return orderId;
  }
  
  async updateOrderStatus(command) {
    const events = await this.eventStore.getEvents(`order-${command.orderId}`);
    const order = this.reconstructOrderFromEvents(events);
    
    if (!order) {
      throw new Error(&apos;Order not found&apos;);
    }
    
    const newEvent = {
      type: &apos;OrderStatusChanged&apos;,
      data: {
        orderId: command.orderId,
        previousStatus: order.status,
        newStatus: command.newStatus,
        reason: command.reason
      },
      metadata: {
        commandId: command.id,
        userId: command.userId,
        timestamp: new Date()
      }
    };
    
    await this.eventStore.appendEvent(
      `order-${command.orderId}`, 
      events.length, 
      [newEvent]
    );
  }
  
  reconstructOrderFromEvents(events) {
    let order = null;
    
    for (const event of events) {
      switch (event.eventType) {
        case &apos;OrderCreated&apos;:
          order = {
            id: event.eventData.orderId,
            customerId: event.eventData.customerId,
            items: event.eventData.items,
            totalAmount: event.eventData.totalAmount,
            status: &apos;Created&apos;,
            createdAt: event.metadata.timestamp
          };
          break;
          
        case &apos;OrderStatusChanged&apos;:
          if (order) {
            order.status = event.eventData.newStatus;
            order.lastModified = event.metadata.timestamp;
          }
          break;
      }
    }
    
    return order;
  }
}

// Query Side - Read Model Projections
class OrderProjectionHandler {
  constructor(db) {
    this.db = db;
    this.orderSummaryCollection = db.collection(&apos;order_summary&apos;);
    this.customerOrdersCollection = db.collection(&apos;customer_orders&apos;);
  }
  
  async handleOrderCreated(event) {
    const orderSummary = {
      _id: event.eventData.orderId,
      customerId: event.eventData.customerId,
      itemCount: event.eventData.items.length,
      totalAmount: event.eventData.totalAmount,
      status: &apos;Created&apos;,
      createdAt: event.metadata.timestamp,
      lastModified: event.metadata.timestamp
    };
    
    await this.orderSummaryCollection.insertOne(orderSummary);
    
    // Update customer orders aggregation
    await this.customerOrdersCollection.updateOne(
      { _id: event.eventData.customerId },
      {
        $inc: { 
          totalOrders: 1,
          totalSpent: event.eventData.totalAmount
        },
        $set: { lastOrderDate: event.metadata.timestamp },
        $setOnInsert: { firstOrderDate: event.metadata.timestamp }
      },
      { upsert: true }
    );
  }
  
  async handleOrderStatusChanged(event) {
    await this.orderSummaryCollection.updateOne(
      { _id: event.eventData.orderId },
      {
        $set: {
          status: event.eventData.newStatus,
          lastModified: event.metadata.timestamp
        }
      }
    );
    
    // Update additional projections based on status
    if (event.eventData.newStatus === &apos;Completed&apos;) {
      await this.customerOrdersCollection.updateOne(
        { _id: event.eventData.customerId },
        { $inc: { completedOrders: 1 } }
      );
    }
  }
}




Multi-Tenant Architecture Patterns

Tenant Isolation Strategies





Security and Compliance

Enterprise MongoDB deployments require comprehensive security measures addressing authentication, authorization, encryption, and compliance requirements.



Advanced Security Implementation

Role-Based Access Control (RBAC)
// Custom role definitions for enterprise security
const securityRoles = {
  // Application service roles
  userServiceRole: {
    role: &quot;userServiceRole&quot;,
    privileges: [
      {
        resource: { db: &quot;userdb&quot;, collection: &quot;users&quot; },
        actions: [&quot;find&quot;, &quot;insert&quot;, &quot;update&quot;, &quot;remove&quot;]
      },
      {
        resource: { db: &quot;userdb&quot;, collection: &quot;user_sessions&quot; },
        actions: [&quot;find&quot;, &quot;insert&quot;, &quot;remove&quot;]
      }
    ],
    roles: []
  },
  
  // Analytics read-only role
  analyticsRole: {
    role: &quot;analyticsRole&quot;,
    privileges: [
      {
        resource: { db: &quot;&quot;, collection: &quot;&quot; }, // All databases
        actions: [&quot;find&quot;, &quot;listCollections&quot;, &quot;listIndexes&quot;]
      }
    ],
    roles: []
  },
  
  // Audit role with special permissions
  auditRole: {
    role: &quot;auditRole&quot;,
    privileges: [
      {
        resource: { cluster: true },
        actions: [&quot;auditLogRotate&quot;, &quot;viewRole&quot;, &quot;viewUser&quot;]
      },
      {
        resource: { db: &quot;audit&quot;, collection: &quot;&quot; },
        actions: [&quot;find&quot;, &quot;insert&quot;, &quot;listCollections&quot;]
      }
    ],
    roles: []
  }
};

// User creation with role assignment
async function createApplicationUsers(adminDb) {
  // Create custom roles
  for (const [roleName, roleConfig] of Object.entries(securityRoles)) {
    try {
      await adminDb.runCommand({
        createRole: roleConfig.role,
        privileges: roleConfig.privileges,
        roles: roleConfig.roles
      });
      console.log(`Created role: ${roleConfig.role}`);
    } catch (error) {
      if (error.code !== 51002) { // Role already exists
        console.error(`Failed to create role ${roleConfig.role}:`, error);
      }
    }
  }
  
  // Create application users
  const applicationUsers = [
    {
      user: &quot;userService&quot;,
      pwd: process.env.USER_SERVICE_PASSWORD,
      roles: [&quot;userServiceRole&quot;]
    },
    {
      user: &quot;analyticsService&quot;,
      pwd: process.env.ANALYTICS_SERVICE_PASSWORD,
      roles: [&quot;analyticsRole&quot;]
    },
    {
      user: &quot;auditService&quot;,
      pwd: process.env.AUDIT_SERVICE_PASSWORD,
      roles: [&quot;auditRole&quot;]
    }
  ];
  
  for (const userConfig of applicationUsers) {
    try {
      await adminDb.runCommand({
        createUser: userConfig.user,
        pwd: userConfig.pwd,
        roles: userConfig.roles
      });
      console.log(`Created user: ${userConfig.user}`);
    } catch (error) {
      if (error.code !== 51003) { // User already exists
        console.error(`Failed to create user ${userConfig.user}:`, error);
      }
    }
  }
}


Field-Level Encryption
// Client-side field level encryption setup
const { MongoClient } = require(&apos;mongodb&apos;);
const { ClientEncryption } = require(&apos;mongodb-client-encryption&apos;);

class FieldLevelEncryption {
  constructor(uri, keyVaultNamespace) {
    this.uri = uri;
    this.keyVaultNamespace = keyVaultNamespace;
    this.kmsProviders = {
      local: {
        key: Buffer.from(process.env.MASTER_KEY, &apos;base64&apos;)
      }
    };
  }
  
  async initialize() {
    // Create key vault client
    this.keyVaultClient = new MongoClient(this.uri);
    await this.keyVaultClient.connect();
    
    // Create client encryption
    this.clientEncryption = new ClientEncryption(
      this.keyVaultClient,
      {
        keyVaultNamespace: this.keyVaultNamespace,
        kmsProviders: this.kmsProviders
      }
    );
    
    // Create data encryption keys
    this.dataKeys = {
      ssn: await this.createDataKey(&apos;SSN_KEY&apos;),
      creditCard: await this.createDataKey(&apos;CREDIT_CARD_KEY&apos;),
      personalData: await this.createDataKey(&apos;PERSONAL_DATA_KEY&apos;)
    };
  }
  
  async createDataKey(altName) {
    try {
      return await this.clientEncryption.createDataKey(&apos;local&apos;, {
        keyAltNames: [altName]
      });
    } catch (error) {
      // Key might already exist, try to find it
      const keyVault = this.keyVaultClient
        .db(this.keyVaultNamespace.split(&apos;.&apos;)[0])
        .collection(this.keyVaultNamespace.split(&apos;.&apos;)[1]);
        
      const existingKey = await keyVault.findOne({
        keyAltNames: altName
      });
      
      return existingKey ? existingKey._id : null;
    }
  }
  
  async encryptField(value, fieldType, algorithm = &apos;AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic&apos;) {
    const keyId = this.dataKeys[fieldType];
    if (!keyId) {
      throw new Error(`No encryption key found for field type: ${fieldType}`);
    }
    
    return await this.clientEncryption.encrypt(value, {
      keyId,
      algorithm
    });
  }
  
  async decryptField(encryptedValue) {
    return await this.clientEncryption.decrypt(encryptedValue);
  }
  
  // Create encrypted client with automatic encryption
  async createEncryptedClient() {
    const schemaMap = {
      &quot;healthcare.patients&quot;: {
        bsonType: &quot;object&quot;,
        properties: {
          ssn: {
            encrypt: {
              keyId: this.dataKeys.ssn,
              bsonType: &quot;string&quot;,
              algorithm: &quot;AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic&quot;
            }
          },
          medicalRecord: {
            encrypt: {
              keyId: this.dataKeys.personalData,
              bsonType: &quot;object&quot;,
              algorithm: &quot;AEAD_AES_256_CBC_HMAC_SHA_512-Random&quot;
            }
          }
        }
      }
    };
    
    const client = new MongoClient(this.uri, {
      autoEncryption: {
        keyVaultNamespace: this.keyVaultNamespace,
        kmsProviders: this.kmsProviders,
        schemaMap
      }
    });
    
    await client.connect();
    return client;
  }
}


Comprehensive Audit Logging
// Advanced audit logging configuration
const auditConfiguration = {
  // Enable audit logging
  auditLog: {
    destination: &quot;file&quot;,
    path: &quot;/var/log/mongodb/audit.json&quot;,
    format: &quot;JSON&quot;,
    filter: {
      // Audit all authentication events
      $or: [
        { &quot;atype&quot;: &quot;authenticate&quot; },
        { &quot;atype&quot;: &quot;authCheck&quot; },
        { &quot;atype&quot;: &quot;logout&quot; },
        
        // Audit administrative operations
        { &quot;atype&quot;: &quot;createCollection&quot; },
        { &quot;atype&quot;: &quot;dropCollection&quot; },
        { &quot;atype&quot;: &quot;createIndex&quot; },
        { &quot;atype&quot;: &quot;dropIndex&quot; },
        
        // Audit data modification on sensitive collections
        {
          $and: [
            { &quot;atype&quot;: { $in: [&quot;insert&quot;, &quot;update&quot;, &quot;remove&quot;] } },
            { &quot;param.ns&quot;: { $regex: &quot;^(users|payments|medical)&quot; } }
          ]
        },
        
        // Audit role and user management
        { &quot;atype&quot;: &quot;createUser&quot; },
        { &quot;atype&quot;: &quot;dropUser&quot; },
        { &quot;atype&quot;: &quot;createRole&quot; },
        { &quot;atype&quot;: &quot;dropRole&quot; },
        { &quot;atype&quot;: &quot;grantRolesToUser&quot; },
        { &quot;atype&quot;: &quot;revokeRolesFromUser&quot; }
      ]
    }
  }
};

// Custom audit event handler
class AuditEventProcessor {
  constructor(db) {
    this.db = db;
    this.auditCollection = db.collection(&apos;security_audit_events&apos;);
  }
  
  async processAuditEvent(auditEvent) {
    const processedEvent = {
      ...auditEvent,
      processedAt: new Date(),
      riskScore: this.calculateRiskScore(auditEvent),
      category: this.categorizeEvent(auditEvent)
    };
    
    await this.auditCollection.insertOne(processedEvent);
    
    // Check for suspicious patterns
    if (processedEvent.riskScore &amp;gt; 7) {
      await this.triggerSecurityAlert(processedEvent);
    }
  }
  
  calculateRiskScore(event) {
    let score = 0;
    
    // Failed authentication attempts
    if (event.atype === &apos;authenticate&apos; &amp;amp;&amp;amp; event.result === 18) {
      score += 3;
    }
    
    // Administrative operations outside business hours
    const hour = new Date(event.ts).getHours();
    if ([&apos;createUser&apos;, &apos;dropUser&apos;, &apos;createRole&apos;, &apos;dropRole&apos;].includes(event.atype) &amp;amp;&amp;amp;
        (hour &amp;lt; 6 || hour &amp;gt; 22)) {
      score += 5;
    }
    
    // Bulk data access
    if (event.atype === &apos;find&apos; &amp;amp;&amp;amp; event.param?.filter === {}) {
      score += 4;
    }
    
    // Unusual source IP
    if (event.remote &amp;amp;&amp;amp; !this.isKnownIP(event.remote)) {
      score += 3;
    }
    
    return Math.min(score, 10);
  }
  
  categorizeEvent(event) {
    const categories = {
      &apos;authenticate&apos;: &apos;AUTHENTICATION&apos;,
      &apos;authCheck&apos;: &apos;AUTHORIZATION&apos;,
      &apos;insert&apos;: &apos;DATA_MODIFICATION&apos;,
      &apos;update&apos;: &apos;DATA_MODIFICATION&apos;,
      &apos;remove&apos;: &apos;DATA_MODIFICATION&apos;,
      &apos;find&apos;: &apos;DATA_ACCESS&apos;,
      &apos;createUser&apos;: &apos;USER_MANAGEMENT&apos;,
      &apos;dropUser&apos;: &apos;USER_MANAGEMENT&apos;,
      &apos;createRole&apos;: &apos;ROLE_MANAGEMENT&apos;,
      &apos;dropRole&apos;: &apos;ROLE_MANAGEMENT&apos;
    };
    
    return categories[event.atype] || &apos;OTHER&apos;;
  }
  
  async triggerSecurityAlert(event) {
    const alert = {
      alertId: new ObjectId(),
      type: &apos;HIGH_RISK_AUDIT_EVENT&apos;,
      severity: &apos;HIGH&apos;,
      event: event,
      triggeredAt: new Date(),
      status: &apos;OPEN&apos;,
      assignedTo: null
    };
    
    await this.db.collection(&apos;security_alerts&apos;).insertOne(alert);
    
    // Send notification to security team
    await this.notifySecurityTeam(alert);
  }
  
  async notifySecurityTeam(alert) {
    // Implementation for security team notification
    console.log(`🚨 Security Alert: ${alert.type} - Risk Score: ${alert.event.riskScore}`);
  }
  
  isKnownIP(ip) {
    const knownIPRanges = [
      &apos;10.0.0.0/8&apos;,
      &apos;172.16.0.0/12&apos;,
      &apos;192.168.0.0/16&apos;
    ];
    
    // Implementation for IP range checking
    return true; // Simplified for example
  }
}




Production Operations and Monitoring

Enterprise MongoDB deployments require comprehensive operational excellence covering monitoring, alerting, backup strategies, and performance optimization.



Performance Monitoring and Alerting
// Comprehensive performance monitoring system
class MongoDBPerformanceMonitor {
  constructor(db, alertManager) {
    this.db = db;
    this.alertManager = alertManager;
    this.metricsCollection = db.collection(&apos;performance_metrics&apos;);
    this.alertCollection = db.collection(&apos;performance_alerts&apos;);
  }
  
  async collectPerformanceMetrics() {
    const metrics = {
      timestamp: new Date(),
      server: await this.getServerStatus(),
      database: await this.getDatabaseMetrics(),
      queries: await this.getSlowQueryMetrics(),
      replication: await this.getReplicationMetrics(),
      sharding: await this.getShardingMetrics()
    };
    
    await this.metricsCollection.insertOne(metrics);
    await this.analyzeMetrics(metrics);
    
    return metrics;
  }
  
  async getServerStatus() {
    const serverStatus = await this.db.admin().serverStatus();
    
    return {
      uptime: serverStatus.uptime,
      memory: {
        resident: serverStatus.mem.resident,
        virtual: serverStatus.mem.virtual,
        mapped: serverStatus.mem.mapped
      },
      connections: {
        current: serverStatus.connections.current,
        available: serverStatus.connections.available,
        totalCreated: serverStatus.connections.totalCreated
      },
      network: {
        bytesIn: serverStatus.network.bytesIn,
        bytesOut: serverStatus.network.bytesOut,
        numRequests: serverStatus.network.numRequests
      },
      opcounters: serverStatus.opcounters,
      wiredTiger: serverStatus.wiredTiger ? {
        cacheSize: serverStatus.wiredTiger.cache[&apos;bytes currently in the cache&apos;],
        cacheDirtySize: serverStatus.wiredTiger.cache[&apos;tracked dirty bytes in the cache&apos;],
        cacheReadIntoSize: serverStatus.wiredTiger.cache[&apos;bytes read into cache&apos;],
        cacheWrittenFromSize: serverStatus.wiredTiger.cache[&apos;bytes written from cache&apos;]
      } : null
    };
  }
  
  async getDatabaseMetrics() {
    const dbStats = await this.db.stats();
    
    return {
      collections: dbStats.collections,
      objects: dbStats.objects,
      avgObjSize: dbStats.avgObjSize,
      dataSize: dbStats.dataSize,
      storageSize: dbStats.storageSize,
      indexSize: dbStats.indexSize,
      indexes: dbStats.indexes
    };
  }
  
  async getSlowQueryMetrics() {
    // Enable profiling for slow operations
    await this.db.runCommand({ profile: 2, slowms: 100 });
    
    const slowQueries = await this.db.collection(&apos;system.profile&apos;)
      .find({ ts: { $gte: new Date(Date.now() - 5 * 60 * 1000) } }) // Last 5 minutes
      .sort({ ts: -1 })
      .limit(100)
      .toArray();
    
    return {
      count: slowQueries.length,
      avgDuration: slowQueries.reduce((sum, q) =&amp;gt; sum + q.millis, 0) / slowQueries.length || 0,
      queries: slowQueries.slice(0, 10) // Top 10 slowest
    };
  }
  
  async getReplicationMetrics() {
    try {
      const replStatus = await this.db.admin().replSetGetStatus();
      
      return {
        state: replStatus.myState,
        members: replStatus.members.map(member =&amp;gt; ({
          name: member.name,
          state: member.state,
          health: member.health,
          uptime: member.uptime,
          optime: member.optime,
          syncSourceHost: member.syncSourceHost
        })),
        replicationLag: this.calculateReplicationLag(replStatus.members)
      };
    } catch (error) {
      return { error: &apos;Not in replica set or insufficient permissions&apos; };
    }
  }
  
  async getShardingMetrics() {
    try {
      const shardingStatus = await this.db.admin().runCommand({ listShards: 1 });
      const configDB = this.db.getSiblingDB(&apos;config&apos;);
      
      const chunks = await configDB.chunks.countDocuments();
      const balancerState = await configDB.settings.findOne({ _id: &apos;balancer&apos; });
      
      return {
        shards: shardingStatus.shards.length,
        chunks: chunks,
        balancerEnabled: balancerState ? balancerState.stopped !== true : true
      };
    } catch (error) {
      return { error: &apos;Not in sharded cluster or insufficient permissions&apos; };
    }
  }
  
  calculateReplicationLag(members) {
    const primary = members.find(m =&amp;gt; m.state === 1);
    if (!primary) return null;
    
    const secondaries = members.filter(m =&amp;gt; m.state === 2);
    const maxLag = Math.max(...secondaries.map(s =&amp;gt; 
      primary.optime.ts.getTime() - s.optime.ts.getTime()
    ));
    
    return maxLag / 1000; // Convert to seconds
  }
  
  async analyzeMetrics(metrics) {
    const alerts = [];
    
    // Connection alert
    if (metrics.server.connections.current / metrics.server.connections.available &amp;gt; 0.8) {
      alerts.push({
        type: &apos;HIGH_CONNECTION_USAGE&apos;,
        severity: &apos;WARNING&apos;,
        message: `Connection usage at ${Math.round(metrics.server.connections.current / metrics.server.connections.available * 100)}%`,
        metrics: {
          current: metrics.server.connections.current,
          available: metrics.server.connections.available
        }
      });
    }
    
    // Memory alert
    if (metrics.server.memory.resident &amp;gt; 8000) { // 8GB threshold
      alerts.push({
        type: &apos;HIGH_MEMORY_USAGE&apos;,
        severity: &apos;WARNING&apos;,
        message: `Resident memory usage: ${metrics.server.memory.resident}MB`,
        metrics: { resident: metrics.server.memory.resident }
      });
    }
    
    // Slow query alert
    if (metrics.queries.count &amp;gt; 50) {
      alerts.push({
        type: &apos;HIGH_SLOW_QUERY_RATE&apos;,
        severity: &apos;CRITICAL&apos;,
        message: `${metrics.queries.count} slow queries in last 5 minutes`,
        metrics: {
          count: metrics.queries.count,
          avgDuration: metrics.queries.avgDuration
        }
      });
    }
    
    // Replication lag alert
    if (metrics.replication.replicationLag &amp;gt; 10) {
      alerts.push({
        type: &apos;HIGH_REPLICATION_LAG&apos;,
        severity: &apos;CRITICAL&apos;,
        message: `Replication lag: ${metrics.replication.replicationLag} seconds`,
        metrics: { lag: metrics.replication.replicationLag }
      });
    }
    
    // Process and store alerts
    for (const alert of alerts) {
      await this.processAlert(alert, metrics.timestamp);
    }
  }
  
  async processAlert(alert, timestamp) {
    const alertDocument = {
      ...alert,
      timestamp,
      status: &apos;ACTIVE&apos;,
      acknowledged: false,
      resolvedAt: null
    };
    
    await this.alertCollection.insertOne(alertDocument);
    await this.alertManager.sendAlert(alertDocument);
  }
}

// Automated backup and disaster recovery
class BackupManager {
  constructor(mongoUri, s3Config) {
    this.mongoUri = mongoUri;
    this.s3Config = s3Config;
  }
  
  async createBackup(databases = []) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, &apos;-&apos;);
    const backupId = `backup-${timestamp}`;
    
    try {
      for (const dbName of databases) {
        await this.backupDatabase(dbName, backupId);
      }
      
      await this.uploadToS3(backupId);
      await this.recordBackup(backupId, databases);
      
      return backupId;
    } catch (error) {
      console.error(`Backup failed for ${backupId}:`, error);
      throw error;
    }
  }
  
  async backupDatabase(dbName, backupId) {
    const backupPath = `/tmp/backups/${backupId}/${dbName}`;
    
    // Use mongodump for consistent backup
    const { execSync } = require(&apos;child_process&apos;);
    const command = `mongodump --uri=&quot;${this.mongoUri}&quot; --db=${dbName} --out=${backupPath}`;
    
    execSync(command, { stdio: &apos;inherit&apos; });
  }
  
  async uploadToS3(backupId) {
    // Implementation for S3 upload
    console.log(`Uploading backup ${backupId} to S3...`);
  }
  
  async recordBackup(backupId, databases) {
    const client = new MongoClient(this.mongoUri);
    await client.connect();
    
    const adminDb = client.db(&apos;admin&apos;);
    await adminDb.collection(&apos;backups&apos;).insertOne({
      backupId,
      databases,
      createdAt: new Date(),
      status: &apos;COMPLETED&apos;,
      location: `s3://${this.s3Config.bucket}/backups/${backupId}`
    });
    
    await client.close();
  }
}




Conclusion

MongoDB has evolved from a simple document database into a comprehensive data platform capable of supporting the most demanding enterprise applications. This comprehensive exploration demonstrates that successful MongoDB implementations require deep understanding of architectural patterns, performance optimization strategies, and operational excellence practices.



Key Success Factors for Production MongoDB:

Architecture Excellence: Implementing appropriate replica set configurations, sharding strategies, and distributed system patterns ensures scalability and reliability at enterprise scale.

Data Modeling Mastery: Leveraging MongoDB’s flexible document model while applying proper normalization strategies, indexing patterns, and schema evolution techniques optimizes performance and maintainability.

Security Implementation: Comprehensive security measures including RBAC, field-level encryption, audit logging, and compliance frameworks protect sensitive data and meet regulatory requirements.

Operational Excellence: Proactive monitoring, automated alerting, robust backup strategies, and performance optimization enable reliable production operations.

Modern Integration Patterns: Event sourcing, CQRS, saga patterns, and microservices architectures leverage MongoDB’s strengths in distributed, cloud-native environments.



Future Considerations:

As MongoDB continues evolving with features like vector search for AI workloads, enhanced time series capabilities, and improved multi-cloud operations, the fundamental principles explored in this guide provide a solid foundation for embracing new capabilities while maintaining operational excellence.

The investment in understanding MongoDB’s advanced capabilities and implementation patterns enables organizations to build scalable, secure, and maintainable data architectures that can adapt to changing business requirements and technological landscapes.

Whether implementing greenfield applications or optimizing existing MongoDB deployments, these patterns and practices provide the depth needed for production success at any scale.





References and Further Reading


  MongoDB Official Documentation
  MongoDB Production Best Practices
  MongoDB Performance Best Practices
  MongoDB Security Checklist
  Building with Patterns: MongoDB Data Modeling
  MongoDB Architecture Guide
  Designing Data-Intensive Applications - Martin Kleppmann
  MongoDB: The Definitive Guide - Shannon Bradshaw
  Event Sourcing with MongoDB
  MongoDB University
  MongoDB Community Forums
  MongoDB GitHub Repository

",
            "wordcount": "13650",
            "inLanguage": "en",
            "dateCreated": "2025-01-27/",
            "datePublished": "2025-01-27/",
            "dateModified": "2025-01-27/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "DATABASE",
            "articleSection": "DATABASE",
            "keywords": ["mongodb","nosql","database","distributed-systems","performance","microservices","data-modeling"]
        }
        </script>
    </body>
</html>
