<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>Advanced Terraform Functions and Expressions: Dynamic Infrastructure Patterns | somaz</title>
    <meta name="description" content="Comprehensive guide to advanced Terraform functions, conditional expressions, for loops, dynamic blocks, and complex data transformations for enterprise-grad...">
    
        <meta name="keywords" content="terraform, hashicorp, functions, expressions, dynamic-blocks, hcl, infrastructure-as-code, automation, advanced-terraform, data-transformation">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Advanced Terraform Functions and Expressions: Dynamic Infrastructure Patterns | somaz">
    <meta name="twitter:description" content="Comprehensive guide to advanced Terraform functions, conditional expressions, for loops, dynamic blocks, and complex data transformations for enterprise-grad...">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755142723/terraform-advance_rau5cf.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/iac/terraform-advance/">
    <meta property="og:title" content="Advanced Terraform Functions and Expressions: Dynamic Infrastructure Patterns | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755142723/terraform-advance_rau5cf.png">
    <meta property="og:description" content="Comprehensive guide to advanced Terraform functions, conditional expressions, for loops, dynamic blocks, and complex data transformations for enterprise-grad...">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/iac/terraform-advance/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-11-15T00:00:00+00:00">
                            


November 15, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>74 min to read</span>
                </p>
                <h1 class="post-title">Advanced Terraform Functions and Expressions: Dynamic Infrastructure Patterns</h1>
                <p class="post-subtitle">Master complex Terraform functions, expressions, and dynamic blocks for sophisticated infrastructure automation</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1755142723/terraform-advance_rau5cf.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><br /></p>

<hr />

<h2 id="overview">Overview</h2>

<p>As infrastructure complexity grows, <strong>Terraform’s advanced functions and expressions</strong> become essential for creating sophisticated, maintainable, and scalable Infrastructure as Code solutions.</p>

<p>This comprehensive guide explores the powerful capabilities that distinguish basic Terraform usage from enterprise-grade implementations.</p>

<p><strong>Advanced Terraform programming</strong> involves mastering built-in functions, conditional logic, iterative constructs, and dynamic resource generation.</p>

<p>These features enable <strong>data transformation, conditional resource creation, and complex infrastructure patterns</strong> that adapt to varying requirements and environments.</p>

<p>This guide covers <strong>nine categories of Terraform functions</strong>, <strong>advanced expression patterns</strong>, <strong>dynamic block construction</strong>, and <strong>real-world implementation strategies</strong>.</p>

<p>We’ll explore how to leverage <strong>conditional expressions, for loops, type conversions, and collection manipulations</strong> to build flexible, reusable infrastructure modules.</p>

<p>Understanding these advanced concepts enables <strong>infrastructure engineers</strong> to create <strong>self-adapting configurations</strong>, <strong>reduce code duplication</strong>, and <strong>implement sophisticated deployment patterns</strong> that scale across multiple environments and use cases.</p>

<p><br /></p>

<hr />

<h2 id="terraform-functions-overview">Terraform Functions Overview</h2>

<p>Terraform provides over <strong>100 built-in functions</strong> organized into nine categories, each serving specific data manipulation and transformation needs in infrastructure configurations.</p>

<p><br /></p>

<h3 id="function-categories">Function Categories:</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Numeric Functions</span>
<span class="nx">abs</span><span class="err">(-</span><span class="mi">5</span><span class="err">)</span>                    <span class="c1"># Returns: 5</span>
<span class="nx">ceil</span><span class="err">(</span><span class="mf">4.3</span><span class="err">)</span>                  <span class="c1"># Returns: 5</span>
<span class="nx">floor</span><span class="err">(</span><span class="mf">4.7</span><span class="err">)</span>                 <span class="c1"># Returns: 4</span>
<span class="nx">max</span><span class="err">(</span><span class="mi">5</span><span class="err">,</span> <span class="mi">12</span><span class="err">,</span> <span class="mi">9</span><span class="err">)</span>             <span class="c1"># Returns: 12</span>
<span class="nx">min</span><span class="err">(</span><span class="mi">5</span><span class="err">,</span> <span class="mi">12</span><span class="err">,</span> <span class="mi">9</span><span class="err">)</span>             <span class="c1"># Returns: 5</span>

<span class="c1"># 2. String Functions</span>
<span class="nx">upper</span><span class="err">(</span><span class="s2">"hello"</span><span class="err">)</span>             <span class="c1"># Returns: "HELLO"</span>
<span class="nx">lower</span><span class="err">(</span><span class="s2">"WORLD"</span><span class="err">)</span>             <span class="c1"># Returns: "world"</span>
<span class="nx">title</span><span class="err">(</span><span class="s2">"hello world"</span><span class="err">)</span>       <span class="c1"># Returns: "Hello World"</span>
<span class="nx">trim</span><span class="err">(</span><span class="s2">"  hello  "</span><span class="err">,</span> <span class="s2">" "</span><span class="err">)</span>     <span class="c1"># Returns: "hello"</span>
<span class="nx">replace</span><span class="err">(</span><span class="s2">"hello"</span><span class="err">,</span> <span class="s2">"l"</span><span class="err">,</span> <span class="s2">"x"</span><span class="err">)</span> <span class="c1"># Returns: "hexxo"</span>

<span class="c1"># 3. Collection Functions</span>
<span class="nx">length</span><span class="err">(</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="err">)</span>          <span class="c1"># Returns: 3</span>
<span class="nx">concat</span><span class="err">(</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="err">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="err">)</span>     <span class="c1"># Returns: [1, 2, 3, 4]</span>
<span class="nx">distinct</span><span class="err">(</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="err">)</span>     <span class="c1"># Returns: [1, 2, 3]</span>
<span class="nx">sort</span><span class="err">(</span><span class="p">[</span><span class="s2">"c"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span><span class="err">)</span>      <span class="c1"># Returns: ["a", "b", "c"]</span>

<span class="c1"># 4. Encoding Functions</span>
<span class="nx">base64encode</span><span class="err">(</span><span class="s2">"hello"</span><span class="err">)</span>      <span class="c1"># Returns: "aGVsbG8="</span>
<span class="nx">base64decode</span><span class="err">(</span><span class="s2">"aGVsbG8="</span><span class="err">)</span>   <span class="c1"># Returns: "hello"</span>
<span class="nx">jsonencode</span><span class="err">(</span><span class="p">{</span><span class="nx">a</span> <span class="p">=</span> <span class="s2">"b"</span><span class="p">}</span><span class="err">)</span>      <span class="c1"># Returns: "{\"a\":\"b\"}"</span>

<span class="c1"># 5. Filesystem Functions</span>
<span class="nx">file</span><span class="err">(</span><span class="s2">"path/to/file.txt"</span><span class="err">)</span>   <span class="c1"># Returns: file contents</span>
<span class="nx">filebase64</span><span class="err">(</span><span class="s2">"image.png"</span><span class="err">)</span>    <span class="c1"># Returns: base64 encoded file</span>
<span class="nx">dirname</span><span class="err">(</span><span class="s2">"/path/to/file"</span><span class="err">)</span>   <span class="c1"># Returns: "/path/to"</span>
<span class="nx">basename</span><span class="err">(</span><span class="s2">"/path/to/file"</span><span class="err">)</span>  <span class="c1"># Returns: "file"</span>

<span class="c1"># 6. Date and Time Functions</span>
<span class="nx">timestamp</span><span class="err">()</span>                <span class="c1"># Returns: current timestamp</span>
<span class="nx">formatdate</span><span class="err">(</span><span class="s2">"YYYY-MM-DD"</span><span class="err">,</span> <span class="nx">timestamp</span><span class="err">())</span>
<span class="nx">timeadd</span><span class="err">(</span><span class="nx">timestamp</span><span class="err">(),</span> <span class="s2">"24h"</span><span class="err">)</span>

<span class="c1"># 7. Hash and Crypto Functions</span>
<span class="nx">md5</span><span class="err">(</span><span class="s2">"hello"</span><span class="err">)</span>              <span class="c1"># Returns: MD5 hash</span>
<span class="nx">sha256</span><span class="err">(</span><span class="s2">"hello"</span><span class="err">)</span>           <span class="c1"># Returns: SHA256 hash</span>
<span class="nx">uuid</span><span class="err">()</span>                    <span class="c1"># Returns: random UUID</span>

<span class="c1"># 8. IP Network Functions</span>
<span class="nx">cidrhost</span><span class="err">(</span><span class="s2">"10.0.0.0/8"</span><span class="err">,</span> <span class="mi">2</span><span class="err">)</span> <span class="c1"># Returns: "10.0.0.2"</span>
<span class="nx">cidrnetmask</span><span class="err">(</span><span class="s2">"10.0.0.0/8"</span><span class="err">)</span> <span class="c1"># Returns: "255.0.0.0"</span>
<span class="nx">cidrsubnet</span><span class="err">(</span><span class="s2">"10.0.0.0/8"</span><span class="err">,</span> <span class="mi">8</span><span class="err">,</span> <span class="mi">2</span><span class="err">)</span> <span class="c1"># Returns: "10.2.0.0/16"</span>

<span class="c1"># 9. Type Conversion Functions</span>
<span class="nx">tostring</span><span class="err">(</span><span class="mi">42</span><span class="err">)</span>              <span class="c1"># Returns: "42"</span>
<span class="nx">tonumber</span><span class="err">(</span><span class="s2">"42"</span><span class="err">)</span>            <span class="c1"># Returns: 42</span>
<span class="nx">tolist</span><span class="err">(</span><span class="nx">toset</span><span class="err">(</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="err">))</span>  <span class="c1"># Returns: [1, 2]</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="advanced-collection-functions">Advanced Collection Functions</h2>

<p><br /></p>

<h3 id="1-coalesce---null-value-handling">1. coalesce - Null Value Handling</h3>

<p>The <code class="language-plaintext highlighter-rouge">coalesce</code> function returns the first non-null, non-empty value from a sequence of arguments, making it essential for providing fallback values and handling optional configurations.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced coalesce patterns</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Environment-based resource naming with fallbacks</span>
  <span class="nx">environment</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> <span class="s2">"development"</span><span class="err">)</span>
  
  <span class="c1"># Multi-level fallback for database configuration</span>
  <span class="nx">db_instance_class</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">db_instance_class</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">environment_defaults</span><span class="p">[</span><span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="p">]</span><span class="err">,</span>
    <span class="s2">"db.t3.micro"</span>
  <span class="err">)</span>
  
  <span class="c1"># Complex subnet group naming with multiple fallbacks</span>
  <span class="nx">db_subnet_group_name</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">db_subnet_group_name</span><span class="err">,</span>
    <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-db-subnet-group"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment</span><span class="err">),</span>
    <span class="s2">"default-db-subnet-group"</span>
  <span class="err">)</span>
  
  <span class="c1"># API endpoint configuration with environment-specific defaults</span>
  <span class="nx">api_endpoint</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">custom_api_endpoint</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span><span class="p">[</span><span class="nx">local</span><span class="err">.</span><span class="nx">environment</span><span class="p">]</span><span class="err">.</span><span class="nx">api_endpoint</span><span class="err">,</span>
    <span class="s2">"https://api.${var.domain_name}"</span>
  <span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Usage in resource configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_db_subnet_group"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>       <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">db_subnet_group_name</span>
  <span class="nx">subnet_ids</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">subnet_ids</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span>        <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">db_subnet_group_name</span>
    <span class="nx">Environment</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment</span>
    <span class="nx">ManagedBy</span>   <span class="p">=</span> <span class="s2">"terraform"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-merge---complex-object-composition">2. merge - Complex Object Composition</h3>

<p>The <code class="language-plaintext highlighter-rouge">merge</code> function combines multiple maps or objects, with later arguments taking precedence over earlier ones for duplicate keys.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced merge patterns for tag management</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Base tags applied to all resources</span>
  <span class="nx">base_tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Project</span>     <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span>
    <span class="nx">Environment</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span>
    <span class="nx">ManagedBy</span>   <span class="p">=</span> <span class="s2">"terraform"</span>
    <span class="nx">CreatedAt</span>   <span class="p">=</span> <span class="nx">formatdate</span><span class="err">(</span><span class="s2">"YYYY-MM-DD"</span><span class="err">,</span> <span class="nx">timestamp</span><span class="err">())</span>
  <span class="p">}</span>
  
  <span class="c1"># Environment-specific tags</span>
  <span class="nx">environment_tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">development</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">AutoShutdown</span> <span class="p">=</span> <span class="s2">"true"</span>
      <span class="nx">CostCenter</span>   <span class="p">=</span> <span class="s2">"development"</span>
      <span class="nx">Backup</span>       <span class="p">=</span> <span class="s2">"weekly"</span>
    <span class="p">}</span>
    <span class="nx">staging</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">AutoShutdown</span> <span class="p">=</span> <span class="s2">"false"</span>
      <span class="nx">CostCenter</span>   <span class="p">=</span> <span class="s2">"qa"</span>
      <span class="nx">Backup</span>       <span class="p">=</span> <span class="s2">"daily"</span>
    <span class="p">}</span>
    <span class="nx">production</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">AutoShutdown</span> <span class="p">=</span> <span class="s2">"false"</span>
      <span class="nx">CostCenter</span>   <span class="p">=</span> <span class="s2">"operations"</span>
      <span class="nx">Backup</span>       <span class="p">=</span> <span class="s2">"hourly"</span>
      <span class="nx">Compliance</span>   <span class="p">=</span> <span class="s2">"required"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Compliance tags for sensitive resources</span>
  <span class="nx">compliance_tags</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_compliance</span> <span class="err">?</span> <span class="p">{</span>
    <span class="nx">DataClassification</span> <span class="p">=</span> <span class="s2">"sensitive"</span>
    <span class="nx">ComplianceScope</span>    <span class="p">=</span> <span class="s2">"SOC2"</span>
    <span class="nx">BackupRequired</span>     <span class="p">=</span> <span class="s2">"true"</span>
    <span class="nx">EncryptionRequired</span> <span class="p">=</span> <span class="s2">"true"</span>
  <span class="p">}</span> <span class="err">:</span> <span class="p">{}</span>
  
  <span class="c1"># Final tag composition with precedence</span>
  <span class="nx">resource_tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">base_tags</span><span class="err">,</span>
    <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">environment_tags</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> <span class="p">{}</span><span class="err">),</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">compliance_tags</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">additional_tags</span>
  <span class="err">)</span>
  
  <span class="c1"># Database-specific tag merging</span>
  <span class="nx">database_tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">resource_tags</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">ResourceType</span> <span class="p">=</span> <span class="s2">"database"</span>
      <span class="nx">BackupWindow</span> <span class="p">=</span> <span class="s2">"03:00-04:00"</span>
      <span class="nx">MaintenanceWindow</span> <span class="p">=</span> <span class="s2">"Mon:04:00-Mon:05:00"</span>
    <span class="p">}</span>
  <span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Advanced configuration merging</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Default monitoring configuration</span>
  <span class="nx">default_monitoring</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">enabled</span>                <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">detailed_monitoring</span>    <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">cpu_alarm_threshold</span>    <span class="p">=</span> <span class="mi">80</span>
    <span class="nx">memory_alarm_threshold</span> <span class="p">=</span> <span class="mi">85</span>
    <span class="nx">disk_alarm_threshold</span>   <span class="p">=</span> <span class="mi">90</span>
  <span class="p">}</span>
  
  <span class="c1"># Environment-specific monitoring overrides</span>
  <span class="nx">environment_monitoring</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">production</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">detailed_monitoring</span>    <span class="p">=</span> <span class="kc">true</span>
      <span class="nx">cpu_alarm_threshold</span>    <span class="p">=</span> <span class="mi">70</span>
      <span class="nx">memory_alarm_threshold</span> <span class="p">=</span> <span class="mi">75</span>
      <span class="nx">enable_custom_metrics</span>  <span class="p">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="nx">staging</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">cpu_alarm_threshold</span> <span class="p">=</span> <span class="mi">85</span>
      <span class="nx">enable_testing_metrics</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Final monitoring configuration</span>
  <span class="nx">monitoring_config</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">default_monitoring</span><span class="err">,</span>
    <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">environment_monitoring</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> <span class="p">{}</span><span class="err">),</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">custom_monitoring_config</span>
  <span class="err">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-lookup-and-element---advanced-data-access">3. lookup and element - Advanced Data Access</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced lookup patterns with complex defaults</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Instance type mapping with environment-based defaults</span>
  <span class="nx">instance_types</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">development</span> <span class="p">=</span> <span class="s2">"t3.micro"</span>
    <span class="nx">staging</span>     <span class="p">=</span> <span class="s2">"t3.small"</span>
    <span class="nx">production</span>  <span class="p">=</span> <span class="s2">"c5.large"</span>
  <span class="p">}</span>
  
  <span class="c1"># Complex lookup with computed defaults</span>
  <span class="nx">instance_type</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">instance_types</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">high_performance</span> <span class="err">?</span> <span class="s2">"c5.xlarge"</span> <span class="err">:</span> <span class="s2">"t3.medium"</span>
  <span class="err">)</span>
  
  <span class="c1"># Multi-level configuration lookup</span>
  <span class="nx">availability_zones</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">region_config</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">aws_region</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">azs</span> <span class="p">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span>
      <span class="nx">preferred_azs</span> <span class="p">=</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span><span class="err">,</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">2</span><span class="err">)</span>
    <span class="p">}</span>
  <span class="err">).</span><span class="nx">preferred_azs</span>
  
  <span class="c1"># Advanced element usage with modulo for round-robin distribution</span>
  <span class="nx">subnet_distribution</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">instance</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="p">{</span>
      <span class="nx">instance_id</span> <span class="p">=</span> <span class="nx">instance</span><span class="err">.</span><span class="nx">id</span>
      <span class="nx">subnet_id</span>   <span class="p">=</span> <span class="nx">element</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">subnet_ids</span><span class="err">,</span> <span class="nx">i</span> <span class="err">%</span> <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">subnet_ids</span><span class="err">))</span>
      <span class="nx">az</span>         <span class="p">=</span> <span class="nx">element</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">availability_zones</span><span class="err">,</span> <span class="nx">i</span> <span class="err">%</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">availability_zones</span><span class="err">))</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Complex lookup for security group rules</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Security group rule templates</span>
  <span class="nx">security_rules</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">web</span> <span class="p">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"ingress"</span>
        <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">80</span>
        <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">80</span>
        <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
        <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"ingress"</span>
        <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">443</span>
        <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">443</span>
        <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
        <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
    <span class="nx">api</span> <span class="p">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"ingress"</span>
        <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">8080</span>
        <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">8080</span>
        <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
        <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">api_allowed_cidrs</span>
      <span class="p">}</span>
    <span class="p">]</span>
    <span class="nx">database</span> <span class="p">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span>                     <span class="p">=</span> <span class="s2">"ingress"</span>
        <span class="nx">from_port</span>               <span class="p">=</span> <span class="mi">5432</span>
        <span class="nx">to_port</span>                 <span class="p">=</span> <span class="mi">5432</span>
        <span class="nx">protocol</span>                <span class="p">=</span> <span class="s2">"tcp"</span>
        <span class="nx">source_security_group_id</span> <span class="p">=</span> <span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">app</span><span class="err">.</span><span class="nx">id</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
  
  <span class="c1"># Dynamic rule selection based on service type</span>
  <span class="nx">selected_rules</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">security_rules</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">service_type</span><span class="err">,</span> <span class="p">[]</span><span class="err">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="advanced-string-functions">Advanced String Functions</h2>

<p><br /></p>

<h3 id="1-format---dynamic-string-construction">1. format - Dynamic String Construction</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced format patterns for resource naming</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Hierarchical naming convention</span>
  <span class="nx">resource_name_template</span> <span class="p">=</span> <span class="s2">"%s-%s-%s-%s"</span>
  
  <span class="c1"># Generate consistent resource names</span>
  <span class="nx">vpc_name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">resource_name_template</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">organization</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span>
    <span class="s2">"vpc"</span>
  <span class="err">)</span>
  
  <span class="nx">subnet_names</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">az</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">availability_zones</span> <span class="err">:</span> <span class="nx">format</span><span class="err">(</span>
      <span class="s2">"%s-%s-%s-subnet-%s"</span><span class="p">,</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">organization</span><span class="p">,</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="p">,</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="p">,</span>
      <span class="nx">substr</span><span class="err">(</span><span class="nx">az</span><span class="p">,</span> <span class="err">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="err">)</span>  <span class="c1"># Use last character of AZ</span>
    <span class="err">)</span>
  <span class="p">]</span>
  
  <span class="c1"># Complex formatting with conditional elements</span>
  <span class="nx">instance_name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
    <span class="s2">"%s-%s%s"</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">base_name</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">instance_role</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_high_availability</span> <span class="err">?</span> <span class="s2">"-ha"</span> <span class="err">:</span> <span class="s2">""</span>
  <span class="err">)</span>
  
  <span class="c1"># URL construction with multiple variables</span>
  <span class="nx">database_connection_string</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
    <span class="s2">"postgresql://%s:%s@%s:%d/%s?sslmode=%s"</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">db_username</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">db_password</span><span class="err">,</span>
    <span class="nx">aws_db_instance</span><span class="err">.</span><span class="nx">main</span><span class="err">.</span><span class="nx">endpoint</span><span class="err">,</span>
    <span class="nx">aws_db_instance</span><span class="err">.</span><span class="nx">main</span><span class="err">.</span><span class="nx">port</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">db_name</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_ssl</span> <span class="err">?</span> <span class="s2">"require"</span> <span class="err">:</span> <span class="s2">"disable"</span>
  <span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Advanced format usage in outputs</span>
<span class="nx">output</span> <span class="s2">"service_endpoints"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">service</span><span class="err">,</span> <span class="nx">config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">services</span> <span class="err">:</span> <span class="nx">service</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">internal_url</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
        <span class="s2">"https://%s.%s.local:%d"</span><span class="err">,</span>
        <span class="nx">service</span><span class="err">,</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
        <span class="nx">config</span><span class="err">.</span><span class="nx">port</span>
      <span class="err">)</span>
      <span class="nx">external_url</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
        <span class="s2">"https://%s.%s.%s"</span><span class="err">,</span>
        <span class="nx">service</span><span class="err">,</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">domain_name</span>
      <span class="err">)</span>
      <span class="nx">health_check</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
        <span class="s2">"%s/health"</span><span class="err">,</span>
        <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"https://%s.%s.%s"</span><span class="err">,</span>
          <span class="nx">service</span><span class="err">,</span>
          <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
          <span class="nx">var</span><span class="err">.</span><span class="nx">domain_name</span>
        <span class="err">)</span>
      <span class="err">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-substr-and-string-manipulation">2. substr and String Manipulation</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced string manipulation patterns</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Extract components from complex identifiers</span>
  <span class="nx">account_id</span> <span class="p">=</span> <span class="nx">substr</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_caller_identity</span><span class="err">.</span><span class="nx">current</span><span class="err">.</span><span class="nx">arn</span><span class="err">,</span> <span class="mi">13</span><span class="err">,</span> <span class="mi">12</span><span class="err">)</span>
  
  <span class="c1"># Create short identifiers for resource naming</span>
  <span class="nx">short_project</span> <span class="p">=</span> <span class="nx">substr</span><span class="err">(</span><span class="nx">replace</span><span class="err">(</span><span class="nx">lower</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">),</span> <span class="s2">"-"</span><span class="err">,</span> <span class="s2">""</span><span class="err">),</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">8</span><span class="err">)</span>
  <span class="nx">short_env</span>     <span class="p">=</span> <span class="nx">substr</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">3</span><span class="err">)</span>
  
  <span class="c1"># Generate unique identifiers with length constraints</span>
  <span class="nx">unique_suffix</span> <span class="p">=</span> <span class="nx">substr</span><span class="err">(</span><span class="nx">uuid</span><span class="err">(),</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">8</span><span class="err">)</span>
  <span class="nx">bucket_name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
    <span class="s2">"%s-%s-%s"</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">short_project</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">short_env</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">unique_suffix</span>
  <span class="err">)</span>
  
  <span class="c1"># Extract and validate AMI ID format</span>
  <span class="nx">is_valid_ami</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span><span class="err">)</span> <span class="err">&gt;</span> <span class="mi">4</span> <span class="err">&amp;&amp;</span> <span class="nx">substr</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span><span class="err">,</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">4</span><span class="err">)</span> <span class="p">==</span> <span class="s2">"ami-"</span>
  
  <span class="c1"># Process and clean input strings</span>
  <span class="nx">sanitized_name</span> <span class="p">=</span> <span class="nx">replace</span><span class="err">(</span>
    <span class="nx">replace</span><span class="err">(</span>
      <span class="nx">lower</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">user_input</span><span class="err">),</span>
      <span class="s2">"/[^a-z0-9-]/"</span><span class="err">,</span> 
      <span class="s2">"-"</span>
    <span class="err">),</span>
    <span class="s2">"/--+/"</span><span class="err">,</span>
    <span class="s2">"-"</span>
  <span class="err">)</span>
  
  <span class="c1"># Extract domain components</span>
  <span class="nx">domain_parts</span> <span class="p">=</span> <span class="nx">split</span><span class="err">(</span><span class="s2">"."</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">domain_name</span><span class="err">)</span>
  <span class="nx">subdomain</span>    <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">domain_parts</span><span class="err">)</span> <span class="err">&gt;</span> <span class="mi">2</span> <span class="err">?</span> <span class="nx">local</span><span class="err">.</span><span class="nx">domain_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">:</span> <span class="s2">""</span>
  <span class="nx">root_domain</span>  <span class="p">=</span> <span class="nx">join</span><span class="err">(</span><span class="s2">"."</span><span class="err">,</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">domain_parts</span><span class="err">,</span> <span class="err">-</span><span class="mi">2</span><span class="err">,</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">domain_parts</span><span class="err">)))</span>
<span class="p">}</span>

<span class="c1"># Advanced validation using string functions</span>
<span class="nx">variable</span> <span class="s2">"ami_id"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"The AMI ID to use for instances"</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span><span class="err">)</span> <span class="err">&gt;</span> <span class="mi">4</span> <span class="err">&amp;&amp;</span> 
      <span class="nx">substr</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span><span class="err">,</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">4</span><span class="err">)</span> <span class="p">==</span> <span class="s2">"ami-"</span> <span class="err">&amp;&amp;</span>
      <span class="nx">can</span><span class="err">(</span><span class="nx">regex</span><span class="err">(</span><span class="s2">"^ami-[0-9a-f]{8}([0-9a-f]{9})?$"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span><span class="err">))</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"AMI ID must be a valid format (ami-xxxxxxxx or ami-xxxxxxxxxxxxxxxxx)."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"instance_name"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Name for the instance"</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">instance_name</span><span class="err">)</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">3</span> <span class="err">&amp;&amp;</span>
      <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">instance_name</span><span class="err">)</span> <span class="err">&lt;</span><span class="p">=</span> <span class="mi">63</span> <span class="err">&amp;&amp;</span>
      <span class="nx">can</span><span class="err">(</span><span class="nx">regex</span><span class="err">(</span><span class="s2">"^[a-z][a-z0-9-]*[a-z0-9]$"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instance_name</span><span class="err">))</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Instance name must be 3-63 characters, start with a letter, and contain only lowercase letters, numbers, and hyphens."</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="types-and-values---advanced-patterns">Types and Values - Advanced Patterns</h2>

<p><br /></p>

<h3 id="1-complex-type-definitions">1. Complex Type Definitions</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced type constraints and validations</span>
<span class="nx">variable</span> <span class="s2">"application_config"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
    <span class="nx">name</span>         <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">version</span>      <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">port</span>         <span class="p">=</span> <span class="nx">number</span>
    <span class="nx">health_check</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
      <span class="nx">enabled</span>  <span class="p">=</span> <span class="nx">bool</span>
      <span class="nx">path</span>     <span class="p">=</span> <span class="nx">string</span>
      <span class="nx">interval</span> <span class="p">=</span> <span class="nx">number</span>
      <span class="nx">timeout</span>  <span class="p">=</span> <span class="nx">number</span>
    <span class="p">}</span><span class="err">)</span>
    <span class="nx">scaling</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
      <span class="nx">min_instances</span> <span class="p">=</span> <span class="nx">number</span>
      <span class="nx">max_instances</span> <span class="p">=</span> <span class="nx">number</span>
      <span class="nx">target_cpu</span>    <span class="p">=</span> <span class="nx">number</span>
    <span class="p">}</span><span class="err">)</span>
    <span class="nx">environment_variables</span> <span class="p">=</span> <span class="nx">map</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
    <span class="nx">secrets</span>              <span class="p">=</span> <span class="nx">map</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
    <span class="nx">dependencies</span>         <span class="p">=</span> <span class="nx">list</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
    <span class="nx">feature_flags</span>        <span class="p">=</span> <span class="nx">map</span><span class="err">(</span><span class="nx">bool</span><span class="err">)</span>
  <span class="p">}</span><span class="err">)</span>
  
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Complete application configuration"</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">application_config</span><span class="err">.</span><span class="nx">port</span> <span class="err">&gt;</span> <span class="mi">1024</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">application_config</span><span class="err">.</span><span class="nx">port</span> <span class="err">&lt;</span> <span class="mi">65536</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Application port must be between 1024 and 65535."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">application_config</span><span class="err">.</span><span class="nx">scaling</span><span class="err">.</span><span class="nx">min_instances</span> <span class="err">&lt;</span><span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">application_config</span><span class="err">.</span><span class="nx">scaling</span><span class="err">.</span><span class="nx">max_instances</span> <span class="err">&amp;&amp;</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">application_config</span><span class="err">.</span><span class="nx">scaling</span><span class="err">.</span><span class="nx">min_instances</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">1</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Min instances must be at least 1 and not exceed max instances."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Complex tuple definitions for multi-environment configurations</span>
<span class="nx">variable</span> <span class="s2">"environments"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="err">(</span><span class="nx">object</span><span class="err">(</span><span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">config</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
      <span class="nx">instance_type</span>    <span class="p">=</span> <span class="nx">string</span>
      <span class="nx">instance_count</span>   <span class="p">=</span> <span class="nx">number</span>
      <span class="nx">auto_scaling</span>     <span class="p">=</span> <span class="nx">bool</span>
      <span class="nx">backup_retention</span> <span class="p">=</span> <span class="nx">number</span>
    <span class="p">}</span><span class="err">)</span>
    <span class="nx">networking</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
      <span class="nx">vpc_cidr</span>           <span class="p">=</span> <span class="nx">string</span>
      <span class="nx">availability_zones</span> <span class="p">=</span> <span class="nx">list</span><span class="err">(</span><span class="nx">string</span><span class="err">)</span>
      <span class="nx">enable_nat_gateway</span> <span class="p">=</span> <span class="nx">bool</span>
    <span class="p">}</span><span class="err">)</span>
    <span class="nx">monitoring</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
      <span class="nx">detailed_monitoring</span> <span class="p">=</span> <span class="nx">bool</span>
      <span class="nx">custom_metrics</span>     <span class="p">=</span> <span class="nx">bool</span>
      <span class="nx">log_retention_days</span> <span class="p">=</span> <span class="nx">number</span>
    <span class="p">}</span><span class="err">)</span>
  <span class="p">}</span><span class="err">))</span>
  
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Multi-environment configuration"</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">environments</span><span class="err">)</span> <span class="err">&gt;</span> <span class="mi">0</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"At least one environment must be defined."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="nx">alltrue</span><span class="err">(</span><span class="p">[</span>
      <span class="nx">for</span> <span class="nx">env</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environments</span> <span class="err">:</span> <span class="nx">can</span><span class="err">(</span><span class="nx">cidrhost</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">networking</span><span class="err">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="mi">0</span><span class="err">))</span>
    <span class="p">]</span><span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"All VPC CIDR blocks must be valid."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Dynamic type handling with any</span>
<span class="nx">variable</span> <span class="s2">"resource_configs"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">map</span><span class="err">(</span><span class="nx">any</span><span class="err">)</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Flexible resource configurations"</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="nx">alltrue</span><span class="err">(</span><span class="p">[</span>
      <span class="nx">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">resource_configs</span> <span class="err">:</span> <span class="nx">contains</span><span class="err">(</span><span class="p">[</span><span class="s2">"string"</span><span class="p">,</span> <span class="s2">"number"</span><span class="p">,</span> <span class="s2">"bool"</span><span class="p">,</span> <span class="s2">"list"</span><span class="p">,</span> <span class="s2">"map"</span><span class="p">],</span> <span class="nx">type</span><span class="err">(</span><span class="nx">v</span><span class="err">))</span>
    <span class="p">]</span><span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Resource configs must contain basic types only."</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-advanced-list-and-map-operations">2. Advanced List and Map Operations</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complex list and map transformations</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Flatten nested structures</span>
  <span class="nx">all_subnets</span> <span class="p">=</span> <span class="nx">flatten</span><span class="err">(</span><span class="p">[</span>
    <span class="nx">for</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environments</span> <span class="err">:</span> <span class="p">[</span>
      <span class="nx">for</span> <span class="nx">az_index</span><span class="p">,</span> <span class="nx">az</span> <span class="nx">in</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">networking</span><span class="err">.</span><span class="nx">availability_zones</span> <span class="err">:</span> <span class="p">{</span>
        <span class="nx">environment</span> <span class="p">=</span> <span class="nx">env_name</span>
        <span class="nx">az</span>          <span class="p">=</span> <span class="nx">az</span>
        <span class="nx">cidr</span>        <span class="p">=</span> <span class="nx">cidrsubnet</span><span class="err">(</span><span class="nx">env_config</span><span class="err">.</span><span class="nx">networking</span><span class="err">.</span><span class="nx">vpc_cidr</span><span class="err">,</span> <span class="mi">8</span><span class="err">,</span> <span class="nx">az_index</span><span class="err">)</span>
        <span class="nx">type</span>        <span class="p">=</span> <span class="nx">az_index</span> <span class="err">&lt;</span> <span class="mi">2</span> <span class="err">?</span> <span class="s2">"public"</span> <span class="err">:</span> <span class="s2">"private"</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">]</span><span class="err">)</span>
  
  <span class="c1"># Group subnets by type</span>
  <span class="nx">subnets_by_type</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">subnet</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">all_subnets</span> <span class="err">:</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">type</span> <span class="p">=</span><span class="err">&gt;</span> <span class="nx">subnet</span><span class="err">...</span>
  <span class="p">}</span>
  
  <span class="c1"># Create complex mappings</span>
  <span class="nx">instance_configs</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">env</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environments</span> <span class="err">:</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">instances</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">i</span> <span class="nx">in</span> <span class="nx">range</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">config</span><span class="err">.</span><span class="nx">instance_count</span><span class="err">)</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">name</span>      <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-%02d"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span><span class="err">,</span> <span class="nx">i</span> <span class="err">+</span> <span class="mi">1</span><span class="err">)</span>
          <span class="nx">subnet_id</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">subnets_by_type</span><span class="err">.</span><span class="nx">private</span><span class="p">[</span><span class="nx">i</span> <span class="err">%</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">subnets_by_type</span><span class="err">.</span><span class="nx">private</span><span class="err">)</span><span class="p">]</span><span class="err">.</span><span class="nx">cidr</span>
          <span class="nx">az</span>        <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">subnets_by_type</span><span class="err">.</span><span class="nx">private</span><span class="p">[</span><span class="nx">i</span> <span class="err">%</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">subnets_by_type</span><span class="err">.</span><span class="nx">private</span><span class="err">)</span><span class="p">]</span><span class="err">.</span><span class="nx">az</span>
        <span class="p">}</span>
      <span class="p">]</span>
      <span class="nx">total_cost_estimate</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">config</span><span class="err">.</span><span class="nx">instance_count</span> <span class="err">*</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="err">,</span> <span class="nx">env</span><span class="err">.</span><span class="nx">config</span><span class="err">.</span><span class="nx">instance_type</span><span class="err">,</span> <span class="mi">100</span><span class="err">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Advanced filtering and transformation</span>
  <span class="nx">production_instances</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">for</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">instance_configs</span> <span class="err">:</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">instances</span><span class="err">...</span>
    <span class="nx">if</span> <span class="nx">env_name</span> <span class="err">==</span> <span class="s2">"production"</span>
  <span class="p">]</span>
  
  <span class="c1"># Conditional list construction</span>
  <span class="nx">monitoring_targets</span> <span class="p">=</span> <span class="nx">concat</span><span class="err">(</span>
    <span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">production_instances</span> <span class="err">:</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">name</span><span class="p">]</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_staging_monitoring</span> <span class="err">?</span> <span class="p">[</span>
      <span class="nx">for</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">instance_configs</span> <span class="err">:</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">instances</span><span class="p">[</span><span class="err">*</span><span class="p">]</span><span class="err">.</span><span class="nx">name</span><span class="err">...</span>
      <span class="nx">if</span> <span class="nx">env_name</span> <span class="err">==</span> <span class="s2">"staging"</span>
    <span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
  <span class="err">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="conditional-expressions---advanced-patterns">Conditional Expressions - Advanced Patterns</h2>

<p><br /></p>

<h3 id="1-complex-conditional-logic">1. Complex Conditional Logic</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Multi-level conditional expressions</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Environment-based configuration selection</span>
  <span class="nx">instance_type</span> <span class="p">=</span> <span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">high_performance</span> <span class="err">?</span> <span class="s2">"c5.2xlarge"</span> <span class="err">:</span> <span class="s2">"m5.xlarge"</span>
    <span class="err">)</span> <span class="err">:</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"staging"</span> <span class="err">?</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">enable_testing</span> <span class="err">?</span> <span class="s2">"m5.large"</span> <span class="err">:</span> <span class="s2">"t3.medium"</span>
    <span class="err">)</span> <span class="err">:</span> <span class="s2">"t3.micro"</span>
  <span class="err">)</span>
  
  <span class="c1"># Complex backup configuration</span>
  <span class="nx">backup_config</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_backups</span> <span class="err">?</span> <span class="p">{</span>
    <span class="nx">retention_period</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">30</span> <span class="err">:</span> <span class="mi">7</span>
    <span class="nx">backup_window</span>   <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"03:00-04:00"</span> <span class="err">:</span> <span class="s2">"02:00-03:00"</span>
    <span class="nx">copy_tags_to_snapshot</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">delete_automated_backups</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"production"</span>
  <span class="p">}</span> <span class="err">:</span> <span class="kc">null</span>
  
  <span class="c1"># Conditional resource creation parameters</span>
  <span class="nx">create_monitoring</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_monitoring</span> <span class="err">&amp;&amp;</span> <span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">||</span> 
    <span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"staging"</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_staging_monitoring</span><span class="err">)</span>
  <span class="err">)</span>
  
  <span class="c1"># Network configuration based on environment</span>
  <span class="nx">network_config</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">enable_nat_gateway</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="kc">true</span> <span class="err">:</span> <span class="nx">var</span><span class="err">.</span><span class="nx">cost_optimization</span> <span class="err">?</span> <span class="kc">false</span> <span class="err">:</span> <span class="kc">true</span>
    <span class="nx">enable_vpn_gateway</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_hybrid_connectivity</span>
    <span class="nx">flow_logs_enabled</span>  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"development"</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_compliance</span>
    
    <span class="c1"># Conditional CIDR allocation</span>
    <span class="nx">vpc_cidr</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">custom_vpc_cidr</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">custom_vpc_cidr</span> <span class="err">:</span> 
      <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"10.0.0.0/16"</span> <span class="err">:</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"staging"</span> <span class="err">?</span> <span class="s2">"10.1.0.0/16"</span> <span class="err">:</span> <span class="s2">"10.2.0.0/16"</span>
    <span class="err">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Advanced conditional resource configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"web"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_web_tier</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">web_instance_count</span> <span class="err">:</span> <span class="mi">0</span>
  
  <span class="nx">ami</span>           <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">is_valid_ami</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">ami_id</span> <span class="err">:</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_ami</span><span class="err">.</span><span class="nx">default</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">instance_type</span>
  
  <span class="c1"># Conditional block inclusion</span>
  <span class="nx">dynamic</span> <span class="s2">"ebs_block_device"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_additional_storage</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">device_name</span> <span class="p">=</span> <span class="s2">"/dev/sdf"</span>
      <span class="nx">volume_size</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">100</span> <span class="err">:</span> <span class="mi">50</span>
      <span class="nx">volume_type</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"gp3"</span> <span class="err">:</span> <span class="s2">"gp2"</span>
      <span class="nx">encrypted</span>   <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"development"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">user_data</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">custom_user_data</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">custom_user_data</span> <span class="err">:</span> <span class="err">(</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_automatic_updates</span> <span class="err">?</span> 
    <span class="nx">file</span><span class="err">(</span><span class="s2">"${path.module}/scripts/auto-update.sh"</span><span class="err">)</span> <span class="err">:</span> 
    <span class="nx">file</span><span class="err">(</span><span class="s2">"${path.module}/scripts/basic-setup.sh"</span><span class="err">)</span>
  <span class="err">)</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">base_tags</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_cost_tracking</span> <span class="err">?</span> <span class="p">{</span>
      <span class="nx">CostCenter</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">cost_center</span>
      <span class="nx">BillingProject</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">billing_project</span>
    <span class="p">}</span> <span class="err">:</span> <span class="p">{}</span><span class="err">,</span>
    <span class="nx">var</span><span class="err">.</span><span class="nx">enable_compliance</span> <span class="err">?</span> <span class="p">{</span>
      <span class="nx">ComplianceScope</span> <span class="p">=</span> <span class="s2">"SOC2"</span>
      <span class="nx">DataClassification</span> <span class="p">=</span> <span class="s2">"internal"</span>
    <span class="p">}</span> <span class="err">:</span> <span class="p">{}</span>
  <span class="err">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-validation-with-conditional-logic">2. Validation with Conditional Logic</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced validation using conditional expressions</span>
<span class="nx">variable</span> <span class="s2">"database_config"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
    <span class="nx">engine</span>         <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">engine_version</span> <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">instance_class</span> <span class="p">=</span> <span class="nx">string</span>
    <span class="nx">allocated_storage</span> <span class="p">=</span> <span class="nx">number</span>
    <span class="nx">multi_az</span>       <span class="p">=</span> <span class="nx">bool</span>
    <span class="nx">backup_retention_period</span> <span class="p">=</span> <span class="nx">number</span>
  <span class="p">}</span><span class="err">)</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="nx">contains</span><span class="err">(</span><span class="p">[</span><span class="s2">"mysql"</span><span class="p">,</span> <span class="s2">"postgres"</span><span class="p">,</span> <span class="s2">"mariadb"</span><span class="p">]</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">engine</span><span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Database engine must be one of: mysql, postgres, mariadb."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">engine</span> <span class="p">==</span> <span class="s2">"mysql"</span> <span class="err">?</span> 
      <span class="nx">can</span><span class="err">(</span><span class="nx">regex</span><span class="err">(</span><span class="s2">"^[0-9]+</span><span class="err">\\</span><span class="s2">.[0-9]+$"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">engine_version</span><span class="err">))</span> <span class="err">:</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">engine</span> <span class="p">==</span> <span class="s2">"postgres"</span> <span class="err">?</span>
      <span class="nx">tonumber</span><span class="err">(</span><span class="nx">split</span><span class="err">(</span><span class="s2">"."</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">engine_version</span><span class="err">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">)</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">12</span> <span class="err">:</span>
      <span class="kc">true</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Engine version must be valid for the selected database engine."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">backup_retention_period</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">0</span> <span class="err">&amp;&amp;</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">backup_retention_period</span> <span class="err">&lt;</span><span class="p">=</span> <span class="err">(</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">database_config</span><span class="err">.</span><span class="nx">multi_az</span> <span class="err">?</span> <span class="mi">35</span> <span class="err">:</span> <span class="mi">7</span>
      <span class="err">)</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Backup retention period must be 0-35 days for Multi-AZ, 0-7 days for single-AZ."</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Complex environment-based validation</span>
<span class="nx">variable</span> <span class="s2">"scaling_config"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">object</span><span class="err">(</span><span class="p">{</span>
    <span class="nx">min_size</span>         <span class="p">=</span> <span class="nx">number</span>
    <span class="nx">max_size</span>         <span class="p">=</span> <span class="nx">number</span>
    <span class="nx">desired_capacity</span> <span class="p">=</span> <span class="nx">number</span>
    <span class="nx">environment</span>      <span class="p">=</span> <span class="nx">string</span>
  <span class="p">}</span><span class="err">)</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">min_size</span> <span class="err">&lt;</span><span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">desired_capacity</span> <span class="err">&amp;&amp;</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">desired_capacity</span> <span class="err">&lt;</span><span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">max_size</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Scaling configuration must satisfy: min_size ≤ desired_capacity ≤ max_size."</span>
  <span class="p">}</span>
  
  <span class="nx">validation</span> <span class="p">{</span>
    <span class="nx">condition</span> <span class="p">=</span> <span class="err">(</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">min_size</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">2</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">max_size</span> <span class="err">&lt;</span><span class="p">=</span> <span class="mi">20</span> <span class="err">:</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"staging"</span> <span class="err">?</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">min_size</span> <span class="err">&gt;</span><span class="p">=</span> <span class="mi">1</span> <span class="err">&amp;&amp;</span> <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">max_size</span> <span class="err">&lt;</span><span class="p">=</span> <span class="mi">10</span> <span class="err">:</span>
      <span class="nx">var</span><span class="err">.</span><span class="nx">scaling_config</span><span class="err">.</span><span class="nx">max_size</span> <span class="err">&lt;</span><span class="p">=</span> <span class="mi">5</span>
    <span class="err">)</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Scaling limits must be appropriate for the environment."</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="for-expressions---advanced-iteration">for Expressions - Advanced Iteration</h2>

<p><br /></p>

<h3 id="1-complex-data-transformations">1. Complex Data Transformations</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced for expression patterns</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Transform and filter collections simultaneously</span>
  <span class="nx">production_databases</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">db_name</span><span class="err">,</span> <span class="nx">db_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">databases</span> <span class="err">:</span> <span class="nx">db_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">instance_class</span> <span class="p">=</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">performance_tier</span> <span class="p">==</span> <span class="s2">"high"</span> <span class="err">?</span> <span class="s2">"db.r5.xlarge"</span> <span class="err">:</span> <span class="s2">"db.t3.medium"</span>
      <span class="nx">allocated_storage</span> <span class="p">=</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">storage_requirements</span> <span class="err">*</span> <span class="mi">2</span>  <span class="c1"># Production gets 2x storage</span>
      <span class="nx">backup_retention</span> <span class="p">=</span> <span class="mi">30</span>
      <span class="nx">multi_az</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="nx">encrypted</span> <span class="p">=</span> <span class="kc">true</span>
      
      <span class="c1"># Conditional parameter groups</span>
      <span class="nx">parameter_group</span> <span class="p">=</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">engine</span> <span class="p">==</span> <span class="s2">"postgres"</span> <span class="err">?</span> 
        <span class="nx">aws_db_parameter_group</span><span class="err">.</span><span class="nx">postgres_prod</span><span class="err">.</span><span class="nx">name</span> <span class="err">:</span> 
        <span class="nx">aws_db_parameter_group</span><span class="err">.</span><span class="nx">mysql_prod</span><span class="err">.</span><span class="nx">name</span>
        
      <span class="c1"># Environment-specific networking</span>
      <span class="nx">subnet_group_name</span> <span class="p">=</span> <span class="nx">aws_db_subnet_group</span><span class="err">.</span><span class="nx">production</span><span class="err">.</span><span class="nx">name</span>
      <span class="nx">vpc_security_group_ids</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">db_production</span><span class="err">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">app_to_db</span><span class="err">.</span><span class="nx">id</span>
      <span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">if</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">enabled</span> <span class="err">&amp;&amp;</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span>
  <span class="p">}</span>
  
  <span class="c1"># Create complex nested structures</span>
  <span class="nx">service_mesh_config</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">service_name</span><span class="err">,</span> <span class="nx">service_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">microservices</span> <span class="err">:</span> <span class="nx">service_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="c1"># Service discovery configuration</span>
      <span class="nx">service_discovery</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">namespace</span> <span class="p">=</span> <span class="nx">aws_service_discovery_http_namespace</span><span class="err">.</span><span class="nx">main</span><span class="err">.</span><span class="nx">name</span>
        <span class="nx">service_name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s"</span><span class="err">,</span> <span class="nx">service_name</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">)</span>
        <span class="nx">health_check_grace_period</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">startup_time</span>
      <span class="p">}</span>
      
      <span class="c1"># Load balancer target groups</span>
      <span class="nx">target_groups</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">port</span> <span class="nx">in</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">ports</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-%d"</span><span class="err">,</span> <span class="nx">service_name</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> <span class="nx">port</span><span class="err">)</span>
          <span class="nx">port</span> <span class="p">=</span> <span class="nx">port</span>
          <span class="nx">protocol</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">protocol</span>
          <span class="nx">health_check_path</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">health_check_path</span>
          <span class="nx">health_check_interval</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">health_check_interval</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="c1"># Service dependencies and routing</span>
      <span class="nx">dependencies</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">dep</span> <span class="nx">in</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">dependencies</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">service_name</span> <span class="p">=</span> <span class="nx">dep</span>
          <span class="nx">endpoint</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"http://%s.%s.local:%d"</span><span class="err">,</span> 
            <span class="nx">dep</span><span class="err">,</span> 
            <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span> 
            <span class="nx">var</span><span class="err">.</span><span class="nx">microservices</span><span class="p">[</span><span class="nx">dep</span><span class="p">]</span><span class="err">.</span><span class="nx">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="err">)</span>
          <span class="nx">timeout</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">microservices</span><span class="p">[</span><span class="nx">dep</span><span class="p">]</span><span class="err">.</span><span class="nx">timeout</span>
        <span class="p">}</span>
        <span class="nx">if</span> <span class="nx">contains</span><span class="err">(</span><span class="nx">keys</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">microservices</span><span class="err">)</span><span class="p">,</span> <span class="nx">dep</span><span class="err">)</span>
      <span class="p">]</span>
      
      <span class="c1"># Auto-scaling configuration</span>
      <span class="nx">scaling_policies</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">auto_scaling</span> <span class="err">?</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span> <span class="p">=</span> <span class="s2">"cpu-scaling"</span>
          <span class="nx">target_value</span> <span class="p">=</span> <span class="mi">70</span>
          <span class="nx">metric_type</span> <span class="p">=</span> <span class="s2">"CPUUtilization"</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nx">name</span> <span class="p">=</span> <span class="s2">"memory-scaling"</span>
          <span class="nx">target_value</span> <span class="p">=</span> <span class="mi">80</span>
          <span class="nx">metric_type</span> <span class="p">=</span> <span class="s2">"MemoryUtilization"</span>
        <span class="p">}</span>
      <span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Multi-dimensional data processing</span>
  <span class="nx">cross_region_backups</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">region</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">backup_regions</span> <span class="err">:</span> <span class="nx">region</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">db_name</span><span class="err">,</span> <span class="nx">db_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">production_databases</span> <span class="err">:</span> <span class="nx">db_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
        <span class="nx">source_db_arn</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"arn:aws:rds:%s:%s:db:%s"</span><span class="err">,</span>
          <span class="nx">var</span><span class="err">.</span><span class="nx">primary_region</span><span class="err">,</span>
          <span class="nx">data</span><span class="err">.</span><span class="nx">aws_caller_identity</span><span class="err">.</span><span class="nx">current</span><span class="err">.</span><span class="nx">account_id</span><span class="err">,</span>
          <span class="nx">db_name</span>
        <span class="err">)</span>
        <span class="nx">backup_schedule</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%d %d * * %s"</span><span class="err">,</span> 
          <span class="err">(</span><span class="nx">index</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">backup_regions</span><span class="err">,</span> <span class="nx">region</span><span class="err">)</span> <span class="err">*</span> <span class="mi">2</span><span class="err">),</span>  <span class="c1"># Stagger backup times</span>
          <span class="mi">3</span><span class="err">,</span>  <span class="c1"># 3 AM</span>
          <span class="nx">join</span><span class="err">(</span><span class="s2">","</span><span class="err">,</span> <span class="nx">range</span><span class="err">(</span><span class="mi">7</span><span class="err">))</span>  <span class="c1"># Daily</span>
        <span class="err">)</span>
        <span class="nx">retention_days</span> <span class="p">=</span> <span class="mi">14</span>
        <span class="nx">encrypted</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      <span class="nx">if</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">cross_region_backup</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-advanced-filtering-and-aggregation">2. Advanced Filtering and Aggregation</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complex filtering with multiple conditions</span>
<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Filter and transform with complex conditions</span>
  <span class="nx">eligible_instances</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">for</span> <span class="nx">instance</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="p">{</span>
      <span class="nx">id</span> <span class="p">=</span> <span class="nx">instance</span><span class="err">.</span><span class="nx">id</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="nx">instance</span><span class="err">.</span><span class="nx">name</span>
      <span class="nx">enhanced_config</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">monitoring_enabled</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="nx">backup_enabled</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="nx">security_group_ids</span> <span class="p">=</span> <span class="nx">concat</span><span class="err">(</span>
          <span class="nx">instance</span><span class="err">.</span><span class="nx">security_group_ids</span><span class="err">,</span>
          <span class="p">[</span><span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">enhanced_monitoring</span><span class="err">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="err">)</span>
      <span class="p">}</span>
      <span class="nx">cost_optimization</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">rightsizing_recommendation</span> <span class="p">=</span> <span class="err">(</span>
          <span class="nx">instance</span><span class="err">.</span><span class="nx">cpu_utilization</span> <span class="err">&lt;</span> <span class="mi">20</span> <span class="err">?</span> <span class="s2">"downsize"</span> <span class="err">:</span>
          <span class="nx">instance</span><span class="err">.</span><span class="nx">cpu_utilization</span> <span class="err">&gt;</span> <span class="mi">80</span> <span class="err">?</span> <span class="s2">"upsize"</span> <span class="err">:</span> <span class="s2">"maintain"</span>
        <span class="err">)</span>
        <span class="nx">estimated_monthly_cost</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="err">,</span> <span class="nx">instance</span><span class="err">.</span><span class="nx">type</span><span class="err">,</span> <span class="mi">0</span><span class="err">)</span> <span class="err">*</span> <span class="mi">24</span> <span class="err">*</span> <span class="mi">30</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">if</span> <span class="err">(</span>
      <span class="nx">instance</span><span class="err">.</span><span class="nx">environment</span> <span class="err">==</span> <span class="s2">"production"</span> <span class="err">&amp;&amp;</span>
      <span class="nx">instance</span><span class="err">.</span><span class="nx">cpu_utilization</span> <span class="err">!=</span> <span class="kc">null</span> <span class="err">&amp;&amp;</span>
      <span class="nx">instance</span><span class="err">.</span><span class="nx">memory_utilization</span> <span class="err">!=</span> <span class="kc">null</span> <span class="err">&amp;&amp;</span>
      <span class="err">!</span><span class="nx">instance</span><span class="err">.</span><span class="nx">marked_for_termination</span>
    <span class="err">)</span>
  <span class="p">]</span>
  
  <span class="c1"># Aggregate data across multiple dimensions</span>
  <span class="nx">cost_summary</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">by_environment</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">env</span> <span class="nx">in</span> <span class="nx">distinct</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span><span class="p">]</span><span class="err">)</span> <span class="err">:</span> <span class="nx">env</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
        <span class="nx">total_instances</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span> <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span> <span class="err">==</span> <span class="nx">env</span><span class="p">]</span><span class="err">)</span>
        <span class="nx">total_cost</span> <span class="p">=</span> <span class="nx">sum</span><span class="err">(</span><span class="p">[</span>
          <span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="p">,</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">type</span><span class="p">,</span> <span class="mi">0</span><span class="err">)</span>
          <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span> <span class="err">==</span> <span class="nx">env</span>
        <span class="p">]</span><span class="err">)</span>
        <span class="nx">average_utilization</span> <span class="p">=</span> <span class="nx">sum</span><span class="err">(</span><span class="p">[</span>
          <span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">cpu_utilization</span>
          <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span> <span class="err">==</span> <span class="nx">env</span> <span class="err">&amp;&amp;</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">cpu_utilization</span> <span class="err">!=</span> <span class="kc">null</span>
        <span class="p">]</span><span class="err">)</span> <span class="err">/</span> <span class="nx">length</span><span class="err">(</span><span class="p">[</span>
          <span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span>
          <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span> <span class="err">==</span> <span class="nx">env</span> <span class="err">&amp;&amp;</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">cpu_utilization</span> <span class="err">!=</span> <span class="kc">null</span>
        <span class="p">]</span><span class="err">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">by_instance_type</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">type</span> <span class="nx">in</span> <span class="nx">distinct</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">type</span><span class="p">]</span><span class="err">)</span> <span class="err">:</span> <span class="nx">type</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
        <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span> <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">type</span> <span class="err">==</span> <span class="nx">type</span><span class="p">]</span><span class="err">)</span>
        <span class="nx">total_cost</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span> <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">type</span> <span class="err">==</span> <span class="nx">type</span><span class="p">]</span><span class="err">)</span> <span class="err">*</span> 
                    <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="err">,</span> <span class="nx">type</span><span class="err">,</span> <span class="mi">0</span><span class="err">)</span>
        <span class="nx">environments</span> <span class="p">=</span> <span class="nx">distinct</span><span class="err">(</span><span class="p">[</span>
          <span class="nx">for</span> <span class="nx">inst</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">instances</span> <span class="err">:</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">environment</span> <span class="nx">if</span> <span class="nx">inst</span><span class="err">.</span><span class="nx">type</span> <span class="err">==</span> <span class="nx">type</span>
        <span class="p">]</span><span class="err">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Create security group rules from service definitions</span>
  <span class="nx">security_group_rules</span> <span class="p">=</span> <span class="nx">flatten</span><span class="err">(</span><span class="p">[</span>
    <span class="nx">for</span> <span class="nx">service_name</span><span class="p">,</span> <span class="nx">service_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">services</span> <span class="err">:</span> <span class="p">[</span>
      <span class="nx">for</span> <span class="nx">rule</span> <span class="nx">in</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">security_rules</span> <span class="err">:</span> <span class="p">{</span>
        <span class="nx">service_name</span> <span class="p">=</span> <span class="nx">service_name</span>
        <span class="nx">rule_type</span> <span class="p">=</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">type</span>
        <span class="nx">from_port</span> <span class="p">=</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">from_port</span>
        <span class="nx">to_port</span> <span class="p">=</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">to_port</span>
        <span class="nx">protocol</span> <span class="p">=</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">protocol</span>
        
        <span class="c1"># Dynamic source configuration</span>
        <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">rule</span><span class="err">,</span> <span class="s2">"cidr_blocks"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span>
        <span class="nx">source_security_group_id</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">rule</span><span class="err">,</span> <span class="s2">"source_service"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> 
          <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">service_security_groups</span><span class="err">,</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">source_service</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">:</span> <span class="kc">null</span>
        
        <span class="c1"># Rule description with context</span>
        <span class="nx">description</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"%s - %s traffic for %s service"</span><span class="err">,</span>
          <span class="nx">title</span><span class="err">(</span><span class="nx">rule</span><span class="err">.</span><span class="nx">type</span><span class="err">),</span>
          <span class="nx">rule</span><span class="err">.</span><span class="nx">protocol</span><span class="err">,</span>
          <span class="nx">service_name</span>
        <span class="err">)</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">]</span><span class="err">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="dynamic-blocks---advanced-resource-generation">Dynamic Blocks - Advanced Resource Generation</h2>

<p><br /></p>

<h3 id="1-complex-dynamic-block-patterns">1. Complex Dynamic Block Patterns</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced dynamic block with conditional logic</span>
<span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">name_prefix</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">application_name</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">)</span>
  <span class="nx">vpc_id</span>      <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">vpc_id</span>

  <span class="c1"># Dynamic ingress rules with complex conditions</span>
  <span class="nx">dynamic</span> <span class="s2">"ingress"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">rule</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">security_rules</span> <span class="err">:</span> <span class="s2">"${rule.name}-${rule.protocol}-${rule.port}"</span> <span class="p">=</span><span class="err">&gt;</span> <span class="nx">rule</span>
      <span class="nx">if</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">type</span> <span class="p">==</span> <span class="s2">"ingress"</span> <span class="err">&amp;&amp;</span> <span class="err">(</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">production_approved</span> <span class="err">:</span> <span class="kc">true</span>
      <span class="err">)</span>
    <span class="p">}</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">description</span> <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">description</span>
      <span class="nx">from_port</span>   <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port</span>
      <span class="nx">to_port</span>     <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port_range</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port_range</span> <span class="err">:</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port</span>
      <span class="nx">protocol</span>    <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">protocol</span>
      
      <span class="c1"># Conditional source configuration</span>
      <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">source_type</span> <span class="p">==</span> <span class="s2">"cidr"</span> <span class="err">?</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">sources</span> <span class="err">:</span> <span class="kc">null</span>
      
      <span class="nx">source_security_group_id</span> <span class="p">=</span> <span class="err">(</span>
        <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">source_type</span> <span class="p">==</span> <span class="s2">"security_group"</span> <span class="err">?</span> 
        <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">security_group_map</span><span class="err">,</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">:</span> <span class="kc">null</span>
      <span class="err">)</span>
      
      <span class="c1"># Self-referencing for internal communication</span>
      <span class="nx">self</span> <span class="p">=</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">source_type</span> <span class="p">==</span> <span class="s2">"self"</span> <span class="err">?</span> <span class="kc">true</span> <span class="err">:</span> <span class="kc">null</span>
      
      <span class="c1"># Prefix list support for AWS services</span>
      <span class="nx">prefix_list_ids</span> <span class="p">=</span> <span class="err">(</span>
        <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">source_type</span> <span class="p">==</span> <span class="s2">"prefix_list"</span> <span class="err">?</span> <span class="nx">ingress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">sources</span> <span class="err">:</span> <span class="kc">null</span>
      <span class="err">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic egress rules with environment-specific filtering</span>
  <span class="nx">dynamic</span> <span class="s2">"egress"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">rule</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">security_rules</span> <span class="err">:</span> <span class="s2">"${rule.name}-${rule.protocol}-${rule.port}"</span> <span class="p">=</span><span class="err">&gt;</span> <span class="nx">rule</span>
      <span class="nx">if</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">type</span> <span class="p">==</span> <span class="s2">"egress"</span> <span class="err">&amp;&amp;</span> <span class="err">(</span>
        <span class="nx">var</span><span class="err">.</span><span class="nx">restrict_egress</span> <span class="err">?</span> 
        <span class="nx">contains</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">allowed_egress_destinations</span><span class="err">,</span> <span class="nx">rule</span><span class="err">.</span><span class="nx">destination</span><span class="err">)</span> <span class="err">:</span> <span class="kc">true</span>
      <span class="err">)</span>
    <span class="p">}</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">description</span> <span class="p">=</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">description</span>
      <span class="nx">from_port</span>   <span class="p">=</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port</span>
      <span class="nx">to_port</span>     <span class="p">=</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port_range</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port_range</span> <span class="err">:</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">port</span>
      <span class="nx">protocol</span>    <span class="p">=</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">protocol</span>
      <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="nx">egress</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">destinations</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">common_tags</span><span class="err">,</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-sg"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">application_name</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environment</span><span class="err">)</span>
  <span class="p">}</span><span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Complex ALB listener rules with dynamic blocks</span>
<span class="nx">resource</span> <span class="s2">"aws_lb_listener"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">load_balancer_arn</span> <span class="p">=</span> <span class="nx">aws_lb</span><span class="err">.</span><span class="nx">application</span><span class="err">.</span><span class="nx">arn</span>
  <span class="nx">port</span>              <span class="p">=</span> <span class="s2">"443"</span>
  <span class="nx">protocol</span>          <span class="p">=</span> <span class="s2">"HTTPS"</span>
  <span class="nx">ssl_policy</span>        <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">ssl_policy</span>
  <span class="nx">certificate_arn</span>   <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">certificate_arn</span>

  <span class="c1"># Default action</span>
  <span class="nx">default_action</span> <span class="p">{</span>
    <span class="nx">type</span>             <span class="p">=</span> <span class="s2">"forward"</span>
    <span class="nx">target_group_arn</span> <span class="p">=</span> <span class="nx">aws_lb_target_group</span><span class="err">.</span><span class="nx">default</span><span class="err">.</span><span class="nx">arn</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic listener rules for path-based routing</span>
  <span class="nx">dynamic</span> <span class="s2">"default_action"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_advanced_routing</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">type</span> <span class="p">=</span> <span class="s2">"forward"</span>
      
      <span class="nx">forward</span> <span class="p">{</span>
        <span class="nx">dynamic</span> <span class="s2">"target_group"</span> <span class="p">{</span>
          <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">target_groups</span>
          
          <span class="nx">content</span> <span class="p">{</span>
            <span class="nx">arn</span>    <span class="p">=</span> <span class="nx">target_group</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">arn</span>
            <span class="nx">weight</span> <span class="p">=</span> <span class="nx">target_group</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">weight</span>
          <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nx">stickiness</span> <span class="p">{</span>
          <span class="nx">enabled</span>  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_stickiness</span>
          <span class="nx">duration</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stickiness_duration</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Dynamic configuration blocks in ECS service</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_service"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">name</span>            <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">service_name</span>
  <span class="nx">cluster</span>         <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">cluster_id</span>
  <span class="nx">task_definition</span> <span class="p">=</span> <span class="nx">aws_ecs_task_definition</span><span class="err">.</span><span class="nx">application</span><span class="err">.</span><span class="nx">arn</span>
  <span class="nx">desired_count</span>   <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">desired_count</span>

  <span class="c1"># Dynamic load balancer configuration</span>
  <span class="nx">dynamic</span> <span class="s2">"load_balancer"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">load_balancers</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">target_group_arn</span> <span class="p">=</span> <span class="nx">load_balancer</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">target_group_arn</span>
      <span class="nx">container_name</span>   <span class="p">=</span> <span class="nx">load_balancer</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">container_name</span>
      <span class="nx">container_port</span>   <span class="p">=</span> <span class="nx">load_balancer</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">container_port</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic network configuration</span>
  <span class="nx">dynamic</span> <span class="s2">"network_configuration"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">network_mode</span> <span class="p">==</span> <span class="s2">"awsvpc"</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">subnets</span>          <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">subnet_ids</span>
      <span class="nx">security_groups</span>  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">security_group_ids</span>
      <span class="nx">assign_public_ip</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">assign_public_ip</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic service registries for service discovery</span>
  <span class="nx">dynamic</span> <span class="s2">"service_registries"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">enable_service_discovery</span> <span class="err">?</span> <span class="p">[</span><span class="nx">var</span><span class="err">.</span><span class="nx">service_discovery_config</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">registry_arn</span> <span class="p">=</span> <span class="nx">service_registries</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">registry_arn</span>
      <span class="nx">port</span>         <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">service_registries</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"port"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span>
      
      <span class="nx">dynamic</span> <span class="s2">"container_name"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">service_registries</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"container_name"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">container_name</span> <span class="p">=</span> <span class="nx">service_registries</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">container_name</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic deployment configuration</span>
  <span class="nx">dynamic</span> <span class="s2">"deployment_configuration"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_config</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="nx">var</span><span class="err">.</span><span class="nx">deployment_config</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">maximum_percent</span>         <span class="p">=</span> <span class="nx">deployment_configuration</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">maximum_percent</span>
      <span class="nx">minimum_healthy_percent</span> <span class="p">=</span> <span class="nx">deployment_configuration</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">minimum_healthy_percent</span>
      
      <span class="nx">dynamic</span> <span class="s2">"deployment_circuit_breaker"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">deployment_configuration</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"circuit_breaker"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">enable</span>   <span class="p">=</span> <span class="nx">deployment_configuration</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">circuit_breaker</span><span class="err">.</span><span class="nx">enable</span>
          <span class="nx">rollback</span> <span class="p">=</span> <span class="nx">deployment_configuration</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">circuit_breaker</span><span class="err">.</span><span class="nx">rollback</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-nested-dynamic-blocks-with-complex-logic">2. Nested Dynamic Blocks with Complex Logic</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Advanced ECS task definition with nested dynamic blocks</span>
<span class="nx">resource</span> <span class="s2">"aws_ecs_task_definition"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">family</span>                   <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">task_family</span>
  <span class="nx">requires_compatibilities</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"FARGATE"</span><span class="p">]</span>
  <span class="nx">network_mode</span>            <span class="p">=</span> <span class="s2">"awsvpc"</span>
  <span class="nx">cpu</span>                     <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">cpu</span>
  <span class="nx">memory</span>                  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">memory</span>
  <span class="nx">execution_role_arn</span>      <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">execution_role_arn</span>
  <span class="nx">task_role_arn</span>           <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">task_role_arn</span>

  <span class="nx">container_definitions</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="err">(</span><span class="p">[</span>
    <span class="nx">for</span> <span class="nx">container</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">containers</span> <span class="err">:</span> <span class="p">{</span>
      <span class="nx">name</span>  <span class="p">=</span> <span class="nx">container</span><span class="err">.</span><span class="nx">name</span>
      <span class="nx">image</span> <span class="p">=</span> <span class="nx">container</span><span class="err">.</span><span class="nx">image</span>
      
      <span class="c1"># Dynamic port mappings</span>
      <span class="nx">portMappings</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">port_config</span> <span class="nx">in</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">"ports"</span><span class="p">,</span> <span class="p">[]</span><span class="err">)</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">containerPort</span> <span class="p">=</span> <span class="nx">port_config</span><span class="err">.</span><span class="nx">container_port</span>
          <span class="nx">hostPort</span>      <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">port_config</span><span class="err">,</span> <span class="s2">"host_port"</span><span class="err">,</span> <span class="nx">port_config</span><span class="err">.</span><span class="nx">container_port</span><span class="err">)</span>
          <span class="nx">protocol</span>      <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">port_config</span><span class="err">,</span> <span class="s2">"protocol"</span><span class="err">,</span> <span class="s2">"tcp"</span><span class="err">)</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="c1"># Dynamic environment variables with secrets handling</span>
      <span class="nx">environment</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">env_value</span> <span class="nx">in</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">"environment"</span><span class="p">,</span> <span class="p">{}</span><span class="err">)</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">name</span>  <span class="p">=</span> <span class="nx">env_name</span>
          <span class="nx">value</span> <span class="p">=</span> <span class="nx">env_value</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="nx">secrets</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">secret_name</span><span class="p">,</span> <span class="nx">secret_arn</span> <span class="nx">in</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">"secrets"</span><span class="p">,</span> <span class="p">{}</span><span class="err">)</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">name</span>      <span class="p">=</span> <span class="nx">secret_name</span>
          <span class="nx">valueFrom</span> <span class="p">=</span> <span class="nx">secret_arn</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
      <span class="c1"># Dynamic log configuration</span>
      <span class="nx">logConfiguration</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">,</span> <span class="s2">"logging"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">{</span>
        <span class="nx">logDriver</span> <span class="p">=</span> <span class="nx">container</span><span class="err">.</span><span class="nx">logging</span><span class="err">.</span><span class="nx">driver</span>
        <span class="nx">options</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
          <span class="p">{</span>
            <span class="s2">"awslogs-group"</span>         <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="err">.</span><span class="nx">application</span><span class="err">.</span><span class="nx">name</span>
            <span class="s2">"awslogs-region"</span>        <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">aws_region</span>
            <span class="s2">"awslogs-stream-prefix"</span> <span class="p">=</span> <span class="nx">container</span><span class="err">.</span><span class="nx">name</span>
          <span class="p">}</span><span class="err">,</span>
          <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">.</span><span class="nx">logging</span><span class="err">,</span> <span class="s2">"options"</span><span class="err">,</span> <span class="p">{}</span><span class="err">)</span>
        <span class="err">)</span>
      <span class="p">}</span> <span class="err">:</span> <span class="kc">null</span>
      
      <span class="c1"># Dynamic health check</span>
      <span class="nx">healthCheck</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">,</span> <span class="s2">"health_check"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">{</span>
        <span class="nx">command</span> <span class="p">=</span> <span class="p">[</span>
          <span class="s2">"CMD-SHELL"</span><span class="p">,</span>
          <span class="nx">container</span><span class="err">.</span><span class="nx">health_check</span><span class="err">.</span><span class="nx">command</span>
        <span class="p">]</span>
        <span class="nx">interval</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">.</span><span class="nx">health_check</span><span class="err">,</span> <span class="s2">"interval"</span><span class="err">,</span> <span class="mi">30</span><span class="err">)</span>
        <span class="nx">timeout</span>  <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">.</span><span class="nx">health_check</span><span class="err">,</span> <span class="s2">"timeout"</span><span class="err">,</span> <span class="mi">5</span><span class="err">)</span>
        <span class="nx">retries</span>  <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">.</span><span class="nx">health_check</span><span class="err">,</span> <span class="s2">"retries"</span><span class="err">,</span> <span class="mi">3</span><span class="err">)</span>
        <span class="nx">startPeriod</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="err">.</span><span class="nx">health_check</span><span class="err">,</span> <span class="s2">"start_period"</span><span class="err">,</span> <span class="mi">60</span><span class="err">)</span>
      <span class="p">}</span> <span class="err">:</span> <span class="kc">null</span>
      
      <span class="c1"># Dynamic mount points</span>
      <span class="nx">mountPoints</span> <span class="p">=</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">mount</span> <span class="nx">in</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">"mounts"</span><span class="p">,</span> <span class="p">[]</span><span class="err">)</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">sourceVolume</span>  <span class="p">=</span> <span class="nx">mount</span><span class="err">.</span><span class="nx">source_volume</span>
          <span class="nx">containerPath</span> <span class="p">=</span> <span class="nx">mount</span><span class="err">.</span><span class="nx">container_path</span>
          <span class="nx">readOnly</span>      <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">mount</span><span class="err">,</span> <span class="s2">"read_only"</span><span class="err">,</span> <span class="kc">false</span><span class="err">)</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span><span class="err">)</span>

  <span class="c1"># Dynamic volume definitions</span>
  <span class="nx">dynamic</span> <span class="s2">"volume"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">volumes</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">name</span>
      
      <span class="nx">dynamic</span> <span class="s2">"host"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"host_path"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">source_path</span> <span class="p">=</span> <span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">host_path</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">dynamic</span> <span class="s2">"efs_volume_configuration"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"efs_config"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">file_system_id</span>     <span class="p">=</span> <span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">.</span><span class="nx">file_system_id</span>
          <span class="nx">root_directory</span>     <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">,</span> <span class="s2">"root_directory"</span><span class="err">,</span> <span class="s2">"/"</span><span class="err">)</span>
          <span class="nx">transit_encryption</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">,</span> <span class="s2">"transit_encryption"</span><span class="err">,</span> <span class="s2">"ENABLED"</span><span class="err">)</span>
          
          <span class="nx">dynamic</span> <span class="s2">"authorization_config"</span> <span class="p">{</span>
            <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">,</span> <span class="s2">"access_point_id"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
            
            <span class="nx">content</span> <span class="p">{</span>
              <span class="nx">access_point_id</span> <span class="p">=</span> <span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">.</span><span class="nx">access_point_id</span>
              <span class="nx">iam</span>            <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">volume</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">efs_config</span><span class="err">,</span> <span class="s2">"use_iam"</span><span class="err">,</span> <span class="s2">"ENABLED"</span><span class="err">)</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">common_tags</span>
<span class="p">}</span>

<span class="c1"># CloudFront distribution with complex dynamic behaviors</span>
<span class="nx">resource</span> <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">enabled</span>             <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">is_ipv6_enabled</span>     <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">default_root_object</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">default_root_object</span>
  <span class="nx">aliases</span>             <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">aliases</span>
  <span class="nx">web_acl_id</span>          <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">web_acl_id</span>

  <span class="c1"># Dynamic origins with complex configurations</span>
  <span class="nx">dynamic</span> <span class="s2">"origin"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">origins</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">domain_name</span> <span class="p">=</span> <span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">domain_name</span>
      <span class="nx">origin_id</span>   <span class="p">=</span> <span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">origin_id</span>
      <span class="nx">origin_path</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"origin_path"</span><span class="err">,</span> <span class="s2">""</span><span class="err">)</span>
      
      <span class="nx">dynamic</span> <span class="s2">"custom_origin_config"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"custom_origin_config"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">http_port</span>              <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"http_port"</span><span class="err">,</span> <span class="mi">80</span><span class="err">)</span>
          <span class="nx">https_port</span>             <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"https_port"</span><span class="err">,</span> <span class="mi">443</span><span class="err">)</span>
          <span class="nx">origin_protocol_policy</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"origin_protocol_policy"</span><span class="err">,</span> <span class="s2">"https-only"</span><span class="err">)</span>
          <span class="nx">origin_ssl_protocols</span>   <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"origin_ssl_protocols"</span><span class="err">,</span> <span class="p">[</span><span class="s2">"TLSv1.2"</span><span class="p">]</span><span class="err">)</span>
          
          <span class="nx">origin_read_timeout</span>    <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"origin_read_timeout"</span><span class="err">,</span> <span class="mi">30</span><span class="err">)</span>
          <span class="nx">origin_keepalive_timeout</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">custom_origin_config</span><span class="err">,</span> <span class="s2">"origin_keepalive_timeout"</span><span class="err">,</span> <span class="mi">5</span><span class="err">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">dynamic</span> <span class="s2">"s3_origin_config"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"s3_origin_config"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">origin_access_identity</span> <span class="p">=</span> <span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">s3_origin_config</span><span class="err">.</span><span class="nx">origin_access_identity</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">dynamic</span> <span class="s2">"custom_header"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">origin</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"custom_headers"</span><span class="err">,</span> <span class="p">{}</span><span class="err">)</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">name</span>  <span class="p">=</span> <span class="nx">custom_header</span><span class="err">.</span><span class="nx">key</span>
          <span class="nx">value</span> <span class="p">=</span> <span class="nx">custom_header</span><span class="err">.</span><span class="nx">value</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1"># Dynamic cache behaviors</span>
  <span class="nx">dynamic</span> <span class="s2">"ordered_cache_behavior"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">cache_behaviors</span>
    
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">path_pattern</span>           <span class="p">=</span> <span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">path_pattern</span>
      <span class="nx">allowed_methods</span>        <span class="p">=</span> <span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">allowed_methods</span>
      <span class="nx">cached_methods</span>         <span class="p">=</span> <span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">cached_methods</span>
      <span class="nx">target_origin_id</span>       <span class="p">=</span> <span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">target_origin_id</span>
      <span class="nx">compress</span>               <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"compress"</span><span class="err">,</span> <span class="kc">true</span><span class="err">)</span>
      <span class="nx">viewer_protocol_policy</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"viewer_protocol_policy"</span><span class="err">,</span> <span class="s2">"redirect-to-https"</span><span class="err">)</span>
      
      <span class="c1"># Dynamic forwarded values</span>
      <span class="nx">dynamic</span> <span class="s2">"forwarded_values"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"forwarded_values"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">query_string</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">forwarded_values</span><span class="err">,</span> <span class="s2">"query_string"</span><span class="err">,</span> <span class="kc">false</span><span class="err">)</span>
          <span class="nx">headers</span>      <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">forwarded_values</span><span class="err">,</span> <span class="s2">"headers"</span><span class="err">,</span> <span class="p">[]</span><span class="err">)</span>
          
          <span class="nx">dynamic</span> <span class="s2">"cookies"</span> <span class="p">{</span>
            <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">forwarded_values</span><span class="err">,</span> <span class="s2">"cookies"</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span> <span class="err">!</span><span class="p">=</span> <span class="kc">null</span> <span class="err">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
            
            <span class="nx">content</span> <span class="p">{</span>
              <span class="nx">forward</span>           <span class="p">=</span> <span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">forwarded_values</span><span class="err">.</span><span class="nx">cookies</span><span class="err">.</span><span class="nx">forward</span>
              <span class="nx">whitelisted_names</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">forwarded_values</span><span class="err">.</span><span class="nx">cookies</span><span class="err">,</span> <span class="s2">"whitelisted_names"</span><span class="err">,</span> <span class="p">[]</span><span class="err">)</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1"># Dynamic Lambda@Edge functions</span>
      <span class="nx">dynamic</span> <span class="s2">"lambda_function_association"</span> <span class="p">{</span>
        <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">ordered_cache_behavior</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"lambda_function_associations"</span><span class="err">,</span> <span class="p">[]</span><span class="err">)</span>
        
        <span class="nx">content</span> <span class="p">{</span>
          <span class="nx">event_type</span>   <span class="p">=</span> <span class="nx">lambda_function_association</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">event_type</span>
          <span class="nx">lambda_arn</span>   <span class="p">=</span> <span class="nx">lambda_function_association</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">lambda_arn</span>
          <span class="nx">include_body</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">lambda_function_association</span><span class="err">.</span><span class="nx">value</span><span class="err">,</span> <span class="s2">"include_body"</span><span class="err">,</span> <span class="kc">false</span><span class="err">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">common_tags</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="real-world-implementation-examples">Real-World Implementation Examples</h2>

<p><br /></p>

<h3 id="1-multi-environment-infrastructure-module">1. Multi-Environment Infrastructure Module</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complete multi-environment infrastructure module</span>
<span class="c1"># modules/multi-env-infrastructure/main.tf</span>

<span class="nx">locals</span> <span class="p">{</span>
  <span class="c1"># Environment-specific configuration matrix</span>
  <span class="nx">environment_config</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">env</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">environments</span> <span class="err">:</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="c1"># Compute configuration</span>
      <span class="nx">instance_type</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">compute</span><span class="err">,</span> <span class="s2">"instance_type"</span><span class="err">,</span> <span class="s2">"t3.micro"</span><span class="err">)</span>
      <span class="nx">min_instances</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">compute</span><span class="err">,</span> <span class="s2">"min_instances"</span><span class="err">,</span> <span class="mi">1</span><span class="err">)</span>
      <span class="nx">max_instances</span> <span class="p">=</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">compute</span><span class="err">,</span> <span class="s2">"max_instances"</span><span class="err">,</span> <span class="mi">3</span><span class="err">)</span>
      
      <span class="c1"># Network configuration with automatic CIDR calculation</span>
      <span class="nx">vpc_cidr</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
        <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">.</span><span class="nx">networking</span><span class="err">,</span> <span class="s2">"vpc_cidr"</span><span class="err">,</span> <span class="kc">null</span><span class="err">),</span>
        <span class="nx">format</span><span class="err">(</span><span class="s2">"10.%d.0.0/16"</span><span class="err">,</span> <span class="nx">index</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">environments</span><span class="err">,</span> <span class="nx">env</span><span class="err">)</span> <span class="err">+</span> <span class="mi">10</span><span class="err">)</span>
      <span class="err">)</span>
      
      <span class="c1"># Storage configuration with environment-based defaults</span>
      <span class="nx">storage</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
        <span class="p">{</span>
          <span class="nx">type</span> <span class="p">=</span> <span class="s2">"gp3"</span>
          <span class="nx">size</span> <span class="p">=</span> <span class="mi">20</span>
          <span class="nx">encrypted</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span><span class="err">,</span>
        <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">,</span> <span class="s2">"storage"</span><span class="err">,</span> <span class="p">{}</span><span class="err">)</span>
      <span class="err">)</span>
      
      <span class="c1"># Monitoring configuration</span>
      <span class="nx">monitoring</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
        <span class="p">{</span>
          <span class="nx">enabled</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"development"</span>
          <span class="nx">detailed</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">==</span> <span class="s2">"production"</span>
          <span class="nx">retention_days</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">30</span> <span class="err">:</span> <span class="mi">7</span>
        <span class="p">}</span><span class="err">,</span>
        <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">,</span> <span class="s2">"monitoring"</span><span class="err">,</span> <span class="p">{}</span><span class="err">)</span>
      <span class="err">)</span>
      
      <span class="c1"># Security configuration</span>
      <span class="nx">security</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
        <span class="p">{</span>
          <span class="nx">enable_waf</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">==</span> <span class="s2">"production"</span>
          <span class="nx">enable_shield</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">==</span> <span class="s2">"production"</span>
          <span class="nx">ssl_policy</span> <span class="p">=</span> <span class="nx">env</span><span class="err">.</span><span class="nx">name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"ELBSecurityPolicy-TLS-1-2-2017-01"</span> <span class="err">:</span> <span class="s2">"ELBSecurityPolicy-2016-08"</span>
        <span class="p">}</span><span class="err">,</span>
        <span class="nx">lookup</span><span class="err">(</span><span class="nx">env</span><span class="err">,</span> <span class="s2">"security"</span><span class="err">,</span> <span class="p">{}</span><span class="err">)</span>
      <span class="err">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1"># Generate all infrastructure components</span>
  <span class="nx">infrastructure_components</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span> <span class="err">:</span> <span class="nx">env_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="c1"># VPC and networking</span>
      <span class="nx">vpc</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">cidr_block</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc_cidr</span>
        <span class="nx">availability_zones</span> <span class="p">=</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span><span class="err">,</span> <span class="mi">0</span><span class="err">,</span> <span class="mi">3</span><span class="err">)</span>
        
        <span class="c1"># Dynamic subnet allocation</span>
        <span class="nx">public_subnets</span> <span class="p">=</span> <span class="p">[</span>
          <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">az</span> <span class="nx">in</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="err">)</span> <span class="err">:</span>
          <span class="nx">cidrsubnet</span><span class="err">(</span><span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">i</span><span class="err">)</span>
        <span class="p">]</span>
        
        <span class="nx">private_subnets</span> <span class="p">=</span> <span class="p">[</span>
          <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">az</span> <span class="nx">in</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="err">)</span> <span class="err">:</span>
          <span class="nx">cidrsubnet</span><span class="err">(</span><span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">i</span> <span class="err">+</span> <span class="mi">10</span><span class="err">)</span>
        <span class="p">]</span>
        
        <span class="nx">database_subnets</span> <span class="p">=</span> <span class="p">[</span>
          <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">az</span> <span class="nx">in</span> <span class="nx">slice</span><span class="err">(</span><span class="nx">data</span><span class="err">.</span><span class="nx">aws_availability_zones</span><span class="err">.</span><span class="nx">available</span><span class="err">.</span><span class="nx">names</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="err">)</span> <span class="err">:</span>
          <span class="nx">cidrsubnet</span><span class="err">(</span><span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">i</span> <span class="err">+</span> <span class="mi">20</span><span class="err">)</span>
        <span class="p">]</span>
      <span class="p">}</span>
      
      <span class="c1"># Application Load Balancer configuration</span>
      <span class="nx">load_balancer</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">internal</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"development"</span>
        <span class="nx">type</span> <span class="p">=</span> <span class="s2">"application"</span>
        
        <span class="c1"># Dynamic target groups based on services</span>
        <span class="nx">target_groups</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">for</span> <span class="nx">service_name</span><span class="err">,</span> <span class="nx">service_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">services</span> <span class="err">:</span> <span class="nx">service_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
            <span class="nx">port</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">port</span>
            <span class="nx">protocol</span> <span class="p">=</span> <span class="s2">"HTTP"</span>
            <span class="nx">health_check</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">enabled</span> <span class="p">=</span> <span class="kc">true</span>
              <span class="nx">path</span> <span class="p">=</span> <span class="nx">service_config</span><span class="err">.</span><span class="nx">health_check_path</span>
              <span class="nx">matcher</span> <span class="p">=</span> <span class="s2">"200"</span>
              <span class="nx">interval</span> <span class="p">=</span> <span class="mi">30</span>
              <span class="nx">timeout</span> <span class="p">=</span> <span class="mi">5</span>
              <span class="nx">healthy_threshold</span> <span class="p">=</span> <span class="mi">2</span>
              <span class="nx">unhealthy_threshold</span> <span class="p">=</span> <span class="mi">3</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1"># Auto Scaling Group configuration</span>
      <span class="nx">auto_scaling</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">min_size</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">min_instances</span>
        <span class="nx">max_size</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">max_instances</span>
        <span class="nx">desired_capacity</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">min_instances</span>
        
        <span class="c1"># Dynamic scaling policies</span>
        <span class="nx">policies</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">monitoring</span><span class="err">.</span><span class="nx">enabled</span> <span class="err">?</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nx">name</span> <span class="p">=</span> <span class="s2">"cpu-scale-up"</span>
            <span class="nx">scaling_adjustment</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="nx">adjustment_type</span> <span class="p">=</span> <span class="s2">"ChangeInCapacity"</span>
            <span class="nx">cooldown</span> <span class="p">=</span> <span class="mi">300</span>
            
            <span class="nx">alarm</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">comparison_operator</span> <span class="p">=</span> <span class="s2">"GreaterThanThreshold"</span>
              <span class="nx">evaluation_periods</span> <span class="p">=</span> <span class="mi">2</span>
              <span class="nx">metric_name</span> <span class="p">=</span> <span class="s2">"CPUUtilization"</span>
              <span class="nx">threshold</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">70</span> <span class="err">:</span> <span class="mi">80</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nx">name</span> <span class="p">=</span> <span class="s2">"cpu-scale-down"</span>
            <span class="nx">scaling_adjustment</span> <span class="p">=</span> <span class="err">-</span><span class="mi">1</span>
            <span class="nx">adjustment_type</span> <span class="p">=</span> <span class="s2">"ChangeInCapacity"</span>
            <span class="nx">cooldown</span> <span class="p">=</span> <span class="mi">300</span>
            
            <span class="nx">alarm</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">comparison_operator</span> <span class="p">=</span> <span class="s2">"LessThanThreshold"</span>
              <span class="nx">evaluation_periods</span> <span class="p">=</span> <span class="mi">3</span>
              <span class="nx">metric_name</span> <span class="p">=</span> <span class="s2">"CPUUtilization"</span>
              <span class="nx">threshold</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">30</span> <span class="err">:</span> <span class="mi">40</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span> <span class="err">:</span> <span class="p">[]</span>
      <span class="p">}</span>
      
      <span class="c1"># Database configuration</span>
      <span class="nx">database</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">for</span> <span class="nx">db_name</span><span class="err">,</span> <span class="nx">db_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">databases</span> <span class="err">:</span> <span class="nx">db_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
          <span class="nx">instance_class</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
            <span class="nx">lookup</span><span class="err">(</span><span class="nx">db_config</span><span class="err">,</span> <span class="s2">"instance_class"</span><span class="err">,</span> <span class="kc">null</span><span class="err">),</span>
            <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"db.r5.large"</span> <span class="err">:</span> <span class="s2">"db.t3.micro"</span>
          <span class="err">)</span>
          
          <span class="nx">allocated_storage</span> <span class="p">=</span> <span class="nx">coalesce</span><span class="err">(</span>
            <span class="nx">lookup</span><span class="err">(</span><span class="nx">db_config</span><span class="err">,</span> <span class="s2">"allocated_storage"</span><span class="err">,</span> <span class="kc">null</span><span class="err">),</span>
            <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">100</span> <span class="err">:</span> <span class="mi">20</span>
          <span class="err">)</span>
          
          <span class="nx">backup_retention_period</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">30</span> <span class="err">:</span> <span class="mi">7</span>
          <span class="nx">multi_az</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span>
          
          <span class="c1"># Performance Insights for production</span>
          <span class="nx">performance_insights_enabled</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span>
          <span class="nx">performance_insights_retention_period</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">7</span> <span class="err">:</span> <span class="kc">null</span>
          
          <span class="c1"># Encryption settings</span>
          <span class="nx">storage_encrypted</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">encrypted</span>
          <span class="nx">kms_key_id</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">encrypted</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">kms_key_id</span> <span class="err">:</span> <span class="kc">null</span>
          
          <span class="c1"># Monitoring and maintenance</span>
          <span class="nx">monitoring_interval</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">monitoring</span><span class="err">.</span><span class="nx">detailed</span> <span class="err">?</span> <span class="mi">60</span> <span class="err">:</span> <span class="mi">0</span>
          <span class="nx">monitoring_role_arn</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">monitoring</span><span class="err">.</span><span class="nx">detailed</span> <span class="err">?</span> <span class="nx">var</span><span class="err">.</span><span class="nx">rds_monitoring_role_arn</span> <span class="err">:</span> <span class="kc">null</span>
          
          <span class="c1"># Environment-specific parameter groups</span>
          <span class="nx">parameter_group_name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-%s-params"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">db_config</span><span class="err">.</span><span class="nx">engine</span><span class="err">)</span>
          
          <span class="c1"># Maintenance and backup windows</span>
          <span class="nx">maintenance_window</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"sun:03:00-sun:04:00"</span> <span class="err">:</span> <span class="s2">"sun:02:00-sun:03:00"</span>
          <span class="nx">backup_window</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"02:00-03:00"</span> <span class="err">:</span> <span class="s2">"01:00-02:00"</span>
        <span class="p">}</span>
        <span class="nx">if</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">db_config</span><span class="err">,</span> <span class="s2">"enabled"</span><span class="err">,</span> <span class="kc">true</span><span class="err">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Generate VPCs for each environment</span>
<span class="nx">resource</span> <span class="s2">"aws_vpc"</span> <span class="s2">"environment"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span>
  
  <span class="nx">cidr_block</span>           <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">vpc_cidr</span>
  <span class="nx">enable_dns_hostnames</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">enable_dns_support</span>   <span class="p">=</span> <span class="kc">true</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">common_tags</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">Name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-vpc"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span><span class="err">)</span>
      <span class="nx">Environment</span> <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span>
    <span class="p">}</span>
  <span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Generate subnets dynamically</span>
<span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"public"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">combo</span> <span class="nx">in</span> <span class="nx">flatten</span><span class="err">(</span><span class="p">[</span>
      <span class="nx">for</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">infrastructure_components</span> <span class="err">:</span> <span class="p">[</span>
        <span class="nx">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">subnet_cidr</span> <span class="nx">in</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc</span><span class="err">.</span><span class="nx">public_subnets</span> <span class="err">:</span> <span class="p">{</span>
          <span class="nx">key</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-public-%d"</span><span class="err">,</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">i</span><span class="err">)</span>
          <span class="nx">env_name</span> <span class="p">=</span> <span class="nx">env_name</span>
          <span class="nx">cidr_block</span> <span class="p">=</span> <span class="nx">subnet_cidr</span>
          <span class="nx">availability_zone</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">vpc</span><span class="err">.</span><span class="nx">availability_zones</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">]</span><span class="err">)</span> <span class="err">:</span> <span class="nx">combo</span><span class="err">.</span><span class="nx">key</span> <span class="p">=</span><span class="err">&gt;</span> <span class="nx">combo</span>
  <span class="p">}</span>
  
  <span class="nx">vpc_id</span>                  <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">environment</span><span class="p">[</span><span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span>              <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">cidr_block</span>
  <span class="nx">availability_zone</span>       <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">availability_zone</span>
  <span class="nx">map_public_ip_on_launch</span> <span class="p">=</span> <span class="kc">true</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">common_tags</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">Name</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span><span class="err">)</span>
      <span class="nx">Type</span> <span class="p">=</span> <span class="s2">"public"</span>
      <span class="nx">Environment</span> <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">env_name</span>
    <span class="p">}</span>
  <span class="err">)</span>
<span class="p">}</span>

<span class="c1"># Auto Scaling Groups with complex configuration</span>
<span class="nx">resource</span> <span class="s2">"aws_autoscaling_group"</span> <span class="s2">"application"</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span>
  
  <span class="nx">name</span>                <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-asg"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span><span class="err">)</span>
  <span class="nx">vpc_zone_identifier</span> <span class="p">=</span> <span class="nx">values</span><span class="err">(</span><span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">private</span><span class="err">)</span><span class="p">[</span><span class="err">*</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span>
  
  <span class="nx">min_size</span>         <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">min_instances</span>
  <span class="nx">max_size</span>         <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">max_instances</span>
  <span class="nx">desired_capacity</span> <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">min_instances</span>
  
  <span class="nx">health_check_type</span>         <span class="p">=</span> <span class="s2">"ELB"</span>
  <span class="nx">health_check_grace_period</span> <span class="p">=</span> <span class="mi">300</span>
  
  <span class="c1"># Dynamic launch template configuration</span>
  <span class="nx">launch_template</span> <span class="p">{</span>
    <span class="nx">id</span>      <span class="p">=</span> <span class="nx">aws_launch_template</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">each</span><span class="err">.</span><span class="nx">key</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span>
    <span class="nx">version</span> <span class="p">=</span> <span class="s2">"$Latest"</span>
  <span class="p">}</span>
  
  <span class="c1"># Dynamic target group attachments</span>
  <span class="nx">dynamic</span> <span class="s2">"target_group_arns"</span> <span class="p">{</span>
    <span class="nx">for_each</span> <span class="p">=</span> <span class="nx">aws_lb_target_group</span><span class="err">.</span><span class="nx">application</span>
    <span class="nx">content</span> <span class="p">{</span>
      <span class="nx">target_group_arns</span> <span class="p">=</span> <span class="p">[</span><span class="nx">target_group_arns</span><span class="err">.</span><span class="nx">value</span><span class="err">.</span><span class="nx">arn</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">tag</span> <span class="p">{</span>
    <span class="nx">key</span>                 <span class="p">=</span> <span class="s2">"Name"</span>
    <span class="nx">value</span>               <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s-instance"</span><span class="err">,</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span><span class="err">,</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span><span class="err">)</span>
    <span class="nx">propagate_at_launch</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">tag</span> <span class="p">{</span>
    <span class="nx">key</span>                 <span class="p">=</span> <span class="s2">"Environment"</span>
    <span class="nx">value</span>               <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span>
    <span class="nx">propagate_at_launch</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="c1"># Instance refresh configuration</span>
  <span class="nx">instance_refresh</span> <span class="p">{</span>
    <span class="nx">strategy</span> <span class="p">=</span> <span class="s2">"Rolling"</span>
    <span class="nx">preferences</span> <span class="p">{</span>
      <span class="nx">min_healthy_percentage</span> <span class="p">=</span> <span class="nx">each</span><span class="err">.</span><span class="nx">key</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">75</span> <span class="err">:</span> <span class="mi">50</span>
      <span class="nx">instance_warmup</span>       <span class="p">=</span> <span class="mi">300</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="2-advanced-output-processing">2. Advanced Output Processing</h3>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complex output generation with data transformation</span>
<span class="nx">output</span> <span class="s2">"environment_summary"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Complete summary of all environment configurations"</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">environments</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span> <span class="err">:</span> <span class="nx">env_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
        <span class="c1"># Network information</span>
        <span class="nx">networking</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">vpc_id</span> <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">environment</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span>
          <span class="nx">vpc_cidr</span> <span class="p">=</span> <span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">environment</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">cidr_block</span>
          
          <span class="c1"># Subnet information grouped by type</span>
          <span class="nx">subnets</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">public</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">for</span> <span class="nx">subnet</span> <span class="nx">in</span> <span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">public</span> <span class="err">:</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
                <span class="nx">id</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">id</span>
                <span class="nx">cidr_block</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">cidr_block</span>
                <span class="nx">availability_zone</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">availability_zone</span>
              <span class="p">}</span>
              <span class="nx">if</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
            <span class="p">}</span>
            
            <span class="nx">private</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">for</span> <span class="nx">subnet</span> <span class="nx">in</span> <span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">private</span> <span class="err">:</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
                <span class="nx">id</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">id</span>
                <span class="nx">cidr_block</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">cidr_block</span>
                <span class="nx">availability_zone</span> <span class="p">=</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">availability_zone</span>
              <span class="p">}</span>
              <span class="nx">if</span> <span class="nx">subnet</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
            <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="c1"># Gateway information</span>
          <span class="nx">internet_gateway</span> <span class="p">=</span> <span class="nx">try</span><span class="err">(</span><span class="nx">aws_internet_gateway</span><span class="err">.</span><span class="nx">environment</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span><span class="err">,</span> <span class="kc">null</span><span class="err">)</span>
          <span class="nx">nat_gateways</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">for</span> <span class="nx">nat</span> <span class="nx">in</span> <span class="nx">aws_nat_gateway</span><span class="err">.</span><span class="nx">environment</span> <span class="err">:</span> <span class="nx">nat</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
              <span class="nx">id</span> <span class="p">=</span> <span class="nx">nat</span><span class="err">.</span><span class="nx">id</span>
              <span class="nx">public_ip</span> <span class="p">=</span> <span class="nx">nat</span><span class="err">.</span><span class="nx">public_ip</span>
              <span class="nx">subnet_id</span> <span class="p">=</span> <span class="nx">nat</span><span class="err">.</span><span class="nx">subnet_id</span>
            <span class="p">}</span>
            <span class="nx">if</span> <span class="nx">nat</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
          <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1"># Compute resources</span>
        <span class="nx">compute</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">auto_scaling_group</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">name</span> <span class="p">=</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">name</span>
            <span class="nx">arn</span> <span class="p">=</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">arn</span>
            <span class="nx">min_size</span> <span class="p">=</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">min_size</span>
            <span class="nx">max_size</span> <span class="p">=</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">max_size</span>
            <span class="nx">desired_capacity</span> <span class="p">=</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">desired_capacity</span>
          <span class="p">}</span>
          
          <span class="nx">launch_template</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="p">=</span> <span class="nx">aws_launch_template</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">id</span>
            <span class="nx">latest_version</span> <span class="p">=</span> <span class="nx">aws_launch_template</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">latest_version</span>
          <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1"># Load balancer information</span>
        <span class="nx">load_balancing</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">for</span> <span class="nx">lb</span> <span class="nx">in</span> <span class="nx">aws_lb</span><span class="err">.</span><span class="nx">application</span> <span class="err">:</span> <span class="nx">lb</span><span class="err">.</span><span class="nx">name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
            <span class="nx">arn</span> <span class="p">=</span> <span class="nx">lb</span><span class="err">.</span><span class="nx">arn</span>
            <span class="nx">dns_name</span> <span class="p">=</span> <span class="nx">lb</span><span class="err">.</span><span class="nx">dns_name</span>
            <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">lb</span><span class="err">.</span><span class="nx">zone_id</span>
            
            <span class="c1"># Target groups for this load balancer</span>
            <span class="nx">target_groups</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">for</span> <span class="nx">tg</span> <span class="nx">in</span> <span class="nx">aws_lb_target_group</span><span class="err">.</span><span class="nx">application</span> <span class="err">:</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
                <span class="nx">arn</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">arn</span>
                <span class="nx">port</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">port</span>
                <span class="nx">protocol</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">protocol</span>
                <span class="nx">health_check</span> <span class="p">=</span> <span class="p">{</span>
                  <span class="nx">enabled</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">health_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="nx">enabled</span>
                  <span class="nx">path</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">health_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="nx">path</span>
                  <span class="nx">port</span> <span class="p">=</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">health_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">.</span><span class="nx">port</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="nx">if</span> <span class="nx">tg</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">if</span> <span class="nx">lb</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
        <span class="p">}</span>
        
        <span class="c1"># Database information</span>
        <span class="nx">databases</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">for</span> <span class="nx">db</span> <span class="nx">in</span> <span class="nx">aws_db_instance</span><span class="err">.</span><span class="nx">application</span> <span class="err">:</span> <span class="nx">db</span><span class="err">.</span><span class="nx">identifier</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">id</span>
            <span class="nx">arn</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">arn</span>
            <span class="nx">endpoint</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">endpoint</span>
            <span class="nx">port</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">port</span>
            <span class="nx">engine</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">engine</span>
            <span class="nx">engine_version</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">engine_version</span>
            <span class="nx">instance_class</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">instance_class</span>
            <span class="nx">allocated_storage</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">allocated_storage</span>
            
            <span class="c1"># Connection information</span>
            <span class="nx">connection_info</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">jdbc_url</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"jdbc:postgresql://%s:%s/%s"</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">endpoint</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">port</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">db_name</span><span class="err">)</span>
              <span class="nx">psql_command</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span><span class="s2">"psql -h %s -p %s -U %s -d %s"</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">endpoint</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">port</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">username</span><span class="err">,</span> <span class="nx">db</span><span class="err">.</span><span class="nx">db_name</span><span class="err">)</span>
            <span class="p">}</span>
            
            <span class="c1"># Backup and maintenance windows</span>
            <span class="nx">maintenance</span> <span class="p">=</span> <span class="p">{</span>
              <span class="nx">backup_window</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">backup_window</span>
              <span class="nx">maintenance_window</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">maintenance_window</span>
              <span class="nx">backup_retention_period</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">backup_retention_period</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">if</span> <span class="nx">db</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
        <span class="p">}</span>
        
        <span class="c1"># Cost estimation</span>
        <span class="nx">cost_estimation</span> <span class="p">=</span> <span class="p">{</span>
          <span class="nx">monthly_estimate</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">compute</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">desired_capacity</span><span class="err">)</span> <span class="err">*</span> 
                     <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="err">,</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">instance_type</span><span class="err">,</span> <span class="mi">100</span><span class="err">)</span> <span class="err">*</span> <span class="mi">24</span> <span class="err">*</span> <span class="mi">30</span>
            
            <span class="nx">storage</span> <span class="p">=</span> <span class="nx">sum</span><span class="err">(</span><span class="p">[</span>
              <span class="nx">for</span> <span class="nx">db</span> <span class="nx">in</span> <span class="nx">values</span><span class="err">(</span><span class="nx">aws_db_instance</span><span class="err">.</span><span class="nx">application</span><span class="err">)</span> <span class="err">:</span> <span class="nx">db</span><span class="err">.</span><span class="nx">allocated_storage</span> <span class="err">*</span> <span class="mf">0.115</span>
              <span class="nx">if</span> <span class="nx">db</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="err">==</span> <span class="nx">env_name</span>
            <span class="p">]</span><span class="err">)</span>
            
            <span class="nx">data_transfer</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">50</span> <span class="err">:</span> <span class="mi">10</span>  <span class="c1"># Estimated monthly data transfer cost</span>
          <span class="p">}</span>
          
          <span class="nx">optimization_recommendations</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">rightsizing</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">instance_type</span> <span class="p">==</span> <span class="s2">"t3.micro"</span> <span class="err">&amp;&amp;</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> 
                         <span class="s2">"Consider upgrading to a larger instance type for production workloads"</span> <span class="err">:</span> <span class="kc">null</span>
            
            <span class="nx">reserved_instances</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> 
                               <span class="s2">"Consider purchasing Reserved Instances for cost savings"</span> <span class="err">:</span> <span class="kc">null</span>
            
            <span class="nx">spot_instances</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"production"</span> <span class="err">?</span> 
                           <span class="s2">"Consider using Spot Instances for development/testing"</span> <span class="err">:</span> <span class="kc">null</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1"># Global summary</span>
    <span class="nx">summary</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">total_environments</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span><span class="err">)</span>
      <span class="nx">total_vpcs</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">aws_vpc</span><span class="err">.</span><span class="nx">environment</span><span class="err">)</span>
      <span class="nx">total_subnets</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">public</span><span class="err">)</span> <span class="err">+</span> <span class="nx">length</span><span class="err">(</span><span class="nx">aws_subnet</span><span class="err">.</span><span class="nx">private</span><span class="err">)</span>
      <span class="nx">total_instances_capacity</span> <span class="p">=</span> <span class="nx">sum</span><span class="err">(</span><span class="p">[</span>
        <span class="nx">for</span> <span class="nx">asg</span> <span class="nx">in</span> <span class="nx">aws_autoscaling_group</span><span class="err">.</span><span class="nx">application</span> <span class="err">:</span> <span class="nx">asg</span><span class="err">.</span><span class="nx">desired_capacity</span>
      <span class="p">]</span><span class="err">)</span>
      
      <span class="c1"># Security summary</span>
      <span class="nx">security_groups</span> <span class="p">=</span> <span class="nx">length</span><span class="err">(</span><span class="nx">aws_security_group</span><span class="err">.</span><span class="nx">application</span><span class="err">)</span>
      
      <span class="c1"># Cost summary</span>
      <span class="nx">estimated_monthly_cost</span> <span class="p">=</span> <span class="nx">sum</span><span class="err">(</span><span class="p">[</span>
        <span class="nx">for</span> <span class="nx">env</span> <span class="nx">in</span> <span class="nx">values</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span><span class="err">)</span> <span class="err">:</span> <span class="err">(</span>
          <span class="nx">env</span><span class="err">.</span><span class="nx">min_instances</span> <span class="err">*</span> <span class="nx">lookup</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">instance_costs</span><span class="p">,</span> <span class="nx">env</span><span class="err">.</span><span class="nx">instance_type</span><span class="p">,</span> <span class="mi">100</span><span class="err">)</span> <span class="err">*</span> <span class="mi">24</span> <span class="err">*</span> <span class="mi">30</span>
        <span class="err">)</span>
      <span class="p">]</span><span class="err">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service-specific outputs</span>
<span class="nx">output</span> <span class="s2">"service_endpoints"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Service endpoints for each environment"</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span> <span class="err">:</span> <span class="nx">env_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">for</span> <span class="nx">service_name</span><span class="err">,</span> <span class="nx">service_config</span> <span class="nx">in</span> <span class="nx">var</span><span class="err">.</span><span class="nx">services</span> <span class="err">:</span> <span class="nx">service_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
        <span class="nx">internal_endpoint</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"http://%s.%s.internal:%d"</span><span class="err">,</span>
          <span class="nx">service_name</span><span class="err">,</span>
          <span class="nx">env_name</span><span class="err">,</span>
          <span class="nx">service_config</span><span class="err">.</span><span class="nx">port</span>
        <span class="err">)</span>
        
        <span class="nx">external_endpoint</span> <span class="p">=</span> <span class="nx">env_config</span><span class="err">.</span><span class="nx">load_balancer</span><span class="err">.</span><span class="nx">internal</span> <span class="err">?</span> <span class="kc">null</span> <span class="err">:</span> <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"https://%s.%s.%s"</span><span class="err">,</span>
          <span class="nx">service_name</span><span class="err">,</span>
          <span class="nx">env_name</span><span class="err">,</span>
          <span class="nx">var</span><span class="err">.</span><span class="nx">domain_name</span>
        <span class="err">)</span>
        
        <span class="nx">load_balancer_dns</span> <span class="p">=</span> <span class="nx">try</span><span class="err">(</span>
          <span class="nx">aws_lb</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s"</span><span class="p">,</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">service_name</span><span class="err">)</span><span class="p">]</span><span class="err">.</span><span class="nx">dns_name</span><span class="err">,</span>
          <span class="kc">null</span>
        <span class="err">)</span>
        
        <span class="nx">health_check_url</span> <span class="p">=</span> <span class="nx">format</span><span class="err">(</span>
          <span class="s2">"http://%s%s"</span><span class="err">,</span>
          <span class="nx">try</span><span class="err">(</span><span class="nx">aws_lb</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">format</span><span class="err">(</span><span class="s2">"%s-%s"</span><span class="p">,</span> <span class="nx">env_name</span><span class="p">,</span> <span class="nx">service_name</span><span class="err">)</span><span class="p">]</span><span class="err">.</span><span class="nx">dns_name</span><span class="err">,</span> <span class="s2">"localhost"</span><span class="err">),</span>
          <span class="nx">service_config</span><span class="err">.</span><span class="nx">health_check_path</span>
        <span class="err">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Secrets and configuration outputs</span>
<span class="nx">output</span> <span class="s2">"configuration_templates"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Configuration templates for applications"</span>
  <span class="nx">sensitive</span>   <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">for</span> <span class="nx">env_name</span><span class="err">,</span> <span class="nx">env_config</span> <span class="nx">in</span> <span class="nx">local</span><span class="err">.</span><span class="nx">environment_config</span> <span class="err">:</span> <span class="nx">env_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
      <span class="nx">database_configs</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">for</span> <span class="nx">db_name</span><span class="err">,</span> <span class="nx">db</span> <span class="nx">in</span> <span class="nx">aws_db_instance</span><span class="err">.</span><span class="nx">application</span> <span class="err">:</span> <span class="nx">db_name</span> <span class="p">=</span><span class="err">&gt;</span> <span class="p">{</span>
          <span class="nx">host</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">endpoint</span>
          <span class="nx">port</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">port</span>
          <span class="nx">database</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">db_name</span>
          <span class="nx">username</span> <span class="p">=</span> <span class="nx">db</span><span class="err">.</span><span class="nx">username</span>
          <span class="c1"># Note: Password would be retrieved from AWS Secrets Manager</span>
          <span class="nx">password_secret_arn</span> <span class="p">=</span> <span class="nx">aws_secretsmanager_secret</span><span class="err">.</span><span class="nx">db_password</span><span class="p">[</span><span class="nx">db_name</span><span class="p">]</span><span class="err">.</span><span class="nx">arn</span>
          
          <span class="c1"># Connection pool settings</span>
          <span class="nx">connection_pool</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">min_connections</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">5</span> <span class="err">:</span> <span class="mi">2</span>
            <span class="nx">max_connections</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="mi">20</span> <span class="err">:</span> <span class="mi">10</span>
            <span class="nx">idle_timeout</span> <span class="p">=</span> <span class="mi">300</span>
            <span class="nx">max_lifetime</span> <span class="p">=</span> <span class="mi">1800</span>
          <span class="p">}</span>
          
          <span class="c1"># SSL configuration</span>
          <span class="nx">ssl_mode</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"require"</span> <span class="err">:</span> <span class="s2">"prefer"</span>
          <span class="nx">ssl_cert_path</span> <span class="p">=</span> <span class="s2">"/opt/certs/rds-ca-2019-root.pem"</span>
        <span class="p">}</span>
        <span class="nx">if</span> <span class="nx">db</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">Environment</span> <span class="p">==</span> <span class="nx">env_name</span>
      <span class="p">}</span>
      
      <span class="c1"># Environment variables for applications</span>
      <span class="nx">environment_variables</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">AWS_REGION</span> <span class="p">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_region</span><span class="err">.</span><span class="nx">current</span><span class="err">.</span><span class="nx">name</span>
        <span class="nx">ENVIRONMENT</span> <span class="p">=</span> <span class="nx">env_name</span>
        <span class="nx">PROJECT_NAME</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">project_name</span>
        
        <span class="c1"># Service discovery endpoints</span>
        <span class="nx">SERVICE_DISCOVERY_NAMESPACE</span> <span class="p">=</span> <span class="nx">try</span><span class="err">(</span>
          <span class="nx">aws_service_discovery_http_namespace</span><span class="err">.</span><span class="nx">environment</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">name</span><span class="err">,</span>
          <span class="kc">null</span>
        <span class="err">)</span>
        
        <span class="c1"># Monitoring and logging</span>
        <span class="nx">CLOUDWATCH_LOG_GROUP</span> <span class="p">=</span> <span class="nx">try</span><span class="err">(</span>
          <span class="nx">aws_cloudwatch_log_group</span><span class="err">.</span><span class="nx">application</span><span class="p">[</span><span class="nx">env_name</span><span class="p">]</span><span class="err">.</span><span class="nx">name</span><span class="err">,</span>
          <span class="kc">null</span>
        <span class="err">)</span>
        
        <span class="c1"># Feature flags based on environment</span>
        <span class="nx">ENABLE_DEBUG_LOGGING</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="err">!</span><span class="p">=</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"true"</span> <span class="err">:</span> <span class="s2">"false"</span>
        <span class="nx">ENABLE_PERFORMANCE_MONITORING</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"true"</span> <span class="err">:</span> <span class="s2">"false"</span>
        <span class="nx">CACHE_TTL</span> <span class="p">=</span> <span class="nx">env_name</span> <span class="p">==</span> <span class="s2">"production"</span> <span class="err">?</span> <span class="s2">"3600"</span> <span class="err">:</span> <span class="s2">"300"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>Advanced Terraform functions and expressions represent the <strong>cornerstone of sophisticated Infrastructure as Code implementations</strong>.</p>

<blockquote>
  <p>Mastering these concepts enables infrastructure engineers to build <strong>self-adapting, maintainable, and scalable infrastructure solutions</strong> that respond dynamically to changing requirements and environments.</p>
</blockquote>

<p><br /></p>

<h3 id="key-mastery-areas">Key Mastery Areas:</h3>

<ol>
  <li><strong>Function Composition</strong>: Combining multiple functions for complex data transformations</li>
  <li><strong>Conditional Logic</strong>: Building intelligent infrastructure that adapts to context</li>
  <li><strong>Dynamic Generation</strong>: Creating resources programmatically based on input data</li>
  <li><strong>Type Safety</strong>: Leveraging Terraform’s type system for robust configurations</li>
  <li><strong>Performance Optimization</strong>: Efficient data processing and resource creation patterns</li>
</ol>

<p><br /></p>

<h3 id="operational-excellence">Operational Excellence:</h3>

<ul>
  <li><strong>Reduced Code Duplication</strong>: DRY principles through advanced function usage</li>
  <li><strong>Enhanced Maintainability</strong>: Self-documenting configurations with clear logic</li>
  <li><strong>Improved Scalability</strong>: Infrastructure that adapts to growth automatically</li>
  <li><strong>Better Testing</strong>: Predictable behavior through pure function compositions</li>
  <li><strong>Team Productivity</strong>: Reusable patterns that accelerate development</li>
</ul>

<h4 id="advanced-implementation-strategies">Advanced Implementation Strategies:</h4>
<ul>
  <li>Develop comprehensive function libraries for common transformation patterns</li>
  <li>Implement policy-as-code using advanced conditional expressions</li>
  <li>Create self-healing infrastructure through dynamic block generation</li>
  <li>Establish infrastructure testing frameworks leveraging Terraform’s type system</li>
  <li>Build sophisticated multi-environment deployment pipelines with advanced expressions</li>
</ul>

<p><br /></p>

<p>The combination of <strong>advanced functions, sophisticated expressions, and dynamic blocks</strong> elevates Terraform from a basic provisioning tool to a <strong>comprehensive infrastructure programming platform</strong>. These capabilities enable the creation of <strong>intelligent, adaptive infrastructure</strong> that scales with organizational needs while maintaining consistency and reliability.</p>

<blockquote>
  <p><em>“Advanced Terraform mastery transforms infrastructure management from reactive maintenance to proactive, intelligent automation that anticipates and adapts to changing requirements.”</em></p>
</blockquote>

<p><br /></p>

<hr />

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.terraform.io/docs/language/functions/index.html">Terraform Functions Documentation</a></li>
  <li><a href="https://www.terraform.io/docs/language/expressions/index.html">HCL Expressions Guide</a></li>
  <li><a href="https://www.terraform.io/docs/language/expressions/dynamic-blocks.html">Dynamic Blocks Documentation</a></li>
  <li><a href="https://www.terraform.io/docs/language/expressions/type-constraints.html">Type Constraints Reference</a></li>
  <li><a href="https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html">Terraform Best Practices</a></li>
  <li><a href="https://www.terraform.io/docs/language/modules/develop/composition.html">Advanced Terraform Patterns</a></li>
  <li><a href="https://registry.terraform.io/browse/modules">Community Function Examples</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/virtualization/cockpit/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755592289/cockpit-1_t5ufcx.png">
                                    
                                    <h3>KVM and Cockpit Complete Virtualization Setup Guide</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/ai/google-ai-pro/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1767584255/google-ai-pro-1_blexkb.png">
                                    
                                    <h3>Google AI Pro: The Ultimate AI Service That Changes Everything</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/container/imagetools-skopeo/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755592919/skopeo-imagetools-1_gkb6aa.png">
                                    
                                    <h3>Docker Image Copy Automation - buildx imagetools vs skopeo Practical Comparison</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="74">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/network/kvm-qemu-networking-deep-dive/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1755067055/kvm-qemu-networking_d9wsnp.png">
                
            </div>
            <h3 class="title">KVM/QEMU Networking Deep Dive - Complete Guide to Virtualization Networking</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Comprehensive guide to advanced Terraform functions, conditional expressions, for loops, dynamic blocks, and complex data transformations for enterprise-grade infrastructure as code.&quot;%20https://somaz.blog/category/iac/terraform-advance/%20via%20&#64;twitter_username&hashtags=terraform,hashicorp,functions,expressions,dynamic-blocks,hcl,infrastructure-as-code,automation,advanced-terraform,data-transformation"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/iac/terraform-advance/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/iac/terraform-advance/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Advanced Terraform Functions and Expressions: Dynamic Infrastructure Patterns",
            "headline": "Master complex Terraform functions, expressions, and dynamic blocks for sophisticated infrastructure automation",
            "description": "Comprehensive guide to advanced Terraform functions, conditional expressions, for loops, dynamic blocks, and complex data transformations for enterprise-grade infrastructure as code.",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1755142723/terraform-advance_rau5cf.png",
            "url": "https://somaz.blog/category/iac/terraform-advance/",
            "articleBody": "



Overview

As infrastructure complexity grows, Terraform’s advanced functions and expressions become essential for creating sophisticated, maintainable, and scalable Infrastructure as Code solutions.

This comprehensive guide explores the powerful capabilities that distinguish basic Terraform usage from enterprise-grade implementations.

Advanced Terraform programming involves mastering built-in functions, conditional logic, iterative constructs, and dynamic resource generation.

These features enable data transformation, conditional resource creation, and complex infrastructure patterns that adapt to varying requirements and environments.

This guide covers nine categories of Terraform functions, advanced expression patterns, dynamic block construction, and real-world implementation strategies.

We’ll explore how to leverage conditional expressions, for loops, type conversions, and collection manipulations to build flexible, reusable infrastructure modules.

Understanding these advanced concepts enables infrastructure engineers to create self-adapting configurations, reduce code duplication, and implement sophisticated deployment patterns that scale across multiple environments and use cases.





Terraform Functions Overview

Terraform provides over 100 built-in functions organized into nine categories, each serving specific data manipulation and transformation needs in infrastructure configurations.



Function Categories:

# 1. Numeric Functions
abs(-5)                    # Returns: 5
ceil(4.3)                  # Returns: 5
floor(4.7)                 # Returns: 4
max(5, 12, 9)             # Returns: 12
min(5, 12, 9)             # Returns: 5

# 2. String Functions
upper(&quot;hello&quot;)             # Returns: &quot;HELLO&quot;
lower(&quot;WORLD&quot;)             # Returns: &quot;world&quot;
title(&quot;hello world&quot;)       # Returns: &quot;Hello World&quot;
trim(&quot;  hello  &quot;, &quot; &quot;)     # Returns: &quot;hello&quot;
replace(&quot;hello&quot;, &quot;l&quot;, &quot;x&quot;) # Returns: &quot;hexxo&quot;

# 3. Collection Functions
length([1, 2, 3])          # Returns: 3
concat([1, 2], [3, 4])     # Returns: [1, 2, 3, 4]
distinct([1, 2, 2, 3])     # Returns: [1, 2, 3]
sort([&quot;c&quot;, &quot;a&quot;, &quot;b&quot;])      # Returns: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]

# 4. Encoding Functions
base64encode(&quot;hello&quot;)      # Returns: &quot;aGVsbG8=&quot;
base64decode(&quot;aGVsbG8=&quot;)   # Returns: &quot;hello&quot;
jsonencode({a = &quot;b&quot;})      # Returns: &quot;{\&quot;a\&quot;:\&quot;b\&quot;}&quot;

# 5. Filesystem Functions
file(&quot;path/to/file.txt&quot;)   # Returns: file contents
filebase64(&quot;image.png&quot;)    # Returns: base64 encoded file
dirname(&quot;/path/to/file&quot;)   # Returns: &quot;/path/to&quot;
basename(&quot;/path/to/file&quot;)  # Returns: &quot;file&quot;

# 6. Date and Time Functions
timestamp()                # Returns: current timestamp
formatdate(&quot;YYYY-MM-DD&quot;, timestamp())
timeadd(timestamp(), &quot;24h&quot;)

# 7. Hash and Crypto Functions
md5(&quot;hello&quot;)              # Returns: MD5 hash
sha256(&quot;hello&quot;)           # Returns: SHA256 hash
uuid()                    # Returns: random UUID

# 8. IP Network Functions
cidrhost(&quot;10.0.0.0/8&quot;, 2) # Returns: &quot;10.0.0.2&quot;
cidrnetmask(&quot;10.0.0.0/8&quot;) # Returns: &quot;255.0.0.0&quot;
cidrsubnet(&quot;10.0.0.0/8&quot;, 8, 2) # Returns: &quot;10.2.0.0/16&quot;

# 9. Type Conversion Functions
tostring(42)              # Returns: &quot;42&quot;
tonumber(&quot;42&quot;)            # Returns: 42
tolist(toset([1, 2, 2]))  # Returns: [1, 2]






Advanced Collection Functions



1. coalesce - Null Value Handling

The coalesce function returns the first non-null, non-empty value from a sequence of arguments, making it essential for providing fallback values and handling optional configurations.

# Advanced coalesce patterns
locals {
  # Environment-based resource naming with fallbacks
  environment = coalesce(var.environment, &quot;development&quot;)
  
  # Multi-level fallback for database configuration
  db_instance_class = coalesce(
    var.db_instance_class,
    local.environment_defaults[var.environment],
    &quot;db.t3.micro&quot;
  )
  
  # Complex subnet group naming with multiple fallbacks
  db_subnet_group_name = coalesce(
    var.db_subnet_group_name,
    format(&quot;%s-%s-db-subnet-group&quot;, var.project_name, local.environment),
    &quot;default-db-subnet-group&quot;
  )
  
  # API endpoint configuration with environment-specific defaults
  api_endpoint = coalesce(
    var.custom_api_endpoint,
    local.environment_config[local.environment].api_endpoint,
    &quot;https://api.${var.domain_name}&quot;
  )
}

# Usage in resource configuration
resource &quot;aws_db_subnet_group&quot; &quot;main&quot; {
  name       = local.db_subnet_group_name
  subnet_ids = var.subnet_ids

  tags = {
    Name        = local.db_subnet_group_name
    Environment = local.environment
    ManagedBy   = &quot;terraform&quot;
  }
}




2. merge - Complex Object Composition

The merge function combines multiple maps or objects, with later arguments taking precedence over earlier ones for duplicate keys.

# Advanced merge patterns for tag management
locals {
  # Base tags applied to all resources
  base_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = &quot;terraform&quot;
    CreatedAt   = formatdate(&quot;YYYY-MM-DD&quot;, timestamp())
  }
  
  # Environment-specific tags
  environment_tags = {
    development = {
      AutoShutdown = &quot;true&quot;
      CostCenter   = &quot;development&quot;
      Backup       = &quot;weekly&quot;
    }
    staging = {
      AutoShutdown = &quot;false&quot;
      CostCenter   = &quot;qa&quot;
      Backup       = &quot;daily&quot;
    }
    production = {
      AutoShutdown = &quot;false&quot;
      CostCenter   = &quot;operations&quot;
      Backup       = &quot;hourly&quot;
      Compliance   = &quot;required&quot;
    }
  }
  
  # Compliance tags for sensitive resources
  compliance_tags = var.enable_compliance ? {
    DataClassification = &quot;sensitive&quot;
    ComplianceScope    = &quot;SOC2&quot;
    BackupRequired     = &quot;true&quot;
    EncryptionRequired = &quot;true&quot;
  } : {}
  
  # Final tag composition with precedence
  resource_tags = merge(
    local.base_tags,
    lookup(local.environment_tags, var.environment, {}),
    local.compliance_tags,
    var.additional_tags
  )
  
  # Database-specific tag merging
  database_tags = merge(
    local.resource_tags,
    {
      ResourceType = &quot;database&quot;
      BackupWindow = &quot;03:00-04:00&quot;
      MaintenanceWindow = &quot;Mon:04:00-Mon:05:00&quot;
    }
  )
}

# Advanced configuration merging
locals {
  # Default monitoring configuration
  default_monitoring = {
    enabled                = true
    detailed_monitoring    = false
    cpu_alarm_threshold    = 80
    memory_alarm_threshold = 85
    disk_alarm_threshold   = 90
  }
  
  # Environment-specific monitoring overrides
  environment_monitoring = {
    production = {
      detailed_monitoring    = true
      cpu_alarm_threshold    = 70
      memory_alarm_threshold = 75
      enable_custom_metrics  = true
    }
    staging = {
      cpu_alarm_threshold = 85
      enable_testing_metrics = true
    }
  }
  
  # Final monitoring configuration
  monitoring_config = merge(
    local.default_monitoring,
    lookup(local.environment_monitoring, var.environment, {}),
    var.custom_monitoring_config
  )
}




3. lookup and element - Advanced Data Access

# Advanced lookup patterns with complex defaults
locals {
  # Instance type mapping with environment-based defaults
  instance_types = {
    development = &quot;t3.micro&quot;
    staging     = &quot;t3.small&quot;
    production  = &quot;c5.large&quot;
  }
  
  # Complex lookup with computed defaults
  instance_type = lookup(
    local.instance_types,
    var.environment,
    var.high_performance ? &quot;c5.xlarge&quot; : &quot;t3.medium&quot;
  )
  
  # Multi-level configuration lookup
  availability_zones = lookup(
    var.region_config,
    var.aws_region,
    {
      azs = data.aws_availability_zones.available.names
      preferred_azs = slice(data.aws_availability_zones.available.names, 0, 2)
    }
  ).preferred_azs
  
  # Advanced element usage with modulo for round-robin distribution
  subnet_distribution = [
    for i, instance in var.instances : {
      instance_id = instance.id
      subnet_id   = element(var.subnet_ids, i % length(var.subnet_ids))
      az         = element(local.availability_zones, i % length(local.availability_zones))
    }
  ]
}

# Complex lookup for security group rules
locals {
  # Security group rule templates
  security_rules = {
    web = [
      {
        type        = &quot;ingress&quot;
        from_port   = 80
        to_port     = 80
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
      },
      {
        type        = &quot;ingress&quot;
        from_port   = 443
        to_port     = 443
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
      }
    ]
    api = [
      {
        type        = &quot;ingress&quot;
        from_port   = 8080
        to_port     = 8080
        protocol    = &quot;tcp&quot;
        cidr_blocks = var.api_allowed_cidrs
      }
    ]
    database = [
      {
        type                     = &quot;ingress&quot;
        from_port               = 5432
        to_port                 = 5432
        protocol                = &quot;tcp&quot;
        source_security_group_id = aws_security_group.app.id
      }
    ]
  }
  
  # Dynamic rule selection based on service type
  selected_rules = lookup(local.security_rules, var.service_type, [])
}






Advanced String Functions



1. format - Dynamic String Construction

# Advanced format patterns for resource naming
locals {
  # Hierarchical naming convention
  resource_name_template = &quot;%s-%s-%s-%s&quot;
  
  # Generate consistent resource names
  vpc_name = format(
    local.resource_name_template,
    var.organization,
    var.environment,
    var.project_name,
    &quot;vpc&quot;
  )
  
  subnet_names = [
    for i, az in local.availability_zones : format(
      &quot;%s-%s-%s-subnet-%s&quot;,
      var.organization,
      var.environment,
      var.project_name,
      substr(az, -1, 1)  # Use last character of AZ
    )
  ]
  
  # Complex formatting with conditional elements
  instance_name = format(
    &quot;%s-%s%s&quot;,
    local.base_name,
    var.instance_role,
    var.enable_high_availability ? &quot;-ha&quot; : &quot;&quot;
  )
  
  # URL construction with multiple variables
  database_connection_string = format(
    &quot;postgresql://%s:%s@%s:%d/%s?sslmode=%s&quot;,
    var.db_username,
    var.db_password,
    aws_db_instance.main.endpoint,
    aws_db_instance.main.port,
    var.db_name,
    var.enable_ssl ? &quot;require&quot; : &quot;disable&quot;
  )
}

# Advanced format usage in outputs
output &quot;service_endpoints&quot; {
  value = {
    for service, config in var.services : service =&amp;gt; {
      internal_url = format(
        &quot;https://%s.%s.local:%d&quot;,
        service,
        var.environment,
        config.port
      )
      external_url = format(
        &quot;https://%s.%s.%s&quot;,
        service,
        var.environment,
        var.domain_name
      )
      health_check = format(
        &quot;%s/health&quot;,
        format(
          &quot;https://%s.%s.%s&quot;,
          service,
          var.environment,
          var.domain_name
        )
      )
    }
  }
}




2. substr and String Manipulation

# Advanced string manipulation patterns
locals {
  # Extract components from complex identifiers
  account_id = substr(data.aws_caller_identity.current.arn, 13, 12)
  
  # Create short identifiers for resource naming
  short_project = substr(replace(lower(var.project_name), &quot;-&quot;, &quot;&quot;), 0, 8)
  short_env     = substr(var.environment, 0, 3)
  
  # Generate unique identifiers with length constraints
  unique_suffix = substr(uuid(), 0, 8)
  bucket_name = format(
    &quot;%s-%s-%s&quot;,
    local.short_project,
    local.short_env,
    local.unique_suffix
  )
  
  # Extract and validate AMI ID format
  is_valid_ami = length(var.ami_id) &amp;gt; 4 &amp;amp;&amp;amp; substr(var.ami_id, 0, 4) == &quot;ami-&quot;
  
  # Process and clean input strings
  sanitized_name = replace(
    replace(
      lower(var.user_input),
      &quot;/[^a-z0-9-]/&quot;, 
      &quot;-&quot;
    ),
    &quot;/--+/&quot;,
    &quot;-&quot;
  )
  
  # Extract domain components
  domain_parts = split(&quot;.&quot;, var.domain_name)
  subdomain    = length(local.domain_parts) &amp;gt; 2 ? local.domain_parts[0] : &quot;&quot;
  root_domain  = join(&quot;.&quot;, slice(local.domain_parts, -2, length(local.domain_parts)))
}

# Advanced validation using string functions
variable &quot;ami_id&quot; {
  type        = string
  description = &quot;The AMI ID to use for instances&quot;
  
  validation {
    condition = (
      length(var.ami_id) &amp;gt; 4 &amp;amp;&amp;amp; 
      substr(var.ami_id, 0, 4) == &quot;ami-&quot; &amp;amp;&amp;amp;
      can(regex(&quot;^ami-[0-9a-f]{8}([0-9a-f]{9})?$&quot;, var.ami_id))
    )
    error_message = &quot;AMI ID must be a valid format (ami-xxxxxxxx or ami-xxxxxxxxxxxxxxxxx).&quot;
  }
}

variable &quot;instance_name&quot; {
  type        = string
  description = &quot;Name for the instance&quot;
  
  validation {
    condition = (
      length(var.instance_name) &amp;gt;= 3 &amp;amp;&amp;amp;
      length(var.instance_name) &amp;lt;= 63 &amp;amp;&amp;amp;
      can(regex(&quot;^[a-z][a-z0-9-]*[a-z0-9]$&quot;, var.instance_name))
    )
    error_message = &quot;Instance name must be 3-63 characters, start with a letter, and contain only lowercase letters, numbers, and hyphens.&quot;
  }
}






Types and Values - Advanced Patterns



1. Complex Type Definitions

# Advanced type constraints and validations
variable &quot;application_config&quot; {
  type = object({
    name         = string
    version      = string
    port         = number
    health_check = object({
      enabled  = bool
      path     = string
      interval = number
      timeout  = number
    })
    scaling = object({
      min_instances = number
      max_instances = number
      target_cpu    = number
    })
    environment_variables = map(string)
    secrets              = map(string)
    dependencies         = list(string)
    feature_flags        = map(bool)
  })
  
  description = &quot;Complete application configuration&quot;
  
  validation {
    condition     = var.application_config.port &amp;gt; 1024 &amp;amp;&amp;amp; var.application_config.port &amp;lt; 65536
    error_message = &quot;Application port must be between 1024 and 65535.&quot;
  }
  
  validation {
    condition = (
      var.application_config.scaling.min_instances &amp;lt;= var.application_config.scaling.max_instances &amp;amp;&amp;amp;
      var.application_config.scaling.min_instances &amp;gt;= 1
    )
    error_message = &quot;Min instances must be at least 1 and not exceed max instances.&quot;
  }
}

# Complex tuple definitions for multi-environment configurations
variable &quot;environments&quot; {
  type = list(object({
    name = string
    config = object({
      instance_type    = string
      instance_count   = number
      auto_scaling     = bool
      backup_retention = number
    })
    networking = object({
      vpc_cidr           = string
      availability_zones = list(string)
      enable_nat_gateway = bool
    })
    monitoring = object({
      detailed_monitoring = bool
      custom_metrics     = bool
      log_retention_days = number
    })
  }))
  
  description = &quot;Multi-environment configuration&quot;
  
  validation {
    condition     = length(var.environments) &amp;gt; 0
    error_message = &quot;At least one environment must be defined.&quot;
  }
  
  validation {
    condition = alltrue([
      for env in var.environments : can(cidrhost(env.networking.vpc_cidr, 0))
    ])
    error_message = &quot;All VPC CIDR blocks must be valid.&quot;
  }
}

# Dynamic type handling with any
variable &quot;resource_configs&quot; {
  type        = map(any)
  description = &quot;Flexible resource configurations&quot;
  
  validation {
    condition = alltrue([
      for k, v in var.resource_configs : contains([&quot;string&quot;, &quot;number&quot;, &quot;bool&quot;, &quot;list&quot;, &quot;map&quot;], type(v))
    ])
    error_message = &quot;Resource configs must contain basic types only.&quot;
  }
}




2. Advanced List and Map Operations

# Complex list and map transformations
locals {
  # Flatten nested structures
  all_subnets = flatten([
    for env_name, env_config in var.environments : [
      for az_index, az in env_config.networking.availability_zones : {
        environment = env_name
        az          = az
        cidr        = cidrsubnet(env_config.networking.vpc_cidr, 8, az_index)
        type        = az_index &amp;lt; 2 ? &quot;public&quot; : &quot;private&quot;
      }
    ]
  ])
  
  # Group subnets by type
  subnets_by_type = {
    for subnet in local.all_subnets : subnet.type =&amp;gt; subnet...
  }
  
  # Create complex mappings
  instance_configs = {
    for env in var.environments : env.name =&amp;gt; {
      instances = [
        for i in range(env.config.instance_count) : {
          name      = format(&quot;%s-%s-%02d&quot;, var.project_name, env.name, i + 1)
          subnet_id = local.subnets_by_type.private[i % length(local.subnets_by_type.private)].cidr
          az        = local.subnets_by_type.private[i % length(local.subnets_by_type.private)].az
        }
      ]
      total_cost_estimate = env.config.instance_count * lookup(local.instance_costs, env.config.instance_type, 100)
    }
  }
  
  # Advanced filtering and transformation
  production_instances = [
    for env_name, env_config in local.instance_configs : env_config.instances...
    if env_name == &quot;production&quot;
  ]
  
  # Conditional list construction
  monitoring_targets = concat(
    [for inst in local.production_instances : inst.name],
    var.enable_staging_monitoring ? [
      for env_name, env_config in local.instance_configs : env_config.instances[*].name...
      if env_name == &quot;staging&quot;
    ] : []
  )
}






Conditional Expressions - Advanced Patterns



1. Complex Conditional Logic

# Multi-level conditional expressions
locals {
  # Environment-based configuration selection
  instance_type = (
    var.environment == &quot;production&quot; ? (
      var.high_performance ? &quot;c5.2xlarge&quot; : &quot;m5.xlarge&quot;
    ) : var.environment == &quot;staging&quot; ? (
      var.enable_testing ? &quot;m5.large&quot; : &quot;t3.medium&quot;
    ) : &quot;t3.micro&quot;
  )
  
  # Complex backup configuration
  backup_config = var.enable_backups ? {
    retention_period = var.environment == &quot;production&quot; ? 30 : 7
    backup_window   = var.environment == &quot;production&quot; ? &quot;03:00-04:00&quot; : &quot;02:00-03:00&quot;
    copy_tags_to_snapshot = true
    delete_automated_backups = var.environment != &quot;production&quot;
  } : null
  
  # Conditional resource creation parameters
  create_monitoring = var.enable_monitoring &amp;amp;&amp;amp; (
    var.environment == &quot;production&quot; || 
    (var.environment == &quot;staging&quot; &amp;amp;&amp;amp; var.enable_staging_monitoring)
  )
  
  # Network configuration based on environment
  network_config = {
    enable_nat_gateway = var.environment == &quot;production&quot; ? true : var.cost_optimization ? false : true
    enable_vpn_gateway = var.environment == &quot;production&quot; &amp;amp;&amp;amp; var.enable_hybrid_connectivity
    flow_logs_enabled  = var.environment != &quot;development&quot; &amp;amp;&amp;amp; var.enable_compliance
    
    # Conditional CIDR allocation
    vpc_cidr = (
      var.custom_vpc_cidr != null ? var.custom_vpc_cidr : 
      var.environment == &quot;production&quot; ? &quot;10.0.0.0/16&quot; :
      var.environment == &quot;staging&quot; ? &quot;10.1.0.0/16&quot; : &quot;10.2.0.0/16&quot;
    )
  }
}

# Advanced conditional resource configuration
resource &quot;aws_instance&quot; &quot;web&quot; {
  count = var.enable_web_tier ? var.web_instance_count : 0
  
  ami           = local.is_valid_ami ? var.ami_id : data.aws_ami.default.id
  instance_type = local.instance_type
  
  # Conditional block inclusion
  dynamic &quot;ebs_block_device&quot; {
    for_each = var.enable_additional_storage ? [1] : []
    
    content {
      device_name = &quot;/dev/sdf&quot;
      volume_size = var.environment == &quot;production&quot; ? 100 : 50
      volume_type = var.environment == &quot;production&quot; ? &quot;gp3&quot; : &quot;gp2&quot;
      encrypted   = var.environment != &quot;development&quot;
    }
  }
  
  user_data = var.custom_user_data != null ? var.custom_user_data : (
    var.enable_automatic_updates ? 
    file(&quot;${path.module}/scripts/auto-update.sh&quot;) : 
    file(&quot;${path.module}/scripts/basic-setup.sh&quot;)
  )
  
  tags = merge(
    local.base_tags,
    var.enable_cost_tracking ? {
      CostCenter = var.cost_center
      BillingProject = var.billing_project
    } : {},
    var.enable_compliance ? {
      ComplianceScope = &quot;SOC2&quot;
      DataClassification = &quot;internal&quot;
    } : {}
  )
}




2. Validation with Conditional Logic

# Advanced validation using conditional expressions
variable &quot;database_config&quot; {
  type = object({
    engine         = string
    engine_version = string
    instance_class = string
    allocated_storage = number
    multi_az       = bool
    backup_retention_period = number
  })
  
  validation {
    condition = contains([&quot;mysql&quot;, &quot;postgres&quot;, &quot;mariadb&quot;], var.database_config.engine)
    error_message = &quot;Database engine must be one of: mysql, postgres, mariadb.&quot;
  }
  
  validation {
    condition = (
      var.database_config.engine == &quot;mysql&quot; ? 
      can(regex(&quot;^[0-9]+\\.[0-9]+$&quot;, var.database_config.engine_version)) :
      var.database_config.engine == &quot;postgres&quot; ?
      tonumber(split(&quot;.&quot;, var.database_config.engine_version)[0]) &amp;gt;= 12 :
      true
    )
    error_message = &quot;Engine version must be valid for the selected database engine.&quot;
  }
  
  validation {
    condition = (
      var.database_config.backup_retention_period &amp;gt;= 0 &amp;amp;&amp;amp;
      var.database_config.backup_retention_period &amp;lt;= (
        var.database_config.multi_az ? 35 : 7
      )
    )
    error_message = &quot;Backup retention period must be 0-35 days for Multi-AZ, 0-7 days for single-AZ.&quot;
  }
}

# Complex environment-based validation
variable &quot;scaling_config&quot; {
  type = object({
    min_size         = number
    max_size         = number
    desired_capacity = number
    environment      = string
  })
  
  validation {
    condition = (
      var.scaling_config.min_size &amp;lt;= var.scaling_config.desired_capacity &amp;amp;&amp;amp;
      var.scaling_config.desired_capacity &amp;lt;= var.scaling_config.max_size
    )
    error_message = &quot;Scaling configuration must satisfy: min_size ≤ desired_capacity ≤ max_size.&quot;
  }
  
  validation {
    condition = (
      var.scaling_config.environment == &quot;production&quot; ?
      var.scaling_config.min_size &amp;gt;= 2 &amp;amp;&amp;amp; var.scaling_config.max_size &amp;lt;= 20 :
      var.scaling_config.environment == &quot;staging&quot; ?
      var.scaling_config.min_size &amp;gt;= 1 &amp;amp;&amp;amp; var.scaling_config.max_size &amp;lt;= 10 :
      var.scaling_config.max_size &amp;lt;= 5
    )
    error_message = &quot;Scaling limits must be appropriate for the environment.&quot;
  }
}






for Expressions - Advanced Iteration



1. Complex Data Transformations

# Advanced for expression patterns
locals {
  # Transform and filter collections simultaneously
  production_databases = {
    for db_name, db_config in var.databases : db_name =&amp;gt; {
      instance_class = db_config.performance_tier == &quot;high&quot; ? &quot;db.r5.xlarge&quot; : &quot;db.t3.medium&quot;
      allocated_storage = db_config.storage_requirements * 2  # Production gets 2x storage
      backup_retention = 30
      multi_az = true
      encrypted = true
      
      # Conditional parameter groups
      parameter_group = db_config.engine == &quot;postgres&quot; ? 
        aws_db_parameter_group.postgres_prod.name : 
        aws_db_parameter_group.mysql_prod.name
        
      # Environment-specific networking
      subnet_group_name = aws_db_subnet_group.production.name
      vpc_security_group_ids = [
        aws_security_group.db_production.id,
        aws_security_group.app_to_db.id
      ]
    }
    if db_config.enabled &amp;amp;&amp;amp; db_config.environment == &quot;production&quot;
  }
  
  # Create complex nested structures
  service_mesh_config = {
    for service_name, service_config in var.microservices : service_name =&amp;gt; {
      # Service discovery configuration
      service_discovery = {
        namespace = aws_service_discovery_http_namespace.main.name
        service_name = format(&quot;%s-%s&quot;, service_name, var.environment)
        health_check_grace_period = service_config.startup_time
      }
      
      # Load balancer target groups
      target_groups = [
        for port in service_config.ports : {
          name = format(&quot;%s-%s-%d&quot;, service_name, var.environment, port)
          port = port
          protocol = service_config.protocol
          health_check_path = service_config.health_check_path
          health_check_interval = service_config.health_check_interval
        }
      ]
      
      # Service dependencies and routing
      dependencies = [
        for dep in service_config.dependencies : {
          service_name = dep
          endpoint = format(&quot;http://%s.%s.local:%d&quot;, 
            dep, 
            var.environment, 
            var.microservices[dep].ports[0]
          )
          timeout = var.microservices[dep].timeout
        }
        if contains(keys(var.microservices), dep)
      ]
      
      # Auto-scaling configuration
      scaling_policies = service_config.auto_scaling ? [
        {
          name = &quot;cpu-scaling&quot;
          target_value = 70
          metric_type = &quot;CPUUtilization&quot;
        },
        {
          name = &quot;memory-scaling&quot;
          target_value = 80
          metric_type = &quot;MemoryUtilization&quot;
        }
      ] : []
    }
  }
  
  # Multi-dimensional data processing
  cross_region_backups = {
    for region in var.backup_regions : region =&amp;gt; {
      for db_name, db_config in local.production_databases : db_name =&amp;gt; {
        source_db_arn = format(
          &quot;arn:aws:rds:%s:%s:db:%s&quot;,
          var.primary_region,
          data.aws_caller_identity.current.account_id,
          db_name
        )
        backup_schedule = format(&quot;%d %d * * %s&quot;, 
          (index(var.backup_regions, region) * 2),  # Stagger backup times
          3,  # 3 AM
          join(&quot;,&quot;, range(7))  # Daily
        )
        retention_days = 14
        encrypted = true
      }
      if db_config.cross_region_backup
    }
  }
}




2. Advanced Filtering and Aggregation

# Complex filtering with multiple conditions
locals {
  # Filter and transform with complex conditions
  eligible_instances = [
    for instance in var.instances : {
      id = instance.id
      name = instance.name
      enhanced_config = {
        monitoring_enabled = true
        backup_enabled = true
        security_group_ids = concat(
          instance.security_group_ids,
          [aws_security_group.enhanced_monitoring.id]
        )
      }
      cost_optimization = {
        rightsizing_recommendation = (
          instance.cpu_utilization &amp;lt; 20 ? &quot;downsize&quot; :
          instance.cpu_utilization &amp;gt; 80 ? &quot;upsize&quot; : &quot;maintain&quot;
        )
        estimated_monthly_cost = lookup(local.instance_costs, instance.type, 0) * 24 * 30
      }
    }
    if (
      instance.environment == &quot;production&quot; &amp;amp;&amp;amp;
      instance.cpu_utilization != null &amp;amp;&amp;amp;
      instance.memory_utilization != null &amp;amp;&amp;amp;
      !instance.marked_for_termination
    )
  ]
  
  # Aggregate data across multiple dimensions
  cost_summary = {
    by_environment = {
      for env in distinct([for inst in var.instances : inst.environment]) : env =&amp;gt; {
        total_instances = length([for inst in var.instances : inst if inst.environment == env])
        total_cost = sum([
          for inst in var.instances : lookup(local.instance_costs, inst.type, 0)
          if inst.environment == env
        ])
        average_utilization = sum([
          for inst in var.instances : inst.cpu_utilization
          if inst.environment == env &amp;amp;&amp;amp; inst.cpu_utilization != null
        ]) / length([
          for inst in var.instances : inst
          if inst.environment == env &amp;amp;&amp;amp; inst.cpu_utilization != null
        ])
      }
    }
    
    by_instance_type = {
      for type in distinct([for inst in var.instances : inst.type]) : type =&amp;gt; {
        count = length([for inst in var.instances : inst if inst.type == type])
        total_cost = length([for inst in var.instances : inst if inst.type == type]) * 
                    lookup(local.instance_costs, type, 0)
        environments = distinct([
          for inst in var.instances : inst.environment if inst.type == type
        ])
      }
    }
  }
  
  # Create security group rules from service definitions
  security_group_rules = flatten([
    for service_name, service_config in var.services : [
      for rule in service_config.security_rules : {
        service_name = service_name
        rule_type = rule.type
        from_port = rule.from_port
        to_port = rule.to_port
        protocol = rule.protocol
        
        # Dynamic source configuration
        cidr_blocks = lookup(rule, &quot;cidr_blocks&quot;, null)
        source_security_group_id = lookup(rule, &quot;source_service&quot;, null) != null ? 
          lookup(local.service_security_groups, rule.source_service, null) : null
        
        # Rule description with context
        description = format(
          &quot;%s - %s traffic for %s service&quot;,
          title(rule.type),
          rule.protocol,
          service_name
        )
      }
    ]
  ])
}






Dynamic Blocks - Advanced Resource Generation



1. Complex Dynamic Block Patterns

# Advanced dynamic block with conditional logic
resource &quot;aws_security_group&quot; &quot;application&quot; {
  name_prefix = format(&quot;%s-%s-&quot;, var.application_name, var.environment)
  vpc_id      = var.vpc_id

  # Dynamic ingress rules with complex conditions
  dynamic &quot;ingress&quot; {
    for_each = {
      for rule in var.security_rules : &quot;${rule.name}-${rule.protocol}-${rule.port}&quot; =&amp;gt; rule
      if rule.type == &quot;ingress&quot; &amp;amp;&amp;amp; (
        var.environment == &quot;production&quot; ? rule.production_approved : true
      )
    }
    
    content {
      description = ingress.value.description
      from_port   = ingress.value.port
      to_port     = ingress.value.port_range != null ? ingress.value.port_range : ingress.value.port
      protocol    = ingress.value.protocol
      
      # Conditional source configuration
      cidr_blocks = ingress.value.source_type == &quot;cidr&quot; ? ingress.value.sources : null
      
      source_security_group_id = (
        ingress.value.source_type == &quot;security_group&quot; ? 
        lookup(local.security_group_map, ingress.value.sources[0], null) : null
      )
      
      # Self-referencing for internal communication
      self = ingress.value.source_type == &quot;self&quot; ? true : null
      
      # Prefix list support for AWS services
      prefix_list_ids = (
        ingress.value.source_type == &quot;prefix_list&quot; ? ingress.value.sources : null
      )
    }
  }

  # Dynamic egress rules with environment-specific filtering
  dynamic &quot;egress&quot; {
    for_each = {
      for rule in var.security_rules : &quot;${rule.name}-${rule.protocol}-${rule.port}&quot; =&amp;gt; rule
      if rule.type == &quot;egress&quot; &amp;amp;&amp;amp; (
        var.restrict_egress ? 
        contains(var.allowed_egress_destinations, rule.destination) : true
      )
    }
    
    content {
      description = egress.value.description
      from_port   = egress.value.port
      to_port     = egress.value.port_range != null ? egress.value.port_range : egress.value.port
      protocol    = egress.value.protocol
      cidr_blocks = egress.value.destinations
    }
  }

  tags = merge(local.common_tags, {
    Name = format(&quot;%s-%s-sg&quot;, var.application_name, var.environment)
  })
}

# Complex ALB listener rules with dynamic blocks
resource &quot;aws_lb_listener&quot; &quot;application&quot; {
  load_balancer_arn = aws_lb.application.arn
  port              = &quot;443&quot;
  protocol          = &quot;HTTPS&quot;
  ssl_policy        = var.ssl_policy
  certificate_arn   = var.certificate_arn

  # Default action
  default_action {
    type             = &quot;forward&quot;
    target_group_arn = aws_lb_target_group.default.arn
  }

  # Dynamic listener rules for path-based routing
  dynamic &quot;default_action&quot; {
    for_each = var.enable_advanced_routing ? [1] : []
    
    content {
      type = &quot;forward&quot;
      
      forward {
        dynamic &quot;target_group&quot; {
          for_each = var.target_groups
          
          content {
            arn    = target_group.value.arn
            weight = target_group.value.weight
          }
        }
        
        stickiness {
          enabled  = var.enable_stickiness
          duration = var.stickiness_duration
        }
      }
    }
  }
}

# Dynamic configuration blocks in ECS service
resource &quot;aws_ecs_service&quot; &quot;application&quot; {
  name            = var.service_name
  cluster         = var.cluster_id
  task_definition = aws_ecs_task_definition.application.arn
  desired_count   = var.desired_count

  # Dynamic load balancer configuration
  dynamic &quot;load_balancer&quot; {
    for_each = var.load_balancers
    
    content {
      target_group_arn = load_balancer.value.target_group_arn
      container_name   = load_balancer.value.container_name
      container_port   = load_balancer.value.container_port
    }
  }

  # Dynamic network configuration
  dynamic &quot;network_configuration&quot; {
    for_each = var.network_mode == &quot;awsvpc&quot; ? [1] : []
    
    content {
      subnets          = var.subnet_ids
      security_groups  = var.security_group_ids
      assign_public_ip = var.assign_public_ip
    }
  }

  # Dynamic service registries for service discovery
  dynamic &quot;service_registries&quot; {
    for_each = var.enable_service_discovery ? [var.service_discovery_config] : []
    
    content {
      registry_arn = service_registries.value.registry_arn
      port         = lookup(service_registries.value, &quot;port&quot;, null)
      
      dynamic &quot;container_name&quot; {
        for_each = lookup(service_registries.value, &quot;container_name&quot;, null) != null ? [1] : []
        
        content {
          container_name = service_registries.value.container_name
        }
      }
    }
  }

  # Dynamic deployment configuration
  dynamic &quot;deployment_configuration&quot; {
    for_each = var.deployment_config != null ? [var.deployment_config] : []
    
    content {
      maximum_percent         = deployment_configuration.value.maximum_percent
      minimum_healthy_percent = deployment_configuration.value.minimum_healthy_percent
      
      dynamic &quot;deployment_circuit_breaker&quot; {
        for_each = lookup(deployment_configuration.value, &quot;circuit_breaker&quot;, null) != null ? [1] : []
        
        content {
          enable   = deployment_configuration.value.circuit_breaker.enable
          rollback = deployment_configuration.value.circuit_breaker.rollback
        }
      }
    }
  }
}




2. Nested Dynamic Blocks with Complex Logic

# Advanced ECS task definition with nested dynamic blocks
resource &quot;aws_ecs_task_definition&quot; &quot;application&quot; {
  family                   = var.task_family
  requires_compatibilities = [&quot;FARGATE&quot;]
  network_mode            = &quot;awsvpc&quot;
  cpu                     = var.cpu
  memory                  = var.memory
  execution_role_arn      = var.execution_role_arn
  task_role_arn           = var.task_role_arn

  container_definitions = jsonencode([
    for container in var.containers : {
      name  = container.name
      image = container.image
      
      # Dynamic port mappings
      portMappings = [
        for port_config in lookup(container, &quot;ports&quot;, []) : {
          containerPort = port_config.container_port
          hostPort      = lookup(port_config, &quot;host_port&quot;, port_config.container_port)
          protocol      = lookup(port_config, &quot;protocol&quot;, &quot;tcp&quot;)
        }
      ]
      
      # Dynamic environment variables with secrets handling
      environment = [
        for env_name, env_value in lookup(container, &quot;environment&quot;, {}) : {
          name  = env_name
          value = env_value
        }
      ]
      
      secrets = [
        for secret_name, secret_arn in lookup(container, &quot;secrets&quot;, {}) : {
          name      = secret_name
          valueFrom = secret_arn
        }
      ]
      
      # Dynamic log configuration
      logConfiguration = lookup(container, &quot;logging&quot;, null) != null ? {
        logDriver = container.logging.driver
        options = merge(
          {
            &quot;awslogs-group&quot;         = aws_cloudwatch_log_group.application.name
            &quot;awslogs-region&quot;        = var.aws_region
            &quot;awslogs-stream-prefix&quot; = container.name
          },
          lookup(container.logging, &quot;options&quot;, {})
        )
      } : null
      
      # Dynamic health check
      healthCheck = lookup(container, &quot;health_check&quot;, null) != null ? {
        command = [
          &quot;CMD-SHELL&quot;,
          container.health_check.command
        ]
        interval = lookup(container.health_check, &quot;interval&quot;, 30)
        timeout  = lookup(container.health_check, &quot;timeout&quot;, 5)
        retries  = lookup(container.health_check, &quot;retries&quot;, 3)
        startPeriod = lookup(container.health_check, &quot;start_period&quot;, 60)
      } : null
      
      # Dynamic mount points
      mountPoints = [
        for mount in lookup(container, &quot;mounts&quot;, []) : {
          sourceVolume  = mount.source_volume
          containerPath = mount.container_path
          readOnly      = lookup(mount, &quot;read_only&quot;, false)
        }
      ]
    }
  ])

  # Dynamic volume definitions
  dynamic &quot;volume&quot; {
    for_each = var.volumes
    
    content {
      name = volume.value.name
      
      dynamic &quot;host&quot; {
        for_each = lookup(volume.value, &quot;host_path&quot;, null) != null ? [1] : []
        
        content {
          source_path = volume.value.host_path
        }
      }
      
      dynamic &quot;efs_volume_configuration&quot; {
        for_each = lookup(volume.value, &quot;efs_config&quot;, null) != null ? [1] : []
        
        content {
          file_system_id     = volume.value.efs_config.file_system_id
          root_directory     = lookup(volume.value.efs_config, &quot;root_directory&quot;, &quot;/&quot;)
          transit_encryption = lookup(volume.value.efs_config, &quot;transit_encryption&quot;, &quot;ENABLED&quot;)
          
          dynamic &quot;authorization_config&quot; {
            for_each = lookup(volume.value.efs_config, &quot;access_point_id&quot;, null) != null ? [1] : []
            
            content {
              access_point_id = volume.value.efs_config.access_point_id
              iam            = lookup(volume.value.efs_config, &quot;use_iam&quot;, &quot;ENABLED&quot;)
            }
          }
        }
      }
    }
  }

  tags = local.common_tags
}

# CloudFront distribution with complex dynamic behaviors
resource &quot;aws_cloudfront_distribution&quot; &quot;application&quot; {
  enabled             = true
  is_ipv6_enabled     = true
  default_root_object = var.default_root_object
  aliases             = var.aliases
  web_acl_id          = var.web_acl_id

  # Dynamic origins with complex configurations
  dynamic &quot;origin&quot; {
    for_each = var.origins
    
    content {
      domain_name = origin.value.domain_name
      origin_id   = origin.value.origin_id
      origin_path = lookup(origin.value, &quot;origin_path&quot;, &quot;&quot;)
      
      dynamic &quot;custom_origin_config&quot; {
        for_each = lookup(origin.value, &quot;custom_origin_config&quot;, null) != null ? [1] : []
        
        content {
          http_port              = lookup(origin.value.custom_origin_config, &quot;http_port&quot;, 80)
          https_port             = lookup(origin.value.custom_origin_config, &quot;https_port&quot;, 443)
          origin_protocol_policy = lookup(origin.value.custom_origin_config, &quot;origin_protocol_policy&quot;, &quot;https-only&quot;)
          origin_ssl_protocols   = lookup(origin.value.custom_origin_config, &quot;origin_ssl_protocols&quot;, [&quot;TLSv1.2&quot;])
          
          origin_read_timeout    = lookup(origin.value.custom_origin_config, &quot;origin_read_timeout&quot;, 30)
          origin_keepalive_timeout = lookup(origin.value.custom_origin_config, &quot;origin_keepalive_timeout&quot;, 5)
        }
      }
      
      dynamic &quot;s3_origin_config&quot; {
        for_each = lookup(origin.value, &quot;s3_origin_config&quot;, null) != null ? [1] : []
        
        content {
          origin_access_identity = origin.value.s3_origin_config.origin_access_identity
        }
      }
      
      dynamic &quot;custom_header&quot; {
        for_each = lookup(origin.value, &quot;custom_headers&quot;, {})
        
        content {
          name  = custom_header.key
          value = custom_header.value
        }
      }
    }
  }

  # Dynamic cache behaviors
  dynamic &quot;ordered_cache_behavior&quot; {
    for_each = var.cache_behaviors
    
    content {
      path_pattern           = ordered_cache_behavior.value.path_pattern
      allowed_methods        = ordered_cache_behavior.value.allowed_methods
      cached_methods         = ordered_cache_behavior.value.cached_methods
      target_origin_id       = ordered_cache_behavior.value.target_origin_id
      compress               = lookup(ordered_cache_behavior.value, &quot;compress&quot;, true)
      viewer_protocol_policy = lookup(ordered_cache_behavior.value, &quot;viewer_protocol_policy&quot;, &quot;redirect-to-https&quot;)
      
      # Dynamic forwarded values
      dynamic &quot;forwarded_values&quot; {
        for_each = lookup(ordered_cache_behavior.value, &quot;forwarded_values&quot;, null) != null ? [1] : []
        
        content {
          query_string = lookup(ordered_cache_behavior.value.forwarded_values, &quot;query_string&quot;, false)
          headers      = lookup(ordered_cache_behavior.value.forwarded_values, &quot;headers&quot;, [])
          
          dynamic &quot;cookies&quot; {
            for_each = lookup(ordered_cache_behavior.value.forwarded_values, &quot;cookies&quot;, null) != null ? [1] : []
            
            content {
              forward           = ordered_cache_behavior.value.forwarded_values.cookies.forward
              whitelisted_names = lookup(ordered_cache_behavior.value.forwarded_values.cookies, &quot;whitelisted_names&quot;, [])
            }
          }
        }
      }
      
      # Dynamic Lambda@Edge functions
      dynamic &quot;lambda_function_association&quot; {
        for_each = lookup(ordered_cache_behavior.value, &quot;lambda_function_associations&quot;, [])
        
        content {
          event_type   = lambda_function_association.value.event_type
          lambda_arn   = lambda_function_association.value.lambda_arn
          include_body = lookup(lambda_function_association.value, &quot;include_body&quot;, false)
        }
      }
    }
  }

  tags = local.common_tags
}






Real-World Implementation Examples



1. Multi-Environment Infrastructure Module

# Complete multi-environment infrastructure module
# modules/multi-env-infrastructure/main.tf

locals {
  # Environment-specific configuration matrix
  environment_config = {
    for env in var.environments : env.name =&amp;gt; {
      # Compute configuration
      instance_type = lookup(env.compute, &quot;instance_type&quot;, &quot;t3.micro&quot;)
      min_instances = lookup(env.compute, &quot;min_instances&quot;, 1)
      max_instances = lookup(env.compute, &quot;max_instances&quot;, 3)
      
      # Network configuration with automatic CIDR calculation
      vpc_cidr = coalesce(
        lookup(env.networking, &quot;vpc_cidr&quot;, null),
        format(&quot;10.%d.0.0/16&quot;, index(var.environments, env) + 10)
      )
      
      # Storage configuration with environment-based defaults
      storage = merge(
        {
          type = &quot;gp3&quot;
          size = 20
          encrypted = true
        },
        lookup(env, &quot;storage&quot;, {})
      )
      
      # Monitoring configuration
      monitoring = merge(
        {
          enabled = env.name != &quot;development&quot;
          detailed = env.name == &quot;production&quot;
          retention_days = env.name == &quot;production&quot; ? 30 : 7
        },
        lookup(env, &quot;monitoring&quot;, {})
      )
      
      # Security configuration
      security = merge(
        {
          enable_waf = env.name == &quot;production&quot;
          enable_shield = env.name == &quot;production&quot;
          ssl_policy = env.name == &quot;production&quot; ? &quot;ELBSecurityPolicy-TLS-1-2-2017-01&quot; : &quot;ELBSecurityPolicy-2016-08&quot;
        },
        lookup(env, &quot;security&quot;, {})
      )
    }
  }
  
  # Generate all infrastructure components
  infrastructure_components = {
    for env_name, env_config in local.environment_config : env_name =&amp;gt; {
      # VPC and networking
      vpc = {
        cidr_block = env_config.vpc_cidr
        availability_zones = slice(data.aws_availability_zones.available.names, 0, 3)
        
        # Dynamic subnet allocation
        public_subnets = [
          for i, az in slice(data.aws_availability_zones.available.names, 0, 3) :
          cidrsubnet(env_config.vpc_cidr, 8, i)
        ]
        
        private_subnets = [
          for i, az in slice(data.aws_availability_zones.available.names, 0, 3) :
          cidrsubnet(env_config.vpc_cidr, 8, i + 10)
        ]
        
        database_subnets = [
          for i, az in slice(data.aws_availability_zones.available.names, 0, 3) :
          cidrsubnet(env_config.vpc_cidr, 8, i + 20)
        ]
      }
      
      # Application Load Balancer configuration
      load_balancer = {
        internal = env_name == &quot;development&quot;
        type = &quot;application&quot;
        
        # Dynamic target groups based on services
        target_groups = {
          for service_name, service_config in var.services : service_name =&amp;gt; {
            port = service_config.port
            protocol = &quot;HTTP&quot;
            health_check = {
              enabled = true
              path = service_config.health_check_path
              matcher = &quot;200&quot;
              interval = 30
              timeout = 5
              healthy_threshold = 2
              unhealthy_threshold = 3
            }
          }
        }
      }
      
      # Auto Scaling Group configuration
      auto_scaling = {
        min_size = env_config.min_instances
        max_size = env_config.max_instances
        desired_capacity = env_config.min_instances
        
        # Dynamic scaling policies
        policies = env_config.monitoring.enabled ? [
          {
            name = &quot;cpu-scale-up&quot;
            scaling_adjustment = 1
            adjustment_type = &quot;ChangeInCapacity&quot;
            cooldown = 300
            
            alarm = {
              comparison_operator = &quot;GreaterThanThreshold&quot;
              evaluation_periods = 2
              metric_name = &quot;CPUUtilization&quot;
              threshold = env_name == &quot;production&quot; ? 70 : 80
            }
          },
          {
            name = &quot;cpu-scale-down&quot;
            scaling_adjustment = -1
            adjustment_type = &quot;ChangeInCapacity&quot;
            cooldown = 300
            
            alarm = {
              comparison_operator = &quot;LessThanThreshold&quot;
              evaluation_periods = 3
              metric_name = &quot;CPUUtilization&quot;
              threshold = env_name == &quot;production&quot; ? 30 : 40
            }
          }
        ] : []
      }
      
      # Database configuration
      database = {
        for db_name, db_config in var.databases : db_name =&amp;gt; {
          instance_class = coalesce(
            lookup(db_config, &quot;instance_class&quot;, null),
            env_name == &quot;production&quot; ? &quot;db.r5.large&quot; : &quot;db.t3.micro&quot;
          )
          
          allocated_storage = coalesce(
            lookup(db_config, &quot;allocated_storage&quot;, null),
            env_name == &quot;production&quot; ? 100 : 20
          )
          
          backup_retention_period = env_name == &quot;production&quot; ? 30 : 7
          multi_az = env_name == &quot;production&quot;
          
          # Performance Insights for production
          performance_insights_enabled = env_name == &quot;production&quot;
          performance_insights_retention_period = env_name == &quot;production&quot; ? 7 : null
          
          # Encryption settings
          storage_encrypted = env_config.storage.encrypted
          kms_key_id = env_config.storage.encrypted ? var.kms_key_id : null
          
          # Monitoring and maintenance
          monitoring_interval = env_config.monitoring.detailed ? 60 : 0
          monitoring_role_arn = env_config.monitoring.detailed ? var.rds_monitoring_role_arn : null
          
          # Environment-specific parameter groups
          parameter_group_name = format(&quot;%s-%s-%s-params&quot;, var.project_name, env_name, db_config.engine)
          
          # Maintenance and backup windows
          maintenance_window = env_name == &quot;production&quot; ? &quot;sun:03:00-sun:04:00&quot; : &quot;sun:02:00-sun:03:00&quot;
          backup_window = env_name == &quot;production&quot; ? &quot;02:00-03:00&quot; : &quot;01:00-02:00&quot;
        }
        if lookup(db_config, &quot;enabled&quot;, true)
      }
    }
  }
}

# Generate VPCs for each environment
resource &quot;aws_vpc&quot; &quot;environment&quot; {
  for_each = local.environment_config
  
  cidr_block           = each.value.vpc_cidr
  enable_dns_hostnames = true
  enable_dns_support   = true
  
  tags = merge(
    local.common_tags,
    {
      Name = format(&quot;%s-%s-vpc&quot;, var.project_name, each.key)
      Environment = each.key
    }
  )
}

# Generate subnets dynamically
resource &quot;aws_subnet&quot; &quot;public&quot; {
  for_each = {
    for combo in flatten([
      for env_name, env_config in local.infrastructure_components : [
        for i, subnet_cidr in env_config.vpc.public_subnets : {
          key = format(&quot;%s-public-%d&quot;, env_name, i)
          env_name = env_name
          cidr_block = subnet_cidr
          availability_zone = env_config.vpc.availability_zones[i]
        }
      ]
    ]) : combo.key =&amp;gt; combo
  }
  
  vpc_id                  = aws_vpc.environment[each.value.env_name].id
  cidr_block              = each.value.cidr_block
  availability_zone       = each.value.availability_zone
  map_public_ip_on_launch = true
  
  tags = merge(
    local.common_tags,
    {
      Name = format(&quot;%s-%s&quot;, var.project_name, each.key)
      Type = &quot;public&quot;
      Environment = each.value.env_name
    }
  )
}

# Auto Scaling Groups with complex configuration
resource &quot;aws_autoscaling_group&quot; &quot;application&quot; {
  for_each = local.environment_config
  
  name                = format(&quot;%s-%s-asg&quot;, var.project_name, each.key)
  vpc_zone_identifier = values(aws_subnet.private)[*].id
  
  min_size         = each.value.min_instances
  max_size         = each.value.max_instances
  desired_capacity = each.value.min_instances
  
  health_check_type         = &quot;ELB&quot;
  health_check_grace_period = 300
  
  # Dynamic launch template configuration
  launch_template {
    id      = aws_launch_template.application[each.key].id
    version = &quot;$Latest&quot;
  }
  
  # Dynamic target group attachments
  dynamic &quot;target_group_arns&quot; {
    for_each = aws_lb_target_group.application
    content {
      target_group_arns = [target_group_arns.value.arn]
    }
  }
  
  tag {
    key                 = &quot;Name&quot;
    value               = format(&quot;%s-%s-instance&quot;, var.project_name, each.key)
    propagate_at_launch = true
  }
  
  tag {
    key                 = &quot;Environment&quot;
    value               = each.key
    propagate_at_launch = true
  }
  
  # Instance refresh configuration
  instance_refresh {
    strategy = &quot;Rolling&quot;
    preferences {
      min_healthy_percentage = each.key == &quot;production&quot; ? 75 : 50
      instance_warmup       = 300
    }
  }
}




2. Advanced Output Processing

# Complex output generation with data transformation
output &quot;environment_summary&quot; {
  description = &quot;Complete summary of all environment configurations&quot;
  value = {
    environments = {
      for env_name, env_config in local.environment_config : env_name =&amp;gt; {
        # Network information
        networking = {
          vpc_id = aws_vpc.environment[env_name].id
          vpc_cidr = aws_vpc.environment[env_name].cidr_block
          
          # Subnet information grouped by type
          subnets = {
            public = {
              for subnet in aws_subnet.public : subnet.tags.Name =&amp;gt; {
                id = subnet.id
                cidr_block = subnet.cidr_block
                availability_zone = subnet.availability_zone
              }
              if subnet.tags.Environment == env_name
            }
            
            private = {
              for subnet in aws_subnet.private : subnet.tags.Name =&amp;gt; {
                id = subnet.id
                cidr_block = subnet.cidr_block
                availability_zone = subnet.availability_zone
              }
              if subnet.tags.Environment == env_name
            }
          }
          
          # Gateway information
          internet_gateway = try(aws_internet_gateway.environment[env_name].id, null)
          nat_gateways = {
            for nat in aws_nat_gateway.environment : nat.tags.Name =&amp;gt; {
              id = nat.id
              public_ip = nat.public_ip
              subnet_id = nat.subnet_id
            }
            if nat.tags.Environment == env_name
          }
        }
        
        # Compute resources
        compute = {
          auto_scaling_group = {
            name = aws_autoscaling_group.application[env_name].name
            arn = aws_autoscaling_group.application[env_name].arn
            min_size = aws_autoscaling_group.application[env_name].min_size
            max_size = aws_autoscaling_group.application[env_name].max_size
            desired_capacity = aws_autoscaling_group.application[env_name].desired_capacity
          }
          
          launch_template = {
            id = aws_launch_template.application[env_name].id
            latest_version = aws_launch_template.application[env_name].latest_version
          }
        }
        
        # Load balancer information
        load_balancing = {
          for lb in aws_lb.application : lb.name =&amp;gt; {
            arn = lb.arn
            dns_name = lb.dns_name
            zone_id = lb.zone_id
            
            # Target groups for this load balancer
            target_groups = {
              for tg in aws_lb_target_group.application : tg.name =&amp;gt; {
                arn = tg.arn
                port = tg.port
                protocol = tg.protocol
                health_check = {
                  enabled = tg.health_check[0].enabled
                  path = tg.health_check[0].path
                  port = tg.health_check[0].port
                }
              }
              if tg.tags.Environment == env_name
            }
          }
          if lb.tags.Environment == env_name
        }
        
        # Database information
        databases = {
          for db in aws_db_instance.application : db.identifier =&amp;gt; {
            id = db.id
            arn = db.arn
            endpoint = db.endpoint
            port = db.port
            engine = db.engine
            engine_version = db.engine_version
            instance_class = db.instance_class
            allocated_storage = db.allocated_storage
            
            # Connection information
            connection_info = {
              jdbc_url = format(&quot;jdbc:postgresql://%s:%s/%s&quot;, db.endpoint, db.port, db.db_name)
              psql_command = format(&quot;psql -h %s -p %s -U %s -d %s&quot;, db.endpoint, db.port, db.username, db.db_name)
            }
            
            # Backup and maintenance windows
            maintenance = {
              backup_window = db.backup_window
              maintenance_window = db.maintenance_window
              backup_retention_period = db.backup_retention_period
            }
          }
          if db.tags.Environment == env_name
        }
        
        # Cost estimation
        cost_estimation = {
          monthly_estimate = {
            compute = length(aws_autoscaling_group.application[env_name].desired_capacity) * 
                     lookup(local.instance_costs, env_config.instance_type, 100) * 24 * 30
            
            storage = sum([
              for db in values(aws_db_instance.application) : db.allocated_storage * 0.115
              if db.tags.Environment == env_name
            ])
            
            data_transfer = env_name == &quot;production&quot; ? 50 : 10  # Estimated monthly data transfer cost
          }
          
          optimization_recommendations = {
            rightsizing = env_config.instance_type == &quot;t3.micro&quot; &amp;amp;&amp;amp; env_name == &quot;production&quot; ? 
                         &quot;Consider upgrading to a larger instance type for production workloads&quot; : null
            
            reserved_instances = env_name == &quot;production&quot; ? 
                               &quot;Consider purchasing Reserved Instances for cost savings&quot; : null
            
            spot_instances = env_name != &quot;production&quot; ? 
                           &quot;Consider using Spot Instances for development/testing&quot; : null
          }
        }
      }
    }
    
    # Global summary
    summary = {
      total_environments = length(local.environment_config)
      total_vpcs = length(aws_vpc.environment)
      total_subnets = length(aws_subnet.public) + length(aws_subnet.private)
      total_instances_capacity = sum([
        for asg in aws_autoscaling_group.application : asg.desired_capacity
      ])
      
      # Security summary
      security_groups = length(aws_security_group.application)
      
      # Cost summary
      estimated_monthly_cost = sum([
        for env in values(local.environment_config) : (
          env.min_instances * lookup(local.instance_costs, env.instance_type, 100) * 24 * 30
        )
      ])
    }
  }
}

# Service-specific outputs
output &quot;service_endpoints&quot; {
  description = &quot;Service endpoints for each environment&quot;
  value = {
    for env_name, env_config in local.environment_config : env_name =&amp;gt; {
      for service_name, service_config in var.services : service_name =&amp;gt; {
        internal_endpoint = format(
          &quot;http://%s.%s.internal:%d&quot;,
          service_name,
          env_name,
          service_config.port
        )
        
        external_endpoint = env_config.load_balancer.internal ? null : format(
          &quot;https://%s.%s.%s&quot;,
          service_name,
          env_name,
          var.domain_name
        )
        
        load_balancer_dns = try(
          aws_lb.application[format(&quot;%s-%s&quot;, env_name, service_name)].dns_name,
          null
        )
        
        health_check_url = format(
          &quot;http://%s%s&quot;,
          try(aws_lb.application[format(&quot;%s-%s&quot;, env_name, service_name)].dns_name, &quot;localhost&quot;),
          service_config.health_check_path
        )
      }
    }
  }
}

# Secrets and configuration outputs
output &quot;configuration_templates&quot; {
  description = &quot;Configuration templates for applications&quot;
  sensitive   = true
  value = {
    for env_name, env_config in local.environment_config : env_name =&amp;gt; {
      database_configs = {
        for db_name, db in aws_db_instance.application : db_name =&amp;gt; {
          host = db.endpoint
          port = db.port
          database = db.db_name
          username = db.username
          # Note: Password would be retrieved from AWS Secrets Manager
          password_secret_arn = aws_secretsmanager_secret.db_password[db_name].arn
          
          # Connection pool settings
          connection_pool = {
            min_connections = env_name == &quot;production&quot; ? 5 : 2
            max_connections = env_name == &quot;production&quot; ? 20 : 10
            idle_timeout = 300
            max_lifetime = 1800
          }
          
          # SSL configuration
          ssl_mode = env_name == &quot;production&quot; ? &quot;require&quot; : &quot;prefer&quot;
          ssl_cert_path = &quot;/opt/certs/rds-ca-2019-root.pem&quot;
        }
        if db.tags.Environment == env_name
      }
      
      # Environment variables for applications
      environment_variables = {
        AWS_REGION = data.aws_region.current.name
        ENVIRONMENT = env_name
        PROJECT_NAME = var.project_name
        
        # Service discovery endpoints
        SERVICE_DISCOVERY_NAMESPACE = try(
          aws_service_discovery_http_namespace.environment[env_name].name,
          null
        )
        
        # Monitoring and logging
        CLOUDWATCH_LOG_GROUP = try(
          aws_cloudwatch_log_group.application[env_name].name,
          null
        )
        
        # Feature flags based on environment
        ENABLE_DEBUG_LOGGING = env_name != &quot;production&quot; ? &quot;true&quot; : &quot;false&quot;
        ENABLE_PERFORMANCE_MONITORING = env_name == &quot;production&quot; ? &quot;true&quot; : &quot;false&quot;
        CACHE_TTL = env_name == &quot;production&quot; ? &quot;3600&quot; : &quot;300&quot;
      }
    }
  }
}






Conclusion

Advanced Terraform functions and expressions represent the cornerstone of sophisticated Infrastructure as Code implementations.


  Mastering these concepts enables infrastructure engineers to build self-adapting, maintainable, and scalable infrastructure solutions that respond dynamically to changing requirements and environments.




Key Mastery Areas:


  Function Composition: Combining multiple functions for complex data transformations
  Conditional Logic: Building intelligent infrastructure that adapts to context
  Dynamic Generation: Creating resources programmatically based on input data
  Type Safety: Leveraging Terraform’s type system for robust configurations
  Performance Optimization: Efficient data processing and resource creation patterns




Operational Excellence:


  Reduced Code Duplication: DRY principles through advanced function usage
  Enhanced Maintainability: Self-documenting configurations with clear logic
  Improved Scalability: Infrastructure that adapts to growth automatically
  Better Testing: Predictable behavior through pure function compositions
  Team Productivity: Reusable patterns that accelerate development


Advanced Implementation Strategies:

  Develop comprehensive function libraries for common transformation patterns
  Implement policy-as-code using advanced conditional expressions
  Create self-healing infrastructure through dynamic block generation
  Establish infrastructure testing frameworks leveraging Terraform’s type system
  Build sophisticated multi-environment deployment pipelines with advanced expressions




The combination of advanced functions, sophisticated expressions, and dynamic blocks elevates Terraform from a basic provisioning tool to a comprehensive infrastructure programming platform. These capabilities enable the creation of intelligent, adaptive infrastructure that scales with organizational needs while maintaining consistency and reliability.


  “Advanced Terraform mastery transforms infrastructure management from reactive maintenance to proactive, intelligent automation that anticipates and adapts to changing requirements.”






References


  Terraform Functions Documentation
  HCL Expressions Guide
  Dynamic Blocks Documentation
  Type Constraints Reference
  Terraform Best Practices
  Advanced Terraform Patterns
  Community Function Examples

",
            "wordcount": "13340",
            "inLanguage": "en",
            "dateCreated": "2025-11-15/",
            "datePublished": "2025-11-15/",
            "dateModified": "2025-11-15/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "IAC",
            "articleSection": "IAC",
            "keywords": ["terraform","hashicorp","functions","expressions","dynamic-blocks","hcl","infrastructure-as-code","automation","advanced-terraform","data-transformation"]
        }
        </script>
    </body>
</html>
