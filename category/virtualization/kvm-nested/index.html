<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <!-- ✅ Google Tag Manager 추가 -->
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];
            w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;
            j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
            f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MBP83N4Q');
    </script>
      <!-- ✅ End Google Tag Manager -->

    <!-- Mermaid.js 직접 로드 -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

    <title>KVM Nested Virtualization Complete Guide | somaz</title>
    <meta name="description" content="Learn how to enable nested virtualization in KVM, configure VT-x features, and optimize performance for VM-within-VM scenarios">
    
        <meta name="keywords" content="kvm, nested-virtualization, vt-x, hypervisor, virtualization, qemu, libvirt">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="KVM Nested Virtualization Complete Guide | somaz">
    <meta name="twitter:description" content="Learn how to enable nested virtualization in KVM, configure VT-x features, and optimize performance for VM-within-VM scenarios">

    
        <meta property="twitter:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755588581/kvm-nested_efue7m.png">
    
    
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="https://somaz.blog/category/virtualization/kvm-nested/">
    <meta property="og:title" content="KVM Nested Virtualization Complete Guide | somaz">
    <meta property="og:image" content="https://res.cloudinary.com/dkcm26aem/image/upload/v1755588581/kvm-nested_efue7m.png">
    <meta property="og:description" content="Learn how to enable nested virtualization in KVM, configure VT-x features, and optimize performance for VM-within-VM scenarios">
    <meta property="og:site_name" content="Somaz Tech Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="somaz">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="https://somaz.blog/category/virtualization/kvm-nested/">
    <link rel="alternate" type="application/rss+xml" title="Somaz Tech Blog" href="https://somaz.blog/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8725590811736154"
        crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;500;700&display=swap" rel="stylesheet"> -->

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

</head>
<!-- ✅ Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBP83N4Q"
            height="0" width="0" style="display:none;visibility:hidden">
    </iframe>
</noscript>
<!-- ✅ End Google Tag Manager (noscript) -->
    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol><symbol id="icon-tistory" viewBox="0 0 24 24"><path d="M4 4h16v3h-6v13h-4V7H4V4z"/></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                somaz <span class="version">v3.1.2</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
        <a href="https://github.com/thiagorossener/jekflix-template" class="get-theme" role="button">
            Get this theme!
        </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post two-columns">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2025-12-14T00:00:00+00:00">
                            


December 14, 2025

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>20 min to read</span>
                </p>
                <h1 class="post-title">KVM Nested Virtualization Complete Guide</h1>
                <p class="post-subtitle">Enable and configure nested virtualization in KVM for advanced virtual environments</p>

                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/v1755588581/kvm-nested_efue7m.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p><br /></p>

<hr />

<h2 id="overview">Overview</h2>

<p><strong>Nested Virtualization</strong> in KVM (Kernel-based Virtual Machine) is a feature that allows running virtual machines (VMs) inside other VMs.</p>

<p>This capability is particularly useful for testing virtualization environments, CI/CD pipelines, cloud platform testing, and development environment setup.</p>

<p>This comprehensive guide provides step-by-step instructions for <strong>enabling nested virtualization on KVM hosts</strong> and configuring guest VMs to support virtualization features.</p>

<p>We’ll cover everything from BIOS configuration to performance optimization and troubleshooting.</p>

<p><br /></p>

<h3 id="related-articles">Related Articles</h3>

<ul>
  <li><a href="https://somaz.blog/category/virtualization/kvm-qemu/">KVM and QEMU Guide</a> - Linux Virtualization Solutions</li>
  <li><a href="https://somaz.blog/category/virtualization/libvirt-virsh/">Libvirt Complete Guide</a> - Linux Virtualization Management Tool</li>
</ul>

<p><br /></p>

<hr />

<h2 id="understanding-vt-x-intel-virtualization-technology">Understanding VT-x (Intel Virtualization Technology)</h2>

<p>Before diving into nested virtualization setup, it’s essential to understand the underlying hardware virtualization technology.</p>

<p><br /></p>

<h3 id="what-is-vt-x">What is VT-x?</h3>

<p><strong>VT-x (Intel Virtualization Technology)</strong> is a hardware virtualization technology provided by Intel CPUs that enables guest operating systems to directly access hardware resources with minimal performance overhead.</p>

<div class="info-box info-box-default-not-check">
  <strong>Core Concept</strong>
  <p>VT-x provides hardware-assisted virtualization by extending the CPU with special instructions and capabilities that make virtualization more efficient and secure.</p>
</div>

<p><br /></p>

<h3 id="key-vt-x-components">Key VT-x Components</h3>

<div class="table-container">
  <table class="table-beauty">
    <tr>
      <th style="width: 25%;">Component</th>
      <th style="width: 75%;">Description</th>
    </tr>
    <tr>
      <td><strong>VMX (Virtual Machine Extensions)</strong></td>
      <td>CPU extension instructions for virtualization operations</td>
    </tr>
    <tr>
      <td><strong>EPT (Extended Page Tables)</strong></td>
      <td>Hardware-assisted memory virtualization for improved performance</td>
    </tr>
    <tr>
      <td><strong>VPID (Virtual Processor ID)</strong></td>
      <td>Reduces TLB flush overhead in virtualized environments</td>
    </tr>
    <tr>
      <td><strong>VT-d</strong></td>
      <td>I/O device virtualization support for direct device access</td>
    </tr>
  </table>
</div>

<p><br /></p>

<hr />

<h2 id="biosuefi-configuration-for-vt-x">BIOS/UEFI Configuration for VT-x</h2>

<p>Proper BIOS/UEFI configuration is the foundation for nested virtualization support.</p>

<p><br /></p>

<h3 id="accessing-biosuefi-settings">Accessing BIOS/UEFI Settings</h3>

<h4 id="1-enter-biosuefi-setup">1. Enter BIOS/UEFI Setup</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># During system boot, press:</span>
<span class="c"># - F2, F12, or Del key (manufacturer-specific)</span>
<span class="c"># - Some systems: F1, F10, or Esc</span>
<span class="c"># - UEFI systems may require holding Shift while clicking Restart</span>
</code></pre></div></div>

<h4 id="2-locate-vt-x-settings">2. Locate VT-x Settings</h4>
<p>Common menu locations for VT-x settings:</p>
<ul>
  <li><strong>Advanced → CPU Configuration → Intel Virtualization Technology</strong></li>
  <li><strong>Processor → Intel VT-x</strong></li>
  <li><strong>Security → Virtualization → VT-x</strong></li>
  <li><strong>Chipset → North Bridge → Intel VT-x</strong></li>
</ul>

<h4 id="3-required-settings-configuration">3. Required Settings Configuration</h4>

<div class="table-container">
  <table class="table-beauty">
    <tr>
      <th style="width: 40%;">Setting</th>
      <th style="width: 20%;">Required Value</th>
      <th style="width: 40%;">Purpose</th>
    </tr>
    <tr>
      <td><strong>Intel VT-x Technology</strong></td>
      <td><strong>[Enabled]</strong></td>
      <td>Core virtualization support</td>
    </tr>
    <tr>
      <td><strong>Intel VT-d Technology</strong></td>
      <td><strong>[Enabled]</strong></td>
      <td>I/O virtualization and device passthrough</td>
    </tr>
    <tr>
      <td><strong>Execute Disable Bit</strong></td>
      <td><strong>[Enabled]</strong></td>
      <td>Security feature for memory protection</td>
    </tr>
    <tr>
      <td><strong>Hyper-Threading</strong></td>
      <td><strong>[Enabled]</strong></td>
      <td>Enhanced CPU utilization (optional)</td>
    </tr>
  </table>
</div>

<div class="info-box info-box-success-not-check">
  <strong>Important Notes</strong>
  <ul>
    <li><strong>Save settings and reboot</strong> after making changes</li>
    <li><strong>Some systems require Secure Boot to be disabled</strong> for nested virtualization</li>
    <li><strong>AMD systems</strong> use AMD-V instead of VT-x with similar configuration steps</li>
  </ul>
</div>

<p><br /></p>

<hr />

<h2 id="verifying-cpu-virtualization-support">Verifying CPU Virtualization Support</h2>

<p>Before enabling nested virtualization, verify that your system supports the necessary hardware features.</p>

<p><br /></p>

<h3 id="check-cpu-virtualization-capabilities">Check CPU Virtualization Capabilities</h3>

<h4 id="complete-cpu-information-check">Complete CPU Information Check</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display detailed CPU information</span>
<span class="nv">$ </span>lscpu
Architecture:        x86_64
CPU op-mode<span class="o">(</span>s<span class="o">)</span>:      32-bit, 64-bit
Byte Order:          Little Endian
Address sizes:       46 bits physical, 48 bits virtual
CPU<span class="o">(</span>s<span class="o">)</span>:              72
On-line CPU<span class="o">(</span>s<span class="o">)</span> list: 0-71
Thread<span class="o">(</span>s<span class="o">)</span> per core:  2
Core<span class="o">(</span>s<span class="o">)</span> per socket:  18
Socket<span class="o">(</span>s<span class="o">)</span>:           2
NUMA node<span class="o">(</span>s<span class="o">)</span>:        2
Vendor ID:           GenuineIntel
CPU family:          6
Model:               79
Model name:          Intel<span class="o">(</span>R<span class="o">)</span> Xeon<span class="o">(</span>R<span class="o">)</span> CPU E5-2697 v4 @ 2.30GHz
Stepping:            1
CPU MHz:             1367.142
CPU max MHz:         3600.0000
CPU min MHz:         1200.0000
BogoMIPS:            4594.55
Virtualization:      VT-x
L1d cache:           32K
L1i cache:           32K
L2 cache:            256K
L3 cache:            46080K
NUMA node0 CPU<span class="o">(</span>s<span class="o">)</span>:   0-17,36-53
NUMA node1 CPU<span class="o">(</span>s<span class="o">)</span>:   18-35,54-71
Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts
</code></pre></div></div>

<h4 id="key-items-to-verify">Key Items to Verify</h4>

<div class="info-box info-box-default-not-check">
  <strong>Critical Flags to Check</strong>
  <ul>
    <li><strong>Virtualization: VT-x</strong> (Intel) or <strong>AMD-V</strong> (AMD)</li>
    <li><strong>Flags containing 'vmx'</strong> (Intel) or <strong>'svm'</strong> (AMD)</li>
    <li><strong>Additional flags</strong>: ept, vpid, vnmi, flexpriority</li>
  </ul>
</div>

<h4 id="quick-virtualization-check">Quick Virtualization Check</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check for virtualization support</span>
<span class="nv">$ </span>egrep <span class="nt">--color</span> <span class="nt">-i</span> <span class="s2">"svm|vmx"</span> /proc/cpuinfo
flags: ... vmx smx ... vnmi flexpriority ept vpid ...

<span class="c"># Alternative check</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"(vmx|svm)"</span> /proc/cpuinfo
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="kvm-module-configuration-on-host">KVM Module Configuration on Host</h2>

<p>Proper KVM module configuration is essential for enabling nested virtualization support.</p>

<p><br /></p>

<h3 id="check-current-kvm-module-status">Check Current KVM Module Status</h3>

<h4 id="verify-loaded-modules">Verify Loaded Modules</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check currently loaded KVM modules</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>kvm
</code></pre></div></div>

<h4 id="expected-output-when-properly-loaded">Expected output when properly loaded:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kvm_intel             487424  18
kvm                  1404928  13 kvm_intel
irqbypass              12288  1 kvm
</code></pre></div></div>

<h4 id="output-when-modules-are-not-loaded">Output when modules are not loaded:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lsmod | <span class="nb">grep </span>kvm
<span class="c"># (no output)</span>
</code></pre></div></div>

<h4 id="module-information-check">Module Information Check</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check KVM Intel module information</span>
<span class="nv">$ </span>modinfo kvm_intel | <span class="nb">grep</span> <span class="nt">-i</span> nested
parm:           nested_early_check:bool
parm:           nested:bool

<span class="c"># Check KVM AMD module information  </span>
<span class="nv">$ </span>modinfo kvm_amd | <span class="nb">grep</span> <span class="nt">-i</span> nested
parm:           nested:bool
</code></pre></div></div>

<p><br /></p>

<h3 id="enable-nested-virtualization-temporarily">Enable Nested Virtualization Temporarily</h3>

<h4 id="unload-existing-kvm-modules">Unload Existing KVM Modules</h4>

<h4 id="for-intel-systems">For Intel Systems:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Remove Intel KVM module</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe <span class="nt">-r</span> kvm_intel

<span class="c"># Verify removal</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>kvm_intel
<span class="c"># (should show no output)</span>
</code></pre></div></div>

<h4 id="for-amd-systems">For AMD Systems:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Remove AMD KVM module</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe <span class="nt">-r</span> kvm_amd

<span class="c"># Verify removal</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>kvm_amd
<span class="c"># (should show no output)</span>
</code></pre></div></div>

<h4 id="reload-modules-with-nested-support">Reload Modules with Nested Support</h4>

<h4 id="for-intel-systems-1">For Intel Systems:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Load Intel KVM module with nested virtualization</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe kvm_intel <span class="nv">nested</span><span class="o">=</span>1

<span class="c"># Verify nested support is enabled</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/module/kvm_intel/parameters/nested
Y
</code></pre></div></div>

<h4 id="for-amd-systems-1">For AMD Systems:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Load AMD KVM module with nested virtualization</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe kvm_amd <span class="nv">nested</span><span class="o">=</span>1

<span class="c"># Verify nested support is enabled</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/module/kvm_amd/parameters/nested
Y
</code></pre></div></div>

<p><br /></p>

<h3 id="enable-nested-virtualization-permanently">Enable Nested Virtualization Permanently</h3>

<h4 id="create-persistent-configuration">Create Persistent Configuration</h4>

<p>To make nested virtualization permanent across reboots, create a module configuration file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create or edit KVM configuration file</span>
<span class="nv">$ </span><span class="nb">sudo </span>vi /etc/modprobe.d/kvm.conf
</code></pre></div></div>

<h4 id="for-intel-hosts-add">For Intel hosts, add:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>options kvm_intel <span class="nv">nested</span><span class="o">=</span>1
</code></pre></div></div>

<h4 id="for-amd-hosts-add">For AMD hosts, add:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>options kvm_amd <span class="nv">nested</span><span class="o">=</span>1
</code></pre></div></div>

<h4 id="apply-configuration">Apply Configuration</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Update initramfs (Ubuntu/Debian)</span>
<span class="nv">$ </span><span class="nb">sudo </span>update-initramfs <span class="nt">-u</span>

<span class="c"># Update initramfs (CentOS/RHEL/Fedora)</span>
<span class="nv">$ </span><span class="nb">sudo </span>dracut <span class="nt">-f</span>

<span class="c"># Reboot to apply changes permanently</span>
<span class="nv">$ </span><span class="nb">sudo </span>reboot
</code></pre></div></div>

<h4 id="verify-permanent-configuration">Verify Permanent Configuration</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># After reboot, check nested support</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/module/kvm_intel/parameters/nested
Y

<span class="c"># Verify module parameters</span>
<span class="nv">$ </span>modinfo kvm_intel | <span class="nb">grep </span>nested
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="guest-vm-nested-virtualization-configuration">Guest VM Nested Virtualization Configuration</h2>

<p>Configure guest VMs to support nested virtualization through CPU passthrough and feature enabling.</p>

<p><br /></p>

<h3 id="method-a-using-virsh-cli">Method A: Using virsh CLI</h3>

<h4 id="edit-vm-configuration">Edit VM Configuration</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Access virsh interactive shell</span>
<span class="nv">$ </span>virsh
virsh <span class="c"># list --all</span>
 Id    Name                           State
<span class="nt">----------------------------------------------------</span>
 -     ubuntu-guest                   shut off
 -     windows-guest                  shut off

<span class="c"># Edit VM configuration</span>
virsh <span class="c"># edit ubuntu-guest</span>
</code></pre></div></div>

<h4 id="configure-cpu-for-nested-virtualization">Configure CPU for Nested Virtualization</h4>

<p>Replace the existing CPU configuration with:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="for-amd-systems-use">For AMD systems, use:</h4>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'svm'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="save-and-restart-vm">Save and Restart VM</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># In virsh shell</span>
virsh <span class="c"># shutdown ubuntu-guest</span>
virsh <span class="c"># start ubuntu-guest</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="method-b-using-virt-manager-gui">Method B: Using Virt-Manager GUI</h3>

<h4 id="step-by-step-gui-configuration">Step-by-Step GUI Configuration</h4>

<ol>
  <li><strong>Open Virt-Manager</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virt-manager
</code></pre></div>    </div>
  </li>
  <li><strong>Access VM Details</strong>
    <ul>
      <li>Right-click on the target VM</li>
      <li>Select <strong>“Open”</strong> → <strong>“Details”</strong></li>
    </ul>
  </li>
  <li><strong>Configure Processor Settings</strong>
    <ul>
      <li>Navigate to <strong>“Processor”</strong> tab</li>
      <li>Set CPU mode to <strong>“host-passthrough”</strong></li>
      <li>Check <strong>“Copy host CPU configuration”</strong></li>
    </ul>
  </li>
  <li><strong>Apply and Restart</strong>
    <ul>
      <li>Click <strong>“Apply”</strong></li>
      <li>Restart the VM</li>
    </ul>
  </li>
</ol>

<p><br /></p>

<h3 id="advanced-cpu-configuration">Advanced CPU Configuration</h3>

<h4 id="comprehensive-feature-set">Comprehensive Feature Set</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span> <span class="na">migratable=</span><span class="s">'on'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'ept'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vpid'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'unrestricted_guest'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'flexpriority'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vnmi'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="cpu-topology-configuration">CPU Topology Configuration</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">'1'</span> <span class="na">cores=</span><span class="s">'4'</span> <span class="na">threads=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="verifying-nested-virtualization-in-guest-vm">Verifying Nested Virtualization in Guest VM</h2>

<p>Confirm that nested virtualization is properly enabled within the guest VM.</p>

<p><br /></p>

<h3 id="check-virtualization-support-in-guest">Check Virtualization Support in Guest</h3>

<h4 id="verify-vt-x-features">Verify VT-x Features</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Inside the guest VM, check for virtualization flags</span>
<span class="nv">$ </span>egrep <span class="nt">--color</span> <span class="nt">-i</span> <span class="s2">"svm|vmx"</span> /proc/cpuinfo
flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts
</code></pre></div></div>

<h4 id="check-kvm-module-in-guest">Check KVM Module in Guest</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install KVM in guest VM (if not already installed)</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> qemu-kvm libvirt-daemon-system

<span class="c"># Check nested virtualization support</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/module/kvm_intel/parameters/nested
Y

<span class="c"># Verify KVM module is loaded</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>kvm
kvm_intel             487424  0
kvm                  1404928  1 kvm_intel
</code></pre></div></div>

<h4 id="test-nested-vm-creation">Test Nested VM Creation</h4>

<script src="https://gist.github.com/somaz94/121a0dbfdd2cd614bbadb03562e5337c.js"></script>

<p><br /></p>

<hr />

<h2 id="performance-optimization-for-nested-virtualization">Performance Optimization for Nested Virtualization</h2>

<p>Optimize nested virtualization performance through proper CPU, memory, and I/O configuration.</p>

<p><br /></p>

<h3 id="cpu-performance-optimization">CPU Performance Optimization</h3>

<h4 id="numa-aware-configuration">NUMA-Aware Configuration</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;numa&gt;</span>
    <span class="nt">&lt;cell</span> <span class="na">id=</span><span class="s">'0'</span> <span class="na">cpus=</span><span class="s">'0-7'</span> <span class="na">memory=</span><span class="s">'8388608'</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/numa&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="cpu-pinning-for-performance">CPU Pinning for Performance</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;vcpu</span> <span class="na">placement=</span><span class="s">'static'</span> <span class="na">cpuset=</span><span class="s">'0-7'</span><span class="nt">&gt;</span>8<span class="nt">&lt;/vcpu&gt;</span>
<span class="nt">&lt;cputune&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'0'</span> <span class="na">cpuset=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'1'</span> <span class="na">cpuset=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'2'</span> <span class="na">cpuset=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'3'</span> <span class="na">cpuset=</span><span class="s">'3'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'4'</span> <span class="na">cpuset=</span><span class="s">'4'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'5'</span> <span class="na">cpuset=</span><span class="s">'5'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'6'</span> <span class="na">cpuset=</span><span class="s">'6'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'7'</span> <span class="na">cpuset=</span><span class="s">'7'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cputune&gt;</span>
</code></pre></div></div>

<h4 id="hyper-threading-considerations">Hyper-Threading Considerations</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check hyper-threading status</span>
<span class="nv">$ </span>lscpu | <span class="nb">grep</span> <span class="s2">"Thread(s) per core"</span>
Thread<span class="o">(</span>s<span class="o">)</span> per core:  2

<span class="c"># For optimal performance, use only physical cores</span>
&lt;vcpu <span class="nv">placement</span><span class="o">=</span><span class="s1">'static'</span> <span class="nv">cpuset</span><span class="o">=</span><span class="s1">'0,2,4,6'</span><span class="o">&gt;</span>4&lt;/vcpu&gt;
</code></pre></div></div>

<p><br /></p>

<h3 id="memory-optimization">Memory Optimization</h3>

<h4 id="huge-pages-configuration">Huge Pages Configuration</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Configure huge pages on host</span>
<span class="nv">$ </span><span class="nb">echo </span>1024 | <span class="nb">sudo tee</span> /proc/sys/vm/nr_hugepages

<span class="c"># Make permanent</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'vm.nr_hugepages = 1024'</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf

<span class="c"># Configure in VM XML</span>
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;memoryBacking&gt;</span>
  <span class="nt">&lt;hugepages/&gt;</span>
<span class="nt">&lt;/memoryBacking&gt;</span>
</code></pre></div></div>

<h4 id="memory-ballooning">Memory Ballooning</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;devices&gt;</span>
  <span class="nt">&lt;memballoon</span> <span class="na">model=</span><span class="s">'virtio'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x08'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/memballoon&gt;</span>
<span class="nt">&lt;/devices&gt;</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="io-performance-optimization">I/O Performance Optimization</h3>

<h4 id="storage-configuration">Storage Configuration</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'qcow2'</span> <span class="na">cache=</span><span class="s">'writeback'</span> <span class="na">io=</span><span class="s">'threads'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">'/var/lib/libvirt/images/vm.qcow2'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vda'</span> <span class="na">bus=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</code></pre></div></div>

<h4 id="network-performance">Network Performance</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'bridge'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">'virbr0'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'vhost'</span> <span class="na">queues=</span><span class="s">'4'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/interface&gt;</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="direct-qemukvm-command-line-usage">Direct QEMU/KVM Command Line Usage</h2>

<p>For advanced users who prefer direct QEMU command line control over libvirt.</p>

<p><br /></p>

<h3 id="basic-nested-virtualization-with-qemu">Basic Nested Virtualization with QEMU</h3>

<h4 id="simple-configuration">Simple Configuration</h4>

<script src="https://gist.github.com/somaz94/87c7097d206a8be5cb03b927504066fe.js"></script>

<h4 id="advanced-vt-x-features">Advanced VT-x Features</h4>

<script src="https://gist.github.com/somaz94/1d53391737e26da651746eacb4d8b44f.js"></script>

<h4 id="performance-optimized-configuration">Performance-Optimized Configuration</h4>

<script src="https://gist.github.com/somaz94/578f007d9d74e00f8955b406c76bcc1a.js"></script>

<p><br /></p>

<hr />

<h2 id="performance-monitoring-and-benchmarking">Performance Monitoring and Benchmarking</h2>

<p>Monitor and benchmark nested virtualization performance to ensure optimal configuration.</p>

<p><br /></p>

<h3 id="vt-x-feature-utilization-monitoring">VT-x Feature Utilization Monitoring</h3>

<h4 id="check-vt-x-usage-in-guest">Check VT-x Usage in Guest</h4>

<script src="https://gist.github.com/somaz94/0476d6881ba724a666bb0357e76efe2a.js"></script>

<h4 id="monitor-vm-exits">Monitor VM Exits</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check KVM statistics</span>
<span class="nv">$ </span><span class="nb">cat</span> /sys/kernel/debug/kvm/exits
exits                 1234567
host_state_reload     12345
hypercalls           4567
request_irq          8901
</code></pre></div></div>

<p><br /></p>

<h3 id="performance-benchmarking">Performance Benchmarking</h3>

<h4 id="cpu-performance-testing">CPU Performance Testing</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CPU performance benchmark</span>
<span class="nv">$ </span>sysbench cpu <span class="nt">--cpu-max-prime</span><span class="o">=</span>20000 run
sysbench 1.0.18 <span class="o">(</span>using system LuaJIT 2.1.0-beta3<span class="o">)</span>

Running the <span class="nb">test </span>with following options:
Number of threads: 1
Initializing random number generator from current <span class="nb">time

</span>Prime numbers limit: 20000

Initializing worker threads...

Threads started!

CPU speed:
    events per second:  1234.56

General statistics:
    total <span class="nb">time</span>:                          10.0001s
    total number of events:              12346

<span class="c"># Disk I/O benchmark</span>
<span class="nv">$ </span><span class="nb">time dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/tmp/test <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>1000
1000+0 records <span class="k">in
</span>1000+0 records out
1048576000 bytes <span class="o">(</span>1.0 GB, 1000 MiB<span class="o">)</span> copied, 2.34567 s, 447 MB/s

real    0m2.346s
user    0m0.001s
sys     0m0.987s
</code></pre></div></div>

<h4 id="memory-performance-testing">Memory Performance Testing</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Memory bandwidth test</span>
<span class="nv">$ </span>sysbench memory <span class="nt">--memory-block-size</span><span class="o">=</span>1M <span class="nt">--memory-total-size</span><span class="o">=</span>10G run

<span class="c"># Memory latency test</span>
<span class="nv">$ </span>lat_mem_rd <span class="nt">-s</span> 512 <span class="nt">-N</span> 2 <span class="nt">-t</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="troubleshooting-common-issues">Troubleshooting Common Issues</h2>

<p>Resolve frequent problems encountered in nested virtualization setups.</p>

<p><br /></p>

<h3 id="hardware-and-bios-issues">Hardware and BIOS Issues</h3>

<h4 id="problem-vt-x-not-available">Problem: VT-x Not Available</h4>

<h4 id="error-messages">Error Messages:</h4>
<script src="https://gist.github.com/somaz94/f576df1381faa2dc07a968737feb590a.js"></script>

<h4 id="solutions">Solutions:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Check BIOS settings</span>
<span class="c"># - Ensure VT-x is enabled in BIOS/UEFI</span>
<span class="c"># - Disable Secure Boot if required</span>
<span class="c"># - Enable VT-d for I/O virtualization</span>

<span class="c"># 2. Verify CPU support</span>
<span class="nv">$ </span>egrep <span class="nt">-c</span> <span class="s1">'(vmx|svm)'</span> /proc/cpuinfo
8  <span class="c"># Should be &gt; 0</span>

<span class="c"># 3. Check for conflicting software</span>
<span class="nv">$ </span><span class="nb">sudo </span>systemctl status vmware
<span class="nv">$ </span><span class="nb">sudo </span>systemctl status virtualbox
</code></pre></div></div>

<p><br /></p>

<h3 id="module-configuration-issues">Module Configuration Issues</h3>

<h4 id="problem-nested-virtualization-not-supported">Problem: Nested Virtualization Not Supported</h4>

<h4 id="check-current-status">Check Current Status:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /sys/module/kvm_intel/parameters/nested
N
</code></pre></div></div>

<h4 id="solutions-1">Solutions:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Reload module with nested support</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe <span class="nt">-r</span> kvm_intel
<span class="nv">$ </span><span class="nb">sudo </span>modprobe kvm_intel <span class="nv">nested</span><span class="o">=</span>1

<span class="c"># 2. Make permanent</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'options kvm_intel nested=1'</span> | <span class="nb">sudo tee</span> /etc/modprobe.d/kvm.conf

<span class="c"># 3. Update initramfs</span>
<span class="nv">$ </span><span class="nb">sudo </span>update-initramfs <span class="nt">-u</span>
<span class="nv">$ </span><span class="nb">sudo </span>reboot
</code></pre></div></div>

<p><br /></p>

<h3 id="guest-vm-configuration-issues">Guest VM Configuration Issues</h3>

<h4 id="problem-vt-x-not-recognized-in-guest">Problem: VT-x Not Recognized in Guest</h4>

<h4 id="check-guest-configuration">Check Guest Configuration:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virsh dumpxml vm-name | <span class="nb">grep</span> <span class="nt">-A5</span> <span class="nt">-B5</span> cpu
&lt;cpu <span class="nv">mode</span><span class="o">=</span><span class="s1">'custom'</span> <span class="nv">match</span><span class="o">=</span><span class="s1">'exact'</span> <span class="nv">check</span><span class="o">=</span><span class="s1">'partial'</span><span class="o">&gt;</span>
  &lt;model <span class="nv">fallback</span><span class="o">=</span><span class="s1">'allow'</span><span class="o">&gt;</span>Skylake-Client-IBRS&lt;/model&gt;
&lt;/cpu&gt;
</code></pre></div></div>

<h4 id="solution-update-cpu-configuration">Solution: Update CPU Configuration:</h4>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="apply-changes">Apply Changes:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virsh shutdown vm-name
<span class="nv">$ </span>virsh edit vm-name
<span class="c"># Make changes and save</span>
<span class="nv">$ </span>virsh start vm-name
</code></pre></div></div>

<p><br /></p>

<h3 id="performance-issues">Performance Issues</h3>

<h4 id="problem-poor-nested-vm-performance">Problem: Poor Nested VM Performance</h4>

<h4 id="diagnostic-commands">Diagnostic Commands:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check CPU usage</span>
<span class="nv">$ </span>top <span class="nt">-p</span> <span class="si">$(</span>pgrep qemu<span class="si">)</span>

<span class="c"># Monitor I/O statistics</span>
<span class="nv">$ </span>iostat <span class="nt">-x</span> 1

<span class="c"># Check memory usage</span>
<span class="nv">$ </span>free <span class="nt">-h</span> <span class="o">&amp;&amp;</span> <span class="nb">cat</span> /proc/meminfo | <span class="nb">grep</span> <span class="nt">-i</span> huge
</code></pre></div></div>

<h4 id="optimization-solutions">Optimization Solutions:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Enable CPU pinning</span>
<span class="nv">$ </span>virsh vcpupin vm-name 0 0
<span class="nv">$ </span>virsh vcpupin vm-name 1 1

<span class="c"># 2. Configure huge pages</span>
<span class="nv">$ </span><span class="nb">echo </span>2048 | <span class="nb">sudo tee</span> /proc/sys/vm/nr_hugepages

<span class="c"># 3. Optimize storage</span>
<span class="nv">$ </span>virsh edit vm-name
<span class="c"># Add: &lt;driver name='qemu' type='qcow2' cache='writeback'/&gt;</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="security-considerations">Security Considerations</h2>

<p>Understanding and mitigating security risks associated with nested virtualization.</p>

<p><br /></p>

<h3 id="security-risks-in-nested-virtualization">Security Risks in Nested Virtualization</h3>

<h4 id="1-vm-escape-vulnerabilities">1. VM Escape Vulnerabilities</h4>

<div class="info-box info-box-default-not-check">
  <strong>Risk Factors</strong>
  <ul>
    <li><strong>Increased Attack Surface</strong>: Multiple virtualization layers create more potential escape vectors</li>
    <li><strong>Hardware Feature Exposure</strong>: Guest VMs gain access to host CPU features</li>
    <li><strong>Side-Channel Attacks</strong>: Hardware features can leak information across VM boundaries</li>
  </ul>
</div>

<h4 id="2-resource-exhaustion-attacks">2. Resource Exhaustion Attacks</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Monitor resource usage in nested environments</span>
<span class="nv">$ </span>virsh domstats <span class="nt">--cpu-total</span> <span class="nt">--memory</span> <span class="nt">--block</span> <span class="nt">--balloon</span> vm-name

<span class="c"># Set resource limits</span>
<span class="nv">$ </span>virsh edit vm-name
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;memtune&gt;</span>
  <span class="nt">&lt;hard_limit</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>8388608<span class="nt">&lt;/hard_limit&gt;</span>
  <span class="nt">&lt;soft_limit</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>6291456<span class="nt">&lt;/soft_limit&gt;</span>
<span class="nt">&lt;/memtune&gt;</span>
<span class="nt">&lt;cputune&gt;</span>
  <span class="nt">&lt;shares&gt;</span>2048<span class="nt">&lt;/shares&gt;</span>
  <span class="nt">&lt;period&gt;</span>100000<span class="nt">&lt;/period&gt;</span>
  <span class="nt">&lt;quota&gt;</span>200000<span class="nt">&lt;/quota&gt;</span>
<span class="nt">&lt;/cputune&gt;</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="security-hardening-measures">Security Hardening Measures</h3>

<h4 id="disable-unnecessary-cpu-features">Disable Unnecessary CPU Features</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'vmx'</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Disable potentially risky features --&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'disable'</span> <span class="na">name=</span><span class="s">'invtsc'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'disable'</span> <span class="na">name=</span><span class="s">'amd-stibp'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'disable'</span> <span class="na">name=</span><span class="s">'spec-ctrl'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div></div>

<h4 id="network-isolation">Network Isolation</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Use isolated networks for nested VMs --&gt;</span>
<span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'network'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">'isolated'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/interface&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create isolated network</span>
<span class="nv">$ </span>virsh net-define /dev/stdin <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
&lt;network&gt;
  &lt;name&gt;isolated&lt;/name&gt;
  &lt;bridge name='virbr1' stp='on' delay='0'/&gt;
  &lt;domain name='isolated'/&gt;
  &lt;ip address='192.168.100.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.100.2' end='192.168.100.254'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</span><span class="no">EOF

</span><span class="nv">$ </span>virsh net-start isolated
<span class="nv">$ </span>virsh net-autostart isolated
</code></pre></div></div>

<h4 id="access-control-and-monitoring">Access Control and Monitoring</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Monitor VM activities</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> libvirtd <span class="nt">-f</span>

<span class="c"># Set up SELinux/AppArmor policies</span>
<span class="nv">$ </span><span class="nb">sudo </span>setsebool <span class="nt">-P</span> virt_use_execmem 1

<span class="c"># Implement logging for nested VMs</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'log_level = 1'</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/libvirt/libvirtd.conf
<span class="nv">$ </span><span class="nb">sudo </span>systemctl restart libvirtd
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="key-points">Key Points</h2>

<div class="info-box info-box-success-not-check">
  <strong>KVM Nested Virtualization Summary</strong>
  <ul>
    <li>
      <strong>Hardware Requirements</strong><br />
      - Intel VT-x or AMD-V CPU support required<br />
      - BIOS/UEFI virtualization features must be enabled<br />
      - Sufficient CPU cores and memory for nested workloads<br />
      - EPT/RVI support recommended for optimal performance
    </li>
    <li>
      <strong>Configuration Steps</strong><br />
      - Enable nested parameter in KVM modules<br />
      - Configure guest VMs with host-passthrough CPU mode<br />
      - Enable specific CPU features (vmx/svm, ept, vpid)<br />
      - Optimize performance through CPU pinning and huge pages
    </li>
    <li>
      <strong>Use Cases and Considerations</strong><br />
      - Ideal for development, testing, and CI/CD environments<br />
      - Cloud platform testing and virtualization research<br />
      - Performance overhead: 10-30% compared to native virtualization<br />
      - Security implications require careful consideration and hardening
    </li>
  </ul>
</div>

<p><br /></p>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p><strong>KVM Nested Virtualization</strong> enables powerful VM-within-VM scenarios that are invaluable for <strong>development, testing, and cloud platform evaluation</strong>. While the setup requires careful configuration of hardware features, kernel modules, and guest VM settings, the resulting flexibility makes it an essential tool for modern virtualization workflows.</p>

<p>The key to successful nested virtualization lies in <strong>proper hardware configuration</strong>, <strong>optimal CPU feature utilization</strong>, and <strong>performance tuning</strong>. By following the guidelines in this comprehensive guide, you can build robust nested virtualization environments that meet your specific requirements.</p>

<p><br /></p>

<h3 id="best-practices-recap">Best Practices Recap</h3>

<ol>
  <li><strong>Verify hardware support</strong> before attempting configuration</li>
  <li><strong>Enable all relevant VT-x features</strong> for optimal performance</li>
  <li><strong>Use host-passthrough CPU mode</strong> for maximum compatibility</li>
  <li><strong>Implement proper resource limits</strong> to prevent resource exhaustion</li>
  <li><strong>Monitor performance</strong> and adjust configurations as needed</li>
</ol>

<p><br /></p>

<h3 id="future-applications">Future Applications</h3>

<p>As <strong>container technologies</strong>, <strong>cloud-native architectures</strong>, and <strong>edge computing</strong> continue evolving, nested virtualization will remain crucial for <strong>testing complex deployment scenarios</strong> and <strong>developing virtualization-aware applications</strong>.</p>

<p><strong>For DevOps, cloud testing, and container-based virtualization practice, start exploring nested virtualization today!</strong></p>

<p><br /></p>

<hr />

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.intel.com/content/www/us/en/virtualization/virtualization-technology/intel-virtualization-technology.html">Intel VT-x Architecture Specification</a></li>
  <li><a href="https://www.kernel.org/doc/Documentation/virtual/kvm/nested-vmx.txt">KVM Nested Virtualization Documentation</a></li>
  <li><a href="https://libvirt.org/formatdomain.html">libvirt Domain XML Format Guide</a></li>
  <li><a href="https://qemu.readthedocs.io/en/latest/system/qemu-cpu-models.html">QEMU CPU Models and Features</a></li>
  <li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_virtualization/">Red Hat Virtualization Guide</a></li>
  <li><a href="https://ubuntu.com/server/docs/virtualization-kvm">Ubuntu KVM Nested Virtualization</a></li>
  <li><a href="https://docs.fedoraproject.org/en-US/quick-docs/getting-started-with-virtualization/">Fedora Virtualization Guide</a></li>
</ul>


                <!-- Pagination links -->


            </article>

            
                <aside class="see-also">
                    <h2>See also</h2>
                    <ul>
                        
                        
                        
                            <li>
                                <a href="/category/cs/context-switching/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1767769259/context-switch-1_s1n69e.png">
                                    
                                    <h3>Context Switch Deep Dive - The Hidden Performance Cost in Container Environments</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/aws/aws-efs-kubernetes-guide/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1767685797/kubernetes-efs-1_ek4rbd.png">
                                    
                                    <h3>AWS Elastic File System (EFS) with Kubernetes - Complete Implementation Guide</h3>
                                </a>
                            </li>
                        
                            <li>
                                <a href="/category/cs/tls-https/">
                                    
                                        <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1767770122/tls-handshake-1_nwd3f0.png">
                                    
                                    <h3>TLS Handshake and Certificate Architecture - A Deep Dive into HTTPS Security</h3>
                                </a>
                            </li>
                        
                    </ul>
                </aside>
            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="20">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <button class="toggle-preview" onclick="togglePreview()">
    <span>Hide Preview ▼</span>
</button>

<div id="recommendationSection" class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    <div id="previewSection" class="preview-section">
        
        <a href="/category/data-engineering/oltp-olap/" class="post-preview">
            <div class="image">
                
                    <img src="https://res.cloudinary.com/dkcm26aem/image/upload/c_scale,w_380/v1767844237/olap-oltp-1_yxrxnm.png">
                
            </div>
            <h3 class="title">Large-Scale Data Processing and Data Architecture Design</h3>
        </a>
    </div>
</div>

<style>
.toggle-preview {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toggle-preview:hover {
    background: #444;
}

.toggle-preview.visible {
    opacity: 1;
}

.recommendation {
    margin-top: 1000px;
    display: block;
    transition: all 0.3s ease;
}

.recommendation.hidden {
    display: none;
}

.hide-preview {
    margin-left: 10px;
    background: none;
    border: 1px solid #666;
    color: #666;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.hide-preview:hover {
    background: #f0f0f0;
}

.preview-section {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.preview-section.hidden {
    max-height: 0;
}
</style>

<script>
function togglePreview() {
    const recommendation = document.getElementById('recommendationSection');
    const button = document.querySelector('.toggle-preview span');
    
    if (recommendation.classList.contains('hidden')) {
        recommendation.classList.remove('hidden');
        button.textContent = 'Hide Preview ▼';
    } else {
        recommendation.classList.add('hidden');
        button.textContent = 'Show Preview ▲';
    }
}

window.addEventListener('scroll', function() {
    const toggleButton = document.querySelector('.toggle-preview');
    const recommendation = document.getElementById('recommendationSection');
    const rect = recommendation.getBoundingClientRect();
    
    if (rect.top <= window.innerHeight) {
        toggleButton.classList.add('visible');
    } else {
        toggleButton.classList.remove('visible');
    }
});
</script>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Learn how to enable nested virtualization in KVM, configure VT-x features, and optimize performance for VM-within-VM scenarios&quot;%20https://somaz.blog/category/virtualization/kvm-nested/%20via%20&#64;twitter_username&hashtags=kvm,nested-virtualization,vt-x,hypervisor,virtualization,qemu,libvirt"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://somaz.blog/category/virtualization/kvm-nested/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="Somaz">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/somaz/">Somaz</a>
      </h3>
      <p class="desc">DevOps engineer focused on cloud infrastructure and automation</p>
      <p>
        
          <a href="https://github.com/somaz94" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
          <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
            <svg><use xlink:href="#icon-linkedin"></use></svg>
          </a>
        
        
          <a href="https://somaz.tistory.com" title="Tistory">
            <svg><use xlink:href="#icon-tistory"></use></svg>
          </a>
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Somaz",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "DevOps Engineer",
      "url": "https://somaz.blog/authors/somaz/",
      "sameAs": [
        "https://github.com/somaz94","https://www.linkedin.com/in/somaz","https://{{ author.tistory_username }}.tistory.com"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'https-somaz94-github-io';
        var disqus_title = '';
        var disqus_url = '/category/virtualization/kvm-nested/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>



        <footer>
    <p>
      
        <a href="https://github.com/somaz94" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/facebook_username" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/twitter_username" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <a href="https://medium.com/@medium_username" title="Medium">
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <a href="https://www.instagram.com/instagram_username" title="Instagram">
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <a href="https://www.linkedin.com/in/somaz" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
      
        <a href="https://somaz.tistory.com" title="Tistory">
          <svg><use xlink:href="#icon-tistory"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="https://somaz.blog/">Home</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/about">About</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/category">Category</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="https://somaz.blog/feed.xml">Feed</a>
      </li>
    
  
</ul>


    <p>
      <a href="https://somaz.blog/sitemap.xml" title="sitemap">Sitemap</a> |
      <a href="https://somaz.blog/privacy-policy" title="Privacy Policy">Privacy Policy</a>
    </p>

    <p>
      <span>Somaz Tech Blog</span> <svg class="love"><use xlink:href="#icon-heart"></use></svg>
    </p>
</footer>










<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "somaz",
  "description": "DevOps engineer's tech blog.",
  "url": "https://somaz.blog/",
  "logo": {
      "@type": "ImageObject",
      "url": "https://somaz.blog/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/somaz94","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/somaz","https://{{ site.tistory_username }}.tistory.com"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "KVM Nested Virtualization Complete Guide",
            "headline": "Enable and configure nested virtualization in KVM for advanced virtual environments",
            "description": "Learn how to enable nested virtualization in KVM, configure VT-x features, and optimize performance for VM-within-VM scenarios",
            "image": "https://res.cloudinary.com/dkcm26aem/image/upload/v1755588581/kvm-nested_efue7m.png",
            "url": "https://somaz.blog/category/virtualization/kvm-nested/",
            "articleBody": "



Overview

Nested Virtualization in KVM (Kernel-based Virtual Machine) is a feature that allows running virtual machines (VMs) inside other VMs.

This capability is particularly useful for testing virtualization environments, CI/CD pipelines, cloud platform testing, and development environment setup.

This comprehensive guide provides step-by-step instructions for enabling nested virtualization on KVM hosts and configuring guest VMs to support virtualization features.

We’ll cover everything from BIOS configuration to performance optimization and troubleshooting.



Related Articles


  KVM and QEMU Guide - Linux Virtualization Solutions
  Libvirt Complete Guide - Linux Virtualization Management Tool






Understanding VT-x (Intel Virtualization Technology)

Before diving into nested virtualization setup, it’s essential to understand the underlying hardware virtualization technology.



What is VT-x?

VT-x (Intel Virtualization Technology) is a hardware virtualization technology provided by Intel CPUs that enables guest operating systems to directly access hardware resources with minimal performance overhead.


  Core Concept
  VT-x provides hardware-assisted virtualization by extending the CPU with special instructions and capabilities that make virtualization more efficient and secure.




Key VT-x Components


  
    
      Component
      Description
    
    
      VMX (Virtual Machine Extensions)
      CPU extension instructions for virtualization operations
    
    
      EPT (Extended Page Tables)
      Hardware-assisted memory virtualization for improved performance
    
    
      VPID (Virtual Processor ID)
      Reduces TLB flush overhead in virtualized environments
    
    
      VT-d
      I/O device virtualization support for direct device access
    
  






BIOS/UEFI Configuration for VT-x

Proper BIOS/UEFI configuration is the foundation for nested virtualization support.



Accessing BIOS/UEFI Settings

1. Enter BIOS/UEFI Setup
# During system boot, press:
# - F2, F12, or Del key (manufacturer-specific)
# - Some systems: F1, F10, or Esc
# - UEFI systems may require holding Shift while clicking Restart


2. Locate VT-x Settings
Common menu locations for VT-x settings:

  Advanced → CPU Configuration → Intel Virtualization Technology
  Processor → Intel VT-x
  Security → Virtualization → VT-x
  Chipset → North Bridge → Intel VT-x


3. Required Settings Configuration


  
    
      Setting
      Required Value
      Purpose
    
    
      Intel VT-x Technology
      [Enabled]
      Core virtualization support
    
    
      Intel VT-d Technology
      [Enabled]
      I/O virtualization and device passthrough
    
    
      Execute Disable Bit
      [Enabled]
      Security feature for memory protection
    
    
      Hyper-Threading
      [Enabled]
      Enhanced CPU utilization (optional)
    
  



  Important Notes
  
    Save settings and reboot after making changes
    Some systems require Secure Boot to be disabled for nested virtualization
    AMD systems use AMD-V instead of VT-x with similar configuration steps
  






Verifying CPU Virtualization Support

Before enabling nested virtualization, verify that your system supports the necessary hardware features.



Check CPU Virtualization Capabilities

Complete CPU Information Check

# Display detailed CPU information
$ lscpu
Architecture:        x86_64
CPU op-mode(s):      32-bit, 64-bit
Byte Order:          Little Endian
Address sizes:       46 bits physical, 48 bits virtual
CPU(s):              72
On-line CPU(s) list: 0-71
Thread(s) per core:  2
Core(s) per socket:  18
Socket(s):           2
NUMA node(s):        2
Vendor ID:           GenuineIntel
CPU family:          6
Model:               79
Model name:          Intel(R) Xeon(R) CPU E5-2697 v4 @ 2.30GHz
Stepping:            1
CPU MHz:             1367.142
CPU max MHz:         3600.0000
CPU min MHz:         1200.0000
BogoMIPS:            4594.55
Virtualization:      VT-x
L1d cache:           32K
L1i cache:           32K
L2 cache:            256K
L3 cache:            46080K
NUMA node0 CPU(s):   0-17,36-53
NUMA node1 CPU(s):   18-35,54-71
Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts


Key Items to Verify


  Critical Flags to Check
  
    Virtualization: VT-x (Intel) or AMD-V (AMD)
    Flags containing &apos;vmx&apos; (Intel) or &apos;svm&apos; (AMD)
    Additional flags: ept, vpid, vnmi, flexpriority
  


Quick Virtualization Check

# Check for virtualization support
$ egrep --color -i &quot;svm|vmx&quot; /proc/cpuinfo
flags: ... vmx smx ... vnmi flexpriority ept vpid ...

# Alternative check
$ grep -E &quot;(vmx|svm)&quot; /proc/cpuinfo






KVM Module Configuration on Host

Proper KVM module configuration is essential for enabling nested virtualization support.



Check Current KVM Module Status

Verify Loaded Modules

# Check currently loaded KVM modules
$ lsmod | grep kvm


Expected output when properly loaded:
kvm_intel             487424  18
kvm                  1404928  13 kvm_intel
irqbypass              12288  1 kvm


Output when modules are not loaded:
$ lsmod | grep kvm
# (no output)


Module Information Check

# Check KVM Intel module information
$ modinfo kvm_intel | grep -i nested
parm:           nested_early_check:bool
parm:           nested:bool

# Check KVM AMD module information  
$ modinfo kvm_amd | grep -i nested
parm:           nested:bool




Enable Nested Virtualization Temporarily

Unload Existing KVM Modules

For Intel Systems:
# Remove Intel KVM module
$ sudo modprobe -r kvm_intel

# Verify removal
$ lsmod | grep kvm_intel
# (should show no output)


For AMD Systems:
# Remove AMD KVM module
$ sudo modprobe -r kvm_amd

# Verify removal
$ lsmod | grep kvm_amd
# (should show no output)


Reload Modules with Nested Support

For Intel Systems:
# Load Intel KVM module with nested virtualization
$ sudo modprobe kvm_intel nested=1

# Verify nested support is enabled
$ cat /sys/module/kvm_intel/parameters/nested
Y


For AMD Systems:
# Load AMD KVM module with nested virtualization
$ sudo modprobe kvm_amd nested=1

# Verify nested support is enabled
$ cat /sys/module/kvm_amd/parameters/nested
Y




Enable Nested Virtualization Permanently

Create Persistent Configuration

To make nested virtualization permanent across reboots, create a module configuration file:

# Create or edit KVM configuration file
$ sudo vi /etc/modprobe.d/kvm.conf


For Intel hosts, add:
options kvm_intel nested=1


For AMD hosts, add:
options kvm_amd nested=1


Apply Configuration

# Update initramfs (Ubuntu/Debian)
$ sudo update-initramfs -u

# Update initramfs (CentOS/RHEL/Fedora)
$ sudo dracut -f

# Reboot to apply changes permanently
$ sudo reboot


Verify Permanent Configuration

# After reboot, check nested support
$ cat /sys/module/kvm_intel/parameters/nested
Y

# Verify module parameters
$ modinfo kvm_intel | grep nested






Guest VM Nested Virtualization Configuration

Configure guest VMs to support nested virtualization through CPU passthrough and feature enabling.



Method A: Using virsh CLI

Edit VM Configuration

# Access virsh interactive shell
$ virsh
virsh # list --all
 Id    Name                           State
----------------------------------------------------
 -     ubuntu-guest                   shut off
 -     windows-guest                  shut off

# Edit VM configuration
virsh # edit ubuntu-guest


Configure CPU for Nested Virtualization

Replace the existing CPU configuration with:

&amp;lt;cpu mode=&apos;host-passthrough&apos; check=&apos;none&apos;&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


For AMD systems, use:
&amp;lt;cpu mode=&apos;host-passthrough&apos; check=&apos;none&apos;&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;svm&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


Save and Restart VM

# In virsh shell
virsh # shutdown ubuntu-guest
virsh # start ubuntu-guest




Method B: Using Virt-Manager GUI

Step-by-Step GUI Configuration


  Open Virt-Manager
    $ virt-manager
    
  
  Access VM Details
    
      Right-click on the target VM
      Select “Open” → “Details”
    
  
  Configure Processor Settings
    
      Navigate to “Processor” tab
      Set CPU mode to “host-passthrough”
      Check “Copy host CPU configuration”
    
  
  Apply and Restart
    
      Click “Apply”
      Restart the VM
    
  




Advanced CPU Configuration

Comprehensive Feature Set

&amp;lt;cpu mode=&apos;host-passthrough&apos; check=&apos;none&apos; migratable=&apos;on&apos;&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;ept&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vpid&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;unrestricted_guest&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;flexpriority&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vnmi&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


CPU Topology Configuration

&amp;lt;cpu mode=&apos;host-passthrough&apos;&amp;gt;
  &amp;lt;topology sockets=&apos;1&apos; cores=&apos;4&apos; threads=&apos;2&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;






Verifying Nested Virtualization in Guest VM

Confirm that nested virtualization is properly enabled within the guest VM.



Check Virtualization Support in Guest

Verify VT-x Features

# Inside the guest VM, check for virtualization flags
$ egrep --color -i &quot;svm|vmx&quot; /proc/cpuinfo
flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts


Check KVM Module in Guest

# Install KVM in guest VM (if not already installed)
$ sudo apt update &amp;amp;&amp;amp; sudo apt install -y qemu-kvm libvirt-daemon-system

# Check nested virtualization support
$ cat /sys/module/kvm_intel/parameters/nested
Y

# Verify KVM module is loaded
$ lsmod | grep kvm
kvm_intel             487424  0
kvm                  1404928  1 kvm_intel


Test Nested VM Creation







Performance Optimization for Nested Virtualization

Optimize nested virtualization performance through proper CPU, memory, and I/O configuration.



CPU Performance Optimization

NUMA-Aware Configuration

&amp;lt;cpu mode=&apos;host-passthrough&apos;&amp;gt;
  &amp;lt;numa&amp;gt;
    &amp;lt;cell id=&apos;0&apos; cpus=&apos;0-7&apos; memory=&apos;8388608&apos; unit=&apos;KiB&apos;/&amp;gt;
  &amp;lt;/numa&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


CPU Pinning for Performance

&amp;lt;vcpu placement=&apos;static&apos; cpuset=&apos;0-7&apos;&amp;gt;8&amp;lt;/vcpu&amp;gt;
&amp;lt;cputune&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;0&apos; cpuset=&apos;0&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;1&apos; cpuset=&apos;1&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;2&apos; cpuset=&apos;2&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;3&apos; cpuset=&apos;3&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;4&apos; cpuset=&apos;4&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;5&apos; cpuset=&apos;5&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;6&apos; cpuset=&apos;6&apos;/&amp;gt;
  &amp;lt;vcpupin vcpu=&apos;7&apos; cpuset=&apos;7&apos;/&amp;gt;
&amp;lt;/cputune&amp;gt;


Hyper-Threading Considerations

# Check hyper-threading status
$ lscpu | grep &quot;Thread(s) per core&quot;
Thread(s) per core:  2

# For optimal performance, use only physical cores
&amp;lt;vcpu placement=&apos;static&apos; cpuset=&apos;0,2,4,6&apos;&amp;gt;4&amp;lt;/vcpu&amp;gt;




Memory Optimization

Huge Pages Configuration

# Configure huge pages on host
$ echo 1024 | sudo tee /proc/sys/vm/nr_hugepages

# Make permanent
$ echo &apos;vm.nr_hugepages = 1024&apos; | sudo tee -a /etc/sysctl.conf

# Configure in VM XML


&amp;lt;memoryBacking&amp;gt;
  &amp;lt;hugepages/&amp;gt;
&amp;lt;/memoryBacking&amp;gt;


Memory Ballooning

&amp;lt;devices&amp;gt;
  &amp;lt;memballoon model=&apos;virtio&apos;&amp;gt;
    &amp;lt;address type=&apos;pci&apos; domain=&apos;0x0000&apos; bus=&apos;0x00&apos; slot=&apos;0x08&apos; function=&apos;0x0&apos;/&amp;gt;
  &amp;lt;/memballoon&amp;gt;
&amp;lt;/devices&amp;gt;




I/O Performance Optimization

Storage Configuration

&amp;lt;disk type=&apos;file&apos; device=&apos;disk&apos;&amp;gt;
  &amp;lt;driver name=&apos;qemu&apos; type=&apos;qcow2&apos; cache=&apos;writeback&apos; io=&apos;threads&apos;/&amp;gt;
  &amp;lt;source file=&apos;/var/lib/libvirt/images/vm.qcow2&apos;/&amp;gt;
  &amp;lt;target dev=&apos;vda&apos; bus=&apos;virtio&apos;/&amp;gt;
&amp;lt;/disk&amp;gt;


Network Performance

&amp;lt;interface type=&apos;bridge&apos;&amp;gt;
  &amp;lt;source bridge=&apos;virbr0&apos;/&amp;gt;
  &amp;lt;model type=&apos;virtio&apos;/&amp;gt;
  &amp;lt;driver name=&apos;vhost&apos; queues=&apos;4&apos;/&amp;gt;
&amp;lt;/interface&amp;gt;






Direct QEMU/KVM Command Line Usage

For advanced users who prefer direct QEMU command line control over libvirt.



Basic Nested Virtualization with QEMU

Simple Configuration



Advanced VT-x Features



Performance-Optimized Configuration







Performance Monitoring and Benchmarking

Monitor and benchmark nested virtualization performance to ensure optimal configuration.



VT-x Feature Utilization Monitoring

Check VT-x Usage in Guest



Monitor VM Exits

# Check KVM statistics
$ cat /sys/kernel/debug/kvm/exits
exits                 1234567
host_state_reload     12345
hypercalls           4567
request_irq          8901




Performance Benchmarking

CPU Performance Testing

# CPU performance benchmark
$ sysbench cpu --cpu-max-prime=20000 run
sysbench 1.0.18 (using system LuaJIT 2.1.0-beta3)

Running the test with following options:
Number of threads: 1
Initializing random number generator from current time

Prime numbers limit: 20000

Initializing worker threads...

Threads started!

CPU speed:
    events per second:  1234.56

General statistics:
    total time:                          10.0001s
    total number of events:              12346

# Disk I/O benchmark
$ time dd if=/dev/zero of=/tmp/test bs=1M count=1000
1000+0 records in
1000+0 records out
1048576000 bytes (1.0 GB, 1000 MiB) copied, 2.34567 s, 447 MB/s

real    0m2.346s
user    0m0.001s
sys     0m0.987s


Memory Performance Testing

# Memory bandwidth test
$ sysbench memory --memory-block-size=1M --memory-total-size=10G run

# Memory latency test
$ lat_mem_rd -s 512 -N 2 -t






Troubleshooting Common Issues

Resolve frequent problems encountered in nested virtualization setups.



Hardware and BIOS Issues

Problem: VT-x Not Available

Error Messages:


Solutions:
# 1. Check BIOS settings
# - Ensure VT-x is enabled in BIOS/UEFI
# - Disable Secure Boot if required
# - Enable VT-d for I/O virtualization

# 2. Verify CPU support
$ egrep -c &apos;(vmx|svm)&apos; /proc/cpuinfo
8  # Should be &amp;gt; 0

# 3. Check for conflicting software
$ sudo systemctl status vmware
$ sudo systemctl status virtualbox




Module Configuration Issues

Problem: Nested Virtualization Not Supported

Check Current Status:
$ cat /sys/module/kvm_intel/parameters/nested
N


Solutions:
# 1. Reload module with nested support
$ sudo modprobe -r kvm_intel
$ sudo modprobe kvm_intel nested=1

# 2. Make permanent
$ echo &apos;options kvm_intel nested=1&apos; | sudo tee /etc/modprobe.d/kvm.conf

# 3. Update initramfs
$ sudo update-initramfs -u
$ sudo reboot




Guest VM Configuration Issues

Problem: VT-x Not Recognized in Guest

Check Guest Configuration:
$ virsh dumpxml vm-name | grep -A5 -B5 cpu
&amp;lt;cpu mode=&apos;custom&apos; match=&apos;exact&apos; check=&apos;partial&apos;&amp;gt;
  &amp;lt;model fallback=&apos;allow&apos;&amp;gt;Skylake-Client-IBRS&amp;lt;/model&amp;gt;
&amp;lt;/cpu&amp;gt;


Solution: Update CPU Configuration:
&amp;lt;cpu mode=&apos;host-passthrough&apos; check=&apos;none&apos;&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


Apply Changes:
$ virsh shutdown vm-name
$ virsh edit vm-name
# Make changes and save
$ virsh start vm-name




Performance Issues

Problem: Poor Nested VM Performance

Diagnostic Commands:
# Check CPU usage
$ top -p $(pgrep qemu)

# Monitor I/O statistics
$ iostat -x 1

# Check memory usage
$ free -h &amp;amp;&amp;amp; cat /proc/meminfo | grep -i huge


Optimization Solutions:
# 1. Enable CPU pinning
$ virsh vcpupin vm-name 0 0
$ virsh vcpupin vm-name 1 1

# 2. Configure huge pages
$ echo 2048 | sudo tee /proc/sys/vm/nr_hugepages

# 3. Optimize storage
$ virsh edit vm-name
# Add: &amp;lt;driver name=&apos;qemu&apos; type=&apos;qcow2&apos; cache=&apos;writeback&apos;/&amp;gt;






Security Considerations

Understanding and mitigating security risks associated with nested virtualization.



Security Risks in Nested Virtualization

1. VM Escape Vulnerabilities


  Risk Factors
  
    Increased Attack Surface: Multiple virtualization layers create more potential escape vectors
    Hardware Feature Exposure: Guest VMs gain access to host CPU features
    Side-Channel Attacks: Hardware features can leak information across VM boundaries
  


2. Resource Exhaustion Attacks

# Monitor resource usage in nested environments
$ virsh domstats --cpu-total --memory --block --balloon vm-name

# Set resource limits
$ virsh edit vm-name


&amp;lt;memtune&amp;gt;
  &amp;lt;hard_limit unit=&apos;KiB&apos;&amp;gt;8388608&amp;lt;/hard_limit&amp;gt;
  &amp;lt;soft_limit unit=&apos;KiB&apos;&amp;gt;6291456&amp;lt;/soft_limit&amp;gt;
&amp;lt;/memtune&amp;gt;
&amp;lt;cputune&amp;gt;
  &amp;lt;shares&amp;gt;2048&amp;lt;/shares&amp;gt;
  &amp;lt;period&amp;gt;100000&amp;lt;/period&amp;gt;
  &amp;lt;quota&amp;gt;200000&amp;lt;/quota&amp;gt;
&amp;lt;/cputune&amp;gt;




Security Hardening Measures

Disable Unnecessary CPU Features

&amp;lt;cpu mode=&apos;host-passthrough&apos;&amp;gt;
  &amp;lt;feature policy=&apos;require&apos; name=&apos;vmx&apos;/&amp;gt;
  &amp;lt;!-- Disable potentially risky features --&amp;gt;
  &amp;lt;feature policy=&apos;disable&apos; name=&apos;invtsc&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;disable&apos; name=&apos;amd-stibp&apos;/&amp;gt;
  &amp;lt;feature policy=&apos;disable&apos; name=&apos;spec-ctrl&apos;/&amp;gt;
&amp;lt;/cpu&amp;gt;


Network Isolation

&amp;lt;!-- Use isolated networks for nested VMs --&amp;gt;
&amp;lt;interface type=&apos;network&apos;&amp;gt;
  &amp;lt;source network=&apos;isolated&apos;/&amp;gt;
  &amp;lt;model type=&apos;virtio&apos;/&amp;gt;
&amp;lt;/interface&amp;gt;


# Create isolated network
$ virsh net-define /dev/stdin &amp;lt;&amp;lt;EOF
&amp;lt;network&amp;gt;
  &amp;lt;name&amp;gt;isolated&amp;lt;/name&amp;gt;
  &amp;lt;bridge name=&apos;virbr1&apos; stp=&apos;on&apos; delay=&apos;0&apos;/&amp;gt;
  &amp;lt;domain name=&apos;isolated&apos;/&amp;gt;
  &amp;lt;ip address=&apos;192.168.100.1&apos; netmask=&apos;255.255.255.0&apos;&amp;gt;
    &amp;lt;dhcp&amp;gt;
      &amp;lt;range start=&apos;192.168.100.2&apos; end=&apos;192.168.100.254&apos;/&amp;gt;
    &amp;lt;/dhcp&amp;gt;
  &amp;lt;/ip&amp;gt;
&amp;lt;/network&amp;gt;
EOF

$ virsh net-start isolated
$ virsh net-autostart isolated


Access Control and Monitoring

# Monitor VM activities
$ journalctl -u libvirtd -f

# Set up SELinux/AppArmor policies
$ sudo setsebool -P virt_use_execmem 1

# Implement logging for nested VMs
$ echo &apos;log_level = 1&apos; | sudo tee -a /etc/libvirt/libvirtd.conf
$ sudo systemctl restart libvirtd






Key Points


  KVM Nested Virtualization Summary
  
    
      Hardware Requirements
      - Intel VT-x or AMD-V CPU support required
      - BIOS/UEFI virtualization features must be enabled
      - Sufficient CPU cores and memory for nested workloads
      - EPT/RVI support recommended for optimal performance
    
    
      Configuration Steps
      - Enable nested parameter in KVM modules
      - Configure guest VMs with host-passthrough CPU mode
      - Enable specific CPU features (vmx/svm, ept, vpid)
      - Optimize performance through CPU pinning and huge pages
    
    
      Use Cases and Considerations
      - Ideal for development, testing, and CI/CD environments
      - Cloud platform testing and virtualization research
      - Performance overhead: 10-30% compared to native virtualization
      - Security implications require careful consideration and hardening
    
  






Conclusion

KVM Nested Virtualization enables powerful VM-within-VM scenarios that are invaluable for development, testing, and cloud platform evaluation. While the setup requires careful configuration of hardware features, kernel modules, and guest VM settings, the resulting flexibility makes it an essential tool for modern virtualization workflows.

The key to successful nested virtualization lies in proper hardware configuration, optimal CPU feature utilization, and performance tuning. By following the guidelines in this comprehensive guide, you can build robust nested virtualization environments that meet your specific requirements.



Best Practices Recap


  Verify hardware support before attempting configuration
  Enable all relevant VT-x features for optimal performance
  Use host-passthrough CPU mode for maximum compatibility
  Implement proper resource limits to prevent resource exhaustion
  Monitor performance and adjust configurations as needed




Future Applications

As container technologies, cloud-native architectures, and edge computing continue evolving, nested virtualization will remain crucial for testing complex deployment scenarios and developing virtualization-aware applications.

For DevOps, cloud testing, and container-based virtualization practice, start exploring nested virtualization today!





References


  Intel VT-x Architecture Specification
  KVM Nested Virtualization Documentation
  libvirt Domain XML Format Guide
  QEMU CPU Models and Features
  Red Hat Virtualization Guide
  Ubuntu KVM Nested Virtualization
  Fedora Virtualization Guide

",
            "wordcount": "3764",
            "inLanguage": "en",
            "dateCreated": "2025-12-14/",
            "datePublished": "2025-12-14/",
            "dateModified": "2025-12-14/",
            "author": {
                "@type": "Person",
                "name": "Somaz",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "DevOps Engineer",
                "url": "https://somaz.blog/authors/somaz/",
                "sameAs": [
                    "https://github.com/somaz94","https://www.linkedin.com/in/somaz"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "somaz",
                "url": "https://somaz.blog/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://somaz.blog/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "VIRTUALIZATION",
            "articleSection": "VIRTUALIZATION",
            "keywords": ["kvm","nested-virtualization","vt-x","hypervisor","virtualization","qemu","libvirt"]
        }
        </script>
    </body>
</html>
