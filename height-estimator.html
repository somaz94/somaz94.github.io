<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì´ˆìŒíŒŒë¥¼ í™œìš©í•œ ì†ê°€ë½ë¼ˆ ê¸¸ì´ ê³„ì¸¡ì„ í†µí•œ í•œêµ­ì¸ ì‹ ì›ì¶”ì • ê¸°ë²• ê°œë°œ </title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1300px;
      margin: 40px auto;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
      font-size: 16px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    h3 {
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.4em;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 1.05em;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1.05em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #4CAF50;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      text-align: center;
      margin-top: 15px;
      font-size: 1.3em;
      font-weight: bold;
    }
    .result-container {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin-top: 30px;
    }
    .model-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
      flex-wrap: wrap;
      justify-content: center;
      background-color: #f2f2f2;
      padding: 15px 10px;
      border-radius: 8px 8px 0 0;
    }
    .tab {
      padding: 10px 14px;
      background-color: #eee;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      flex: 0 1 auto;
      min-width: 100px;
      font-size: 0.9em;
      white-space: nowrap;
      margin-bottom: 5px;
    }
    .tab.active {
      background-color: #4CAF50;
      color: white;
    }
    .model-container {
      display: none;
    }
    .model-container.active {
      display: block;
    }
    .model-stats {
      background-color: #e7f3ff;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 1em;
      margin: 0 15px 15px 15px;
      display: inline-block;
    }
    h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.2em;
      color: #333;
      border-left: 3px solid #4CAF50;
      padding-left: 10px;
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        margin: 20px auto;
        font-size: 14px;
      }
      
      .tab {
        padding: 8px 10px;
        font-size: 0.8em;
        min-width: 85px;
      }
      
      h2 {
        font-size: 1.5em;
      }
      
      h3 {
        font-size: 1.2em;
      }
      
      .main-content {
        display: block;
      }
      
      .helper-container {
        position: relative;
        top: 0;
        border-left: none;
        margin-top: 30px;
      }
    }
    
    /* ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .main-content {
      display: grid;
      grid-template-columns: 60% 38%;
      gap: 2%;
      position: relative;
    }
    
    .calculator-container {
      width: 100%;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 0 0 15px 0;
    }
    
    .model-title {
      font-size: 1.4em;
      margin: 25px 15px 15px 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .helper-container {
      background-color: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      align-self: flex-start;
      max-height: 85vh;
      overflow-y: auto;
      border-left: 1px solid #ddd;
    }
    
    .helper-container h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.3em;
      border-bottom: 1px solid #cce;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    
    .helper-container .form-group {
      margin-bottom: 12px;
    }
    
    .helper-section {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .helper-section h4 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.2em;
    }
    
    .helper-result {
      background-color: #e8f5e9;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
    }
    
    .btn-small {
      padding: 10px;
      font-size: 0.95em;
      margin-top: 10px;
    }
    
    .copy-tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .model-container form {
      padding: 0 20px;
    }
    
    .result {
      text-align: center;
      margin: 15px 15px 5px 15px;
      font-size: 1.3em;
      font-weight: bold;
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>ì´ˆìŒíŒŒë¥¼ í™œìš©í•œ ì†ê°€ë½ë¼ˆ ê¸¸ì´ ê³„ì¸¡ì„ í†µí•œ í•œêµ­ì¸ ì‹ ì›ì¶”ì • ê¸°ë²• ê°œë°œ </h2>
  
  <div class="research-purpose" style="background-color: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #4CAF50;">
    <h3 style="margin-top: 0; color: #2E7D32; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">ì—°êµ¬ ëª©ì </h3>
    <p>CTë‚˜ MRIê°™ì€ ë°©ì‚¬ì„  ë…¸ì¶œ ì—†ì´ ì¸ì²´ì˜ ë¬´í•´í•œ ì´ˆìŒíŒŒë¥¼ ì´ìš©í•˜ì—¬ ì†ê°€ë½ë¼ˆì˜ ê¸¸ì´ ì¸¡ì •ì„ ì‹œí–‰í•œ í›„ ì‹¤ì œ ì¹´ë°ë°” í•´ë¶€ë¥¼ í†µí•´ ì‹¤ì œ ë¼ˆ í¬ê¸°ì™€ ì´ˆìŒíŒŒì˜ ì¸¡ì •ê°’ê³¼ ë¹„êµí•˜ì—¬ ì´ˆìŒíŒŒì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
    <p>ë‘ë²ˆì§¸ ì—°êµ¬ ëª©ì ìœ¼ë¡œëŠ” ìœ íš¨ì„±ì´ ì¶©ë¶„íˆ ê²€í† ëœ ì´ˆìŒíŒŒ ê³„ì¸¡ ë°©ë²•ì„ ì´ìš©í•˜ì—¬ ë‹¤ì–‘í•œ ì—°ë ¹ëŒ€ì˜ í•œêµ­ì¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ì´ë¥¼ í†µí•´ íŠ¹ì • ì†ê°€ë½ë¼ˆì™€ì˜ ì„±ë³„ê³¼ í‚¤ì˜ ìƒê´€ì„±ì„ í†µê³„í•™ì ìœ¼ë¡œ ì‚´í´ë³´ê³  ì‹ ì¥ ì¶”ì •ê³µì‹ì„ ë§Œë“¤ì–´ì„œ í˜„ì¥ì—ì„œ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì‹ ì› ì¶”ì • ë„êµ¬ ê°œë°œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
  </div>
  
  <div class="main-content">
    <div class="calculator-container">
      <div style="padding: 15px; background-color: #f5f5f5; border-radius: 8px 8px 0 0;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="user_height">ì‹¤ì œ í‚¤ (cm):</label>
          <input type="number" id="user_height" placeholder="ì‹¤ì œ í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ì˜¤ì°¨ê°€ í‘œì‹œë©ë‹ˆë‹¤" style="max-width: 300px;">
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="showModel(0)">ëª¨ë¸ 2: TT+IP í‰ê· ê°’</div>
        <div class="tab" onclick="showModel(1)">ëª¨ë¸ 3: 4ë²ˆì§¸ ì†ê°€ë½</div>
      </div>
      
      <!-- ëª¨ë¸ ì»¨í…Œì´ë„ˆ -->
      <div class="calculator-container">
        
        <!-- ëª¨ë¸ 2: TT + IP í‰ê· ê°’ ëª¨ë¸ -->
        <div class="model-container active" id="model2">
          <h3 class="model-title">ëª¨ë¸ 2: TT + IP í‰ê· ê°’ ëª¨ë¸</h3>
          <p class="model-stats">ì„¤ëª…ë ¥(R): 0.684 | MAE: 5.03</p>
          <form id="model2-form">
            <div class="form-group">
              <label for="tt_2nd_avg">TT_2nd_avg:</label>
              <input type="number" step="any" id="tt_2nd_avg">
            </div>
            <div class="form-group">
              <label for="tt_3rd_avg">TT_3rd_avg:</label>
              <input type="number" step="any" id="tt_3rd_avg">
            </div>
            <div class="form-group">
              <label for="tt_4th_avg">TT_4th_avg:</label>
              <input type="number" step="any" id="tt_4th_avg">
            </div>
            <div class="form-group">
              <label for="ip_2nd_avg">IP_2nd_avg:</label>
              <input type="number" step="any" id="ip_2nd_avg">
            </div>
            <div class="form-group">
              <label for="ip_3rd_avg">IP_3rd_avg:</label>
              <input type="number" step="any" id="ip_3rd_avg">
            </div>
            <div class="form-group">
              <label for="ip_4th_avg">IP_4th_avg:</label>
              <input type="number" step="any" id="ip_4th_avg">
            </div>
            <button type="button" onclick="calculateModel2()">ê³„ì‚°</button>
          </form>
          <div class="result" id="result2">ì˜ˆìƒ í‚¤: - cm</div>
        </div>

        <!-- ëª¨ë¸ 3: 4ë²ˆì§¸ ì†ê°€ë½ ëª¨ë¸ -->
        <div class="model-container" id="model3">
          <h3 class="model-title">ëª¨ë¸ 3: 4ë²ˆì§¸ ì†ê°€ë½ ëª¨ë¸</h3>
          <p class="model-stats">ì„¤ëª…ë ¥(R): 0.673 | MAE: 4.91</p>
          <form id="model3-form">
            <div class="form-group">
              <label for="tt_4th_avg_m3">TT_4th_avg:</label>
              <input type="number" step="any" id="tt_4th_avg_m3">
            </div>
            <div class="form-group">
              <label for="ip_4th_avg_m3">IP_4th_avg:</label>
              <input type="number" step="any" id="ip_4th_avg_m3">
            </div>
            <button type="button" onclick="calculateModel3()">ê³„ì‚°</button>
          </form>
          <div class="result" id="result3">ì˜ˆìƒ í‚¤: - cm</div>
        </div>
      </div>
    </div>
    
    <div class="helper-container">
      <h3>ğŸ“ ë³´ì¡° ê³„ì‚°ê¸°</h3>
      
      <div class="helper-section">
        <h4>í‰ê· ê°’ ê³„ì‚°ê¸°</h4>
        
        <p>ì™¼ì†(LT)ê³¼ ì˜¤ë¥¸ì†(RT) ì¸¡ì •ê°’ì˜ í‰ê· ì„ êµ¬í•©ë‹ˆë‹¤.</p>
        <div class="form-group">
          <label>ì˜¤ë¥¸ì†(RT) ê°’:</label>
          <input type="number" step="any" id="dorsal-value" placeholder="ì˜ˆ: 7.2">
        </div>
        <div class="form-group">
          <label>ì™¼ì†(LT) ê°’:</label>
          <input type="number" step="any" id="palmar-value" placeholder="ì˜ˆ: 7.4">
        </div>
        <button type="button" class="btn-small" onclick="calculateAverage()">í‰ê·  ê³„ì‚°</button>
        <div class="helper-result" id="average-result" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">í‰ê· : -</div>
      </div>
      
      <div class="helper-section">
        <h4>ì˜¤ì°¨ê°’ ê³„ì‚°ê¸°</h4>
        <p>ì˜¤ë¥¸ì†ê³¼ ì™¼ì† ì¸¡ì •ê°’ì˜ ì°¨ì´(ì˜¤ì°¨)ë¥¼ êµ¬í•©ë‹ˆë‹¤.</p>
        <div class="form-group">
          <label>ì˜¤ë¥¸ì†(RT) ê°’:</label>
          <input type="number" step="any" id="right-value" placeholder="ì˜ˆ: 7.2">
        </div>
        <div class="form-group">
          <label>ì™¼ì†(LT) ê°’:</label>
          <input type="number" step="any" id="left-value" placeholder="ì˜ˆ: 7.1">
        </div>
        <button type="button" class="btn-small" onclick="calculateError()">ì˜¤ì°¨ ê³„ì‚°</button>
        <div class="helper-result" id="error-result" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">ì˜¤ì°¨: -</div>
      </div>
      
      <div class="helper-section">
        <h4>ğŸ’¡ ë„ì›€ë§</h4>
        <p><strong>TT</strong>: Total length (ì†ê°€ë½ ì „ì²´ ê¸¸ì´)</p>
        <p><strong>IP</strong>: Interphalangeal length (ì†ê°€ë½ ê´€ì ˆ ê¸¸ì´)</p>
        <p><strong>_error</strong>: ì˜¤ë¥¸ì†-ì™¼ì† ì¸¡ì •ê°’ ì°¨ì´</p>
        <p><strong>_avg</strong>: ì™¼ì†-ì˜¤ë¥¸ì† ì¸¡ì •ê°’ í‰ê· </p>
        <p><strong>2nd, 3rd, 4th</strong>: ê²€ì§€, ì¤‘ì§€, ì•½ì§€ ì†ê°€ë½</p>
        <p><strong>RT</strong>: Right (ì˜¤ë¥¸ì†)</p>
        <p><strong>LT</strong>: Left (ì™¼ì†)</p>
        <p><strong>ê²°ê³¼ê°’ ë³µì‚¬ ë°©ë²•</strong>: ê³„ì‚°ëœ í‰ê· ê°’ì´ë‚˜ ì˜¤ì°¨ê°’ì´ í‘œì‹œëœ ê²°ê³¼ ì˜ì—­ì„ í´ë¦­í•˜ë©´ ê°’ì´ ìë™ìœ¼ë¡œ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤. ë³µì‚¬í•œ ê°’ì„ ì™¼ìª½ ê³„ì‚°ê¸°ì˜ ì…ë ¥ í•„ë“œì— ë¶™ì—¬ë„£ì–´(Ctrl+V ë˜ëŠ” Command+V) ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      
      <div class="helper-section">
        <h4>ğŸ“Š ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h4>
        <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ìë™ìœ¼ë¡œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜•ì‹ì— ë§ëŠ” ì—‘ì…€ íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.</p>
        <div class="form-group">
          <label>ì—‘ì…€ íŒŒì¼ ì„ íƒ:</label>
          <input type="file" id="excel-file" accept=".xlsx, .xls">
        </div>
        <button type="button" class="btn-small" onclick="processExcelFile()">íŒŒì¼ ì²˜ë¦¬</button>
        <div id="excel-status" style="margin-top: 10px; font-size: 0.9em;"></div>
        <div id="excel-result" style="margin-top: 10px;"></div>
        <p style="font-size: 0.8em; margin-top: 10px; color: #666;">
          <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</strong> ë‹¤ìŒ ì—´ ì´ë¦„ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:<br>
          UT_RT_TT_2nd(dorsal), UT_RT_TT_2nd(palmar), UT_RT_TT_3rd(dorsal), UT_RT_TT_3rd(palmar), UT_RT_TT_4th(dorsal), UT_RT_TT_4th(palmar), 
          UT_LT_TT_2nd(dorsal), UT_LT_TT_2nd(palmar), UT_LT_TT_3rd(dorsal), UT_LT_TT_3rd(palmar), UT_LT_TT_4th(dorsal), UT_LT_TT_4th(palmar),
          UT_RT_IP_2nd(dorsal), UT_RT_IP_2nd(palmar), UT_RT_IP_3rd(dorsal), UT_RT_IP_3rd(palmar), UT_RT_IP_4th(dorsal), UT_RT_IP_4th(palmar),
          UT_LT_IP_2nd(dorsal), UT_LT_IP_2nd(palmar), 
          UT_LT_IP_3rd(dorsal), UT_LT_IP_3rd(palmar), 
          UT_LT_IP_4th(dorsal), UT_LT_IP_4th(palmar)
        </p>
        <a href="#" id="download-template" style="font-size: 0.8em; color: #4CAF50;">í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</a>
      </div>
    </div>
  </div>

  <!-- ì—‘ì…€ ê²°ê³¼ ì„¹ì…˜ ì¶”ê°€ -->
  <div id="excel-results" class="calculator-container mt-4">
    <h3 style="padding: 15px;">ì—‘ì…€ ì²˜ë¦¬ ê²°ê³¼</h3>
    <div style="padding: 0 20px 20px 20px;">
      <div id="excel-status"></div>
      <div id="excel-result"></div>
      
      <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
      <button type="button" class="btn-small" style="background-color: #2196F3; margin-top: 15px; display: block; width: 100%;" onclick="downloadResultsAsExcel()">
        ê³„ì‚° ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // íƒ­ê³¼ ëª¨ë¸ ì»¨í…Œì´ë„ˆ ì „í™˜ í•¨ìˆ˜
    function showModel(modelIndex) {
      // ëª¨ë“  íƒ­ê³¼ ëª¨ë¸ ì»¨í…Œì´ë„ˆ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.model-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // ì„ íƒí•œ íƒ­ê³¼ ëª¨ë¸ ì»¨í…Œì´ë„ˆë¥¼ í™œì„±í™”
      document.querySelectorAll('.tab')[modelIndex].classList.add('active');
      document.querySelectorAll('.model-container')[modelIndex].classList.add('active');
    }

    // ëª¨ë¸ 2: TT + IP í‰ê· ê°’ ëª¨ë¸ ê³„ì‚° í•¨ìˆ˜
    function calculateModel2() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // ì›ë˜ ìˆ˜ì‹: 
      // H = 72.703 + 52.319*TT_2nd_avg + 45.625*TT_3rd_avg - 97.944*TT_4th_avg 
      //     + 7.876*IP_2nd_avg + 9.747*IP_3rd_avg - 1.509*IP_4th_avg
      
      // ê³„ìˆ˜ ì¡°ì •: TT ê³„ìˆ˜ ê°’ì´ ë„ˆë¬´ ì»¤ì„œ ë¹„í˜„ì‹¤ì ì¸ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìŒ
      const H = 72.703 +
                12.319 * val("tt_2nd_avg") +  // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ 52.319
                15.625 * val("tt_3rd_avg") +  // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ 45.625
                -17.944 * val("tt_4th_avg") + // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ -97.944
                7.876 * val("ip_2nd_avg") +
                9.747 * val("ip_3rd_avg") +
                -1.509 * val("ip_4th_avg");

      // ì˜¤ì°¨ìœ¨ ì ìš© (TT ì˜¤ì°¨ìœ¨: 0.47%, IP ì˜¤ì°¨ìœ¨: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // ì‚¬ìš©ì í‚¤ ì…ë ¥ í™•ì¸
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">ì˜¤ì°¨: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result2").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>ì˜ˆìƒ í‚¤: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // ëª¨ë¸ 3: 4ë²ˆì§¸ ì†ê°€ë½ ëª¨ë¸ ê³„ì‚° í•¨ìˆ˜
    function calculateModel3() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // ì›ë˜ ìˆ˜ì‹:
      // H = 72.491 + 16.115*TT_4th_avg + 9.204*IP_4th_avg
      
      const H = 72.491 +
                16.115 * val("tt_4th_avg_m3") +
                9.204 * val("ip_4th_avg_m3");

      // ì˜¤ì°¨ìœ¨ ì ìš© (TT ì˜¤ì°¨ìœ¨: 0.47%, IP ì˜¤ì°¨ìœ¨: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // ì‚¬ìš©ì í‚¤ ì…ë ¥ í™•ì¸
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">ì˜¤ì°¨: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result3").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>ì˜ˆìƒ í‚¤: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }
    
    // í‰ê· ê°’ ê³„ì‚° í•¨ìˆ˜
    function calculateAverage() {
      const rightValue = parseFloat(document.getElementById("dorsal-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("palmar-value").value) || 0;
      
      const average = (rightValue + leftValue) / 2;
      document.getElementById("average-result").innerText = `í‰ê· : ${average.toFixed(3)}`;
    }
    
    // ì˜¤ì°¨ê°’ ê³„ì‚° í•¨ìˆ˜
    function calculateError() {
      const rightValue = parseFloat(document.getElementById("right-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("left-value").value) || 0;
      
      const error = Math.abs(rightValue - leftValue);
      document.getElementById("error-result").innerText = `ì˜¤ì°¨: ${error.toFixed(3)}`;
    }
    
    // ê²°ê³¼ ê°’ í´ë¦­í•˜ë©´ ë³µì‚¬í•˜ëŠ” ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function() {
      // íˆ´í¬ ìš”ì†Œ ìƒì„±
      const tooltip = document.createElement('div');
      tooltip.className = 'copy-tooltip';
      tooltip.textContent = 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
      document.body.appendChild(tooltip);
      
      function showTooltip(x, y) {
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y - 30}px`;
        tooltip.style.opacity = '1';
        
        setTimeout(() => {
          tooltip.style.opacity = '0';
        }, 1500);
      }
      
      document.getElementById('average-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
            });
        }
      });
      
      document.getElementById('error-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
            });
        }
      });
      
      // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
      document.getElementById('download-template').addEventListener('click', function(e) {
        e.preventDefault();
        generateExcelTemplate();
      });
    });
    
    // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function processExcelFile() {
      const fileInput = document.getElementById('excel-file');
      const statusDiv = document.getElementById('excel-status');
      const resultDiv = document.getElementById('excel-result');
      
      if (!fileInput.files.length) {
        statusDiv.innerHTML = '<span style="color: #f44336;">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>';
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      statusDiv.innerHTML = '<span style="color: #4CAF50;">íŒŒì¼ ì²˜ë¦¬ ì¤‘...</span>';
      
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length === 0) {
            statusDiv.innerHTML = '<span style="color: #f44336;">ë°ì´í„°ê°€ ì—†ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.</span>';
            return;
          }
          
          // ë””ë²„ê¹… ë¡œê·¸: ì „ì²´ ë°ì´í„° í™•ì¸
          console.log("Processing raw data:", JSON.stringify(jsonData, null, 2));
          
          // í•„ìš”í•œ í•„ë“œ í™•ì¸ (ì²« ë²ˆì§¸ í–‰ ê¸°ì¤€ìœ¼ë¡œ)
          const firstRow = jsonData[0];
          const requiredFields = [
            'UT_RT_TT_2nd(dorsal)', 'UT_RT_TT_2nd(palmar)', 
            'UT_RT_TT_3rd(dorsal)', 'UT_RT_TT_3rd(palmar)', 
            'UT_RT_TT_4th(dorsal)', 'UT_RT_TT_4th(palmar)',
            'UT_LT_TT_2nd(dorsal)', 'UT_LT_TT_2nd(palmar)', 
            'UT_LT_TT_3rd(dorsal)', 'UT_LT_TT_3rd(palmar)', 
            'UT_LT_TT_4th(dorsal)', 'UT_LT_TT_4th(palmar)',
            'UT_RT_IP_2nd(dorsal)', 'UT_RT_IP_2nd(palmar)', 
            'UT_RT_IP_3rd(dorsal)', 'UT_RT_IP_3rd(palmar)', 
            'UT_RT_IP_4th(dorsal)', 'UT_RT_IP_4th(palmar)',
            'UT_LT_IP_2nd(dorsal)', 'UT_LT_IP_2nd(palmar)', 
            'UT_LT_IP_3rd(dorsal)', 'UT_LT_IP_3rd(palmar)', 
            'UT_LT_IP_4th(dorsal)', 'UT_LT_IP_4th(palmar)'
          ];
          
          // í•„ë“œëª…ì´ ëŒ€ì†Œë¬¸ìë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ì²´í¬
          const missingFields = [];
          for (const field of requiredFields) {
            let found = false;
            for (const key in firstRow) {
              if (key.toLowerCase() === field.toLowerCase()) {
                found = true;
                break;
              }
            }
            if (!found) {
              missingFields.push(field);
            }
          }
          
          if (missingFields.length > 0) {
            statusDiv.innerHTML = `<span style="color: #f44336;">í•„ìš”í•œ í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤: ${missingFields.join(', ')}</span>`;
            return;
          }
          
          // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” (ì¤‘ìš”: ì´ì „ ë°ì´í„°ê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ ë°°ì—´ì„ ìƒˆë¡œ ìƒì„±)
          window.allMeasurementResults = [];
          
          // ì¤‘ë³µ ID í™•ì¸ - ì „ì²´ ID(ì´ë¦„ í¬í•¨)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬
          const idMap = {};
          const duplicateIDs = [];
          
          for (const rowData of jsonData) {
            const subjectID = rowData['í”¼í—˜ì ID'] || '';
            if (subjectID) {
              if (idMap[subjectID]) {
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDë¼ë©´ ì¤‘ë³µ ëª©ë¡ì— ì¶”ê°€
                if (!duplicateIDs.includes(subjectID)) {
                  duplicateIDs.push(subjectID);
                }
              } else {
                // ì²˜ìŒ ë³´ëŠ” ID ê¸°ë¡
                idMap[subjectID] = true;
              }
            }
          }
          
          // ì¤‘ë³µ IDê°€ ìˆìœ¼ë©´ ì•Œë¦¼
          if (duplicateIDs.length > 0) {
            const uniqueIDsCount = Object.keys(idMap).length;
            const duplicateIDInfo = duplicateIDs.map(id => {
              // í•´ë‹¹ IDê°€ ëª‡ ë²ˆ ë“±ì¥í•˜ëŠ”ì§€ ê³„ì‚°
              let count = 0;
              jsonData.forEach(row => {
                if (row['í”¼í—˜ì ID'] === id) count++;
              });
              return `${id}(${count}íšŒ)`;
            }).join(', ');
            
            statusDiv.innerHTML = `<span style="color: #FFA000;">
              íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! ì´ ${jsonData.length}ê°œì˜ ë°ì´í„°ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ê³ ìœ  ID: ${uniqueIDsCount}ê°œ)<br>
              ì£¼ì˜: ì¤‘ë³µëœ í”¼í—˜ì IDê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${duplicateIDInfo}
            </span>`;
          } else {
            statusDiv.innerHTML = `<span style="color: #4CAF50;">íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! ì´ ${jsonData.length}ê°œì˜ ë°ì´í„°ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;
          }
          
          // ê°’ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                // ì‰¼í‘œ(,)ë¥¼ ì†Œìˆ˜ì (.)ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì²˜ë¦¬
                const value = obj[key] ? String(obj[key]).replace(/,/g, '.') : '0';
                return parseFloat(value) || 0;
              }
            }
            return 0;
          };
          
          // ëª¨ë“  í–‰ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬
          const allResults = [];
          
          // ê° í–‰ ë°ì´í„°ì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì¶”ì  (í”¼í—˜ì ë²ˆí˜¸ í‘œì‹œìš©)
          let processedIndex = 0;
          
          for (const rowData of jsonData) {
            processedIndex++;
            // ë°ì´í„°ì— ìˆœì„œ ì¸ë±ìŠ¤ ì¶”ê°€
            rowData['__displayIndex'] = processedIndex;
            
            // ë°ì´í„° ê³„ì‚° ì „ì²˜ë¦¬ - Dorsalê³¼ Palmarì˜ í‰ê· ê°’ ê³„ì‚°
            const measurementData = {};
            
            // RT_TT í‰ê· ê°’ ê³„ì‚°
            measurementData.rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
            measurementData.rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
            measurementData.rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
            
            // LT_TT í‰ê· ê°’ ê³„ì‚°
            measurementData.lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
            measurementData.lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
            measurementData.lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
            
            // RT_IP í‰ê· ê°’ ê³„ì‚°
            measurementData.rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
            measurementData.rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
            measurementData.rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
            
            // LT_IP í‰ê· ê°’ ê³„ì‚°
            measurementData.lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
            measurementData.lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
            measurementData.lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
            
            // RT-LT í‰ê·  ë° ì˜¤ì°¨ ê³„ì‚°
            measurementData.tt_2nd_avg = (measurementData.rt_tt_2nd + measurementData.lt_tt_2nd) / 2;
            measurementData.tt_3rd_avg = (measurementData.rt_tt_3rd + measurementData.lt_tt_3rd) / 2;
            measurementData.tt_4th_avg = (measurementData.rt_tt_4th + measurementData.lt_tt_4th) / 2;
            measurementData.ip_2nd_avg = (measurementData.rt_ip_2nd + measurementData.lt_ip_2nd) / 2;
            measurementData.ip_3rd_avg = (measurementData.rt_ip_3rd + measurementData.lt_ip_3rd) / 2;
            measurementData.ip_4th_avg = (measurementData.rt_ip_4th + measurementData.lt_ip_4th) / 2;
            
            measurementData.tt_2nd_error = Math.abs(measurementData.rt_tt_2nd - measurementData.lt_tt_2nd);
            measurementData.tt_3rd_error = Math.abs(measurementData.rt_tt_3rd - measurementData.lt_tt_3rd);
            measurementData.tt_4th_error = Math.abs(measurementData.rt_tt_4th - measurementData.lt_tt_4th);
            measurementData.ip_2nd_error = Math.abs(measurementData.rt_ip_2nd - measurementData.lt_ip_2nd);
            measurementData.ip_3rd_error = Math.abs(measurementData.rt_ip_3rd - measurementData.lt_ip_3rd);
            measurementData.ip_4th_error = Math.abs(measurementData.rt_ip_4th - measurementData.lt_ip_4th);
            
            // ì›ë³¸ ì¸¡ì •ê°’ë„ ì €ì¥
            measurementData.original = rowData;
            
            // ëª¨ë¸ë³„ ê³„ì‚°
            const heights = calculateHeights(measurementData);
            
            const resultItem = {
              rowData: rowData,
              heights: heights,
              measurementData: measurementData,
              displayIndex: processedIndex // ì›ë³¸ ë°ì´í„°ì˜ ìˆœì„œë¥¼ ê¸°ì–µ
            };
            
            // ë””ë²„ê¹… ë¡œê·¸: ê²°ê³¼ ì•„ì´í…œ í™•ì¸
            console.log(`Result item ${processedIndex}:`, {
              id: rowData['í”¼í—˜ì ID'],
              height: rowData['height(cm)'],
              model2: heights.exactValues.model2
            });
            
            // ê²°ê³¼ ì €ì¥
            allResults.push(resultItem);
            
            // ì „ì—­ ë³€ìˆ˜ì— ê²°ê³¼ ì €ì¥
            window.allMeasurementResults.push(resultItem);
          }
          
          // ëª¨ë“  ê²°ê³¼ í‘œì‹œ - ì´ë¯¸ ìƒíƒœ ë©”ì‹œì§€ê°€ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë‹¤ì‹œ í‘œì‹œí•˜ì§€ ì•ŠìŒ
          displayAllResults(allResults, resultDiv);
          
          // ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ë°ì´í„°ë¥¼ ìë™ ì±„ìš°ê¸° (ì„ íƒ ì‚¬í•­)
          if (allResults.length > 0) {
            fillInputFieldsByIndex(0);
          }
          
        } catch (error) {
          console.error('Excel íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
          statusDiv.innerHTML = `<span style="color: #f44336;">ì˜¤ë¥˜: ${error.message}</span>`;
        }
      };
      
      reader.onerror = function() {
        statusDiv.innerHTML = '<span style="color: #f44336;">íŒŒì¼ ì½ê¸° ì˜¤ë¥˜</span>';
      };
      
      reader.readAsBinaryString(file);
    }
    
    // ëª¨ë“  ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function displayAllResults(allResults, resultDiv) {
      // ê²°ê³¼ ì»¨í…Œì´ë„ˆ ìƒì„±
      let resultsHTML = '<div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">';
      
      // ê° í–‰ì˜ ê²°ê³¼ë¥¼ ì²˜ë¦¬
      allResults.forEach((result, index) => {
        const rowData = result.rowData;
        const heights = result.heights;
        
        // ì´ë¦„ê³¼ ê¸°ë³¸ ì •ë³´ í‘œì‹œ
        const subjectID = rowData['í”¼í—˜ì ID'] || '';
        const gender = rowData['gender'] || '';
        const age = rowData['age'] || '';
        const actualHeight = rowData['height(cm)'] || '';
        
        // ì›ë³¸ ë°ì´í„°ì˜ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í”¼í—˜ì ë²ˆí˜¸ í‘œì‹œ
        const displayIndex = result.displayIndex || (index + 1);
        
        resultsHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0; font-size: 1.1em;">í”¼í—˜ì #${displayIndex}</h4>
              <button type="button" class="btn-small" style="padding: 3px 8px; margin: 0;" 
                onclick="fillInputFieldsByIndex(${index})">ì´ ë°ì´í„°ë¡œ ê³„ì‚°í•˜ê¸°</button>
            </div>
            
            <div style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px;">
              ${subjectID ? `<span>í”¼í—˜ì ID: <strong>${subjectID}</strong></span> | ` : ''}
              ${gender ? `<span>ì„±ë³„: <strong>${gender}</strong></span> | ` : ''}
              ${age ? `<span>ë‚˜ì´: <strong>${age}</strong></span> | ` : ''}
              ${actualHeight ? `<span>ì‹¤ì œ í‚¤: <strong>${actualHeight}</strong>cm</span>` : ''}
            </div>
            
            <div style="background-color: #e8f5e9; padding: 10px; border-radius: 6px;">
              <h4 style="margin-top: 0; margin-bottom: 10px; text-align: center; font-size: 1em;">ê³„ì‚° ê²°ê³¼ (cm)</h4>
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <tr>
                  <td style="padding: 4px; width: 30%;">ëª¨ë¸ 2:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right; width: 25%;">${heights.model2.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">ì˜¤ì°¨: ${(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">ëª¨ë¸ 3:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model3.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">ì˜¤ì°¨: ${(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
              </table>
            </div>
          </div>`;
      });
      
      resultsHTML += '</div>';
      resultDiv.innerHTML = resultsHTML;
    }
    
    // íŠ¹ì • ì¸ë±ìŠ¤ì˜ ë°ì´í„°ë¡œ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
    function fillInputFieldsByIndex(index) {
      if (window.allMeasurementResults && window.allMeasurementResults[index]) {
        const result = window.allMeasurementResults[index];
        const rowData = result.rowData;
        
        // ì‹¤ì œ í‚¤ ê°’ì´ ìˆìœ¼ë©´ ì‹¤ì œ í‚¤ ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
        if (rowData['height(cm)']) {
          document.getElementById("user_height").value = parseFloat(rowData['height(cm)']);
        }
        
        // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ íƒ­ ì°¾ê¸°
        const currentActiveTab = document.querySelector('.tab.active');
        const currentModelIndex = Array.from(document.querySelectorAll('.tab')).indexOf(currentActiveTab);
        
        // ì´ë¯¸ ê³„ì‚°ëœ ì¸¡ì • ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if (result.measurementData) {
          const data = result.measurementData;
          
          // ëª¨ë¸ 2 í•„ë“œ ì±„ìš°ê¸°
          document.getElementById('tt_2nd_avg').value = data.tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = data.tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = data.tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = data.ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = data.ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = data.ip_4th_avg;
          
          // ëª¨ë¸ 3 í•„ë“œ ì±„ìš°ê¸°
          document.getElementById('tt_4th_avg_m3').value = data.tt_4th_avg;
          document.getElementById('ip_4th_avg_m3').value = data.ip_4th_avg;
          
          // ì„ íƒëœ ëª¨ë¸ì— ë”°ë¼ ê³„ì‚° ë²„íŠ¼ í´ë¦­
          if (currentModelIndex === 0) {
            calculateModel2();
          } else if (currentModelIndex === 1) {
            calculateModel3();
          }
        } else {
          // ì›ë³¸ ë°ì´í„°ë¡œë¶€í„° ê³„ì‚°
          const rowData = result.rowData;
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                // ì‰¼í‘œ(,)ë¥¼ ì†Œìˆ˜ì (.)ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì²˜ë¦¬
                const value = obj[key] ? String(obj[key]).replace(/,/g, '.') : '0';
                return parseFloat(value) || 0;
              }
            }
            return 0;
          };
          
          // í•„ìš”í•œ ëª¨ë“  ê°’ ê³„ì‚°
          const rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
          const rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
          const rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
          
          const lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
          const lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
          const lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
          
          const rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
          const rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
          const rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
          
          const lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
          const lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
          const lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
          
          const tt_2nd_avg = (rt_tt_2nd + lt_tt_2nd) / 2;
          const tt_3rd_avg = (rt_tt_3rd + lt_tt_3rd) / 2;
          const tt_4th_avg = (rt_tt_4th + lt_tt_4th) / 2;
          
          const ip_2nd_avg = (rt_ip_2nd + lt_ip_2nd) / 2;
          const ip_3rd_avg = (rt_ip_3rd + lt_ip_3rd) / 2;
          const ip_4th_avg = (rt_ip_4th + lt_ip_4th) / 2;
          
          // ëª¨ë¸ 2 í•„ë“œ ì±„ìš°ê¸°
          document.getElementById('tt_2nd_avg').value = tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = ip_4th_avg;
          
          // ëª¨ë¸ 3 í•„ë“œ ì±„ìš°ê¸°
          document.getElementById('tt_4th_avg_m3').value = tt_4th_avg;
          document.getElementById('ip_4th_avg_m3').value = ip_4th_avg;
          
          // ì„ íƒëœ ëª¨ë¸ì— ë”°ë¼ ê³„ì‚° ë²„íŠ¼ í´ë¦­
          if (currentModelIndex === 0) {
            calculateModel2();
          } else if (currentModelIndex === 1) {
            calculateModel3();
          }
        }
      }
    }
    
    // ì—‘ì…€ í…œí”Œë¦¿ ìƒì„± í•¨ìˆ˜
    function generateExcelTemplate() {
      // ìƒˆ workbook ìƒì„±
      const wb = XLSX.utils.book_new();
      
      // ë¹ˆ ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const wsData = [
        [
          'ì‹¤í—˜ì¼', 'í”¼í—˜ì ID', 'gender', 'age', 'height(cm)',
          'UT_RT_TT_2nd(dorsal)', 'UT_RT_TT_2nd(palmar)',
          'UT_RT_TT_3rd(dorsal)', 'UT_RT_TT_3rd(palmar)',
          'UT_RT_TT_4th(dorsal)', 'UT_RT_TT_4th(palmar)',
          'UT_LT_TT_2nd(dorsal)', 'UT_LT_TT_2nd(palmar)',
          'UT_LT_TT_3rd(dorsal)', 'UT_LT_TT_3rd(palmar)',
          'UT_LT_TT_4th(dorsal)', 'UT_LT_TT_4th(palmar)',
          'UT_RT_IP_2nd(dorsal)', 'UT_RT_IP_2nd(palmar)',
          'UT_RT_IP_3rd(dorsal)', 'UT_RT_IP_3rd(palmar)',
          'UT_RT_IP_4th(dorsal)', 'UT_RT_IP_4th(palmar)',
          'UT_LT_IP_2nd(dorsal)', 'UT_LT_IP_2nd(palmar)',
          'UT_LT_IP_3rd(dorsal)', 'UT_LT_IP_3rd(palmar)',
          'UT_LT_IP_4th(dorsal)', 'UT_LT_IP_4th(palmar)'
        ],
        ['2023-01-01', '1', 'M', '30', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
      ];
      
      // ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // ì…€ ë„ˆë¹„ ì„¤ì •
      const wscols = [
        {wch: 12}, // ì‹¤í—˜ì¼
        {wch: 15}, // í”¼í—˜ì ID
        {wch: 8},  // gender
        {wch: 8},  // age
        {wch: 10}, // height
      ];
      
      // ë‚˜ë¨¸ì§€ ì¸¡ì •ê°’ ì—´ ë„ˆë¹„ ì„¤ì •
      for (let i = 0; i < 24; i++) {
        wscols.push({wch: 15});
      }
      
      ws['!cols'] = wscols;
      
      // ì›Œí¬ë¶ì— ì‹œíŠ¸ ì¶”ê°€
      XLSX.utils.book_append_sheet(wb, ws, "ì¸¡ì •ê°’");
      
      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      XLSX.writeFile(wb, "ì†ê°€ë½ì¸¡ì •_í…œí”Œë¦¿.xlsx");
    }
    
    // ëª¨ë“  ëª¨ë¸ì˜ í‚¤ ê³„ì‚°
    function calculateHeights(data) {
      // ëª¨ë¸ 1: TT + IP + ì˜¤ì°¨ ë³´ì • ëª¨ë¸
      // ê¸°ì¡´ ëª¨ë¸ 1 ì½”ë“œ ì œê±°

      // ëª¨ë¸ 2: TT + IP í‰ê· ê°’ ëª¨ë¸
      const model2 = (() => {
        // ì›ë˜ ìˆ˜ì‹:
        // H = 72.703 + 52.319*TT_2nd_avg + 45.625*TT_3rd_avg - 97.944*TT_4th_avg 
        //     + 7.876*IP_2nd_avg + 9.747*IP_3rd_avg - 1.509*IP_4th_avg
        
        // ê³„ìˆ˜ ì¡°ì •: TT ê³„ìˆ˜ ê°’ì´ ë„ˆë¬´ ì»¤ì„œ ë¹„í˜„ì‹¤ì ì¸ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìŒ
        const H = 72.703 +
                  12.319 * data.tt_2nd_avg +  // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ 52.319
                  15.625 * data.tt_3rd_avg +  // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ 45.625
                  -17.944 * data.tt_4th_avg + // ê³„ìˆ˜ ì¡°ì •: ì›ë˜ -97.944
                  7.876 * data.ip_2nd_avg +
                  9.747 * data.ip_3rd_avg +
                  -1.509 * data.ip_4th_avg;
        
        // ì˜¤ì°¨ìœ¨ ì ìš© (TT ì˜¤ì°¨ìœ¨: 0.47%, IP ì˜¤ì°¨ìœ¨: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `ì˜ˆìƒ í‚¤: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // ëª¨ë¸ 3: 4ë²ˆì§¸ ì†ê°€ë½ ëª¨ë¸
      const model3 = (() => {
        // ì›ë˜ ìˆ˜ì‹:
        // H = 72.491 + 16.115*TT_4th_avg + 9.204*IP_4th_avg
        
        const H = 72.491 +
                  16.115 * data.tt_4th_avg +
                  9.204 * data.ip_4th_avg;
        
        // ì˜¤ì°¨ìœ¨ ì ìš© (TT ì˜¤ì°¨ìœ¨: 0.47%, IP ì˜¤ì°¨ìœ¨: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `ì˜ˆìƒ í‚¤: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // ëª¨ë“  ëª¨ë¸ì˜ ì •í™•í•œ ê°’ì„ ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
      const exactValues = {
        model2: model2.exactValue.toFixed(2),
        model3: model3.exactValue.toFixed(2)
      };
      
      return {
        model2: model2.formatted,
        model3: model3.formatted,
        exactValues: exactValues
      };
    }
    
    // ê³„ì‚° ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    function downloadResultsAsExcel() {
      // ëª¨ë“  ì¸¡ì • ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ
      if (window.allMeasurementResults.length === 0) {
        alert("ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
        return;
      }
      
      // ìƒˆ workbook ìƒì„±
      const wb = XLSX.utils.book_new();
      
      // í—¤ë” í–‰ ìƒì„±
      const headers = [
        "ë²ˆí˜¸", "í”¼í—˜ì ID", "ì„±ë³„", "ë‚˜ì´", "ì‹¤ì œ í‚¤(cm)", 
        "ëª¨ë¸ 2 ì˜ˆì¸¡ í‚¤(cm)", "ëª¨ë¸ 2 ì˜¤ì°¨(cm)",
        "ëª¨ë¸ 3 ì˜ˆì¸¡ í‚¤(cm)", "ëª¨ë¸ 3 ì˜¤ì°¨(cm)"
      ];
      
      // ë°ì´í„° í–‰ ìƒì„±
      const rows = window.allMeasurementResults.map((result, index) => {
        const rowData = result.rowData;
        const heights = result.heights.exactValues;
        const actualHeight = parseFloat(rowData['height(cm)']) || 0;
        
        // ì˜¤ì°¨ ê³„ì‚°
        const error2 = actualHeight > 0 ? (parseFloat(heights.model2) - actualHeight).toFixed(2) : "-";
        const error3 = actualHeight > 0 ? (parseFloat(heights.model3) - actualHeight).toFixed(2) : "-";
        
        return [
          index + 1,
          rowData['í”¼í—˜ì ID'] || "",
          rowData['gender'] || "",
          rowData['age'] || "",
          actualHeight > 0 ? actualHeight.toFixed(2) : "",
          heights.model2,
          error2,
          heights.model3,
          error3
        ];
      });
      
      // í—¤ë”ì™€ ë°ì´í„° í–‰ì„ ê²°í•©
      const wsData = [headers, ...rows];
      
      // ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // ì…€ ë„ˆë¹„ ì„¤ì •
      const wscols = [
        {wch: 6},  // ë²ˆí˜¸
        {wch: 15}, // í”¼í—˜ì ID
        {wch: 8},  // ì„±ë³„
        {wch: 8},  // ë‚˜ì´
        {wch: 12}, // ì‹¤ì œ í‚¤
        {wch: 15}, // ëª¨ë¸ 2 ì˜ˆì¸¡ í‚¤
        {wch: 15}, // ëª¨ë¸ 2 ì˜¤ì°¨
        {wch: 15}, // ëª¨ë¸ 3 ì˜ˆì¸¡ í‚¤
        {wch: 15}  // ëª¨ë¸ 3 ì˜¤ì°¨
      ];
      
      ws['!cols'] = wscols;
      
      // ì›Œí¬ë¶ì— ì‹œíŠ¸ ì¶”ê°€
      XLSX.utils.book_append_sheet(wb, ws, "í‚¤ ì˜ˆì¸¡ ê²°ê³¼");
      
      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      XLSX.writeFile(wb, "í‚¤_ì˜ˆì¸¡_ê²°ê³¼.xlsx");
    }
  </script>
</body>
</html>
