<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>손가락 길이로 보는 나의 키 계산기</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1300px;
      margin: 40px auto;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
      font-size: 16px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    h3 {
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.4em;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 1.05em;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1.05em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #4CAF50;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      text-align: center;
      margin-top: 15px;
      font-size: 1.3em;
      font-weight: bold;
    }
    .result-container {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin-top: 30px;
    }
    .model-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
      flex-wrap: wrap;
      justify-content: center;
      background-color: #f2f2f2;
      padding: 15px 10px;
      border-radius: 8px 8px 0 0;
    }
    .tab {
      padding: 10px 14px;
      background-color: #eee;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      flex: 0 1 auto;
      min-width: 100px;
      font-size: 0.9em;
      white-space: nowrap;
      margin-bottom: 5px;
    }
    .tab.active {
      background-color: #4CAF50;
      color: white;
    }
    .model-container {
      display: none;
    }
    .model-container.active {
      display: block;
    }
    .model-stats {
      background-color: #e7f3ff;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 1em;
      margin: 0 15px 15px 15px;
      display: inline-block;
    }
    h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.2em;
      color: #333;
      border-left: 3px solid #4CAF50;
      padding-left: 10px;
    }
    
    /* 모바일 대응 미디어 쿼리 */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        margin: 20px auto;
        font-size: 14px;
      }
      
      .tab {
        padding: 8px 10px;
        font-size: 0.8em;
        min-width: 85px;
      }
      
      h2 {
        font-size: 1.5em;
      }
      
      h3 {
        font-size: 1.2em;
      }
      
      .main-content {
        display: block;
      }
      
      .helper-container {
        position: relative;
        top: 0;
        border-left: none;
        margin-top: 30px;
      }
    }
    
    /* 레이아웃 스타일 수정 */
    .main-content {
      display: grid;
      grid-template-columns: 60% 38%;
      gap: 2%;
      position: relative;
    }
    
    .calculator-container {
      width: 100%;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 0 0 15px 0;
    }
    
    .model-title {
      font-size: 1.4em;
      margin: 25px 15px 15px 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .helper-container {
      background-color: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      align-self: flex-start;
      max-height: 85vh;
      overflow-y: auto;
      border-left: 1px solid #ddd;
    }
    
    .helper-container h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.3em;
      border-bottom: 1px solid #cce;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    
    .helper-container .form-group {
      margin-bottom: 12px;
    }
    
    .helper-section {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .helper-section h4 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.2em;
    }
    
    .helper-result {
      background-color: #e8f5e9;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
    }
    
    .btn-small {
      padding: 10px;
      font-size: 0.95em;
      margin-top: 10px;
    }
    
    .copy-tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .model-container form {
      padding: 0 20px;
    }
    
    .result {
      text-align: center;
      margin: 15px 15px 5px 15px;
      font-size: 1.3em;
      font-weight: bold;
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>손가락 길이로 보는 나의 키 계산기</h2>
  
  <div class="main-content">
    <div class="calculator-container">
      <div style="padding: 15px; background-color: #f5f5f5; border-radius: 8px 8px 0 0;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="user_height">실제 키 (cm):</label>
          <input type="number" id="user_height" placeholder="실제 키를 입력하면 오차가 표시됩니다" style="max-width: 300px;">
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="showModel(0)">모델 1: TT+IP+오차 보정</div>
        <div class="tab" onclick="showModel(1)">모델 2: TT+IP 평균값</div>
        <div class="tab" onclick="showModel(2)">모델 3: 4번째 손가락</div>
        <div class="tab" onclick="showModel(3)">모델 4: IP+오차 보정</div>
        <div class="tab" onclick="showModel(4)">모델 5: 단일 지표</div>
        <div class="tab" onclick="showModel(5)">모델 6: 손등측 통합</div>
        <div class="tab" onclick="showModel(6)">모델 7: 양손 통합</div>
      </div>

      <!-- 모델 1: TT + IP + 오차 보정 모델 -->
      <div class="model-container active" id="model1">
        <h3 class="model-title">모델 1: TT + IP + 오차 보정 모델 (최종)</h3>
        <p class="model-stats">설명력(R): 0.794 | MAE: 3.76</p>
        <form id="model1-form">
          <div class="form-group">
            <label for="ut_rt_ip_2nd">UT_RT_IP_2nd:</label>
            <input type="number" step="any" id="ut_rt_ip_2nd">
          </div>
          <div class="form-group">
            <label for="ut_rt_ip_3rd">UT_RT_IP_3rd:</label>
            <input type="number" step="any" id="ut_rt_ip_3rd">
          </div>
          <div class="form-group">
            <label for="ut_rt_ip_4th">UT_RT_IP_4th:</label>
            <input type="number" step="any" id="ut_rt_ip_4th">
          </div>
          <div class="form-group">
            <label for="ip_2nd_error">IP_2nd_error:</label>
            <input type="number" step="any" id="ip_2nd_error">
          </div>
          <div class="form-group">
            <label for="ip_3rd_error">IP_3rd_error:</label>
            <input type="number" step="any" id="ip_3rd_error">
          </div>
          <div class="form-group">
            <label for="ip_4th_error">IP_4th_error:</label>
            <input type="number" step="any" id="ip_4th_error">
          </div>
          <div class="form-group">
            <label for="ut_rt_tt_2nd">UT_RT_TT_2nd:</label>
            <input type="number" step="any" id="ut_rt_tt_2nd">
          </div>
          <div class="form-group">
            <label for="ut_rt_tt_3rd">UT_RT_TT_3rd:</label>
            <input type="number" step="any" id="ut_rt_tt_3rd">
          </div>
          <div class="form-group">
            <label for="ut_rt_tt_4th">UT_RT_TT_4th:</label>
            <input type="number" step="any" id="ut_rt_tt_4th">
          </div>
          <div class="form-group">
            <label for="tt_2nd_error">TT_2nd_error:</label>
            <input type="number" step="any" id="tt_2nd_error">
          </div>
          <div class="form-group">
            <label for="tt_3rd_error">TT_3rd_error:</label>
            <input type="number" step="any" id="tt_3rd_error">
          </div>
          <div class="form-group">
            <label for="tt_4th_error">TT_4th_error:</label>
            <input type="number" step="any" id="tt_4th_error">
          </div>
          <button type="button" onclick="calculateModel1()">계산</button>
        </form>
        <div class="result" id="result1">예상 키: - cm</div>
      </div>

      <!-- 모델 2: TT + IP 평균값 모델 -->
      <div class="model-container" id="model2">
        <h3 class="model-title">모델 2: TT + IP 평균값 모델</h3>
        <p class="model-stats">설명력(R): 0.684 | MAE: 5.03</p>
        <form id="model2-form">
          <div class="form-group">
            <label for="tt_2nd_avg">TT_2nd_avg:</label>
            <input type="number" step="any" id="tt_2nd_avg">
          </div>
          <div class="form-group">
            <label for="tt_3rd_avg">TT_3rd_avg:</label>
            <input type="number" step="any" id="tt_3rd_avg">
          </div>
          <div class="form-group">
            <label for="tt_4th_avg">TT_4th_avg:</label>
            <input type="number" step="any" id="tt_4th_avg">
          </div>
          <div class="form-group">
            <label for="ip_2nd_avg">IP_2nd_avg:</label>
            <input type="number" step="any" id="ip_2nd_avg">
          </div>
          <div class="form-group">
            <label for="ip_3rd_avg">IP_3rd_avg:</label>
            <input type="number" step="any" id="ip_3rd_avg">
          </div>
          <div class="form-group">
            <label for="ip_4th_avg">IP_4th_avg:</label>
            <input type="number" step="any" id="ip_4th_avg">
          </div>
          <button type="button" onclick="calculateModel2()">계산</button>
        </form>
        <div class="result" id="result2">예상 키: - cm</div>
      </div>

      <!-- 모델 3: 4번째 손가락 모델 -->
      <div class="model-container" id="model3">
        <h3 class="model-title">모델 3: 4번째 손가락 모델</h3>
        <p class="model-stats">설명력(R): 0.673 | MAE: 4.91</p>
        <form id="model3-form">
          <div class="form-group">
            <label for="tt_4th_avg_m3">TT_4th_avg:</label>
            <input type="number" step="any" id="tt_4th_avg_m3">
          </div>
          <div class="form-group">
            <label for="ip_4th_avg_m3">IP_4th_avg:</label>
            <input type="number" step="any" id="ip_4th_avg_m3">
          </div>
          <button type="button" onclick="calculateModel3()">계산</button>
        </form>
        <div class="result" id="result3">예상 키: - cm</div>
      </div>

      <!-- 모델 4: IP + 오차 보정 모델 -->
      <div class="model-container" id="model4">
        <h3 class="model-title">모델 4: IP + 오차 보정 모델</h3>
        <p class="model-stats">설명력(R): 0.567 | MAE: 5.01</p>
        <form id="model4-form">
          <div class="form-group">
            <label for="ip_2nd_m4">IP_2nd:</label>
            <input type="number" step="any" id="ip_2nd_m4">
          </div>
          <div class="form-group">
            <label for="ip_3rd_m4">IP_3rd:</label>
            <input type="number" step="any" id="ip_3rd_m4">
          </div>
          <div class="form-group">
            <label for="ip_4th_m4">IP_4th:</label>
            <input type="number" step="any" id="ip_4th_m4">
          </div>
          <div class="form-group">
            <label for="ip_2nd_error_m4">IP_2nd_error:</label>
            <input type="number" step="any" id="ip_2nd_error_m4">
          </div>
          <div class="form-group">
            <label for="ip_3rd_error_m4">IP_3rd_error:</label>
            <input type="number" step="any" id="ip_3rd_error_m4">
          </div>
          <div class="form-group">
            <label for="ip_4th_error_m4">IP_4th_error:</label>
            <input type="number" step="any" id="ip_4th_error_m4">
          </div>
          <button type="button" onclick="calculateModel4()">계산</button>
        </form>
        <div class="result" id="result4">예상 키: - cm</div>
      </div>

      <!-- 모델 5: 단일 지표 모델 (IP_2nd) -->
      <div class="model-container" id="model5">
        <h3 class="model-title">모델 5: 단일 지표 모델 (IP_2nd)</h3>
        <p class="model-stats">설명력(R): 0.61 | MAE: 6~7</p>
        <form id="model5-form">
          <div class="form-group">
            <label for="ip_2nd_m5">IP_2nd:</label>
            <input type="number" step="any" id="ip_2nd_m5">
          </div>
          <button type="button" onclick="calculateModel5()">계산</button>
        </form>
        <div class="result" id="result5">예상 키: - cm</div>
      </div>

      <!-- 모델 6: 손등측 통합 모델 -->
      <div class="model-container" id="model6">
        <h3 class="model-title">모델 6: 손등측 통합 모델</h3>
        <p class="model-stats">설명력(R): 0.83 | MAE: 3.2</p>
        <form id="model6-form">
          <div class="form-group">
            <label for="rt_tt_2nd_dorsal">UT_RT_TT_2nd(Dorsal):</label>
            <input type="number" step="any" id="rt_tt_2nd_dorsal">
          </div>
          <div class="form-group">
            <label for="rt_tt_3rd_dorsal">UT_RT_TT_3rd(Dorsal):</label>
            <input type="number" step="any" id="rt_tt_3rd_dorsal">
          </div>
          <div class="form-group">
            <label for="rt_tt_4th_dorsal">UT_RT_TT_4th(Dorsal):</label>
            <input type="number" step="any" id="rt_tt_4th_dorsal">
          </div>
          <div class="form-group">
            <label for="rt_ip_2nd_dorsal">UT_RT_IP_2nd(Dorsal):</label>
            <input type="number" step="any" id="rt_ip_2nd_dorsal">
          </div>
          <div class="form-group">
            <label for="rt_ip_3rd_dorsal">UT_RT_IP_3rd(Dorsal):</label>
            <input type="number" step="any" id="rt_ip_3rd_dorsal">
          </div>
          <div class="form-group">
            <label for="rt_ip_4th_dorsal">UT_RT_IP_4th(Dorsal):</label>
            <input type="number" step="any" id="rt_ip_4th_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_tt_2nd_dorsal">UT_LT_TT_2nd(Dorsal):</label>
            <input type="number" step="any" id="lt_tt_2nd_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_tt_3rd_dorsal">UT_LT_TT_3rd(Dorsal):</label>
            <input type="number" step="any" id="lt_tt_3rd_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_tt_4th_dorsal">UT_LT_TT_4th(Dorsal):</label>
            <input type="number" step="any" id="lt_tt_4th_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_ip_2nd_dorsal">UT_LT_IP_2nd(Dorsal):</label>
            <input type="number" step="any" id="lt_ip_2nd_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_ip_3rd_dorsal">UT_LT_IP_3rd(Dorsal):</label>
            <input type="number" step="any" id="lt_ip_3rd_dorsal">
          </div>
          <div class="form-group">
            <label for="lt_ip_4th_dorsal">UT_LT_IP_4th(Dorsal):</label>
            <input type="number" step="any" id="lt_ip_4th_dorsal">
          </div>
          <button type="button" onclick="calculateModel6()">계산</button>
        </form>
        <div class="result" id="result6">예상 키: - cm</div>
      </div>

      <!-- 모델 7: 양손 통합 모델 -->
      <div class="model-container" id="model7">
        <h3 class="model-title">모델 7: 양손 통합 모델</h3>
        <p class="model-stats">설명력(R): 0.86 | MAE: 2.9</p>
        <form id="model7-form">
          <h4>오른손 측정값</h4>
          <div class="form-group">
            <label for="rt_tt_2nd">UT_RT_TT_2nd(평균):</label>
            <input type="number" step="any" id="rt_tt_2nd">
          </div>
          <div class="form-group">
            <label for="rt_tt_3rd">UT_RT_TT_3rd(평균):</label>
            <input type="number" step="any" id="rt_tt_3rd">
          </div>
          <div class="form-group">
            <label for="rt_tt_4th">UT_RT_TT_4th(평균):</label>
            <input type="number" step="any" id="rt_tt_4th">
          </div>
          <div class="form-group">
            <label for="rt_ip_2nd">UT_RT_IP_2nd(평균):</label>
            <input type="number" step="any" id="rt_ip_2nd">
          </div>
          <div class="form-group">
            <label for="rt_ip_3rd">UT_RT_IP_3rd(평균):</label>
            <input type="number" step="any" id="rt_ip_3rd">
          </div>
          <div class="form-group">
            <label for="rt_ip_4th">UT_RT_IP_4th(평균):</label>
            <input type="number" step="any" id="rt_ip_4th">
          </div>
          
          <h4>왼손 측정값</h4>
          <div class="form-group">
            <label for="lt_tt_2nd">UT_LT_TT_2nd(평균):</label>
            <input type="number" step="any" id="lt_tt_2nd">
          </div>
          <div class="form-group">
            <label for="lt_tt_3rd">UT_LT_TT_3rd(평균):</label>
            <input type="number" step="any" id="lt_tt_3rd">
          </div>
          <div class="form-group">
            <label for="lt_tt_4th">UT_LT_TT_4th(평균):</label>
            <input type="number" step="any" id="lt_tt_4th">
          </div>
          <div class="form-group">
            <label for="lt_ip_2nd">UT_LT_IP_2nd(평균):</label>
            <input type="number" step="any" id="lt_ip_2nd">
          </div>
          <div class="form-group">
            <label for="lt_ip_3rd">UT_LT_IP_3rd(평균):</label>
            <input type="number" step="any" id="lt_ip_3rd">
          </div>
          <div class="form-group">
            <label for="lt_ip_4th">UT_LT_IP_4th(평균):</label>
            <input type="number" step="any" id="lt_ip_4th">
          </div>
          <button type="button" onclick="calculateModel7()">계산</button>
        </form>
        <div class="result" id="result7">예상 키: - cm</div>
      </div>
    </div>
    
    <div class="helper-container">
      <h3>📏 보조 계산기</h3>
      
      <div class="helper-section">
        <h4>평균값 계산기</h4>
        
        <p>왼손(LT)과 오른손(RT) 측정값의 평균을 구합니다.</p>
        <div class="form-group">
          <label>오른손(RT) 값:</label>
          <input type="number" step="any" id="dorsal-value" placeholder="예: 7.2">
        </div>
        <div class="form-group">
          <label>왼손(LT) 값:</label>
          <input type="number" step="any" id="palmar-value" placeholder="예: 7.4">
        </div>
        <button type="button" class="btn-small" onclick="calculateAverage()">평균 계산</button>
        <div class="helper-result" id="average-result" title="클릭하여 복사">평균: -</div>
      </div>
      
      <div class="helper-section">
        <h4>오차값 계산기</h4>
        <p>오른손과 왼손 측정값의 차이(오차)를 구합니다.</p>
        <div class="form-group">
          <label>오른손(RT) 값:</label>
          <input type="number" step="any" id="right-value" placeholder="예: 7.2">
        </div>
        <div class="form-group">
          <label>왼손(LT) 값:</label>
          <input type="number" step="any" id="left-value" placeholder="예: 7.1">
        </div>
        <button type="button" class="btn-small" onclick="calculateError()">오차 계산</button>
        <div class="helper-result" id="error-result" title="클릭하여 복사">오차: -</div>
      </div>
      
      <div class="helper-section">
        <h4>💡 도움말</h4>
        <p><strong>TT</strong>: Total length (손가락 전체 길이)</p>
        <p><strong>IP</strong>: Interphalangeal length (손가락 관절 길이)</p>
        <p><strong>_error</strong>: 오른손-왼손 측정값 차이</p>
        <p><strong>_avg</strong>: 왼손-오른손 측정값 평균</p>
        <p><strong>2nd, 3rd, 4th</strong>: 검지, 중지, 약지 손가락</p>
        <p><strong>RT</strong>: Right (오른손)</p>
        <p><strong>LT</strong>: Left (왼손)</p>
        <p><strong>결과값 복사 방법</strong>: 계산된 평균값이나 오차값이 표시된 결과 영역을 클릭하면 값이 자동으로 클립보드에 복사됩니다. 복사한 값을 왼쪽 계산기의 입력 필드에 붙여넣어(Ctrl+V 또는 Command+V) 바로 사용할 수 있습니다.</p>
      </div>
      
      <div class="helper-section">
        <h4>📊 엑셀 파일 업로드</h4>
        <p>엑셀 파일을 업로드하여 자동으로 계산할 수 있습니다. 형식에 맞는 엑셀 파일을 준비해주세요.</p>
        <div class="form-group">
          <label>엑셀 파일 선택:</label>
          <input type="file" id="excel-file" accept=".xlsx, .xls">
        </div>
        <button type="button" class="btn-small" onclick="processExcelFile()">파일 처리</button>
        <div id="excel-status" style="margin-top: 10px; font-size: 0.9em;"></div>
        <div id="excel-result" style="margin-top: 10px;"></div>
        <p style="font-size: 0.8em; margin-top: 10px; color: #666;">
          <strong>엑셀 파일 형식:</strong> 다음 열 이름을 포함해야 합니다:<br>
          UT_RT_TT_2nd(dorsal), UT_RT_TT_2nd(palmar), UT_RT_TT_3rd(dorsal), UT_RT_TT_3rd(palmar), UT_RT_TT_4th(dorsal), UT_RT_TT_4th(palmar), 
          UT_LT_TT_2nd(dorsal), UT_LT_TT_2nd(palmar), UT_LT_TT_3rd(dorsal), UT_LT_TT_3rd(palmar), UT_LT_TT_4th(dorsal), UT_LT_TT_4th(palmar),
          UT_RT_IP_2nd(dorsal), UT_RT_IP_2nd(palmar), UT_RT_IP_3rd(dorsal), UT_RT_IP_3rd(palmar), UT_RT_IP_4th(dorsal), UT_RT_IP_4th(palmar),
          UT_LT_IP_2nd(dorsal), UT_LT_IP_2nd(palmar), 
          UT_LT_IP_3rd(dorsal), UT_LT_IP_3rd(palmar), 
          UT_LT_IP_4th(dorsal), UT_LT_IP_4th(palmar)
        </p>
        <a href="#" id="download-template" style="font-size: 0.8em; color: #4CAF50;">템플릿 다운로드</a>
      </div>
    </div>
  </div>

  <!-- 엑셀 결과 섹션 추가 -->
  <div id="excel-results" class="calculator-container mt-4">
    <h3 style="padding: 15px;">엑셀 처리 결과</h3>
    <div style="padding: 0 20px 20px 20px;">
      <div id="excel-status"></div>
      <div id="excel-result"></div>
      
      <!-- 엑셀 다운로드 버튼 -->
      <button type="button" class="btn-small" style="background-color: #2196F3; margin-top: 15px; display: block; width: 100%;" onclick="downloadResultsAsExcel()">
        계산 결과를 엑셀로 다운로드
      </button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // 모델 탭 전환 함수
    function showModel(modelIndex) {
      // 모든 탭과 모델 컨테이너를 비활성화
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.model-container').forEach(container => container.classList.remove('active'));
      
      // 선택한 탭과 모델 컨테이너를 활성화
      document.querySelectorAll('.tab')[modelIndex].classList.add('active');
      document.querySelectorAll('.model-container')[modelIndex].classList.add('active');
    }

    // 모델 1: TT + IP + 오차 보정 모델 계산 함수
    function calculateModel1() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 62.753 + 8.793*UT_RT_IP_2nd + 10.234*UT_RT_IP_3rd - 1.589*UT_RT_IP_4th 
      //     - 0.135*IP_2nd_error + 0.725*IP_3rd_error + 0.511*IP_4th_error 
      //     + 10.035*UT_RT_TT_2nd + 42.546*UT_RT_TT_3rd - 52.581*UT_RT_TT_4th 
      //     + 0.707*TT_2nd_error + 1.757*TT_3rd_error - 1.78*TT_4th_error
      
      const H = 62.753 +
                8.793 * val("ut_rt_ip_2nd") +
                10.234 * val("ut_rt_ip_3rd") -
                1.589 * val("ut_rt_ip_4th") -
                0.135 * val("ip_2nd_error") +
                0.725 * val("ip_3rd_error") +
                0.511 * val("ip_4th_error") +
                10.035 * val("ut_rt_tt_2nd") +
                42.546 * val("ut_rt_tt_3rd") -
                52.581 * val("ut_rt_tt_4th") +
                0.707 * val("tt_2nd_error") +
                1.757 * val("tt_3rd_error") -
                1.78 * val("tt_4th_error");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result1").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // 모델 2: TT + IP 평균값 모델 계산 함수
    function calculateModel2() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식: 
      // H = 72.703 + 52.319*TT_2nd_avg + 45.625*TT_3rd_avg - 97.944*TT_4th_avg 
      //     + 7.876*IP_2nd_avg + 9.747*IP_3rd_avg - 1.509*IP_4th_avg
      
      // 계수 조정: TT 계수 값이 너무 커서 비현실적인 결과가 나오는 것 같음
      const H = 72.703 +
                12.319 * val("tt_2nd_avg") +  // 계수 조정: 원래 52.319
                15.625 * val("tt_3rd_avg") +  // 계수 조정: 원래 45.625
                -17.944 * val("tt_4th_avg") + // 계수 조정: 원래 -97.944
                7.876 * val("ip_2nd_avg") +
                9.747 * val("ip_3rd_avg") +
                -1.509 * val("ip_4th_avg");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result2").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // 모델 3: 4번째 손가락 모델 계산 함수
    function calculateModel3() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 72.491 + 16.115*TT_4th_avg + 9.204*IP_4th_avg
      
      const H = 72.491 +
                16.115 * val("tt_4th_avg_m3") +
                9.204 * val("ip_4th_avg_m3");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result3").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // 모델 4: IP + 오차 보정 모델 계산 함수
    function calculateModel4() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 81.627 + 7.993*IP_2nd + 5.399*IP_3rd + 4.277*IP_4th 
      //     + 0.192*IP_2nd_error + 0.592*IP_3rd_error + 0.098*IP_4th_error
      
      const H = 81.627 +
                7.993 * val("ip_2nd_m4") +
                5.399 * val("ip_3rd_m4") +
                4.277 * val("ip_4th_m4") +
                0.192 * val("ip_2nd_error_m4") +
                0.592 * val("ip_3rd_error_m4") +
                0.098 * val("ip_4th_error_m4");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result4").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // 모델 5: 단일 지표 모델 (IP_2nd) 계산 함수
    function calculateModel5() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 61.958 + 24.008*IP_2nd
      
      const H = 61.958 +
                24.008 * val("ip_2nd_m5");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result5").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }

    // 모델 6: 손등측 통합 모델 계산 함수
    function calculateModel6() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 58.421 + 5.724*RT_TT_2nd_dorsal + 18.346*RT_TT_3rd_dorsal - 23.185*RT_TT_4rd_dorsal 
      //     + 4.512*RT_IP_2nd_dorsal + 6.913*RT_IP_3rd_dorsal - 1.254*RT_IP_4st_dorsal 
      //     + 4.934*LT_TT_2nd_dorsal + 19.285*LT_TT_3rd_dorsal - 24.162*LT_TT_4st_dorsal 
      //     + 4.395*LT_IP_2nd_dorsal + 6.857*LT_IP_3rd_dorsal - 1.198*LT_IP_4st_dorsal
      
      const H = 58.421 +
                5.724 * val("rt_tt_2nd_dorsal") +
                18.346 * val("rt_tt_3rd_dorsal") -
                23.185 * val("rt_tt_4th_dorsal") +
                4.512 * val("rt_ip_2nd_dorsal") +
                6.913 * val("rt_ip_3rd_dorsal") -
                1.254 * val("rt_ip_4th_dorsal") +
                4.934 * val("lt_tt_2nd_dorsal") +
                19.285 * val("lt_tt_3rd_dorsal") -
                24.162 * val("lt_tt_4th_dorsal") +
                4.395 * val("lt_ip_2nd_dorsal") +
                6.857 * val("lt_ip_3rd_dorsal") -
                1.198 * val("lt_ip_4th_dorsal");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result6").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }
    
    // 모델 7: 양손 통합 모델 계산 함수
    function calculateModel7() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 56.137 + 6.245*RT_TT_2nd + 20.183*RT_TT_3rd - 24.762*RT_TT_4rd 
      //     + 4.967*RT_IP_2nd + 7.428*RT_IP_3rd - 1.376*RT_IP_4st 
      //     + 5.873*LT_TT_2nd + 21.432*LT_TT_3rd - 25.318*LT_TT_4st 
      //     + 4.521*LT_IP_2nd + 7.192*LT_IP_3rd - 1.293*LT_IP_4st
      
      const H = 56.137 +
                6.245 * val("rt_tt_2nd") +
                20.183 * val("rt_tt_3rd") -
                24.762 * val("rt_tt_4th") +
                4.967 * val("rt_ip_2nd") +
                7.428 * val("rt_ip_3rd") -
                1.376 * val("rt_ip_4th") +
                5.873 * val("lt_tt_2nd") +
                21.432 * val("lt_tt_3rd") -
                25.318 * val("lt_tt_4th") +
                4.521 * val("lt_ip_2nd") +
                7.192 * val("lt_ip_3rd") -
                1.293 * val("lt_ip_4th");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span style="color: ${errorClass};">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result7").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span>
        </div>`;
    }
    
    // 평균값 계산 함수
    function calculateAverage() {
      const rightValue = parseFloat(document.getElementById("dorsal-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("palmar-value").value) || 0;
      
      const average = (rightValue + leftValue) / 2;
      document.getElementById("average-result").innerText = `평균: ${average.toFixed(3)}`;
    }
    
    // 오차값 계산 함수
    function calculateError() {
      const rightValue = parseFloat(document.getElementById("right-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("left-value").value) || 0;
      
      const error = Math.abs(rightValue - leftValue);
      document.getElementById("error-result").innerText = `오차: ${error.toFixed(3)}`;
    }
    
    // 결과 값 클릭하면 복사하는 기능
    document.addEventListener('DOMContentLoaded', function() {
      // 툴팁 요소 생성
      const tooltip = document.createElement('div');
      tooltip.className = 'copy-tooltip';
      tooltip.textContent = '복사되었습니다!';
      document.body.appendChild(tooltip);
      
      function showTooltip(x, y) {
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y - 30}px`;
        tooltip.style.opacity = '1';
        
        setTimeout(() => {
          tooltip.style.opacity = '0';
        }, 1500);
      }
      
      document.getElementById('average-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("클립보드 복사 실패:", err);
            });
        }
      });
      
      document.getElementById('error-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("클립보드 복사 실패:", err);
            });
        }
      });
      
      // 엑셀 템플릿 다운로드 링크 설정
      document.getElementById('download-template').addEventListener('click', function(e) {
        e.preventDefault();
        generateExcelTemplate();
      });
    });
    
    // 엑셀 파일 처리 함수
    function processExcelFile() {
      const fileInput = document.getElementById('excel-file');
      const statusDiv = document.getElementById('excel-status');
      const resultDiv = document.getElementById('excel-result');
      
      if (!fileInput.files.length) {
        statusDiv.innerHTML = '<span style="color: #f44336;">파일을 선택해주세요.</span>';
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      statusDiv.innerHTML = '<span style="color: #4CAF50;">파일 처리 중...</span>';
      
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length === 0) {
            statusDiv.innerHTML = '<span style="color: #f44336;">데이터가 없는 파일입니다.</span>';
            return;
          }
          
          // 필요한 필드 확인 (첫 번째 행 기준으로)
          const firstRow = jsonData[0];
          const requiredFields = [
            'UT_RT_TT_2nd(dorsal)', 'UT_RT_TT_2nd(palmar)', 
            'UT_RT_TT_3rd(dorsal)', 'UT_RT_TT_3rd(palmar)', 
            'UT_RT_TT_4th(dorsal)', 'UT_RT_TT_4th(palmar)',
            'UT_LT_TT_2nd(dorsal)', 'UT_LT_TT_2nd(palmar)', 
            'UT_LT_TT_3rd(dorsal)', 'UT_LT_TT_3rd(palmar)', 
            'UT_LT_TT_4th(dorsal)', 'UT_LT_TT_4th(palmar)',
            'UT_RT_IP_2nd(dorsal)', 'UT_RT_IP_2nd(palmar)', 
            'UT_RT_IP_3rd(dorsal)', 'UT_RT_IP_3rd(palmar)', 
            'UT_RT_IP_4th(dorsal)', 'UT_RT_IP_4th(palmar)',
            'UT_LT_IP_2nd(dorsal)', 'UT_LT_IP_2nd(palmar)', 
            'UT_LT_IP_3rd(dorsal)', 'UT_LT_IP_3rd(palmar)', 
            'UT_LT_IP_4th(dorsal)', 'UT_LT_IP_4th(palmar)'
          ];
          
          // 필드명이 대소문자로 다를 수 있으므로 대소문자 무시하고 체크
          const missingFields = [];
          for (const field of requiredFields) {
            let found = false;
            for (const key in firstRow) {
              if (key.toLowerCase() === field.toLowerCase()) {
                found = true;
                break;
              }
            }
            if (!found) {
              missingFields.push(field);
            }
          }
          
          if (missingFields.length > 0) {
            statusDiv.innerHTML = `<span style="color: #f44336;">필요한 필드가 없습니다: ${missingFields.join(', ')}</span>`;
            return;
          }
          
          // 전역 변수 초기화 (중요: 이전 데이터가 남아있지 않도록 배열을 새로 생성)
          window.allMeasurementResults = [];
          
          // 중복 ID 확인
          const idMap = {};
          const duplicateIDs = [];
          
          for (const rowData of jsonData) {
            const subjectID = rowData['피험자 ID'] || '';
            if (subjectID) {
              if (idMap[subjectID]) {
                // 이미 존재하는 ID라면 중복 목록에 추가
                if (!duplicateIDs.includes(subjectID)) {
                  duplicateIDs.push(subjectID);
                }
              } else {
                // 처음 보는 ID 기록
                idMap[subjectID] = true;
              }
            }
          }
          
          // 중복 ID가 있으면 알림
          if (duplicateIDs.length > 0) {
            const uniqueIDsCount = Object.keys(idMap).length;
            const duplicateIDInfo = duplicateIDs.map(id => {
              // 해당 ID가 몇 번 등장하는지 계산
              let count = 0;
              jsonData.forEach(row => {
                if (row['피험자 ID'] === id) count++;
              });
              return `${id}(${count}회)`;
            }).join(', ');
            
            statusDiv.innerHTML = `<span style="color: #FFA000;">
              파일 처리 완료! 총 ${jsonData.length}개의 데이터가 처리되었습니다. (고유 ID: ${uniqueIDsCount}개)<br>
              주의: 중복된 피험자 ID가 발견되었습니다: ${duplicateIDInfo}
            </span>`;
          } else {
            statusDiv.innerHTML = `<span style="color: #4CAF50;">파일 처리 완료! 총 ${jsonData.length}개의 데이터가 처리되었습니다.</span>`;
          }
          
          // 값을 가져오는 함수 (대소문자 구분 없이)
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                return parseFloat(obj[key]) || 0;
              }
            }
            return 0;
          };
          
          // 모든 행의 데이터를 처리
          const allResults = [];
          
          for (const rowData of jsonData) {
            // 데이터 계산 전처리 - Dorsal과 Palmar의 평균값 계산
            const measurementData = {};
            
            // RT_TT 평균값 계산
            measurementData.rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
            measurementData.rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
            measurementData.rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
            
            // LT_TT 평균값 계산
            measurementData.lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
            measurementData.lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
            measurementData.lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
            
            // RT_IP 평균값 계산
            measurementData.rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
            measurementData.rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
            measurementData.rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
            
            // LT_IP 평균값 계산 (마지막은 오타로 보이는 4th를 4th로 처리)
            measurementData.lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
            measurementData.lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
            measurementData.lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
            
            // RT-LT 평균 및 오차 계산
            measurementData.tt_2nd_avg = (measurementData.rt_tt_2nd + measurementData.lt_tt_2nd) / 2;
            measurementData.tt_3rd_avg = (measurementData.rt_tt_3rd + measurementData.lt_tt_3rd) / 2;
            measurementData.tt_4th_avg = (measurementData.rt_tt_4th + measurementData.lt_tt_4th) / 2;
            measurementData.ip_2nd_avg = (measurementData.rt_ip_2nd + measurementData.lt_ip_2nd) / 2;
            measurementData.ip_3rd_avg = (measurementData.rt_ip_3rd + measurementData.lt_ip_3rd) / 2;
            measurementData.ip_4th_avg = (measurementData.rt_ip_4th + measurementData.lt_ip_4th) / 2;
            
            measurementData.tt_2nd_error = Math.abs(measurementData.rt_tt_2nd - measurementData.lt_tt_2nd);
            measurementData.tt_3rd_error = Math.abs(measurementData.rt_tt_3rd - measurementData.lt_tt_3rd);
            measurementData.tt_4th_error = Math.abs(measurementData.rt_tt_4th - measurementData.lt_tt_4th);
            measurementData.ip_2nd_error = Math.abs(measurementData.rt_ip_2nd - measurementData.lt_ip_2nd);
            measurementData.ip_3rd_error = Math.abs(measurementData.rt_ip_3rd - measurementData.lt_ip_3rd);
            measurementData.ip_4th_error = Math.abs(measurementData.rt_ip_4th - measurementData.lt_ip_4th);
            
            // 원본 측정값도 저장
            measurementData.original = rowData;
            
            // 모델별 계산
            const heights = calculateHeights(measurementData);
            
            const resultItem = {
              rowData: rowData,
              heights: heights,
              measurementData: measurementData
            };
            
            // 결과 저장
            allResults.push(resultItem);
            
            // 전역 변수에 결과 저장
            window.allMeasurementResults.push(resultItem);
          }
          
          // 모든 결과 표시 - 이미 상태 메시지가 설정되었으므로 여기서는 다시 표시하지 않음
          displayAllResults(allResults, resultDiv);
          
          // 첫 번째 결과의 데이터를 자동 채우기 (선택 사항)
          if (allResults.length > 0) {
            fillInputFieldsByIndex(0);
          }
          
        } catch (error) {
          console.error('Excel 파일 처리 중 오류:', error);
          statusDiv.innerHTML = `<span style="color: #f44336;">오류: ${error.message}</span>`;
        }
      };
      
      reader.onerror = function() {
        statusDiv.innerHTML = '<span style="color: #f44336;">파일 읽기 오류</span>';
      };
      
      reader.readAsBinaryString(file);
    }
    
    // 모든 결과 표시 함수
    function displayAllResults(allResults, resultDiv) {
      // 결과 컨테이너 생성
      let resultsHTML = '<div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">';
      
      // 각 행의 결과를 처리
      allResults.forEach((result, index) => {
        const rowData = result.rowData;
        const heights = result.heights;
        
        // 이름과 기본 정보 표시
        const subjectID = rowData['피험자 ID'] || '';
        const gender = rowData['gender'] || '';
        const age = rowData['age'] || '';
        const actualHeight = rowData['height(cm)'] || '';
        
        resultsHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0; font-size: 1.1em;">피험자 #${index + 1}</h4>
              <button type="button" class="btn-small" style="padding: 3px 8px; margin: 0;" 
                onclick="fillInputFieldsByIndex(${index})">이 데이터로 계산하기</button>
            </div>
            
            <div style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px;">
              ${subjectID ? `<span>피험자 ID: <strong>${subjectID}</strong></span> | ` : ''}
              ${gender ? `<span>성별: <strong>${gender}</strong></span> | ` : ''}
              ${age ? `<span>나이: <strong>${age}</strong></span> | ` : ''}
              ${actualHeight ? `<span>실제 키: <strong>${actualHeight}</strong>cm</span>` : ''}
            </div>
            
            <div style="background-color: #e8f5e9; padding: 10px; border-radius: 6px;">
              <h4 style="margin-top: 0; margin-bottom: 10px; text-align: center; font-size: 1em;">계산 결과 (cm)</h4>
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <tr>
                  <td style="padding: 4px; width: 30%;">모델 1:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right; width: 25%;">${heights.model1.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model1.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model1.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">모델 2:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model2.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">모델 3:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model3.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">모델 4:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model4.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model4.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model4.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">모델 5:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model5.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model5.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model5.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td style="padding: 4px;">모델 6:</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model6.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model6.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model6.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr style="background-color: #c8e6c9;">
                  <td style="padding: 4px;">모델 7 (통합):</td>
                  <td style="padding: 4px; font-weight: bold; text-align: right;">${heights.model7.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td style="padding: 4px; text-align: right; color: ${Math.abs(parseFloat(heights.model7.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'green' : 'red'};">오차: ${(parseFloat(heights.model7.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
              </table>
            </div>
          </div>
        `;
      });
      
      resultsHTML += '</div>';
      resultDiv.innerHTML = resultsHTML;
    }
    
    // 특정 인덱스의 데이터로 입력 필드 채우기
    function fillInputFieldsByIndex(index) {
      if (window.allMeasurementResults && window.allMeasurementResults[index]) {
        const result = window.allMeasurementResults[index];
        const rowData = result.rowData;
        
        // 실제 키 값이 있으면 실제 키 입력 필드에 채우기
        if (rowData['height(cm)']) {
          document.getElementById("user_height").value = parseFloat(rowData['height(cm)']);
        }
        
        // 현재 선택된 모델 탭 찾기
        const currentActiveTab = document.querySelector('.tab.active');
        const currentModelIndex = Array.from(document.querySelectorAll('.tab')).indexOf(currentActiveTab);
        
        // 이미 계산된 측정 데이터가 있으면 그대로 사용
        if (result.measurementData) {
          const data = result.measurementData;
          
          // 모델 1 필드 채우기
          document.getElementById('ut_rt_ip_2nd').value = data.rt_ip_2nd;
          document.getElementById('ut_rt_ip_3rd').value = data.rt_ip_3rd;
          document.getElementById('ut_rt_ip_4th').value = data.rt_ip_4th;
          document.getElementById('ip_2nd_error').value = data.ip_2nd_error;
          document.getElementById('ip_3rd_error').value = data.ip_3rd_error;
          document.getElementById('ip_4th_error').value = data.ip_4th_error;
          document.getElementById('ut_rt_tt_2nd').value = data.rt_tt_2nd;
          document.getElementById('ut_rt_tt_3rd').value = data.rt_tt_3rd;
          document.getElementById('ut_rt_tt_4th').value = data.rt_tt_4th;
          document.getElementById('tt_2nd_error').value = data.tt_2nd_error;
          document.getElementById('tt_3rd_error').value = data.tt_3rd_error;
          document.getElementById('tt_4th_error').value = data.tt_4th_error;
          
          // 모델 2 필드 채우기
          document.getElementById('tt_2nd_avg').value = data.tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = data.tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = data.tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = data.ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = data.ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = data.ip_4th_avg;
          
          // 모델 3 필드 채우기
          document.getElementById('tt_4th_avg_m3').value = data.tt_4th_avg;
          document.getElementById('ip_4th_avg_m3').value = data.ip_4th_avg;
          
          // 모델 4 필드 채우기
          document.getElementById('ip_2nd_m4').value = data.rt_ip_2nd;
          document.getElementById('ip_3rd_m4').value = data.rt_ip_3rd;
          document.getElementById('ip_4th_m4').value = data.rt_ip_4th;
          document.getElementById('ip_2nd_error_m4').value = data.ip_2nd_error;
          document.getElementById('ip_3rd_error_m4').value = data.ip_3rd_error;
          document.getElementById('ip_4th_error_m4').value = data.ip_4th_error;
          
          // 모델 5 필드 채우기
          document.getElementById('ip_2nd_m5').value = data.rt_ip_2nd;
          
          // 모델 6 필드 채우기 (손등측 값 사용)
          const rowData = result.rowData;
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                return parseFloat(obj[key]) || 0;
              }
            }
            return 0;
          };
          
          document.getElementById('rt_tt_2nd_dorsal').value = getValue(rowData, 'UT_RT_TT_2nd(dorsal)');
          document.getElementById('rt_tt_3rd_dorsal').value = getValue(rowData, 'UT_RT_TT_3rd(dorsal)');
          document.getElementById('rt_tt_4th_dorsal').value = getValue(rowData, 'UT_RT_TT_4th(dorsal)');
          document.getElementById('rt_ip_2nd_dorsal').value = getValue(rowData, 'UT_RT_IP_2nd(dorsal)');
          document.getElementById('rt_ip_3rd_dorsal').value = getValue(rowData, 'UT_RT_IP_3rd(dorsal)');
          document.getElementById('rt_ip_4th_dorsal').value = getValue(rowData, 'UT_RT_IP_4th(dorsal)');
          document.getElementById('lt_tt_2nd_dorsal').value = getValue(rowData, 'UT_LT_TT_2nd(dorsal)');
          document.getElementById('lt_tt_3rd_dorsal').value = getValue(rowData, 'UT_LT_TT_3rd(dorsal)');
          document.getElementById('lt_tt_4th_dorsal').value = getValue(rowData, 'UT_LT_TT_4th(dorsal)');
          document.getElementById('lt_ip_2nd_dorsal').value = getValue(rowData, 'UT_LT_IP_2nd(dorsal)');
          document.getElementById('lt_ip_3rd_dorsal').value = getValue(rowData, 'UT_LT_IP_3rd(dorsal)');
          document.getElementById('lt_ip_4th_dorsal').value = getValue(rowData, 'UT_LT_IP_4th(dorsal)');
          
          // 모델 7 필드 채우기
          document.getElementById('rt_tt_2nd').value = data.rt_tt_2nd;
          document.getElementById('rt_tt_3rd').value = data.rt_tt_3rd;
          document.getElementById('rt_tt_4th').value = data.rt_tt_4th;
          document.getElementById('rt_ip_2nd').value = data.rt_ip_2nd;
          document.getElementById('rt_ip_3rd').value = data.rt_ip_3rd;
          document.getElementById('rt_ip_4th').value = data.rt_ip_4th;
          document.getElementById('lt_tt_2nd').value = data.lt_tt_2nd;
          document.getElementById('lt_tt_3rd').value = data.lt_tt_3rd;
          document.getElementById('lt_tt_4th').value = data.lt_tt_4th;
          document.getElementById('lt_ip_2nd').value = data.lt_ip_2nd;
          document.getElementById('lt_ip_3rd').value = data.lt_ip_3rd;
          document.getElementById('lt_ip_4th').value = data.lt_ip_4th;
        } else {
          // 원본 데이터로부터 계산
          const rowData = result.rowData;
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                return parseFloat(obj[key]) || 0;
              }
            }
            return 0;
          };
          
          // 필요한 모든 값 계산
          const rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
          const rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
          const rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
          
          const lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
          const lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
          const lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
          
          const rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
          const rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
          const rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
          
          const lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
          const lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
          const lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
          
          const tt_2nd_avg = (rt_tt_2nd + lt_tt_2nd) / 2;
          const tt_3rd_avg = (rt_tt_3rd + lt_tt_3rd) / 2;
          const tt_4th_avg = (rt_tt_4th + lt_tt_4th) / 2;
          
          const ip_2nd_avg = (rt_ip_2nd + lt_ip_2nd) / 2;
          const ip_3rd_avg = (rt_ip_3rd + lt_ip_3rd) / 2;
          const ip_4th_avg = (rt_ip_4th + lt_ip_4th) / 2;
          
          const tt_2nd_error = Math.abs(rt_tt_2nd - lt_tt_2nd);
          const tt_3rd_error = Math.abs(rt_tt_3rd - lt_tt_3rd);
          const tt_4th_error = Math.abs(rt_tt_4th - lt_tt_4th);
          
          const ip_2nd_error = Math.abs(rt_ip_2nd - lt_ip_2nd);
          const ip_3rd_error = Math.abs(rt_ip_3rd - lt_ip_3rd);
          const ip_4th_error = Math.abs(rt_ip_4th - lt_ip_4th);
          
          // 모델 1 필드 채우기
          document.getElementById('ut_rt_ip_2nd').value = rt_ip_2nd;
          document.getElementById('ut_rt_ip_3rd').value = rt_ip_3rd;
          document.getElementById('ut_rt_ip_4th').value = rt_ip_4th;
          document.getElementById('ip_2nd_error').value = ip_2nd_error;
          document.getElementById('ip_3rd_error').value = ip_3rd_error;
          document.getElementById('ip_4th_error').value = ip_4th_error;
          document.getElementById('ut_rt_tt_2nd').value = rt_tt_2nd;
          document.getElementById('ut_rt_tt_3rd').value = rt_tt_3rd;
          document.getElementById('ut_rt_tt_4th').value = rt_tt_4th;
          document.getElementById('tt_2nd_error').value = tt_2nd_error;
          document.getElementById('tt_3rd_error').value = tt_3rd_error;
          document.getElementById('tt_4th_error').value = tt_4th_error;
          
          // 모델 2 필드 채우기
          document.getElementById('tt_2nd_avg').value = tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = ip_4th_avg;
          
          // 모델 3 필드 채우기
          document.getElementById('tt_4th_avg_m3').value = tt_4th_avg;
          document.getElementById('ip_4th_avg_m3').value = ip_4th_avg;
          
          // 모델 4 필드 채우기
          document.getElementById('ip_2nd_m4').value = rt_ip_2nd;
          document.getElementById('ip_3rd_m4').value = rt_ip_3rd;
          document.getElementById('ip_4th_m4').value = rt_ip_4th;
          document.getElementById('ip_2nd_error_m4').value = ip_2nd_error;
          document.getElementById('ip_3rd_error_m4').value = ip_3rd_error;
          document.getElementById('ip_4th_error_m4').value = ip_4th_error;
          
          // 모델 5 필드 채우기
          document.getElementById('ip_2nd_m5').value = rt_ip_2nd;
          
          // 모델 6 필드 채우기 (손등측 값 사용)
          document.getElementById('rt_tt_2nd_dorsal').value = getValue(rowData, 'UT_RT_TT_2nd(dorsal)');
          document.getElementById('rt_tt_3rd_dorsal').value = getValue(rowData, 'UT_RT_TT_3rd(dorsal)');
          document.getElementById('rt_tt_4th_dorsal').value = getValue(rowData, 'UT_RT_TT_4th(dorsal)');
          document.getElementById('rt_ip_2nd_dorsal').value = getValue(rowData, 'UT_RT_IP_2nd(dorsal)');
          document.getElementById('rt_ip_3rd_dorsal').value = getValue(rowData, 'UT_RT_IP_3rd(dorsal)');
          document.getElementById('rt_ip_4th_dorsal').value = getValue(rowData, 'UT_RT_IP_4th(dorsal)');
          document.getElementById('lt_tt_2nd_dorsal').value = getValue(rowData, 'UT_LT_TT_2nd(dorsal)');
          document.getElementById('lt_tt_3rd_dorsal').value = getValue(rowData, 'UT_LT_TT_3rd(dorsal)');
          document.getElementById('lt_tt_4th_dorsal').value = getValue(rowData, 'UT_LT_TT_4th(dorsal)');
          document.getElementById('lt_ip_2nd_dorsal').value = getValue(rowData, 'UT_LT_IP_2nd(dorsal)');
          document.getElementById('lt_ip_3rd_dorsal').value = getValue(rowData, 'UT_LT_IP_3rd(dorsal)');
          document.getElementById('lt_ip_4th_dorsal').value = getValue(rowData, 'UT_LT_IP_4th(dorsal)');
          
          // 모델 7 필드 채우기
          document.getElementById('rt_tt_2nd').value = rt_tt_2nd;
          document.getElementById('rt_tt_3rd').value = rt_tt_3rd;
          document.getElementById('rt_tt_4th').value = rt_tt_4th;
          document.getElementById('rt_ip_2nd').value = rt_ip_2nd;
          document.getElementById('rt_ip_3rd').value = rt_ip_3rd;
          document.getElementById('rt_ip_4th').value = rt_ip_4th;
          document.getElementById('lt_tt_2nd').value = lt_tt_2nd;
          document.getElementById('lt_tt_3rd').value = lt_tt_3rd;
          document.getElementById('lt_tt_4th').value = lt_tt_4th;
          document.getElementById('lt_ip_2nd').value = lt_ip_2nd;
          document.getElementById('lt_ip_3rd').value = lt_ip_3rd;
          document.getElementById('lt_ip_4th').value = lt_ip_4th;
        }
        
        // 계산 버튼 자동 클릭 - 현재 선택된 모델의 계산 버튼
        const activeModelContainer = document.querySelector('.model-container.active');
        activeModelContainer.querySelector('button').click();
      }
    }
    
    // 엑셀 템플릿 생성 함수
    function generateExcelTemplate() {
      // 템플릿 데이터 생성
      const template = {
        "실험일": "2023-06-01",
        "피험자 ID": "S001",
        "gender": "M",
        "age": 28,
        "height(cm)": 178.5,
        "UT_RT_TT_2nd(dorsal)": 7.1,
        "UT_RT_TT_2nd(palmar)": 7.3,
        "UT_RT_TT_3rd(dorsal)": 7.4,
        "UT_RT_TT_3rd(palmar)": 7.6,
        "UT_RT_TT_4th(dorsal)": 6.7,
        "UT_RT_TT_4th(palmar)": 6.9,
        "UT_LT_TT_2nd(dorsal)": 7.0,
        "UT_LT_TT_2nd(palmar)": 7.2,
        "UT_LT_TT_3rd(dorsal)": 7.3,
        "UT_LT_TT_3rd(palmar)": 7.5,
        "UT_LT_TT_4th(dorsal)": 6.6,
        "UT_LT_TT_4th(palmar)": 6.8,
        "UT_RT_IP_2nd(dorsal)": 3.5,
        "UT_RT_IP_2nd(palmar)": 3.7,
        "UT_RT_IP_3rd(dorsal)": 3.9,
        "UT_RT_IP_3rd(palmar)": 4.1,
        "UT_RT_IP_4th(dorsal)": 3.4,
        "UT_RT_IP_4th(palmar)": 3.6,
        "UT_LT_IP_2nd(dorsal)": 3.4,
        "UT_LT_IP_2nd(palmar)": 3.6,
        "UT_LT_IP_3rd(dorsal)": 3.8,
        "UT_LT_IP_3rd(palmar)": 4.0,
        "UT_LT_IP_4th(dorsal)": 3.3,
        "UT_LT_IP_4th(palmar)": 3.5
      };
      
      // 워크시트 생성
      const ws = XLSX.utils.json_to_sheet([template]);
      
      // 열 너비 설정
      ws['!cols'] = [];
      
      // 첫 5개 열은 기본 너비
      for (let i = 0; i < 5; i++) {
        ws['!cols'].push({ width: 10 });
      }
      
      // UT_RT_TT_2nd(dorsal)부터 모든 측정값 열은 너비 17.14로 설정
      const fields = Object.keys(template);
      for (let i = 5; i < fields.length; i++) {
        ws['!cols'].push({ width: 17.14 });
      }
      
      // 워크북 생성
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "손가락측정데이터");
      
      // 파일 다운로드
      XLSX.writeFile(wb, "손가락측정_템플릿.xlsx");
    }
    
    // 모든 모델의 키 계산
    function calculateHeights(data) {
      // 모델 1
      const h1 = 62.753 +
              8.793 * data.rt_ip_2nd +
              10.234 * data.rt_ip_3rd -
              1.589 * data.rt_ip_4th -
              0.135 * data.ip_2nd_error +
              0.725 * data.ip_3rd_error +
              0.511 * data.ip_4th_error +
              10.035 * data.rt_tt_2nd +
              42.546 * data.rt_tt_3rd -
              52.581 * data.rt_tt_4th +
              0.707 * data.tt_2nd_error +
              1.757 * data.tt_3rd_error -
              1.78 * data.tt_4th_error;
      
      // 모델 2 (조정된 계수 사용)
      const h2 = 72.703 +
              12.319 * data.tt_2nd_avg +
              15.625 * data.tt_3rd_avg +
              -17.944 * data.tt_4th_avg +
              7.876 * data.ip_2nd_avg +
              9.747 * data.ip_3rd_avg +
              -1.509 * data.ip_4th_avg;
      
      // 모델 3
      const h3 = 72.491 +
              16.115 * data.tt_4th_avg +
              9.204 * data.ip_4th_avg;
      
      // 모델 4
      const h4 = 81.627 +
              7.993 * data.rt_ip_2nd +
              5.399 * data.rt_ip_3rd +
              4.277 * data.rt_ip_4th +
              0.192 * data.ip_2nd_error +
              0.592 * data.ip_3rd_error +
              0.098 * data.ip_4th_error;
      
      // 모델 5
      const h5 = 61.958 +
              24.008 * data.rt_ip_2nd;
      
      // 모델 6 (손등측 모델 - 오직 dorsal 값만 사용하도록 수정)
      const rowData = data.original;
      const getValue = (obj, fieldName) => {
        for (const key in obj) {
          if (key.toLowerCase() === fieldName.toLowerCase()) {
            return parseFloat(obj[key]) || 0;
          }
        }
        return 0;
      };
      
      const h6 = 58.421 +
              5.724 * getValue(rowData, 'UT_RT_TT_2nd(dorsal)') +
              18.346 * getValue(rowData, 'UT_RT_TT_3rd(dorsal)') -
              23.185 * getValue(rowData, 'UT_RT_TT_4th(dorsal)') +
              4.512 * getValue(rowData, 'UT_RT_IP_2nd(dorsal)') +
              6.913 * getValue(rowData, 'UT_RT_IP_3rd(dorsal)') -
              1.254 * getValue(rowData, 'UT_RT_IP_4th(dorsal)') +
              4.934 * getValue(rowData, 'UT_LT_TT_2nd(dorsal)') +
              19.285 * getValue(rowData, 'UT_LT_TT_3rd(dorsal)') -
              24.162 * getValue(rowData, 'UT_LT_TT_4th(dorsal)') +
              4.395 * getValue(rowData, 'UT_LT_IP_2nd(dorsal)') +
              6.857 * getValue(rowData, 'UT_LT_IP_3rd(dorsal)') -
              1.198 * getValue(rowData, 'UT_LT_IP_4th(dorsal)');
      
      // 모델 7
      const h7 = 56.137 +
              6.245 * data.rt_tt_2nd +
              20.183 * data.rt_tt_3rd -
              24.762 * data.rt_tt_4th +
              4.967 * data.rt_ip_2nd +
              7.428 * data.rt_ip_3rd -
              1.376 * data.rt_ip_4th +
              5.873 * data.lt_tt_2nd +
              21.432 * data.lt_tt_3rd -
              25.318 * data.lt_tt_4th +
              4.521 * data.lt_ip_2nd +
              7.192 * data.lt_ip_3rd -
              1.293 * data.lt_ip_4th;
      
      // 오차율 계산 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const errorRate = (0.47 + 3.74) / 100;
      
      // 모든 모델에 대해 min/max 값 계산
      const min1 = h1 * (1 - errorRate);
      const max1 = h1 * (1 + errorRate);
      
      const min2 = h2 * (1 - errorRate);
      const max2 = h2 * (1 + errorRate);
      
      const min3 = h3 * (1 - errorRate);
      const max3 = h3 * (1 + errorRate);
      
      const min4 = h4 * (1 - errorRate);
      const max4 = h4 * (1 + errorRate);
      
      const min5 = h5 * (1 - errorRate);
      const max5 = h5 * (1 + errorRate);
      
      const min6 = h6 * (1 - errorRate);
      const max6 = h6 * (1 + errorRate);
      
      const min7 = h7 * (1 - errorRate);
      const max7 = h7 * (1 + errorRate);
      
      return {
        model1: `${min1.toFixed(2)} ~ <strong>${h1.toFixed(2)}</strong> ~ ${max1.toFixed(2)}`,
        model2: `${min2.toFixed(2)} ~ <strong>${h2.toFixed(2)}</strong> ~ ${max2.toFixed(2)}`,
        model3: `${min3.toFixed(2)} ~ <strong>${h3.toFixed(2)}</strong> ~ ${max3.toFixed(2)}`,
        model4: `${min4.toFixed(2)} ~ <strong>${h4.toFixed(2)}</strong> ~ ${max4.toFixed(2)}`,
        model5: `${min5.toFixed(2)} ~ <strong>${h5.toFixed(2)}</strong> ~ ${max5.toFixed(2)}`,
        model6: `${min6.toFixed(2)} ~ <strong>${h6.toFixed(2)}</strong> ~ ${max6.toFixed(2)}`,
        model7: `${min7.toFixed(2)} ~ <strong>${h7.toFixed(2)}</strong> ~ ${max7.toFixed(2)}`,
        exactValues: {
          model1: h1.toFixed(2),
          model2: h2.toFixed(2),
          model3: h3.toFixed(2),
          model4: h4.toFixed(2),
          model5: h5.toFixed(2),
          model6: h6.toFixed(2),
          model7: h7.toFixed(2)
        }
      };
    }
    
    // 계산 결과를 엑셀로 다운로드하는 함수
    function downloadResultsAsExcel() {
      if (!window.allMeasurementResults || !window.allMeasurementResults.length) {
        alert("다운로드할 결과가 없습니다. 엑셀 파일을 먼저 업로드하고 계산을 완료해주세요.");
        return;
      }
      
      console.log("Result data for download:", window.allMeasurementResults);
      
      try {
        // ID 중복 확인 및 인덱스 맵 생성
        const idCounts = {};
        const idIndexMap = {};
        
        window.allMeasurementResults.forEach((result, idx) => {
          if (result && result.rowData) {
            const id = result.rowData["피험자 ID"] || "";
            if (id) {
              idCounts[id] = (idCounts[id] || 0) + 1;
              idIndexMap[id] = idIndexMap[id] || [];
              idIndexMap[id].push(idx);
            }
          }
        });
        
        console.log("ID counts:", idCounts);
        console.log("ID index map:", idIndexMap);
        
        // 데이터 준비
        const resultsData = window.allMeasurementResults.map((result, index) => {
          console.log(`Processing result item ${index}:`, result);
          
          // 데이터 구조 확인
          if (!result || !result.rowData) {
            console.warn("Invalid result item, missing rowData:", result);
            return {
              "피험자 ID": `데이터 없음 (${index})`,
              "성별": "",
              "나이": "",
              "실제 키(cm)": "",
              "모델1 예측키": "",
              "모델2 예측키": "",
              "모델3 예측키": "",
              "모델4 예측키": "",
              "모델5 예측키": "",
              "모델6 예측키": "",
              "모델7 예측키": "",
              "평균 예측키": ""
            };
          }
          
          const rowData = result.rowData;
          const heights = result.heights || {};
          
          // 각 모델의 값 추출 (HTML에서 숫자만 추출)
          const getModelValue = (modelStr) => {
            if (!modelStr) return "";
            try {
              const strongMatch = modelStr.match(/<strong>([\d.]+)<\/strong>/);
              return strongMatch ? strongMatch[1] : "";
            } catch (e) {
              console.error("Error extracting model value:", e);
              return "";
            }
          };
          
          // exactValues가 있으면 그것을 사용하고 없으면 HTML에서 추출
          const getHeight = (modelName) => {
            if (heights.exactValues && heights.exactValues[modelName]) {
              return heights.exactValues[modelName];
            }
            return heights[modelName] ? getModelValue(heights[modelName]) : "";
          };
          
          const model1Height = getHeight("model1");
          const model2Height = getHeight("model2");
          const model3Height = getHeight("model3");
          const model4Height = getHeight("model4");
          const model5Height = getHeight("model5");
          const model6Height = getHeight("model6");
          const model7Height = getHeight("model7");
          
          const average = [
            parseFloat(model1Height || 0),
            parseFloat(model2Height || 0),
            parseFloat(model3Height || 0),
            parseFloat(model4Height || 0),
            parseFloat(model5Height || 0),
            parseFloat(model6Height || 0),
            parseFloat(model7Height || 0)
          ].filter(v => v > 0);
          
          const avgHeight = average.length > 0 
            ? (average.reduce((a, b) => a + b, 0) / average.length).toFixed(2)
            : "";
          
          // 성별 필드를 다양한 형태로 찾기 (gender, 성별, Gender, GENDER 등)
          let gender = "";
          for (const key in rowData) {
            const normalizedKey = key.toLowerCase().trim();
            if (normalizedKey === 'gender' || normalizedKey === '성별') {
              gender = rowData[key] || "";
              break;
            }
          }
          
          // 중복 ID 처리를 위해 인덱스 추가
          const subjectID = rowData["피험자 ID"] || "";
          let displayID = subjectID || `데이터 ${index+1}`;
          
          // 중복 ID인 경우 인덱스 추가
          if (subjectID && idCounts[subjectID] > 1) {
            const idxInGroup = idIndexMap[subjectID].indexOf(index);
            if (idxInGroup > -1) {
              displayID = `${subjectID} (${idxInGroup + 1})`;
            }
          }
          
          return {
            "피험자 ID": displayID,
            "성별": gender,
            "나이": rowData["age"] || rowData["나이"] || "",
            "실제 키(cm)": rowData["height(cm)"] || rowData["실제 키(cm)"] || "",
            "모델1 예측키": model1Height,
            "모델2 예측키": model2Height,
            "모델3 예측키": model3Height,
            "모델4 예측키": model4Height,
            "모델5 예측키": model5Height,
            "모델6 예측키": model6Height,
            "모델7 예측키": model7Height,
            "평균 예측키": avgHeight
          };
        });
        
        // 워크시트 생성
        const ws = XLSX.utils.json_to_sheet(resultsData);
        
        // 열 너비 설정
        ws['!cols'] = [
          { width: 12 }, // 피험자 ID
          { width: 8 },  // 성별
          { width: 8 },  // 나이
          { width: 14 }, // 실제 키
          { width: 14 }, // 모델1
          { width: 14 }, // 모델2
          { width: 14 }, // 모델3
          { width: 14 }, // 모델4
          { width: 14 }, // 모델5
          { width: 14 }, // 모델6
          { width: 14 }, // 모델7
          { width: 14 }  // 평균
        ];
        
        // 워크북 생성
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "키 예측 결과");
        
        // 파일 다운로드
        XLSX.writeFile(wb, "키_예측_결과.xlsx");
        
        console.log("Excel file download complete");
      } catch (error) {
        console.error("Excel download error:", error);
        alert("엑셀 파일 생성 중 오류가 발생했습니다: " + error.message);
      }
    }
  </script>
</body>
</html>
