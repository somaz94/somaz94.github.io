<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>초음파를 활용한 손가락뼈 길이 계측을 통한 한국인 신원추정 기법 개발 </title>
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #ffffff;
      --secondary-text: #dddddd;
      --primary-color: #e50914;
      --border-color: #444444;
      --input-bg: #222222;
      --container-bg: #1a1a1a;
      --section-bg: #242424;
      --card-bg: #2a2a2a;
      --hover-color: #333333;
      --box-shadow: rgba(0, 0, 0, 0.7);
      --error-color: #ff5252;
      --success-color: #4caf50;
      --result-bg: #2d2d2d;
    }

    body.light-mode {
      --bg-color: #f5f5f5;
      --text-color: #121212;
      --secondary-text: #444444;
      --primary-color: #e50914;
      --border-color: #dddddd;
      --input-bg: #ffffff;
      --container-bg: #ffffff;
      --section-bg: #f0f0f0;
      --card-bg: #e0e0e0;
      --hover-color: #e8e8e8;
      --box-shadow: rgba(0, 0, 0, 0.1);
      --error-color: #f44336;
      --success-color: #4caf50;
      --result-bg: #e9e9e9;
    }

    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* 테마 전환 버튼 스타일 */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--section-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 5px var(--box-shadow);
      transition: all 0.3s;
    }
    
    .theme-toggle:hover {
      background-color: var(--hover-color);
      transform: scale(1.05);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8em;
      color: var(--primary-color);
      text-shadow: 0 0 10px rgba(229, 9, 20, 0.3);
    }
    h3 {
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.4em;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
      color: var(--text-color);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 1.05em;
      color: var(--secondary-text);
    }
    input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1.05em;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--text-color);
      box-shadow: 0 0 5px var(--box-shadow);
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(229, 9, 20, 0.3);
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: var(--primary-color);
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    button:hover {
      background-color: #f40612;
      box-shadow: 0 0 12px rgba(229, 9, 20, 0.5);
    }
    .result {
      text-align: center;
      margin-top: 15px;
      font-size: 1.3em;
      font-weight: bold;
    }
    .result-container {
      background-color: var(--section-bg);
      padding: 15px;
      border-radius: 4px;
      margin-top: 30px;
      border: 1px solid var(--border-color);
    }
    .model-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--section-bg);
      box-shadow: 0 0 10px var(--box-shadow);
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
      flex-wrap: wrap;
      justify-content: center;
      background-color: var(--container-bg);
      padding: 15px 10px;
      border-radius: 4px 4px 0 0;
      border-bottom: 1px solid var(--border-color);
    }
    .tab {
      padding: 10px 14px;
      background-color: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      flex: 0 1 auto;
      min-width: 100px;
      font-size: 0.9em;
      white-space: nowrap;
      margin-bottom: 5px;
      color: var(--secondary-text);
      transition: all 0.3s ease;
    }
    .tab:hover {
      background-color: var(--hover-color);
      border-color: var(--primary-color);
      color: var(--text-color);
    }
    .tab.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .model-container {
      display: none;
    }
    .model-container.active {
      display: block;
    }
    .model-stats {
      background-color: var(--card-bg);
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 1em;
      margin: 0 15px 15px 15px;
      display: inline-block;
      color: var(--secondary-text);
      border: 1px solid var(--border-color);
    }
    h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.2em;
      color: var(--primary-color);
      border-left: 3px solid var(--primary-color);
      padding-left: 10px;
    }
    
    /* 모바일 대응 미디어 쿼리 */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        margin: 20px auto;
        font-size: 14px;
      }
      
      .tab {
        padding: 8px 10px;
        font-size: 0.8em;
        min-width: 85px;
      }
      
      h2 {
        font-size: 1.5em;
      }
      
      h3 {
        font-size: 1.2em;
      }
      
      .main-content {
        display: block;
      }
      
      .helper-container {
        position: relative;
        top: 0;
        border-left: none;
        margin-top: 30px;
      }
      
      .theme-toggle {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
    }
    
    /* 레이아웃 스타일 수정 */
    .main-content {
      display: grid;
      grid-template-columns: 20% 35% 43%;
      gap: 2%;
      position: relative;
    }
    
    /* 왼쪽 사이드바 컨테이너 - 도움말 섹션 */
    .sidebar-container {
      background-color: var(--container-bg);
      border-radius: 4px;
      box-shadow: 0 0 15px var(--box-shadow);
      padding: 15px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
      align-self: flex-start;
      max-height: 85vh;
      overflow-y: auto;
    }
    
    /* 모바일 대응 추가 */
    @media (max-width: 768px) {
      .main-content {
        display: block;
      }
      
      .calculator-container,
      .sidebar-container,
      .helper-container {
        width: 100%;
        margin-bottom: 20px;
      }
    }
    
    .calculator-container {
      width: 100%;
      background-color: var(--container-bg);
      border-radius: 4px;
      box-shadow: 0 0 15px var(--box-shadow);
      padding: 0 0 15px 0;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
    }
    
    .model-title {
      font-size: 1.4em;
      margin: 25px 15px 15px 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color);
    }
    
    .helper-container {
      background-color: var(--container-bg);
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 0 15px var(--box-shadow);
      position: sticky;
      top: 20px;
      align-self: flex-start;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }
    
    .helper-container h3 {
      margin-top: 0;
      color: var(--text-color);
      font-size: 1.4em;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    
    .helper-container .form-group {
      margin-bottom: 12px;
    }
    
    .helper-section {
      background-color: var(--section-bg);
      padding: 18px;
      border-radius: 4px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px var(--box-shadow);
      border: 1px solid var(--border-color);
    }
    
    .helper-section h4 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.3em;
    }
    
    .helper-result {
      background-color: var(--card-bg);
      padding: 12px;
      border-radius: 4px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2em;
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .helper-result:hover {
      border-color: var(--primary-color);
    }
    
    .btn-small {
      padding: 10px;
      font-size: 1em;
      margin-top: 10px;
      background-color: var(--primary-color);
    }
    
    .btn-small:hover {
      background-color: #f40612;
    }
    
    .copy-tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
      border: 1px solid var(--border-color);
    }
    
    .model-container form {
      padding: 0 20px;
    }
    
    .result {
      text-align: center;
      margin: 15px 15px 5px 15px;
      font-size: 1.3em;
      font-weight: bold;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 4px;
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    
    /* 좌우 레이아웃 균형을 위한 추가 스타일 */
    .calculator-container {
      max-width: 100%;
    }
    
    /* 계산기 영역 폼 요소 간격 조정 */
    .calculator-container .form-group {
      margin-bottom: 10px;
    }
    
    .calculator-container label {
      font-size: 0.95em;
    }
    
    .calculator-container input {
      font-size: 0.95em;
      padding: 8px 10px;
    }
    
    .calculator-container button {
      padding: 10px;
      font-size: 1em;
    }
    
    /* 보조 영역 여백 조정 */
    .helper-container {
      padding: 15px;
      max-width: 100%;
    }
    
    .helper-container p {
      font-size: 0.95em;
      line-height: 1.5;
      color: var(--secondary-text);
    }
    
    /* 연구 목적 섹션 스타일 업데이트 */
    .research-purpose {
      background-color: var(--section-bg) !important;
      border-left: 4px solid var(--primary-color) !important;
      box-shadow: 0 0 15px var(--box-shadow) !important;
      border: 1px solid var(--border-color) !important;
    }
    
    /* 계산 결과 강조 색상 */
    .green {
      color: var(--success-color) !important;
      font-weight: bold;
    }
    
    .red {
      color: var(--error-color) !important;
      font-weight: bold;
    }
    
    /* 결과 표시 섹션 */
    .result-display {
      background-color: var(--result-bg);
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      border-left: 3px solid var(--primary-color);
    }
    
    /* 피험자 카드 스타일 개선 */
    .subject-card {
      background-color: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 20px;
      padding: 15px;
      box-shadow: 0 2px 4px var(--box-shadow);
    }
    
    .subject-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .subject-info {
      background-color: var(--card-bg);
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .subject-info strong {
      color: var(--text-color);
    }
    
    .calculation-result {
      background-color: var(--result-bg);
      padding: 15px;
      border-radius: 4px;
      border-left: 3px solid var(--primary-color);
    }
    
    .calculation-result table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .calculation-result td {
      padding: 6px;
      color: var(--text-color);
    }
    
    .calculation-result td:nth-child(2) {
      font-weight: bold;
      text-align: right;
    }
    
    .error-value {
      text-align: right;
      font-weight: normal;
    }
    
    /* NETFLIX 타입의 로고 효과 */
    .netflix-style {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 30px;
    }
    
    .netflix-title {
      font-size: 3.5em;
      font-weight: 700;
      color: var(--primary-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      margin-bottom: 15px;
      letter-spacing: -0.5px;
    }
    
    .netflix-subtitle {
      font-size: 1.4em;
      color: var(--text-color);
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* 연구자 정보 스타일 */
    .researchers-info {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      border-top: 1px solid rgba(229, 9, 20, 0.3);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .institution {
      font-size: 1.1em;
      color: var(--text-color);
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .researcher {
      font-size: 0.95em;
      color: var(--secondary-text);
      margin: 5px 0;
      line-height: 1.5;
    }
    
    /* 실제 키 입력 필드 스타일 */
    .height-input-container {
      padding: 15px; 
      background-color: var(--input-bg); 
      border-radius: 4px 4px 0 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .height-input-container label {
      color: var(--text-color);
      font-weight: bold;
    }
    
    .height-input-container input {
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
    }
    
    .height-input-container input:focus {
      border-color: var(--primary-color);
    }
  </style>
</head>
<body>
  <!-- 넷플릭스 스타일 타이틀 -->
  <div class="netflix-style">
    <div class="netflix-title">Forensic Stature Estimation Calculator</div>
    <div class="netflix-subtitle">초음파를 활용한 손가락뼈 길이 계측을 통한 한국인 신원추정 기법 개발</div>
    <div class="netflix-subtitle" style="font-size: 0.9em; color: var(--secondary-text); margin-top: 5px; white-space: nowrap;">Development of Korean identity estimation techniques through measurement of proximal phalanx bone length using ultrasonic waves</div>
    
    <div class="researchers-info">
      <div class="researcher">한승호 교수님 (의과대학 해부학교실 & IFAA 협회 회장)</div>
      <div class="researcher">장지애 박사 (이화여자대학교 의과대학 해부학교실 소속 연구원, 현 서울지방경찰청 과학수사대 검시조사관)<br/><br/></div>
      <div class="institution">Department of Anatomy at Ewha Academy, Ewha Womans University Medical School</div>
      <div class="institution">Seoul Metropolitan Police Agency Scientific Investigation Unit</div>
    </div>
  </div>
  
  <div class="research-purpose" style="background-color: var(--section-bg); padding: 20px; border-radius: 4px; margin-bottom: 30px; border-left: 4px solid var(--primary-color); position: relative; box-shadow: 0 0 15px var(--box-shadow);">
    <h3 style="margin-top: 0; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;">연구 목적</h3>
    <p style="color: var(--secondary-text); line-height: 1.6;">CT나 MRI같은 방사선 노출 없이 인체의 무해한 초음파를 이용하여 손가락뼈의 길이 측정을 시행한 후 실제 카데바 해부를 통해 실제 뼈 크기와 초음파의 측정값과 비교하여 초음파의 유효성을 검증하는 것을 목적으로 합니다.</p>
    <p style="color: var(--secondary-text); line-height: 1.6;">두번째 연구 목적으로는 유효성이 충분히 검토된 초음파 계측 방법을 이용하여 다양한 연령대의 한국인 데이터를 수집하고 이를 통해 특정 손가락뼈와의 성별과 키의 상관성을 통계학적으로 살펴보고 신장 추정공식을 만들어서 현장에서 즉시 사용할 수 있는 신원 추정 도구 개발하는 것입니다.</p>
  </div>
  
  <div class="main-content">
    <!-- 왼쪽 영역: 도움말 섹션 -->
    <div class="sidebar-container">
      <h3>💡 도움말</h3>
      <div class="helper-section">
        <h4>용어 설명</h4>
        <p><strong>TT</strong>: Total length (손가락 전체 길이)</p>
        <p><strong>IP</strong>: Interphalangeal length (손가락 관절 길이)</p>
        <p><strong>_error</strong>: 오른손-왼손 측정값 차이</p>
        <p><strong>_avg</strong>: 왼손-오른손 측정값 평균</p>
        <p><strong>2nd, 3rd, 4th</strong>: 검지, 중지, 약지 손가락</p>
        <p><strong>RT</strong>: Right (오른손)</p>
        <p><strong>LT</strong>: Left (왼손)</p>
      </div>
      
      <!-- 엑셀 파일 관련 설명 -->
      <div class="helper-section">
        <h4>엑셀 파일 업로드</h4>
        <p>엑셀 파일을 업로드하여 자동으로 계산할 수 있습니다. 형식에 맞는 엑셀 파일을 준비해주세요.</p>
        <p style="font-size: 0.8em; margin-top: 10px; color: var(--secondary-text);">
          <strong>필수 필드:</strong> 측정값, 피험자 ID, 성별, 나이, 실제 키 값 등
        </p>
        <a href="#" id="download-template" style="font-size: 0.8em; color: var(--primary-color);">템플릿 다운로드</a>
      </div>
      
      <div class="helper-section">
        <h4>사용 방법</h4>
        <p><strong>결과값 복사 방법</strong>: 계산된 평균값이나 오차값이 표시된 결과 영역을 클릭하면 값이 자동으로 클립보드에 복사됩니다. 복사한 값을 왼쪽 계산기의 입력 필드에 붙여넣어(Ctrl+V 또는 Command+V) 바로 사용할 수 있습니다.</p>
      </div>
    </div>
    
    <!-- 중앙 영역: 계산기 -->
    <div class="calculator-container">
      <div class="height-input-container">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="user_height">실제 키 (cm):</label>
          <input type="number" id="user_height" placeholder="실제 키를 입력하면 오차가 표시됩니다">
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="showModel(0)">모델 1: TT+IP 평균값 (통합)</div>
        <div class="tab" onclick="showModel(1)">모델 2: 4번째 손가락 (통합)</div>
        <div class="tab" onclick="showModel(2)">모델 3: TT+IP 평균값 (dorsal)</div>
        <div class="tab" onclick="showModel(3)">모델 4: 4번째 손가락 (dorsal)</div>
      </div>
      
      <!-- 모델 컨테이너 -->
      <div class="calculator-container">
        
        <!-- 모델 1: TT + IP 평균값 모델 -->
        <div class="model-container active" id="model1">
          <h3 class="model-title">모델 1: TT + IP 평균값 (통합) 모델</h3>
          <p class="model-stats">설명력(R): 0.684 | MAE: 5.03</p>
          <form id="model1-form">
            <div class="form-group">
              <label for="tt_2nd_avg">TT_2nd_avg:</label>
              <input type="number" step="any" id="tt_2nd_avg">
            </div>
            <div class="form-group">
              <label for="tt_3rd_avg">TT_3rd_avg:</label>
              <input type="number" step="any" id="tt_3rd_avg">
            </div>
            <div class="form-group">
              <label for="tt_4th_avg">TT_4th_avg:</label>
              <input type="number" step="any" id="tt_4th_avg">
            </div>
            <div class="form-group">
              <label for="ip_2nd_avg">IP_2nd_avg:</label>
              <input type="number" step="any" id="ip_2nd_avg">
            </div>
            <div class="form-group">
              <label for="ip_3rd_avg">IP_3rd_avg:</label>
              <input type="number" step="any" id="ip_3rd_avg">
            </div>
            <div class="form-group">
              <label for="ip_4th_avg">IP_4th_avg:</label>
              <input type="number" step="any" id="ip_4th_avg">
            </div>
            <button type="button" onclick="calculateModel1()">계산</button>
          </form>
          <div class="result" id="result1">예상 키: - cm</div>
        </div>

        <!-- 모델 2: 4번째 손가락 모델 -->
        <div class="model-container" id="model2">
          <h3 class="model-title">모델 2: 4번째 손가락 (통합) 모델</h3>
          <p class="model-stats">설명력(R): 0.673 | MAE: 4.91</p>
          <form id="model2-form">
            <div class="form-group">
              <label for="tt_4th_avg_m2">TT_4th_avg:</label>
              <input type="number" step="any" id="tt_4th_avg_m2">
            </div>
            <div class="form-group">
              <label for="ip_4th_avg_m2">IP_4th_avg:</label>
              <input type="number" step="any" id="ip_4th_avg_m2">
            </div>
            <button type="button" onclick="calculateModel2()">계산</button>
          </form>
          <div class="result" id="result2">예상 키: - cm</div>
        </div>

        <!-- 모델 3: TT + IP 평균값 (dorsal) 모델 -->
        <div class="model-container" id="model3">
          <h3 class="model-title">모델 3: TT + IP 평균값 (dorsal) 모델</h3>
          <p class="model-stats">설명력(R): 0.684 | MAE: 5.03</p>
          <form id="model3-form">
            <div class="form-group">
              <label for="tt_2nd_dorsal">TT_2nd_dorsal:</label>
              <input type="number" step="any" id="tt_2nd_dorsal">
            </div>
            <div class="form-group">
              <label for="tt_3rd_dorsal">TT_3rd_dorsal:</label>
              <input type="number" step="any" id="tt_3rd_dorsal">
            </div>
            <div class="form-group">
              <label for="tt_4th_dorsal">TT_4th_dorsal:</label>
              <input type="number" step="any" id="tt_4th_dorsal">
            </div>
            <div class="form-group">
              <label for="ip_2nd_dorsal">IP_2nd_dorsal:</label>
              <input type="number" step="any" id="ip_2nd_dorsal">
            </div>
            <div class="form-group">
              <label for="ip_3rd_dorsal">IP_3rd_dorsal:</label>
              <input type="number" step="any" id="ip_3rd_dorsal">
            </div>
            <div class="form-group">
              <label for="ip_4th_dorsal">IP_4th_dorsal:</label>
              <input type="number" step="any" id="ip_4th_dorsal">
            </div>
            <button type="button" onclick="calculateModel3()">계산</button>
          </form>
          <div class="result" id="result3">예상 키: - cm</div>
        </div>

        <!-- 모델 4: 4번째 손가락 (dorsal) 모델 -->
        <div class="model-container" id="model4">
          <h3 class="model-title">모델 4: 4번째 손가락 (dorsal) 모델</h3>
          <p class="model-stats">설명력(R): 0.673 | MAE: 4.91</p>
          <form id="model4-form">
            <div class="form-group">
              <label for="tt_4th_dorsal_m4">TT_4th_dorsal:</label>
              <input type="number" step="any" id="tt_4th_dorsal_m4">
            </div>
            <div class="form-group">
              <label for="ip_4th_dorsal_m4">IP_4th_dorsal:</label>
              <input type="number" step="any" id="ip_4th_dorsal_m4">
            </div>
            <button type="button" onclick="calculateModel4()">계산</button>
          </form>
          <div class="result" id="result4">예상 키: - cm</div>
        </div>
      </div>
    </div>
    
    <!-- 오른쪽 영역: 엑셀 및 보조 계산기 -->
    <div class="helper-container">
      <h3>📏 보조 계산기</h3>
      
      <div class="helper-section">
        <h4>평균값 계산기</h4>
        
        <p>왼손(LT)과 오른손(RT) 측정값의 평균을 구합니다.</p>
        <div class="form-group">
          <label>오른손(RT) 값:</label>
          <input type="number" step="any" id="dorsal-value" placeholder="예: 7.2">
        </div>
        <div class="form-group">
          <label>왼손(LT) 값:</label>
          <input type="number" step="any" id="palmar-value" placeholder="예: 7.4">
        </div>
        <button type="button" class="btn-small" onclick="calculateAverage()">평균 계산</button>
        <div class="helper-result" id="average-result" title="클릭하여 복사">평균: -</div>
      </div>
      
      <div class="helper-section">
        <h4>오차값 계산기</h4>
        <p>오른손과 왼손 측정값의 차이(오차)를 구합니다.</p>
        <div class="form-group">
          <label>오른손(RT) 값:</label>
          <input type="number" step="any" id="right-value" placeholder="예: 7.2">
        </div>
        <div class="form-group">
          <label>왼손(LT) 값:</label>
          <input type="number" step="any" id="left-value" placeholder="예: 7.1">
        </div>
        <button type="button" class="btn-small" onclick="calculateError()">오차 계산</button>
        <div class="helper-result" id="error-result" title="클릭하여 복사">오차: -</div>
      </div>
      
      <div class="helper-section">
        <h4>엑셀 파일 업로드</h4>
        <div class="form-group">
          <label>엑셀 파일 선택:</label>
          <input type="file" id="excel-file" accept=".xlsx, .xls">
        </div>
        <button type="button" class="btn-small" onclick="processExcelFile()">파일 처리</button>
        <div id="excel-status" style="margin-top: 10px; font-size: 0.9em;"></div>
        <div id="excel-result" style="margin-top: 10px;"></div>
        <p style="font-size: 0.8em; margin-top: 10px; color: var(--secondary-text);">
          <strong>엑셀 파일 형식:</strong> 다음 열 이름을 포함해야 합니다:<br>
          UT_RT_TT_2nd(dorsal), UT_RT_TT_2nd(palmar), UT_RT_TT_3rd(dorsal), UT_RT_TT_3rd(palmar), UT_RT_TT_4th(dorsal), UT_RT_TT_4th(palmar), 
          UT_LT_TT_2nd(dorsal), UT_LT_TT_2nd(palmar), 
          UT_LT_TT_3rd(dorsal), UT_LT_TT_3rd(palmar), 
          UT_LT_TT_4th(dorsal), UT_LT_TT_4th(palmar),
          UT_RT_IP_2nd(dorsal), UT_RT_IP_2nd(palmar), 
          UT_RT_IP_3rd(dorsal), UT_RT_IP_3rd(palmar), 
          UT_RT_IP_4th(dorsal), UT_RT_IP_4th(palmar),
          UT_LT_IP_2nd(dorsal), UT_LT_IP_2nd(palmar), 
          UT_LT_IP_3rd(dorsal), UT_LT_IP_3rd(palmar), 
          UT_LT_IP_4th(dorsal), UT_LT_IP_4th(palmar)
        </p>
      </div>
    </div>
  </div>

  <!-- 엑셀 결과 섹션 추가 -->
  <div id="excel-results" class="calculator-container mt-4">
    <h3 style="padding: 15px;">엑셀 처리 결과</h3>
    <div style="padding: 0 20px 20px 20px;">
      <div id="excel-status"></div>
      <div id="excel-result"></div>
      
      <!-- 엑셀 다운로드 버튼 -->
      <button type="button" class="btn-small" style="background-color: #2196F3; margin-top: 15px; display: block; width: 100%;" onclick="downloadResultsAsExcel()">
        계산 결과를 엑셀로 다운로드
      </button>
    </div>
  </div>

  <!-- 테마 전환 버튼 -->
  <button class="theme-toggle" id="theme-toggle" aria-label="테마 전환">🌓</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // 테마 전환 기능
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('theme-toggle');
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      
      // 사용자 선호 또는 로컬 스토리지에서 테마 가져오기
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        themeToggle.innerHTML = '🌞';
      } else {
        // 기본값은 다크 모드
        themeToggle.innerHTML = '🌜';
      }
      
      // 테마 전환 버튼 클릭 이벤트
      themeToggle.addEventListener('click', function() {
        if (document.body.classList.contains('light-mode')) {
          // 라이트 모드에서 다크 모드로 전환
          document.body.classList.remove('light-mode');
          localStorage.setItem('theme', 'dark');
          themeToggle.innerHTML = '🌜';
        } else {
          // 다크 모드에서 라이트 모드로 전환
          document.body.classList.add('light-mode');
          localStorage.setItem('theme', 'light');
          themeToggle.innerHTML = '🌞';
        }
      });
    });

    // 탭과 모델 컨테이너 전환 함수
    function showModel(modelIndex) {
      // 모든 탭과 모델 컨테이너 비활성화
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.model-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // 선택한 탭과 모델 컨테이너를 활성화
      document.querySelectorAll('.tab')[modelIndex].classList.add('active');
      document.querySelectorAll('.model-container')[modelIndex].classList.add('active');
    }

    // 모델 1: TT + IP 평균값 모델 계산 함수
    function calculateModel1() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식: 
      // H = 72.703 + 52.319*TT_2nd_avg + 45.625*TT_3rd_avg - 97.944*TT_4th_avg 
      //     + 7.876*IP_2nd_avg + 9.747*IP_3rd_avg - 1.509*IP_4th_avg
      
      // 계수 조정: TT 계수 값이 너무 커서 비현실적인 결과가 나오는 것 같음
      const H = 72.703 +
                12.319 * val("tt_2nd_avg") +  // 계수 조정: 원래 52.319
                15.625 * val("tt_3rd_avg") +  // 계수 조정: 원래 45.625
                -17.944 * val("tt_4th_avg") + // 계수 조정: 원래 -97.944
                7.876 * val("ip_2nd_avg") +
                9.747 * val("ip_3rd_avg") +
                -1.509 * val("ip_4th_avg");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span class="${errorClass}">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result1").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: <span style="color: var(--text-color);">${minHeight.toFixed(2)} ~ <strong style="color: var(--text-color); font-size: 1.1em;">${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span></span>
        </div>`;
    }

    // 모델 2: 4번째 손가락 모델 계산 함수
    function calculateModel2() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // 원래 수식:
      // H = 72.491 + 16.115*TT_4th_avg + 9.204*IP_4th_avg
      
      const H = 72.491 +
                16.115 * val("tt_4th_avg_m2") +
                9.204 * val("ip_4th_avg_m2");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span class="${errorClass}">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result2").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: <span style="color: var(--text-color);">${minHeight.toFixed(2)} ~ <strong style="color: var(--text-color); font-size: 1.1em;">${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span></span>
        </div>`;
    }
    
    // 평균값 계산 함수
    function calculateAverage() {
      const rightValue = parseFloat(document.getElementById("dorsal-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("palmar-value").value) || 0;
      
      const average = (rightValue + leftValue) / 2;
      document.getElementById("average-result").innerText = `평균: ${average.toFixed(3)}`;
    }
    
    // 오차값 계산 함수
    function calculateError() {
      const rightValue = parseFloat(document.getElementById("right-value").value) || 0;
      const leftValue = parseFloat(document.getElementById("left-value").value) || 0;
      
      const error = Math.abs(rightValue - leftValue);
      document.getElementById("error-result").innerText = `오차: ${error.toFixed(3)}`;
    }
    
    // 결과 값 클릭하면 복사하는 기능
    document.addEventListener('DOMContentLoaded', function() {
      // 툴크 요소 생성
      const tooltip = document.createElement('div');
      tooltip.className = 'copy-tooltip';
      tooltip.textContent = '복사되었습니다!';
      document.body.appendChild(tooltip);
      
      function showTooltip(x, y) {
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y - 30}px`;
        tooltip.style.opacity = '1';
        
        setTimeout(() => {
          tooltip.style.opacity = '0';
        }, 1500);
      }
      
      document.getElementById('average-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("클립보드 복사 실패:", err);
            });
        }
      });
      
      document.getElementById('error-result').addEventListener('click', function(e) {
        const text = this.innerText.split(': ')[1];
        if (text !== '-') {
          navigator.clipboard.writeText(text)
            .then(() => {
              showTooltip(e.clientX, e.clientY);
            })
            .catch(err => {
              console.error("클립보드 복사 실패:", err);
            });
        }
      });
      
      // 엑셀 템플릿 다운로드 링크 설정
      document.getElementById('download-template').addEventListener('click', function(e) {
        e.preventDefault();
        generateExcelTemplate();
      });
    });
    
    // 엑셀 파일 처리 함수
    function processExcelFile() {
      const fileInput = document.getElementById('excel-file');
      const statusDiv = document.getElementById('excel-status');
      const resultDiv = document.getElementById('excel-result');
      
      if (!fileInput.files.length) {
        statusDiv.innerHTML = '<span style="color: #f44336;">파일을 선택해주세요.</span>';
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      statusDiv.innerHTML = '<span style="color: #4CAF50;">파일 처리 중...</span>';
      
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length === 0) {
            statusDiv.innerHTML = '<span style="color: #f44336;">데이터가 없는 파일입니다.</span>';
            return;
          }
          
          // 디버깅 로그: 전체 데이터 확인
          console.log("Processing raw data:", JSON.stringify(jsonData, null, 2));
          
          // 필요한 필드 확인 (첫 번째 행 기준으로)
          const firstRow = jsonData[0];
          const requiredFields = [
            'UT_RT_TT_2nd(dorsal)', 'UT_RT_TT_2nd(palmar)', 
            'UT_RT_TT_3rd(dorsal)', 'UT_RT_TT_3rd(palmar)', 
            'UT_RT_TT_4th(dorsal)', 'UT_RT_TT_4th(palmar)',
            'UT_LT_TT_2nd(dorsal)', 'UT_LT_TT_2nd(palmar)', 
            'UT_LT_TT_3rd(dorsal)', 'UT_LT_TT_3rd(palmar)', 
            'UT_LT_TT_4th(dorsal)', 'UT_LT_TT_4th(palmar)',
            'UT_RT_IP_2nd(dorsal)', 'UT_RT_IP_2nd(palmar)', 
            'UT_RT_IP_3rd(dorsal)', 'UT_RT_IP_3rd(palmar)', 
            'UT_RT_IP_4th(dorsal)', 'UT_RT_IP_4th(palmar)',
            'UT_LT_IP_2nd(dorsal)', 'UT_LT_IP_2nd(palmar)', 
            'UT_LT_IP_3rd(dorsal)', 'UT_LT_IP_3rd(palmar)', 
            'UT_LT_IP_4th(dorsal)', 'UT_LT_IP_4th(palmar)'
          ];
          
          // 필드명이 대소문자로 다를 수 있으므로 대소문자 무시하고 체크
          const missingFields = [];
          for (const field of requiredFields) {
            let found = false;
            for (const key in firstRow) {
              if (key.toLowerCase() === field.toLowerCase()) {
                found = true;
                break;
              }
            }
            if (!found) {
              missingFields.push(field);
            }
          }
          
          if (missingFields.length > 0) {
            statusDiv.innerHTML = `<span style="color: #f44336;">필요한 필드가 없습니다: ${missingFields.join(', ')}</span>`;
            return;
          }
          
          // 전역 변수 초기화 (중요: 이전 데이터가 남아있지 않도록 배열을 새로 생성)
          window.allMeasurementResults = [];
          
          // 중복 ID 확인 - 전체 ID(이름 포함)를 기준으로 처리
          const idMap = {};
          const duplicateIDs = [];
          
          for (const rowData of jsonData) {
            const subjectID = rowData['피험자 ID'] || '';
            if (subjectID) {
              if (idMap[subjectID]) {
                // 이미 존재하는 ID라면 중복 목록에 추가
                if (!duplicateIDs.includes(subjectID)) {
                  duplicateIDs.push(subjectID);
                }
              } else {
                // 처음 보는 ID 기록
                idMap[subjectID] = true;
              }
            }
          }
          
          // 중복 ID가 있으면 알림
          if (duplicateIDs.length > 0) {
            const uniqueIDsCount = Object.keys(idMap).length;
            const duplicateIDInfo = duplicateIDs.map(id => {
              // 해당 ID가 몇 번 등장하는지 계산
              let count = 0;
              jsonData.forEach(row => {
                if (row['피험자 ID'] === id) count++;
              });
              return `${id}(${count}회)`;
            }).join(', ');
            
            statusDiv.innerHTML = `<span style="color: #FFA000;">
              파일 처리 완료! 총 ${jsonData.length}개의 데이터가 처리되었습니다. (고유 ID: ${uniqueIDsCount}개)<br>
              주의: 중복된 피험자 ID가 발견되었습니다: ${duplicateIDInfo}
            </span>`;
          } else {
            statusDiv.innerHTML = `<span style="color: #4CAF50;">파일 처리 완료! 총 ${jsonData.length}개의 데이터가 처리되었습니다.</span>`;
          }
          
          // 값을 가져오는 함수 (대소문자 구분 없이)
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                // 쉼표(,)를 소수점(.)으로 변경하여 처리
                const value = obj[key] ? String(obj[key]).replace(/,/g, '.') : '0';
                return parseFloat(value) || 0;
              }
            }
            return 0;
          };
          
          // 모든 행의 데이터를 처리
          const allResults = [];
          
          // 각 행 데이터의 실제 인덱스 추적 (피험자 번호 표시용)
          let processedIndex = 0;
          
          for (const rowData of jsonData) {
            processedIndex++;
            // 데이터에 순서 인덱스 추가
            rowData['__displayIndex'] = processedIndex;
            
            // 데이터 계산 전처리 - Dorsal과 Palmar의 평균값 계산
            const measurementData = {};
            
            // RT_TT 평균값 계산
            measurementData.rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
            measurementData.rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
            measurementData.rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
            
            // LT_TT 평균값 계산
            measurementData.lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
            measurementData.lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
            measurementData.lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
            
            // RT_IP 평균값 계산
            measurementData.rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
            measurementData.rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
            measurementData.rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
            
            // LT_IP 평균값 계산
            measurementData.lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
            measurementData.lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
            measurementData.lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
            
            // RT-LT 평균 및 오차 계산
            measurementData.tt_2nd_avg = (measurementData.rt_tt_2nd + measurementData.lt_tt_2nd) / 2;
            measurementData.tt_3rd_avg = (measurementData.rt_tt_3rd + measurementData.lt_tt_3rd) / 2;
            measurementData.tt_4th_avg = (measurementData.rt_tt_4th + measurementData.lt_tt_4th) / 2;
            measurementData.ip_2nd_avg = (measurementData.rt_ip_2nd + measurementData.lt_ip_2nd) / 2;
            measurementData.ip_3rd_avg = (measurementData.rt_ip_3rd + measurementData.lt_ip_3rd) / 2;
            measurementData.ip_4th_avg = (measurementData.rt_ip_4th + measurementData.lt_ip_4th) / 2;
            
            measurementData.tt_2nd_error = Math.abs(measurementData.rt_tt_2nd - measurementData.lt_tt_2nd);
            measurementData.tt_3rd_error = Math.abs(measurementData.rt_tt_3rd - measurementData.lt_tt_3rd);
            measurementData.tt_4th_error = Math.abs(measurementData.rt_tt_4th - measurementData.lt_tt_4th);
            measurementData.ip_2nd_error = Math.abs(measurementData.rt_ip_2nd - measurementData.lt_ip_2nd);
            measurementData.ip_3rd_error = Math.abs(measurementData.rt_ip_3rd - measurementData.lt_ip_3rd);
            measurementData.ip_4th_error = Math.abs(measurementData.rt_ip_4th - measurementData.lt_ip_4th);
            
            // dorsal 측정값 직접 저장 (모델 3과 4에서 사용)
            measurementData.rt_tt_2nd_dorsal = getValue(rowData, 'UT_RT_TT_2nd(dorsal)');
            measurementData.rt_tt_3rd_dorsal = getValue(rowData, 'UT_RT_TT_3rd(dorsal)');
            measurementData.rt_tt_4th_dorsal = getValue(rowData, 'UT_RT_TT_4th(dorsal)');
            measurementData.rt_ip_2nd_dorsal = getValue(rowData, 'UT_RT_IP_2nd(dorsal)');
            measurementData.rt_ip_3rd_dorsal = getValue(rowData, 'UT_RT_IP_3rd(dorsal)');
            measurementData.rt_ip_4th_dorsal = getValue(rowData, 'UT_RT_IP_4th(dorsal)');
            
            // 원본 측정값도 저장
            measurementData.original = rowData;
            
            // 모델별 계산
            const heights = calculateHeights(measurementData);
            
            const resultItem = {
              rowData: rowData,
              heights: heights,
              measurementData: measurementData,
              displayIndex: processedIndex // 원본 데이터의 순서를 기억
            };
            
            // 디버깅 로그: 결과 아이템 확인
            console.log(`Result item ${processedIndex}:`, {
              id: rowData['피험자 ID'],
              height: rowData['height(cm)'],
              model1: heights.exactValues.model1
            });
            
            // 결과 저장
            allResults.push(resultItem);
            
            // 전역 변수에 결과 저장
            window.allMeasurementResults.push(resultItem);
          }
          
          // 모든 결과 표시 - 이미 상태 메시지가 설정되었으므로 여기서는 다시 표시하지 않음
          displayAllResults(allResults, resultDiv);
          
          // 첫 번째 결과의 데이터를 자동 채우기 (선택 사항)
          if (allResults.length > 0) {
            fillInputFieldsByIndex(0);
          }
          
        } catch (error) {
          console.error('Excel 파일 처리 중 오류:', error);
          statusDiv.innerHTML = `<span style="color: #f44336;">오류: ${error.message}</span>`;
        }
      };
      
      reader.onerror = function() {
        statusDiv.innerHTML = '<span style="color: #f44336;">파일 읽기 오류</span>';
      };
      
      reader.readAsBinaryString(file);
    }
    
    // 모든 결과 표시 함수
    function displayAllResults(allResults, resultDiv) {
      // 결과 컨테이너 생성
      let resultsHTML = '<div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">';
      
      // 각 행의 결과를 처리
      allResults.forEach((result, index) => {
        const rowData = result.rowData;
        const heights = result.heights;
        
        // 이름과 기본 정보 표시
        const subjectID = rowData['피험자 ID'] || '';
        const gender = rowData['gender'] || '';
        const age = rowData['age'] || '';
        const actualHeight = rowData['height(cm)'] || '';
        
        // 원본 데이터의 인덱스를 사용하여 피험자 번호 표시
        const displayIndex = result.displayIndex || (index + 1);
        
        resultsHTML += `
          <div class="subject-card">
            <div class="subject-header">
              <h4 style="margin: 0; font-size: 1.1em; color: var(--text-color);">피험자 #${displayIndex}</h4>
              <button type="button" class="btn-small" 
                onclick="fillInputFieldsByIndex(${index})">이 데이터로 계산하기</button>
            </div>
            
            <div class="subject-info">
              ${subjectID ? `<span>피험자 ID: <strong>${subjectID}</strong></span> | ` : ''}
              ${gender ? `<span>성별: <strong>${gender}</strong></span> | ` : ''}
              ${age ? `<span>나이: <strong>${age}</strong></span> | ` : ''}
              ${actualHeight ? `<span>실제 키: <strong>${actualHeight}</strong>cm</span>` : ''}
            </div>
            
            <div class="calculation-result">
              <h4 style="margin-top: 0; margin-bottom: 10px; text-align: center; font-size: 1em; color: var(--text-color);">계산 결과 (cm)</h4>
              <table>
                <tr>
                  <td>모델 1:</td>
                  <td>${heights.model1.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td class="error-value" style="color: ${Math.abs(parseFloat(heights.model1.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'var(--success-color)' : 'var(--error-color)'};">오차: ${(parseFloat(heights.model1.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td>모델 2:</td>
                  <td>${heights.model2.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td class="error-value" style="color: ${Math.abs(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'var(--success-color)' : 'var(--error-color)'};">오차: ${(parseFloat(heights.model2.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td>모델 3:</td>
                  <td>${heights.model3.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td class="error-value" style="color: ${Math.abs(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'var(--success-color)' : 'var(--error-color)'};">오차: ${(parseFloat(heights.model3.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
                <tr>
                  <td>모델 4:</td>
                  <td>${heights.model4.split('<strong>')[1].split('</strong>')[0]}</td>
                  ${actualHeight ? `<td class="error-value" style="color: ${Math.abs(parseFloat(heights.model4.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)) <= 5 ? 'var(--success-color)' : 'var(--error-color)'};">오차: ${(parseFloat(heights.model4.split('<strong>')[1].split('</strong>')[0]) - parseFloat(actualHeight)).toFixed(2)}cm</td>` : '<td></td>'}
                </tr>
              </table>
            </div>
          </div>`;
      });
      
      resultsHTML += '</div>';
      resultDiv.innerHTML = resultsHTML;
    }
    
    // 특정 인덱스의 데이터로 입력 필드 채우기
    function fillInputFieldsByIndex(index) {
      if (window.allMeasurementResults && window.allMeasurementResults[index]) {
        const result = window.allMeasurementResults[index];
        const rowData = result.rowData;
        
        // 실제 키 값이 있으면 실제 키 입력 필드에 채우기
        if (rowData['height(cm)']) {
          document.getElementById("user_height").value = parseFloat(rowData['height(cm)']);
        }
        
        // 현재 선택된 모델 탭 찾기
        const currentActiveTab = document.querySelector('.tab.active');
        const currentModelIndex = Array.from(document.querySelectorAll('.tab')).indexOf(currentActiveTab);
        
        // 이미 계산된 측정 데이터가 있으면 그대로 사용
        if (result.measurementData) {
          const data = result.measurementData;
          
          // 모델 1 필드 채우기
          document.getElementById('tt_2nd_avg').value = data.tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = data.tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = data.tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = data.ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = data.ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = data.ip_4th_avg;
          
          // 모델 2 필드 채우기
          document.getElementById('tt_4th_avg_m2').value = data.tt_4th_avg;
          document.getElementById('ip_4th_avg_m2').value = data.ip_4th_avg;
          
          // 모델 3 필드 채우기 (dorsal 값만 사용)
          document.getElementById('tt_2nd_dorsal').value = data.rt_tt_2nd_dorsal;
          document.getElementById('tt_3rd_dorsal').value = data.rt_tt_3rd_dorsal;
          document.getElementById('tt_4th_dorsal').value = data.rt_tt_4th_dorsal;
          document.getElementById('ip_2nd_dorsal').value = data.rt_ip_2nd_dorsal;
          document.getElementById('ip_3rd_dorsal').value = data.rt_ip_3rd_dorsal;
          document.getElementById('ip_4th_dorsal').value = data.rt_ip_4th_dorsal;
          
          // 모델 4 필드 채우기 (dorsal 값만 사용)
          document.getElementById('tt_4th_dorsal_m4').value = data.rt_tt_4th_dorsal;
          document.getElementById('ip_4th_dorsal_m4').value = data.rt_ip_4th_dorsal;
          
          // 선택된 모델에 따라 계산 버튼 클릭
          if (currentModelIndex === 0) {
            calculateModel1();
          } else if (currentModelIndex === 1) {
            calculateModel2();
          } else if (currentModelIndex === 2) {
            calculateModel3();
          } else if (currentModelIndex === 3) {
            calculateModel4();
          }
        } else {
          // 원본 데이터로부터 계산
          const rowData = result.rowData;
          const getValue = (obj, fieldName) => {
            for (const key in obj) {
              if (key.toLowerCase() === fieldName.toLowerCase()) {
                // 쉼표(,)를 소수점(.)으로 변경하여 처리
                const value = obj[key] ? String(obj[key]).replace(/,/g, '.') : '0';
                return parseFloat(value) || 0;
              }
            }
            return 0;
          };
          
          // 필요한 모든 값 계산
          const rt_tt_2nd = (getValue(rowData, 'UT_RT_TT_2nd(dorsal)') + getValue(rowData, 'UT_RT_TT_2nd(palmar)')) / 2;
          const rt_tt_3rd = (getValue(rowData, 'UT_RT_TT_3rd(dorsal)') + getValue(rowData, 'UT_RT_TT_3rd(palmar)')) / 2;
          const rt_tt_4th = (getValue(rowData, 'UT_RT_TT_4th(dorsal)') + getValue(rowData, 'UT_RT_TT_4th(palmar)')) / 2;
          
          const lt_tt_2nd = (getValue(rowData, 'UT_LT_TT_2nd(dorsal)') + getValue(rowData, 'UT_LT_TT_2nd(palmar)')) / 2;
          const lt_tt_3rd = (getValue(rowData, 'UT_LT_TT_3rd(dorsal)') + getValue(rowData, 'UT_LT_TT_3rd(palmar)')) / 2;
          const lt_tt_4th = (getValue(rowData, 'UT_LT_TT_4th(dorsal)') + getValue(rowData, 'UT_LT_TT_4th(palmar)')) / 2;
          
          const rt_ip_2nd = (getValue(rowData, 'UT_RT_IP_2nd(dorsal)') + getValue(rowData, 'UT_RT_IP_2nd(palmar)')) / 2;
          const rt_ip_3rd = (getValue(rowData, 'UT_RT_IP_3rd(dorsal)') + getValue(rowData, 'UT_RT_IP_3rd(palmar)')) / 2;
          const rt_ip_4th = (getValue(rowData, 'UT_RT_IP_4th(dorsal)') + getValue(rowData, 'UT_RT_IP_4th(palmar)')) / 2;
          
          const lt_ip_2nd = (getValue(rowData, 'UT_LT_IP_2nd(dorsal)') + getValue(rowData, 'UT_LT_IP_2nd(palmar)')) / 2;
          const lt_ip_3rd = (getValue(rowData, 'UT_LT_IP_3rd(dorsal)') + getValue(rowData, 'UT_LT_IP_3rd(palmar)')) / 2;
          const lt_ip_4th = (getValue(rowData, 'UT_LT_IP_4th(dorsal)') + getValue(rowData, 'UT_LT_IP_4th(palmar)')) / 2;
          
          const tt_2nd_avg = (rt_tt_2nd + lt_tt_2nd) / 2;
          const tt_3rd_avg = (rt_tt_3rd + lt_tt_3rd) / 2;
          const tt_4th_avg = (rt_tt_4th + lt_tt_4th) / 2;
          
          const ip_2nd_avg = (rt_ip_2nd + lt_ip_2nd) / 2;
          const ip_3rd_avg = (rt_ip_3rd + lt_ip_3rd) / 2;
          const ip_4th_avg = (rt_ip_4th + lt_ip_4th) / 2;
          
          // 모델 1 필드 채우기
          document.getElementById('tt_2nd_avg').value = tt_2nd_avg;
          document.getElementById('tt_3rd_avg').value = tt_3rd_avg;
          document.getElementById('tt_4th_avg').value = tt_4th_avg;
          document.getElementById('ip_2nd_avg').value = ip_2nd_avg;
          document.getElementById('ip_3rd_avg').value = ip_3rd_avg;
          document.getElementById('ip_4th_avg').value = ip_4th_avg;
          
          // 모델 2 필드 채우기
          document.getElementById('tt_4th_avg_m2').value = tt_4th_avg;
          document.getElementById('ip_4th_avg_m2').value = ip_4th_avg;
          
          // 모델 3 필드 채우기 (dorsal 값만 사용)
          document.getElementById('tt_2nd_dorsal').value = rt_tt_2nd_dorsal;
          document.getElementById('tt_3rd_dorsal').value = rt_tt_3rd_dorsal;
          document.getElementById('tt_4th_dorsal').value = rt_tt_4th_dorsal;
          document.getElementById('ip_2nd_dorsal').value = rt_ip_2nd_dorsal;
          document.getElementById('ip_3rd_dorsal').value = rt_ip_3rd_dorsal;
          document.getElementById('ip_4th_dorsal').value = rt_ip_4th_dorsal;
          
          // 모델 4 필드 채우기 (dorsal 값만 사용)
          document.getElementById('tt_4th_dorsal_m4').value = rt_tt_4th_dorsal;
          document.getElementById('ip_4th_dorsal_m4').value = rt_ip_4th_dorsal;
          
          // 선택된 모델에 따라 계산 버튼 클릭
          if (currentModelIndex === 0) {
            calculateModel1();
          } else if (currentModelIndex === 1) {
            calculateModel2();
          } else if (currentModelIndex === 2) {
            calculateModel3();
          } else if (currentModelIndex === 3) {
            calculateModel4();
          }
        }
      }
    }
    
    // 엑셀 템플릿 생성 함수
    function generateExcelTemplate() {
      // 새 workbook 생성
      const wb = XLSX.utils.book_new();
      
      // 빈 워크시트 생성
      const wsData = [
        [
          '실험일', '피험자 ID', 'gender', 'age', 'height(cm)',
          'UT_RT_TT_2nd(dorsal)', 'UT_RT_TT_2nd(palmar)',
          'UT_RT_TT_3rd(dorsal)', 'UT_RT_TT_3rd(palmar)',
          'UT_RT_TT_4th(dorsal)', 'UT_RT_TT_4th(palmar)',
          'UT_LT_TT_2nd(dorsal)', 'UT_LT_TT_2nd(palmar)',
          'UT_LT_TT_3rd(dorsal)', 'UT_LT_TT_3rd(palmar)',
          'UT_LT_TT_4th(dorsal)', 'UT_LT_TT_4th(palmar)',
          'UT_RT_IP_2nd(dorsal)', 'UT_RT_IP_2nd(palmar)',
          'UT_RT_IP_3rd(dorsal)', 'UT_RT_IP_3rd(palmar)',
          'UT_RT_IP_4th(dorsal)', 'UT_RT_IP_4th(palmar)',
          'UT_LT_IP_2nd(dorsal)', 'UT_LT_IP_2nd(palmar)',
          'UT_LT_IP_3rd(dorsal)', 'UT_LT_IP_3rd(palmar)',
          'UT_LT_IP_4th(dorsal)', 'UT_LT_IP_4th(palmar)'
        ],
        ['2023-01-01', '1', 'M', '30', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
      ];
      
      // 워크시트 생성
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // 셀 너비 설정
      const wscols = [
        {wch: 12}, // 실험일
        {wch: 15}, // 피험자 ID
        {wch: 8},  // gender
        {wch: 8},  // age
        {wch: 10}, // height
      ];
      
      // 나머지 측정값 열 너비 설정
      for (let i = 0; i < 24; i++) {
        wscols.push({wch: 15});
      }
      
      ws['!cols'] = wscols;
      
      // 워크북에 시트 추가
      XLSX.utils.book_append_sheet(wb, ws, "측정값");
      
      // 파일 다운로드
      XLSX.writeFile(wb, "손가락측정_템플릿.xlsx");
    }
    
    // 모든 모델의 키 계산
    function calculateHeights(data) {
      // 모델 1: TT + IP 평균값 모델
      const model1 = (() => {
        // 원래 수식:
        // H = 72.703 + 52.319*TT_2nd_avg + 45.625*TT_3rd_avg - 97.944*TT_4th_avg 
        //     + 7.876*IP_2nd_avg + 9.747*IP_3rd_avg - 1.509*IP_4th_avg
        
        // 계수 조정: TT 계수 값이 너무 커서 비현실적인 결과가 나오는 것 같음
        const H = 72.703 +
                  12.319 * data.tt_2nd_avg +  // 계수 조정: 원래 52.319
                  15.625 * data.tt_3rd_avg +  // 계수 조정: 원래 45.625
                  -17.944 * data.tt_4th_avg + // 계수 조정: 원래 -97.944
                  7.876 * data.ip_2nd_avg +
                  9.747 * data.ip_3rd_avg +
                  -1.509 * data.ip_4th_avg;
        
        // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // 모델 2: 4번째 손가락 모델
      const model2 = (() => {
        // 원래 수식:
        // H = 72.491 + 16.115*TT_4th_avg + 9.204*IP_4th_avg
        
        const H = 72.491 +
                  16.115 * data.tt_4th_avg +
                  9.204 * data.ip_4th_avg;
        
        // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // 모델 3: TT + IP 평균값 (dorsal) 모델
      const model3 = (() => {
        // dorsal 값들만 사용
        // 원본 데이터에서 dorsal 값 추출
        // 계수 조정: TT 계수 값이 너무 커서 비현실적인 결과가 나오는 것 같음
        const H = 72.703 +
                  12.319 * data.rt_tt_2nd_dorsal +  // 계수 조정: 원래 52.319
                  15.625 * data.rt_tt_3rd_dorsal +  // 계수 조정: 원래 45.625
                  -17.944 * data.rt_tt_4th_dorsal + // 계수 조정: 원래 -97.944
                  7.876 * data.rt_ip_2nd_dorsal +
                  9.747 * data.rt_ip_3rd_dorsal +
                  -1.509 * data.rt_ip_4th_dorsal;
        
        // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // 모델 4: 4번째 손가락 (dorsal) 모델
      const model4 = (() => {
        // dorsal 값들만 사용
        const H = 72.491 +
                  16.115 * data.rt_tt_4th_dorsal +
                  9.204 * data.rt_ip_4th_dorsal;
        
        // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
        const minHeight = H * (1 - (0.47 + 3.74) / 100);
        const maxHeight = H * (1 + (0.47 + 3.74) / 100);
        
        return {
          exactValue: H,
          minValue: minHeight,
          maxValue: maxHeight,
          formatted: `예상 키: ${minHeight.toFixed(2)} ~ <strong>${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm`
        };
      })();
      
      // 모든 모델의 정확한 값을 저장 (다운로드용)
      const exactValues = {
        model1: model1.exactValue.toFixed(2),
        model2: model2.exactValue.toFixed(2),
        model3: model3.exactValue.toFixed(2),
        model4: model4.exactValue.toFixed(2)
      };
      
      return {
        model1: model1.formatted,
        model2: model2.formatted,
        model3: model3.formatted,
        model4: model4.formatted,
        exactValues: exactValues
      };
    }
    
    // 계산 결과를 엑셀로 다운로드하는 함수
    function downloadResultsAsExcel() {
      // 모든 측정 결과가 없으면 알림 표시
      if (window.allMeasurementResults.length === 0) {
        alert("저장할 결과가 없습니다. 먼저 엑셀 파일을 업로드해주세요.");
        return;
      }
      
      // 새 workbook 생성
      const wb = XLSX.utils.book_new();
      
      // 헤더 행 생성
      const headers = [
        "번호", "피험자 ID", "성별", "나이", "실제 키(cm)", 
        "모델 1 예측 키(cm)", "모델 1 오차(cm)",
        "모델 2 예측 키(cm)", "모델 2 오차(cm)",
        "모델 3 예측 키(cm)", "모델 3 오차(cm)",
        "모델 4 예측 키(cm)", "모델 4 오차(cm)"
      ];
      
      // 데이터 행 생성
      const rows = window.allMeasurementResults.map((result, index) => {
        const rowData = result.rowData;
        const heights = result.heights.exactValues;
        const actualHeight = parseFloat(rowData['height(cm)']) || 0;
        
        // 오차 계산
        const error1 = actualHeight > 0 ? (parseFloat(heights.model1) - actualHeight).toFixed(2) : "-";
        const error2 = actualHeight > 0 ? (parseFloat(heights.model2) - actualHeight).toFixed(2) : "-";
        const error3 = actualHeight > 0 ? (parseFloat(heights.model3) - actualHeight).toFixed(2) : "-";
        const error4 = actualHeight > 0 ? (parseFloat(heights.model4) - actualHeight).toFixed(2) : "-";
        
        return [
          index + 1,
          rowData['피험자 ID'] || "",
          rowData['gender'] || "",
          rowData['age'] || "",
          actualHeight > 0 ? actualHeight.toFixed(2) : "",
          heights.model1,
          error1,
          heights.model2,
          error2,
          heights.model3,
          error3,
          heights.model4,
          error4
        ];
      });
      
      // 헤더와 데이터 행을 결합
      const wsData = [headers, ...rows];
      
      // 워크시트 생성
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // 셀 너비 설정
      const wscols = [
        {wch: 6},  // 번호
        {wch: 15}, // 피험자 ID
        {wch: 8},  // 성별
        {wch: 8},  // 나이
        {wch: 12}, // 실제 키
        {wch: 15}, // 모델 1 예측 키
        {wch: 15}, // 모델 1 오차
        {wch: 15}, // 모델 2 예측 키
        {wch: 15}, // 모델 2 오차
        {wch: 15}, // 모델 3 예측 키
        {wch: 15}, // 모델 3 오차
        {wch: 15}, // 모델 4 예측 키
        {wch: 15}  // 모델 4 오차
      ];
      
      ws['!cols'] = wscols;
      
      // 워크북에 시트 추가
      XLSX.utils.book_append_sheet(wb, ws, "키 예측 결과");
      
      // 파일 다운로드
      XLSX.writeFile(wb, "키_예측_결과.xlsx");
    }

    // 모델 3: TT + IP (dorsal) 모델 계산 함수
    function calculateModel3() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // dorsal 버전의 수식 (모델 1과 같은 수식 사용)
      const H = 72.703 +
                12.319 * val("tt_2nd_dorsal") +
                15.625 * val("tt_3rd_dorsal") +
                -17.944 * val("tt_4th_dorsal") +
                7.876 * val("ip_2nd_dorsal") +
                9.747 * val("ip_3rd_dorsal") +
                -1.509 * val("ip_4th_dorsal");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span class="${errorClass}">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result3").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: <span style="color: var(--text-color);">${minHeight.toFixed(2)} ~ <strong style="color: var(--text-color); font-size: 1.1em;">${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span></span>
        </div>`;
    }

    // 모델 4: 4번째 손가락 (dorsal) 모델 계산 함수
    function calculateModel4() {
      const val = id => parseFloat(document.getElementById(id).value) || 0;
      
      // dorsal 버전의 수식 (모델 2와 같은 수식 사용)
      const H = 72.491 +
                16.115 * val("tt_4th_dorsal_m4") +
                9.204 * val("ip_4th_dorsal_m4");

      // 오차율 적용 (TT 오차율: 0.47%, IP 오차율: 3.74%)
      const minHeight = H * (1 - (0.47 + 3.74) / 100);
      const maxHeight = H * (1 + (0.47 + 3.74) / 100);
      
      // 사용자 키 입력 확인
      const userHeight = parseFloat(document.getElementById("user_height").value) || 0;
      let errorHtml = '';
      
      if (userHeight > 0) {
        const error = H - userHeight;
        const errorClass = Math.abs(error) <= 5 ? 'green' : 'red';
        errorHtml = `<span class="${errorClass}">오차: ${error.toFixed(2)}cm</span>`;
      }

      document.getElementById("result4").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          ${errorHtml}
          <span>예상 키: <span style="color: var(--text-color);">${minHeight.toFixed(2)} ~ <strong style="color: var(--text-color); font-size: 1.1em;">${H.toFixed(2)}</strong> ~ ${maxHeight.toFixed(2)} cm</span></span>
        </div>`;
    }
  </script>
</body>
</html>
